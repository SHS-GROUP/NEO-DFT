c 12 Aug 13 - DGF - finish FMO 5.0
C 21 May 13 - DGF - reduce printout for MD and change FMO initial guess
C  1 May 13 - CS,SP,CB,AAW,JI,TS,LBR,JAM,AAD,WL,CC,TN,DGF,AA,DT,NM,MWS
C                         NEW DATE IN BOX IN HONOR OF:
C             EFMO disp/CT/XR/CP updates, MCSCF SVD&VVOs, h&i ints,
C             EFP2 dispersion, ORMAS-PT2, F12 via MPQC, CUHF, CIM,
C             FMO Monte Carlo, FMO 4.3, MP2/CCSD for LIBCCHEM,
C             excited state CEEIS, CAS/MCQDPT diabatization
C 26 Oct 12 - MWS - LIBCCHEM's CCSD(T) check run, bump release number
C 19 Oct 12 - MWS - synchronize FRGINF common
C  7 Sep 12 - AA  - update interface to LIBCCHEM
C  2 Sep 12 - NM  - WFN: skip SCF for the 2nd calc. in the CI search
C 24 JUL 12 - DGF - PAD COMMON FOR FMO 4.3
C 21 JUN 12 - DGF - CHANGES FOR FMO 4.3
C  1 MAY 12 - PX;DGF,TN,CS,CHC,SRP;ACW;RP;LMR;EAH;FZ;BSD,JBL;SAN -
C                         NEW DATE IN BOX IN HONOR OF:
C             EFP2 CH.TR. USING VVOS;FMO 4.2'S (E)FMO;MPCQ+DYN.WSTATE;
C             VVOS FOR TM AND HEAVY MG;TWO PHOTON ABSORPTION;
C             VALENCE BOND CALCULATIONS;THERMOCHEMISTRY
C  9 APR 12 - FZ  - PAD THE INFOTD COMMON FOR TPA
C 28 Mar 12 - SAN - correct final PCM printing
c 23 MAR 12 - CHC,DGF - QM/EFP-MD and MGC, redundant PCM printout cut
C 30 JAN 12 - SAN - RUNTYP=COMP CONTROL VALFM, ADDED RUNTYP=COMP ADDED TO
C                   BRNCHX SUBROUTINE, CHANGED /CXTHRM/
C 28 DEC 11 - DGF - CHANGES FOR FMO 4.2
C  2 NOV 11 - MWS - GRADX: ALLOW FOR CORRECT EFP NUMERICAL GRADIENT
C 11 AUG 11 - HL,DS,NT;U.MINN.;FZ;TN;YI;KB,TN,DGF;AA;HL,NT,DS;NM;NM;AAD
C                         NEW DATE IN BOX IN HONOR OF:
C             FULL TDDFT/MP2 WITH PCM/EFP;SMD SOLV.;TAMM-DANCOFF TDDFT;
C             SPK REL.BASES;LOCAL RESPONSE DISPERSION;ACC. FMO GRAD;
C             LIBCCHEM SCF/MP2; QUAN.POL. QM/MM; SPIN-FLIP TDDFT/CIS;
C             CONICAL INTERSECTIONS; QM/EFP ENERGY ANALYSIS.
C 15 APR 11 - HL  - ADD QUANPOL
C 15 APR 11 - MK,DGT  - WASEDA NAMES UPDATED, GRADX: SCOPE CHANGES
C 12 DEC 10 - HL  - ADD PRINT OUT FOR QM/MM(POL)/CONTINUUM TD-DFT RUNS
C 12 DEC 10 - AVM - INTERFACING WITH U.MINNESOTA SMX CODES
C  1 OCT 10 - AA;TZ,MJB,MK;RP,KKB;MK;NM;FZ;MG;DJS,HL;TN,CS,DGF
C                         NEW DATE IN BOX IN HONOR OF:
C                   GPU CODE FOR CLOSED SHELL FOCK BUILD, SCALABILITY;
C                   SPIN-ORBIT AND IOTC SCALAR RELATIVITY, MCP BASES;
C                   REPLACEMENT COSMO (RHF,UHF,ROHF AND THEIR DFT/MP2);
C                   RI-MP2 ENERGIES; EFP1/TDDFT GRADIENTS AND PARALLEL;
C                   METAGGA TDDFT ENERGY, CLOSE SHELL TAMM/DANCOFF;
C                   RM1 PARAMETERS; OPEN SHELL ZAPT + PCM GRADIENT,
C                   FMO 4.0 AND EFMO AND TINKER/FMO INTERFACING.
C 11 AUG 10 - TN  - ALLOW RUNTYP=MD FOR FMO
C 11 AUG 10 - MK  - INTERFACE TO RI-MP2 PROGRAM
C 11 AUG 10 - RP  - ENSURE COSMO WORKS WITH ALL POSSIBLE MP2 CODES
C 11 AUG 10 - RP  - UPDATE COSMO INTERFACE, DOUBLE HYBRID CHANGES
C 10 MAY 10 - MWS - DISABLE THE OPTION OF OPENING THE -OUTPUT- FILE
C 25 MAR 10 - HL,PFS,DJS,YLW;HPTI,SS,RP,KAN,FZ;DGF,TN;DMK;MW,JRG
C                         NEW DATE IN BOX IN HONOR OF:
C                   LMO-EDA, HET. PCM, MP2/PCM AND TDDFT/PCM GRADIENTS,
C                   DFT GRIDDING, DFT+TDDFT FUNCTIONALS, FMO UPDATES,
C                   EFP2/QM EX.REP,CR-EOML AND EA-EOM/IP-EOM
C 14 OCT 09 - DGF,JRG - WFN: RESTORE RHF DENS FOR FMO, WFNCC: NEW CCTYP
C 14 AUG 09 - KAN - COULOMB ATTENUATED METHODS (CAM) FOR DFT & TDDFT
C 14 AUG 09 - RP  - MODIFICATIONS FOR THE B2PLYP DFT FUNCTIONAL
C 22 MAY 09 - MC  - DISABLE RADIAL GRID CHECK FOR TD-HF EXCITATION
C  1 MAY 09 - PFS,HL - ADD LMOEDA METHOD
C 12 JAN 09 - YBG,KRG,MWS,HL,PS,LVS,SS,RP,FZ,TJD,DGF,TN,MC,MK -
C                         NEW DATE IN BOX IN HONOR OF:
C                   RUNTYP=GAMMA, PCM/EFP FIXES, PCM+PCM/EFP GRADIENTS,
C                   EFP CLEANUP+SCREENING, NEW DFT+TDDFT FUNCTIONALS,
C                   RUNTYP=NACME, FMO 3.2 AND PCM/TDDFT, DIVIDE+CONQUER
C 12 JAN 09 - DGF - OUTPUT GROUND STATE PCM PROPERTIES FOR TDDFT/PCM
C 15 DEC 08 - MC  - SYNCHRONIZE INFOTD COMMON
C 20 NOV 08 - MK  - CHANGES TO ADD THE DIVIDE-AND-CONQUER METHOD
C 20 NOV 08 - MWS - HFGRAD: DO PCM GRADIENT BEFORE 2E- DER. INTEGRALS
C 23 OCT 08 - PFS,HL - HFGRAD: ADD IPCDER=3 FOR FIXPVA
C 18 JUL 08 - YBG - OPTIONS INVOLVING 3RD NUCLEAR DERIVATIVES
C 11 APR 08 - PP,MW,JRG,TN,KI,DDK,LVS,JMM,RKC,HN,MC,SHY,SS,BNJ,SAN,HPTI-
C                         NEW DATE IN BOX IN HONOR OF:
C                   OPEN SHELL CC, CEEIS EXTRAP, MP2/IMS GRADIENT,
C                   EFP CHANGES FOR OPEN SHELL, EWALD SUMS, AND MD RUNS,
C                   IVO-CAS, GMCPT, TDDFT GRADIENT, UTDDFT ENERGY,
C                   META-GGA'S, INTERNAL COORD VSCF, G3MP2 THERMOCHEM,
C                   DFT GRID CHANGES AND PARALLELIZATION
C  4 MAR 08 - SPW - CHANGES FOR NEO GRADIENT
C  4 MAR 08 - HN  - WFNMP2: ADD CALL TO THE GMC-QDPT PROGRAM
C  4 MAR 08 - SHY - WFNTDDFT: ALLOW FOR UNRESTRICTED REFERENCE STATE
C  7 DEC 07 - MWS - BRNCHX: ADD BONDING ANALYSIS RUN TYPE
C 28 AUG 07 - HL  - HFGRAD: CHANGES FOR PCM GRADIENTS
C 20 AUG 07 - RKC - WFNMP2: IVO-CASCI RUN MAKES CALL TO MCQDPT
C 20 AUG 07 - DGF - VARIOUS CHANGES FOR FMO 3.1 RELEASE
C 27 JUL 07 - MC  - ADD TDDFT GRADIENT
C 25 JUN 07 - MWS - WFNCC: PRINT WARNING IF LARGE LCAO COEF EXISTS
C 21 MAY 07 - MWS - WFNCC: CALL EITHER CLOSED OR OPEN SHELL DRIVERS
C 24 MAR 07 - HM,TN,DGF,LVS,KI,PEA,SPW,BN,GMC,SS,RP,MC,AA -
C                         NEW DATE IN BOX IN HONOR OF:
C                   MCP GRAD; FMO+EFP; FMO3: PIEDA, 3-BODY MP2, ETC.,
C                   EFP SCREENING; NEO: POSITRONS, CI; DISK-BASED
C                   PARALLEL MP2 ENERGY; VSCF: INT. COORD, SUBGROUPS,
C                   COMBINATION BANDS; MANY NEW DFT FUNCTIONALS;
C                   TD-DFT AND LC-DFT; PARALLEL ORMAS-CI.
C 22 DEC 06 - ST,NK,MC,DGF,TN - LC EXCHANGE, FMO 3.0, FMO/EFP GRADIENT
C 19 NOV 06 - PEA - WFN: CALL FOR POSITRON PROPERTIES
C  6 NOV 06 - MWS - WFN: CALLS WFNTDDFT
C 25 OCT 06 - SPW - WFNCI: CHANGES TO CALL NEO-CI
C  7 SEP 06 - RMO,JLB,TJD,NM,FLG,YA,SPW,MWS,SS -
C                   NEW DATE IN BOX IN HONOR OF PARALLEL CCSD(T),
C                   DDI V3, SOUPED UP MCSCF HESSIANS, MEX SEARCH,
C                   ELONGATION METHOD, NEO INTERFACE, QUAMBO/VVO,
C                   AND POLARIZABILITY DECOMPOSITION
C 10 JUL 06 - MWS - SAVE NUCLEAR REPULSION FOR PURE CI JOBS
C  8 MAY 06 - BSD - SAVE VB2000 ENERGY CORRECTLY
C 29 MAR 06 - FLG - CHANGES FOR LOCALIZATION FOR ELONGATION METHOD
C 13 MAR 06 - NM  - INCLUDE MEX EXECUTION PATHWAY
C 22 FEB 06 - YA,TLW,SG,MK,MWS,HMN,OQ,MW,PP,HL,DGF,TN,LVS -
C                   NEW DATE IN BOX IN HONOR OF: DDI CPHF, NUM. POLAR.,
C                   MCP LIBRARY, RYS QUAD, MD TRAJ., TDHFX, CR-CCL,
C                   EFP+PCM GRAD, FMO+EFP AND FMO+PCM, PROPERTY REORG.,
C                   MAKEFP SOUPUPS (MULT.SCREEN, DYN.POL.SOLVERS)
C  2 FEB 06 - MWS - WFN,WFNMP2,WFNCI,WFNCIS: REORGANIZE PROPERTY CALLS
C 17 JAN 06 - MWS - WFNCC: ADD CR-CCSD(T)_L PATHWAY
C 14 NOV 05 - DGF - SOME PCM CLEANUP TOUCHES
C 19 SEP 05 - SPW - GAMESS,ENERGX,WFNCIS: ADD NEO HOOKS, FIX CISVEC READ
C  5 JUL 05 - MWS - SELECT NEW ATOM,BASIS,EFP,PCM,DAF DIMENSIONS
C 27 JUN 05 - CMA,JI,PP,MW,KK,IA,JS,HL,HMN,PA,SPW,DMC,DGF,FRJ -
C                   NEW DATE IN BOX IN HONOR OF ZAPT2 GRAD, DET. MRPT,
C                   CCSD DENSITY AND (Q), EFP CHANGES, CIS TRANS.MOM,
C                   SVP SOLVATION, FMO V.2, SYSTEMATIC BASIS SETS
C  1 JUN 05 - CMA,JI - ADD ZAPT2 GRADIENT, DETERMINANT MRPT ENERGY
C 30 APR 05 - DGF - ADD RUNTYP=FMO0, UPDATE SEVERAL FMO METHODS AND GDDI
C 14 MAR 05 - MWS - WFNCIS: DO HF PROPS/DIPOLE INTS BEFORE CIS GRAD
C  7 MAR 05 - IA  - FIX COMMON BLOCK FRGINF
C 13 FEB 05 - MWS - PAD COMMON BLOCK HERMIT, WERMIT, NSHEL, FRGINF
C  5 FEB 05 - MWS - PAD COMMON FMORUN
C 22 NOV 04 - MWS - NEW DATE IN BOX IN HONOR OF QFF-VSCF, ROT.AX. SPDL
C                   AND ERIC AO INTEGRAL CODES, AND QFMM GRADIENT CODE
C  7 SEP 04 - CHC - HFGRAD: ADD LINEAR SCALING GRADIENT OPTION
C 23 JUL 04 - DGF - PRINT RELAXED DENSITY CI PROPERTIES AFTER GRADIENTS
C 23 JUL 04 - MWS - WFNMP2: MCQDPT MUST OPEN AOINTS ON ALL CPUS
C 19 MAY 04 - DGF,RMO - NEW DATE IN BOX IN HONOR OF FMO AND GROUP DDI
C  7 APR 04 - MWS - NEW DATE IN BOX IN HONOR OF SMP-OPTIMIZED DDI,
C                   MCSCF ANALYTIC HESSIANS, TRIPLES CORRECTED EOM-CCSD,
C                   GEPOL-AS PCM GRADIENTS, AND MANY BODY SCF-MI.
C 22 DEC 03 - MWS - WFNMP2: FIX ENERGY ONLY CALCULATIONS
C 12 DEC 03 - MWS - NEW DATE IN BOX IN HONOR OF PARALLEL CIS GRADIENT,
C                   NMR SPECTRA, SPIN-ORBIT WITH MODEL CORE POTENTIALS,
C                   DOUGLAS-KROLL 3RD ORDER, NUMERICAL DERIVATIVES
C  9 DEC 03 - OQ,RMO - EXTENDED TDHF AND NUMERICAL GRADIENT CALLS
C  4 NOV 03 - MWS - DROP NMR STUB ROUTINE
C  3 SEP 03 - SPW - ADD WFNCIS DRIVER FOR CI-SINGLES CODE
C 14 AUG 03 - MWS - IMPROVE ACCURACY OF HERMITE ROOTS/WEIGHTS
C  3 JUL 03 - MWS - NEW DATE IN BOX IN HONOR OF PCM GRAD, PARALLEL UMP2
C 16 JUN 03 - HL  - ENERGX,HFGRAD: PCM GRADIENT CHANGES
C 15 MAY 03 - CMA - WFNMP2: CALLS TO PARALLEL DISTRIBUTED MEMORY
C 26 MAR 03 - MWS - WFNMP2: IGNORE DIRTRF/DIRSCF FOR MCQDPT RUNS
C 28 JAN 03 - MWS - WFNCC: GENERATE C2 INTEGRAL LIST FOR NON-ABEL GROUPS
C 14 JAN 03 - JI  - NEW DATE IN BOX IN HONOR OF ORMAS
C 12 DEC 02 - MWS - GAMESS: INTERFACING TO GVVPT OPTION INCLUDED
C  7 AUG 02 - MWS - REMOVE CHARGE PENETRATION STUBS
C 20 JUN 02 - MWS - NEW DATE IN BOX IN HONOR OF MSU'S COUPLED CLUSTER
C 22 MAY 02 - MAF - DUMMY INTERFACE TO NMR PROPERTY
C 17 APR 02 - MWS - ADD WFNCC DRIVER
C 16 FEB 02 - CMA,JI - NEW DATE IN BOX IN HONOR OF UMP2 GRAD, DET SOCI
C 24 JAN 02 - CMA - HFGRAD,WFNMP2: CHANGES FOR MP2 GRADIENT
C 21 DEC 01 - MWS - WFN,WFNCI,WFNMP2: SET PSI LEVEL FLAG
C 16 NOV 01 - MWS - WFNMP2: SAVE EMP2 TO /ENRGYS/, PARALLEL MP2PRP
C 25 OCT 01 - MWS - STUB OUT MODEL CORE POTENTIAL CALLS
C 19 SEP 01 - MWS - WFNMP2: NO REGENERATION OF AO INTEGRALS FOR MCQDPT
C  6 SEP 01 - CHC,HU,JI - NEW DATE IN BOX IN HONOR OF QFMM, PARALLEL
C                   MCQDPT, GENERAL DETERMINANT CI, AND JACOBI MCSCF
C  1 AUG 01 - JI  - TWEAKS FOR GENERAL CI
C 25 JUN 01 - DGF - NEW DATE IN BOX IN HONOR OF GRID DFT, SO-MCQDPT,
C                   RESC INTERNAL UNCONTRACTION
C 13 JUN 01 - DGF - GAMESS: STUFF ALL RUNTYP BRANCHING INTO ONE ROUTINE
C 26 APR 01 - JPI - WFNCI: PERMIT GENERAL CI CALL
C 20 FEB 01 - PND - GAMESS: CALL TO MONTE CARLO GLOBAL OPTIMIZER
C 26 OCT 00 - MWS - NEW DATA IN BOX IN HONOR OF SYMMETRY DETERMINANT CI,
C                   NEW PCM, EFP+PCM INTERFACE, AND RAMAN DEVELOPMENTS
C 11 OCT 00 - BM  - ADDED IEF SOLVATION MODEL
C 28 JUL 00 - MWS - ADD NEW ARG TO CALL TO INIDEN
C 11 JUN 00 - MWS - GEN C1 INT LIST FOR NON-ABEL MCSCF (FIX DEC 99 BUG)
C  1 MAY 00 - MWS - CALL RAMAN DRIVER
C 10 APR 00 - MWS - REMOVE STATIC MEMORY FROM COSMO COMMONS
C 25 MAR 00 - MWS - NEW DATE IN BOX IN HONOR OF VSCF, ESC GRADIENTS,
C                   COVALENT EFP, COSMO, GRID-FREE DFT
C 13 MAR 00 - KKB/LNB - WFNMP2: ADD COSMO
C 16 FEB 00 - VK  - GAMESS,ORTHDN: CHANGES DUE TO MO TRUNCATION/FREEZING
C 10 JAN 00 - MWS - GAMESS: NEW DATE IN BOX IN HONOR OF GENERAL SPIN
C                   ORBIT COUPLING, RESC AND NESC, AND MCQDPT WEIGHTS
C 29 DEC 99 - MWS - WFNMP2: CORRECTLY LABEL SCF VS. MP2 PROPS
C 21 DEC 99 - DGF - INIDEN: ADD ORB. PURIF. ARG, REMOVE RUNTYP=SPINORBT
C 29 AUG 99 - CHC - QMMM MMONLY KEYWORDS IN $CONTROL BY JRS
C 10 JUN 99 - MWS - WFNMP2: FIX DDI/NONDDI INTEGRAL REGENERATION
C  6 JUN 99 - MWS - NEW DATE IN BOX IN HONOR OF PARALLEL MP2 GRADIENT,
C                   OPEN SHELL ZAPT MP2, AND SPHERICAL HARMONICS
C  9 APR 99 - MWS - WFNMP2: CALL THE NEW MP2 CODE
C 13 MAR 99 - KRG - ENERGX: ADD CALL TO DFT INTEGRALS
C  1 DEC 98 - MWS - NEW DATE IN BOX IN HONOR OF ECP HESS AND DLC COORDS
C 12 NOV 98 - MAF - WFNMP2: ALLOW FOR USE OF SPHERICAL HARMONICS
C  6 MAY 98 - MWS - NEW DATE IN BOX IN HONOR OF DETERMINANT FULL CI
C  6 JAN 98 - DGF - NEW DATE IN BOX IN HONOR OF GENERAL SOC ACTIVE SPACE
C 28 SEP 97 - MWS - CONVERT PARALLEL CALLS FROM TCGMSG TO DDI
C 14 AUG 97 - MWS - GRADX: RESTORE MISSING CALL TO PUVIB
C 24 JUL 97 - MWS - WFNCI: FIX IREST/LREST CONFUSION
C 16 JUL 97 - GNM - ENERGX,GRADX: CHANGES FOR FRAGONLY RUNS
C 18 MAR 97 - MWS - NEW DATE IN BOX IN HONOR OF PCM CODE
C 22 FEB 97 - MWS - GAMESS,ENERGX,HFGRAD: CALLS TO PCM CODE
C 19 FEB 97 - MWS - WFN: SAVE ELECTRONIC ENERGY OF MCSCF FUNCTIONS
C 14 FEB 97 - MWS - ENERGX,WFNCI: POSTPONE 2E- INTS FOR STRAIGHT CI
C  8 JAN 97 - GMC - WFN: CALL TO FULL QUADRATIC MCSCF
C 18 DEC 96 - JHJ - GAMESS: MAKEFP RUNTYP ADDED
C 26 NOV 96 - SPW - GAMESS: ALLOW FROZEN CORE CI GRADIENTS
C 31 OCT 96 - MWS - NEW DATE IN BOX IN HONOR OF MCQDPT AND CI GRADIENT
C 23 OCT 96 - HN  - ENERGZ,WFN,WFNMP2: CHANGES FOR MCSCF+MP2
C 17 OCT 96 - SPW - ENERGX,GRADX,WFNCI: CHANGE FOR CI GRADS; ADD CIGRAD
C 29 SEP 96 - MWS - GRADX USES STANDARD ROUTINE PUVIB
C 11 SEP 96 - MWS - NEW DATE IN BOX IN HONOR OF EFP CODE, FINALLY.
C 13 AUG 96 - MWS - WFN,WFNCI: FIX SCFTYP=NONE OPTION
C 11 JUL 96 - MWS - BRING WFNMP2 ROUTINE TO THIS FILE
C 22 JUN 96 - SPW,GMC - NEW DATE IN BOX IN HONOR OF FROZEN CORE MP2
C                   GRADIENT AND APPROXIMATE SOSCF MCSCF
C 13 JUN 96 - VAG - WRITE WFN ROUTINE TO REPLACE WFN,SCF,MCCI MESS
C  5 MAR 96 - MWS - CHANGE SHELL SYMMETRY PACKING COMMONS
C  9 JAN 95 - WC  - CHANGE CALL TO INIDEN
C  3 JAN 96 - MWS - USE NEW ONE ELECTRON INTEGRAL DRIVER
C 20 NOV 95 - SPW,FRJ - NEW DATE IN BOX IN HONOR OF MP2 GRADIENT AND
C                   GRADIENT EXTREMALS
C  9 OCT 95 - SPW - GAMESS,HFGRAD: PERMIT MP2 GRADIENT COMPUTATION
C 14 SEP 95 - SPW - GAMESS: ONLY MCSCF RUNS NEED TO READ LOCAL INPUT
C 16 AUG 95 - MWS - ENSURE THAT MP2 IS NOT CHOSEN FOR NEW RUN TYPES
C 26 JUL 95 - MWS - NEW DATE IN BOX IN HONOR OF UHF/ROHF/GVB SOSCF
C 24 MAY 95 - MWS - ENERGX: ALLOW DISTRIBUTED AO INTS DURING CI/MCSCF
C 10 MAR 95 - GMC,MWS - NEW DATE IN BOX IN HONOR OF SOSCF
C  1 FEB 95 - WC,RM: NEW DATE IN BOX IN HONOR OF MOROKUMA AND SURFACE
C 24 JAN 95 - MWS - WFNCI: USE C1 DURING NON-ABELIAN TRANSFORMATIONS
C 17 NOV 94 - TT  - NEW DATE IN BOX IN HONOR OF DRC RUN TYPE
C 11 AUG 94 - HAK - NEW DATE IN BOX IN HONOR OF TDHF NLO PROPERTIES
C 22 JUL 94 - BMB,JHJ - NEW DATE IN BOX IN HONOR OF FAST SPDFG GRADIENT,
C                   AND IN HONOR OF LOCALIZED CHARGE DECOMPOSITION
C  6 JUN 94 - MWS - NEW DATE IN BOX IN HONOR OF PARALLEL CI, HESSIANS,
C                   LOCALIZATION, USING PARALLEL TRANS.SRC
C  1 JUN 94 - MWS - ENERGX,WFNCI: ADAPT TO PARALLEL CI
C 27 MAY 94 - SPW - GRADX: FIX FOR FRAGMENT GRADIENTS
C  5 APR 94 - NM,SPW - NEW DATE IN BOX IN HONOR OF SCRF AND NEW MP2
C 10 MAR 94 - FRJ - ENERGX: RESTRICT VTSCAL CHANGES
C 25 JAN 94 - MWS - NEW DATE IN BOX IN HONOR OF PARALLEL MCSCF,
C                   ENERGX: MCSCF INTEGRALS IN C1 IF NON-ABELIAN GRP
C 13 DEC 93 - TLW - ENERGX: MCSCF RUNS USE SYMMETRY FOR INTEGRALS
C  3 NOV 93 - MH  - GAMESS: ADD HOOKS TO CHARMM PACKAGE
C  2 NOV 93 - MWS - ADD GAMESS PAPER REFERENCE TO THE BOX
C 17 JUL 93 - MWS - NEW DATE IN BOX IN HONOR OF LANTHANIDES
C 11 MAR 93 - FJ  - ADD VIRIAL SCALING
C  4 MAR 93 - JHJ - NEW DATE IN BOX IN HONOR OF SCRF OPTION
C 26 JAN 93 - MWS - COMMENT OUT PTIMIT TO REMOVE SND/RCV CALLS
C 11 DEC 92 - MWS - CHANGE ARG LIST FOR HESSX
C 13 NOV 92 - NM,SJS,TLW - NEW DATE IN BOX IN HONOR OF ROHF-MP2,
C                   SCHLEGEL IRC, SEMI-PARALLEL HESSIAN CALCULATION
C 10 NOV 92 - MK  - ADD CALL TO ZEALOT INTERFACE, CHANGE /INTRFC/
C 22 JUN 92 - MWS - ADD 2ND ARG TO GUESMO CALLS
C 28 APR 92 - MWS - INCLUDE FINITE FIELD CALC OF POLARIZABILITY
C  2 APR 92 - MWS,TLW - COMMON ENRGYS MADE PURE FLOATING POINT
C 18 MAR 92 - TLW,JHJ,MWS - NEW DATE IN BOX IN HONOR OF PARALLEL
C                   SCF ENERGY AND GRADIENT, MOPAC WITHIN GAMESS,
C                   AND MICHEL'S SYMMETRY CODE
C 12 MAR 92 - MWS - REDIMENSION TO 500 ATOMS
C  9 MAR 92 - JHJ - HFGRAD,ORTHDN: CHANGES FOR MOPAC INTERFACE
C  2 MAR 92 - MWS - ORTHDN: USE QMTSYM, SAVE -Q- ON DAF EARLY IN RUN
C 29 JAN 92 - TLW - GAMESS: PARALLEL STUFF MOVED TO BEGING AND ENDING
C 25 JAN 92 - MWS - GAMESS,ENERGX: GUESMO TAKES ONLY 1 ARGUMENT
C 10 JAN 92 - TLW - CHANGE REWIND TO CALL SEQREW
C 10 JAN 92 - MWS,TLW - MAKE OPENIP, OPENIR AND OPENIW TO SEQOPN
C  4 JAN 92 - TLW - MAKE WRITES PARALLEL; ADD COMMON PAR
C  5 DEC 91 - MWS - GAMESS: CALL LMOINP AFTER CALL TO DRTGEN.
C  3 DEC 91 - TLW - ENERGX: ALLOW F AND G PROPERTIES TO BE CALCULATED
C 11 NOV 91 - NM,JHJ - NEW DATE IN BOX IN HONOR OF UMP2 + EFP INTERFACE
C 31 OCT 91 - JHJ - MCCI: WRITE COMMON ENRGYS TO DAF 2.
C 28 OCT 91 - JHJ - MCCI: ITERATE INDUCED DIPOLES FOR MCSCF/CI.
C 18 OCT 91 - TLW,MWS - NEW DATE IN BOX IN HONOR OF SPDFG INTEGRALS,
C                   AND DIRECT SCF.
C 20 AUG 91 - MWS - NEW DATE IN BOX IN HONOR OF RHF-DEM, POPULATION
C                   LOCALIZATION, AND PROJECTED HUCKEL GUESS.
C 10 AUG 91 - MWS - GAMESS: GENERATE DRT EARLY IN THE RUN
C  9 AUG 91 - TLW - ENERGX: STOP CALCULATION AFTER ENERGY IF F AND G
C                   FUNCTIONS ARE INPUT
C  2 JUL 91 - MWS - ORTHDN: CHANGE USAGE OF ORTHO ROUTINE
C 24 JUN 91 - MWS - ENERGX: DON'T TURN SYMMETRY OFF FOR GVB RUNS
C 13 JUN 91 - MWS - NEW DATE IN BOX IN HONOR OF SBK BASIS SETS
C  8 APR 91 - MWS - CHANGE CALLS TO GUESMO.
C  4 APR 91 - MWS - NEW DATE IN BOX IN HONOR OF ENERGY LOCALIZATION,
C                   PROP RUNS ALWAYS GENERATE DISTINCT ROW TABLE.
C  1 MAR 91 - MWS - CHANGE CALL TO HESSX
C 23 JAN 91 - JAB - GRADX DRIVER NOW CALLS EGPUN.
C 12 NOV 90 - MWS - NEW DATE IN BOX IN HONOR OF COORD=ZMT INPUT
C 10 OCT 90 - MWS - NEW DATE IN BOX IN HONOR OF OUT OF CORE CPHF.
C                   PUNCH OF MOLPLT AND PLTORB FILES AT END OF JOB.
C 15 AUG 90 - TLW - ADD 7 ELEMENTS TO COMMONS HERMIT AND WERMIT AND
C                   INITIALIZED THEM.
C 30 JUL 90 - MWS - NEW DATE IN BOX IN HONOR OF OS-TCSCF HESSIANS,
C                   INTERFACE TO RPAC (AND AIMPAC) IN MAIN PROGRAM
C  5 JUN 90 - MWS - NEW DATE IN BOX IN HONOR OF FREE FORMAT $DATA,
C                   AND TRUDGE OPTIMIZATION OF CI ENERGY
C 16 APR 90 - MK  - ADD WFNCI AS SEPARATE CI CALCULATION DRIVER
C 30 MAR 90 -MK,SK- NEW DATE IN BOX IN HONOR OF TRUDGE OPTIMIZATIONS,
C                   AND ONE ELECTRON SPIN-ORBIT COUPLING
C  8 MAR 90 - MWS - NEW DATE IN BOX IN HONOR OF GRAPHICS
C  7 JAN 90 - MWS - NEW DATE IN BOX IN HONOR OF FREE FORMAT DRT INPUT
C  9 DEC 89 - MWS - GRADX: CORRECT NUCLEAR CHARGE FOR ECP CASE
C  6 DEC 89 - MWS - NEW DATE IN BOX IN HONOR OF ROHF HESSIANS AND ECPS
C 23 OCT 89 - MWS - DELETE COMMON FUNCT SAVES
C 26 SEP 89 - MWS - ADD NFT13,NFT14 TO COMMON CIFILS
C  5 AUG 89 - MWS - NEW DATE IN BOX (A BUG FIX, NEW HARDWARE RELEASE),
C                   TIMIT FLUSHES OUTPUT BUFFER FOR IW,IP,
C                   MOVE UNPORTABLE CODE INTO NEW MODULE UNPORT
C 28 MAR 89 - MWS - GRADX: ALLOW EXETYP=CHECK TO FEEL OUT GRADIENT.
C 16 MAR 89 - MWS - GRADX: PRINT FINAL TIME MESSAGE
C  6 MAR 89 - MWS - HFGRAD: TRF2DM CALL MOVED TO DDEBUT
C 25 FEB 89 - MWS - ADD OUTPUT FLUSH TO HFGRAD
C  7 FEB 89 - MWS - CHANGE INIDEN CALL
C  1 FEB 89 - MWS - NEW DATE IN BOX IN HONOR OF MP2 AND ORBITAL
C                   SYMMETRY LABELS, CHANGE OPENCI CALL IN HFGRAD,
C                   INCREASE DYNAMIC MEMORY FROM 500,000 TO 750,000.
C 18 JAN 89 - MWS - NEW DATE IN BOX IN HONOR OF MICHEL'S ANALYTIC
C                   RHF HESSIAN CODE, WHICH WAS ADAPTED FROM HONDO7,
C                   CHANGE RUNTYP=FORCE TO RUNTYP=HESSIAN
C 15 DEC 88 - MWS - CHANGE CALL TO TRNSF
C 30 NOV 88 - JAM - ADD *ALL LINES TO SUPPORT ALLIANT MACHINES
C 15 NOV 88 - KF  - CHANGE ETA TIMING
C 13 OCT 88 - MWS - NEW DATE IN BOX IN HONOR OF MICHEL'S MCSCF CODE,
C                   MCCI: REMOVE MOST $CIINP, CHANGE MCSCF,TRNSF CALLS
C 27 AUG 88 - MWS - NEW DATE IN BOX FOR VIBANL,BAKER,IRC,BIG DIMS
C 17 AUG 88 - MWS - DON'T ATTEMPT CRAY TRACEBACK IN ABRT ANYMORE
C 10 AUG 88 - MWS - MXSH,MXGSH,MXGTOT FROM 120,10,440 TO 1000,30,5000
C 10 JUL 88 - MWS - NEW DATE IN BOX IN HONOR OF NEW GVB DIIS CODE
C 30 JUN 88 - MWS - FULL *OS2 AND *CVX (CONVEX) VERSIONS.
C 21 JUN 88 - JAB - PUNCH $GRAD AND $VIB GROUPS FOR RUNTYP=GRADIENT
C 19 JUN 88 - MWS - GENERATE MO GUESS FOR RUNTYP=PROP JOBS
C  4 JUN 88 - MWS - NEW DATE IN BOX IN HONOR OF NEW GRADIENT LOGIC
C 30 MAY 88 - MWS - ROUTINE HFGRAD CALLS JKDER ONLY, NO MORE SPCHK
C                   USE PARAMETER TO DIMENSION COMMON
C 23 MAY 88 - MWS - NEW DATE IN BOX IN HONOR OF NEW INTEGRAL LOGIC
C  8 MAY 88 - MWS - UP AO-S FROM 255 TO 2047
C  4 MAY 88 - MWS - ADD OS/2 TIMING CODE (AS *OS2 LINES)
C 22 APR 88 - MWS - REMOVE NCONF ARG TO INIDEN, USE /GVBWFN/ IN ENERGX
C 18 APR 88 - MWS - NEW DATE IN BOX IN HONOR OF NEW SCF CODE
C  7 APR 88 - MWS - IBM VERSION TO 2,000,000 WORDS.
C  2 APR 88 - MWS - DELETE ROUTINE TIMREM, IT'S NO LONGER USED,
C                   PUT INITAL ORBITAL GUESS AFTER 1E- INTEGRALS.
C 29 FEB 88 - STE - MCCI: RNAM>>DRTINP(1)
C 19 FEB 88 - MWS - ADD RUNTYP=SPINORBT/TRANSITN, CHANGE DRTGEN CALL,
C                   READ INPUT FOR FROZEN ORB. MCSCF, NEW DATE IN BOX
C  3 DEC 87 - STE - NEW DATE IN BOX
C 19 NOV 87 - STE - PUT EXETYP IN COMMON RUNOPT; SAVE COMMON FUNCT
C  5 OCT 87 - MWS - CHANGE UNIX CPU TIMING MECHANISM
C 10 AUG 87 - MWS - INCLUDE ETA VERSION, NEW DATE IN BOX
C  1 JUL 87 - STE - MCCI: SAVE NRNFG,NPFLG FOR OVERLAY
C 20 MAY 87 - MWS - PERIODIC FLUSH OF CELERITY OUTPUT, FIX ABRT TIMSTR,
C                   USE XUFLOW INSTEAD OF ASSEMBLER ZUNDFL FOR IBM.
C 10 MAY 87 - STE - ABRT: PRINT FINAL TIMING INFO;  NEW DATE IN BOX
C  4 MAY 87 - STE - ORTHDN: INIDEN,ORTHO NO LONGER USE IA/IWRK IN QMATRX
C 12 FEB 87 - MWS - DELETE MSWRIT CALL IN ENERGX
C 30 NOV 86 - STE - CTSS: MATHLIB ROUTINE FOR TRACEBACK,  NEW DATE
C 18 NOV 86 - MWS - CTSS: CORRECT SPELLING OF MSGFRR
C  4 NOV 86 - STE - ROHF BUG FIXED, FPS VERSION CHECKED,  NEW DATE
C 15 OCT 86 - MWS - FIX CRAY TIMING, ADD DROPFILE, NEW DATE IN BOX,
C                   ADD CRAY/CTSS SPECIFIC CALLS TO GAMESS,
C                   REMOVE EXTRA ARGUMENT FROM MSWRIT CALL IN ENERGX
C 12 SEP 86 - MWS - ADD CELERITY TRACEBACK INSTRUCTION PRINTOUT
C 15 AUG 86 - MWS - MOVE SETFM BEHIND MAIN PROGRAM SO TRUE SIZE
C                   OF /FMCOM/ GETS LOADED FIRST, NEW DATE IN BOX.
C 30 JUL 86 - MWS - PAD COMMON ENRGYS
C  9 JUL 86 - MWS - SANITIZE FLOATING POINT CONSTANTS, BRING TMDATE,
C                   TSECND(NEE SECOND),ABRT,MCHPAR FROM IOLIB,
C                   ADD CODE FOR CRAY AND CELERITY VERSIONS.
C 20 JUN 86 - MWS - CHANGE DATE IN BOX, IBM VERSION DESCRIPTION
C  8 JAN 86 - STE - COUNT ENERGY EVALUATIONS, CALL ORTHDN 1X PER E
C 17 DEC 85 - STE - NEW DATE IN BOX; USE NEW TRANSFORMATION ROUTINES
C  4 DEC 85 - STE - HFGRAD: USE TEXIT AFTER CALLS TO JKD...
C 13 NOV 85 - STE - SETFM: USE FPS MEMORY MANAGEMENT ROUTINES
C                   DEFINE ALL LOGICAL UNIT NUMBERS IN MAIN PROG.
C 24 OCT 85 - STE - IMPROVE GRADIENT RESTART (ENERGX,HFGRAD)
C 14 OCT 85 - STE - USE GENERIC SQRT,ABS,MAX
C 10 OCT 85 - STE - ENERGX: ADD /ORDOPT/,/OUTPUT/ TO TURN OFF SYMMETRY
C                   WHEN NOPK=NORDER=1 BUT NOT AN MC OR CI RUN
C 10 SEP 85 - STE - INITIALIZE SOME VARIABLES, CHANGE FPS MEMORY
C 16 JUL 85 - MWS - PRINT FEWER INPUT CARDS, NEW DATE IN BOX
C 10 JUL 85 - MWS - HOLLERITH VERSION SPECIFICATION
C  9 MAR 85 - MWS - MISC CHANGES IN MAIN PROGRAM, NEW DATE IN BOX
C 27 JUL 84 - STE - NEW DATE: REMOVE MUCH REDUNDANT CODE,
C                   IMPROVE RESTART CAPABILITY
C 26 APR 84 - STE - ALLOW CI RESTARTS
C  8 MAR 84 - STE - NEW DATE:FIXES IN GUGDG,SIGMA,ZMATRX
C 26 FEB 84 - STE - PUT NEW DATE IN BOX (NEW GUGDG MODULE)
C  2 FEB 84 - STE - PUT NEW DATE IN BOX
C 17 JAN 84 - STE - HAVE TIMIT PRINT TOTAL REAL TIMES TOO
C 11 JAN 84 - STE - PRINT MAXIMUM MEMORY USED
C 27 DEC 83 - STE - INCLUDE MCCI AND WFN ROUTINES
C 26 DEC 83 - STE - FIX RMS GRADIENT VALUE IN GRADX
C 16 DEC 83 - STE - MOVE OPEN FOR UNITS 8 AND 9 TO START
C 29 NOV 83 - STE - DEFINE LOGICAL UNITS 7,8 AND 9 IN MAIN
C  4 NOV 83 - STE - ADD TIMIT,TIMREM,TEXIT AND SETFM TO MAIN MODULE
C                   MOVE CALL TO SETFM FROM START TO MCHPAR AND RETURN
C                   MEMSIZ TO MCHPAR TO SET LIMFM. PUT ERROR
C                   CONTROL IN MCHPAR WHICH WITH SECOND,TMDATE,ABRT
C                   GO TO IOLIB MODULE. MOVE BLOCK DATA INSIDE MAIN
C  8 JUN 83 - MWS - ADD INTRINSIC REACTION COORDINATE PATHFINDER
C  8 MAY 83 - MWS - RECOMPILED, MOVE IO STUFF TO IOLIB
C  7 MAY 83 - MWS - NEW SINGLE POINT GRADIENT DRIVER, SINCE THE
C                   OLD OPTX WAS TOSSED, MANY ROUTINES MOVED
C                   FROM THIS SEGMENT TO IOLIB, MTHLIB, ETC.
C  8 MAR 83 - MWS - ENERGX CALLS NEW ORTHDN TO ORTHOG OLD MO-S
C                   AND FIND DENSITY ON MULTIPLE GEOMETRY RUNS
C  2 MAR 83 - MWS - DEAD CODE ABORT AND ISOUT2 DELETED
C 22 FEB 83 - MWS - CALL TO ZUNDFL TO PREVENT UNDERFLOW COUNTING
C 18 DEC 82 - MWS - FOR RUNTYP CHECK, CALL TO DRTGEN
C DEC 14 82 - MWS - PRINT CPU MINUTES
C NOV  7 82 - MWS - NEW ROUTINE TMDATE, ELIMINATE ALL TRACES
C                   OF THAT IDIOT TIME FILE
C NOV  4 82 - MWS - DEFINE FILE INSTEAD OF CALL TO ZDFILE
C  3 NOV 82 - MWS - ECHO INPUT CARDS ON PAGE ONE OF OUTPUT
C 30 OCT 82 - MWS - PRINT TIME AND DATE AT JOB START,END
C  5 OCT 82 - MWS - CONVERT FOR IBM
C JUN 30 82 - MWS - KILL TIME SCALE FILE IN -TIMIT-
C 20 JUN 82 - MWS - QUENCH OUTPUT CONVERSION ERROR MESSAGE
C MAR 23 82 - MWS - PUT HSTARX ROUTINES IN THE SCF SECTIONS,
C
C GAMESS CAME ORIGINALLY WITH 400,000 WORDS OF FAST MEMORY
C
C*MODULE GAMESS  *DECK GAMESS
C> @brief   Main GAMESS program
C>
C> @details initialize parallel and other environments,
C>          read molecular specification (START),
C>          carry out desired run type (BRNCHX),
C>          properties such as localization at final geometry,
C>          terminate execution.
C>
C> @date October 2012 - Albert DeFusco
C> - Added Wei Li to list of contributors
C> - Added support for CIM subsystem branch
C>
      PROGRAM GAMESS
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      DIMENSION TIMSTR(3),CARD(10)
C
      LOGICAL AIMPAC,RPAC,PLTORB,MOLPLT
      LOGICAL GOPARR,DSKWRK,MASWRK
C
      CHARACTER*40 VERSN
      DOUBLE PRECISION MOROKM
C
      PARAMETER (MXCHRM=1,MXUNIT=299,maxtstp=25,MXATM=2000)
C
      COMMON /CHMGMS/ XCHM(MXCHRM),YCHM(MXCHRM),ZCHM(MXCHRM),
     *                DXELMM(MXCHRM),DYELMM(MXCHRM),DZELMM(MXCHRM),
     *                QCHM(MXCHRM),NCHMAT,KCHRMM
      COMMON /CIFILS/ NFT11,NFT12,NFT13,NFT14,NFT15,NFT16,IDAF20,NEMEMX
      COMMON /EFPFMO/ RUNEFP,REFFMO,REPNUCEFP,IEFPFMO,ISWENUC,EFPEFP
      COMMON /ELGPMT/ NELONG,NATM,NASPIN,NCT,NBNDAB,NTMLB,IPRI,LDOS
      COMMON /ELGRST/ IRSTRT,I2EA,IGOOD
      COMMON /FMOAPI/ FMOID(MXATM),FMOAPI_COORD,LAP,LKEEPER
      COMMON /FMOINF/ NFG,NLAYER,NATFMO,NBDFG,NAOTYP,NBODY
      COMMON /INTRFC/ FRIEND,AIMPAC,RPAC,PLTORB,MOLPLT
      COMMON /IOFILE/ IR,IW,IP,IJK,IJKT,IDAF,NAV,IODA(950)
      COMMON /MACHSW/ KDIAG,ICORFL,IXDR,modio
      COMMON /NEOJOB/ NEORUN,NELERM
      COMMON /OPNNFT/ NFTOPN(MXUNIT),NODEXT(MXUNIT),IOSMP(2)
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
      COMMON /PCMDIM/ MXSP,MXTS,MEMPCM1,MEMPCM2,NTS
      COMMON /PCMOPT/ RABI,RASC,REFPOL,THRSLS,DENSLS,WB,WA,ETA2,GD,EVAC,
     *                RHOW,PM,AREATL,AREAKP,BONDRY,OMEGA,RET,FRO,EPSINF,
     *                EPS,DR,RSOLV,VMOL,TCE,STEN,DSTEN,CMF,TABS,IDIRCT,
     *                IPCDER,IDP,ICOMP,IFIELD,ICAV,IDISP,IPRINT,IRETCAV,
     *                ICENT,IFAST,NEVAL,IEFPOL,KEEPSM,IMGABI,IMGASC,NADD
      COMMON /PCMPAR/ IPCM,NFT26,NFT27,IRPPCM,IEF,IP_F,NFMOPCM
      COMMON /RESTAR/ TIMLIM,IREST,NREC,INTLOC,IST,JST,KST,LST
      COMMON /RUNOPT/ RUNTYP,EXETYP,NEVALS,NGLEVL,NHLEVL
      COMMON /SOLSMX/ SOLA,SOLB,SOLC,SOLG,SOLH,SOLN,ISMX
      COMMON /stats/  timstp(maxtstp,4)
      COMMON /TMVALS/ TI,TX,TIM
      COMMON /WFNOPT/ SCFTYP,VBTYP,DFTYPE,TDDFTYP,CITYP,CCTYP,
     *                MPLEVL,MPCTYP
C
C     COSMO INFORMATION
C
      LOGICAL ISEPS,USEPS
      COMMON /ISEPS / ISEPS, USEPS
C
      PARAMETER (ZERO=0.0D+00)
C
      DATA CHECK  /8HCHECK   /
      DATA SURF   /8HSURFACE /,OPTFMO/8HOPTFMO  /,FMO0/8HFMO0    /
      DATA MOROKM /8HMOROKUMA/,GLOBOP /8HGLOBOP  /,FMOHESS/8HFMOHESS /
      DATA TDHF   /8HTDHF    /,OPTMIZ /8HOPTIMIZE/, SADPT  /8HSADPOINT/
      DATA BNDANA /8HBONDANAL/,HSSIAN /8HHESSIAN /,FMOMD  /8HMD      /
      DATA COMP   /8HCOMP    /
C
      DATA FSODCI,GENCI/8HFSOCI   ,8HGENCI   /
      DATA BLANK/8H        /
C
C     NO TIMING CALLS BEFORE BEGING --> DDI_PBEG BECAUSE MPI_WTIME IS UTILIZED IN
C     TSECND
C
      CALL BEGING(VERSN)
      CALL GMS_CCHEM_INITIALIZE()
C
      call vclr(timstp,1,maxtstp*4)
      call stopwa(1,0)
c
C     ----- CHARMM INTERFACE -----
C     TO USE GAMESS FROM INSIDE OF CHARMM, YOU MUST
C     1. INITIALIZE KCHRMM JUST BELOW TO 1, AND COMMENT OUT NCHMAT=0
C     2. CHANGE "PROGRAM GAMESS" ABOVE TO "SUBROUTINE GAMESS"
C     3. CHANGE THE "STOP" STATEMENT BELOW TO "RETURN"
C     4. DELETE DUMMY SUBROUTINES -CHGMIU- AND -CHMDAT- FROM IOLIB.SRC
C     5. CHANGE -MXCHRM- FROM 1 TO 25120 IN ALL PARAMETER DEFINITIONS
C        FOUND IN GAMESS,GRD1,INPUTB,INPUTC,INT1 MODULES
C
      KCHRMM=0
      NCHMAT=0
C
C     ----- ASSUME THIS IS NOT A NEO RUN -----
C
      NEORUN=0
      NELERM=0
C           ELONGATION FLAG
      IGOOD = 1
C
C        ----- DEFINE SOME BASIC LOGICAL UNITS -----
C
      IR    =  5
      IW    =  6
      IP    =  7
      IJK   =  8
      IJKT  =  9
      NFT11 = 11
      NFT12 = 12
      NFT13 = 13
      NFT14 = 14
      NFT15 = 15
      NFT16 = 16
      IDAF20= 20
C
      IOSMP(2)=0
C
C             ----- OPEN THE INPUT AND PUNCH FILES -----
C     ANYONE WHO WANTS TO DIRECT THE LOG FILE TO A DISK FILE, MAY SIMPLY
C     UNCOMMENT ITS OPEN, AND DEFINE THE ENVIRONMENT VARIABLE AS WISHED.
C     NOT OPENING UNIT 6 ON UNIX LEAVES THE OUTPUT FROM GAMESS GOING
C     INTO 'STANDARD OUTPUT', I.E. INTO THE NORMAL JOB LOG FILE.
C
      IF(KCHRMM.EQ.0) THEN
         CALL SEQOPN(IR,'INPUT', 'OLD',.TRUE., 'FORMATTED')
C---     CALL SEQOPN(IW,'OUTPUT','NEW',.FALSE.,'FORMATTED')
         CALL SEQOPN(IP,'PUNCH', 'NEW',.FALSE.,'FORMATTED')
      ELSE
C                 FOR THE UNLIKELY CASE OF INTERFACING TO CHARMM...
         CALL CHGMIU(IR,IW)
         CALL SEQOPN(IP,'PUNCH', 'NEW',.FALSE.,'FORMATTED')
      END IF
C
C     ----- PRINT THE GAMESS VERSION BANNER -----
C     ----- START THE CLOCK TICKING -----
C
      IF (MASWRK) THEN
         WRITE(IW,9050) VERSN
         WRITE(IW,9051)
         WRITE(IW,9052)
         CALL DDI_NNODE(NNODE,MYNODE)
         IF (GOPARR) WRITE(IW,9055) NPROC,NNODE
      END IF
      TI=ZERO
      TX=ZERO
      CALL TIMIT(0)
      CALL TMDATE(TIMSTR)
      IF (MASWRK) WRITE(IW,9001) TIMSTR
C
C     ---- ECHO INPUT TO OUTPUT FILE
C
      IF (MASWRK) WRITE(IW,9010)
      CALL SEQREW(IR)
      IF (MASWRK) THEN
         DO 20 I=1,50
            READ(IR,9020,END=30) CARD
            WRITE(IW,9030)       CARD
   20    CONTINUE
   30    CONTINUE
      END IF
C
C        SET UP PRIMITIVE FACTORS FOR ONE-ELECTRON INTEGRALS
C        INITIALIZE FOR THE INTEGRAL QUADRATURES
C
      CALL SETPNRM
      CALL SETRYS
      CALL SETHERMITE
C
C     ----- READ IN BASIS SET AND GET INITIAL MO'S -----
C
      CALL START
C
      CALL VALFM(INITFM)
C
C     ----- MP2 RUNS SHOULD NOT BE TOO EXOTIC -----
C
      IF((RUNTYP.EQ.MOROKM .OR. RUNTYP.EQ.TDHF) .AND.  MPLEVL.GT.0) THEN
         IF (MASWRK) WRITE(IW,9070) RUNTYP
         CALL ABRT
      END IF
C
C                     CHECK IF PARALLEL CI IS ENABLED
      IF((CITYP.EQ.FSODCI .OR. CITYP.EQ.GENCI) .AND.  GOPARR) THEN
         IF(MASWRK) WRITE(IW,9090) CITYP
         CALL ABRT
      END IF
C
      IF (TIM .GE. TIMLIM) THEN
         IF (MASWRK) WRITE(IW,*) 'OUT OF TIME, SEE TIMLIM IN $SYSTEM'
         CALL ABRT
      END IF
C
C     GET MEMORY FOR IN CORE 2E INTEGRALS
C
      CALL INT2EIC(0)
C
C     IF RUNTYP.EQ.'SURFACE ', SCAN POTENTIAL ENERGY SURFACE FOR THE
C     RUNTYP GIVEN IN $SURF.  MOST RUNS CAN PROCEED DIRECTLY TO THE
C     BRANCHING OFF ROUTINE, TO DO THE RUNTYP SELECTED IN $CONTRL.
C
      IF(NFG.NE.0) THEN
C              THE FIRST CALLS READS IN DATA AND DOES E+GRAD
C              FOR ENERGY/GRADIENT RUNS
C              SIGX NEED BE CALLED EXPLICITLY, AS IT CALLS FMOX ITSELF.
         RUNEFP=RUNTYP
C         IF (RUNTYP.EQ.GLOBOP) THEN
C            FMOAPI_COORD=0 
C            RUNTYP  = ENERGY
C            CALL FMOX(0)
C            RUNTYP = RUNEFP
C         ENDIF
         FMOAPI_COORD=0 
         IF(RUNTYP.EQ.HSSIAN) THEN
            CALL FMOX(0)
            CALL BRNCHX(RUNTYP)
         ELSE
           IF(RUNTYP.NE.OPTFMO.AND.RUNTYP.NE.FMO0.AND.RUNTYP.NE.FMOHESS)
     *        CALL FMOX(0)
         END IF
C
         IF(RUNTYP.EQ.OPTMIZ.OR.RUNTYP.EQ.SADPT.OR.RUNTYP.EQ.OPTFMO.OR.
     *      RUNTYP.EQ.FMO0.OR.RUNTYP.EQ.GLOBOP.OR.RUNTYP.EQ.FMOHESS.OR.
     *      RUNTYP.EQ.FMOMD) CALL BRNCHX(RUNTYP)
C
C     --- A NUCLEAR/ELECTRONIC ORBITAL RUN HAS ITS OWN BRANCHER ---
C
      ELSE IF(NEORUN.EQ.1) THEN
         CALL NEOCAL(RUNTYP)
      ELSE IF(RUNTYP.EQ.SURF) THEN
         CALL SURFX
      ELSE
C
C          AT LONG LAST, HERE IS THE MOST COMMON RUN TYPE PATHWAY.
C
         CALL BRNCHX(RUNTYP)
      END IF
C
C     ---NEW VALFM FOR CHANGES IN COMP.SRC TO MEMORY USAGE ---
C
      IF(RUNTYP.EQ.COMP) CALL VALFM(INITFM)
C
C        ----- FINAL PRINTOUT FOR PCM RUNS -----
C
      IF(IPCM.EQ.1  .AND.  RUNTYP.NE.COMP) THEN
C
C     ORIGINAL, non-SMD form:
C         CALCULATE CAVITATION AND/OR DISPERSION-REPULSION ENERGIES
C
         IF(ISMX.EQ.0) THEN
            IF(IFIELD.NE.0) CALL EFIELDM
            IF(ICAV.EQ.1)   CALL CAVITM
            IF(IDISP.EQ.1)  CALL DISRPM
            CALL SOLPRT
         ELSE
C
C     SMD form: CAVITATION-DISPERSION-SOLVENT-STRUCTURE (CDS) ENERGIES
C
            CALL SMDPRT
         END IF
      END IF
C
C     ----- PRINT OUT COSMO INFORMATION -----
C
      IF(ISEPS .AND. MASWRK) CALL COSPRT()
C
C
C        ----- POSSIBLE ORBITAL LOCALIZATION -----
C        ----- POSSIBLE MO TRUNCATION/LOCALIZATION -----
C
      IF(RUNTYP.NE.BNDANA.AND.NFG.EQ.0) CALL LMOX
      IF(NFG.EQ.0) CALL TRUNC
C
C             ELONGATION METHOD SPECIAL LOCALIZATION
      IF(IGOOD.EQ.0) THEN
         IF(MASWRK) THEN
            WRITE(IW,*) 'SOMETHING WRONG, HALT FURTHER RLMO CALCULATION'
         END IF
         CALL ABRT
      END IF
      IF(NELONG.GE.2.AND.RUNTYP.NE.TDHF) THEN
         IF(MASWRK) WRITE(IW,*) 'STARTING LOCALIZATIONS FOR ELONGATION'
         CALL GULOCL
         IF(MASWRK) WRITE(IW,*)
     *        '....DONE WITH ELONGATION METHOD LOCALIZATION...'
        CALL TIMIT(1)
      END IF
C
C     RETURN MEMORY FOR IN CORE 2E INTEGRALS AND PCM
C     THE CALL ORDER TO INT2EIC(1), RETFM(MEMPCM2) AND RETFM(MEMPCM1)
C     IS IMPORTANT AND MUST BE EXACTLY OPPOSITE TO THE CALLING SEQUENCE.
C
      CALL INT2EIC(1)
      IF(IPCM.NE.0) THEN
        CALL RETFM(MEMPCM2)
        CALL RETFM(MEMPCM1)
        IF(RUNTYP.NE.COMP) INITFM=INITFM-MEMPCM1-MEMPCM2
C          INITFM AS COMPUTED ABOVE DID NOT KNOW ABOUT PCM MEMORY
C          ALLOCATED IN START
      END IF
C
C        ----- INTERFACES TO OTHER PROGRAMS -----
C     FOR FMO RUNS THE CALLS BELOW WILL GENERATE DATA ONLY FOR THE LAST
C     PIECE COMPUTED (SOME DIMER USUALLY), WHICH NORMALLY DOES NOT MAKE
C     SENSE. NOTE THAT PLTORB DATA IS GENERATED IN MONOSCF FOR CERTAIN
C     OPTIONS AND FOR CERTAIN FRAGMENTS (MONOMERS).
C
      IF(NFG.EQ.0) THEN
         IF(PLTORB) CALL PLTMEM
         IF(MOLPLT) CALL MOLMEM
         IF(AIMPAC  .AND.  EXETYP.NE.CHECK) CALL AIMMEM
         IF(RPAC    .AND.  EXETYP.NE.CHECK) CALL RPACX
         IF(FRIEND.NE.BLANK) CALL ZEALX
      END IF
C
C        ----- ALL DONE -----
C
      IF(IP.NE.7  .AND.  MASWRK) WRITE(IW,9105) IP
C
      call stopwa(1,1)
      if(iand(modio,4).eq.0) call prttim
c
      CALL VALFM(LASTFM)
      IF(LASTFM.NE.INITFM  .AND.  MASWRK) WRITE(IW,9100) LASTFM-INITFM
      CALL BIGFM(MAXMEM)
      CALL TMDATE(TIMSTR)
      IF (MASWRK) WRITE(IW,9002) TIMSTR
      CALL ENDING
      STOP
C
 9001 FORMAT(' EXECUTION OF GAMESS BEGUN ',3A8)
 9002 FORMAT(' EXECUTION OF GAMESS TERMINATED NORMALLY ',3A8)
 9010 FORMAT(/1X,11X,'ECHO OF THE FIRST FEW INPUT CARDS -')
 9020 FORMAT(10A8)
 9030 FORMAT(1X,'INPUT CARD>',10A8)
 9050 FORMAT(10X,54(1H*)/
     *     10X,1H*,9X,'GAMESS VERSION =  1 MAY 2013 (R1)',10X,1H*/
     *     10X,1H*,13X,'FROM IOWA STATE UNIVERSITY',13X,1H*/
     *     10X,1H*,1X,
     *  'M.W.SCHMIDT, K.K.BALDRIDGE, J.A.BOATZ, S.T.ELBERT,',1X,1H*/
     *     10X,1H*,3X,
     *  'M.S.GORDON, J.H.JENSEN, S.KOSEKI, N.MATSUNAGA,',3X,1H*/
     *     10X,1H*,10X,
     *  'K.A.NGUYEN, S.J.SU, T.L.WINDUS,',11X,1H*/
     *     10X,1H*,7X,
     *  'TOGETHER WITH M.DUPUIS, J.A.MONTGOMERY',7X,1H*/
     *     10X,1H*,9X,
     *  'J.COMPUT.CHEM.  14, 1347-1363(1993)',8X,1H*/
     *     10X,7(1H*),A40,7(1H*))
 9051 FORMAT(/2X,'SINCE 1993, STUDENTS AND POSTDOCS',
     *     ' WORKING AT IOWA STATE UNIVERSITY'/
     *  2X,'AND ALSO IN THEIR VARIOUS JOBS AFTER LEAVING ISU HAVE MADE',
     *     ' IMPORTANT'/
     *  2X,'CONTRIBUTIONS TO THE CODE:'/
     *  5X,'IVANA ADAMOVIC, CHRISTINE AIKENS, YURI ALEXEEV,',
     *     ' POOJA ARORA,'/
     *  5X,'ANDREY ASADCHEV, ROB BELL, PRADIPTA BANDYOPADHYAY,',
     *     ' JONATHAN BENTZ,'/
     *  5X,'BRETT BODE, GALINA CHABAN, WEI CHEN, CHEOL HO CHOI,',
     *     ' PAUL DAY,'/
     *  5X,'ALBERT DEFUSCO, TIM DUDLEY, DMITRI FEDOROV,',
     *     ' GRAHAM FLETCHER,'/
     *  5X,'MARK FREITAG, KURT GLAESEMANN, DAN KEMP, GRANT MERRILL,'/
     *  5X,'NORIYUKI MINEZAWA, JONATHAN MULLIN, TAKESHI NAGATA,'/
     *  5X,'SEAN NEDD, HEATHER NETZLOFF, BOSILJKA NJEGIC,',
     *     ' RYAN OLSON, MIKE PAK,'/
     *  5X,'JIM SHOEMAKER, LYUDMILA SLIPCHENKO, SAROM SOK, JIE SONG,'/
     *  5X,'TETSUYA TAKETSUGU, SIMON WEBB, SOOHAENG YOO,',
     *     ' FEDERICO ZAHARIEV')
 9052 FORMAT(/2X,'ADDITIONAL CODE HAS BEEN PROVIDED BY COLLABORATORS',
     *     ' IN OTHER GROUPS:'/
     *  5X,'IOWA STATE UNIVERSITY:'/
     * 10X,'JOE IVANIC, LAIMUTIS BYTAUTAS, KLAUS RUEDENBERG'/
     *  5X,'UNIVERSITY OF TOKYO: KIMIHIKO HIRAO, TAKAHITO NAKAJIMA,'/
     * 10X,'TAKAO TSUNEDA, MUNEAKI KAMIYA, SUSUMU YANAGISAWA,'/
     * 10X,'KIYOSHI YAGI, MAHITO CHIBA, SEIKEN TOKURA, NAOAKI KAWAKAMI'/
     *  5X,'UNIVERSITY OF AARHUS: FRANK JENSEN'/
     *  5X,'UNIVERSITY OF IOWA: VISVALDAS KAIRYS, HUI LI'/
     *  5X,'NATIONAL INST. OF STANDARDS AND TECHNOLOGY: WALT STEVENS,',
     *     ' DAVID GARMER'/
     *  5X,'UNIVERSITY OF PISA: BENEDETTA MENNUCCI, JACOPO TOMASI'/
     *  5X,'UNIVERSITY OF MEMPHIS: HENRY KURTZ, PRAKASHAN KORAMBATH'/
     *  5X,'UNIVERSITY OF ALBERTA: TOBY ZENG, MARIUSZ KLOBUKOWSKI'/
     *  5X,'UNIVERSITY OF NEW ENGLAND: MARK SPACKMAN'/
     *  5X,'MIE UNIVERSITY: HIROAKI UMEDA'/
     *  5X,'MICHIGAN STATE UNIVERSITY:'/
     * 10X,'KAROL KOWALSKI, MARTA WLOCH, JEFFREY GOUR, JESSE LUTZ,'/
     * 10X,'WEI LI, PIOTR PIECUCH'/
     *  5X,'UNIVERSITY OF SILESIA: MONIKA MUSIAL, STANISLAW KUCHARSKI'/
     *  5X,'FACULTES UNIVERSITAIRES NOTRE-DAME DE LA PAIX:'/
     * 10X,'OLIVIER QUINET, BENOIT CHAMPAGNE'/
     *  5X,'UNIVERSITY OF CALIFORNIA - SANTA BARBARA: BERNARD KIRTMAN'/
     *  5X,'INSTITUTE FOR MOLECULAR SCIENCE:'/
     * 10X,'KAZUYA ISHIMURA, MICHIO KATOUDA, AND SHIGERU NAGASE'/,
     *  5X,'UNIVERSITY OF NOTRE DAME: DAN CHIPMAN'/
     *  5X,'KYUSHU UNIVERSITY:'/
     *    10X,'HARUYUKI NAKANO,'/
     *    10X,'FENG LONG GU, JACEK KORCHOWIEC,',
     *     ' MARCIN MAKOWSKI, AND YURIKO AOKI,'/
     *    10X,'HIROTOSHI MORI AND EISAKU MIYOSHI'/
     *  5X,'PENNSYLVANIA STATE UNIVERSITY:'/10X,'TZVETELIN IORDANOV,',
     *     ' CHET SWALINA, JONATHAN SKONE,'/
     * 10X,'SHARON HAMMES-SCHIFFER'/
     *  5X,'WASEDA UNIVERSITY:'/
     *    10X,'MASATO KOBAYASHI, TOMOKO AKAMA, TSUGUKI TOUMA,'/
     *    10X,'TAKESHI YOSHIKAWA, YASUHIRO IKABATA, HIROMI NAKAI'/
     *  5X,'NANJING UNIVERSITY: SHUHUA LI'/
     *  5X,'UNIVERSITY OF NEBRASKA:'/
     * 10X,'PEIFENG SU, DEJUN SI, NANDUN THELLAMUREGE, YALI WANG,',
     *     ' HUI LI'/
     *  5X,'UNIVERSITY OF ZURICH:'/
     * 10X,'ROBERTO PEVERATI, KIM BALDRIDGE'/
     *  5X,'N. COPERNICUS UNIVERSITY AND JACKSON STATE UNIVERSITY:',/
     * 10X,'MARIA BARYSZ'/)
 9055 FORMAT(/1X,'PARALLEL VERSION RUNNING ON',I6,' PROCESSORS IN',
     *        I6,' NODES.'/)
 9070 FORMAT(/1X,'***** ERROR ***** GAMESS DOES NOT PERMIT RUNTYP=',
     *       A8,' WITH MP2')
 9090 FORMAT(/1X,'**** ERROR *****'/
     *        1X,'CI PROGRAM CITYP=',A8,' DOES NOT RUN IN PARALLEL.'/
     *        1X,'PARALLEL CI IS $CONTRL CITYP=CIS/ALDET/ORMAS/GUGA.')
 9100 FORMAT(///'* * * * ERROR * * * *'/
     *      1X,'MEMORY LEAK DETECTED.',I10,
     *         ' WORDS ARE STILL ALLOCATED SOMEWHERE'///)
 9105 FORMAT(///'* * * * ERROR * * * * PUNCH OUTPUT UNIT NUMBER',
     *          ' IS TRASHED, IP=',I10)
      END
C*MODULE GAMESS  *DECK BRNCHX
      SUBROUTINE BRNCHX(RUNTYP)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      DOUBLE PRECISION MOROKM,MD,MAKEFP,NMR,NACME,LMOEDA
      COMMON /FFPARM/ NFFAT,NBOND,NANGL,NDIHR,NDIHB,NCMAP,NWAGG,
     *                N1213J,N14J,NLKQMM,IDOCHG,IDOPOL,IDOLJ,IDOCMAP
      COMMON /FMOINF/ NFG,NLAYER,NATFMO,NBDFG,NAOTYP,NBODY
C
      DATA ENERGY /8HENERGY  /, GRAD   /8HGRADIENT/, HSSIAN /8HHESSIAN /
      DATA PROP   /8HPROP    /, OPTMIZ /8HOPTIMIZE/, SADPT  /8HSADPOINT/
      DATA AIRC   /8HIRC     /, DRC    /8HDRC     /, AMEX   /8HMEX     /
      DATA MOROKM /8HMOROKUMA/, TRNSTN /8HTRANSITN/, TRUDGE /8HTRUDGE  /
      DATA FFIELD /8HFFIELD  /, TDHF   /8HTDHF    /, XTDHF  /8HTDHFX   /
      DATA GRDXTR /8HGRADEXTR/, MAKEFP /8HMAKEFP  /, MD     /8HMD      /
      DATA VSCF   /8HVSCF    /, RAMAN  /8HRAMAN   /, GLOBOP /8HGLOBOP  /
      DATA NMR    /8HNMR     /
      DATA FMO0   /8HFMO0    /, OPTFMO /8HOPTFMO  /, BNDANA /8HBONDANAL/
      DATA NACME  /8HNACME   /, G3MP2  /8HG3MP2   /, GAMMA  /8HGAMMA   /
      DATA LMOEDA /8HLMOEDA  /, FMOHESS/8HFMOHESS /, COMP   /8HCOMP    /
      DATA CONICL /8HCONICAL /, QMEFPEA/8HQMEFPEA /
      DATA CIMFINAL/8HCIMFINAL/,CIMSUB /8HCIMSUB  /
C
C     ----- BRANCH ACCORDING TO RUNTYP TO APPROPRIATE DRIVER -----
C
C     IF RUNTYP.EQ.'ENERGY  ', CALCULATE ENERGY
C     IF RUNTYP.EQ.'GRADIENT', CALCULATE ENERGY+GRADIENT
C     IF RUNTYP.EQ.'HESSIAN ', CALCULATE ENERGY+GRADIENT+HESSIAN
C     IF RUNTYP.EQ.'GAMESS  ', CALCULATE ENERGY+GRADIENT+HESSIAN+3RD
C     IF RUNTYP.EQ.'OPTIMIZE', OPTIMIZE MOLECULAR GEOMETRY
C     IF RUNTYP.EQ.'SADPOINT', LOCATE A TRANSITION STATE
C     IF RUNTYP.EQ.'MEX     ', MINIMUM ENERGY CROSSING POINT SEARCH
C     IF RUNTYP.EQ.'TRUDGE  ', NONGRADIENT GEOMETRY/EXPONENT OPTIM.
C     IF RUNTYP.EQ.'GLOBOP  ', RUN MONTE CARLO GLOBAL OPTIMIZATION
C     IF RUNTYP.EQ.'IRC     ', TRACE REACTION PATH
C     IF RUNTYP.EQ.'DRC     ', FOLLOW DYNAMIC REACTION COORDINATE
C     IF RUNTYP.EQ.'GRADEXTR', FOLLOW A GRADIENT EXTREMAL
C     IF RUNTYP.EQ.'MOROKUMA', PERFORM MOROKUMA ANALYSIS
C     IF RUNTYP.EQ.'SPINORBT', COMPUTE SPIN-ORBIT COUPLING
C     IF RUNTYP.EQ.'TRANSITN', COMPUTE TRANSITION MOMENT
C     IF RUNTYP.EQ.'FFIELD  ', COMPUTE POLARIZABILITY
C     IF RUNTYP.EQ.'TDHF    ', FREQUENCY DEPENDENT OPTICAL PROPERTIES
C     IF RUNTYP.EQ.'TDHFX   ', EXTENDED PACKAGE FOR ADDITIONAL
C                              FREQUENCY DEPENDENT OPTICAL PROPERTIES
C     IF RUNTYP.EQ.'RAMAN   ', COMPUTE RAMAN SPECTRUM INTENSITY
C     IF RUNTYP.EQ.'PROP    ', CALCULATE PROPERTIES ONLY
C     IF RUNTYP.EQ.'MAKEFP  ', MAKE AN EFFECTIVE FRAGMENT POTENTIAL
C     IF RUNTYP.EQ.'QMEFPEA ', ENERGY DECOMPOSITION FOR ALL QM/EFP
C     IF RUNTYP.EQ.'OPTFMO  ', OPTIMISE MOLECULAR GEOMETRY FOR FMO
C     IF RUNTYP.EQ.'FMO0    ', 0-BODY FMO
C     IF RUNTYP.EQ.'BONDANAL', AUTOMATED BONDING ANALYSIS
C     IF RUNTYP.EQ.'CONICAL ', LOCATE A CONICAL INTERSECTION
C     IF RUNTYP.EQ.'G3MP2   ', CALCULATE G3(MP2,CCSD(T))
C     IF RUNTYP.EQ.'COMP    ', COMPOSITE METHOD FORMULATION
C
C     THE RUNTYP OF 'SURFACE' IS HANDLED ELSEWHERE.
C
      IF(RUNTYP.EQ.ENERGY) CALL ENERGX
      IF(RUNTYP.EQ.GRAD  ) CALL GRADX
      IF(RUNTYP.EQ.HSSIAN) CALL HESSX(.FALSE.,.FALSE.)
      IF(RUNTYP.EQ.GAMMA)  CALL GAMMAX
      IF(RUNTYP.EQ.OPTMIZ.AND.NFFAT.EQ.0) CALL SIGX(.FALSE.)
      IF(RUNTYP.EQ.OPTMIZ.AND.NFFAT.GT.0) CALL FFOPTX
      IF(RUNTYP.EQ.SADPT )                CALL SIGX(.FALSE.)
      IF(RUNTYP.EQ.AMEX)   CALL MEXNGX
      IF(RUNTYP.EQ.TRUDGE) CALL TRUDGX
      IF(RUNTYP.EQ.GLOBOP) CALL GLOPDR
      IF(RUNTYP.EQ.AIRC  ) CALL IRCX
      IF(RUNTYP.EQ.DRC)    CALL DRCX
      IF(RUNTYP.EQ.MD.AND.NFFAT.EQ.0) CALL MDX
      IF(RUNTYP.EQ.MD.AND.NFFAT.GT.0) CALL FFMDX
      IF(RUNTYP.EQ.GRDXTR) CALL GRADEX
      IF(RUNTYP.EQ.VSCF)   CALL VSCFX
      IF(RUNTYP.EQ.MOROKM) CALL MOROX
      IF(RUNTYP.EQ.TRNSTN) CALL TRNMOMX
      IF(RUNTYP.EQ.FFIELD) CALL FFLDX
      IF(RUNTYP.EQ.TDHF)   CALL TDHFX
      IF(RUNTYP.EQ.XTDHF)  CALL TDHFXMAIN
      IF(RUNTYP.EQ.RAMAN)  CALL RAMANX
      IF(RUNTYP.EQ.NMR)    CALL NMRX
      IF(RUNTYP.EQ.PROP  ) THEN
         CALL ONEEI
         CALL GUESMO(GUESS)
         CALL PROPTY('PROP')
      END IF
      IF(RUNTYP.EQ.MAKEFP) CALL EFPX
      IF(RUNTYP.EQ.OPTFMO) CALL OPTFMOX
      IF(RUNTYP.EQ.FMO0)   CALL FMO0X
      IF(RUNTYP.EQ.BNDANA) CALL BNDANX
      IF(RUNTYP.EQ.G3MP2)  CALL G3MP2X
      IF(RUNTYP.EQ.COMP)   CALL COMPX
      IF(RUNTYP.EQ.NACME)  CALL NACMEX(.TRUE.)
      IF(RUNTYP.EQ.LMOEDA) CALL LMOEDAX
      if(runtyp.eq.cimsub.or.runtyp.eq.cimfinal) call cimx(runtyp)
      IF(RUNTYP.EQ.QMEFPEA) CALL QMEFPEAX
      IF(NFG.NE.0) CALL CLOSEFRG
      IF(RUNTYP.EQ.FMOHESS) CALL FMOHESSX(.FALSE.,.FALSE.)
      IF(RUNTYP.EQ.CONICL) CALL SIGX(.FALSE.)
C
      RETURN
      END
C*MODULE GAMESS  *DECK ENERGX
      SUBROUTINE ENERGX
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      LOGICAL GOPARR,DSKWRK,MASWRK,VTSCAL,VIROK,LVCLN,SVGPAR,CAMFLAG,
     *        DIRTRF,MMONLY,QMMM,ABEL,ABELPT,LCFLAG,LRINT,LCFLAGS,LRINTS
      LOGICAL SECONDD
C
      PARAMETER (MXATM=2000, MXSH=5000, MXGTOT=20000, MXRT=100,
     *           MXFRG=1050, MXDFG=5, MXDPPT=MXFRG*MXDFG*12)
C
      COMMON /CXTHRM/ CXTHERM(11),CXZPE,METHCX,ICXBAS,ICXPCM,SECONDD
      COMMON /DFTPAR/ DFTTYP(20),EXENA,EXENB,EXENC,IDFT34,NAUXFUN,
     *                                                    NAUXSHL
      COMMON /DFTCAM/ ALPHAC,BETAC,CAMMU,CAMVWN,CAMLYP,CAMFLAG
      COMMON /ENRGYS/ ENUCR,EELCT,ETOT,SZ,SZZ,ECORE,ESCF,EERD,E1,E2,
     *                VEN,VEE,EPOT,EKIN,ESTATE(MXRT),STATN,EDFT(2),EDISP
      COMMON /ENRGMP/ EMP2,EMP3,EMP4,EMP2A
      COMMON /FF    / NFFLVL
      COMMON /FRGINF/ NMPTS(MXFRG),NMTTPT,IEFC,IEFD,IEFQ,IEFO,
     *                NPPTS(MXFRG),NPTTPT,IEFP,
     *                NRPTS(MXFRG),NRTTPT,IREP,ICHGP,NFRG,
     *                NDPPTS(MXDPPT),NDPTTPT,IEFDP,LSTMPTS(MXFRG),
     *                NBSFN(MXFRG),NMXMO(MXFRG)
      COMMON /FUNCT / E,EG(3*MXATM)
      COMMON /INFOA / NAT,ICH,MUL,NUM,NQMT,NE,NA,NB,
     *                ZAN(MXATM),C(3,MXATM),IAN(MXATM)
      COMMON /IOFILE/ IR,IW,IP,IJK,IJKT,IDAF,NAV,IODA(950)
      COMMON /MEXOPT/ MEXSKPGES,MEXSTATE
      COMMON /NEOJOB/ NEORUN,NELERM
      COMMON /NLRC  / LCFLAG,LRINT,EMU,EMU2,LRFILE
      COMMON /NSHEL / EX(MXGTOT),CS(MXGTOT),CP(MXGTOT),CD(MXGTOT),
     *                CF(MXGTOT),CG(MXGTOT),CH(MXGTOT),CI(MXGTOT),
     *                KSTART(MXSH),KATOM(MXSH),KTYPE(MXSH),KNG(MXSH),
     *                KLOC(MXSH),MIN(MXSH),MAX(MXSH),NSHELL
      COMMON /ORDOPT/ NORDER,NDAR,LDAR,NBOXMX,NWORD,NOMEM,NSQUAR
      COMMON /OUTPUT/ NPRINT,ITOL,ICUT,NORMF,NORMP,NOPK
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
      COMMON /PCMITR/ RCUT(2),THRES,IPCMIT,IMUL,MXDIIS,NREG,MXITR1,
     *                MXITR2,MODPAP
      COMMON /PCMOPT/ RABI,RASC,REFPOL,THRSLS,DENSLS,WB,WA,ETA2,GD,EVAC,
     *                RHOW,PM,AREATL,AREAKP,BONDRY,OMEGA,RET,FRO,EPSINF,
     *                EPS,DR,RSOLV,VMOL,TCE,STEN,DSTEN,CMF,TABS,IDIRCT,
     *                IPCDER,IDP,ICOMP,IFIELD,ICAV,IDISP,IPRINT,IRETCAV,
     *                ICENT,IFAST,NEVAL,IEFPOL,KEEPSM,IMGABI,IMGASC,NADD
      COMMON /PCMPAR/ IPCM,NFT26,NFT27,IRPPCM,IEF,IP_F,NFMOPCM
      COMMON /PCMPRT/ GCAVP,GCAVS,GDISP,GREP,EHFGAS
      COMMON /RESTAR/ TIMLIM,IREST,NREC,INTLOC,IST,JST,KST,LST
      COMMON /RUNOPT/ RUNTYP,EXETYP,NEVALS,NGLEVL,NHLEVL
      COMMON /SIMDAT/ NACC,NREJ,IGOMIN,NRPA,IBWM,NACCT,NREJT,NRPAT,
     *                NPRTGO,IDPUNC,IGOFLG
      COMMON /SYMTRY/ MAPSHL(MXSH,48),MAPCTR(MXATM,48),
     *                T(432),INVT(48),NT
      COMMON /TINOPT/ MPARTI,MMONLY, QMMM
      COMMON /TMVALS/ TI,TX,TIM
      COMMON /TRFOPT/ CUTTRF,NWDTRF,MPTRAN,ITRFAO,NOSYMT,IPURTF,DIRTRF
      COMMON /VIRIAL/ SCALTE,SCALTT,GVIR,VTCONV,MAXVT,VTSCAL,VIROK,LVCLN
      COMMON /WFNOPT/ SCFTYP,VBTYP,DFTYPE,TDDFTYP,CITYP,CCTYP,
     *                MPLEVL,MPCTYP
      COMMON /ZMTALT/ NZMAT2,NZVAR2,NVAR2,NZMTRD,ICOORD
C
C     CHANGE FOR DIVIDE-AND-CONQUER METHOD
C
      LOGICAL DCFLG
      COMMON /DCOPT / SUBTYP,BUFTYP,SUBLNG,BUFRAD,NDCPRT,NSUBS,DCFLG
      DATA RDDM   /8HDMREAD  /
C
      DATA RMC    /8HMCSCF   /
      DATA RNONE  /8HNONE    /
      DATA GUGA   /8HGUGA    /
      DATA ENERGY /8HENERGY  /
      DATA OPTMIZ /8HOPTIMIZE/
      DATA SADPT  /8HSADPOINT/
      DATA AMEX   /8HMEX     /
      DATA GLOBOP /8HGLOBOP  /
      DATA COMP   /8HCOMP    /
      DATA TWO /2.0D+00/, OLDHSS/0.0D+00/, ISCF/0/
      DATA SCALTX/0.0D+00/
C
C     ----- CALCULATE THE ENERGY OF THE MOLECULE -----
C     IREST = 0     NORMAL START AND NORMAL RUNNING CONDITION.
C     IREST = 1     2E-INTEGRAL RESTART ( 1E + MO'S SAVED)
C     IREST = 2     SCF RESTART ( 1E + MO'S SAVED; 2E SAVED)
C     IREST = 5     MP2 RESTART (SKIP SCF, DO ONLY MP2: USED BY FMO-MP2)
C
C     ENERGY CALCULATION WITH CARTESIAN 2ND AND 3RD DERIVATIVE MATRIX
C
      IF(NFFLVL.GE.2)THEN
         CALL FFCART
         RETURN
      ENDIF
C
C     TINKER MM ENERGY CALCULATION
C
      IF ((QMMM .OR. MMONLY) .AND. (RUNTYP .EQ. ENERGY)) THEN
         IF(MASWRK) CALL ANALYZE
         IF(MMONLY) RETURN
      END IF
C
C     ----- COORD=FRAGONLY GOES OFF SEPARATELY FROM QM RUNS -----
C     QM+EFP NEEDS TO SET UP PARALLEL WORK BALANCING FOR EFP RUNS
C
      IF(ICOORD.EQ.4) THEN
         CALL EFSP
         RETURN
      ELSE
         IF(NFRG.GT.0) CALL EFPPARL
      END IF
C
C          SUPPRESS PRINTING DURING MONTE CARLO RUNS
      IF(RUNTYP.EQ.GLOBOP) THEN
         NPRTGO=2
      ELSE
         NPRTGO=1
      END IF
C
C          OPTION FOR SCALING EXPONENTS TO SATISFY VIRIAL THEOREM
C
      IF(LVCLN) THEN
         ISCF=1
         GO TO 80
      END IF
  50  ISCF=ISCF+1
      E = ETOT
C
C          LONG RANGE CORRECTION (TD-DFT AND DFT CALCULATIONS)
C
      LCFLAGS=LCFLAG
      LRINTS=LRINT
      IF(DFTYPE.EQ.RNONE) THEN
        LCFLAG=.FALSE.
        LRINT=.FALSE.
      ENDIF
c
      call stopwa(2,0)
C
C     ----- PREPARE DIVIDE-AND-CONQUER INDICES -----
C
      IF (DCFLG) CALL DFLCST(0,.TRUE.)
C
C     ----- 1E- INTEGRALS -----
C
      IF(RUNTYP.NE.AMEX) THEN
         IF(IREST.LE.1) CALL ONEEI
      ELSE
         IF(MEXSTATE.EQ.1) CALL ONEEI
      END IF
      IF(TIM.GE.TIMLIM) GO TO 120
C
C     ----- PREPARE INITIAL ORBITALS -----
C     THIS IS EITHER DOING THE FIRST GUESS, OR ORTHONORMALIZING
C     ORBITALS FROM A PREVIOUS GEOMETRY, MAKING NEW DENSITY MATRIX.
C     NOTE: BOTH CALLS GENERATE THE -Q- MATRIX AT THE CURRENT GEOMETRY.
C
      IF(RUNTYP.NE.AMEX) THEN
         IF(NEVALS.EQ.0) THEN
            CALL GUESMO(GUESS)
         ELSE IF (DCFLG) THEN
            GUESS = RDDM
            DUMMY = 0.0D+00
            CALL GUESDC(0,GUESS,0,DUMMY,DUMMY,
     *                  .FALSE.,.FALSE.,.FALSE.,.FALSE.,.FALSE.,0)
         ELSE
            IF(IREST.NE.5) CALL ORTHDN
C           FOR FMO-MP2 GRADIENTS ORTHDN MUST HAVE BEEN CALLED DURING
C           FMO-RHF GRADIENT, AND NOW (FMO-MP2) NO SCF IS DONE.
         END IF
      ELSE
         IF(MEXSKPGES.EQ.1) THEN
            CALL ORTHDN
         ELSE
            CALL GUESMO(GUESS)
         END IF
      END IF
C
C     ----- 1E- INTEGRALS FOR DFT -----
C     THIS REQUIRES ONE KNOW THE ORBITALS, SO AFTER ORBITAL SELECTION
C
      IF (DFTTYP(1) .NE. 0.0D+00) CALL DFTINT
C
C     ----- RESET SYMMETRY IF USER REQUESTED INTEGRAL ORDERING -----
C
      NTSAVE = NT
      IF(NOPK.EQ.1  .AND.  NORDER.EQ.1) NT=1
C
C     ----- 2E- INTEGRALS -----
C
      ABEL = ABELPT()
      SVGPAR = GOPARR
      IF(SCFTYP.EQ.RMC  .AND.  ITRFAO.EQ.1) GOPARR=.FALSE.
      IF(SCFTYP.EQ.RMC  .AND.  .NOT.ABEL) NT=1
      IF(LCFLAG .OR. CAMFLAG) THEN
          LRINT=.TRUE.
          IF(IREST.LE.1  .AND.  SCFTYP.NE.RNONE) CALL JANDK
          LRINT=.FALSE.
      END IF
      IF(RUNTYP.NE.AMEX) THEN
         IF(IREST.LE.1  .AND.  SCFTYP.NE.RNONE) CALL JANDK
      ELSE
         IF(MEXSTATE.EQ.1) CALL JANDK
      END IF
      GOPARR = SVGPAR
      NT     = NTSAVE
      call stopwa(2,1)
      IF(TIM.GE.TIMLIM) GO TO 120
C
C     --- NEO RUN MAY REQUIRE INTEGRAL AND INITIAL GUESS SET UP ---
C
      IF(NEORUN.EQ.1) THEN
         IF(NEVALS.EQ.0) THEN
            CALL NEOSET(.TRUE.,.TRUE.)
         ELSE
            CALL NEOSET(.TRUE.,.FALSE.)
         END IF
      END IF
C
C     ----- PCM CALCULATION, STEP 1 -----
C           REASON: CAV+DIS+REP CAN BE ADDED TO SCF ENERGY
C
      IF (RUNTYP.EQ.COMP) THEN
       IPCM=ICXPCM
      END IF
      IF(IPCM.EQ.1) THEN
        NPRTBK=NPRINT
        NPRINT=817
        GCAVP=0.0D+00
        GDISP=0.0D+00
        GREP=0.0D+00
        IF(ICAV.EQ.1) THEN
          CALL CAVITM
          IF(MASWRK)WRITE(IW,*)' '
          IF(MASWRK)WRITE(IW,*)'DONE CAVITATION ENERGY'
          IF(MASWRK)CALL TIMIT(1)
        END IF
        IF(IDISP.EQ.1) THEN
          CALL DISRPM
          IF(MASWRK)WRITE(IW,*)' '
          IF(MASWRK)WRITE(IW,*)
     *      'DONE DISPERSION-REPULSION ENERGY'
          IF(MASWRK)CALL TIMIT(1)
        END IF
        NPRINT=NPRTBK
      END IF
C
C     FOR SINGLE POINT ENERGY JOBS, IT IS BETTER TO DO A GAS PHASE
C     ENERGY AND THEN THE PCM, SO WE HAVE CORRECT SOLVATION ENERGY
C     MODPAP=2 OMITS RUNNING GAS PHASE ENERGY
C
      IF(RUNTYP.EQ.ENERGY.AND.IAND(MODPAP,2).EQ.0.AND.IPCM.EQ.1
     *   .AND.TDDFTYP.EQ.RNONE) IPCM=10
 130  CONTINUE
C
      IF(IPCM.EQ.1) CALL SOLVNT
C
C     ----- CALCULATE WAVEFUNCTION -----
C
      IF(IREST.LE.2.OR.IREST.EQ.5) CALL WFN
      NEVALS = NEVALS + 1
      IF(TIM.GE.TIMLIM) GO TO 120
C
      IF(IPCM.EQ.10) THEN
          EHFGAS = ETOT
          IF(MPLEVL.EQ.2) EHFGAS=EMP2
          IPCM = 1
          GO TO 130
      END IF
C
C     MOST JOBS NOW EXIT FROM THIS ROUTINE
C
      IF(.NOT.VTSCAL) GO TO 120
C
C     ----- OPTIONAL VIRIAL SCALING -----
C
      IF(MPLEVL.GT.0 .OR.  CITYP.NE.RNONE .OR. CCTYP.NE.RNONE
     *               .OR. DFTYPE.NE.RNONE .OR. VBTYP.NE.RNONE) THEN
         IF(MASWRK) WRITE(IW,*) ' VTSCAL IS IMPLEMENTED FOR SCF ONLY'
         CALL ABRT
      END IF
      IF(RUNTYP.NE.OPTMIZ  .AND.  RUNTYP.NE.SADPT
     *                     .AND.  RUNTYP.NE.ENERGY) THEN
         IF(MASWRK) WRITE(IW,9000)
         CALL ABRT
      END IF
      IF((RUNTYP.EQ.OPTMIZ.OR.RUNTYP.EQ.SADPT) .AND.  .NOT.LVCLN) THEN
         IF(MASWRK) WRITE(IW,9010)
         SCALTE=(-EPOT/(TWO*EKIN))**2
         SCALTT = SCALTT*SCALTE
      END IF
      IF(RUNTYP.EQ.ENERGY .OR. LVCLN) THEN
         IF(.NOT.LVCLN  .AND.  MASWRK) WRITE(IW,9020)
         IF(E.EQ.0.0D+00) THEN
            IF(MASWRK) WRITE(IW,9030)
            CALL ABRT
         END IF
         IF(CITYP.EQ.GUGA) THEN
            CALL CIGRAD
         ELSE
            CALL HFGRAD
         END IF
      END IF
C
C     OLDHSS IS USED IF IN A GEOMETRY OPTIMIZATION, THE GEOMETRY
C     CONVERGES, THE VIRIAL IS CLEANED UP FOR FIXED GEOMETRY,
C     AND THE NEW SCALED BASIS THEN CAUSES THE GEOMETRY TO NO
C     LONGER BE CONVERGED. THE GEOMETRY WILL THEN BE CONVERGED,
C     AND ONLY IF THE VIRIAL AGAIN NEED TO BE CLEANED UP DOES
C     OLDHSS COME INTO PLAY. IN THIS CASE IT ESSENTIALLY SAVES
C     ONE GRADIENT CALCULATION BY NOT STARTING AGAIN FROM THE
C     DEFAULT VIRHSS VALUE OF 200.
C
   80 CONTINUE
      IF((VTSCAL .AND. RUNTYP.EQ.ENERGY) .OR. LVCLN) THEN
         IF(ISCF.EQ.1) THEN
            GRD2=0.0D+00
            SCALTE=1.0D+00
            VIRHSS=2.0D+02
            IF(OLDHSS.NE.0.0D+00) VIRHSS=OLDHSS
         END IF
         GRD1=GRD2
         GVIR  = DDOT(3*NAT,C,1,EG,1)
         GRD2 = GVIR +TWO*EKIN+EPOT
         IF(MASWRK) WRITE(IW,9040) GRD2
         IF(ABS(GRD2).LT.VTCONV) GO TO 100
         IF(ISCF.GT.1) VIRHSS=(GRD2-GRD1)/(SCALTE-SCALTX)
C
C        RFO STEP, SAFEGUARD AGAINST NEGATIVE OR SMALL VIRHSS
C
         BILBO = VIRHSS**2 + 4.0D+00*(GRD2**2)
         FRODOP = (VIRHSS + SQRT(BILBO))/2.0D+00
         FRODOM = (VIRHSS - SQRT(BILBO))/2.0D+00
         FRODO = FRODOM
         IF(FRODOP.LT.FRODO) FRODO=FRODOP
         ASTEP = GRD2/(FRODO-VIRHSS)
C          NEVER ALLOW CHANGES BY MORE THAN 0.05 IN ONE STEP
         IF(ABS(ASTEP).GT.0.05D+00)ASTEP=0.05D+00*ASTEP/ABS(ASTEP)
         SCALTX = SCALTE
         SCALTE = SCALTE+ASTEP
         RATIO = SCALTE*SCALTE/(SCALTX*SCALTX)
         SCALTT = SCALTT*RATIO
         CALL NORMAO(1)
         DO 90 I=1,MXGTOT
            EX(I)=EX(I)*RATIO
   90    CONTINUE
         IF(MASWRK) WRITE(IW,9050) RATIO,SCALTT
         CALL NORMAO(2)
         IF(ISCF.LT.MAXVT) GO TO 50
            IF(MASWRK) WRITE(IW,9060) MAXVT
            CALL ABRT
  100    CONTINUE
         IF(MASWRK) WRITE(IW,9070) ABS(GRD2),VTCONV
         IF(LVCLN) OLDHSS=VIRHSS
         IF(LVCLN) RETURN
         VTSCAL = .FALSE.
         NPRINT = 7
         CALL ORBKIN
      END IF
C
  120 CONTINUE
      LCFLAG=LCFLAGS
      LRINT=LRINTS
      RETURN
C
 9000 FORMAT(1X,'VIRIAL SCALING ONLY WORKS WITH RUNTYP = ENERGY',
     *        'OPTIMIZE OR SADPOINT')
 9010 FORMAT(/,1X,'VIRIAL SCALING FOR RUNTYP = OPTIMIZE OR SADPOINT')
 9020 FORMAT(/,1X,'VIRIAL SCALING FOR RUNTYP = ENERGY')
 9030 FORMAT(1X,'SCF HAS APPARENTLY NOT CONVERGED')
 9040 FORMAT(/,1X,'CURRENT VIRIAL ERROR =',F12.8)
 9050 FORMAT(/,1X,'SCALING EXPONENTS BY',F12.8,' TOTAL SCALING SO FAR',
     *          F12.8)
 9060 FORMAT(1X,'EXCESS NUMBER OF VIRIAL ITERATIONS, MAX GIVEN =',I3)
 9070 FORMAT(1X,'VIRIAL ERROR',F12.8,' IS LESS THAN VTCONV',
     *          F12.8,' CONVERGED')
      END
C*MODULE GAMESS  *DECK CIGRAD
      SUBROUTINE CIGRAD
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      LOGICAL FIRST,SECND,CPHF,BOTH,MFIRST,MSECND,MCPHF,EFLDL
C
      PARAMETER (MXATM=2000, MXFRG=1050, MXFGPT=12000,
     *           MXDFG=5, MXDPPT=MXFRG*MXDFG*12)
C
      COMMON /EFLDC / EVEC(3),EFLDL
      COMMON /FGRAD / DEF(3,MXFGPT),DEFT(3,MXFRG),TORQ(3,MXFRG),
     *                EFCENT(3,MXFRG),FRGMAS(MXFRG),FRGMI(6,MXFRG),
     *                ATORQ(3,MXFRG)
      COMMON /FRGINF/ NMPTS(MXFRG),NMTTPT,IEFC,IEFD,IEFQ,IEFO,
     *                NPPTS(MXFRG),NPTTPT,IEFP,
     *                NRPTS(MXFRG),NRTTPT,IREP,ICHGP,NFRG,
     *                NDPPTS(MXDPPT),NDPTTPT,IEFDP,LSTMPTS(MXFRG),
     *                NBSFN(MXFRG),NMXMO(MXFRG)
      COMMON /FUNCT / EHF,EG(3*MXATM)
      COMMON /GRAD  / DE(3,MXATM)
      COMMON /HSSPAR/ FIRST,SECND,CPHF,BOTH,MFIRST,MSECND,MCPHF
      COMMON /INFOA / NAT,ICH,MUL,NUM,NQMT,NE,NA,NB,
     *                ZAN(MXATM),C(3,MXATM),IAN(MXATM)
      COMMON /INTOPT/ ISCHWZ,IECP,NECP,IEFLD
      COMMON /IOFILE/ IR,IW,IP,IJK,IJKT,IDAF,NAV,IODA(950)
      COMMON /RESTAR/ TIMLIM,IREST,NREC,INTLOC,IST,JST,KST,LST
      COMMON /RUNOPT/ RUNTYP,EXETYP,NEVALS,NGLEVL,NHLEVL
      COMMON /TMVALS/ TI,TX,TIM
      COMMON /ZRFPAR/ GZRF,FIND(3),GNUCF,EBORN,DIELEC,IZRF,ICALC
C
      DATA CHECK/8HCHECK   /
C
C     ----- CALCULATE GRADIENT OF THE CI ENERGY -----
C        WITH RESPECT TO THE NUCLEAR COORDINATES
C
C     AT PRESENT, ANALYTIC COMPUTAITON IS POSSIBLE ONLY FOR CITYP=GUGA.
C
C     IREST = 3  1E-GRADIENT RESTART(MO'S SAVED; NO GRADIENT SAVED)
C     IREST = 4  2E-GRADIENT RESTART(MO'S SAVED; PARTIAL GRADIENT SAVED)
C
C     ----- NUMERICAL FIRST DERIVATIVES ARE DONE ELSEWHERE -----
C
      IF(NGLEVL.EQ.1) THEN
         CALL NUMGRDX
         RETURN
      END IF
C
      NCOORD = 3*NAT
C
C     ----- OPEN FILE FOR DERIVATIVE FOCK MATRICES -----
C
      NFT18 = 18
      CALL SEQOPN(NFT18,'FOCKDER','UNKNOWN',.FALSE.,'UNFORMATTED')
C
      FIRST=.TRUE.
      MFIRST=.TRUE.
      SECND=.FALSE.
      MSECND=.FALSE.
      BOTH=.FALSE.
      MCPHF=.TRUE.
      CPHF=.TRUE.
C
C     --- CHECK FOR REACTION FIELD OR FRAGMENTS FOR TIMING PURPOSES ---
C
      IPOT=IEFC+IEFD+IEFQ+IEFO+IEFP+IREP
C
C     ---- INITIALIZE GRADIENT TO ZER0 ----
C
      CALL VCLR(DE,1,3*NAT)
      IF(NFRG.GT.0) CALL VCLR(ATORQ,1,3*NFRG)
C
C     ----- 1E- INTEGRAL DERIVATIVE CONTRIBUTIONS TO THE GRADIENT -----
C
      IF (IREST.LE.3) CALL STVDD
      IF (TIM .GE. TIMLIM) RETURN
C
C     ----- 2E- INTEGRAL DERIVATIVE CONTRIBUTIONS TO THE GRADIENT -----
C
      IF (IREST.LE.4) CALL DDERJK
C
C     ---- GET CPHF CONTRIBUTION ----
C
      CALL DAREAD(IDAF,IODA,DE,NCOORD,67,0)
      CALL CPHFX
C
C     ---- MAKE GRADIENT MODIFICATIONS DUE TO ECP, ELEC. FIELD,   ----
C     ---- REACN. FIELD, AND FRAGMENTS IF NEEDED                  ----
C
      IF (IECP.GT.0 .OR. IZRF.GT.0 .OR. IPOT.GT.0 .OR. EFLDL)
     *   CALL CIGRDM
C
      IREST = 0
C
C     --- WAVE FUNCTION PROPERTIES FOR CI RELAXED DENSITY MATRIX ---
C     PROPERTIES FOR EXPECTATION VALUE DENSITY ARE PRINTED IN WFNCI
C
      CALL PROPTY('CI R')
C
      IF(EXETYP.EQ.CHECK) CALL VCLR(DE,1,3*NAT)
      CALL DAWRIT(IDAF,IODA,DE,NCOORD,3,0)
      CALL DCOPY(NCOORD,DE,1,EG,1)
      RETURN
      END
C*MODULE GAMESS  *DECK GRADX
C>
C> @brief   gradient driver
C>
C> @details Driver for gradient
C>
C> @author  unknown 
C>
      SUBROUTINE GRADX
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      LOGICAL LINEAR,GOPARR,DSKWRK,MASWRK,FGONLY,LCFLAG,LRINT,LCFLAGS,
     *        LRINTS,GRDOUT,mdout
      DOUBLE PRECISION IMS, MD
      INTEGER DDI_WORLD,DDI_GROUP
C
      PARAMETER (MXATM=2000, MXFRG=1050, MXFGPT=12000,
     *           MXDFG=5, MXDPPT=MXFRG*MXDFG*12,MXAO=8192,maxmgc=100)
      PARAMETER (ZERO=0.0D+00, GTOL=1.0D-08)
      PARAMETER(DDI_WORLD=0,DDI_GROUP=1)
      parameter(UNITS = 1.0D+00/0.52917724924D+00)
C
      COMMON /FF    / NFFLVL
      COMMON /FGRAD / DEF(3,MXFGPT),DEFT(3*MXFRG),TORQ(3*MXFRG),
     *                EFCENT(3,MXFRG),FRGMAS(MXFRG),FRGMI(6,MXFRG),
     *                ATORQ(3,MXFRG)
      COMMON /FMOINF/ NFG,NLAYER,NATFMO,NBDFG,NAOTYP,NBODY
      COMMON /FRGINF/ NMPTS(MXFRG),NMTTPT,IEFC,IEFD,IEFQ,IEFO,
     *                NPPTS(MXFRG),NPTTPT,IEFP,
     *                NRPTS(MXFRG),NRTTPT,IREP,ICHGP,NFRG,
     *                NDPPTS(MXDPPT),NDPTTPT,IEFDP,LSTMPTS(MXFRG),
     *                NBSFN(MXFRG),NMXMO(MXFRG)
      COMMON /FUNCT / E,EG(3*MXATM)
      COMMON /GRAD  / DUMMY(3*MXATM)
      COMMON /INFOA / NAT,ICH,MUL,NUM,NQMT,NE,NA,NB,
     *                ZAN(MXATM),C(3,MXATM),IAN(MXATM)
      COMMON /IOFILE/ IR,IW,IP,IJK,IJKT,IDAF,NAV,IODA(950)
      COMMON /MACHSW/ KDIAG,ICORFL,IXDR,modio
      common /mgcops/ rmgc,cp2(300),mgcflag,mgcpnt
      COMMON /MP2PAR/ OSPT,CODEMP,SCSPT,TOL,METMP2,NWDMP2,MEMPRI,MPPROP,
     *                NACORE,NBCORE,NOA,NOB,NORB,NBF,NOMIT,MOCPHF,MAXITC
      COMMON /NLRC  / LCFLAG,LRINT,EMU,EMU2,LRFILE
      COMMON /OUTPUT/ NPRINT,ITOL,ICUT,NORMF,NORMP,NOPK
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
      COMMON /RUNLAB/ TITLE(10),A(MXATM),B(MXATM),BFLAB(MXAO)
      COMMON /RUNOPT/ RUNTYP,EXETYP,NEVALS,NGLEVL,NHLEVL
      COMMON /WFNOPT/ SCFTYP,VBTYP,DFTYPE,TDDFTYP,CITYP,CCTYP,
     *                MPLEVL,MPCTYP
      COMMON /XYZPRP/ DUM(3),DIP(3),DUMM(32)
      COMMON /ZMAT  / NZMAT,NZVAR,NVAR,NSYMC,LINEAR
      dimension bv(3),chgmgc(maxmgc),fmgc(3,maxmgc)
C
      DATA CHECK/8HCHECK   /,GUGA/8HGUGA    /,RNONE/8HNONE    /
      DATA IMS/8HIMS     /
      DATA MD/8HMD      /
C
C        ----- EVALUATE NUCLEAR GRADIENT AT ONE (1) GEOMETRY -----
C        THIS ROUTINE WRITTEN BY MIKE SCHMIDT, MAY 7, 1983.
C
C     NEXT PART DOES RUNTYP=GAMMA'S CARTESIAN 2ND AND 3RD DERIVATIVES
C
      mgccnt=0
      do i=1,maxmgc
         chgmgc(i)=zero
         fmgc(1,i)=zero
         fmgc(2,i)=zero
         fmgc(3,i)=zero
      enddo
  100 continue
c
      IF(NFFLVL.GE.2)THEN
         CALL FFCART
         RETURN
      ENDIF
C
      FGONLY = NUM.EQ.0  .AND.  NFRG.GT.0
C
      LCFLAGS=LCFLAG
      LRINTS=LRINT
      IF(DFTYPE.EQ.RNONE) THEN
        LCFLAG=.FALSE.
        LRINT=.FALSE.
      ENDIF
C
      IF (MASWRK.AND.NFG.EQ.0) WRITE(IW,9000)
      IF(NFG.EQ.0.OR.MPLEVL.EQ.0) E=ZERO
C
C        IN CASE THIS IS A NUMERICAL GRADIENT BEING RUN IN SUBGROUPS,
C        ENERGY AT INITIAL GEOMETRY MUST RUN IN SAME SUBGROUP DIVISION.
C
      IF (FGONLY) THEN
         CALL EFSP
      ELSE
         IF(NGLEVL.GT.0) CALL GDDI_SCOPE(DDI_GROUP)
         CALL ENERGX
         IF(NGLEVL.GT.0) CALL GDDI_SCOPE(DDI_WORLD)
      END IF
C
      IF(E.EQ.ZERO  .AND.  EXETYP.NE.CHECK) THEN
         IF (MASWRK) WRITE(IW,9010)
         IF(NFG.NE.0) RETURN
         CALL ABRT
      END IF
C
      NCOORD = 3*NAT
      NCF=3*NFRG
      NC1=NCOORD+2*NCF
C
C        CODE=IMS PROGRAM DOES NOT USE NORMAL ANALYTIC GRADIENT DRIVERS,
C        IT'S ALREADY DONE BY THE TIME WE GET BACK FROM ENERGX.
C
      IF(MPLEVL.GT.0.AND.CODEMP.EQ.IMS .AND. NGLEVL.EQ.0) GO TO 150
C
C        COMPUTE THE GRADIENT
C
      IF(CITYP.EQ.GUGA) THEN
         CALL CIGRAD
      ELSE
         IF (FGONLY) THEN
            CALL EFGRAD
         ELSE
            CALL HFGRAD
         END IF
      END IF
C
  150 CONTINUE
      GRMS=ZERO
      GMAX=ZERO
      DO 200 I=1,NCOORD
         GVAL=ABS(EG(I))
         GRMS=GRMS + GVAL*GVAL
         IF(GVAL.GT.GMAX) GMAX=GVAL
         IF(GVAL.LT.GTOL) EG(I)=ZERO
         DUMMY(I)=EG(I)
  200 CONTINUE
      FMAX1 = ZERO
      FMAX2 = ZERO
      IF(NFRG.GT.0) FMAX1 = ABS(DEFT(IDAMAX(NCF,DEFT,1)))
      IF(NFRG.GT.0) FMAX2 = ABS(TORQ(IDAMAX(NCF,TORQ,1)))
      GMAX = MAX(GMAX,FMAX1,FMAX2)
      IF(NFRG.GT.0) GRMS  = GRMS + DDOT(NCF,DEFT,1,DEFT,1)
     *                           + DDOT(NCF,TORQ,1,TORQ,1)
      GRMS=SQRT(GRMS/NC1)
C
C     PRINT AND PUNCH THE FINAL GRADIENT
C
      IF(MASWRK  .AND.  NPRINT.NE.-5) THEN
         WRITE(IW,9070)
         CALL EGOUT(EG,NAT)
         WRITE(IW,9020) GMAX,GRMS
      END IF
      mdout=runtyp.ne.md.or.iand(modio,16).eq.0
      IF (.NOT. FGONLY.AND.NFG.EQ.0.and.mdout)
     *   CALL EGPUN(EG,NAT,' $GRAD  ')
C
C         TRANSFORM GRADIENT TO INTERNAL COORDINATES
C
      IF(NZMAT.GT.0) THEN
         CALL TRANG(DUMMY,NVAR,NCOORD)
         CALL PZANDG(DUMMY,1)
         GRMS=ZERO
         GMAX=ZERO
         DO I=1,NVAR
            GVAL=ABS(DUMMY(I))
            IF(GVAL.LT.GTOL) DUMMY(I)=ZERO
            IF(GVAL.GT.GMAX) GMAX=GVAL
            GRMS=GRMS + GVAL*GVAL
         ENDDO
         GRMS = SQRT(GRMS/NVAR)
         IF (MASWRK) WRITE(IW,9020) GMAX,GRMS
      END IF
C
C     A $VIB GROUP MIGHT BE OF USE IF THIS RUN IS TRYING TO CONVERGE
C     ON SOME GEOMETRY WHICH DIDN'T QUITE CONVERGE IN A RUNTYP=FORCE.
C
      IF(NFG.EQ.0.and.mdout) THEN
         GRDOUT=.FALSE.
         IF(RUNTYP.EQ.MD) GRDOUT=.TRUE.
         CALL PUVIB(IP,IW,GRDOUT,NCOORD,0,0,0,E,EG,DIP)
         IF (MASWRK) WRITE(IP,FMT='('' $END   '')')
      END IF
C
      LCFLAG=LCFLAGS
      LRINT=LRINTS
C
      IF(MASWRK) WRITE(IW,9030)
      CALL TIMIT(1)
c
c     Mean Gradient Charge Calculations
C
      if (mgcflag.eq.1.and.mgcpnt.ge.1.and.mgccnt.le.mgcpnt) then
        if (mgccnt.eq.0) then
           do i=1,nat-1
              fmgc(1,i)=Eg(i*3-2)
              fmgc(2,i)=Eg(i*3-1)
              fmgc(3,i)=Eg(i*3)
           enddo
           zan(nat)=1.0D+00
           ich=ich+1
        else
           if (maswrk) write(IW,9100)
           if (maswrk) write(IW,9101) mgccnt,(C(i,nat)/units,i=1,3)
           do i=1,nat-1
              do j=1,3
                 bv(j)=C(j,nat)-C(j,i)
              enddo
              vecn=sqrt(bv(1)**2+bv(2)**2+bv(3)**2)
              dotp=(Eg(i*3-2)-fmgc(1,i))*bv(1)
     *            +(Eg(i*3-1)-fmgc(2,i))*bv(2)
     *            +(Eg(i*3)  -fmgc(3,i))*bv(3)
c              chgmgc(i)=chgmgc(i)+vecn*dotp
              if (maswrk) write(IW,9200) i,A(i),B(i),vecn*dotp
c              chgmgc(i)=zero
           enddo
        endif
        C(1,nat)=cp2(3*mgccnt+1)*units
        C(2,nat)=cp2(3*mgccnt+2)*units
        C(3,nat)=cp2(3*mgccnt+3)*units
        mgccnt=mgccnt+1
        if (mgccnt.le.mgcpnt) go to 100
      elseif (mgcflag.eq.1.and.mgcpnt.eq.0) then
        if (mgccnt.ge.1) then
           do i=1,nat-1
              do j=1,3
                 bv(j)=C(j,nat)-C(j,i)
              enddo
              vecn=sqrt(bv(1)**2+bv(2)**2+bv(3)**2)
              dotp=(Eg(i*3-2)-fmgc(1,i))*bv(1)
     *            +(Eg(i*3-1)-fmgc(2,i))*bv(2)
     *            +(Eg(i*3)  -fmgc(3,i))*bv(3)
              chgmgc(i)=chgmgc(i)+vecn*dotp
           enddo
        endif
        mgccnt=mgccnt+1
        if (mgccnt.eq.1) then
           do i=1,nat-1
              fmgc(1,i)=Eg(i*3-2)
              fmgc(2,i)=Eg(i*3-1)
              fmgc(3,i)=Eg(i*3)
           enddo
           zan(nat)=1.0D+00
           ich=ich+1
           C(1,nat)=rmgc*units
           go to 100
        elseif (mgccnt.eq.2) then
           C(1,nat)=-rmgc*units
           go to 100
        elseif (mgccnt.eq.3) then
           C(1,nat)=0
           C(2,nat)=rmgc*units
           go to 100
        elseif (mgccnt.eq.4) then
           C(2,nat)=-rmgc*units
           go to 100
        elseif (mgccnt.eq.5) then
           C(2,nat)=0
           C(3,nat)=rmgc*units
           go to 100
        elseif (mgccnt.eq.6) then
           C(3,nat)=-rmgc*units
           go to 100
        elseif (mgccnt.eq.7) then
           if (maswrk) write(IW,9100)
           tmgc=zero
           do i=1,nat-1
             chgmgc(i)=chgmgc(i)/6.0D+00
             tmgc=tmgc+chgmgc(i)
             if (maswrk) write(IW,9200) i,A(i),B(i),chgmgc(i)
           enddo
           if (maswrk) write(IW,9300) tmgc
        endif
        CALL TIMIT(1)
      endif
c
      RETURN
C
 9000 FORMAT(/,20X,32(1H-),
     *       /,20X,'SINGLE POINT ENERGY AND GRADIENT',
     *       /,20X,32(1H-))
 9010 FORMAT(1X,'NO GRADIENT, SCF DID NOT CONVERGE')
 9020 FORMAT(/19X,'MAXIMUM GRADIENT = ',F14.9/
     *        23X,'RMS GRADIENT = ',F14.9)
 9030 FORMAT(/,'..... END OF SINGLE POINT GRADIENT .....')
 9070 FORMAT(/25X,22(1H-)/25X,22HGRADIENT OF THE ENERGY/25X,22(1H-))
 9101 FORMAT('Probe Point',I4,3F15.3)
 9100 FORMAT(/25X,20(1H-)/25X,20HMean Gradient Charge/25X,20(1H-))
 9200 FORMAT(9X,I4,1X,A8,A2,F18.9)
 9300 FORMAT(/12x,'SUM',9x,F18.9/)
      END
C*MODULE GAMESS  *DECK HFGRAD
C>
C> @brief evaluates nuclear gradient for HF wavefunctions
C>
C> @author unknown
C>
C> @date February, 2013 - Casper Steinmann
C> - add PCM gradient to semi-empirical methods
C>
      SUBROUTINE HFGRAD
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      DOUBLE PRECISION IMS
C
      LOGICAL QOPS,QFMM
C
      PARAMETER (MXATM=2000, MXFRG=1050)
C
      COMMON /FUNCT / E,EG(3,MXATM)
      COMMON /GRAD  / DE(3,MXATM)
      COMMON /INFOA / NAT,ICH,MUL,NUM,NQMT,NE,NA,NB,
     *                ZAN(MXATM),C(3,MXATM),IAN(MXATM)
      COMMON /IOFILE/ IR,IW,IP,IJK,IJKT,IDAF,NAV,IODA(950)
      COMMON /MP2PAR/ OSPT,CODEMP,SCSPT,TOLMP,METHMP,NWDMP2,MEMPRI,
     *                MPPROP,NACOREMP,NBCOREMP,NOAMP,NOBMP,NORBMP,
     *                NBFMP,NOMITMP,MOCPHF,MAXITC
      COMMON /NEOJOB/ NEORUN,NELERM
      COMMON /PCMOPT/ RABI,RASC,REFPOL,THRSLS,DENSLS,WB,WA,ETA2,GD,EVAC,
     *                RHOW,PM,AREATL,AREAKP,BONDRY,OMEGA,RET,FRO,EPSINF,
     *                EEPS,DR,RSOLV,VMOL,TCE,STEN,DSTEN,CMF,TABS,IDIRCT,
     *                IPCDER,IDP,ICOMP,IFIELD,ICAV,IDISP,IPRINT,IRETCAV,
     *                ICENT,IFAST,NEVAL,IEFPOL,KEEPSM,IMGABI,IMGASC,NADD
      COMMON /PCMPAR/ IPCM,NFT26,NFT27,IRPPCM,IEF,IP_F,NFMOPCM
      COMMON /PCMTMP/ IDSP(MXATM+MXFRG*5),DPCMFRG(6,MXFRG),
     *                EGPCM(3,MXATM)
      COMMON /QMFM  / SIZE,EPS,DPGD,QFMM,NP,NS,IWS,NPGP,MPMTHD,NUMRD,
     *                ITERMS,QOPS,ISCUT
      COMMON /RESTAR/ TIMLIM,IREST,NREC,INTLOC,IST,JST,KST,LST
      COMMON /RUNOPT/ RUNTYP,EXETYP,NEVALS,NGLEVL,NHLEVL
      COMMON /TMVALS/ TI,TX,TIM
      COMMON /WFNOPT/ SCFTYP,VBTYP,DFTYPE,TDDFTYP,CITYP,CCTYP,
     *                MPLEVL,MPCTYP
C
      DATA NONE,RNONE/4HNONE,8HNONE    /
      DATA DDI,IMS,ZAPT/8HDDI     ,8HIMS     ,8HZAPT    /
      DATA RMC/8HMCSCF   /
      DATA CONICL/8HCONICAL /
C
C     ----- FINISH THE NUCLEAR GRADIENT OF THE ENERGY -----
C
C     TO BE MORE PRECISE, IN SPITE OF ITS NAME, THIS ROUTINE DOES
C     THE DERIVATIVE INTEGRAL CONTRIBUTIONS TO THE GRADIENT VECTOR,
C     INCLUDING CASES SUCH AS MP2, TD-DFT, OR CIS THAT ARE NOT -HF-!
C
C     SOME WAVEFUNCTIONS HAVE TO PRODUCE ENERGY-WEIGHTED DENSITY
C     MATRICES, ETC. PRIOR TO CALLING THIS ROUTINE, WHICH IS
C     RESPONSIBLE ONLY FOR THE FINAL INTEGRAL DERIVATIVE TERMS.
C
C     UNFORTUNATELY, THERE IS A ROGUE PATH FOR GUGA CI THAT IS NOT
C     PROPERLY CAPTURED INTO THIS ROUTINE.  SOMEDAY THAT SHOULD
C     BE CLEANED UP.  ANY PLACE THAT CALLS -HFGRAD- NORMALLY HAS
C     TO HAVE A CLUNKY IF/ELSE/THEN BLOCK CALLING -CIGRAD- AS WELL.
C
C     IREST = 3  1E-GRADIENT RESTART(MO'S SAVED; NO GRADIENT SAVED)
C     IREST = 4  2E-GRADIENT RESTART(MO'S SAVED; PARTIAL GRADIENT SAVED)
C
C     ----- IMS MP2 CODE HAS ALREADY DONE ITS DERIVATIVE INTEGRALS -----
C
      IF(MPLEVL.EQ.2  .AND.  CODEMP.EQ.IMS  .AND.  NGLEVL.EQ.0) RETURN
C
C     ----- NUMERICAL FIRST DERIVATIVES ARE DONE ELSEWHERE -----
C
      IF(NGLEVL.EQ.1) THEN
         CALL NUMGRDX
         RETURN
      END IF
C
C     ----- MOPAC FIRST DERIVATIVES ARE DONE ELSEWHERE -----
C
      IF(MPCTYP.NE.NONE) THEN
         CALL MPCGRD(SCFTYP)
         IF(IPCM.EQ.1.AND.IPCDER.EQ.3) THEN
           CALL DERCCM
           CALL VADD(EGPCM,1,EG,1,EG,1,3*NAT)
         ENDIF
         RETURN
      END IF
C
C     ----- SA-MCSCF FIRST DERIVATIVES ARE DONE ELSEWHERE -----
C
      IF(SCFTYP.EQ.RMC) THEN
         NSTATS = NSTATMC()
         IF(NSTATS.GT.1) THEN
            CALL NACMEX(.FALSE.)
            CALL DAREAD(IDAF,IODA,EG,3*NAT,3,0)
            IF(RUNTYP.EQ.CONICL) CALL EGCONICL
            RETURN
         END IF
      END IF
C
C     ----- POLARIZABLE CONTINUUM MODEL GRADIENT CORRECTIONS -----
C           NEED TO CALL DERCCM HERE FOR EFP-PCM GRADIENTS
C           WHICH ARE INVOLVED IN 'STVDER'
C
      IF(IPCM.EQ.1.OR.NFMOPCM.GT.0) THEN
         IF(IPCDER.EQ.2.OR.IPCDER.EQ.3) THEN
            IF(IEF.EQ.3.OR.IEF.EQ.10) CALL DERCCM
         END IF
      END IF
C
C        TD-DFT GRADIENTS CANNOT USE POINT GROUP SYMMETRY
C
      IF(TDDFTYP.NE.RNONE) CALL SYMOFF
C
C     ----- 1E- INTEGRAL DERIVATIVE CONTRIBUTIONS TO THE GRADIENT -----
C
      IF (IREST.LE.3) CALL STVDER
      IF (TIM .GE. TIMLIM) RETURN
C
C     ----- POLARIZABLE CONTINUUM MODEL GRADIENT CORRECTIONS -----
C
       IF(IPCM.EQ.1.OR.NFMOPCM.GT.0) THEN
        IF(IPCDER.EQ.2.OR.IPCDER.EQ.3) THEN
           IF(IEF.EQ.3.OR.IEF.EQ.10) THEN
C             -- DERCCM IS CALLED IN VNNDER FOR EFP-PCM(NO QM)
C                DERCCM IS CALLED ABOVE IN OTHER CASES
C                DERCCM IS CALLED IN MP2GR2.SRC FOR IMS-MP2 CODE
              CALL DAREAD(IDAF,IODA,EG,3*NAT,3,0)
              DO IAT = 1, NAT
                 DO IXYZ = 1, 3
                    EG(IXYZ,IAT) = EG(IXYZ,IAT) + EGPCM(IXYZ,IAT)
                 END DO
              END DO
              IF(MPLEVL.EQ.2  .AND.  CODEMP.EQ.DDI) THEN
                 CALL DCOPY(3*NAT,EG,1,DE,1)
              END IF
              CALL DAWRIT(IDAF,IODA,EG,3*NAT,3,0)
           END IF
         ELSE IF(IPCDER.EQ.1) THEN
           IF(IEF.EQ.0) CALL DERPCM
           IF(IEF.EQ.3.OR.IEF.EQ.10) CALL DERIEF
         END IF
       END IF
C
C     ----- 2E- INTEGRAL DERIVATIVE CONTRIBUTIONS TO THE GRADIENT -----
C
      IF (IREST.LE.4)  THEN
        IF (MPLEVL.EQ.2  .AND.  (CODEMP.EQ.DDI.OR.OSPT.EQ.ZAPT)) THEN
          CALL PJKDMP2
        ELSE
          IF (QFMM) THEN
             CALL JKLDER
          ELSE
             CALL JKDER
          END IF
        END IF
      END IF
C
      IF(TDDFTYP.NE.RNONE) CALL SYMON
C
C        COMPLETE NUCLEAR/ELECTRON ORBITAL METHOD GRADIENT
C
      IF(NEORUN.EQ.1) CALL NEOGRAD
C
      IREST = 0
      RETURN
      END
C*MODULE GAMESS  *DECK ORTHDN
C>
C> @brief   MO orgonalization 
C>
C> @details Orthogonalize MOs. 
C>
C> @author  unknown 
C>
      SUBROUTINE ORTHDN
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      LOGICAL MFRZ,skipor
C
      DIMENSION SAVDMO(1)
C
      PARAMETER (MXATM=2000, MXAO=8192)
C
      COMMON /FMCOM / XX(1)
      COMMON /FMOINF/ NFG,NLAYER,NATFMO,NBDFG,NAOTYP,NBODY
      COMMON /FMOOPT/ ESPSCA(9),RESPAP(2),RESPPC(2),RESDIM,RESTRI(4),
     *                RCORSD,RESPCT,CONVFG,CNVDMP,COROFF,RFLMO(4),
     *                ORSHFT,ORSHFT2,CNVAFO,ASCREEN(4),IXESP,MXITFG,
     *                NGUESS,NBSSE,MODORB,MODPAR,IRSTSTP,IRSTLAY,NPRFMO,
     *                NFMOPAL,MODPRP,MAXL1C,IPIEDA,MODGRD,MODESP,IVMUL,
     *                MODLMO,NOPDEN,MOFOCK,MODFD,modfmm,ncentm
      COMMON /INFOA / NAT,ICH,MUL,NUM,NQMT,NE,NA,NB,
     *                ZAN(MXATM),C(3,MXATM),IAN(MXATM)
      COMMON /IOFILE/ IR,IW,IP,IJK,IJKT,IDAF,NAV,IODA(950)
      COMMON /MFRPAR/ MFRZ,NUMFRZ,NORFRZ,IFRZ(MXAO)
      COMMON /WFNOPT/ SCFTYP,VBTYP,DFTYPE,TDDFTYP,CITYP,CCTYP,
     *                MPLEVL,MPCTYP
C
      DATA UHF,SAVDMO/8HUHF     ,8HMOSAVED /,RMC/8HMCSCF   /
      DATA NONE/4HNONE/
C
C     ----- ORTHONORMALIZE CURRENT MO-S WITH CURRENT METRIC -----
C     ----- UPDATE THE DENSITY MATRIX ACCORDINGLY -----
C     OLD VECTORS AND NEW OVERLAP MATRIX MUST BE PRESENT ON THE DAF.
C
C        THIS ROUTINE WRITTEN BY MIKE SCHMIDT, MARCH 8,1983.
C
C     ----- MOPAC ORBITALS ARE AUTOMATICALLY ORTHONORMAL -----
C           FMO OFTEN DOES NOT HAVE INITIAL ORBITALS, ONLY DENSITY.
C
      IF(MPCTYP.NE.NONE) RETURN
C
      L0 = 0
      L1 = NUM
      L2 = (L1*L1+L1)/2
      L3 = L1 * L1
C
C     ----- FIND THE Q MATRIX -----
C
      CALL VALFM(LOADFM)
      LIWRK  = LOADFM + 1
      LS     = LIWRK  + L1
      LQ     = LS     + L2
      LV     = LQ     + L3
      LE     = LV     + L3
      LSCR   = LE     + L1
      LAST   = LSCR   + 8*L1
      NEED = LAST - LOADFM - 1
      CALL GETFM(NEED)
C
      CALL DAREAD(IDAF,IODA,XX(LS),L2,12,0)
      CALL QMTSYM(XX(LS),XX(LV),XX(LQ),XX(LE),XX(LSCR),XX(LIWRK),
     *            L0,L1,L2,L3,.FALSE.)
      CALL DAWRIT(IDAF,IODA,XX(LQ),L3,45,0)
C
C     IF DOING FMO, QUIT NOW
C
      IF(NFG.NE.0) THEN
        CALL FMOORBS(XX(LV),XX(LS),XX(LE),XX(LQ),XX(LSCR),XX(LIWRK),
     *               L0,L1,L2,L3,skipor)
        if(skipor) then
          CALL RETFM(NEED)
          RETURN
        END IF
      END IF
C
C        ORTHONORMALIZE, AND BACK TRANSFORM
C
      CALL DAREAD(IDAF,IODA,XX(LS),L2,12,0)
      IPASS=1
      NSAV=15
  200 CONTINUE
      CALL DAREAD(IDAF,IODA,XX(LV),L3,NSAV,0)
      NMO=L0
      IF(NFG.NE.0) THEN
C          IRSTLAY IS SET IN EDIM FOR MCSCF,
C          OTHERWISE WE SHOULD NOT GET HERE!
        NMO=IRSTLAY
        IF(SCFTYP.NE.RMC) NMO=NA
      END IF
      CALL ORTHO(XX(LQ),XX(LS),XX(LV),XX(LSCR),NMO,L0,L1,L2,L1)
      CALL TFSQB(XX(LV),XX(LQ),XX(LSCR),L0,L1,L1)
      CALL DAWRIT(IDAF,IODA,XX(LV),L3,NSAV,0)
C
C     IF THE ORBITALS ARE FROZEN, WRITE ALSO TO DICTIONARY FILE 318
C
      IF(MFRZ.and.nfg.eq.0) CALL DAWRIT(IDAF,IODA,XX(LV),L3,318,0)
C
C        REPEAT FOR BETA ORBITALS FOR UHF FUNCTIONS
C
      IF(SCFTYP.NE.UHF) GO TO 300
      IF(NB.EQ.0) GO TO 300
      IF(IPASS.EQ.2) GO TO 300
      IPASS=2
      NSAV=19
      GO TO 200
C
  300 CONTINUE
      CALL RETFM(NEED)
C
C     ----- INITIALIZE THE DENSITY MATRICES -----
C
      LDA  = LOADFM + 1
      LDB  = LDA    + L2
      LV   = LDB    + L2
      LE   = LV     + L3
      LOCC = LE     + L1
      LAST = LOCC   + L1
      NEED = LAST - LDA - 1
      CALL GETFM(NEED)
      IDUMMY=0
      DUMMY=0.0D+00
      CALL INIDEN(SAVDMO,XX(LV),XX(LDA),XX(LDB),XX(LE),
     *            XX(LOCC),DUMMY,DUMMY,DUMMY,DUMMY,IDUMMY,0,
     *            IDUMMY,IDUMMY,L1,L2,L3,.FALSE.,.FALSE.,.FALSE.,
     *            .FALSE.,.FALSE.,NA,1,L1,L2,L3)
      CALL RETFM(NEED)
      RETURN
      END
C*MODULE GAMESS  *DECK WFN
C>
C> @brief   Main wavefunction driver
C>
C> @details call basic SCF, then possible correlation methods.
C>
C> @date September 2010 - Albert DeFusco
C> - Added the cluster-in-molecules post-scf method
C>
      SUBROUTINE WFN
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      DOUBLE PRECISION MD
      DOUBLE PRECISION LMOEDA
      CHARACTER*4 PRPTYP
C
      LOGICAL GOPARR,DSKWRK,MASWRK,POSNEO,POSPRP
      LOGICAL DCFLG
      LOGICAL COSBUG,COSWRT,DCOSMO,PRFCND,IOUTCH
C
      PARAMETER (MXATM=2000, MXRT=100)
C
      COMMON /ACONV / RRSHFT,EXTTOL,DMPTOL,VSHTOL,IEXTIN
      common /c0nicl/ pntstp,pntgrd,pnalfa,pnsigm,ncvgpn,ncncl,neg2cl,
     *                ndbgci,ixroot(2),ixstat(2)
      COMMON /CONV  / ACURCY,EN,ETOT,EHF,EHF0,DIFF,ITER,ICALP,ICBET
      COMMON /COSDAT/ SE2,SECORR,QVCOSMO,ELAST,EMP2COS,EMP2LAST,
     *                COSVOL,COSSAR,EDIEL,EOC1,DEOC_RS,SUMQSC,
     *                SUMQSCOLD,ZSUM,ZSUM2,ZSUM3,FEPSI,RDS,DISEX2,
     *                EPSI,COSRAD,DISEX,OUTCHG,EDIEL_SAVE,
     *                MAXNPS,ICORR,ITRIP,NQS,MP2TRIP,MP2ITER,
     *                ICFREQ,NSPA,NSPH,NPSD,NPS,NPS2,NDEN,NPSPHER,
     *                COSBUG,COSWRT,DCOSMO,PRFCND,IOUTCH
      COMMON /DCOPT / SUBTYP,BUFTYP,SUBLNG,BUFRAD,NDCPRT,NSUBS,DCFLG
      COMMON /ENRGYS/ ENUCR,EELCT,ETOT2,SZ2,SZZ2,ECORE,ESCF,EERD,E1,E2,
     *                VEN,VEE,EPOT,EKIN,ESTATE(MXRT),STATN,EDFT(2),EDISP
      COMMON /FMOINF/ NFG,NLAYER,NATFMO,NBDFG,NAOTYP,NBODY
      COMMON /FUNCT / E,EG(3,MXATM)
      COMMON /INFOA / NAT,ICH,MUL,NUM,NQMT,NE,NA,NB,
     *                ZAN(MXATM),C(3,MXATM),IAN(MXATM)
      COMMON /IOFILE/ IR,IW,IP,IJK,IJKT,IDAF,NAV,IODA(950)
      COMMON /MRPTIN/ TYPMRMP,INORBMC,MCVEC
      COMMON /NEOMPN/ NEMPLV
      COMMON /NUCPOS/ POSNEO,POSPRP
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
      COMMON /PSILVL/ IPSI,ISKPRP
      COMMON /RESTAR/ TIMLIM,IREST,NREC,INTLOC,IST,JST,KST,LST
      COMMON /RUNOPT/ RUNTYP,EXETYP,NEVALS,NGLEVL,NHLEVL
      COMMON /VBINTF/ VBENGY
      COMMON /WFNOPT/ SCFTYP,VBTYP,DFTYPE,TDDFTYP,CITYP,CCTYP,
     *                MPLEVL,MPCTYP
C
      PARAMETER (ZERO=0.0D+00)
C
      LOGICAL MOSORT,ORTHO,SUBRHF,FCORE,restrt,runsub
      common /CIMPAR/ bufdst,cconv,submtd,subtypc,atmmlk,
     *                eta,zeta,zeta1,zeta2,cimtyp,enrgml,
     *                mtdatm(mxatm),MOFIX,mrgsub,
     *                mosort,ortho,subrhf,fcore,restrt,runsub
C

      DATA RMC/8HMCSCF   /
      DATA RHF,UHF,ROHF,GVB/8HRHF     ,8HUHF     ,8HROHF    ,8HGVB     /
      DATA CHECK/8HCHECK   /,RNONE/8HNONE    /, MD     /8HMD      /
      DATA LMOEDA /8HLMOEDA  /
C
C     ----- DRIVER FOR SELF-CONSISTENT FIELD CALCULATIONS -----
C     WHICH MAY BE FOLLOWED UP BY AN OPTIONAL CORRELATION COMPUTATION
C          IPSI=0 MEANS SCF OR DFT,
C          IPSI=1 MEANS CI,
C          IPSI=2 MEANS MP,
C          IPSI=3 MEANS CC,
C          IPSI=4 MEANS VB
C     COMPUTATION IS CURRENTLY IN PROGRESS.
C     SKIP SCF FOR FMO-MP2
C
      IPSI=0
      IF(IREST.EQ.5) THEN
        IREST=0
        GO TO 300
      END IF
c
c     skip SCF for the 2nd state in the CI search
c
      if(ncncl.ne.0 .and. neg2cl.eq.-1) then
        en=enuc(nat,zan,c)
        go to 300
      end if
C
C     ----- SET CONVERGENCE CRITERIA FOR SCF -----
C
      IEXTIN = 4
      EXTTOL = 1.0D-03
      DMPTOL = 1.0D-04
      VSHTOL = 0.4D+00
C
C        SET UP S,P,D,F,G TRANSFORMATION MATRICES
C
      CALL TRMAT
C
C     COSMO RESETS ICORR FOR EACH NEW GEOMETRY
C     WORKS BOTH FOR RHF AND MP2 OPTIMIZATION. THE LABEL 100 IS
C     NEEDED TO MAKE THE INNER SCF WITHIN THE MP2 ITERATIONS.
C
      ICORR=0
  100 CONTINUE
C
C         ZERO SOME ENERGIES AND SPINS
C
      E = ZERO
      ETOT = ZERO
      EN=ENUC(NAT,ZAN,C)
      IF(SCFTYP.EQ.RMC) ENUCR=EN
      IF(SCFTYP.EQ.RNONE) ENUCR=EN
      SZ = ZERO
      S2 = ZERO
C
C        MCSCF AND MCSCF+CI HAVE DIFFERENT LENGTHS FOR CI VECTOR FILE.
C        IF A CI ON TOP OF AN MCSCF HAS BEEN COMPLETED AT AN EARLIER
C        GEOMETRY, ERASE THE CI COMPUTATION'S EIGENVECTOR FILE TO AVOID
C        CONFUSING THE MCSCF AT THE CURRENT GEOMETRY.
C
      IF(SCFTYP.EQ.RMC  .AND.  CITYP.NE.RNONE) THEN
         IF(NEVALS.GT.0) CALL ERASCI
      END IF
C
C        IF A MCSCF+PT RUN HAS VECTORS READ IN, WE CAN SKIP MCSCF
C        CI WITHOUT SCF GENERATING ORBITALS SHOULD SKIP PROPERTIES
C
      IF(SCFTYP.EQ.RMC  .AND.  INORBMC.NE.0) GO TO 300
      IF(SCFTYP.EQ.RNONE) GO TO 300
C
C     ----- EXECUTE SCF PROCEDURE -----
C
      call stopwa(2,0)
      IF (.NOT.DCFLG) THEN
         IF (SCFTYP.EQ. RHF) CALL RHFCL
         IF (SCFTYP.EQ. UHF) CALL UHFOP(SZ,S2)
         IF (SCFTYP.EQ.ROHF) CALL UHFOP(SZ,S2)
         IF (SCFTYP.EQ. GVB) CALL RHFGVB
         IF (SCFTYP.EQ. RMC) CALL MCSCF
      ELSE
         CALL DCSCF(SZ,S2)
      END IF
      call stopwa(2,1)
C
C     ----- SAVE ENERGY DATA FOR SCF -----
C
      IF (SCFTYP.EQ.RMC) ETOT=E
      IF (SCFTYP.EQ.RMC) EHF=EELCT
      E = ETOT
      ENUCR = EN
      EELCT = EHF
      ETOT2 = ETOT
      SZ2   = SZ
      SZZ2  = S2
      ECORE = ZERO
      ESCF  = ETOT
      CALL DAWRIT(IDAF,IODA,ENUCR,MXRT+15,2,0)
C
C     Print out QM dipole moment during MD runs.
      IF(RUNTYP.EQ.MD) then
        CALL ELMOMC
        GO TO 300
      endif
      IF(RUNTYP.EQ.LMOEDA) GO TO 300
C
C     -----  WAVE FUNCTION PROPERTIES AT THE SCF LEVEL -----
C     ----- DENSITY MATRIX PROPERTIES AT THE DFT LEVEL -----
C
                          PRPTYP='SCF '
      IF(DFTYPE.NE.RNONE) PRPTYP='DFT '
      CALL PROPTY(PRPTYP)
C
C        ==== OPTIONAL CORRELATED COMPUTATION FOLLOWING THE SCF ====
C
  300 CONTINUE
      call stopwa(3,0)
C
C     ++++ IN THE DIVERGED CASES BELOW FMO IS ALLOWED TO RETURN BECAUSE
C     ++++ IT MAY RUN THE SAME SCF AGAIN WITH A DIFFERENT CONVERGER.
C
C
C     ----- CARRY OUT OPTIONAL CLUSTER-IN-MOLECULES COMPUTATION -----
C
      if (cimtyp.ne.rnone) then
         IF(E.EQ.ZERO  .AND.  EXETYP.NE.CHECK) THEN
            IF(MASWRK) WRITE(IW,9050) CIMTYP
            CALL ABRT
         END IF
         call cimprint
         if(exetyp.eq.check.and.maswrk) then
            write(iw,*)
            write(iw,*) 'CHECK IS NOT AVAILABLE FOR CIM'
            write(iw,*)
         else
            if(maswrk) call cimi(nsubsystems)
            call runcimsub(nsubsystems)
         endif
      endif
C
C     ----- CARRY OUT OPTIONAL 2ND ORDER PERTURBATION COMPUTATION -----
C
      IF(MPLEVL.GT.0) THEN
         IF(E.EQ.ZERO  .AND.  EXETYP.NE.CHECK  .AND.  INORBMC.EQ.0) THEN
            IF(MASWRK) WRITE(IW,9000) MPLEVL
            IF(NFG.NE.0) RETURN
            CALL ABRT
         END IF
         IF(MPLEVL.EQ.2) CALL WFNMP2
         INORBMC = 0
      END IF
C
C     ----- CARRY OUT OPTIONAL NUCLEAR-ELECTRONIC MP2 (NEO-MP2) -----
C
      IF(NEMPLV.GT.0) THEN
         IF(NEMPLV.EQ.2) THEN
            CALL ENMP2D
            IF (POSNEO.AND.POSPRP) CALL LAMBDAHF
         ELSE
            IF(MASWRK) WRITE(IW,*)'ONLY NEO-MP2 CURRENTLY AVAILABLE'
         END IF
      END IF
C
C        COSMO MP2 ITERATIONS
C
      IF (MP2ITER.EQ.1) GO TO 100
C
C     ----- CARRY OUT OPTIONAL COUPLED CLUSTER COMPUTATION -----
C
      IF(CCTYP.NE.RNONE) THEN
         IF(E.EQ.ZERO  .AND.  EXETYP.NE.CHECK) THEN
            IF(MASWRK) WRITE(IW,9010) CCTYP
            IF(NFG.NE.0) RETURN
            CALL ABRT
         END IF
         CALL WFNCC
      END IF
C
C     ----- CARRY OUT OPTIONAL CI COMPUTATION -----
C
      IF (CITYP.NE.RNONE) THEN
         IF(E.EQ.ZERO  .AND.
     *          .NOT. (EXETYP.EQ.CHECK .OR. SCFTYP.EQ.RNONE)) THEN
            IF(MASWRK) WRITE(IW,9020) CITYP
            IF(NFG.NE.0) RETURN
            CALL ABRT
         END IF
         IF(SCFTYP.EQ.RMC) CALL ERASCI
         CALL WFNCI
      END IF
C
C     ----- CARRY OUT OPTIONAL VALENCE BOND COMPUTATION -----
C
      IF(VBTYP.NE.RNONE) THEN
         IF(E.EQ.ZERO  .AND.  EXETYP.NE.CHECK) THEN
            IF(MASWRK) WRITE(IW,9030) VBTYP
            CALL ABRT
         END IF
         IPSI=4
         CALL VBGMS(1)
         E     = VBENGY
         ETOT2 = VBENGY
         CALL DAWRIT(IDAF,IODA,ENUCR,MXRT+15,2,0)
         CALL PROPTY('VB  ')
      END IF
C
C     ----- CARRY OUT OPTIONAL TDDFT CALCULATION -----
C
      IF(TDDFTYP.NE.RNONE) THEN
         IF(E.EQ.ZERO  .AND.  EXETYP.NE.CHECK) THEN
            IF(MASWRK) WRITE(IW,9040) TDDFTYP
            IF(NFG.NE.0) RETURN
            CALL ABRT
         END IF
         CALL WFNTDDFT
      END IF
C
C     ----- WRITE ENERGY VALUES TO DISK -----
C     THIS NEEDS TO BE DONE BEFORE CALLING FOR PROPERTIES, SO THAT
C     EVERY PLACE SHOULD HAVE DONE THIS, BUT BE SAFE AND DO IT AGAIN.
C
      CALL DAWRIT(IDAF,IODA,ENUCR,MXRT+15,2,0)
      call stopwa(3,1)
      RETURN
C
 9000 FORMAT(/1X,'SCF DID NOT CONVERGE...NO MPLEVL=',I1,' CALCULATION')
 9010 FORMAT(/1X,'SCF DID NOT CONVERGE...NO CCTYP=',A8,' CALCULATION')
 9020 FORMAT(/1X,'SCF DID NOT CONVERGE...NO CITYP=',A8,' CALCULATION')
 9030 FORMAT(/1X,'SCF DID NOT CONVERGE...NO VBTYP=',A8,' CALCULATION')
 9040 FORMAT(/1X,'SCF DID NOT CONVERGE...NO TDDFT=',A8,' CALCULATION')
 9050 FORMAT(/1X,'SCF DID NOT CONVERGE...NO CIMTYP=',A8,' CALCULATION')
      END
C*MODULE GAMESS  *DECK WFNCC
C> @brief   interface to Coupled Cluster programs
C> @details selects from Michigan State's serial closed/open shell
C>          ground/excited state programs, Olson/Benz' parallel
C>          closed shell program, Asadchev's LIBCCHEM program.
C> @author  Mike Schmidt August 2002
!> @date September 2010 - Albert DeFusco
!> - Add calls to cim-specific drivers for correlated subsystems
      SUBROUTINE WFNCC
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      LOGICAL GOPARR,DSKWRK,MASWRK,ABEL,ABELPT,DIRSCF,FDIFF,
     *        EOM,DDITRF,NDINTS,DOCORE
      LOGICAL GMS_CCHEM
      DIMENSION ECCHEM(5)
      DIMENSION NANGM(7)
C
      PARAMETER (MXRT=100, MXATM=2000, MXAO=8192)
C
      COMMON /CCPAR / AMPTSH,METHCC,NCCTOT,NCCOCC,NCCFZC,NCCFZV,
     *                MXCCIT,MXRLEIT,MWRDCC,ICCCNV,ICCRST,IDSKCC
      COMMON /ENRGYS/ VNN,EELCT,ETOT,SZ,SZZ,ECORE,ESCF,EERD,E1,E2,
     *                VEN,VEE,EPOT,EKIN,ESTATE(MXRT),STATN,EDFT(2),EDISP
      COMMON /EOMPAR/ CVGCI,CVGEOM,GRPEOM,NSTEOM(8),NOACT,NUACT,
     *                MOACTCC(MXAO),MTHTRIP,MTHCI,MTHEOM,MTHINIT,
     *                MAXCI,MAXEOM,MICCI,MICEOM,IROOTCC(2),
     *                IPROPCC,IPROPCCE
      COMMON /FMOINF/ NFG,NLAYER,NATFMO,NBDFG,NAOTYP,NBODY
      COMMON /FMOOPT/ ESPSCA(9),RESPAP(2),RESPPC(2),RESDIM,RESTRI(4),
     *                RCORSD,RESPCT,CONVFG,CNVDMP,COROFF,RFLMO(4),
     *                ORSHFT,ORSHFT2,CNVAFO,ASCREEN(4),IXESP,MXITFG,
     *                NGUESS,NBSSE,MODORB,MODPAR,IRSTSTP,IRSTLAY,NPRFMO,
     *                NFMOPAL,MODPRP,MAXL1C,IPIEDA,MODGRD,MODESP,IVMUL,
     *                MODLMO,NOPDEN,MOFOCK,MODFD,modfmm,ncentm
      COMMON /FMORUN/ ESPSCF,E0SCF(2),EMP2S,IDAFMO,ICURFG,JCURFG,KCURFG,
     *                ICURLAY,ICURUNT,NAT1E,NCURSH,NGAU,ICURPOP,IFMOSTP,
     *                MONCOR,NEEDR,MODRST,NORBPROJ,NUNESP,ISKIPESP,
     *                IESDPPC,IDOPROP,MP2RUN,ICURIT,IDMFMO,IDDFMO,
     *                IDDCUR,NDDLEFT,IVMFMO,nzmtfmo
      COMMON /FMCOM / XX(1)
      COMMON /FUNCT / E,EG(3,MXATM)
      COMMON /INFOA / NAT,ICH,MUL,NUM,NQMT,NE,NA,NB,
     *                ZAN(MXATM),C(3,MXATM),IAN(MXATM)
      COMMON /IOFILE/ IR,IW,IP,IJK,IJKT,IDAF,NAV,IODA(950)
      COMMON /OPTSCF/ DIRSCF,FDIFF
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
      COMMON /PSILVL/ IPSI,ISKPRP
      COMMON /RUNOPT/ RUNTYP,EXETYP,NEVALS,NGLEVL,NHLEVL
      COMMON /WFNOPT/ SCFTYP,VBTYP,DFTYPE,TDDFTYP,CITYP,CCTYP,
     *                MPLEVL,MPCTYP
C
C     CHANGE FOR DIVIDE-AND-CONQUER METHOD
C
      LOGICAL DODCCR,ONLYOC,RMKORB,FZCORE,DOMP1,HFFRM
      COMMON /DCCORR/ RBUFCR,WOCC,ISTCOR,ITPART,DODCCR,ONLYOC,RMKORB,
     *                FZCORE,DOMP1,HFFRM
C
      DATA RHF,ROHF/8HRHF     ,8HROHF    /
      DATA CCSDT/8HCCSD(T) /
      DATA EOMSD,CREOM,CREOML,CRCCL
     *   /8HEOM-CCSD,8HCR-EOM  ,8HCR-EOML ,8HCR-CCL  /
      DATA CHECK/8HCHECK   /
      DATA NANGM/4,4,6,10,15,21,28/
      DATA CIMSUB/8HCIMSUB  /
C
C        ---- DRIVER FOR COUPLED CLUSTER CALCULATION ----
C     IT IS USEFUL TO REMEMBER THAT
C     NCCTOT IS THE TOTAL NUMBER OF MOS.
C     NCCOCC IS THE NUMBER OF OCCUPIED MOS, INCLUDING CORE.
C     NCCFZC IS THE NUMBER OF CORE ORBITALS OMITTED FROM CORRELATION.
C     NCCFZV IS THE NUMBER OF FROZEN EXTERNAL ORBITALS OMITTED.
C
      IPSI=3
      NCCTOT = NQMT
      IXESPS=IXESP
      IF(NFG.NE.0.AND.IAND(IXESP,2048).NE.0) IXESP=IXESP-2048
C
C        LIBCCHEM's C++ program can take CCSD(T) runs only.
C
      IF (GMS_CCHEM()  .AND.  CCTYP.EQ.CCSDT) THEN
         CALL SYSINP(MEMORY,MEMDDI)
         IF(NPROC.GT.1  .AND.  MEMDDI.EQ.0) THEN
            IF(MASWRK) THEN
               WRITE(IW,*) 'PARALLEL LIBCCHEM CCSD(T) WITHOUT MEMDDI.'
               WRITE(IW,*) 'ASSUMING LIBCCHEM BUILT WITH PARALLEL HDF5.'
            END IF
            CALL ABRT
         END IF
         NACT = NCCOCC - NCCFZC
         NVIR = NCCTOT - NCCOCC - NCCFZV
C
C             MEMORY NEEDS ARE COPIED FROM CCHEM'S OUTPUT
C          triples use only Tijab and Vijab storage from the CCSD step.
C
         NAV = NACT + NVIR
         CALL BASCHK(LMAX)
         LANG = NANGM(LMAX+1)
         NTIJAB =   NACT*NACT*NVIR*NVIR
         NUIJAB =   NACT*NACT*NUM *NUM
         NVIJAB =   NACT*NACT*NAV *NUM
         NVIQRS =   NACT*LANG*NUM *NAV
         NVIJKA =   NACT*NACT*NACT*NVIR
         NVIJKL =   NACT*NACT*NACT*NACT
         NVIAJB =   NACT*NVIR*NACT*NUM
         NITER  = 4*NACT*NACT*NUM*NUM + NACT*NVIR
         NVIABC =   NACT*NVIR*NUM*NVIR
         NCCSD = NTIJAB + NUIJAB
     *         + NVIJAB + NVIQRS + NVIJKA + NVIJKL + NVIAJB
     *         + NITER
         NTRIP = NTIJAB + NVIJAB + NVIABC
         NCCSD = NCCSD/1000000 + 1
         NTRIP = NTRIP/1000000 + 1
C
         IF(MASWRK) THEN
            WRITE(IW,9200) CCTYP,NUM,NCCTOT,NCCOCC,NCCFZC,NACT,NVIR,
     *                     NCCFZV,MXCCIT,MXRLEIT,ICCCNV,AMPTSH
            WRITE(IW,9210) NCCSD,NTRIP
            WRITE(IW,*) ' '
         END IF
C
         IF(EXETYP.EQ.CHECK) THEN
            ECCHEM(1) = 0.0D+00
            ECCHEM(2) = 0.0D+00
            ECCHEM(3) = 0.0D+00
            ECCHEM(4) = 0.0D+00
            ECCHEM(5) = 0.0D+00
         ELSE
            CALL GMS_CCHEM_CCSD_ENERGY(ECCHEM)
         END IF
C
         E    = ESCF + ECCHEM(4)
         ETOT = ESCF + ECCHEM(4)
         IF(MASWRK) THEN
            WRITE(IW,*) ' '
            WRITE(IW,9220) ESCF,ESCF+ECCHEM(1),ESCF+ECCHEM(2),
     *                          ESCF+ECCHEM(3),ESCF+ECCHEM(4)
            WRITE(IW,*) ' '
            WRITE(IW,*) '.... DONE WITH CCSD(T) ENERGY ....'
         END IF
         CALL TIMIT(1)
         RETURN
      END IF
 9200 FORMAT(/5X,41(1H-),5X,21(1H-)/
     *        5X,'CCSD(T) ENERGY CALCULATION USING LIBCCHEM',
     *        5X,'PROGRAM BY A.ASADCHEV'/
     *        5X,41(1H-),5X,21(1H-)/
     *        1X,'CCTYP                            =',A8/
     *        1X,'NUMBER OF ATOMIC BASIS FUNCTIONS =',I6/
     *        1X,'TOTAL NUMBER OF MOS              =',I6/
     *        1X,'NUMBER OF OCCUPIED MOS           =',I6/
     *        1X,'NUMBER OF FROZEN CORE MOS        =',I6/
     *        1X,'NUMBER OF VALENCE MOS CORRELATED =',I6/
     *        1X,'NUMBER OF VIRTUAL MOS CORRELATED =',I6/
     *        1X,'NUMBER OF FROZEN VIRTUAL MOS     =',I6/
     *        1X,'MAXIMUM CC ITERATIONS            =',I6/
     *        1X,'MAXIMUM DIIS ITERATIONS          =',I6/
     *        1X,'CONVERGENCE CRITERION FOR CC     =',I6/
     *        1X,'AMPLITUDE ACCURACY THRESHOLD     =',1P,E8.1)
 9210 FORMAT(/1X,'MEMORY REQUIREMENT FOR CCSD ITERS=',I10,' MWORDS.'/
     *        1X,'MEMORY REQUIREMENT FOR (T) STEP  =',I10,' MWORDS.'/
     *        1X,'IF DISTRIBUTED MEMORY (MEMDDI) EXCEEDS THE LARGER',
     *           ' OF THESE,'/
     *        1x,'NO HDF5 DISK FILES WILL BE USED.')
 9220 FORMAT(/5X,'LIBCCHEM''S COUPLED CLUSTER CALCULATION RESULTS:'/
     *        10X,'E(RHF)     =',F20.10/
     *        10X,'E(MP2)     =',F20.10/
     *        10X,'E(CCSD)    =',F20.10/
     *        10X,'E(CCSD[T]) =',F20.10/
     *        10X,'E(CCSD(T)) =',F20.10)
C
      IF(MASWRK) THEN
         IF(.NOT.DODCCR) THEN
            WRITE(IW,9000) CCTYP,NCCTOT,NCCOCC,NCCFZC,NCCFZV,
     *                     MXCCIT,MXRLEIT,ICCCNV,AMPTSH
            IF(NFG.NE.0.AND.NORBPROJ.NE.0) WRITE(IW,9005) NORBPROJ
            IF(MWRDCC.GT.0) WRITE(IW,9010) MWRDCC
         ELSE
            WRITE(IW,9500) CCTYP,MXCCIT,MXRLEIT,ICCCNV,AMPTSH
         ENDIF
      END IF
C
C     ----- AO BASIS 2E- INTEGRALS -----
C     IF NON-ABELIAN, WE NEED A C1 SYMMETRY AO INTEGRAL LIST,
C     SO THAT THE INTEGRAL TRANSFORMATION WILL RUN CORRECTLY.
C
      ABEL = ABELPT()
      IF(.NOT.DIRSCF  .AND.  .NOT.ABEL) THEN
         IF(MASWRK) WRITE(IW,9020)
         CALL SYMOFF
         CALL JANDK
         CALL SYMON
      END IF
C
      IF (DODCCR) THEN
C
C        DIVIDE-AND-CONQUER COUPLED CLUSTER RUNS
C
         EOM = CCTYP.EQ.EOMSD .OR. CCTYP.EQ.CREOM .OR. CCTYP.EQ.CREOML
     *                        .OR. CCTYP.EQ.CRCCL
         IF(MASWRK  .AND.  EOM) WRITE(IW,9040)
         CALL DCCCDRVR(BESTCC,EOM)
C
         IF(EXETYP.EQ.CHECK) BESTCC=0.0D+00
         E    = BESTCC
         ETOT = BESTCC
         CALL DAWRIT(IDAF,IODA,VNN,MXRT+15,2,0)
C
         RETURN
      END IF
C
C        CARRY OUT A FOUR INDEX TRANSFORMATION OVER ONLY
C        THOSE ORBITALS CORRELATED BY THE CC CALCULATION.
C        IN SERIAL, THIS IS A FULL VVVV TRANSFORMATION.
C        IN PARALLEL, WE DO INTEGRALS FROM OOOO TO VVVO BUT NOT VVVV.
C
      NPRINT= 0
      NCORBS= NCCFZC
      DOCORE=.FALSE.
      IF(GOPARR) THEN
         DDITRF=.TRUE.
         NDINTS=.TRUE.
         NOCCMO= NCCOCC
         NTOTMO= NCCTOT-NCCFZV
      ELSE
         DDITRF=.FALSE.
         NDINTS=.FALSE.
         NOCCMO= NCCTOT-NCCFZV
         NTOTMO= NCCTOT-NCCFZV
      END IF
C
C        PRINT A WARNING IF THERE IS A VERY LARGE COEFFICIENT
C        IN THE VIRTUAL ORBITAL SPACE
      CALL VALFM(LOADFM)
      LVEC = LOADFM+1
      LAST = LVEC + NUM*NUM
      NEED = LAST-LOADFM-1
      CALL GETFM(NEED)
      CALL DAREAD(IDAF,IODA,XX(LVEC),NUM*NUM,15,0)
      MAXC = IDAMAX(NUM*NQMT,XX(LVEC),1)
      BIGGEST = ABS(XX(LVEC-1+MAXC))
      IF(BIGGEST.GT.1.0D+02) THEN
         MAXM = 1 + MAXC/NUM
         MAXA = MAXC - NUM*(MAXM-1)
         IF(MASWRK) WRITE(IW,9100) BIGGEST,MAXA,MAXM
      END IF
      CALL RETFM(NEED)
C
      IF (RUNTYP.EQ.CIMSUB) THEN
         CALL TRFMCX_CIM(NPRINT,NCORBS,NOCCMO,NTOTMO,.FALSE.,.FALSE.,
     *        DDITRF,NDINTS,NDINTS,NDINTS,NDINTS,NDINTS,.FALSE.,DOCORE)
      ELSE
         CALL TRFMCX(NPRINT,NCORBS,NOCCMO,NTOTMO,.FALSE.,.FALSE.,DDITRF,
     *            NDINTS,NDINTS,NDINTS,NDINTS,NDINTS,.FALSE.,DOCORE)
      END IF
C
C        PERFORM THE COUPLED CLUSTER CALCULATION
C
C        THE VARIABLE -EOM- CAPTURES COMPUTATIONS THAT NEED TO
C        BE DIRECTED TOWARD THE EOM/METHOD OF MOMENTS CODE,
C        WHICH IS NOT ALWAYS AN EXCITED STATE COMPUTATION.
C
      IF(SCFTYP.EQ.RHF) THEN
         EOM = CCTYP.EQ.EOMSD .OR. CCTYP.EQ.CREOM .OR. CCTYP.EQ.CREOML
     *                        .OR. CCTYP.EQ.CRCCL
         IF(MASWRK  .AND.  EOM) WRITE(IW,9040) CCTYP
         IF (RUNTYP.EQ.CIMSUB) THEN
            CALL   CCDRVR_CIM(BESTCC,EOM)
         ELSE
            CALL   CCDRVR(BESTCC,EOM)
         END IF
      END IF
C
      IF(SCFTYP.EQ.ROHF) THEN
         EOM = CCTYP.EQ.EOMSD .OR. CCTYP.EQ.CREOM
         IF (RUNTYP.EQ.CIMSUB) THEN
            CALL ROCCDRVR_CIM(BESTCC,EOM)
         ELSE
            CALL ROCCDRVR(BESTCC,EOM)
         END IF
      END IF
C
C        CARRY OUT POSSIBLE CLOSED SHELL EQUATION OF MOTION CALCULATION
C        CCSD (WITHOUT TRIPLES) WAS DONE DURING THE CCDRVR STEP ABOVE,
C        AND THIS GROUND STATE ENERGY SHOULD BE PASSED TO THE EOM-CCSD.
C        THE ENERGY OF ONE OF THE EXCITED STATES, POSSIBLY TRIPLES
C        CORRECTED, WILL BE PASSED BACK TO US TO SAVE AS THE ANSWER.
C
      IF(SCFTYP.EQ.RHF) THEN
         IF(EOM) THEN
            IF(MASWRK) WRITE(IW,9050)
            ECCSD = BESTCC
            IF (RUNTYP.EQ.CIMSUB) THEN
               CALL EOMDRV_CIM(CCTYP,ESCF,ECCSD,BESTEOM)
            ELSE
               CALL EOMDRV(CCTYP,ESCF,ECCSD,BESTEOM)
            END IF
            BESTCC = BESTEOM
         END IF
C     PROBABLY, FILE CLOSING IN CCFCLO SHOULD BE DONE WITHOUT IFS.
C     EOMDRV USES SOME FILES OPENED IN CCDRVR!!
         IF(NFG.NE.0) CALL CCFCLO(EOM)
      END IF
C
      CALL DERCHK(NDER)
      IF(NDER.GT.0  .AND.  CCTYP.EQ.CRCCL  .AND.  MASWRK) WRITE(IW,9060)
C
      IF(EXETYP.EQ.CHECK) BESTCC=0.0D+00
      E    = BESTCC
      ETOT = BESTCC
      CALL DAWRIT(IDAF,IODA,VNN,MXRT+15,2,0)
C
C        CCPRP/CCPRPE BOTH RESULT IN IPROPCC BEING SET,
C        BUT WE MUST THINK ABOUT G.S. VERSUS ONE PARTICULAR E.S.
C        OPEN SHELL CODE DOES NOT YET PRODUCE A DENSITY MATRIX.
C
      IF(SCFTYP.NE.ROHF) THEN
C
         IF(IPROPCC.NE.0) THEN
            IF(IROOTCC(1).EQ.1  .AND.  IROOTCC(2).EQ.0) THEN
               CALL PROPTY('CCSD')
            ELSE
               CALL PROPTY('EOMD')
            END IF
         END IF
      END IF
C
C     FMO IS CONFUSED WITH THE CC DENSITY, SO RESTORE THE RHF VALUES
C
      IF(NFG.NE.0.AND.IAND(IXESP,2048).NE.0) CALL LOADHFD
      IXESP=IXESPS
      RETURN
C
 9000 FORMAT(/5X,27(1H-)/5X,'COUPLED CLUSTER CALCULATION'/5X,27(1H-)/
     *        1X,'CCTYP                        =',A8/
     *        1X,'TOTAL NUMBER OF MOS          =',I6/
     *        1X,'NUMBER OF OCCUPIED MOS       =',I6/
     *        1X,'NUMBER OF FROZEN CORE MOS    =',I6/
     *        1X,'NUMBER OF FROZEN VIRTUAL MOS =',I6/
     *        1X,'MAXIMUM CC ITERATIONS        =',I6/
     *        1X,'MAXIMUM DIIS ITERATIONS      =',I6/
     *        1X,'CONVERGENCE CRITERION FOR CC =',I6/
     *        1X,'AMPLITUDE ACCURACY THRESHOLD =',1P,E8.1)
 9005 FORMAT(/1X,'NUMBER OF REDUNDANT MOS IN FMO=',I5)
 9010 FORMAT( 1X,'MAXIMUM MEMORY USAGE IN CC   =',I12)
 9020 FORMAT(/1X,'REGENERATING AO INTEGRAL LIST W/O SYMMETRY FOR THE',
     *           ' INTEGRAL TRANSFORMATION.')
 9040 FORMAT(/1X,'CCTYP=',A8,' CALCULATION REQUIRES CONVERGED GROUND',
     *           ' STATE CCSD AMPLTUDES.')
 9050 FORMAT(/1X,'THE GROUND STATE CCSD HAS CONVERGED,',
     *          ' NOW ENTERING THE EOMCCSD PROGRAM TO'/
     *       1X,'CALCULATE EXCITED STATE(S) AND/OR',
     *          ' PROPERTIES AND/OR CR-CC(2,3) ENERGIES...'/)
 9060 FORMAT(/1X,'THE DERIVATIVE COMPUTATION WILL BE DONE WITH THE',
     *           ' TYPE -A- CR-CC(2,3)'/
     *        1X,'ENERGY, WHICH IS INVARIANT TO ROTATIONS OF THE',
     *           ' ORBITALS.')
 9100 FORMAT(/1X,'*** WARNING ***'/
     *        1X,'MAXIMUM LCAO COEF=',F15.6,
     *           ', FOR AO',I6,' IN MO=',I6,' EXCEEDS 100.'/
     *        1X,'ADDITIONAL INPUTS MAY BE REQUIRED TO',
     *           ' OBTAIN GOOD CC ACCURACY:'/
     *        1X,' $CONTRL ICUT=10 OR 11'/
     *        1X,' $TRANS  CUTTRF= 1D-10 OR 1D-11'/
     *        1X,' $SCF    CONV=2.5D-07 FDIFF=.FALSE.'/
     *        1X,'IF CCSD CONVERGENCE TROUBLES ARISE,',
     *           ' CONSIDER USING QMTTOL.')
 9500 FORMAT(/5X,46(1H-)
     *       /5X,'DIVIDE-AND-CONQUER COUPLED CLUSTER CALCULATION'
     *       /5X,46(1H-)/
     *        1X,'CCTYP                        =',A8/
     *        1X,'MAXIMUM CC ITERATIONS        =',I6/
     *        1X,'MAXIMUM DIIS ITERATIONS      =',I6/
     *        1X,'CONVERGENCE CRITERION FOR CC =',I6/
     *        1X,'AMPLITUDE ACCURACY THRESHOLD =',1P,E8.1)
      END
C*MODULE GAMESS  *DECK WFNCI
      SUBROUTINE WFNCI
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      DOUBLE PRECISION NEOSCF,NEOCI
C
      PARAMETER (MXATM=2000, MXRT=100)
C
      PARAMETER (NNAM=3)
      DIMENSION QNAM(NNAM),KQNAM(NNAM)
      DIMENSION NRNFG(10),NPFLG(10)
C
      LOGICAL GOPARR,DSKWRK,MASWRK,SVDSKW,SVDIRT,DIRTRF,ABEL,ABELPT,
     *        DDITRF,DOOOOO,DOVOOO,DOVVOO,DOVOVO,DOVVVO,DOVVVV,DOCORE
C
      COMMON /CEEIS0/ ICEEIS
      COMMON /ENRGYS/ ENUCR,EELCT,ETOT2,SZ2,SZZ2,ECORE,ESCF,EERD,E1,E2,
     *                VEN,VEE,EPOT,EKIN,ESTATE(MXRT),STATN,EDFT(2),EDISP
      COMMON /FMOINF/ NFG,NLAYER,NATFMO,NBDFG,NAOTYP,NBODY
      COMMON /INFOA / NAT,ICH,MUL,NUM,NQMT,NE,NA,NB,
     *                ZAN(MXATM),C(3,MXATM),IAN(MXATM)
      COMMON /IOFILE/ IR,IW,IP,IJK,IJKT,IDAF,NAV,IODA(950)
      COMMON /NEOJOB/ NEORUN,NELERM
      COMMON /NEOMTD/ NEOSCF,NEOCI
      COMMON /OUTPUT/ NPRINT,ITOL,ICUT,NORMF,NORMP,NOPK
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
      COMMON /PSILVL/ IPSI,ISKPRP
      COMMON /RUNOPT/ RUNTYP,EXETYP,NEVALS,NGLEVL,NHLEVL
      COMMON /TRFOPT/ CUTTRF,NWDTRF,MPTRAN,ITRFAO,NOSYMT,IPURTF,DIRTRF
      COMMON /WFNOPT/ SCFTYP,VBTYP,DFTYPE,TDDFTYP,CITYP,CCTYP,
     *                MPLEVL,MPCTYP
C
      INTEGER         D_OOOO,D_VOOO,D_VVOO,D_VOVO,D_VVVO,D_VVVV,
     *                D_OOOOAB,D_OOOOBB,D_VOOOAB,D_VOOOBA,D_VOOOBB,
     *                D_VVOOAB,D_VVOOBA,D_VVOOBB,D_VOVOAB,D_VOVOBB,
     *                D_U,D_UB,D_E,D_EB
      LOGICAL         NDOOOO,NDVOOO,NDVVOO,NDVOVO,NDVVVO,NDVVVV,NDCORE,
     *                NDVVOOBA,NDVVOOAB,NDVVOOBB,NDVOVOAB,NDVOVOBB,
     *                NDVOOOBA,NDVOOOAB,NDVOOOBB,NDOOOOAB,NDOOOOBB
      COMMON /TRFDMS/ D_OOOO,D_VOOO,D_VVOO,D_VOVO,D_VVVO,D_VVVV,
     *                D_OOOOAB,D_OOOOBB,D_VOOOAB,D_VOOOBA,D_VOOOBB,
     *                D_VVOOAB,D_VVOOBA,D_VVOOBB,D_VOVOAB,D_VOVOBB,
     *                D_U,D_UB,D_E,D_EB,
     *                NDOOOO,NDVOOO,NDVVOO,NDVOVO,NDVVVO,NDVVVV,NDCORE,
     *                NDVVOOBA,NDVVOOAB,NDVVOOBB,NDVOVOAB,NDVOVOBB,
     *                NDVOOOBA,NDVOOOAB,NDVOOOBB,NDOOOOAB,NDOOOOBB
C
C     ----- SET UP NAMELIST SIMULATION -----
C
      DATA CIINP/8HCIINP   /
      DATA QNAM/8HNRNFG   ,8HNPFLG   ,8HIREST   /
      DATA KQNAM/101,101,1/
      DATA NRNFG /1,1,1,1,1,0,0,0,0,0/
      DATA NPFLG /0,0,0,0,0,0,0,0,0,0/
C
      DATA CIDRT/8HCIDRT   /
      DATA RMC  /8HMCSCF   /
      DATA RNONE/8HNONE    /
      DATA OPTMIZ/8HOPTIMIZE/, SADPT/8HSADPOINT/, TRUDGE/8HTRUDGE  /
      DATA ALDET,GENCI,FSOCI/8HALDET   ,8HGENCI   ,8HFSOCI   /
      DATA    ORMAS,CIS,GUGA/8HORMAS   ,8HCIS     ,8HGUGA    /
      DATA SFCIS/8HSFCIS   /
      DATA FCI/8HFCI     /
      DATA CHECK/8HCHECK   /
C
C     ----- EVALUATE A CI WAVEFUNCTION -----
C
      IPSI=1
C
      SVDSKW = DSKWRK
      DSKWRK = .TRUE.
      NASAVE = NA
      NBSAVE = NB
C
C           CIS HAS ITS OWN DRIVER, DOESN'T USE $CIINP AT ALL
C
      IF(CITYP.EQ.CIS .OR. CITYP.EQ.SFCIS) GO TO 500
C
C     THE CI STEPS TO BE EXECUTED ARE IN -NRNFG-,
C     WITH THE AMOUNT OF PRINTOUT CONTROLLED BY -NPFLG-
C     USE OF -IREST- FOR RESTARTING IN THE MIDDLE IS --NOT-- RECOMMENDED
C
      JRET=0
      IREST=1
C
      CALL NAMEIO(IR,JRET,CIINP,NNAM,QNAM,KQNAM,
     *            NRNFG,NPFLG,IREST,
     *            0,
     *     0,0,0,0,0,  0,0,0,0,0,  0,0,0,0,0,  0,0,0,0,0,
     *     0,0,0,0,0,  0,0,0,0,0,  0,0,0,0,0,  0,0,0,0,0,
     *     0,0,0,0,0,  0,0,0,0,0,  0,0,0,0,0,  0,0,0,0,0)
      IF (JRET.GT.1) THEN
         IF (MASWRK) WRITE (IW,9010)
         CALL ABRT
      END IF
C
C     ---- ANALYTIC GUGA CI GRADIENT REQUIRES BOTH
C     ---- 2 PARTICLE DENSITY AND THE LAGRANGIAN.
C
      CALL DERCHK(NDER)
      IF(NDER.GT.0  .AND.  NGLEVL.EQ.0) THEN
         NRNFG(6)=1
         NRNFG(7)=1
      END IF
C
C     ----- TURN OFF CI PRINTOUT AFTER 1ST GEOMETRY -----
C     OPTIMIZE,SADPOINT,TRUDGE RUNS SHOULD ALWAYS PRINT CI DIAG
C
      IF (NPRINT.EQ.-5) THEN
         IREST=1
         DO 140 I = 1,10
            NPFLG(I) = -5
  140    CONTINUE
         IF(RUNTYP.EQ.OPTMIZ) NPFLG(4) = 0
         IF(RUNTYP.EQ.SADPT)  NPFLG(4) = 0
         IF(RUNTYP.EQ.TRUDGE) NPFLG(4) = 0
      END IF
C
C     ----- AO BASIS 2E- INTEGRALS -----
C     IF NO PRELIMINARY SCF WAS DONE, WE NEED AN AO INTEGRAL LIST.
C     IF NON-ABELIAN, WE NEED A C1 SYMMETRY AO INTEGRAL LIST.
C     PARALLEL RUNS ONLY NEED TO SET UP THE DDI MO TRANSFORMATION.
C
      SVDIRT=DIRTRF
      IF(GOPARR) DIRTRF=.TRUE.
C
      ABEL = ABELPT()
      IF(SCFTYP.EQ.RNONE .OR.  .NOT.ABEL) THEN
         IF(.NOT.ABEL) CALL SYMOFF
         CALL JANDK
         IF(.NOT.ABEL) CALL SYMON
      END IF
C
C     POSSIBLY CHANGE THE STATE MULTIPLICITY FOR FMO-CI (MONOMERS).
C     DEACTIVATE AND REMOVE LATER.
C
      IF(NFG.NE.0) CALL FMOMUL
C
      DIRTRF=SVDIRT
C
  500 CONTINUE
C
C              ===== EXECUTE THE DESIRED CI PACKAGE =====
C     THE CI COMPUTATION IS EXPECTED TO PRODUCE A DENSITY MATRIX FOR
C     SOME SPECIFIC STATE, AND FALL INTO PROPERTY EVALUATION BELOW.
C
C        CARRY OUT A DETERMINANT OR CSF BASED CI SINGLES COMPUTATION
C           NOTE WELL!  ACHTUNG!  WE RETURN AT ONCE, FOR CIS HANDLES A
C           SINGLE CALL FOR PROPERTIES, EXPECTATION OR RELAXED, ITSELF.
C
      IF(CITYP.EQ.CIS .OR. CITYP.EQ.SFCIS) THEN
         CALL WFNCIS
         RETURN
      END IF
C
C        CARRY OUT A DETERMINANT BASED NEO FULL CI COMPUTATION
C
      IF(NEORUN.EQ.1) THEN
         IF(NEOCI.EQ.FCI) THEN
            CALL NEOFCI(NPFLG,0)
         ELSE
            WRITE(IW,*) 'NEOCI=FCI MUST BE SELECTED IN $NEO'
            CALL ABRT
         END IF
         RETURN
      END IF
C
C        CARRY OUT A DETERMINANT BASED FULL CI COMPUTATION
C
      IF(CITYP.EQ.ALDET) THEN
         IF(MASWRK) WRITE(IW,9110) NRNFG(2),NPFLG(2),
     *         NRNFG(4),NPFLG(4),NRNFG(5),NPFLG(5),NRNFG(6),NPFLG(6)
         CALL ALDECI(NRNFG,NPFLG)
      END IF
C
C        CARRY OUT A DETERMINANT BASED GENERAL CI COMPUTATION
C
      IF(CITYP.EQ.GENCI) THEN
         IF(MASWRK) WRITE(IW,9120) NRNFG(2),NPFLG(2),
     *         NRNFG(4),NPFLG(4),NRNFG(5),NPFLG(5),NRNFG(6),NPFLG(6)
         CALL ALGNCI(NRNFG,NPFLG)
      END IF
C
C        CARRY OUT A DETERMINANT BASED FULL SECOND ORDER CI COMPUTATION
C
      IF(CITYP.EQ.FSOCI) THEN
         IF(MASWRK) WRITE(IW,9130) NRNFG(2),NPFLG(2),
     *         NRNFG(4),NPFLG(4),NRNFG(5),NPFLG(5),NRNFG(6),NPFLG(6)
         CALL FSODCI(NRNFG,NPFLG)
      END IF
C
C        CARRY OUT A DETERMINANT BASED ORMAS CI COMPUTATION
C
      IF(CITYP.EQ.ORMAS) THEN
         IF(MASWRK) WRITE(IW,9140) NRNFG(2),NPFLG(2),
     *         NRNFG(4),NPFLG(4),NRNFG(5),NPFLG(5),NRNFG(6),NPFLG(6)
         IF (ICEEIS.EQ.0) THEN
           CALL ORDET(NRNFG,NPFLG)
         ELSE IF (ICEEIS.EQ.1) THEN
           CALL CEEIS(NRNFG,NPFLG)
         END IF
      END IF
C
C        CARRY OUT A CSF BASED GUGA CI COMPUTATION
C
      IF(CITYP.EQ.GUGA) THEN
         IF (MASWRK) WRITE (IW,9150) (NRNFG(I),NPFLG(I),I=1,8)
         IF(IREST.LE.0) IREST=1
         GO TO (210,220,230,240,250,260,270,280), IREST
C
C        ----- CONSTRUCT -DRT- TABLE -----
C
  210    CONTINUE
         DRTNAM = CIDRT
         IF(NRNFG(1).NE.0) CALL DRTGEN(NPFLG(1),DRTNAM)
C
C        ----- TRANSFORM INTEGRALS -----
C
  220    CONTINUE
         DDITRF = GOPARR
                    DOOOOO=.FALSE.
         IF(DDITRF) DOOOOO=.TRUE.
                    DOVOOO=.FALSE.
                    DOVVOO=.FALSE.
                    DOVOVO=.FALSE.
                    DOVVVO=.FALSE.
                    DOVVVV=.FALSE.
                 DOCORE=.TRUE.
         IF(NRNFG(2).NE.0) THEN
             CALL TRFMCX(NPFLG(2),0,0,0,.FALSE.,.TRUE.,
     *                   DDITRF,DOOOOO,DOVOOO,DOVVOO,DOVOVO,
     *                   DOVVVO,DOVVVV,DOCORE)
         END IF
C
C        ----- SORT THE TRANSFORMED INTEGRALS FOR -GUGA-CI -----
C
  230    CONTINUE
         IF (NRNFG(3).NE.0) CALL GUGSRT(NPFLG(3),DDITRF)
C
C        ----- CONSTRUCT THE -CI- ENERGY MATRIX -----
C
         IF (NRNFG(3).NE.0) CALL GUGAEM(NPFLG(3))
C
C        ----- FIND ROOT(S) OF THE -CI- ENERGY MATRIX -----
C     IF THE ORBITALS ARE FROM MCSCF, WE NEED TO BLOW AWAY THE
C     MCSCF FUNCTIONS EIGENVECTOR FILE.
C
  240    CONTINUE
         IF (NRNFG(4).NE.0) THEN
            IF(SCFTYP.EQ.RMC) CALL ERASCI
            CALL GUGADG(NPFLG(4))
         END IF
C
C        ----- GET 1-PARTICLE REDUCED DENSITY MATRIX -----
C
  250    CONTINUE
         IF (NRNFG(5).NE.0) CALL GUGADM(NPFLG(5))
C
C        ----- GET 2-PARTICLE REDUCED DENSITY MATRIX -----
C
  260    CONTINUE
         IF (NRNFG(6).NE.0) CALL GUG2DM(NPFLG(6))
C
C        ----- GET LAGRANGIAN MATRIX -----
C
  270    CONTINUE
         IF (NRNFG(7).NE.0) CALL CILGRN(NPFLG(7))
C
C        ----- DETERMINE ENERGY FROM DENSITIES AND INTEGRALS -----
C
  280    CONTINUE
         IF(NRNFG(8).NE.0) CALL CINRGY(NPFLG(8))
C
         IF(DDITRF  .AND.  EXETYP.NE.CHECK) CALL DDI_DESTROY(D_OOOO)
      END IF
C
C        EACH CI PACKAGE SHOULD HAVE PUT ITS ENERGIES INTO /ENRGYS/,
C        SO WE CAN DO THE WRITE-TO-DISK FOR ALL OF THEM HERE.
C
      CALL DAWRIT(IDAF,IODA,ENUCR,MXRT+15,2,0)
C
C     --- WAVE FUNCTION PROPERTIES FOR CI EXPECTATION VALUE DENSITY ---
C
      CALL PROPTY('CI E')
C
      DSKWRK = SVDSKW
      NA = NASAVE
      NB = NBSAVE
      RETURN
C
 9010 FORMAT(1X,'NAMELIST $CIINP SYNTAX ERROR FOUND.')
 9110 FORMAT(/1X,'DETERMINANT CI OPTIONS   NRNFG   NPFLG'/
     *        1X,'INTEGRAL TRANSFORMATION',I5,3X,I5/
     *        1X,'DIAGONALIZE HAMILTONIAN',I5,3X,I5/
     *        1X,'FORM 1E- DENSITY MATRIX',I5,3X,I5/
     *        1X,'FORM 2E- DENSITY MATRIX',I5,3X,I5)
 9120 FORMAT(/1X,'GENERAL CI OPTIONS       NRNFG   NPFLG'/
     *        1X,'INTEGRAL TRANSFORMATION',I5,3X,I5/
     *        1X,'DIAGONALIZE HAMILTONIAN',I5,3X,I5/
     *        1X,'FORM 1E- DENSITY MATRIX',I5,3X,I5/
     *        1X,'FORM 2E- DENSITY MATRIX',I5,3X,I5)
 9130 FORMAT(/1X,'FULL SECOND-ORDER CI OPTIONS       NRNFG   NPFLG'/
     *        1X,'INTEGRAL TRANSFORMATION',10X,I5,3X,I5/
     *        1X,'DIAGONALIZE HAMILTONIAN',10X,I5,3X,I5/
     *        1X,'FORM 1E- DENSITY MATRIX',10X,I5,3X,I5/
     *        1X,'FORM 2E- DENSITY MATRIX',10X,I5,3X,I5)
 9140 FORMAT(/1X,'OCCUPATIONALLY RESTRICTED MULTIPLE ACTIVE SPACE',
     *           ' CI OPTIONS'/
     *        1X,'                                   NRNFG   NPFLG'/
     *        1X,'INTEGRAL TRANSFORMATION',10X,I5,3X,I5/
     *        1X,'DIAGONALIZE HAMILTONIAN',10X,I5,3X,I5/
     *        1X,'FORM 1E- DENSITY MATRIX',10X,I5,3X,I5/
     *        1X,'FORM 2E- DENSITY MATRIX',10X,I5,3X,I5)
 9150 FORMAT(/1X,'GUGA CI OPTIONS      NRNFG     NPFLG'/1X,36(1H-)//
     *        1X,'-DRT- TABLE      ',I5,5X,I5/
     *        1X,'TRANSFORMATION   ',I5,5X,I5/
     *        1X,'ENERGY MATRIX    ',I5,5X,I5/
     *        1X,'DIAGONALIZATION  ',I5,5X,I5/
     *        1X,'1E-DENSITY MATRIX',I5,5X,I5/
     *        1X,'2E-DENSITY MATRIX',I5,5X,I5/
     *        1X,'LAGRANGIAN MATRIX',I5,5X,I5)
      END
C*MODULE GAMESS  *DECK WFNCIS
      SUBROUTINE WFNCIS
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      CHARACTER*4 PRPTYP
C
      LOGICAL PK,PANDK,BLOCK,DIRSCF,FDIFF,GOPARR,DSKWRK,MASWRK,
     *        MNMEDG,MNMEOP,UNVGSS,DGAPRX,RDCISV,DIRTRF,DETRUN,
     *        EXPDEN
C
      PARAMETER (MXATM=2000, MXRT=100)
C
      COMMON /ENRGYS/ ENUCR,EELCT,ETOT,SZ,SZZ,ECORE,ESCF,EERD,E1,E2,
     *                VEN,VEE,EPOT,EKIN,ESTATE(MXRT),STATN,EDFT(2),EDISP
      COMMON /FUNCT / E,EG(3,MXATM)
      COMMON /CISPAR/ HAMTYP,DIAGZN,DAVCVG,PRTTOL,NSTATE,ISTATE,MULT,
     &                MXV,NDAVIT,ICISPR,NACORE,NBCORE,NOA,NOB,NORBOC,
     &                NBF,NGSVEC,MNMEDG,MNMEOP,ICLOBBR,UNVGSS,DGAPRX,
     &                RDCISV
      COMMON /CISEN / ECIS
      COMMON /INFOA / NAT,ICH,MUL,NUM,NQMT,NE,NA,NB,
     *                ZAN(MXATM),C(3,MXATM),IAN(MXATM)
      COMMON /INT2IC/ NINTIC,ININTIC,NXXIC,LBUFPIC,LIXIC,LABSIX,NINTIX
      COMMON /IOFILE/ IR,IW,IP,IJK,IJKT,IDAF,NAV,IODA(950)
      COMMON /OPTSCF/ DIRSCF,FDIFF
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
      COMMON /PKFIL / PK,PANDK,BLOCK
      COMMON /TRFOPT/ CUTTRF,NWDTRF,MPTRAN,ITRFAO,NOSYMT,IPURTF,DIRTRF
      COMMON /WFNOPT/ SCFTYP,VBTYP,DFTYPE,TDDFTYP,CITYP,CCTYP,
     *                MPLEVL,MPCTYP
C
      DATA RHF,UHF,ROHF /8HRHF     ,8HUHF     ,8HROHF    /
      DATA DETS/8HDETS    /
      DATA SFCIS/8HSFCIS   /
C
C     SET UP -CIS- RUN: EVALUATE ENERGY, AND IF REQUIRED 1-E GRADIENT
C
      NBF  = NUM
C
C     --- IT SHOULD NOT BE POSSIBLE TO GET HERE WITH A SUPERMATRIX ---
C     BUT CHECK THAT IT IS NOT, JUST TO BE SAFE.
C
      IF(.NOT.DIRSCF  .AND.  PK) THEN
         WRITE(IW,*) 'WFNCIS: ERROR, A -PK- FILE SHOULD NOT BE USED'
         CALL ABRT
      END IF
C
      DIRTRF = .FALSE.
C
C       NOTHING HAS BEEN DONE TO PERMIT IN-CORE CIS. (PERHAPS IT
C       IS NOT VERY NECESSARY ANYWAY, BUT THEN IT WOULD BE GOOD TO
C       GIVE UP IN-CORE INTEGRAL MEMORY FOR INTEGRAL TRANSFORMATION...)
C
      IF(NINTIC.NE.0.AND..NOT.DIRSCF) THEN
        IF(MASWRK) WRITE(IW,*) 'TURNING OFF IN-CORE INTEGRALS...'
        DIRSCF=.TRUE.
      END IF
C
C        --- POSSIBLY READ GUESS CIS VECTOR FROM INPUT ---
C
      IF(RDCISV) THEN
         NOCA  = NOA - NACORE
         NVIRA = NQMT - NOA
         IF(HAMTYP.EQ.DETS) THEN
            DETRUN = .TRUE.
            NCFG = 2*NOCA*NVIRA
         ELSE
            DETRUN = .FALSE.
            NCFG = NOCA*NVIRA
         END IF
         CALL CISVRD(DETRUN,NCFG,NSTATE)
         NGSVEC = NSTATE
         RDCISV = .FALSE.
      END IF
C
C     --- WILL WE GET EXPECTATION OR RELAXED DENSITY BACK FROM CIS?
C
      CALL DERCHK(NDER)
      EXPDEN = NDER.EQ.0  .AND.  ICISPR.EQ.0
C
C     -CISAO- DOES THE ENERGY, POSSIBLY SOME WORK TO GENERATE THE
C     RELAXED/GENERALIZED DENSITY, AND POSSIBLY SOME GRADIENT SET
C     UP.  CIS GRADIENTS WOULD BE COMPLETED IN -GRADX-, IF NEED BE.
C
C     NOTE ALSO THAT THE NORMAL CI DRIVER LEAVES IT UP TO US TO
C     EVALUATE PROPERTIES FOR CIS HERE, SO WE CAN LABEL THE DENSITY
C     MATRIX EXACTLY CORRECTLY.
C
      IF(SCFTYP.EQ.RHF)  THEN
         CALL CISAO
         E    = ECIS
         ETOT = ECIS
         CALL DAWRIT(IDAF,IODA,ENUCR,MXRT+15,2,0)
         IF(EXPDEN) THEN
            IF(MASWRK) WRITE(IW,9100)
            CALL TIMIT(1)
            PRPTYP='CISE'
         ELSE
            IF(MASWRK) WRITE(IW,9150)
            CALL TIMIT(1)
            PRPTYP='CISR'
         END IF
         CALL PROPTY(PRPTYP)
      END IF
C
C     -SFCISCALC- DOES THE ENERGY, POSSIBLY SOME WORK TO GENERATE THE
C     RELAXED/GENERALIZED DENSITY, AND POSSIBLY SOME GRADIENT SET
C     UP.  SFCIS GRADIENTS WOULD BE COMPLETED IN -GRADX-, IF NEED BE.
C
      IF(SCFTYP.EQ.UHF) THEN
         IF(CITYP.EQ.SFCIS) THEN
            CALL SFCISCALC
         ELSE
            CALL ABRT
         END IF
      END IF
C
      IF(SCFTYP.EQ.ROHF) THEN
         IF(CITYP.EQ.SFCIS) THEN
            CALL SFCISCALC
         ELSE
            CALL ABRT
         END IF
      END IF
C
      RETURN
C
 9100 FORMAT(/1X,'..... DONE WITH CIS ENERGY .....'/)
 9150 FORMAT(/1X,'.... DONE WITH CIS ENERGY + 1-PARTICLE DENSITY ....'/)
      END
C*MODULE GAMESS  *DECK WFNMP2
C>
C> @brief   driver for second-order perturbation theory
C>
C> @details 2nd order PT energy and/or gradient, after SCF level
C>          calculations for RHF, UHF, ROHF, MCSCF but not GVB.
C>
C> @author  Michael W. Schmidt, approximately 1994?
C>
C> @date September 2010 - Albert DeFusco
C> - Add calls to CIM-specific drivers for correlated subsystems
C>
      SUBROUTINE WFNMP2
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      DOUBLE PRECISION IMS,METHODMC
C
      LOGICAL PK,PANDK,BLOCK,DIRSCF,FDIFF,LMOMP2,ABEL,ABELPT,
     *        GOPARR,DSKWRK,MASWRK,GPSAVE,DIRTRF,
     *        DTRFSV,DSCFSV,DSKWSV,EONLY,DDMP,DHFUNC,SECONDD,
     *        CANONC,FCORE,FORS,EKT,LINSER
C
      PARAMETER (MXATM=2000, MXRT=100, MXFRG=1050, MXNORO=250)
C
      COMMON /COMPE2/ E2PARA,E2OPOS
      COMMON /CXTHRM/ CXTHERM(11),CXZPE,METHCX,ICXBAS,ICXPCM,SECONDD
      COMMON /DFTDH / CHF,CMP2,C2S,C2T,DHFUNC
      COMMON /DFTPAR/ DFTTYP(20),EXENA,EXENB,EXENC,IDFT34,NAUXFUN,
     *                                                    NAUXSHL
      COMMON /ENRGMP/ EMP2,EMP3,EMP4,EMP2A
      COMMON /ENRGYS/ ENUCR,EELCT,ETOT,SZ,SZZ,ECORE,ESCF,EERD,E1,E2,
     *                VEN,VEE,EPOT,EKIN,ESTATE(MXRT),STATN,EDFT(2),EDISP
      COMMON /FMCOM / X(1)
      COMMON /FMOINF/ NFG,NLAYER,NATFMO,NBDFG,NAOTYP,NBODY
      COMMON /FMORUN/ ESPSCF,E0SCF(2),EMP2S,IDAFMO,ICURFG,JCURFG,KCURFG,
     *                ICURLAY,ICURUNT,NAT1E,NCURSH,NGAU,ICURPOP,IFMOSTP,
     *                MONCOR,NEEDR,MODRST,NORBPROJ,NUNESP,ISKIPESP,
     *                IESDPPC,IDOPROP,MP2RUN,ICURIT,IDMFMO,IDDFMO,
     *                IDDCUR,NDDLEFT,IVMFMO,nzmtfmo
      COMMON /FUNCT / E,EG(3,MXATM)
      COMMON /INFOA / NAT,ICH,MUL,NUM,NQMT,NE,NA,NB,
     *                ZAN(MXATM),C(3,MXATM),IAN(MXATM)
      COMMON /INT2IC/ NINTIC,ININTIC,NXXIC,LBUFPIC,LIXIC,LABSIX,NINTIX
      COMMON /IOFILE/ IR,IW,IP,IJK,IJKT,IDAF,NAV,IODA(950)
      COMMON /MCINP / METHODMC,CISTEP,FINALCI,ACURCY,ENGTOL,DAMP,
     *                MICIT,NWORD,NORBMC,NOROT(2,MXNORO),MOFRZ(15),
     *                NPFLG(10),NOFO,MCFMO,IDIABAT,
     *                CANONC,FCORE,FORS,EKT,LINSER
      COMMON /MP2LOC/ LMOMP2
      COMMON /MP2PAR/ OSPT,CODEMP,SCSPT,TOL,METHOD,NWDMP2,MEMPRI,MPPROP,
     *                NACORE,NBCORE,NOA,NOB,NORB,NBF,NOMIT,MOCPHF,MAXITC
      COMMON /MRPTIN/ TYPMRMP,INORBMC,MCVEC
      COMMON /OPTSCF/ DIRSCF,FDIFF
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
      COMMON /PCMPAR/ IPCM,NFT26,NFT27,IRPPCM,IEF,IP_F,NFMOPCM
      COMMON /PCMOPT/ RABI,RASC,REFPOL,THRSLS,DENSLS,WB,WA,ETA2,GD,EVAC,
     *                RHOW,PM,AREATL,AREAKP,BONDRY,OMEGA,RET,FRO,EPSINF,
     *                EPS,DR,RSOLV,VMOL,TCE,STEN,DSTEN,CMF,TABS,IDIRCT,
     *                IPCDER,IDP,ICOMP,IFIELD,ICAV,IDISP,IPRINT,IRETCAV,
     *                ICENT,IFAST,NEVAL,IEFPOL,KEEPSM,IMGABI,IMGASC,NADD
      COMMON /PCMTMP/ IDSP(MXATM+MXFRG*5),DPCMFRG(6,MXFRG),
     *                EGPCM(3,MXATM)
      COMMON /PKFIL / PK,PANDK,BLOCK
      COMMON /PRPOPT/ ETOLLZ,ILOCAL,IAHARD
      COMMON /PSILVL/ IPSI,ISKPRP
      COMMON /RUNOPT/ RUNTYP,EXETYP,NEVALS,NGLEVL,NHLEVL
      COMMON /TRFOPT/ CUTTRF,NWDTRF,MPTRAN,ITRFAO,NOSYMT,IPURTF,DIRTRF
      COMMON /WFNOPT/ SCFTYP,VBTYP,DFTYPE,TDDFTYP,CITYP,CCTYP,
     *                MPLEVL,MPCTYP
C
C     COSMO INFORMATION
C
      LOGICAL ISEPS,USEPS
      COMMON /ISEPS / ISEPS, USEPS
      LOGICAL COSBUG,COSWRT,DCOSMO,PRFCND,IOUTCH
      COMMON /COSDAT/ SE2,SECORR,QVCOSMO,ELAST,EMP2COS,EMP2LAST,
     *                COSVOL,COSSAR,EDIEL,EOC1,DEOC_RS,SUMQSC,
     *                SUMQSCOLD,ZSUM,ZSUM2,ZSUM3,FEPSI,RDS,DISEX2,
     *                EPSI,COSRAD,DISEX,OUTCHG,EDIEL_SAVE,
     *                MAXNPS,ICORR,ITRIP,NQS,MP2TRIP,MP2ITER,
     *                ICFREQ,NSPA,NSPH,NPSD,NPS,NPS2,NDEN,NPSPHER,
     *                COSBUG,COSWRT,DCOSMO,PRFCND,IOUTCH
C
C     CHANGE FOR DIVIDE-AND-CONQUER METHOD
C
      LOGICAL DODCCR,ONLYOC,RMKORB,FZCORE,DOMP1,HFFRM
      COMMON /DCCORR/ RBUFCR,WOCC,ISTCOR,ITPART,DODCCR,ONLYOC,RMKORB,
     *                FZCORE,DOMP1,HFFRM
C
      LOGICAL IVOCAS
      COMMON /MROPT / IVOCAS
C
      DATA CHECK/8HCHECK   /
      DATA GRPV /8H $VEC   /
      DATA RHF,UHF,ROHF/8HRHF     ,8HUHF     ,8HROHF    /
      DATA GVB,RMC     /8HGVB     ,8HMCSCF   /
      DATA RMP,ZAPT          /8HRMP     ,8HZAPT    /
      DATA DEMRPT,RMCQD,GVVPT,GMCQDPT
     *    /8HDETMRPT ,8HMCQDPT  ,8HGVVPT   ,8HGMCPT   /
      DATA SERIAL,DDI,IMS,RIMP2,CCHEM
     *    /8HSERIAL  ,8HDDI     ,8HIMS     ,8HRIMP2   ,8HCCHEM   /
      DATA G3MP2/8HG3MP2   /
      DATA RNONE/8HNONE    /
      DATA CIMSUB/8HCIMSUB  /
C
C     ----- DRIVER FOR SECOND ORDER PERTURBATION THEORY -----
C
C     DO ENERGY, DENSITY, AND/OR GRADIENT, IN SERIAL OR PARALLEL,
C     FOR ANY SCFTYP.  NOT ALL METHODS ARE CODED, E.G. GVB HAS NO
C     PERTURBATION THEORY, AND MCSCF HAS NO DENSITY/GRADIENT YET.
C
      IPSI=2
C
      NORB = NQMT
      NBF  = NUM
C
C         POSSIBLE LOCALIZATION FOR ENERGY DECOMPOSITION,
C         AND TURN OFF SO LOCALIZATION ISN'T REPEATED AT JOB END.
C
      IF (LMOMP2) THEN
         CALL LMOX
         ILOCAL=0
      END IF
C
C          SET COSMO MODEL'S MP2 TO LOOK UNCONVERGED ON FIRST PASS
      IF (ISEPS) MP2ITER=1
C
C        AT PRESENT, NO MCSCF+MPLEVL RUN CAN GENERATE A DENSITY MATRIX
C
      IF (SCFTYP.EQ.RMC) MPPROP=0
C
C     --- IT SHOULD NOT BE POSSIBLE TO GET HERE WITH A SUPERMATRIX ---
C     BUT CHECK THAT IT IS NOT, JUST TO BE SAFE.
C
      IF(.NOT.DIRSCF  .AND.  PK) THEN
         WRITE(IW,*) 'WFNMP2: ERROR, A -PK- FILE SHOULD NOT BE USED'
         CALL ABRT
      END IF
C
      IF(NINTIC.NE.0.AND.(.NOT.DIRTRF.OR..NOT.DIRSCF)) THEN
C       ACTUALLY SOME SEQUENTIAL MP2 WORKS WITH IN-CORE (DEPENDING ON
C       AVAILABLE MEMORY).
C       IF(MASWRK) WRITE(IW,*) 'IN-CORE MP2 IS NOT FINISHED YET.'
        IF(MASWRK) WRITE(IW,*) 'TURNING OFF IN-CORE INTEGRALS...'
        DIRSCF=.TRUE.
        DIRTRF=.TRUE.
C---    CALL ABRT
      END IF
C
C     ----- TEST FOR ENERGY ONLY, OR ANALYTIC DERIVATIVE NEEDED -----
C     DENSITY OF FIRST ORDER WAVEFUNCTION IS NEEDED FOR PROPERTIES,
C     AND OBTAINING IT REQUIRES RUNNING PART OF THE GRADIENT CODE.
C
      CALL DERCHK(NDER)
      IF(RUNTYP.EQ.G3MP2) THEN
         IF(ICXBAS.EQ.1) NDER=1
         IF(ICXBAS.EQ.2) NDER=0
      END IF
      EONLY = NDER.EQ.0  .OR.  NGLEVL.EQ.1  .OR.  NHLEVL.EQ.2
      IF(MPPROP.NE.0) EONLY=.FALSE.
C
C     CHECK FOR DISTRIBUTED DATA PARALLEL MP2, AND DDI SUPPORT
C
C        WE HAVE SERIAL CODE FOR RHF + MP2 ENERGY OR GRADIENT
C                                UHF + MP2 ENERGY OR GRADIENT
C                             ROHF + ZAPT2 ENERGY
C                             ROHF +  RMP2 ENERGY
C                            MCSCF + MRPT2 ENERGY
C      WE HAVE PARALLEL CODE FOR RHF + MP2 ENERGY OR GRADIENT
C                                UHF + MP2 ENERGY OR GRADIENT
C                             ROHF + ZAPT2 ENERGY OR GRADIENT
C                             ROHF +  RMP2 ENERGY (REPLICATED MEMORY)
C                            MCSCF + MRMP2 ENERGY
C
      DDMP=.FALSE.
      IF(GOPARR  .AND.
     *  (SCFTYP.EQ.RHF  .OR.  SCFTYP.EQ.UHF  .OR.
     *  (SCFTYP.EQ.ROHF.AND.OSPT.EQ.ZAPT.AND.     EONLY))) DDMP=.TRUE.
      IF(SCFTYP.EQ.ROHF.AND.OSPT.EQ.ZAPT.AND..NOT.EONLY)   DDMP=.TRUE.
      IF(DODCCR) DDMP=.FALSE.
C
      CALL DDI_LEVEL(IMPLEMENTATION)
      IF(IMPLEMENTATION.EQ.0  .AND.  DDMP) THEN
         IF(MASWRK) WRITE(IW,*) 'YOUR MACHINE LACKS -DDI- SUPPORT'
         CALL ABRT
      END IF
      IF(DDMP) GO TO 3
C
C        --- APPARENTLY WE ARE RUNNING A SERIAL MP2 PROGRAM ---
C        A C1 INTEGRAL LIST IS NEEDED IF THE GROUP IS NOT ABELIAN
C
C        JAN, 2006:
C           IN PARALLEL, THIS IS USED ONLY BY ROHF/RMP ENERGY RUNS.
C           FOR ANCIENT MP2 PARALLELIZATION:
C           THE INTEGRALS MUST BE REGENERATED IF A DUPLICATED AO
C           INTEGRAL FILE IS BEING USED (OLD PARALLELIZATION)
C
      ABEL = ABELPT()
      IF(.NOT.ABEL  .OR.
     *  (GOPARR .AND. ITRFAO.EQ.1  .AND.  SCFTYP.NE.RMC)) THEN
         IF(.NOT.DIRSCF) THEN
            GPSAVE = GOPARR
            IF(ITRFAO.EQ.1) GOPARR=.FALSE.
            IF(.NOT.ABEL  .AND.  MASWRK) WRITE(IW,9210)
            IF(.NOT.ABEL) CALL SYMOFF
            CALL JANDK
            IF(.NOT.ABEL) CALL SYMON
            GOPARR = GPSAVE
         END IF
      END IF
C
    3 CONTINUE
C
C     ==== CARRY OUT 2ND ORDER PERTURBATION FOR EACH SCF REFERENCE ====
C
C     IF ONLY THE ENERGY W/O DENSITY OR GRADIENT IS DESIRED, THERE
C     MAY BE SPECIALIZED ROUTINES FOR THAT.  ALSO, THE SERIAL CODE MAY
C     BE SEPARATE FROM A (PROBABLY) DISTRIBUTED MEMORY PARALLEL CODE.
C
C     THE CALLS FOR GRADIENT (OR JUST DENSITY MATRIX) SHOULD EVALUATE
C     THE 2ND ORDER ENERGY, DO ENOUGH INTEGRAL TRANSFORMING TO DO
C     RESPONSES, FINISH THE RESPONSES AND GENERATE DENSITY MATRICES,
C     BUT DO NOT INCLUDE NONSEPARABLE DM2 BACKTRANSFORMS OR INTEGRAL
C     DERIVATIVES, WHICH MUST BE DONE LATER.
C
      IF(SCFTYP.EQ.RHF)  THEN
         IF(EONLY) THEN
            IF(IVOCAS) THEN
               CALL MCQDPT(RMCQD,GRPV)
C                     DIVIDE-AND-CONQUER MP2 RUNS
            ELSE IF (DODCCR) THEN
               CALL MP2DC
C                     STANDARD CLOSED SHELL MP2
            ELSE
               IF(CODEMP.EQ.DDI)    CALL MP2DDI
               IF(CODEMP.EQ.SERIAL) THEN
                  IF (RUNTYP.EQ.CIMSUB) THEN
                     CALL MP2NRG_CIM
                  ELSE
                     CALL MP2NRG
                  ENDIF
               ENDIF
               IF(CODEMP.EQ.IMS)    CALL MP2IMS
               IF(CODEMP.EQ.CCHEM)  CALL MP2CCHEM
               IF(CODEMP.EQ.RIMP2)  CALL RIMP2DRIVER
            ENDIF
C
            IF(MASWRK) WRITE(IW,9100)
            CALL TIMIT(1)
         ELSE
            IF(CODEMP.EQ.DDI) THEN
               CALL MP2DDI
               IF(MASWRK) WRITE(IW,9100)
               CALL TIMIT(1)
            END IF
            IF(CODEMP.EQ.SERIAL) THEN
               CALL MP2GE2
               IF(MASWRK) WRITE(IW,9100)
               CALL TIMIT(1)
               CALL MP2GRD
            END IF
            IF(CODEMP.EQ.IMS) THEN
               CALL MP2GRDIMS
               IF(IPCM.EQ.1.OR.NFMOPCM.GT.0) THEN
                  IF(IPCDER.EQ.2.OR.IPCDER.EQ.3) THEN
                     CALL DAREAD(IDAF,IODA,EG,3*NAT,3,0)
                     DO IAT = 1, NAT
                        DO IXYZ = 1, 3
                           EG(IXYZ,IAT) = EG(IXYZ,IAT)
     *                                  + EGPCM(IXYZ,IAT)
                        END DO
                     END DO
                     CALL DAWRIT(IDAF,IODA,EG,3*NAT,3,0)
                  END IF
               END IF
               IF(MASWRK) WRITE(IW,9100)
               CALL TIMIT(1)
            END IF
         END IF
      END IF
C
      IF(SCFTYP.EQ.UHF) THEN
         IF(EONLY) THEN
            IF(CODEMP.EQ.DDI) THEN
               CALL MP2DDI
               IF(MASWRK) WRITE(IW,9100)
               CALL TIMIT(1)
            END IF
            IF(CODEMP.EQ.SERIAL) THEN
               CALL UMP2EN
               IF(MASWRK) WRITE(IW,9100)
               CALL TIMIT(1)
            END IF
            IF(CODEMP.EQ.RIMP2) THEN
               CALL RIMP2DRIVER
               IF(MASWRK) WRITE(IW,9100)
               CALL TIMIT(1)
            END IF
         ELSE
            IF(CODEMP.EQ.SERIAL) THEN
               CALL UMPGE2
               IF(MASWRK) WRITE(IW,9100)
               CALL TIMIT(1)
               CALL UMPGRD
            END IF
            IF(CODEMP.EQ.DDI) THEN
               CALL MP2DDI
               IF(MASWRK) WRITE(IW,9100)
               CALL TIMIT(1)
            END IF
         END IF
      END IF
C
C     --- SELECT FROM 2 KINDS OF HIGH SPIN, OPEN SHELL PERT. THEORY ---
C
      IF(SCFTYP.EQ.ROHF) THEN
C
C                 THE RMP THEORY LACKS GRADIENTS, AND WE USE AN OLD
C                 STYLE PARALLELIZATION INSIDE THE SERIAL UMP CODE.
         IF(OSPT.EQ.RMP) THEN
            IF(EONLY) THEN
               CALL UMP2EN
               IF(MASWRK) WRITE(IW,9100)
               CALL TIMIT(1)
            ELSE
               IF(MASWRK) WRITE(IW,*) 'RMP GRADIENT CODE DOES NOT EXIST'
               CALL ABRT
            END IF
         END IF
C
C                 THE ZAPT THEORY HAS PARALLEL AND SERIAL ENERGY CODE.
C                 THE ZAPT THEORY GRADIENT HAS ONLY DDI PARALLEL CODE.
C                 CHECK RUNS UNSET GOPARR BY CALLING SYSINP INSIDE
C                 MP2DDI, SO FORCE ZAPT GRADIENTS TO BE PARALLEL TWICE.
         IF(OSPT.EQ.ZAPT) THEN
            IF(EONLY) THEN
               IF(CODEMP.EQ.SERIAL) THEN
                  CALL ZAPTEN
                  IF(MASWRK) WRITE(IW,9100)
                  CALL TIMIT(1)
               END IF
               IF(CODEMP.EQ.DDI) THEN
                  CALL MP2DDI
                  IF(MASWRK) WRITE(IW,9100)
                  CALL TIMIT(1)
               ENDIF
            ELSE
               GOPARR = .TRUE.
               CALL MP2DDI
               IF(MASWRK) WRITE(IW,9100)
               CALL TIMIT(1)
               GOPARR = .TRUE.
            END IF
         END IF
      END IF
C
C     --- JUST A MARKER TO MAKE IT CLEAR GVB + PT2 IS IMPOSSIBLE ---
C     INPUT SCANNERS SHOULD HAVE PREVENTED US FROM EVER GETTING HERE.
C
      IF(SCFTYP.EQ.GVB) THEN
         IF(MASWRK) WRITE(IW,*) 'NO GVB+MP2, TRY MCSCF REFERENCE'
         CALL ABRT
      END IF
C
C     --- SELECT FROM 3 KINDS OF MULTIREFERENCE PERTURBATION THEORY ---
C     THERE'S NO GRADIENT OR DENSITY MATRIX CODE AT THE PRESENT TIME.
C
      IF(SCFTYP.EQ.RMC) THEN
         IF(EONLY) THEN
C
C     --- QUASIDEGENERATE MULTIREFERENCE PERTURBATION THEORY ---
C               THIS IS A DETERMINANT BASED PROGRAM
C
            IF (TYPMRMP.EQ.DEMRPT) THEN
               CALL MRPT
            END IF
C
C     --- QUASIDEGENERATE MULTIREFERENCE PERTURBATION THEORY ---
C               THIS IS A GUGA CSF BASED PROGRAM
C     THIS PROGRAM HAS SPIN-ORBIT PERTURBATION AS A SUB-OPTION.
C     THIS PROGRAM HAS REFERENCE WEIGHT COMPUTATION AS AN OPTION.
C
C     NOTE THAT PARALLEL FULLNR MAY HAVE FORCED A DIRECT TRANSFORMATION,
C     SO NOW THE MCQDPT MAY NEED AN AO INTEGRAL FILE ON EACH NODE.
C
            IF(TYPMRMP.EQ.RMCQD) THEN
               DTRFSV = DIRTRF
               DSCFSV = DIRSCF
               IF(DIRTRF  .OR.  DIRSCF) THEN
                  DIRTRF = .FALSE.
                  DIRSCF = .FALSE.
                  IF(MASWRK) WRITE(IW,9040)
                  DSKWSV = DSKWRK
                  DSKWRK = .TRUE.
                  CALL SEQOPN(IJK,'AOINTS','UNKNOWN',.FALSE.,
     *                        'UNFORMATTED')
                  GPSAVE = GOPARR
                  GOPARR = .FALSE.
                  IF(.NOT.ABEL) CALL SYMOFF
                  CALL JANDK
                  IF(.NOT.ABEL) CALL SYMON
                  GOPARR = GPSAVE
                  DSKWRK = DSKWSV
               END IF
               CALL MCQDPT(RMCQD,GRPV)
               IF(DTRFSV  .OR.  DSCFSV) THEN
                  DIRTRF = DTRFSV
                  DIRSCF = DSCFSV
               END IF
            END IF
C
C     --- GENERALIZED VAN VLECK MULTIREFERENCE PERTURBATION THEORY ---
C
            IF(TYPMRMP.EQ.GVVPT) THEN
               CALL GVVPT2M
            END IF
C
C     --- MC-QDPT WITH GENERAL MC REFERENCE FUNCTIONS (GMC-QDPT)
C
            IF(TYPMRMP.EQ.GMCQDPT) THEN
               CALL GMCPT
            END IF
C
            IF(MASWRK) WRITE(IW,9100)
            CALL TIMIT(1)
C
C                  possible diabatization of the PT2 "states"
C
            IF(IDIABAT.NE.0) CALL DIABATX(1)
C
         ELSE
            IF(MASWRK) WRITE(IW,*)
     *           'MCSCF+MP2 GRADIENT CODE DOES NOT EXIST'
            CALL ABRT
         END IF
      END IF  ! END MRPT TYPE SELECTION
      IF(NFG.NE.0) THEN
        EMP2=EMP2+EMP2S
      ENDIF
C
C        STORE ENERGY (ALL ORDINARY 2ND ORDER PT METHODS)
C
      IF(DFTYPE.EQ.RNONE) THEN
         E   =EMP2
         ETOT=EMP2
         CALL DAWRIT(IDAF,IODA,ENUCR,MXRT+15,2,0)
C
C     --- WAVE FUNCTION PROPERTIES FOR MP2 RELAXED DENSITY MATRIX ---
C     PRECISELY SPEAKING, THIS IS THE 1ST ORDER WAVEFUNCTION'S DENSITY
C
         IF(EONLY  .OR.  (ISEPS  .AND.  MP2ITER.EQ.1)) THEN
            CONTINUE
         ELSE
            CALL PROPTY('MP2 ')
         END IF
C
C        STORE ENERGY (DOUBLE HYBRID METHODS, WHICH MIX IN DFT ENERGY)
C        DOUBLE HYBRID DOES NOT PERMIT ANY PROPERTY EVALUATION.
C
      ELSE
C
C IF SOMEONE WILL IMPLEMENT SCS-MP2 FOR OPEN SHELL,
C THE NEXT SECTION COULD BE IN PRINCIPLE ELIMINATED, PROVIDING
C THE CORRECT CHANGES - RIGHT NOW, THE ONLY DOUBLE HYBRID THAT
C CAN DO OPEN SHELL CALCULATIONS IS B2PLYP
C (IT DOES NOT USE SCS-MP2)
C
         IF(SCFTYP.EQ.UHF) THEN
            IF(DFTTYP(3).EQ.1.0D0) THEN
               WRITE(IW,*)
               WRITE(IW,*)'ERROR! WB97X-2 IS NOT AVAILABLE FOR UHF'
               WRITE(IW,*)
               CALL ABRT
            ELSE
               E2SS = 0.5D+00 * E2
               E2OS = 0.5D+00 * E2
            END IF
         ELSE
            E2SS = E2OPOS
            E2OS = E2PARA
         END IF
C
C IN THE B2PLYP CASE C2S = C2T IN DFTXCA, THEREFORE THIS FORMULA
C IS THE SAME AS THE CORRECT B2PLYP FORMULA:
C        EMP2 = ESCF + C2S * E2
C
         EMP2 = ESCF + C2S*E2SS + C2T*E2OS
         IF(MASWRK) THEN
            WRITE(IW,9310)
            IF(DFTTYP(3).EQ.1.0D0) THEN
               WRITE(IW,9320) ESCF, E2SS*C2S, C2S, E2OS*C2T,
     *                        C2T, C2S*E2SS+C2T*E2OS, EMP2
            ELSE
               WRITE(IW,9330) ESCF, DFTTYP(3), E2SS*C2S, C2S, E2OS*C2T,
     *                        C2T, C2S*E2SS+C2T*E2OS, EMP2
            END IF
         END IF
      END IF
C
C          RESTORE ROHF CANONICAL ORBITALS AFTER RMP STYLE MP2
C
      IF(SCFTYP.EQ.ROHF .AND.  OSPT.EQ.RMP .AND. EXETYP.NE.CHECK) THEN
         L3 = NUM*NUM
         CALL VALFM(LOADFM)
         LV   = LOADFM + 1
         LAST = LV     + L3
         NEED = LAST - LOADFM -1
         CALL GETFM(NEED)
         CALL DAREAD(IDAF,IODA,X(LV),L3,61,0)
         CALL DAWRIT(IDAF,IODA,X(LV),L3,15,0)
         CALL RETFM(NEED)
      END IF
C
C     COSMO MP2 ITERATION
C
      IF(ISEPS) THEN
         IF (MASWRK) THEN
           WRITE(IW,*)
           WRITE(IW,*)"    ---------------------------------"
           WRITE(IW,*)"    CONVERGENCE WITHIN MP2 ITERATIONS"
           WRITE(IW,*)"    ---------------------------------"
           WRITE(IW,*)
         END IF
         CHKMP2=ABS(EMP2LAST-EMP2)
         IF (MASWRK) WRITE(IW,9580) EMP2,EMP2LAST,CHKMP2
         EMP2LAST=EMP2
C
         IF(CHKMP2.GT.1.0D-05) THEN
            MP2ITER=1
            ICORR=1
         ELSE
            MP2ITER=0
            EMP2LAST=0.0D+00
            IF (MASWRK) THEN
              WRITE(IW,*)
              WRITE(IW,*)"    CONVERGENCE WITHIN MP2 ACHIEVED"
              WRITE(IW,*)
            END IF
            CALL COSOCE(ETOT)
         END IF
C
C        MP2ITER=1 NEEDS A CALL TO PJKDMP2 FOR CODE=DDI TO FREE
C        ALLOCATED MEMORY.
C
         IF(MPPROP.EQ.1 .OR. MP2ITER.EQ.1) THEN
           IF(CODEMP.EQ.DDI.OR.OSPT.EQ.ZAPT
     *       .AND. NDER.GT.0) CALL PJKDMP2
           IF(COSBUG) WRITE(IW,9590) MPPROP,MP2ITER,ICORR
         END IF
      END IF
C
      RETURN
C
 9100 FORMAT(1X,'..... DONE WITH MP2 ENERGY .....')
 9040 FORMAT(/1X,'MCQDPT CANNOT RUN AO INTEGRAL DIRECT, SO',
     *          '  DIRTRF/DIRSCF WILL BE IGNORED.')
 9210 FORMAT(/1X,'REGENERATING AO INTEGRALS W/O SYMMETRY FOR',
     *           ' THIS NON-ABELIAN POINT GROUP...')
C
 9310 FORMAT(/5X,'THE E(MP2) ENERGY ABOVE IS A REGULAR FULL MP2'/
     *        5X,'THE DOUBLE HYBRID RESULTS ARE SHOWN BELOW:'/)
 9320 FORMAT(20X,'                    E(DFT)= ',1F20.10/
     *       20X,'    SCALED SAME SPIN E(2S)= ',1F20.10/
     *       20X,'      E(2S) SCALING FACTOR= ',1F20.6/
     *       20X,'SCALED OPPOSITE SPIN E(2T)= ',1F20.10/
     *       20X,'      E(2T) SCALING FACTOR= ',1F20.6/
     *       20X,'         TOTAL SCALED E(2)= ',1F20.10/
     *       47X,'---------------------',/
     *       20X,'FINAL DOUBLE HYBRID ENERGY= ',1F20.10)

 9330 FORMAT(20X,'                    E(DFT)= ',1F20.10/
     *       20X,'         HF SCALING FACTOR= ',1F20.6/
     *       20X,'    SCALED SAME SPIN E(2S)= ',1F20.10/
     *       20X,'      E(2S) SCALING FACTOR= ',1F20.6/
     *       20X,'SCALED OPPOSITE SPIN E(2T)= ',1F20.10/
     *       20X,'      E(2T) SCALING FACTOR= ',1F20.6/
     *       20X,'         TOTAL SCALED E(2)= ',1F20.10/
     *       47X,'---------------------',/
     *       20X,'FINAL DOUBLE HYBRID ENERGY= ',1F20.10)
C
 9580 FORMAT(6X,'E(MP2)        =',F20.10/
     *       6X,'E(MP2-LAST)   =',F20.10/
     *       6X,'DELTA-E       =',F20.10/)
 9590 FORMAT(1X,'WFNMP2: COSMO PARAMS MPPROP=',I3,' MP2ITER=',I3,
     *          ' ICORR=',I3)
      END
C
C*MODULE GAMESS  *DECK WFNTDDFT
      SUBROUTINE WFNTDDFT
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      LOGICAL TRIPLET,NONEQ,DIRSCF,FDIFF,GOPARR,DSKWRK,MASWRK,
     *        LCFLAG,LRINT,SG1,SG1T,CAMFLAG,TAMMD,TPA
C
      PARAMETER (MXATM=2000, MXSH=5000, MXRT=100, MXFRG=1050,
     *           MXDFG=5, MXDPPT=MXFRG*MXDFG*12)
C
      PARAMETER (MXGRID=10, MXGRIDTYP=10)
C
      COMMON /DFTCAM/ ALPHAC,BETAC,CAMMU,CAMVWN,CAMLYP,CAMFLAG
      COMMON /DFGRID/ DFTTHR,DFTGTHR,SWOFF,SW0,BSLRD(137),NDFTFG,
     *                NRAD,NTHE,NPHI,NRAD0,NTHE0,NPHI0,
     *                NANGPT(MXGRID),NANGPT0(MXGRID),SG1,JANS
      COMMON /DFLEB/  NLEB(MXGRID),NLEB0(MXGRID)
      COMMON /DFPRUN/ PRUNERADS(MXGRID,MXGRIDTYP),
     *                PRUNEATOMS(2,MXGRIDTYP),
     *                IPRUNECUTS(MXATM),NTOTGRIDPOINTS(MXATM),
     *                NGRIDS,MAXANG,NGRIDTYPS
      COMMON /ENRGYS/ ENUCR,EELCT,ETOT,SZ,SZZ,ECORE,ESCF,EERD,E1,E2,
     *                VEN,VEE,EPOT,EKIN,ESTATE(MXRT),STATN,EDFT(2),EDISP
      COMMON /FRGINF/ NMPTS(MXFRG),NMTTPT,IEFC,IEFD,IEFQ,IEFO,
     *                NPPTS(MXFRG),NPTTPT,IEFP,
     *                NRPTS(MXFRG),NRTTPT,IREP,ICHGP,NFRG,
     *                NDPPTS(MXDPPT),NDPTTPT,IEFDP,LSTMPTS(MXFRG),
     *                NBSFN(MXFRG),NMXMO(MXFRG)
      COMMON /INFGRD/ RHOMIN,ILENG,MAXGRD
      COMMON /INFOEX/ TDM(3,MXRT),MOCC(MXRT),MVIR(MXRT),
     *                MONOC1,MONVR1,IFMODIM
      COMMON /INFOTD/ CNVTOL,TRIPLET,SG1T,JANST,NRADT,NTHET,NPHIT,NLEBT,
     *                NSTAT,NTRIAL,MAXVEC,NTHST,IRECTD,ITDFG,NONEQR,
     *                ITDPRP,TAMMD,TPA
      COMMON /IOFILE/ IR,IW,IP,IJK,IJKT,IDAF,NAV,IODA(950)
      COMMON /NLRC  / LCFLAG,LRINT,EMU,EMU2,LRFILE
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
      COMMON /PCMPAR/ IPCM,NFT26,NFT27,IRPPCM,IEF,IP_F,NFMOPCM
      COMMON /PCMOPT/ RABI,RASC,REFPOL,THRSLS,DENSLS,WB,WA,ETA2,GD,EVAC,
     *                RHOW,PM,AREATL,AREAKP,BONDRY,OMEGA,RET,FRO,EPSINF,
     *                EPS,DR,RSOLV,VMOL,TCE,STEN,DSTEN,CMF,TABS,IDIRCT,
     *                IPCDER,IDP,ICOMP,IFIELD,ICAV,IDISP,IPRINT,IRETCAV,
     *                ICENT,IFAST,NEVAL,IEFPOL,KEEPSM,IMGABI,IMGASC,NADD
      COMMON /RUNOPT/ RUNTYP,EXETYP,NEVALS,NGLEVL,NHLEVL
      COMMON /SYMTRY/ MAPSHL(MXSH,48),MAPCTR(MXATM,48),
     *                T(432),INVT(48),NT
      COMMON /OPTSCF/ DIRSCF,FDIFF
      COMMON /WFNOPT/ SCFTYP,VBTYP,DFTYPE,TDDFTYP,CITYP,CCTYP,
     *                MPLEVL,MPCTYP
C
      DATA RHF/8HRHF     /
      DATA UHF  /8HUHF     /
      DATA ROHF /8HROHF    /
      DATA RNONE/8HNONE    /,ATDDFT/8HTDDFT   /,ATDHF/8HTDHF    /
      DATA EXCITE,SPNFLP/8HEXCITE  ,8HSPNFLP  /
      DATA ASFDFT/8HSFDFT   /
C
C     TDDFT EXCITATION ENERGY AND OSCILLATOR STRENGTH CALCULATION
C
C     WRITTEN BY MAHITO CHIBA
C     NATIONAL INSTITUTE OF ADVANCED INDUSTRIAL SCIENCE AND TECHNOLOGY
C     (AIST), JAPAN.
C
C        ----- DRIVER FOR TD-DFT COMPUTATIONS -----
C
      TDTYP=ATDDFT
      IF(TDDFTYP.EQ.RNONE) TDTYP=ATDHF
      IF(TDDFTYP.EQ.SPNFLP) TDTYP=ASFDFT
C
      IF(MASWRK) THEN
         IF(LCFLAG) THEN
            WRITE(IW,8000) TDTYP,SCFTYP,EMU
         ELSEIF(CAMFLAG) THEN
            WRITE(IW,8010) TDTYP,SCFTYP,ALPHAC,BETAC,EMU
         ELSE
            WRITE(IW,7000) TDTYP,SCFTYP
         END IF
         IF(SCFTYP.EQ.RHF) THEN
            WRITE(IW,9000)
            IF(CAMFLAG) WRITE(IW,9015)
         ELSE
            IF(TDDFTYP.EQ.EXCITE) THEN
               WRITE(IW,9010)
            ELSE IF(TDDFTYP.EQ.SPNFLP) THEN
               WRITE(IW,9011)
            END IF
         END IF
         IF(NFRG.GT.0 .AND. IPCM.EQ.1) WRITE(IW,9020)
      ENDIF
C
C        PROGRAMMED ONLY WITH A GRID (FORCED HERE FOR CHECK RUNS)
C
      IF(DFTYPE.NE.RNONE) NDFTFG = 1
C
C       --- TURN OFF INTEGRAL SYMMETRY FOR TDDFT ITERS ---
C     THE POINT GROUP SYMMETRY SHOULD BE TURNED BACK ON,
C     ONCE THE TDDFT ITERATIONS HAVE CONVERGED, SO THAT THE
C     SYMMETRY LABELS FOR THE EXCITATIONS CAN BE PRINTED.
C
      IF(NT.GT.1) THEN
         CALL SYMOFF
         IF(DIRSCF) THEN
            IF(MASWRK) WRITE(IW,1100) TDTYP
         ELSE
            IF(MASWRK) WRITE(IW,1110) TDTYP
            IF(LCFLAG.OR.CAMFLAG) THEN
               LRINT=.TRUE.
               CALL JANDK
               LRINT=.FALSE.
            ENDIF
            CALL JANDK
         END IF
         CALL SYMON
      END IF
C
C        ----- CHANGE GRID SIZE FOR TDDFT
C
      NRADS=NRAD
      NTHES=NTHE
      NPHIS=NPHI
      NLEBS=NLEB(1)
      NRAD=NRADT
      NTHE=NTHET
      NPHI=NPHIT
      NLEB(1)=NLEBT
C
C     --- DEFINE MAXGRD, W/O EXPLOITING ANY GRID SYMMETRY
C     TDHF NOW NEEDS A GRID TO COMPUTE THE LAMBDA DIAGNOSTIC, SO
C     ALWAYS CREATE IT.  NOTE THAT GROUND STATE GRID IS NOT CREATED!
C
C---  IF(NDFTFG.EQ.1) THEN
         CALL SYMOFF
         CALL MEMGRD
         CALL SYMON
C---  END IF
C
      NONEQ=.TRUE.
      IF(NONEQR.EQ.0) NONEQ=.FALSE.
      IF(MASWRK) THEN
         WRITE(IW,*) ' '
         WRITE(IW,*) '-TDDFT RUNTIME PARAMETERS-'
         WRITE(IW,*) '   TRIPLET  =',TRIPLET
         WRITE(IW,*) '   NONEQ    =',NONEQ
         WRITE(IW,*) '   NSTATE   =',NSTAT
         WRITE(IW,*) '   IROOT    =',NTHST
         WRITE(IW,*) '   NTRIAL   =',NTRIAL
         WRITE(IW,*) '   MAXVEC   =',MAXVEC
         IF(NDFTFG.EQ.1) THEN
            WRITE(IW,*) '   ILENG    =',ILENG
            WRITE(IW,*) '   MAXGRD   =',MAXGRD
            IF(SG1) THEN
               WRITE(IW,*)'   USING THE SG-1 PRUNED GRIDS'
            ELSE
               IF(NLEB(1).NE.0) THEN
                  WRITE(IW,*)'   NRAD     =',NRAD
                  WRITE(IW,*)'   NLEB     =',MAXANG
               ELSE
                  WRITE(IW,*)'   NRAD     =',NRAD
                  WRITE(IW,*)'   NTHE     =',NTHE
                  WRITE(IW,*)'   NPHI     =',NPHI
               ENDIF
            ENDIF
         ENDIF
C               PRINT DATA ON SOLVATION MODEL
         IF(IPCM.EQ.1.OR.NFMOPCM.GT.0) THEN
            IF(NONEQR.EQ.1) THEN
               WRITE(IW,9050) EPS,EPSINF
            ELSE
               WRITE(IW,9060) EPS
            ENDIF
         ELSE IF(NFRG.GT.0) THEN
            WRITE(IW,*) 'SOLVENT SPECTRUM MODELED BY TDDFT/EFP'
         ELSE
            WRITE(IW,*) 'COMPUTING GAS PHASE SPECTRUM'
         ENDIF
         WRITE(IW,*) ' '
         NRADPTS=NRAD
         IF(DFTYPE.NE.RNONE) CALL CHKRGRID(NRADPTS)
         WRITE(IW,*) ' '
      ENDIF
C
C     --- GET ENERGIES FOR TDDFT EXCITED STATES
C     NOTE THAT SYMMETRY IS TURNED OFF AGAIN, INSIDE THE FOLLOWING.
C
      ITDFG=1
      IF (SCFTYP.EQ.RHF)  CALL  TDDFTCALC
      IF (SCFTYP.EQ.UHF) THEN
         IF(TDDFTYP.EQ.EXCITE) THEN
            CALL UTDDFTCALC
         ELSE IF(TDDFTYP.EQ.SPNFLP) THEN
            CALL SFDFTCALC
         END IF
      END IF
      IF (SCFTYP.EQ.ROHF) THEN
         IF(TDDFTYP.EQ.EXCITE) THEN
            CALL UTDDFTCALC
         ELSE IF(TDDFTYP.EQ.SPNFLP) THEN
            CALL SFDFTCALC
         END IF
      END IF
      ITDFG=0
C
      NRAD=NRADS
      NTHE=NTHES
      NPHI=NPHIS
      NLEB(1)=NLEBS
C
      IF(GOPARR) THEN
         CALL DDI_BCAST(2428,'F',ETOT,1,MASTER)
         CALL DDI_BCAST(2428,'F',ESTATE,MXRT,MASTER)
         CALL DDI_BCAST(2428,'F',TDM,MXRT,MASTER)
         CALL DDI_BCAST(2428,'I',MOCC,MXRT,MASTER)
         CALL DDI_BCAST(2428,'I',MVIR,MXRT,MASTER)
      ENDIF
C
C        IF THE RUN IS DOING AN ANALYTIC GRADIENT, WE NEED TO
C        GENERATE RESPONSES, DENSITY QUANTITIES, AND PROPERTIES.
C        THIS CALL DOES -NOT- DO THE NUCLEAR DERIVATIVE INTEGRALS!
C
      ITDFG=1
      CALL DERCHK(NDER)
      IF((NDER.GT.0  .AND.  NGLEVL.EQ.0)  .OR.  ITDPRP.EQ.1) THEN
         IF(TDDFTYP.EQ.EXCITE) CALL TDGRAD
      END IF
      ITDFG=0
      RETURN
C
 1100 FORMAT(/1X,'SWITCHING OFF POINT GROUP SYMMETRY DURING DIRECT ',
     *           A5,' ITERATIONS')
 1110 FORMAT(/1X,'REGENERATING AO INTEGRAL LIST IN C1 SYMMETRY FOR ',
     *           A5,' ITERATIONS...')
 7000 FORMAT(/1X,71(1H-)/
     *  20X,A5,' CALCULATION FOR SCFTYP=',A4)
 8000 FORMAT(/1X,71(1H-)/
     *  17X,'LC-',A5,' CALCULATION FOR SCFTYP=',A4/
     *  22X,'WITH LC-PARAMETER MU = ',F4.2/
     *  9X,'Y. TAWADA, T. TSUNEDA, S. YANAGISAWA, T. YANAI, K. HIRAO,'/
     *  18X,'J. CHEM. PHYS. 120 (2004) 8425-8433.'/)
 8010 FORMAT(/1X,71(1H-)/
     *  17X,'CAM-',A5,' CALCULATION FOR SCFTYP=',A4/
     *  12X,'WITH CAM-PARAMETERS ALPHA = ',F4.2,' BETA = ',F4.2,
     *  ' MU = ',F4.2/
     *  9X,'Y. TAWADA, T. TSUNEDA, S. YANAGISAWA, T. YANAI, K. HIRAO,'/
     *  18X,'J. CHEM. PHYS. 120 (2004) 8425-8433.'/
     *  19X,'T. YANAI, D. P. TEW, N. C. HANDY,'/
     *  19X,'CHEM. PHYS. LETT. 393 (2004) 51.'/)
 9000 FORMAT(26X,'CODED BY MAHITO CHIBA'/
     *   1X,'NATIONAL INSTITUTE OF ADVANCED INDUSTRIAL SCIENCE AND',
     *      ' TECHNOLOGY, JAPAN'/
     *       1X,71(1H-))
 9010 FORMAT(26X,'CODED BY SOOHAENG YOO'/
     *       1X,71(1H-))
 9011 FORMAT(26X,'CODED BY NORIYUKI MINEZAWA'/
     *       1X,71(1H-))
 9015 FORMAT(26X,'AND BY KIET A. NGUYEN'/
     *       1X,71(1H-))
 9020 FORMAT(
     *  13X,'QM/MM(POL)/CONTINUUM STYLE TD-DFT CALCULATION'/
     *  13X,'       NANDUN THELLAMUREGE AND HUI LI'/
     *  13X,'       UNIVERSITY OF NEBRASKA-LINCOLN'/
     *       1X,71(1H-)/)
 9050 FORMAT(1X,'SOLVENT SPECTRUM MODELED BY NON-EQUILIBRIUM TDDFT/PCM'/
     *       1X,'EPS=',F8.3,' EPSINF=',F8.3)
 9060 FORMAT(1X,'SOLVENT SPECTRUM MODELED BY EQUILIBRIUM TDDFT/PCM'/
     *       1X,'EPS=',F8.3)
      END
C
C*MODULE GAMESS  *DECK TRIVIA
C
C        THIS IS A STAND-ALONE CODE, NOT INCLUDED WITH GAMESS.
C
      SUBROUTINE GVVPT2M
      WRITE(6,*) 'PRESENTLY THE GVVPT2 PROGRAM IS DELETED'
      RETURN
      END
