#!/bin/csh
#
#       a "backend" script, run in the COBALT batch queue at Argonne.
#       see also the "front end" script named gms.
#
# COBALT_JOBSIZE is number of nodes
#
set JOB=$1
set VERNO=$2
set FMO=$3
set MODE=$4 
set DDI_NODES=$5 
set USERSCR=/projects/bulk_properties_dd14/spruitt/scr
set GMSDIR=/projects/bulk_properties_dd14/spruitt/gms-spencer
#
set RANKS = 1
@ RANKS = $MODE * $COBALT_JOBSIZE
#
set ERIC=/projects/bulk_properties_dd14/fletcher/gamess/ericfmt.dat
#
mkdir $USERSCR/$JOB.$COBALT_JOBID
mv $USERSCR/$JOB.F05  $USERSCR/$JOB.$COBALT_JOBID
set SCR=$USERSCR/$JOB.$COBALT_JOBID
#
set FMO=0
if ($FMO == 1) then
    set JOBTMP=/tmp/JOB
else
    set JOBTMP=$SCR/$JOB
endif
#
set RMTMP=/projects/bulk_properties_dd14/fletcher/gamess/rmtmpfiles
#
set ENVS="BG_SHAREDMEMSIZE=32MB PAMID_VERBOSE=1 DDI_LOGICAL_NODE_SIZE=$DDI_NODES OUTPUT=$JOBTMP.F06 TRAJECT=$SCR/$JOB.trj ERICFMT=$ERIC IRCDATA=$SCR/$JOB.irc INPUT=$SCR/$JOB.F05 PUNCH=$JOBTMP.dat RESTART=$SCR/$JOB.rst EXTBAS=$SCR/$JOB.bas AOINTS=$SCR/$JOB.F08 MOINTS=$SCR/$JOB.F09 DICTNRY=$SCR/$JOB.F10 DRTFILE=$SCR/$JOB.F11 CIVECTR=$SCR/$JOB.F12 CASINTS=$SCR/$JOB.F13 CIINTS=$SCR/$JOB.F14 WORK15=$SCR/$JOB.F15 WORK16=$SCR/$JOB.F16 CSFSAVE=$SCR/$JOB.F17 FOCKDER=$SCR/$JOB.F18 WORK19=$SCR/$JOB.F19 DASORT=$SCR/$JOB.F20 DFTINTS=$SCR/$JOB.F21 DFTGRID=$SCR/$JOB.F22 JKFILE=$SCR/$JOB.F23 ORDINT=$SCR/$JOB.F24 EFPIND=$SCR/$JOB.F25 PCMDATA=$SCR/$JOB.F26 PCMINTS=$SCR/$JOB.F27 SVPWRK1=$SCR/$JOB.F26 SVPWRK2=$SCR/$JOB.F27 MLTPL=$SCR/$JOB.F28 MLTPLT=$SCR/$JOB.F29 DAFL30=$SCR/$JOB.F30 SOINTX=$SCR/$JOB.F31 SOINTY=$SCR/$JOB.F32 SOINTZ=$SCR/$JOB.F33 SORESC=$SCR/$JOB.F34 SIMEN=$SCR/$JOB.simen SIMCOR=$SCR/$JOB.simcor GCILIST=$SCR/$JOB.F37 HESSIAN=$SCR/$JOB.F38 SOCCDAT=$JOBTMP.F40 AABB41=$SCR/$JOB.F41 BBAA42=$SCR/$JOB.F42 BBBB43=$SCR/$JOB.F43 MCQD50=$SCR/$JOB.F50 MCQD51=$SCR/$JOB.F51 MCQD52=$SCR/$JOB.F52 MCQD53=$SCR/$JOB.F53 MCQD54=$SCR/$JOB.F54 MCQD55=$SCR/$JOB.F55 MCQD56=$SCR/$JOB.F56 MCQD57=$SCR/$JOB.F57 MCQD58=$SCR/$JOB.F58 MCQD59=$SCR/$JOB.F59 MCQD60=$SCR/$JOB.F60 MCQD61=$SCR/$JOB.F61 MCQD62=$SCR/$JOB.F62 MCQD63=$SCR/$JOB.F63 MCQD64=$SCR/$JOB.F64 NMRINT1=$SCR/$JOB.F61 NMRINT2=$SCR/$JOB.F62 NMRINT3=$SCR/$JOB.F63 NMRINT4=$SCR/$JOB.F64 NMRINT5=$SCR/$JOB.F65 NMRINT6=$SCR/$JOB.F66 DCPHFH2=$SCR/$JOB.F67 DCPHF21=$SCR/$JOB.F68 BG_MAPPING=XYZT SHIP_TMP=1"
#
echo "Environmental variable list: $ENVS"
#
if ($FMO == 1) then
echo "Cleaning up /tmp on nodes prior to GAMESS calculation..."
    runjob -p 1 --np $COBALT_JOBSIZE --block $COBALT_PARTNAME --verbose=INFO : $RMTMP
#
    runjob -p $MODE --np $RANKS --block $COBALT_PARTNAME --verbose=INFO --envs $ENVS : $GMSDIR/gamess.$VERNO.x
echo "Cleaning up /tmp on nodes after GAMESS calculation..."
    runjob -p 1 --np $COBALT_JOBSIZE --block $COBALT_PARTNAME --verbose=INFO : $RMTMP
else
    if ($FMO == 0) then
	runjob -p $MODE --np $RANKS --block $COBALT_PARTNAME --verbose=INFO --envs $ENVS : $GMSDIR/gamess.$VERNO.x
    endif
endif
#
sleep 2
#
rm $USERSCR/$JOB.script
rm $USERSCR/$JOB.cobaltlog
mv $USERSCR/$JOB.error $SCR
#
sleep 2
#
exit
