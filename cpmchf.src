C 11 Aug 11 - NM  - NACMEX,CPMCX: SA-MCSCF grad and conical intersect.
C 11 Aug 10 - DGF - SYNCH COMMON BLOCK ENRGYS
C  1 May 09 - SK  - check basis set is spd only
C 23 Oct 08 - TJD - fixed state index problem in FMNAC (NACME runs)
C 11 Apr 08 - MWS - implement a run type of NACME
C  4 Mar 08 - TJD - changes for NACME and SA-MCSCF gradient computation
C 24 Mar 06 - MWS - JCPOVR: file 18 processed only by master
C 22 Sep 06 - TJD - soup up runs with large active space, add ORMAS
C 10 Jul 06 - MWS - CHECK runs should not DDI_DESTROY
C 13 Mar 06 - TJD - soup up runs with many filled orbitals
C 17 Jan 06 - MWS - use new DDI transf common TRFDMS
C 14 Nov 05 - DGF - pad common block ENRGYS
C 19 Sep 05 - MWS - add true nuclear charge array to INFOA common
C  5 Jul 05 - MWS - SELECT NEW ATOM,BASIS,EFP,PCM,DAF DIMENSIONS
C 13 feb 05 - MWS - pad common block NSHEL
C 07 Sep 04 - MWS - pad common block INTFIL
C 23 Jul 04 - TJD - MCCPCG: carry on if nearly cvgd., or not pos.def.
C 20 Apr 04 - TJD - improve execution speed and parallel scalability
C 19 Feb 04 - TJD - fix right hand sides, and again excited states
C 16 Jan 04 - TJD - fix nact2/norb dimensioning, and excited states
C  9 Dec 03 - TJD - SOLVE CPMCHF EQUATIONS FOR ANALYTIC MCSCF HESSIANS
C
C*MODULE CPMCHF  *DECK ADVNCP
C     ---------------------------------------------
      SUBROUTINE ADVNCP(CON,NELE,NORB)
C     ---------------------------------------------
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      INTEGER CON(*)
C
C     This routine is the same as ADVANC in ALDECI
C
      IF (CON(NELE).EQ.NORB) THEN
         DO 50 I=NELE-1,1,-1
            IF (CON(I+1)-CON(I).GT.1) THEN
               CON(I) = CON(I) + 1
               DO 40 J=I+1,NELE
                  CON(J) = CON(J-1) + 1
   40          CONTINUE
               RETURN
            ENDIF
   50    CONTINUE
      ENDIF
C
      CON(NELE) = CON(NELE)+1
C
      RETURN
      END
C*MODULE CPMCHF  *DECK CPDRD2
      SUBROUTINE CPDRD2(WAXCI,PRCNDC,CI,DFC,DERI,FCOR,ERI,INDEX,IACON1,
     *                  IACON2,IMMA,IMMC,ISPA,ISPB,ISYMA,ISYMB,ITAB,IOX,
     *                  IMUL,IPOSA,IPERA,IIND1,IBCON1,ISAS,ISBS,ISAC,
     *                  ISBC,ISTART,ISTRB,ISTRP,IFA,NINDX,NDETLN,NACT,
     *                  NCOR,NA,NB,NALP,NBLP,NSYM,NXYZ,L1,NNACT,JLO,JHI,
     *                  NCI,NSTATS)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      INTEGER POSDET
C
      DIMENSION WAXCI(NXYZ,NSTATS*NDETLN),PRCNDC(*),CI(*),DFC(*),
     *          DERI(*),FCOR(*),ERI(L1,NACT,NNACT)
      DIMENSION INDEX(NINDX,NINDX),IACON1(NA),IACON2(NA),
     *          IMMA(NSYM,(NA*(NACT-NA))),IMMC(NSYM),ISPA(NALP),
     *          ISPB(NBLP),ISYMA(NALP),ISYMB(NBLP),ITAB(NSYM),IOX(NACT),
     *          IMUL(NSYM,NSYM),IPOSA(NA*(NACT-NA)),IPERA(NA*(NACT-NA)),
     *          IIND1(NA*(NACT-NA)),IBCON1(NA),ISAS(NSYM+1),
     *          ISBS(NSYM+1),ISAC(NALP),ISBC(NBLP),ISTART(NBLP),
     *          ISTRB((NBLP*(NB*(NACT-NB)))/2),
     *          ISTRP((NBLP*(NB*(NACT-NB)))/2),
     *          IFA(0:NACT,0:NACT)
C
      ICONST = 1
      IZERO = 0
C
      DO 7 I=1,NINDX
         DO 8 J=1,I
            INDEX(I,J) = I*(I-1)/2 + J
            INDEX(J,I) = INDEX(I,J)
    8    CONTINUE
    7 CONTINUE
C
      DO 30 I=1,NA
         IACON1(I) = I
   30 CONTINUE
C
C     ----- Big Loop over all alpha determinants -----
C
      DO 9000 IJK = 1,NALP
C
C          ----- Alpha excitations here -----
C          -----      Single first      -----
C
         IAC = 0
         DO 45 II=1,NSYM
            IMMC(II) = 0
   45    CONTINUE
         ICAT = ISPA(IJK)
         ISA1 = ISYMA(IJK)
         ITAS = ITAB(ISA1)
         DO 7030 IA=1,NA
             IO1 = IACON1(IA)
             IS1 = IOX(IO1)
             IST = IO1 + 1
             IEN = IACON1(IA+1)-1
             IF (IA.EQ.NA) IEN=NACT
             DO 7025 KKJ=IA+1,NA+1
                DO 7020 JJ=IST,IEN
                IS2 = IOX(JJ)
                IP1 = IMUL(IS2,IS1)
C
             IAC = IAC + 1
             CALL RET1DET(IACON1,IACON2,NA,IA,JJ,IZERO,KKJ,IPER1)
C
C          ----- Storage here for later use, well worth it -----
C
             IPET = POSDET(NACT,NA,IACON2,IFA)
             IPOSA(IAC) = ISPA(IPET)
             IMMC(ISYMA(IPET)) = IMMC(ISYMA(IPET)) + 1
             IMMA(ISYMA(IPET),IMMC(ISYMA(IPET))) = IAC
             IPERA(IAC) = ((-1)**IPER1)*ICONST
             IND = INDEX(JJ,IO1)
             IIND1(IAC) = IND
C
             IF(IS1.NE.IS2) GO TO 417
C
         DO 49 I=1,NB
            IBCON1(I) = I
   49    CONTINUE
C
C          ----- Loop over beta dets of the right symmetry -----
C
                   IJ = (IND-1)*NXYZ + 1
                   DO 407 INBB = ISBS(ISA1),ISBS(ISA1+1)-1
                   INB1 = ISBC(INBB)
                   ICIT = ICAT+ISPB(INB1)
                   ICI2 = IPOSA(IAC) + ISPB(INB1)
C
                   IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                     DO ISTAT=1,NSTATS
                       NCI2 = (ISTAT-1)*NCI + ICI2
                       FC = CI(NCI2)*IPERA(IAC)
                       IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                       CALL DAXPY(NXYZ,FC,DFC(IJ),1,WAXCI(1,IWIT),1)
                     ENDDO
                   ENDIF
C
                   IF(ICI2.GE.JLO .AND. ICI2.LE.JHI) THEN
                     DO ISTAT=1,NSTATS
                       NCIT = (ISTAT-1)*NCI + ICIT
                       FC = CI(NCIT)*IPERA(IAC)
                       IWI2 = (ISTAT-1)*NDETLN + ICI2 - JLO + 1
                       CALL DAXPY(NXYZ,FC,DFC(IJ),1,WAXCI(1,IWI2),1)
                     ENDDO
                   ENDIF
  407          CONTINUE
C
                   DO 487 IK=1,NA
                      IF (IK.EQ.IA) GOTO 487
                      ION = IACON1(IK)
                      J1 = INDEX(ION,ION)
                      JJ1 = INDEX(IND,J1)
                      J2 = INDEX(ION,JJ)
                      J3 = INDEX(ION,IO1)
                      INX = INDEX(J2,J3)
C
                      IJKL = (JJ1-1)*NXYZ + 1
                      ILKJ = (INX-1)*NXYZ + 1
                   DO 413 INBB=ISBS(ISA1),ISBS(ISA1+1)-1
                      INB1 = ISBC(INBB)
                      ICIT = ICAT+ISPB(INB1)
                      ICI2 = IPOSA(IAC)+ISPB(INB1)
C
                      IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                        DO ISTAT=1,NSTATS
                          NCI2 = (ISTAT-1)*NCI + ICI2
                          FC = CI(NCI2)*IPERA(IAC)
                          IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                          CALL DAXPY(NXYZ,FC,DERI(IJKL),1,
     *                               WAXCI(1,IWIT),1)
                          CALL DAXPY(NXYZ,-FC,DERI(ILKJ),1,
     *                               WAXCI(1,IWIT),1)
                        ENDDO
                      ENDIF
C
                      IF(ICI2.GE.JLO .AND. ICI2.LE.JHI) THEN
                        DO ISTAT=1,NSTATS
                          NCIT = (ISTAT-1)*NCI + ICIT
                          FC = CI(NCIT)*IPERA(IAC)
                          IWI2 = (ISTAT-1)*NDETLN + ICI2 - JLO + 1
                          CALL DAXPY(NXYZ,FC,DERI(IJKL),1,
     *                               WAXCI(1,IWI2),1)
                          CALL DAXPY(NXYZ,-FC,DERI(ILKJ),1,
     *                               WAXCI(1,IWI2),1)
                        ENDDO
                      ENDIF
  413              CONTINUE
C
  487              CONTINUE
C
                  NST = 1
                  DO 415 INBB = ISBS(ISA1),ISBS(ISA1+1)-1
                  NEND = ISBC(INBB)
                  DO 5510 KK=NST,NEND-1
                     CALL ADVANC(IBCON1,NB,NACT)
 5510             CONTINUE
                  ICIT = ICAT+ISPB(NEND)
                  ICI2 = IPOSA(IAC)+ISPB(NEND)
C
                     DO 790 IK=1,NB
                      ION = IBCON1(IK)
                      J1 = INDEX(ION,ION)
                      JJ1 = INDEX(IND,J1)
C
                      IJKL = (JJ1-1)*NXYZ + 1
C
                      IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                        DO ISTAT=1,NSTATS
                          NCI2 = (ISTAT-1)*NCI + ICI2
                          FC = CI(NCI2)*IPERA(IAC)
                          IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                          CALL DAXPY(NXYZ,FC,DERI(IJKL),1,
     *                               WAXCI(1,IWIT),1)
                        ENDDO
                      ENDIF
C
                      IF(ICI2.GE.JLO .AND. ICI2.LE.JHI) THEN
                        DO ISTAT=1,NSTATS
                          NCIT = (ISTAT-1)*NCI + ICIT
                          FC = CI(NCIT)*IPERA(IAC)
                          IWI2 = (ISTAT-1)*NDETLN + ICI2 - JLO + 1
                          CALL DAXPY(NXYZ,FC,DERI(IJKL),1,
     *                               WAXCI(1,IWI2),1)
                        ENDDO
                      ENDIF
  790              CONTINUE
C
          NST = NEND
  415     CONTINUE
C
  417     CONTINUE
C
C          ----- Double excitations -----
C
          DO 4015 IAA = IA+1,NA
             IPA = IAA
             IIA = IACON1(IAA)
             IS3 = IOX(IIA)
             IF (JJ.GT.IIA) IPA = IPA - 1
             ISTAA = JJ+1
             IENAA = IEN
             DO 4010 KKJAA=KKJ,NA+1
                DO 4005 JJAA=ISTAA,IENAA
                IS4 = IOX(JJAA)
                IP2 = IMUL(IS4,IS3)
                IF (IP1.NE.IP2) GOTO 4005
C
             CALL RET1DET(IACON2,IBCON1,NA,IPA,JJAA,IZERO,KKJAA,IPER2)
             IPET = POSDET(NACT,NA,IBCON1,IFA)
             ICA1 = ISPA(IPET)
             IPERT = IPER1+IPER2
             IPERT = ((-1)**IPERT)*ICONST
                   I2 = INDEX(IACON1(IAA),JJAA)
                   INX = INDEX(I2,IND)
                   II1 = INDEX(JJAA,IO1)
                   II2 = INDEX(IACON1(IAA),JJ)
                   INX2 = INDEX(II1,II2)
C
                   IJKL = (INX-1)*NXYZ + 1
                   ILKJ = (INX2-1)*NXYZ + 1
                DO 786 INB1 = ISBS(ISA1),ISBS(ISA1+1)-1
                   NEND = ISBC(INB1)
                   ICI2 = ICA1 + ISPB(NEND)
                   ICIT = ICAT+ISPB(NEND)
C
                   IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                     DO ISTAT=1,NSTATS
                       NCI2 = (ISTAT-1)*NCI + ICI2
                       FC = CI(NCI2)*IPERT
                       IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                       CALL DAXPY(NXYZ,FC,DERI(IJKL),1,WAXCI(1,IWIT),1)
                       CALL DAXPY(NXYZ,-FC,DERI(ILKJ),1,WAXCI(1,IWIT),1)
                     ENDDO
                   ENDIF
C
                   IF(ICI2.GE.JLO .AND. ICI2.LE.JHI) THEN
                     DO ISTAT=1,NSTATS
                       NCIT = (ISTAT-1)*NCI + ICIT
                       FC = CI(NCIT)*IPERT
                       IWI2 = (ISTAT-1)*NDETLN + ICI2 - JLO + 1
                       CALL DAXPY(NXYZ,FC,DERI(IJKL),1,WAXCI(1,IWI2),1)
                       CALL DAXPY(NXYZ,-FC,DERI(ILKJ),1,WAXCI(1,IWI2),1)
                     ENDDO
                   ENDIF
  786       CONTINUE
C
 4005           CONTINUE
                ISTAA = IACON1(KKJAA)+1
                IENAA = IACON1(KKJAA+1)-1
                IF (KKJAA.EQ.NA) IENAA=NACT
 4010        CONTINUE
 4015 CONTINUE
C
C
 7020           CONTINUE
                IST = IACON1(KKJ)+1
                IEN = IACON1(KKJ+1)-1
                IF (KKJ.EQ.NA) IEN=NACT
 7025        CONTINUE
 7030     CONTINUE
C
C          ----- Diagonal -----
C
            DO 67 II=1,NA
               I1 = IACON1(II)
               IND1 = INDEX(I1,I1)
C
               IJ1 = INDEX(I1+NCOR,I1+NCOR)
               IJ2 = (IND1-1)*NXYZ + 1
              DO 53 INB1 = ISBS(ISA1),ISBS(ISA1+1)-1
              NEND = ISBC(INB1)
              ICIT = ICAT+ISPB(NEND)
C
              IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                DO ISTAT=1,NSTATS
                  NCIT = (ISTAT-1)*NCI + ICIT
                  FC = CI(NCIT)
                  IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                  CALL DAXPY(NXYZ,FC,DFC(IJ2),1,WAXCI(1,IWIT),1)
                  PRCNDC(IWIT) = PRCNDC(IWIT) + FCOR(IJ1)
                ENDDO
              ENDIF
   53         CONTINUE
C
               DO 64 JJ=II+1,NA
                  I2 = IACON1(JJ)
                  IND2 = INDEX(I2,I2)
                  INDM = IND2 - I2 + I1
                  J1 = INDEX(INDM,INDM)
                  J2 = INDEX(IND2,IND1)
C
                  IIKK = (J2-1)*NXYZ + 1
                  IKIK = (J1-1)*NXYZ + 1
               DO 55 INB1 = ISBS(ISA1),ISBS(ISA1+1)-1
                  NEND = ISBC(INB1)
                  ICIT = ICAT+ISPB(NEND)
C
                  IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      NCIT = (ISTAT-1)*NCI + ICIT
                      FC = CI(NCIT)
                      IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                      CALL DAXPY(NXYZ,FC,DERI(IIKK),1,WAXCI(1,IWIT),1)
                      CALL DAXPY(NXYZ,-FC,DERI(IKIK),1,WAXCI(1,IWIT),1)
                      DVAL = ERI(I1+NCOR,I1,IND2) - ERI(I1+NCOR,I2,INDM)
                      PRCNDC(IWIT) = PRCNDC(IWIT) + DVAL
                    ENDDO
                  ENDIF
   55          CONTINUE
C
   64          CONTINUE
C
         DO 47 I=1,NB
            IBCON1(I) = I
   47    CONTINUE
C
             NST = 1
             DO 56 INB1 = ISBS(ISA1),ISBS(ISA1+1)-1
             NEND = ISBC(INB1)
             DO 7710 KK=NST,NEND-1
                CALL ADVANC(IBCON1,NB,NACT)
 7710        CONTINUE
             ICIT = ICAT+ISPB(NEND)
C
               DO 68 JJ=1,NB
                  I2 = IBCON1(JJ)
                  IND2 = INDEX(I2,I2)
                  J2 = INDEX(IND1,IND2)
C
                  IIKK = (J2-1)*NXYZ + 1
                  FC = CI(ICIT)
                  IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      NCIT = (ISTAT-1)*NCI + ICIT
                      FC = CI(NCIT)
                      IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                      CALL DAXPY(NXYZ,FC,DERI(IIKK),1,WAXCI(1,IWIT),1)
                      PRCNDC(IWIT) = PRCNDC(IWIT) + ERI(I1+NCOR,I1,IND2)
                    ENDDO
                  ENDIF
   68          CONTINUE
C
            NST = NEND
   56       CONTINUE
C
   67       CONTINUE
C
C          ----- Loop over Beta dets now -----
C
         DO 40 II=1,NB
            IBCON1(II) = II
   40    CONTINUE
         JJZ = 1
C        ELSE
C        DO 41 II=1,NB
C           IBCON1(II) = IACON1(II)
C  41    CONTINUE
C        JJZ = IJK
C        ENDIF
C
         DO 8000 KJI = JJZ,NBLP
         ISTAR = ISTART(KJI)-1
         IPB1 = ISPB(KJI)
         ISB1 = ISYMB(KJI)
         ITBS = ITAB(ISB1)
         IMZZ = IMMC(ITBS)
         M1 = 0
         M2 = 0
         IF (ISB1.EQ.ITAS) M1 = 1
         IF (IMZZ.NE.0) M2 = 1
         IF (M1.EQ.0.AND.M2.EQ.0) GOTO 7998
         QNUM = 1.0D+00
         IC1 = ICAT + IPB1
C
C          ----- Beta first *********************** Single -----
C
          DO 900 IB=1,NB
             IBB = IBCON1(IB)
             IB1 = IOX(IBB)
             IR1 = IMUL(IB1,ISB1)
             IST = IBB+1
             IEN = IBCON1(IB+1)-1
             IF (IB.EQ.NB) IEN = NACT
             DO 895 KKJ=IB+1,NB+1
                DO 890 JJ=IST,IEN
                IB2 = IOX(JJ)
                ISB2 = IMUL(IR1,IB2)
                ITB2 = ITAB(ISB2)
                ISTAR = ISTAR + 1
                IF (ISB2.NE.ITAS.AND.M1.EQ.0) GOTO 890
                IF (M2.EQ.0.AND.IMMC(ITB2).EQ.0) GOTO 890
                IF (ISB2.NE.ITAS.AND.IMMC(ITB2).EQ.0) GOTO 890
C
                   IPB2 = ISTRB(ISTAR)
                   IC2 = ICAT + IPB2
                   ZPERB = ISTRP(ISTAR)/QNUM
                   IOB = INDEX(IBB,JJ)
C
            IF (M2.EQ.0.AND.IMMC(ITB2).NE.0) THEN
               DO 1013 IAT = 1,IMMC(ITB2)
                  IJU = IMMA(ITB2,IAT)
                  IC4 = IPOSA(IJU) + IPB2
                  IND = IIND1(IJU)
                  IX = INDEX(IND,IOB)
C
                  IJKL = (IX-1)*NXYZ + 1
C
                  IF(IC4.GE.JLO .AND. IC4.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      NIC1 = (ISTAT-1)*NCI + IC1
                      FC = CI(NIC1)*IPERA(IJU)*ZPERB
                      IW4 = (ISTAT-1)*NDETLN + IC4 - JLO + 1
                      CALL DAXPY(NXYZ,FC,DERI(IJKL),1,WAXCI(1,IW4),1)
                    ENDDO
                  ENDIF
C
                  IF(IC1.GE.JLO .AND. IC1.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      NIC4 = (ISTAT-1)*NCI + IC4
                      FC = CI(NIC4)*IPERA(IJU)*ZPERB
                      IW1 = (ISTAT-1)*NDETLN + IC1 - JLO + 1
                      CALL DAXPY(NXYZ,FC,DERI(IJKL),1,WAXCI(1,IW1),1)
                    ENDDO
                  ENDIF
 1013          CONTINUE
               GOTO 890
          ENDIF
C
            IF (M1.EQ.0.AND.ISB2.EQ.ITAS) THEN
               DO 2013 IAT =1,IMMC(ITBS)
                  IJU = IMMA(ITBS,IAT)
                  IC3 = IPOSA(IJU) + IPB1
                  IND = IIND1(IJU)
                  IX = INDEX(IND,IOB)
C
                  IJKL = (IX-1)*NXYZ + 1
C
                  IF(IC3.GE.JLO .AND. IC3.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      NIC2 = (ISTAT-1)*NCI + IC2
                      FC = CI(NIC2)*IPERA(IJU)*ZPERB
                      IW3 = (ISTAT-1)*NDETLN + IC3 - JLO + 1
                      CALL DAXPY(NXYZ,FC,DERI(IJKL),1,WAXCI(1,IW3),1)
                    ENDDO
                  ENDIF
C
                  IF(IC2.GE.JLO .AND. IC2.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      NIC3 = (ISTAT-1)*NCI + IC3
                      FC = CI(NIC3)*IPERA(IJU)*ZPERB
                      IW2 = (ISTAT-1)*NDETLN + IC2 - JLO + 1
                      CALL DAXPY(NXYZ,FC,DERI(IJKL),1,WAXCI(1,IW2),1)
                    ENDDO
                  ENDIF
 2013          CONTINUE
               GOTO 890
            ENDIF
C
            IF (ISB2.NE.ITAS.AND.IMMC(ITB2).NE.0) THEN
               DO 3013 IAT = 1,IMMC(ITB2)
                  IJU = IMMA(ITB2,IAT)
                  IC4 = IPOSA(IJU) + IPB2
                  IND = IIND1(IJU)
                  IX = INDEX(IND,IOB)
C
                  IJKL = (IX-1)*NXYZ + 1
C
                  IF(IC4.GE.JLO .AND. IC4.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      NIC1 = (ISTAT-1)*NCI + IC1
                      FC = CI(NIC1)*IPERA(IJU)*ZPERB
                      IW4 = (ISTAT-1)*NDETLN + IC4 - JLO + 1
                      CALL DAXPY(NXYZ,FC,DERI(IJKL),1,WAXCI(1,IW4),1)
                    ENDDO
                  ENDIF
C
                  IF(IC1.GE.JLO .AND. IC1.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      NIC4 = (ISTAT-1)*NCI + IC4
                      FC = CI(NIC4)*IPERA(IJU)*ZPERB
                      IW1 = (ISTAT-1)*NDETLN + IC1 - JLO + 1
                      CALL DAXPY(NXYZ,FC,DERI(IJKL),1,WAXCI(1,IW1),1)
                    ENDDO
                  ENDIF
 3013          CONTINUE
               GOTO 890
            ENDIF
C
            IF (IMMC(ITB2).EQ.0.AND.ISB2.EQ.ITAS) THEN
               DO 4013 IAT =1,IMMC(ITBS)
                  IJU = IMMA(ITBS,IAT)
                  IC3 = IPOSA(IJU) + IPB1
                  IND = IIND1(IJU)
                  IX = INDEX(IND,IOB)
C
                  IJKL = (IX-1)*NXYZ + 1
C
                  IF(IC3.GE.JLO .AND. IC3.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      NIC2 = (ISTAT-1)*NCI + IC2
                      FC = CI(NIC2)*IPERA(IJU)*ZPERB
                      IW3 = (ISTAT-1)*NDETLN + IC3 - JLO + 1
                      CALL DAXPY(NXYZ,FC,DERI(IJKL),1,WAXCI(1,IW3),1)
                    ENDDO
                  ENDIF
C
                  IF(IC2.GE.JLO .AND. IC2.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      NIC3 = (ISTAT-1)*NCI + IC3
                      FC = CI(NIC3)*IPERA(IJU)*ZPERB
                      IW2 = (ISTAT-1)*NDETLN + IC2 - JLO + 1
                      CALL DAXPY(NXYZ,FC,DERI(IJKL),1,WAXCI(1,IW2),1)
                    ENDDO
                  ENDIF
 4013          CONTINUE
               GOTO 890
            ENDIF
C
            IF (IMMC(ITB2).NE.0.AND.ISB2.EQ.ITAS) THEN
               DO 5013 IAT=1,IMMC(ITB2)
                  IJU = IMMA(ITB2,IAT)
                  IC3 = IPOSA(IJU) + IPB1
                  IC4 = IPOSA(IJU) + IPB2
                  IND = IIND1(IJU)
                  IX = INDEX(IND,IOB)
C
                  IJKL = (IX-1)*NXYZ + 1
C
                  IF(IC4.GE.JLO .AND. IC4.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      NIC1 = (ISTAT-1)*NCI + IC1
                      FC = CI(NIC1)*IPERA(IJU)*ZPERB
                      IW4 = (ISTAT-1)*NDETLN + IC4 - JLO + 1
                      CALL DAXPY(NXYZ,FC,DERI(IJKL),1,WAXCI(1,IW4),1)
                    ENDDO
                  ENDIF
C
                  IF(IC1.GE.JLO .AND. IC1.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      NIC4 = (ISTAT-1)*NCI + IC4
                      FC = CI(NIC4)*IPERA(IJU)*ZPERB
                      IW1 = (ISTAT-1)*NDETLN + IC1 - JLO + 1
                      CALL DAXPY(NXYZ,FC,DERI(IJKL),1,WAXCI(1,IW1),1)
                    ENDDO
                  ENDIF
C
                  IF(IC3.GE.JLO .AND. IC3.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      NIC2 = (ISTAT-1)*NCI + IC2
                      FC = CI(NIC2)*IPERA(IJU)*ZPERB
                      IW3 = (ISTAT-1)*NDETLN + IC3 - JLO + 1
                      CALL DAXPY(NXYZ,FC,DERI(IJKL),1,WAXCI(1,IW3),1)
                    ENDDO
                  ENDIF
C
                  IF(IC2.GE.JLO .AND. IC2.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      NIC3 = (ISTAT-1)*NCI + IC3
                      FC = CI(NIC3)*IPERA(IJU)*ZPERB
                      IW2 = (ISTAT-1)*NDETLN + IC2 - JLO + 1
                      CALL DAXPY(NXYZ,FC,DERI(IJKL),1,WAXCI(1,IW2),1)
                    ENDDO
                  ENDIF
 5013          CONTINUE
               GOTO 890
            ENDIF
C
  890           CONTINUE
                IST = IBCON1(KKJ)+1
                IEN = IBCON1(KKJ+1)-1
                IF (KKJ.EQ.NB) IEN=NACT
  895        CONTINUE
  900     CONTINUE
C
 7998     CONTINUE
           CALL ADVANC(IBCON1,NB,NACT)
 8000    CONTINUE
      CALL ADVANC(IACON1,NA,NACT)
 9000 CONTINUE
C
C          ----- Now for the Beta part -----
C
C
      DO 876 JJI=1,NB
         IBCON1(JJI) = JJI
  876 CONTINUE
C
      DO 9999 IJK = 1,NBLP
         ICAB = ISPB(IJK)
         ISB1 = ISYMB(IJK)
C
      DO 6030 IB=1,NB
         IST = IBCON1(IB)+1
         IEN = IBCON1(IB+1)-1
         IF (IB.EQ.NB) IEN=NACT
         IO1 = IBCON1(IB)
         IS1 = IOX(IO1)
         DO 6025 KKJ=IB+1,NB+1
            DO 6020 JJ=IST,IEN
            IS2 = IOX(JJ)
            IP1 = IMUL(IS2,IS1)
C
            CALL RET1DET(IBCON1,IACON2,NB,IB,JJ,IZERO,KKJ,IPER1)
C           IPER = ((-1)**IPER1)*2
            IPER = ((-1)**IPER1)
            IND = INDEX(JJ,IO1)
            IF (IS1.NE.IS2) GOTO 517
            IPB1 = POSDET(NACT,NB,IACON2,IFA)
            IPB1 = ISPB(IPB1)
C
       DO 89 I=1,NA
          IACON1(I) = I
   89 CONTINUE
C
C          ----- Loop over alpha -----
C
             IJ = (IND-1)*NXYZ + 1
          DO 907 INA1 = ISAS(ISB1),ISAS(ISB1+1)-1
             ICIA = ISAC(INA1)
             ICIT = ISPA(ICIA) + ICAB
             ICI2 = ISPA(ICIA) + IPB1
C
             IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
               DO ISTAT=1,NSTATS
                 NCI2 = (ISTAT-1)*NCI + ICI2
                 FC = CI(NCI2)*IPER
                 IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                 CALL DAXPY(NXYZ,FC,DFC(IJ),1,WAXCI(1,IWIT),1)
               ENDDO
             ENDIF
C
             IF(ICI2.GE.JLO .AND. ICI2.LE.JHI) THEN
               DO ISTAT=1,NSTATS
                 NCIT = (ISTAT-1)*NCI + ICIT
                 FC = CI(NCIT)*IPER
                 IWI2 = (ISTAT-1)*NDETLN + ICI2 - JLO + 1
                 CALL DAXPY(NXYZ,FC,DFC(IJ),1,WAXCI(1,IWI2),1)
               ENDDO
             ENDIF
  907     CONTINUE
C
             DO 687 IK=1,NB
                IF (IK.EQ.IB) GOTO 687
                ION = IBCON1(IK)
                J1 = INDEX(ION,ION)
                JJ1 = INDEX(IND,J1)
                J1 = INDEX(ION,JJ)
                J2 = INDEX(ION,IO1)
                INX = INDEX(J1,J2)
C
                IJKL = (JJ1-1)*NXYZ + 1
                ILKJ = (INX-1)*NXYZ + 1
           DO 918 INA1 = ISAS(ISB1),ISAS(ISB1+1)-1
               ICIA = ISAC(INA1)
               ICIT = ISPA(ICIA) + ICAB
               ICI2 = ISPA(ICIA) + IPB1
C
               IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                 DO ISTAT=1,NSTATS
                   NCI2 = (ISTAT-1)*NCI + ICI2
                   FC = CI(NCI2)*IPER
                   IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                   CALL DAXPY(NXYZ,FC,DERI(IJKL),1,WAXCI(1,IWIT),1)
                   CALL DAXPY(NXYZ,-FC,DERI(ILKJ),1,WAXCI(1,IWIT),1)
                 ENDDO
               ENDIF
C
               IF(ICI2.GE.JLO .AND. ICI2.LE.JHI) THEN
                 DO ISTAT=1,NSTATS
                   NCIT = (ISTAT-1)*NCI + ICIT
                   FC = CI(NCIT)*IPER
                   IWI2 = (ISTAT-1)*NDETLN + ICI2 - JLO + 1
                   CALL DAXPY(NXYZ,FC,DERI(IJKL),1,WAXCI(1,IWI2),1)
                   CALL DAXPY(NXYZ,-FC,DERI(ILKJ),1,WAXCI(1,IWI2),1)
                 ENDDO
               ENDIF
  918      CONTINUE
C
  687        CONTINUE
C
            NST = 1
            DO 920 INA1 = ISAS(ISB1),ISAS(ISB1+1)-1
            NEND = ISAC(INA1)
            DO 8810 KK=NST,NEND-1
               CALL ADVANC(IACON1,NA,NACT)
 8810       CONTINUE
            ICIA = ISPA(NEND)
            ICIT = ICIA + ICAB
            ICI2 = ICIA  + IPB1
C
             DO 690 IK=1,NA
                ION = IACON1(IK)
                J1 = INDEX(ION,ION)
                JJ1 = INDEX(IND,J1)
C
                IJKK = (JJ1-1)*NXYZ + 1
                IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                  DO ISTAT=1,NSTATS
                    NCI2 = (ISTAT-1)*NCI + ICI2
                    FC = CI(NCI2)*IPER
                    IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                    CALL DAXPY(NXYZ,FC,DERI(IJKK),1,WAXCI(1,IWIT),1)
                  ENDDO
                ENDIF
C
                IF(ICI2.GE.JLO .AND. ICI2.LE.JHI) THEN
                  DO ISTAT=1,NSTATS
                    NCIT = (ISTAT-1)*NCI + ICIT
                    FC = CI(NCIT)*IPER
                    IWI2 = (ISTAT-1)*NDETLN + ICI2 - JLO + 1
                    CALL DAXPY(NXYZ,FC,DERI(IJKK),1,WAXCI(1,IWI2),1)
                  ENDDO
                ENDIF
  690        CONTINUE
             NST = NEND
  920    CONTINUE
C
  517   CONTINUE
C
C          ----- Now for beta doubles -----
C
       DO 6015 IBB = IB+1,NB
               ISTBB = JJ+1
               IENBB = IEN
               JB = IBCON1(IBB)
               IS3 = IOX(JB)
               IPB = IBB
               IF (JJ.GT.JB) IPB = IPB - 1
               DO 6010 KKJBB = KKJ,NB+1
                  DO 6005 JJBB = ISTBB,IENBB
                    IS4 = IOX(JJBB)
                    IP2 = IMUL(IS4,IS3)
                    IF (IP1.NE.IP2) GOTO 6005
C
          CALL RET1DET(IACON2,IACON1,NB,IPB,JJBB,IZERO,KKJBB,IPER2)
          IBP2 = POSDET(NACT,NB,IACON1,IFA)
          IBP2 = ISPB(IBP2)
          IPER = IPER1+IPER2
C         IPER = ((-1)**IPER)*2
          IPER = ((-1)**IPER)
               I2 = INDEX(JB,JJBB)
               INX = INDEX(I2,IND)
               II1 = INDEX(JJBB,IO1)
               II2 = INDEX(JB,JJ)
               INX2 = INDEX(II1,II2)
C
               IJKL = (INX-1)*NXYZ + 1
               ILKJ = (INX2-1)*NXYZ + 1
             DO 686 INA1 = ISAS(ISB1),ISAS(ISB1+1)-1
             NEND = ISAC(INA1)
             ICIA = ISPA(NEND)
             ICIT = ICIA + ICAB
             ICI2 = ICIA + IBP2
C
             IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
               DO ISTAT=1,NSTATS
                 NCI2 = (ISTAT-1)*NCI + ICI2
                 FC = CI(NCI2)*IPER
                 IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                 CALL DAXPY(NXYZ,FC,DERI(IJKL),1,WAXCI(1,IWIT),1)
                 CALL DAXPY(NXYZ,-FC,DERI(ILKJ),1,WAXCI(1,IWIT),1)
               ENDDO
             ENDIF
C
             IF(ICI2.GE.JLO .AND. ICI2.LE.JHI) THEN
               DO ISTAT=1,NSTATS
                 NCIT = (ISTAT-1)*NCI + ICIT
                 FC = CI(NCIT)*IPER
                 IWI2 = (ISTAT-1)*NDETLN + ICI2 - JLO + 1
                 CALL DAXPY(NXYZ,FC,DERI(IJKL),1,WAXCI(1,IWI2),1)
                 CALL DAXPY(NXYZ,-FC,DERI(ILKJ),1,WAXCI(1,IWI2),1)
               ENDDO
             ENDIF
  686       CONTINUE
C
 6005          CONTINUE
               ISTBB = IBCON1(KKJBB)+1
               IENBB = IBCON1(KKJBB+1)-1
               IF (KKJBB.EQ.NB) IENBB=NACT
 6010      CONTINUE
 6015 CONTINUE
C
 6020       CONTINUE
            IST = IBCON1(KKJ)+1
            IEN=IBCON1(KKJ+1)-1
            IF (KKJ.EQ.NB) IEN=NACT
 6025     CONTINUE
 6030 CONTINUE
C
C          ----- Remaining part of diagonal contributions -----
C
            DO 69 II=1,NB
               I1 = IBCON1(II)
               IND1 = INDEX(I1,I1)
C
               IJ1 = INDEX(I1+NCOR,I1+NCOR)
               IJ2 = (IND1-1)*NXYZ + 1
            DO 93 INA1 = ISAS(ISB1),ISAS(ISB1+1)-1
              NEND = ISAC(INA1)
              ICIA = ISPA(NEND)
              ICIT = ICIA + ICAB
C
              IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                DO ISTAT=1,NSTATS
                  NCIT = (ISTAT-1)*NCI + ICIT
                  FC = CI(NCIT)
                  IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                  CALL DAXPY(NXYZ,FC,DFC(IJ2),1,WAXCI(1,IWIT),1)
                  PRCNDC(IWIT) = PRCNDC(IWIT) + FCOR(IJ1)
                ENDDO
              ENDIF
   93       CONTINUE
C
               DO 74 JJ=II+1,NB
                  I2 = IBCON1(JJ)
                  IND2 = INDEX(I2,I2)
                  INDM = IND2-I2+I1
                  J1 = INDEX(INDM,INDM)
                  J2 = INDEX(IND2,IND1)
C
                  IIKK = (J2-1)*NXYZ + 1
                  IKIK = (J1-1)*NXYZ + 1
            DO 97 INA1 = ISAS(ISB1),ISAS(ISB1+1)-1
               NEND = ISAC(INA1)
               ICIA = ISPA(NEND)
               ICIT = ICIA + ICAB
C
               IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                 DO ISTAT=1,NSTATS
                   NCIT = (ISTAT-1)*NCI + ICIT
                   FC = CI(NCIT)
                   IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                   CALL DAXPY(NXYZ,FC,DERI(IIKK),1,WAXCI(1,IWIT),1)
                   CALL DAXPY(NXYZ,-FC,DERI(IKIK),1,WAXCI(1,IWIT),1)
                   DVAL = ERI(I1+NCOR,I1,IND2) - ERI(I1+NCOR,I2,INDM)
                   PRCNDC(IWIT) = PRCNDC(IWIT) + DVAL
                 ENDDO
               ENDIF
   97       CONTINUE
C
   74          CONTINUE
C
   69       CONTINUE
           CALL ADVANC(IBCON1,NB,NACT)
 9999 CONTINUE
C
      RETURN
      END
C*MODULE CPMCHF  *DECK CPMCX
      SUBROUTINE CPMCX
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      LOGICAL SVDSWK,MASWRK,GOPARR,DSKWRK,SOME,PACK2E,FDIRCT,QCORR
      LOGICAL CANONC,FCORE,FORS,NOCI,EKT,LINSER,GENMC,NOCAS
C
      INTEGER         C_OOOO, C_VOOO, C_VVOO, C_VOVO
      DOUBLE PRECISION METHOD,NACME
C
      PARAMETER (MXRT=100, MXATM=2000, MXSH=5000, MXNORO=250)
C
      DIMENSION NOCP(3*MXATM)
C
      COMMON /CIFILS/ NFT11,NFT12,NFT13,NFT14,NFT15,NFT16,IDAF20,NEMEMX
      COMMON /DLBTIM/ C_OOOO,C_VOOO,C_VVOO,C_VOVO
      COMMON /DETWFN/ WSTATE(MXRT),SPINS(MXRT),CRIT,PRTTOL,S,SZ,
     *                GRPDET,STSYM,GLIST,
     *                NFLGDM(MXRT),IWTS(MXRT),NCORSV,NCOR,NACT,NORB,
     *                NA,NB,K,KST,IROOT,IPURES,MAXW1,NITER,MAXP,NCI,
     *                IGPDET,KSTSYM,NFTGCI
      COMMON /ECP2  / CLP(400),ZLP(400),NLP(400),KFIRST(MXATM,6),
     *                KLAST(MXATM,6),LMAX(MXATM),LPSKIP(MXATM),
     *                IZCORE(MXATM)
      COMMON /ENRGYS/ ENUCR,EELCT,ETOT,STOT,SZZ,ECORE,ESCF,EERD,E1,E2,
     *                VEN,VEE,EPOT,EKIN,ESTATE(MXRT),STATN,EDFT(2),EDISP
      COMMON /FCCWFN/ NSPACE,MSTA(51),MNUM(51),MINI(51),MAXI(51),
     *                IAMI(51),IAMA(51),IBMI(51),IBMA(51),IDIM(51),
     *                LBST(51),NREF0,FDIRCT,QCORR,C0SQ
      COMMON /FMCOM / X(1)
      COMMON /INFOA / NAT,ICH,MUL,NUM,NQMT,NE,NA2,NB2,
     *                ZAN(MXATM),C(3,MXATM),IAN(MXATM)
      COMMON /INTFIL/ NINTMX,NHEX,NTUPL,PACK2E,INTTYP,IGRDTYP
      COMMON /IOFILE/ IR,IW,IP,IJKO,IJKT,IDAF,NAV,IODA(950)
      COMMON /MACHIN/ NWDVAR,MAXFM,MAXSM,LIMFM,LIMSM
      COMMON /MCINP / METHOD,CISTEP,ACURCY,ENGTOL,DAMP,MICIT,NWORD,
     *                NORBMC,NOROT(2,MXNORO),MOFRZ(15),NPFLG(10),
     *                NOFO,MCFMO,CANONC,FCORE,FORS,NOCI,EKT,LINSER
      COMMON /OUTPUT/ NPRINT,ITOL,ICUT,NORMF,NORMP,NOPK
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
      COMMON /RUNOPT/ RUNTYP,EXETYP,NEVALS,NGLEVL,NHLEVL
      COMMON /SYMTRY/ MAPSHL(MXSH,48),MAPCTR(MXATM,48),
     *                T(432),INVT(48),NT
C
      INTEGER         D_OOOO,D_VOOO,D_VVOO,D_VOVO,D_VVVO,D_VVVV,
     *                D_OOOOAB,D_OOOOBB,D_VOOOAB,D_VOOOBA,D_VOOOBB,
     *                D_VVOOAB,D_VVOOBA,D_VVOOBB,D_VOVOAB,D_VOVOBB,
     *                D_U,D_UB,D_E,D_EB
      LOGICAL         NDOOOO,NDVOOO,NDVVOO,NDVOVO,NDVVVO,NDVVVV,NDCORE,
     *                NDVVOOBA,NDVVOOAB,NDVVOOBB,NDVOVOAB,NDVOVOBB,
     *                NDVOOOBA,NDVOOOAB,NDVOOOBB,NDOOOOAB,NDOOOOBB
      COMMON /TRFDMS/ D_OOOO,D_VOOO,D_VVOO,D_VOVO,D_VVVO,D_VVVV,
     *                D_OOOOAB,D_OOOOBB,D_VOOOAB,D_VOOOBA,D_VOOOBB,
     *                D_VVOOAB,D_VVOOBA,D_VVOOBB,D_VOVOAB,D_VOVOBB,
     *                D_U,D_UB,D_E,D_EB,
     *                NDOOOO,NDVOOO,NDVVOO,NDVOVO,NDVVVO,NDVVVV,NDCORE,
     *                NDVVOOBA,NDVVOOAB,NDVVOOBB,NDVOVOAB,NDVOVOBB,
     *                NDVOOOBA,NDVOOOAB,NDVOOOBB,NDOOOOAB,NDOOOOBB
C
      DATA ORMAS /8HORMAS   /
      DATA CHECK /8HCHECK   /
      DATA NACME,HESS,CONICL /8HNACME   ,8HHESSIAN ,8HCONICAL /
C
      PARAMETER (ZERO=0.0D+00)
C
      L0 = NQMT
      L1 = NUM
      L2 = (L1*L1+L1)/2
      L3 = L1*L1
      N1 = NACT
      N2 = (N1*N1+N1)/2
      N4 = (N2*N2+N2)/2
      M1 = NCORSV+NACT
C
      NSYM = 2**IGPDET
      NXYZ = 3*NAT
      NC3 = NXYZ**2
C
      SOME = NPRINT.NE.-5 .AND. MASWRK
      NFT18 = 18
      NFT19 = 19
      GENMC = .FALSE.
      NOCAS = .FALSE.
      IF(CISTEP.EQ.ORMAS) THEN
        GENMC = .TRUE.
        LBST(1) = 1
        DO II=2,NSPACE
          IDIM(II-1) = MAX(IAMA(II-1),IBMA(II-1))
          LBST(II) = LBST(II-1) + ((MNUM(II-1)+1)*(IDIM(II-1)+1))
        ENDDO
        IDIM(NSPACE) = MAX(IAMA(NSPACE),IBMA(NSPACE))
        LNEED = LBST(NSPACE)+((MNUM(NSPACE)+1)*(IDIM(NSPACE)+1))
      ELSE
        NSPACE = 1
        LNEED = 0
        ITGA = 1
        ITGB = 1
        NB1EX = 0
      ENDIF
C
      IF(GOPARR) THEN
         CALL DDI_PROCDLB_CREATE(C_OOOO)
         CALL DDI_PROCDLB_CREATE(C_VOOO)
         CALL DDI_PROCDLB_CREATE(C_VVOO)
         CALL DDI_PROCDLB_CREATE(C_VOVO)
      END IF
C
      IF(MASWRK) WRITE(IW,9000)
      CALL FLSHBF(IW)
C
C     ----- Get memory required for whole program -----
C
      CALL GOTFM(NGOTMX)
      CALL VALFM(LOADFM)
      LIBO = LOADFM + 1
      LIND = LIBO + L1
      LIFA = LIND + L3
      LV = LIFA + ((N1+1)**2)/NWDVAR + 1
      LWRK = LV + L3
      LIA = LWRK + MAX(2*L3,N4)
      LEG = LIA + L2
      LEH = LEG + NXYZ
      LOINT = LEH + 9*(NAT*NAT+NAT)/2
      LFCOR = LOINT + L2
      LERI = LFCOR + L2
      LAMAT = LERI + L1*N1*N2
      LOPDM = LAMAT + L1*NCORSV*N2
      LEPS = LOPDM + N2
      LTPDM = LEPS + L3
      LX = LTPDM + N4
      LIX = LX + NINTMX
      LFCM = LIX + NINTMX
      LSDER = LFCM + NC3
      LDDM = LSDER + L3*NXYZ
      LSK = LDDM + 3*NXYZ
      LWSTMP = LSK + NAT
      LETMP = LWSTMP + MXRT
      LNG = LETMP + MXRT
      LBOX1 = LNG + NXYZ
      LBOX2 = LBOX1 + NSPACE
      LBOX3 = LBOX2 + NSPACE
      LBOX4 = LBOX3 + NSPACE
      LBOX5 = LBOX4 + NSPACE
      LAST = LBOX5 + NSPACE
      NEED1 = LAST - LOADFM - 1 + LNEED
      CALL GETFM(NEED1)
C
C     ----- Determine unique xyz for which CPMCSCF is needed -----
C
      NUNIQ = 0
      DO IXYZ=1,NXYZ
        NOCP(IXYZ) = 1
      ENDDO
      DO 200 IAT=1,NAT
        NUCZ = INT(ZAN(IAT)+0.01D+00) + IZCORE(IAT)
        IF(NUCZ.EQ.0) GO TO 200
        DO IT=1,NT
          IF(MAPCTR(IAT,IT).GT.IAT) GO TO 200
        ENDDO
        IXYZ=3*(IAT-1)
        NOCP(IXYZ+1) = 0
        NOCP(IXYZ+2) = 0
        NOCP(IXYZ+3) = 0
        NUNIQ = NUNIQ + 3
  200 CONTINUE
C
C     ----- Determine quantities related to generation of -----
C     -----              coupling constants               -----
C
      IAST = 0
      IBST = 0
C
      IF(GENMC) THEN
        DO II=1,NSPACE
          LBST(II) = LBST(II) + LAST
          CALL BINOM8(X(LBST(II)),MNUM(II),IDIM(II))
        ENDDO
C
        CALL TOTALCO(X(LBOX1),NSPACE,NA,IAMA,IAMI,X(LBOX2),ITGA)
        CALL TOTALCO(X(LBOX1),NSPACE,NB,IBMA,IBMI,X(LBOX2),ITGB)
C
        CALL RESETCO(X(LBOX1),NSPACE,NA,IAMA,IAMI,X(LBOX2))
        DO II=1,ITGA
          CALL TOTDETG(X(LBOX1),NSPACE,LBST,X(LBST(1)),LNEED,
     *                 MNUM,IDIM,ITOT)
          IAST = IAST + ITOT
          CALL PUSHCO(X(LBOX1),NSPACE,NA,IAMA,IAMI,X(LBOX2),IEND)
        ENDDO
C
        CALL RESETCO(X(LBOX1),NSPACE,NB,IBMA,IBMI,X(LBOX2))
        DO II=1,ITGB
          CALL TOTDETG(X(LBOX1),NSPACE,LBST,X(LBST(1)),LNEED,
     *                 MNUM,IDIM,ITOT)
          IBST = IBST + ITOT
          CALL PUSHCO(X(LBOX1),NSPACE,NB,IBMA,IBMI,X(LBOX2),IEND)
        ENDDO
      ENDIF
      CALL BINOM6(X(LIFA),N1)
      CALL MATMC2(L1,M1,NCORSV,NA,NB,X(LIFA),NSYM,IIS,NDETMX,
     *            ITGA,ITGB,NSPACE,IAST,IBST,GENMC)
C
      CALL VALFM(LOADFM)
      LIWRK = LOADFM + 1
      LAST = LIWRK + IIS
      NEEDWK = LAST - LOADFM - 1
      CALL GETFM(NEEDWK)
C
      IF(GENMC) THEN
        CALL VCLR(X(LIWRK),1,IIS)
        LCON = LIWRK
        LANDET = LCON + NA
        LBNDET = LANDET + NSPACE*ITGA
        LGCOM = LBNDET + NSPACE*ITGB
        LCOB = LGCOM + ITGA*ITGB
        CALL MATMC3(NDETMX,NCORSV,ITGA,ITGB,NA,NB,X(LBOX1),X(LBOX2),
     *              X(LBOX3),X(LCON),X(LANDET),X(LBNDET),X(LGCOM),
     *              X(LCOB),X(LBST(1)),NOCAS)
      ENDIF
C
C     ----- Determine independent orbital rotations -----
C
C-MWS-CALL DERCHK(NDER)
      NDER=2
      CALL DAREAD(IDAF,IODA,X(LIBO),L1,255,1)
      CALL FMPAIR(X(LIND),X(LIBO),MSTA,NCORSV,N1,L1,L0,NROT,NDER,
     *            NSPACE,GENMC,NOCAS)
C
      CALL DAREAD(IDAF,IODA,X(LIBO),L1,262,1)
      CALL CORTRA(X(LIBO),M1,NCORSV)
      IF(NDER.NE.2) NDETMX = NCI
C
C     ----- Get memory for CPMCHF configuration solution -----
C
      NDETLN = NDETMX
      JLO = 1
      JHI = NDETMX
      JROTLO = 1
      JROTHI = NROT
      IF(GOPARR) THEN
        NDETLN = NDETMX/NPROC
        NDTMOD = MOD(NDETMX,NPROC)
        IF(ME.LT.NDTMOD) THEN
          JLO = ME*(NDETLN+1) + 1
          JHI = JLO + NDETLN
        ELSE
          JLO = NDTMOD*(NDETLN+1) + (ME-NDTMOD)*NDETLN + 1
          JHI = JLO + NDETLN - 1
        ENDIF
        IF(NDTMOD.GT.0) NDETLN = NDETLN + 1
C
        NROTLN = NROT/NPROC
        NDTMOD = MOD(NROT,NPROC)
        IF(ME.LT.NDTMOD) THEN
          JROTLO = ME*(NROTLN+1) + 1
          JROTHI = JROTLO + NROTLN
        ELSE
          JROTLO = NDTMOD*(NROTLN+1) + (ME-NDTMOD)*NROTLN + 1
          JROTHI = JROTLO + NROTLN - 1
        ENDIF
      ENDIF
C
C     ----- Determine number of spin states -----
C
      IWST = 0
      NSTATS = 0
      IRTTMP = 0
      DO 100 IST=1,K
        IF(IPURES.EQ.1) THEN
          IF(ABS(SPINS(IST)-S) .GT. 0.03D+00) GO TO 100
          IWST = IWST + 1
        ELSE
          IWST = IWST + 1
        ENDIF
        IF(WSTATE(IWST).NE.ZERO) THEN
          NSTATS = NSTATS + 1
          X(LWSTMP+NSTATS-1) = WSTATE(IWST)
          IF(IROOT.EQ.IWST) IRTTMP = NSTATS
        ENDIF
  100 CONTINUE
C
      CALL DERCHK(MAXDER)
      IF((NSTATS.NE.1) .AND. (RUNTYP.EQ.HESS .OR. MAXDER.EQ.2)) THEN
         IF(MASWRK) WRITE(IW,9005)
         CALL ABRT
      END IF
 9005 FORMAT(/1X,'CANNOT PERFORM HESSIAN EVALUATION FOR STATE-',
     *           'AVERAGED WAVEFUNCTION.')
C
      NNSTAT = (NSTATS*NSTATS+NSTATS)/2
C
C     ----- Get more memory required for whole program -----
C
      CALL VALFM(LOADFM)
      LCI = LOADFM + 1
      LYAO = LCI + NSTATS*NDETMX
      LYAC = LYAO + NUNIQ*NROT
      LYAS = LYAC + NXYZ*NSTATS*NDETLN
      LPRCDO = LYAS + NUNIQ*NNSTAT
      LPRCDC = LPRCDO + NROT
      LPRCDS = LPRCDC + NSTATS*NDETLN
      LEGRAD = LPRCDS + NNSTAT
      LDERI = LEGRAD + NXYZ*NNSTAT
      LAST = LDERI + N1*N1*N2*NXYZ
      NEED2 = LAST - LOADFM - 1
      IF(EXETYP.NE.CHECK) CALL GETFM(NEED2)
C
C     ----- Get temporary memory -----
C
      CALL VALFM(LOADFM)
      LDFC = LOADFM + 1
      LDLAG = LDFC + L2*NXYZ
      LDSAO = LDLAG + L3*NXYZ
      LDHC = LDSAO + L3
      LTMPWK = LDHC + NXYZ
      LCIOLD = LTMPWK + NSTATS*NDETLN
      LAST = LCIOLD + K*NCI
      NEEDT = LAST - LOADFM - 1
      IF(EXETYP.NE.CHECK) CALL GETFM(NEEDT)
C
      MEMREP = NEED1 + NEED2 + NEEDT
      IF(EXETYP.EQ.CHECK) THEN
        CALL CPCHK1(MEMREP,IW,NSTATS,NXYZ,NDETMX)
      ELSE
        IF(SOME) WRITE(IW,9010) MEMREP,NGOTMX
      ENDIF
C
      IF(EXETYP.EQ.CHECK) THEN
         CALL VCLR(X(LEG),1,NXYZ)
         CALL DAWRIT(IDAF,IODA,X(LEG),NXYZ,3,0)
         CALL DAWRIT(IDAF,IODA,X(LEG),NXYZ,29,0)
         NEGH = NXYZ + 9*(NAT*NAT+NAT)/2
         CALL DAREAD(IDAF,IODA,X(LEG),NEGH,67,0)
         CALL CPWAB0(X(LFCM),X(LEH),NAT)
         CALL DAWRIT(IDAF,IODA,X(LFCM),NC3,4,0)
         CALL VCLR(X(LDDM),1,3*NXYZ)
         CALL DAWRIT(IDAF,IODA,X(LDDM),3*NXYZ,34,0)
         GO TO 300
      END IF
C
C     ----- Get CI vectors from file -----
C
      SVDSWK = DSKWRK
      DSKWRK = .FALSE.
      CALL SEQREW(NFT12)
      IF(MASWRK) READ(NFT12) NSTATS,NDETS
      IF(GOPARR) CALL DDI_BCAST(2150,'I',NSTATS,1,MASTER)
      IF(GOPARR) CALL DDI_BCAST(2151,'I',NDETS,1,MASTER)
C
      IF(NSTATS.NE.K .OR. NDETS.NE.NCI) THEN
        IF(MASWRK) WRITE(IW,9360) NSTATS,NDETS,K,NCI
        CALL ABRT
      END IF
C
      IWST = 0
      NSTATS = 0
      CALL DCOPY(MXRT,ESTATE,1,X(LETMP),1)
      DO 150 IST=1,K
        IF(IPURES.EQ.1) THEN
          IF(ABS(SPINS(IST)-S) .GT. 0.03D+00) THEN
            CALL SEQADV(NFT12)
            GO TO 150
          END IF
          IWST = IWST + 1
        ELSE
          IWST = IWST + 1
        ENDIF
        IF(WSTATE(IWST).NE.ZERO) NSTATS = NSTATS + 1
C
        IF(WSTATE(IWST).EQ.ZERO) THEN
          CALL SEQADV(NFT12)
          GO TO 150
        ENDIF
        IF(MASWRK) THEN
           IF(RUNTYP.EQ.HESS)   WRITE(IW,9060) ESTATE(IST),SPINS(IST)
           IF(RUNTYP.EQ.NACME)  WRITE(IW,9065) ESTATE(IST),SPINS(IST)
           IF(RUNTYP.EQ.CONICL) WRITE(IW,9065) ESTATE(IST),SPINS(IST)
        ENDIF
        LCITMP = LCIOLD + (NSTATS-1)*NCI
        CALL SQREAD(NFT12,X(LCITMP),NCI)
        ESTATE(NSTATS) = X(LETMP+IST-1)
  150 CONTINUE
      CALL SEQREW(NFT12)
      DSKWRK = SVDSWK
C
C     ----- Construct derivative overlap terms -----
C
      IF(NDER.EQ.2) THEN
        NEGH = NXYZ + 9*(NAT*NAT+NAT)/2
        CALL DAREAD(IDAF,IODA,X(LEG),NEGH,67,0)
        CALL CPWAB0(X(LFCM),X(LEH),NAT)
        CALL DAWRIT(IDAF,IODA,X(LEG),NXYZ,3,0)
        CALL DAWRIT(IDAF,IODA,X(LEG),NXYZ,29,0)
      ENDIF
C
      CALL DAREAD(IDAF,IODA,X(LEPS),L3,403,0)
      CALL DAREAD(IDAF,IODA,X(LOPDM),N2,320,0)
      CALL GTTPDM(X(LTPDM),X(LX),X(LIX),N4,NINTMX)
C
      CALL JCPOVR(X(LFCM),X(LSDER),X(LDFC),X(LDERI),X(LDLAG),X(LDHC),
     *            X(LDSAO),X(LV),X(LOINT),X(LFCOR),X(LERI),X(LAMAT),
     *            X(LOPDM),X(LTPDM),X(LPRCDO),X(LEPS),X(LWRK),
     *            X(LWRK+L3),X(LIA),X(LIND),NCORSV,N1,NXYZ,L0,L1,L2,N2,
     *            N4,NROT,NDER,NFT18)
C
C     ----- Construct configuration part of right-hand -----
C     -----          side of CPMCSCF equations         -----
C
      CALL DAREAD(IDAF,IODA,X(LEG),NXYZ,3,0)
      CALL DAREAD(IDAF,IODA,X(LNG),NXYZ,258,0)
      CALL VSUB(X(LNG),1,X(LEG),1,X(LEG),1,NXYZ)
C
      LWAXCI = LYAC
      IF(GENMC) THEN
        CALL JCPORM(X(LDFC),X(LWAXCI),X(LDHC),X(LDERI),X(LFCOR),
     *              X(LOINT),X(LERI),X(LPRCDC),X(LPRCDS),X(LCI),
     *              X(LCIOLD),X(LWSTMP),X(LEGRAD),X(LBOX1),X(LBOX2),
     *              X(LBOX3),X(LBOX4),X(LBOX5),X(LIBO),X(LIWRK),IW,
     *              NDER,NXYZ,L1,L2,N2,N4,LNEED,JLO,JHI,NDETMX,NDETLN,
     *              NSTATS,ITGA,ITGB,IAST,IBST,IIS,NNSTAT,NB1EX)
      ELSE
        CALL JCPDET(X(LWAXCI),X(LPRCDC),X(LPRCDS),X(LCI),X(LCIOLD),
     *              X(LDFC),X(LDERI),X(LDHC),X(LFCOR),X(LERI),X(LEGRAD),
     *              X(LOINT),X(LWSTMP),X(LIBO),X(LIFA),X(LIWRK),NDETMX,
     *              NDETLN,NCI,N1,NCORSV,NA,NB,IGPDET,KSTSYM,NSYM,IIS,
     *              IW,NXYZ,L1,JLO,JHI,NSTATS,NNSTAT)
      ENDIF
C
C     ----- Write configuration part of right-hand side of -----
C     -----           CPMCSCF equations to file            -----
C
      SVDSWK = DSKWRK
      DSKWRK = .TRUE.
      CALL SEQOPN(NFT19,'WORK19','UNKNOWN',.FALSE.,'UNFORMATTED')
      CALL SEQREW(NFT19)
      DO IXYZ=1,NXYZ
        LVAL = LWAXCI + IXYZ - 1
        CALL DCOPY(NSTATS*NDETLN,X(LVAL),NXYZ,X(LTMPWK),1)
        CALL SQWRIT(NFT19,X(LTMPWK),NSTATS*NDETLN)
      ENDDO
C
      CALL RETFM(NEEDT)
  300 CONTINUE
C
C     ----- Solve CPMCSCF equations using conjugate gradient -----
C
      IWKVEC = MAX(L3,NSTATS*NDETLN)
      CALL VALFM(LOADFM)
      LRSIDO = LOADFM + 1
      LRSIDC = LRSIDO + NUNIQ*NROT
      LRSIDS = LRSIDC + NUNIQ*NDETLN*NSTATS
      LZRSO = LRSIDS + NUNIQ*NNSTAT
      LZRSC = LZRSO + NUNIQ*NROT
      LZRSS = LZRSC + NUNIQ*NDETLN*NSTATS
      LPDIRO = LZRSS + NUNIQ*NNSTAT
      LPDIRC = LPDIRO + NUNIQ*NROT
      LPDIRS = LPDIRC + NUNIQ*NDETMX*NSTATS
      LBNORM = LPDIRS + NUNIQ*NNSTAT
      LBKNUM = LBNORM + NUNIQ
      LBKDEN = LBKNUM + NUNIQ
      LTMPWK = LBKDEN + NUNIQ
      LDDEN = LTMPWK + MAX(2*NXYZ,IWKVEC)
      LDDEN2 = LDDEN + MAX(NSTATS*NSTATS*N1*N1,NUNIQ*N2)
      LSALAG = LDDEN2 + NUNIQ*N1*N1
      LSAGRD = LSALAG + NSTATS*NSTATS*L3
      LFCORS = LSAGRD + NSTATS*NSTATS*NXYZ
      LYTMP = LFCORS + L3
      LAST = LYTMP + NUNIQ*N1*N1*N2
      NEEDT = LAST - LOADFM - 1
      IF(EXETYP.NE.CHECK) CALL GETFM(NEEDT)
C
      IF(SOME) THEN
        WRITE(IW,9020)
        CALL TIMIT(1)
        WRITE(IW,9030) NROT,NDETMX
        WRITE(IW,9040) NUNIQ,0
C
        MEMREP = NEED1 + NEED2 + NEEDT
        IF(EXETYP.EQ.CHECK) THEN
          CALL CPCHK2(MEMREP,IW,NSTATS,NUNIQ,NXYZ,NDETMX,L3)
        ELSE
          WRITE(IW,9045) MEMREP,NGOTMX
        ENDIF
        CALL FLSHBF(IW)
      ENDIF
C
      DSKWRK = SVDSWK
C
      IF(EXETYP.EQ.CHECK) GO TO 400
C
      CALL MCCPCG(X(LYAO),X(LYAC),X(LYAS),X(LPRCDO),X(LPRCDC),X(LPRCDS),
     *            X(LRSIDO),X(LRSIDC),X(LRSIDS),X(LZRSO),X(LZRSC),
     *            X(LZRSS),X(LPDIRO),X(LPDIRC),X(LPDIRS),X(LBNORM),
     *            X(LBKNUM),X(LBKDEN),X(LOINT),X(LFCOR),X(LAMAT),
     *            X(LERI),X(LEPS),X(LOPDM),X(LTPDM),X(LCI),X(LTMPWK),
     *            X(LIND),X(LIA),X(LIWRK),X(LIFA),X(LIBO),NOCP,
     *            NXYZ,NUNIQ,NROT,NDETLN,NDETMX,IIS,JLO,JHI,NA,NB,NSYM,
     *            NCORSV,N1,L0,L1,L2,NFT18,NFT19,NSTATS,X(LWSTMP),
     *            X(LEGRAD),X(LSALAG),X(LDERI),X(LDDEN),X(LDDEN2),
     *            X(LFCORS),X(LYTMP),GENMC,LNEED,X(LBOX1),X(LBOX2),
     *            X(LBOX3),X(LBOX4),X(LBOX5),ITGA,ITGB,IAST,IBST,NB1EX,
     *            JROTLO,JROTHI)
C
C     ----- Add CPMCHF contributions to force constant matrix -----
C     -----        and symmetrize force constant matrix       -----
C
      IF(NDER.EQ.2) THEN
        CALL VCLR(X(LDDM),1,3*NXYZ)
        LDIAO = LEPS
        LDIMO = LOINT
C
        CALL FMDDEN(X(LDDEN),X(LYAC),X(LCI),X(LIFA),X(LIBO),X(LIWRK),
     *              NACT,N2,NUNIQ,NDETLN,NSYM,NA,NB,IIS,JLO,JHI,LNEED,
     *              ITGA,ITGB,IAST,IBST,X(LBOX1),X(LBOX2),X(LBOX4),
     *              X(LBOX5),GENMC)
C
        CALL UAFCM(X(LFCM),X(LDDM),X(LYAO),X(LYAC),X(LDDEN),X(LZRSO),
     *             X(LZRSC),X(LSDER),X(LCI),X(LEG),X(LOPDM),X(LV),
     *             X(LDIAO),X(LDIMO),X(LTMPWK),X(LIND),NOCP,X(LIA),L0,
     *             L1,L2,NXYZ,NUNIQ,NROT,NDETLN,NCORSV,NACT,N2,JLO,JHI,
     *             NFT18,NFT19)
C
        CALL CPSYM(X(LFCM),NXYZ)
C SUPPRESS THE HESSIAN OUTPUT IN THE SA-MCSCF CALCULATION
        IF(NSTATS.EQ.1) CALL DAWRIT(IDAF,IODA,X(LFCM),NC3,4,0)
C
        CALL VCLR(X(LFCM),1,3*NXYZ)
        CALL DAREAD(IDAF,IODA,X(LFCM),3*NXYZ,34,0)
        CALL VADD(X(LDDM),1,X(LFCM),1,X(LDDM),1,3*NXYZ)
        CALL DAWRIT(IDAF,IODA,X(LDDM),3*NXYZ,34,0)
        CALL CPSDDM(X(LDDM),X(LSK),NXYZ)
      ENDIF
C
      IF(NSTATS.GT.1) THEN
        CALL FMNAC(X(LSAGRD),X(LEGRAD),X(LNG),X(LSALAG),X(LYAO),
     *             X(LDDEN),X(LCI),X(LSDER),X(LV),X(LWRK),X(LIA),NOCP,
     *             X(LIND),X(LIFA),X(LIBO),X(LIWRK),L0,L1,NSTATS,NNSTAT,
     *             NXYZ,NUNIQ,NROT,NACT,NCORSV,NDETMX,NSYM,NA,NB,IIS,
     *             IRTTMP)
      ENDIF
C
      CALL DCOPY(MXRT,X(LETMP),1,ESTATE,1)
C
C     ----- Return memory and counters -----
C
      CALL RETFM(NEEDT)
      CALL RETFM(NEED2)
  400 CONTINUE
      CALL RETFM(NEEDWK)
      CALL RETFM(NEED1)
C
      IF(GOPARR) THEN
        CALL DDI_PROCDLB_DESTROY(C_VOVO)
        CALL DDI_PROCDLB_DESTROY(C_VVOO)
        CALL DDI_PROCDLB_DESTROY(C_VOOO)
        CALL DDI_PROCDLB_DESTROY(C_OOOO)
        IF(EXETYP.NE.CHECK) THEN
          IF(MASWRK) WRITE(IW,9151)
          CALL DDI_DESTROY(D_VVOO)
          IF(MASWRK) WRITE(IW,9152)
          CALL DDI_DESTROY(D_OOOO)
          IF(MASWRK) WRITE(IW,9153)
          CALL DDI_DESTROY(D_VOOO)
          IF(MASWRK) WRITE(IW,9154)
          CALL DDI_DESTROY(D_VOVO)
        ENDIF
      ENDIF
C
      IF(GENMC) THEN
        DO II=1,NSPACE+1
          MSTA(II) = MSTA(II) + NCORSV
        ENDDO
      ENDIF
C
      IF(MASWRK) WRITE(IW,9100)
      CALL TIMIT(1)
C
 9000 FORMAT(/5X,49(1H-)/
     *        5X,'COUPLED-PERTURBED MULTICONFIGURATION HARTREE-FOCK'/
     *        5X,49(1H-))
 9010 FORMAT(/1X,'SETTING UP RIGHT-HAND SIDE OF CPMCHF EQUATIONS.',
     *       /1X,'# OF WORDS REQUIRED  = ',I10,
     *       /1X,'# OF WORDS AVAILABLE = ',I10,
     *       /1X,'NOTE THAT THE CP-MCHF DISTRIBUTED MEMORY',
     *           ' REQUIREMENTS ARE JUST THE',
     *       /1X,'MEMORY NEEDED TO STORE TRANSFORMED INTEGRAL',
     *           ' CLASSES (ALLOCATED ABOVE).')
 9020 FORMAT(/1X,'FINISHED SETTING UP RIGHT-HAND SIDE.')
 9030 FORMAT(/1X,'CALCULATING MCSCF ELECTRONIC HESSIAN ON THE FLY.',
     *       /1X,'# OF ORBITAL ROTATIONS   = ',I10,
     *       /1X,'LENGTH OF DET. EXPANSION = ',I10)
 9040 FORMAT(1X,'SOLVING FOR',I5,' NUCLEAR RESPONSES AND',I2,
     *          ' ELECTRIC FIELD RESPONSES')
 9045 FORMAT(/1X,'SOLVING CPMCHF EQUATIONS USING CG ALGORITHM.',
     *       /1X,'# OF WORDS REQUIRED  = ',I10,
     *       /1X,'# OF WORDS AVAILABLE = ',I10)
 9100 FORMAT(/1X,'...... DONE WITH CPMCHF EQUATIONS ......')
 9151 FORMAT(1X,'FREEING DISTRIBUTED STORAGE FOR',
     *          ' [VIR VIR|OCC OCC] INTEGRALS')
 9152 FORMAT(1X,'FREEING DISTRIBUTED STORAGE FOR',
     *          ' [OCC OCC|OCC OCC] INTEGRALS')
 9153 FORMAT(1X,'FREEING DISTRIBUTED STORAGE FOR',
     *          ' [VIR OCC|OCC OCC] INTEGRALS')
 9154 FORMAT(1X,'FREEING DISTRIBUTED STORAGE FOR',
     *          ' [VIR OCC|VIR OCC] INTEGRALS')
 9060 FORMAT(1X,'COMPUTING HESSIAN OF STATE WITH E=',F20.10,' S=',F5.1)
 9065 FORMAT(1X,'COMPUTING NACME FOR STATE WITH E=',F20.10,' S=',F5.1)
 9360 FORMAT(/1X,'***** ERROR IN -CPMCX- ROUTINE *****'/
     *       1X,'CI EIGENVECTOR FILE HAS DATA FOR NSTATE,NDETS=',I3,I10/
     *       1X,'BUT THE PRESENT CALCULATION HAS NSTATE,NDETS=',I3,I10)
      RETURN
      END
C*MODULE CPMCHF  *DECK NACMEX
      SUBROUTINE NACMEX(ENCALC)
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      LOGICAL ENCALC,FIRST,SECND,CPHF,BOTH,MFIRST,MSECND,MCPHF,
     *        SVGPAR,SVDSKW,SVDTRF,
     *        DIRTRF,GOPARR,DSKWRK,MASWRK
C
      PARAMETER (MXATM=2000, MXRT=100)
C
      COMMON /DETWFN/ WSTATE(MXRT),SPINS(MXRT),CRIT,PRTTOL,S,SZ,
     *                GRPDET,STSYM,GLIST,
     *                NFLGDM(MXRT),IWTS(MXRT),NCORSV,NCOR,NACT,NDTORB,
     *                MNA,MNB,K,KSTDET,IROOT,IPURES,MAXW1,NITER,MAXP,
     *                NCIDET,IGPDET,KSTSYM,NFTGCI
      COMMON /FUNCT / E,EG(3*MXATM)
      COMMON /HSSPAR/ FIRST,SECND,CPHF,BOTH,MFIRST,MSECND,MCPHF
      COMMON /INFOA / NAT,ICH,MUL,NUM,NQMT,NE,NA,NB,
     *                ZAN(MXATM),C(3,MXATM),IAN(MXATM)
      COMMON /IOFILE/ IR,IW,IP,IJK,IPK,IDAF,NAV,IODA(950)
      COMMON /OUTPUT/ NPRINT,ITOL,ICUT,NORMF,NORMP,NOPK
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
      COMMON /RUNOPT/ RUNTYP,EXETYP,NEVALS,NGLEVL,NHLEVL
      COMMON /TRFOPT/ CUTTRF,NWDTRF,MPTRAN,ITRFAO,NOSYMT,IPURTF,DIRTRF
C
      PARAMETER (ZERO=0.0D+00, TOL=1.0D-09)
C
      DATA CHECK/8HCHECK   /
C
C     ----- driver for Non-Adiabatic Coupling Matrix Elements -----
C     The NACME program written by Tim Dudley of Villanova University
C                 completed in the summer of 2008
C     This driver also handles computation of SA-MCSCF gradients.
C     This driver may only be called for MCSCF wavefunctions!
C
C     We take the easy way out with symmetry usage, turning it off
C     for the entire calculation.
C     1. In some cases, perhaps when the electronic state is totally
C        symmetric, it is OK to turn symmetry off after the integral
C        transformation, and thus be sure of getting a wavefunction
C        with good symmetry control.  But, see the MgH2 test case.
C     2. Symmetry must be off in the integral derivative terms.
C     3. Symmetry is also turned off in the response equations, but
C        it almost works to solve for only symmetry unique responses.
C        Some sort of clever symmetrization routine is needed.
C
      CALL SYMOFF
C
C     we only use 1st derivative ints from the 2nd derivative package
C
      FIRST=.TRUE.
      SECND=.FALSE.
      CPHF =.TRUE.
      BOTH =.FALSE.
      MFIRST=.TRUE.
      MSECND=.FALSE.
      MCPHF =.TRUE.
C
      CALL BASCHK(MAXL)
      IF(MAXL.GT.2) THEN
         IF(MASWRK) WRITE(IW,*) 'RUNTYP=NACME IS LIMITED TO S,P,D AOS'
         CALL ABRT
      END IF
C
      NSTATS = 0
      DO ISTAT=1,MXRT
         IF(WSTATE(ISTAT).GT.TOL) NSTATS = NSTATS+1
      ENDDO
      IF(NSTATS.EQ.1) THEN
        IF(MASWRK) WRITE(IW,9030)
        CALL ABRT
      END IF
C
C     ----- READ $CPHF INPUT -----
C
      CALL CPINP
C
C     ----- GET THE ENERGY AND THE WAVEFUNCTION -----
C
      IF(ENCALC) CALL ENERGX
      IF(E.EQ.ZERO  .AND.  EXETYP.NE.CHECK) THEN
         IF(MASWRK) WRITE(IW,9040)
         CALL ABRT
      END IF
C
C         MCSCF response code requires A DISTRIBUTED MEMORY PARALLEL
C         INTEGRAL TRANSFORMATION, AND so is "parallel", even for p=1.
C         the wavefunction, just above, is allowed to be serial.
C
      SVDSKW = DSKWRK
      SVGPAR = GOPARR
      SVDTRF = DIRTRF
      GOPARR = .TRUE.
      DIRTRF = .TRUE.
C
C     ----- INTEGRAL TRANSFORMATION -----
C     The MCSCF response equations use distributed MO integrals, only.
C
      NOCC=NCORSV+NACT
      NPR = 0
      IF(NPRINT.EQ.-5) NPR=-5
      CALL TRFMCX(NPR,0,NOCC,NQMT,.FALSE.,.FALSE.,.TRUE.,.TRUE.,
     *            .TRUE.,.TRUE.,.TRUE.,.FALSE.,.FALSE.,.TRUE.)
C
C     ----- OPEN DERIVATIVE FOCK (DERIVATIVE LAGRANGIAN) MATRIX FILE
C
      NFT18 = 18
      DSKWRK = .FALSE.
      CALL SEQOPN(NFT18,'FOCKDER','UNKNOWN',.FALSE.,'UNFORMATTED')
C
C     ----- ONE ELECTRON INTEGRAL DERIVATIVE TERMS -----
C
      CALL STVDD
C
C     ----- DIPOLE INTEGRALS AND THEIR DERIVATIVES -----
C
      CALL CALCOM(XC,YC,ZC)
      CALL DIPINT(XC,YC,ZC,.FALSE.)
      CALL DDINT
C
C     ----- TWO ELECTRON INTEGRAL DERIVATIVE TERMS -----
C
      CALL DDERJK
C
C     ----- SOLVE THE COUPLED PERTURBED EQUATIONS -----
C
      DSKWRK=.TRUE.
      CALL CPMCX
C
      CALL SYMON
C
      DSKWRK = SVDSKW
      GOPARR = SVGPAR
      DIRTRF = SVDTRF
C
      RETURN
C
 9030 FORMAT(/1X,'CONFUSION, ONLY ONE STATE IN SA-MC GRADIENT,',
     *           ' OR NACME RUN?')
 9040 FORMAT(//1X,'ENERGY DID NOT CONVERGE...ABORTING HESSIAN'//)
      END
C*MODULE CPMCHF  *DECK DETCP
      SUBROUTINE DETCP(IW,IBO,NACT,NA,NB,IDSYM,ISYM1,NSYM,NALP,NBLP,
     *                 ICON,ISYMA,ISYMB,ICOA,ICOB,ITAB,IMUL,ISPA,ISPB,
     *                 ISAS,ISBS,ISAC,ISBC,NSTATS,CI,CIOLD)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      DIMENSION CI(*),CIOLD(*)
      DIMENSION ICON(*)
      DIMENSION ISPA(NALP),ISPB(NBLP),ICOA(NSYM),ICOB(NSYM)
      DIMENSION ISYMA(NALP),ISYMB(NBLP),ITAB(NSYM)
      DIMENSION ISAS(NSYM+1),ISBS(NSYM+1)
      DIMENSION ISAC(NALP),ISBC(NBLP)
      DIMENSION IMUL(NSYM,NSYM)
      DIMENSION IBO(NACT)
C
C     ----- This code is similar to SYMWRK in aldeci.src -----
C
      CALL GTAB(IDSYM,ISYM1,ITAB,ICON(1),ICON(4),ICON(7),ICON(10))
      CALL GMUL(IDSYM,IMUL,ICON(1),ICON(4),ICON(7),ICON(10))
C
      DO 13 II=1,NSYM
         ISAS(II) = 0
         ISBS(II) = 0
         ICOA(II) = 0
         ICOB(II) = 0
   13 CONTINUE
C
      DO 23 II=1,NB
        ICON(II) = II
   23 CONTINUE
C
      DO 43 IB=1,NBLP
        CALL GETSYM1(IW,ICON(1),NACT,NB,IBO,IDSYM,ISYM,
     *               ICON(NA+1),ICON(NA+4),ICON(NA+7),ICON(NA+10))
        ISYMB(IB) = ISYM
        ICOB(ISYM) = ICOB(ISYM) + 1
        ISPB(IB) = ICOB(ISYM)
        CALL ADVANC(ICON,NB,NACT)
   43 CONTINUE
C
      DO 33 II=1,NA
        ICON(II) = II
   33 CONTINUE
C
C     ----- Expand the ci vector over all determinants -----
C     -----     if performing hessian calculation      -----
C
      NCI = 0
      IVAL = 1
      JVAL = 1
      DO 53 IA=1,NALP
        CALL GETSYM1(IW,ICON(1),NACT,NA,IBO,IDSYM,ISYM,
     *               ICON(NA+1),ICON(NA+4),ICON(NA+7),ICON(NA+10))
        ISYMA(IA) = ISYM
        ICOA(ISYM) = ICOA(ISYM) + 1
        ISPA(IA) = NCI
        NCI = NCI + ICOB(ITAB(ISYM))
        CALL ADVANC(ICON,NA,NACT)
        IF(NSTATS.GT.1) GO TO 53
C
        DO 50 IB=1,NBLP
          JSYM = IMUL(ISYM,ISYMB(IB))
          IF(JSYM.EQ.ISYM1) THEN
            CI(IVAL) = CIOLD(JVAL)
            JVAL = JVAL + 1
          END IF
          IVAL = IVAL + 1
   50   CONTINUE
   53 CONTINUE
C
      IF(NSTATS.GT.1) THEN
        CALL DCOPY(NSTATS*NCI,CIOLD,1,CI,1)
        ISAS(1) = 1
        ISBS(1) = 1
        ISAS(NSYM+1) = NALP + 1
        ISBS(NSYM+1) = NBLP + 1
C
        DO 63 II=2,NSYM
          ISAS(II) = ISAS(II-1) + ICOA(ITAB(II-1))
          ISBS(II) = ISBS(II-1) + ICOB(ITAB(II-1))
   63   CONTINUE
C
        DO 73 II=1,NSYM
          ICOA(II) = 0
          ICOB(II) = 0
   73   CONTINUE
C
        DO 83 IA=1,NALP
          NSA = ISYMA(IA)
          ICOA(NSA) = ICOA(NSA) + 1
          ISAC(ISAS(ITAB(NSA))+ICOA(NSA)-1) = IA
   83   CONTINUE
C
        DO 93 IB=1,NBLP
          NSA = ISYMB(IB)
          ICOB(NSA) = ICOB(NSA) + 1
          ISBC(ISBS(ITAB(NSA))+ICOB(NSA)-1) = IB
   93   CONTINUE
C
        RETURN
      ENDIF
C
C     ----- Now reset quantities to reflect C1 symmetry -----
C     -----      if performing hessian calculation      -----
C
      DO 103 IB=1,NBLP
        ISYMB(IB) = 1
        ICOB(1) = IB
        ISPB(IB) = ICOB(1)
        ISBC(IB) = IB
  103 CONTINUE
C
      NCI = 0
      DO 113 IA=1,NALP
        ISYMA(IA) = 1
        ICOA(1) = IA
        ISPA(IA) = NCI
        ISAC(IA) = IA
        NCI = NCI + NBLP
  113 CONTINUE
C
      ISAS(1) = 1
      ISBS(1) = 1
      ISAS(2) = NALP + 1
      ISBS(2) = NBLP + 1
C
      DO 123 II=1,NACT
        IBO(II) = 1
  123 CONTINUE
C
      CALL GTAB(1,1,ITAB,ICON(1),ICON(4),ICON(7),ICON(10))
      CALL GMUL(1,IMUL,ICON(1),ICON(4),ICON(7),ICON(10))
C
      RETURN
      END
C*MODULE CPMCHF  *DECK FMAVEC
      SUBROUTINE FMAVEC(AVEC,YAO,AMAT,OINT,IROT,INDEX,L1,NCOR,NACT,
     *                  NNACT,NXYZ,NROT,NINDX,JRLO,JRHI)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      DIMENSION AVEC(NXYZ,NNACT),YAO(NXYZ,NROT),AMAT(L1,NCOR,NNACT),
     *          OINT(L1,L1)
      DIMENSION IROT(L1,L1),INDEX(NINDX,NINDX)
C
      PARAMETER (TWO=2.0D+00,TOL=1.0D-09)
C
      CALL VCLR(AVEC,1,NXYZ*NNACT)
C
      DO 100 M=1,L1
        DO 20 N=1,NCOR
          IPHSE = IROT(M,N)
          MN = IABS(IPHSE)
          IF(MN.LT.JRLO .OR. MN.GT.JRHI) GO TO 20
          DO 10 IJ=1,NNACT
            DVAL = AMAT(M,N,IJ)
            DVAL = DVAL*MN/IPHSE
            IF(ABS(DVAL).LT.TOL) GO TO 10
            CALL DAXPY(NXYZ,DVAL,YAO(1,MN),1,AVEC(1,IJ),1)
   10     CONTINUE
   20   CONTINUE
C
        DO 60 I=1,NACT
          II = I+NCOR
          IPHSE = IROT(M,II)
          MI = IABS(IPHSE)
          IF(MI.LT.JRLO .OR. MI.GT.JRHI) GO TO 60
          DO 50 J=1,NACT
            DVAL = OINT(M,J+NCOR)*MI/IPHSE
            IF(ABS(DVAL).LT.TOL) GO TO 50
            IJ = INDEX(I,J)
            IF(I.EQ.J) DVAL = DVAL*TWO
            CALL DAXPY(NXYZ,DVAL,YAO(1,MI),1,AVEC(1,IJ),1)
   50     CONTINUE
   60   CONTINUE
  100 CONTINUE
C
      RETURN
      END
C*MODULE CPMCHF  *DECK FMDDEN
      SUBROUTINE FMDDEN(DDEN,YAC,CI,IFA,IOX,IWRK,NACT,NNACT,NUNIQ,
     *                  NDETLN,NSYM,NA,NB,IIS,JLO,JHI,LNEED,ITGA,ITGB,
     *                  IAST,IBST,LBOX1,LBOX2,LBOX4,LBOX5,GENMC)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      LOGICAL GOPARR,DSKWRK,MASWRK,FDIRCT,QCORR,GENMC
C
      DIMENSION DDEN(NUNIQ,NNACT),YAC(NUNIQ,NDETLN),CI(*)
      DIMENSION IFA(0:NACT,0:NACT),IOX(NACT),IWRK(IIS)
      DIMENSION LBOX1(*),LBOX2(*),LBOX4(*),LBOX5(*)
C
      COMMON /FCCWFN/ NSPACE,MSTA(51),MNUM(51),MINI(51),MAXI(51),
     *                IAMI(51),IAMA(51),IBMI(51),IBMA(51),IDIM(51),
     *                LBST(51),NREF0,FDIRCT,QCORR,C0SQ
      COMMON /FMCOM / X(1)
      COMMON /IOFILE/ IR,IW,IP,IJKO,IJKT,IDAF,NAV,IODA(950)
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
C
      IF(GENMC) THEN
        LWRK = 1
        LKTAB = LWRK + 43
        LGMUL = LKTAB + NSYM
        LCON = LGMUL + NSYM*NSYM
        LCOA = LCON + NA
        LCOB = LCOA + NSYM*ITGA
        LANDET = LCOB + NSYM*ITGB
        LBNDET = LANDET + NSPACE*ITGA
        NAST = LBNDET + NSPACE*ITGB
        NBST = NAST + ITGA + 1
        LSYMA = NBST + ITGB + 1
        LSYMB = LSYMA + IAST
        LGCOM = LSYMB + IBST
        LSPA = LGCOM + ITGB*ITGA
        LSPB = LSPA + IAST
        LDISB = LSPB + IBST
        LSAS = LDISB + NSYM*ITGB*ITGA
        LSBS = LSAS + (NSYM+1)*ITGA
        LSAC = LSBS + (NSYM+1)*ITGB
        LSBC = LSAC + IAST
        LIND = LSBC + IBST
        LACON1 = LIND + NNACT + 1
        LACON2 = LACON1 + NA
        LBCON1 = LACON2 + NA
        LBCON2 = LBCON1 + NA
        ITOT = LBCON2 + NA - 1
      ELSE
        NALP = IFA(NACT,NA)
        NBLP = IFA(NACT,NB)
C
        ISYMA = 1
        ISYMB = ISYMA + NALP
        ICOA = ISYMB + NBLP
        ICOB = ICOA + NSYM
        ITAB = ICOB + NSYM
        IMUL = ITAB + NSYM
        ISPA = IMUL + NSYM*NSYM
        ISPB = ISPA + NALP
        ISAS = ISPB + NBLP
        ISBS = ISAS + NSYM+1
        ISAC = ISBS + NSYM+1
        ISBC = ISAC + NALP
C
        IACON1 = ISBC + NBLP
        IBCON1 = IACON1 + NA + 43
        IACON2 = IBCON1 + NA
        IBCON2 = IACON2 + NA
        IPOSA = IBCON2 + NB
        IPERA = IPOSA + (NA*(NACT-NA))
        IIND1 = IPERA + (NA*(NACT-NA))
        INDEX = IIND1 + (NA*(NACT-NA))
        ITOT = INDEX + NACT*NACT - 1
      ENDIF
C
      IF (ITOT.GT.IIS) THEN
         IF(MASWRK) THEN
           WRITE(IW,*) 'NOT ENOUGH MEMORY SPECIFIED FOR IWRK'
           WRITE(IW,*) 'ASKED FOR ',IIS,' NEED ',ITOT
         END IF
         CALL ABRT
      ENDIF
C
      IF(GENMC) THEN
        CALL ORMDD1(DDEN,YAC,NDETLN,NUNIQ,JLO,JHI,NNACT,NACT,NA,NB,
     *              X(LBST(1)),LNEED,CI,IWRK(LIND),NSYM,IOX,LBOX1,
     *              LBOX2,LBOX4,LBOX5,IWRK(LKTAB),IWRK(LACON1),
     *              IWRK(LACON2),IWRK(LBCON1),IWRK(LBCON2),IWRK(LANDET),
     *              IWRK(LBNDET),IWRK(NAST),IWRK(NBST),IWRK(LSYMA),
     *              IWRK(LSYMB),IWRK(LGCOM),IWRK(LSPA),IWRK(LSPB),
     *              IWRK(LDISB),IWRK(LSAS),IWRK(LSBS),IWRK(LSAC),
     *              ITGA,ITGB,IAST,IBST)
      ELSE
        CALL MATDD1(DDEN,YAC,CI,NNACT,NUNIQ,NACT,NA,NB,NDETLN,NALP,NBLP,
     *              IFA,IOX,NSYM,IWRK(IACON1),IWRK(IBCON1),IWRK(IACON2),
     *              IWRK(IPOSA),IWRK(IPERA),IWRK(IIND1),IWRK(INDEX),
     *              IWRK(ISYMA),IWRK(ISYMB),IWRK(ISPA),IWRK(ISPB),
     *              IWRK(ISAS),IWRK(ISBS),IWRK(ISAC),IWRK(ISBC),JLO,JHI)
      ENDIF
C
      IF(GOPARR) CALL DDI_GSUMF(2188,DDEN,NUNIQ*NNACT)
C
      RETURN
      END
C*MODULE CPMCHF  *DECK FMNAC
      SUBROUTINE FMNAC(SAGRAD,EGRAD,DNUC,SALAG,YAO,TDEN,CIVEC,SDER,V,
     *                 WRK,IA,NOCP,INDEX,IFA,IOX,IWRK,L0,L1,NSTATS,
     *                 NNSTAT,NXYZ,NUNIQ,NROT,NACT,NCOR,NDETMX,NSYM,
     *                 NA,NB,IIS,IRTTMP)
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      DIMENSION SAGRAD(NXYZ,NSTATS*NSTATS),EGRAD(NXYZ,NNSTAT),
     *          DNUC(NXYZ),SALAG(L1,L1,NSTATS*NSTATS),YAO(NUNIQ,NROT),
     *          TDEN(NACT,NACT,NSTATS*NSTATS),CIVEC(NDETMX,NSTATS),
     *          SDER(NXYZ,L1,L1),V(L1,L1),WRK(*)
      DIMENSION IA(*),NOCP(NXYZ),INDEX(L1,L1),IFA(*),IOX(*),IWRK(IIS)
C
      LOGICAL GOPARR,DSKWRK,MASWRK
C
      PARAMETER (MXGTOT=20000, MXSH=5000, MXRT=100, MXATM=2000,
     *           MXAO=8192)
C
      COMMON /ENRGYS/ ENUCR,EELCT,ETOT,SZ,SZZ,ECORE,ESCF,EERD,E1,E2,
     *                VEN,VEE,EPOT,EKIN,ESTATE(MXRT),STATN,EDFT(2),EDISP
      COMMON /IOFILE/ IR,IW,IP,IJKO,IJKT,IDAF,NAV,IODA(950)
      COMMON /DETWFN/ WSTATE(MXRT),SPINS(MXRT),CRIT,PRTTOL,SDET,SZDET,
     *                GRPDET,STSYM,GLIST,
     *                NFLGDM(MXRT),IWTS(MXRT),
     *                NCORSVDET,NCORDET,NACTDET,NORBDET,NADET,NBDET,
     *                KDET,KSTDET,IROOTDET,IPURES,MAXW1,NITERDET,
     *                MAXP,NCIDET,IGPDET,KSTSYMDET,NFTGCI
      COMMON /NSHEL / EX(MXGTOT),CS(MXGTOT),CP(MXGTOT),CD(MXGTOT),
     *                CF(MXGTOT),CG(MXGTOT),CH(MXGTOT),CI(MXGTOT),
     *                KSTART(MXSH),KATOM(MXSH),KTYPE(MXSH),KNG(MXSH),
     *                KLOC(MXSH),KMIN(MXSH),KMAX(MXSH),NSHELL
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
      COMMON /RUNLAB/ TITLE(10),ANAM(MXATM),BNAM(MXATM),BFLAB(MXAO)
      COMMON /FMCOM / X(1)
C
      PARAMETER (ZERO=0.0D+00,ONE=1.0D+00,TWO=2.0D+00)
C
      L3 = L1*L1
      NSTAT2 = NSTATS*NSTATS
C
      DO 20 ISTAT=1,NSTATS
        DO 20 JSTAT=1,NSTATS
          IG = MAX(ISTAT,JSTAT)
          JG = MIN(ISTAT,JSTAT)
          IJG = IA(IG) + JG
          IJSTAT = (ISTAT-1)*NSTATS + JSTAT
          CALL DCOPY(NXYZ,EGRAD(1,IJG),1,SAGRAD(1,IJSTAT),1)
          IF(ISTAT.NE.JSTAT) THEN
            EVAL = ESTATE(ISTAT) - ESTATE(JSTAT)
            EVAL = ONE/EVAL
            CALL DSCAL(NXYZ,EVAL,SAGRAD(1,IJSTAT),1)
          ELSE
            CALL VADD(DNUC,1,SAGRAD(1,IJSTAT),1,SAGRAD(1,IJSTAT),1,NXYZ)
          ENDIF
   20 CONTINUE
C
C     ----- Generate CI portion of non-adiabatic coupling -----
C     -----  matrix elements, noting that diagonal terms  -----
C     -----   are state-averaged MCSCF energy gradients   -----
C
      DO 100 I=1,L0
        DO 100 J=1,I
          IPHSE = INDEX(I,J)
          IROT = IABS(IPHSE)
          IF(IROT.EQ.0) GO TO 100
C
          DO 90 ISTAT=1,NSTATS
            DO 90 JSTAT=1,NSTATS
              IJSTAT = (ISTAT-1)*NSTATS + JSTAT
              EVAL = ONE
              IF(ISTAT.NE.JSTAT) EVAL = ESTATE(ISTAT) - ESTATE(JSTAT)
              DVAL = SALAG(I,J,IJSTAT) - SALAG(J,I,IJSTAT)
              DVAL = TWO*DVAL/EVAL
              IUNIQ = 0
              DO 80 IXYZ=1,NXYZ
                IF(NOCP(IXYZ).EQ.1) GO TO 80
                IUNIQ = IUNIQ + 1
                DTMP = YAO(IUNIQ,IROT)*DVAL
                SAGRAD(IXYZ,IJSTAT) = SAGRAD(IXYZ,IJSTAT) + DTMP
   80         CONTINUE
   90     CONTINUE
  100 CONTINUE
C
C     ----- Generate CSF portion of non-adiabatic coupling -----
C     -----                 matrix elements                -----
C
      L2 = (L1*L1+L1)/2
      NTOT = NCOR+NACT
      NSTATS2=(NSTATS*NSTATS+NSTATS)/2
      CALL VALFM(LOADFM)
      LXAO   = LOADFM - 1
      LYAO   = LXAO   + L2
      LZAO   = LYAO   + L2
      LXMO   = LZAO   + L2
      LYMO   = LXMO   + NTOT*NTOT
      LZMO   = LYMO   + NTOT*NTOT
      LVAO   = LZMO   + NTOT*NTOT
      LTDIP  = LVAO   + L3
      LOSC   = LTDIP  + 3*NSTATS2
      LAST   = LOSC   + NSTATS2
      NEEDTD = LAST - LOADFM - 1
      CALL GETFM(NEEDTD)
      CALL FMTDEN(TDEN,CIVEC,IFA,IOX,IWRK,NACT,NSTATS,NDETMX,NSYM,
     *            NA,NB,IIS,
     *            X(LXAO),X(LYAO),X(LZAO),X(LXMO),X(LYMO),X(LZMO),
     *            X(LVAO),X(LTDIP),X(LOSC),
     *            NCOR,NTOT,L1,L2,L3,NSTATS2,ESTATE)
      CALL RETFM(NEEDTD)
C
      DO 200 IXYZ=1,NXYZ
        DO 150 I=1,NACT
          DO 150 J=1,NACT
            SVAL = SDER(IXYZ,I+NCOR,J+NCOR)
            SVAL = SVAL/TWO
            DO 120 ISTAT=1,NSTATS
              DO 120 JSTAT=1,NSTATS
                IF(ISTAT.EQ.JSTAT) GO TO 120
                IJSTAT = (ISTAT-1)*NSTATS + JSTAT
                JISTAT = (JSTAT-1)*NSTATS + ISTAT
                DVAL = SVAL*TDEN(I,J,JISTAT)
                SAGRAD(IXYZ,IJSTAT) = SAGRAD(IXYZ,IJSTAT) - DVAL
  120       CONTINUE
  150   CONTINUE
  200 CONTINUE
C
      DO 300 MU=1,L1
        DO 300 NU=1,L1
          DO 250 ISTAT=1,NSTAT2
            DVAL = ZERO
            DO 220 I=1,NACT
              CVAL = V(MU,I+NCOR)
              DO 220 J=1,NACT
                DVAL = DVAL + CVAL*V(NU,J+NCOR)*TDEN(I,J,ISTAT)
  220       CONTINUE
            SALAG(MU,NU,ISTAT) = DVAL
  250     CONTINUE
  300 CONTINUE
C
      DO 400 M=1,3
        IF(M.EQ.1) CALL DAREAD(IDAF,IODA,WRK,L3,63,0)
        IF(M.EQ.2) CALL DAREAD(IDAF,IODA,WRK,L3,64,0)
        IF(M.EQ.3) CALL DAREAD(IDAF,IODA,WRK,L3,65,0)
        DO 360 ISHELL=1,NSHELL
          IAT  = KATOM(ISHELL)
          IXYZ = 3*(IAT-1)
          LOCI = KLOC(ISHELL) - KMIN(ISHELL)
          MINI = KMIN(ISHELL)
          MAXI = KMAX(ISHELL)
          DO 340 ISTAT=1,NSTATS
            DO 340 JSTAT=1,NSTATS
              IF(ISTAT.EQ.JSTAT) GO TO 340
              IJSTAT = (ISTAT-1)*NSTATS + JSTAT
              JISTAT = (JSTAT-1)*NSTATS + ISTAT
              DVAL = ZERO
C
              DO 320 I=MINI,MAXI
                II = LOCI + I
                DO 320 JJ=1,L1
                  IIJJ = (JJ-1)*L1 + II
                  DVAL = DVAL + SALAG(JJ,II,JISTAT)*WRK(IIJJ)
  320         CONTINUE
C
              SAGRAD(IXYZ+M,IJSTAT) = SAGRAD(IXYZ+M,IJSTAT) + DVAL
  340     CONTINUE
  360   CONTINUE
  400 CONTINUE
C
C     ----- Since we have a CASSCF wavefunction, we don't need -----
C     ----- to consider the perturbed orbital contribution to  -----
C     -----                      CSF NACME                     -----
C
C      DO ISTAT=1,NSTATS*NSTATS
C        CALL PRSQ(TDEN(1,1,ISTAT),NACT,NACT,NACT)
C      ENDDO
C
C           prints raw results:
C     IF(MASWRK) then
C        WRITE(IW,*) ' '
C        WRITE(iw,*) 'dump of THE ENTIRE NACME/SA-GRADIENT ARRAY'
C        CALL PRSQ(SAGRAD,NSTATS*NSTATS,NXYZ,NXYZ)
C     end if
C
C        process the state-specific gradients (diagonals of SAGRAD)
C
      ISTATM=0   ! COUNTS STATES MATCHING DESIRED MULTIPLICITY
      ISTAT =0   ! COUNTS SUCH STATES THAT ALSO HAVE NON-ZERO WEIGHT
      DO 500 IST=1,KDET
        IF(ABS(SPINS(IST)-SDET) .GT. 0.03D+00) GO TO 500
        ISTATM = ISTATM + 1
        IF(WSTATE(ISTATM).EQ.ZERO) GO TO 500
        ISTAT  = ISTAT  + 1
        IJSTAT = (ISTAT-1)*NSTATS + ISTAT
        CALL DCOPY(NXYZ,SAGRAD(1,IJSTAT),1,EGRAD(1,ISTAT),1)
C           save the gradient of state -iroot-
        IF(ISTAT.EQ.IRTTMP) THEN
          CALL DAWRIT(IDAF,IODA,EGRAD(1,ISTAT),NXYZ,3,0)
        ENDIF
        IF(MASWRK) THEN
           WRITE(IW,9030) ISTATM,WSTATE(ISTATM)
           NAT=NXYZ/3
           CALL EGOUT(EGRAD(1,ISTAT),NAT)
        END IF
  500 CONTINUE
C         save the sa-mcscf gradients for all states
      CALL DAWRIT(IDAF,IODA,EGRAD,NSTATS*NXYZ,491,0)
C
C        process the NACME vectors (offdiagonals of SAGRAD
C
      IF(MASWRK) WRITE(IW,9000) SDET
      IJG = 0
      ISTATM=0   ! COUNTS STATES MATCHING DESIRED MULTIPLICITY
      ISTAT =0   ! COUNTS SUCH STATES THAT ALSO HAVE NON-ZERO WEIGHT
      DO 610 IST=1,KDET
        IF(ABS(SPINS(IST)-SDET) .GT. 0.03D+00) GO TO 610
        ISTATM = ISTATM + 1
        IF(WSTATE(ISTATM).EQ.ZERO) GO TO 610
        ISTAT  = ISTAT  + 1
        JSTATM=0
        JSTAT =0
        DO 600 JST=1,IST-1
          IF(ABS(SPINS(JST)-SDET) .GT. 0.03D+00) GO TO 600
          JSTATM = JSTATM + 1
          IF(WSTATE(JSTATM).EQ.ZERO) GO TO 600
          JSTAT  = JSTAT  + 1
          IJG = IJG + 1
          IJSTAT = (ISTAT-1)*NSTATS + JSTAT
          CALL DCOPY(NXYZ,SAGRAD(1,IJSTAT),1,EGRAD(1,IJG),1)
          IF(MASWRK) THEN
             WRITE(IW,9010) ISTATM,WSTATE(ISTATM),JSTATM,WSTATE(JSTATM)
             IX=0
             NAT=NXYZ/3
             DO IAT=1,NAT
                WRITE(IW,9020) IAT,ANAM(IAT),BNAM(IAT),
     *                         (EGRAD(IX+III,IJG),III=1,3)
                IX=IX+3
             ENDDO
          END IF
  600   CONTINUE
  610 CONTINUE
C         save the nacme elements for all i>j pairs of states
      CALL DAWRIT(IDAF,IODA,EGRAD,IJG*NXYZ,492,0)
      RETURN
C
 9000 FORMAT(/1X,'NACME FOR STATE J->I HAVE OPPOSITE SIGN TO THE',
     *           ' NACME CONNECTING STATE I->J,'/
     *        1X,'SO ONLY NACME FOR I>J ARE PRINTED,',
     *        1X,'FOR STATES WITH SPIN QUANTUM NO. S=',F6.2)
 9010 FORMAT(/1X,'NONADIABATIC COUPLING MATRIX ELEMENT (NACME),',
     *           ' IN ONE/BOHR'/
     *        1X,'<STATE',I3,', WEIGHT=',F10.5,
     *           ' | D/DQ | STATE',I3,', WEIGHT=',F10.5,'>'/
     *        3X,'ATOM',15X,'D/DX',9X,'D/DY',9X,'D/DZ')
 9020 FORMAT(1X,I4,1X,A8,A2,3F13.7)
 9030 FORMAT(/1X,'STATE-SPECIFIC GRADIENT OF STATE',I4,' WEIGHT=',F10.5)
      END
C*MODULE CPMCHF  *DECK FMPAIR
      SUBROUTINE FMPAIR(INDEX,IOX,MSTA,NCOR,NACT,NUM,NQMT,NROT,NDER,
     *                  NSPACE,GENMC,NOCAS)
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      DIMENSION INDEX(NUM,NUM),IOX(NUM),MSTA(*)
      LOGICAL GENMC,NOCAS
C
C     Determine independent orbital rotations for CASSCF
C     wavefunctions
C
      NOCC = NCOR+NACT
      L3 = NUM**2
      CALL VICLR(INDEX,1,L3)
C
C     Active-core
C
      IJ=-1
      DO 100 I=NCOR+1,NOCC
        IS1 = IOX(I)
        DO 80 J=1,NCOR
          IS2 = IOX(J)
          IF((IS1.NE.IS2) .AND. (NDER.NE.2)) GO TO 80
          INDEX(J,I) = IJ
          INDEX(I,J) = IABS(IJ)
          IJ = IJ-1
   80   CONTINUE
  100 CONTINUE
C
C     Virtual-occupied
C
      DO 200 I=NOCC+1,NQMT
        IS1 = IOX(I)
        DO 180 J=1,NOCC
          IS2 = IOX(J)
          IF((IS1.NE.IS2) .AND. (NDER.NE.2)) GO TO 180
          INDEX(J,I) = IJ
          INDEX(I,J) = IABS(IJ)
          IJ = IJ-1
  180   CONTINUE
  200 CONTINUE
C
C     Active-active orbital rotations for non-CAS wavefunctions
C
      IF(GENMC .AND. NOCAS) THEN
        DO 400 II=NSPACE,1,-1
          DO 350 JJ=1,II-1
            DO 340 I=MSTA(II),MSTA(II+1)-1
              IS1 = IOX(I)
              DO 320 J=MSTA(JJ),MSTA(JJ+1)-1
                IS2 = IOX(J)
                IF((IS1.NE.IS2) .AND. (NDER.NE.2)) GO TO 320
                INDEX(J,I) = IJ
                INDEX(I,J) = IABS(IJ)
                IJ = IJ-1
  320         CONTINUE
  340       CONTINUE
  350     CONTINUE
  400   CONTINUE
      ENDIF
C
      NROT = IABS(IJ) - 1
C
      RETURN
      END
C*MODULE CPMCHF  *DECK FMRHS
      SUBROUTINE FMRHS(RHSO,RHSC,RHSS,CI,EGRAD,WSTATE,WRK,INDEX,NOCP,
     *                 NXYZ,NUNIQ,NROT,NDETLN,NOCC,L1,NFT18,NFT19,
     *                 NSTATS,JLO,JHI,NCI,NNSTAT)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      LOGICAL GOPARR,DSKWRK,MASWRK,SVDSWK
C
      DIMENSION RHSO(NUNIQ,NROT),RHSC(NUNIQ,NSTATS*NDETLN),
     *          RHSS(NUNIQ,NNSTAT),CI(NCI,NSTATS),EGRAD(NXYZ,NNSTAT),
     *          WSTATE(*),WRK(*)
      DIMENSION INDEX(L1,L1),NOCP(NXYZ)
C
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
C
      PARAMETER (TWO=2.0D+00)
C
      CALL VCLR(RHSO,1,NUNIQ*NROT)
      CALL VCLR(RHSS,1,NUNIQ*NNSTAT)
      CALL VCLR(RHSC,1,NUNIQ*NSTATS*NDETLN)
      L3 = L1*L1
      NDETS = JHI-JLO+1
C
C     ----- Form orbital part of rhs of CPMCSCF equations -----
C
      SVDSWK = DSKWRK
      DSKWRK = .FALSE.
      CALL SEQREW(NFT18)
C
      IUNIQ = 0
      DO 100 IXYZ=1,NXYZ
        CALL SQREAD(NFT18,WRK,L3)
        IF(NOCP(IXYZ).EQ.1) GO TO 100
        IUNIQ=IUNIQ+1
C
        DO 50 J=1,NOCC
          DO 50 I=1,L1
            IJ = (J-1)*L1 + I
            IPHSE = INDEX(I,J)
            IROT = IABS(IPHSE)
            IF(IROT.EQ.0) GO TO 50
            DLT = IROT
            DLT = DLT/IPHSE
            RHSO(IUNIQ,IROT) = RHSO(IUNIQ,IROT) + DLT*WRK(IJ)
   50   CONTINUE
  100 CONTINUE
      CALL DSCAL(NUNIQ*NROT,TWO,RHSO,1)
C
C     ----- Form configuration part of rhs of CPMCSCF equations -----
C
      DSKWRK = .TRUE.
      CALL SEQREW(NFT19)
      IUNIQ = 0
C
      DO 200 IXYZ=1,NXYZ
        IF(NOCP(IXYZ).EQ.1) THEN
          CALL SEQADV(NFT19)
          GO TO 200
        ENDIF
C
        IUNIQ = IUNIQ + 1
        NLEN = NSTATS*NDETLN
        CALL SQREAD(NFT19,WRK,NLEN)
        CALL DCOPY(NSTATS*NDETLN,WRK,1,RHSC(IUNIQ,1),NUNIQ)
C
        DO 150 ISTAT=1,NSTATS
          II = (ISTAT-1)*NDETLN + 1
          DO 150 JSTAT=1,NSTATS
            IG = MAX(ISTAT,JSTAT)
            JG = MIN(ISTAT,JSTAT)
            IJ = (IG*IG-IG)/2 + JG
            DVAL = EGRAD(IXYZ,IJ)
            CALL DAXPY(NDETS,-DVAL,CI(JLO,JSTAT),1,RHSC(IUNIQ,II),NUNIQ)
  150   CONTINUE
C
C     ----- Form state-state part of rhs of CPMCSCF equations -----
C
        IJSTAT = 0
        DO 180 ISTAT=1,NSTATS
          DO 180 JSTAT=1,ISTAT-1
            IJSTAT = IJSTAT + 1
            IJ = (ISTAT*ISTAT-ISTAT)/2 + JSTAT
            DVAL = WSTATE(JSTAT)-WSTATE(ISTAT)
            DVAL = TWO*DVAL
            RHSS(IUNIQ,IJSTAT) = DVAL*EGRAD(IXYZ,IJ)
  180   CONTINUE
  200 CONTINUE
C
      DO ISTAT=1,NSTATS
        IVAL = (ISTAT-1)*NDETLN + 1
        DVAL = TWO*WSTATE(ISTAT)
        CALL DSCAL(NUNIQ*NDETLN,DVAL,RHSC(1,IVAL),1)
      ENDDO
C
      DSKWRK = SVDSWK
C
      RETURN
      END
C*MODULE CPMCHF  *DECK FMRHSO
      SUBROUTINE FMRHSO(RHSO,YADEN,Y1DEN,ERI,AMAT,OINT,WRK,IROT,INDEX,
     *                  NACT,NNACT,NCOR,NXYZ,L1,NROT,NINDX)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      DIMENSION RHSO(NXYZ,NROT),YADEN(NXYZ,NACT,NACT*NNACT),
     *          Y1DEN(NXYZ,NNACT),ERI(L1,NACT,NNACT),
     *          AMAT(L1,NCOR,NNACT),WRK(NXYZ),OINT(L1,L1)
      DIMENSION IROT(L1,L1),INDEX(NINDX,NINDX)
C
      PARAMETER (ONE=1.0D+00,TWO=2.0D+00,TOL=1.0D-09)
C
      N1 = NACT*NNACT
      N2 = NXYZ*NACT
C
      DO 1000 M=1,L1
        DO 200 I=1,NACT
          IPHSE = IROT(M,I+NCOR)
          MI = IABS(IPHSE)
          IF(MI.EQ.0) GO TO 200
          DTMP = ONE*MI/IPHSE
          DO IXYZ=1,NXYZ
            WRK(IXYZ) = DDOT(N1,ERI(M,1,1),L1,YADEN(IXYZ,I,1),N2)
          ENDDO
          CALL DAXPY(NXYZ,DTMP,WRK,1,RHSO(1,MI),1)
C
          DO 100 J=1,NACT
            DVAL = OINT(M,J+NCOR)*MI/IPHSE
            IF(ABS(DVAL).LT.TOL) GO TO 100
            JI = INDEX(J,I)
            IF(I.EQ.J) DVAL = TWO*DVAL
            CALL DAXPY(NXYZ,DVAL,Y1DEN(1,JI),1,RHSO(1,MI),1)
  100     CONTINUE
  200   CONTINUE
C
        DO 400 I=1,NCOR
          IPHSE = IROT(M,I)
          MI = IABS(IPHSE)
          IF(MI.EQ.0) GO TO 400
          DO 300 K=1,NACT
            DO 300 L=1,K
              KL = INDEX(K,L)
              DVAL = AMAT(M,I,KL)*MI/IPHSE
              IF(ABS(DVAL).LT.TOL) GO TO 300
              CALL DAXPY(NXYZ,DVAL,Y1DEN(1,KL),1,RHSO(1,MI),1)
  300     CONTINUE
  400   CONTINUE
C
 1000 CONTINUE
C
      RETURN
      END
C*MODULE CPMCHF  *DECK FMTDEN
      SUBROUTINE FMTDEN(TDEN,CI,IFA,IOX,IWRK,NACT,NSTATS,NDETMX,NSYM,
     *                  NA,NB,IIS,
     *            XAO,YAO,ZAO,XMO,YMO,ZMO,VAO,TDIP,OSC,
     *            NCORE,NTOT,L1,L2,L3,NSTATS2,ESTATE)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      LOGICAL GOPARR,DSKWRK,MASWRK,DBG
C
      DIMENSION TDEN(NACT,NACT,NSTATS*NSTATS),CI(NDETMX,NSTATS)
      DIMENSION IFA(0:NACT,0:NACT),IOX(NACT),IWRK(IIS)
      DIMENSION XAO(L2),YAO(L2),ZAO(L2),VAO(L1,L1)
      DIMENSION XMO(NTOT,NTOT),YMO(NTOT,NTOT),ZMO(NTOT,NTOT)
      DIMENSION ESTATE(NSTATS)
      DIMENSION OSC(NSTATS2)
      DIMENSION TDIP(3,NSTATS2)
C
      PARAMETER (MXATM=2000)
      COMMON /INFOA / NAT,ICH,MUL,NUM,NQMT,NE,MA,MB,
     *                ZAN(MXATM),C(3,MXATM),IAN(MXATM)
C
      COMMON /IOFILE/ IR,IW,IP,IJKO,IJKT,IDAF,NAV,IODA(950)
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
      PARAMETER (DEBYE=2.541766D+00)
      PARAMETER (ZERO=0.D0,TWO=2.D0,THREE=3.D0)
      DIMENSION ITAG(3,2)
      DATA ITAG/4H   X,4H   Y,4H   Z,
     *          4HD/DX,4HD/DY,4HD/DZ/
C
      NALP = IFA(NACT,NA)
      NBLP = IFA(NACT,NB)
C
      ISYMA = 1
      ISYMB = ISYMA + NALP
      ICOA = ISYMB + NBLP
      ICOB = ICOA + NSYM
      ITAB = ICOB + NSYM
      IMUL = ITAB + NSYM
      ISPA = IMUL + NSYM*NSYM
      ISPB = ISPA + NALP
      ISAS = ISPB + NBLP
      ISBS = ISAS + NSYM+1
      ISAC = ISBS + NSYM+1
      ISBC = ISAC + NALP
C
      IACON1 = ISBC + NBLP
      IBCON1 = IACON1 + NA + 43
      IACON2 = IBCON1 + NA
      IBCON2 = IACON2 + NA
      IPOSA = IBCON2 + NB
      IPERA = IPOSA + (NA*(NACT-NA))
      IIND1 = IPERA + (NA*(NACT-NA))
      INDEX = IIND1 + (NA*(NACT-NA))
      ITOT = INDEX + NACT*NACT - 1
C
      IF (ITOT.GT.IIS) THEN
         IF(MASWRK) THEN
           WRITE(IW,*) 'NOT ENOUGH MEMORY SPECIFIED FOR IWRK'
           WRITE(IW,*) 'ASKED FOR ',IIS,' NEED ',ITOT
         END IF
         CALL ABRT
      ENDIF
C
      CALL MATTD1(TDEN,CI,NSTATS,NACT,NA,NB,NDETMX,NALP,
     *            NBLP, IFA,IOX,NSYM,IWRK(IACON1),IWRK(IBCON1),
     *            IWRK(IACON2),IWRK(IPOSA),IWRK(IPERA),IWRK(IIND1),
     *            IWRK(INDEX),IWRK(ISYMA),IWRK(ISYMB),IWRK(ISPA),
     *            IWRK(ISPB),IWRK(ISAS),IWRK(ISBS),IWRK(ISAC),
     *            IWRK(ISBC))
C
C ALL NUCLEAR CONTRIBUTIONS TO DIPOLE MOMENT
C
      CALL CALCOM(XP,YP,ZP)
      CALL DIPINT(XP,YP,ZP,.FALSE.)
      CALL DAREAD(IDAF,IODA,XAO,L2,95,0)
      CALL DAREAD(IDAF,IODA,YAO,L2,96,0)
      CALL DAREAD(IDAF,IODA,ZAO,L2,97,0)
      DMXNU=0.0D+00
      DMYNU=0.0D+00
      DMZNU=0.0D+00
      CHARGE=0.0D+00
      DO 280  I=1,NAT
         ZNUC = ZAN(I)
         CHARGE = CHARGE + ZNUC
         XN = C(1,I) - XP
         YN = C(2,I) - YP
         ZN = C(3,I) - ZP
         DMXNU = DMXNU + ZNUC*XN
         DMYNU = DMYNU + ZNUC*YN
         DMZNU = DMZNU + ZNUC*ZN
 280  CONTINUE
C
C     ----- TRANSFORM THE AO INTEGRALS TO MO INTEGRALS -----
C
      CALL DAREAD(IDAF,IODA,VAO,L3,15,0)
      IFORM=1
      DBG=.FALSE.
      CALL TMOINT(XMO,VAO,VAO,XAO,
     *            ITAG(1,IFORM),IFORM,NTOT,L1,L2,DBG)
      CALL TMOINT(YMO,VAO,VAO,YAO,
     *            ITAG(2,IFORM),IFORM,NTOT,L1,L2,DBG)
      CALL TMOINT(ZMO,VAO,VAO,ZAO,
     *            ITAG(3,IFORM),IFORM,NTOT,L1,L2,DBG)
C
C assume core contribution are the same for all states
      DMCOREX=ZERO
      DMCOREY=ZERO
      DMCOREZ=ZERO
      DO II=1,NCORE
         DMCOREX = DMCOREX - TWO*XMO(II,II)
         DMCOREY = DMCOREY - TWO*YMO(II,II)
         DMCOREZ = DMCOREZ - TWO*ZMO(II,II)
      ENDDO
C
      CALL VCLR(OSC,1,NSTATS2)
C
C the transition dipole moment
      IF(MASWRK) WRITE(IW,*)
      IF(MASWRK) WRITE(IW,*) ' --- DIPOLE MOMENTS (DEBYE) ---'
      IJ2=0
      DO JST=1,NSTATS
         DO IST=1,JST
            IJ=(IST-1)*NSTATS+JST
            IJ2=IJ2+1
            DMX=ZERO
            DMY=ZERO
            DMZ=ZERO
            DO II=1,NACT
               DO JJ=1,NACT
                  DMX = DMX - XMO(NCORE+II,NCORE+JJ)*TDEN(II,JJ,IJ)
                  DMY = DMY - YMO(NCORE+II,NCORE+JJ)*TDEN(II,JJ,IJ)
                  DMZ = DMZ - ZMO(NCORE+II,NCORE+JJ)*TDEN(II,JJ,IJ)
               ENDDO
            ENDDO
C nuclear and core moments needed for single state
            IF(IST.EQ.JST) THEN
               DMX = DMX + DMXNU + DMCOREX
               DMY = DMY + DMYNU + DMCOREY
               DMZ = DMZ + DMZNU + DMCOREZ
               DIP=SQRT(DMX*DMX+DMY*DMY+DMZ*DMZ)
               IF(MASWRK) WRITE(IW,"(I3,',',I3,' :  DIPOLE',4F12.6)")
     *            IST,JST,
     *            DMX*DEBYE,DMY*DEBYE,DMZ*DEBYE,DIP*DEBYE
            ELSE
               DIP=SQRT(DMX*DMX+DMY*DMY+DMZ*DMZ)
               OSC(IJ2)=TWO*(ESTATE(JST)-ESTATE(IST))*DIP*DIP/THREE
               IF(MASWRK) WRITE(IW,"(I3,',',I3,' : TDIPOLE',4F12.6)")
     *            IST,JST,
     *            DMX*DEBYE,DMY*DEBYE,DMZ*DEBYE,DIP*DEBYE
            ENDIF
            TDIP(1,IJ2) = DMX
            TDIP(2,IJ2) = DMY
            TDIP(3,IJ2) = DMZ
         ENDDO
      ENDDO
C
      IF(MASWRK) WRITE(IW,*)
      IF(MASWRK) WRITE(IW,*) ' --- OSCILLATOR STRENGTHS  ---'
      CALL PRTRI(OSC,NSTATS)
      IF(MASWRK) WRITE(IW,*)
C
      RETURN
      END
C*MODULE CPMCHF  *DECK GTTPDM
      SUBROUTINE GTTPDM(TPDM,XX,IX,NIJKL,NINTMX)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      LOGICAL GOPARR,DSKWRK,MASWRK,DWSAVE
C
      DIMENSION TPDM(NIJKL),XX(*),IX(*)
C
      COMMON /CIFILS/ NFT11,NFT12,NFT13,NFT14,NFT15,NFT16,IDAF20,NEMEMX
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
      COMMON /PCKLAB/ LABSIZ
C
      CALL VCLR(TPDM,1,NIJKL)
      DWSAVE = DSKWRK
      DSKWRK = .FALSE.
C
      IF(MASWRK) THEN
        CALL SEQREW(NFT15)
 2000   CONTINUE
        CALL PREAD(NFT15,XX,IX,NXX,NINTMX)
        IF(NXX.NE.0) THEN
          MGIJKL=IABS(NXX)
          IF(MGIJKL.GT.NINTMX) CALL ABRT
          DO 2100 MG=1,MGIJKL
             GGIJKL=XX(MG)
C
             NPACK = MG
             IF (LABSIZ .EQ. 2) THEN
*I32              LABEL1 = IX( 2*NPACK - 1 )
*I32              LABEL2 = IX( 2*NPACK     )
*I32              IPACK = ISHFT( LABEL1, -16 )
*I32              JPACK = IAND( LABEL1, 65535 )
*I32              KPACK = ISHFT( LABEL2, -16 )
*I32              LPACK = IAND( LABEL2, 65535 )
*I64              LABEL = IX(NPACK)
*I64              IPACK = ISHFT( LABEL, -48 )
*I64              JPACK = IAND( ISHFT( LABEL, -32 ), 65535 )
*I64              KPACK = IAND( ISHFT( LABEL, -16 ), 65535 )
*I64              LPACK = IAND( LABEL, 65535 )
              ELSE IF (LABSIZ .EQ. 1) THEN
*I32              LABEL = IX(NPACK)
*I32              IPACK = ISHFT( LABEL, -24 )
*I32              JPACK = IAND( ISHFT( LABEL, -16 ), 255 )
*I32              KPACK = IAND( ISHFT( LABEL,  -8 ), 255 )
*I32              LPACK = IAND( LABEL, 255 )
*I64              IF ( MOD(NPACK,2) .EQ. 0 ) THEN
*I64                LABEL = IX( NPACK/2 )
*I64                IPACK = IAND( ISHFT( LABEL, -24 ), 255 )
*I64                JPACK = IAND( ISHFT( LABEL, -16 ), 255 )
*I64                KPACK = IAND( ISHFT( LABEL,  -8 ), 255 )
*I64                LPACK = IAND( LABEL, 255 )
*I64            ELSE
*I64                LABEL = IX( (NPACK/2)+1 )
*I64                IPACK = ISHFT( LABEL, -56 )
*I64                JPACK = IAND( ISHFT( LABEL, -48 ), 255 )
*I64                KPACK = IAND( ISHFT( LABEL, -40 ), 255 )
*I64                LPACK = IAND( ISHFT( LABEL, -32 ), 255 )
*I64            END IF
              END IF
              IG = IPACK
              JG = JPACK
              KG = KPACK
              LG = LPACK
C
              II = MAX(IG,JG)
              JJ = MIN(IG,JG)
              IJ = (II*II-II)/2 + JJ
              KK = MAX(KG,LG)
              LL = MIN(KG,LG)
              KL = (KK*KK-KK)/2 + LL
              IJG = MAX(IJ,KL)
              KLG = MIN(IJ,KL)
              IJKL = (IJG*IJG-IJG)/2 + KLG
C
              TPDM(IJKL) = GGIJKL
 2100     CONTINUE
          IF(NXX.GT.0) GO TO 2000
        END IF
C
      ENDIF
C
      IF(GOPARR) CALL DDI_BCAST(2150,'F',TPDM,NIJKL,MASTER)
      DSKWRK = DWSAVE
C
      RETURN
      END
C*MODULE CPMCHF  *DECK HSMLTC
      SUBROUTINE HSMLTC(RHSC,RHSO,RHSS,YAO,YAC,YAS,PRCNDS,SALAG,CI,OINT,
     *                  FCOR,AMAT,ERI,IROT,IWRK,IFA,IOX,NCOR,NACT,NA,NB,
     *                  L1,L2,NSYM,IIS,NDETMX,NDETLN,NROT,NUNIQ,JLO,JHI,
     *                  NSTATS,WSTATE,WRK,YADEN,AVEC,BVEC,YAOTMP,ITER,
     *                  GENMC,LNEED,LBOX1,LBOX2,LBOX3,LBOX4,LBOX5,ITGA,
     *                  ITGB,IAST,IBST,NB1EX,JROTLO,JROTHI)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      LOGICAL GOPARR,DSKWRK,MASWRK
      LOGICAL FDIRCT,QCORR,GENMC
C
      DIMENSION RHSC(NUNIQ,NSTATS*NDETLN),RHSO(NUNIQ,NROT),
     *          RHSS(NUNIQ,*),YAO(NUNIQ,NROT),YAC(NUNIQ,NSTATS*NDETMX),
     *          YAS(NUNIQ,*),PRCNDS(*),SALAG(L1,L1,NSTATS*NSTATS),
     *          CI(NDETMX,NSTATS),OINT(L2),FCOR(L1,L1),AMAT(*),ERI(*),
     *          WSTATE(*),WRK(*),YADEN(*),AVEC(*),BVEC(*),YAOTMP(*)
      DIMENSION LBOX1(*),LBOX2(*),LBOX3(*),LBOX4(*),LBOX5(*)
      DIMENSION IROT(L1,L1),IWRK(IIS),IFA(0:NACT,0:NACT),IOX(NACT)
C
      PARAMETER (MXRT=100)
C
      COMMON /ENRGYS/ ENUCR,EELCT,ETOT,SZ,SZZ,ECORE,ESCF,EERD,E1,E2,
     *                VEN,VEE,EPOT,EKIN,ESTATE(MXRT),STATN,EDFT(2),EDISP
      COMMON /FCCWFN/ NSPACE,MSTA(51),MNUM(51),MINI(51),MAXI(51),
     *                IAMI(51),IAMA(51),IBMI(51),IBMA(51),IDIM(51),
     *                LBST(51),NREF0,FDIRCT,QCORR,C0SQ
      COMMON /FMCOM / X(1)
      COMMON /IOFILE/ IR,IW,IP,IJKO,IJKT,IDAF,NAV,IODA(950)
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
C
      PARAMETER (HALF=0.5D+00,FOUR=4.0D+00,TOL=1.0D-09)
C
      NALP = IFA(NACT,NA)
      NBLP = IFA(NACT,NB)
      NINDX = (NACT**2+NACT)/2
      IF(L1.GT.NINDX) NINDX = L1
      NNSTAT = (NSTATS*NSTATS+NSTATS)/2
      L3 = L1*L1
      NNACT = (NACT*NACT+NACT)/2
      NDETVL = JHI-JLO+1
C
      CALL VCLR(RHSC,1,NDETLN*NSTATS*NUNIQ)
      CALL VCLR(RHSS,1,NUNIQ*NNSTAT)
      CALL VCLR(YADEN,1,NUNIQ*NACT*NACT*NNACT)
C
      IF(GENMC) THEN
        IF(.NOT.FDIRCT) THEN
          IDIM1 = NSYM + 1
          IDIM2 = IBST + 1
        ELSE
          IDIM1 = 1
          IDIM2 = 1
        ENDIF
C
        LWRK = 1
        LKTAB = LWRK + 43
        LGMUL = LKTAB + NSYM
        LCON = LGMUL + NSYM*NSYM
        LCOA = LCON + NA
        LCOB = LCOA + NSYM*ITGA
        LANDET = LCOB + NSYM*ITGB
        LBNDET = LANDET + NSPACE*ITGA
        NAST = LBNDET + NSPACE*ITGB
        NBST = NAST + ITGA + 1
        LSYMA = NBST + ITGB + 1
        LSYMB = LSYMA + IAST
        LGCOM = LSYMB + IBST
        LSPA = LGCOM + ITGB*ITGA
        LSPB = LSPA + IAST
        LDISB = LSPB + IBST
        LSAS = LDISB + NSYM*ITGB*ITGA
        LSBS = LSAS + (NSYM+1)*ITGA
        LSAC = LSBS + (NSYM+1)*ITGB
        LSBC = LSAC + IAST
        LIND = LSBC + IBST
        LACON1 = LIND + NNACT + 1
        LACON2 = LACON1 + NA
        LBCON1 = LACON2 + NA
        LBCON2 = LBCON1 + NA
        IPOSA = LBCON2 + NA
        IPERA = IPOSA + NA*(NACT-NA)*NSYM
        IIND1 = IPERA + NA*(NACT-NA)*NSYM
        IIND2 = IIND1 + NA*(NACT-NA)*NSYM
        IIND3 = IIND2 + NA*(NACT-NA)*NSYM
        IGROA = IIND3 + NA*(NACT-NA)*NSYM
        IMMC = IGROA + NA*(NACT-NA)*NSYM
        INDEX2 = IMMC + NSYM
        JB1GR = INDEX2 + NINDX*NINDX
        JB1PE = JB1GR + NB1EX
        JB1IN = JB1PE + NB1EX
        JB1PO = JB1IN + NB1EX
        JB1ST = JB1PO + NB1EX
        JB1SY = JB1ST + IDIM1*IDIM2
        JB1IN2 = JB1SY + NB*(NACT-NB)
        ITOT = JB1IN2 + 2*NB1EX - 1
      ELSE
        ISYMA = 1
        ISYMB = ISYMA + NALP
        ICOA = ISYMB + NBLP
        ICOB = ICOA + NSYM
        ITAB = ICOB + NSYM
        IMUL = ITAB + NSYM
        ISPA = IMUL + NSYM*NSYM
        ISPB = ISPA + NALP
        ISAS = ISPB + NBLP
        ISBS = ISAS + NSYM+1
        ISAC = ISBS + NSYM+1
        ISBC = ISAC + NALP
C
        IACON1 = ISBC + NBLP
        IBCON1 = IACON1 + NA + 43
        IACON2 = IBCON1 + NA
        IBCON2 = IACON2 + NA
        IPOSA = IBCON2 + NB
        IPERA = IPOSA + (NA*(NACT-NA))
        IIND1 = IPERA + (NA*(NACT-NA))
        INDEX = IIND1 + 3*(NA*(NACT-NA))
        IMMA = INDEX + NINDX**2
        IMMC = IMMA + NSYM*(NA*(NACT-NA))
        ISTRB = IMMC + NSYM
        ISTRP = ISTRB + ((NB*(NACT-NB))*NBLP)/2
        ISTAR = ISTRP + ((NB*(NACT-NB))*NBLP)/2
        ITOT = ISTAR + NBLP - 1
C
        CALL SETUP(NACT,0,NA,NB,IWRK(IBCON1),
     *             IWRK(IACON2),IFA,IWRK(INDEX),IWRK(ISPB),NBLP,
     *             IWRK(ISTRB),IWRK(ISTRP),IWRK(ISTAR))
      ENDIF
C
      IF(ITOT.GT.IIS) THEN
        IF(MASWRK) THEN
          WRITE(IW,*) 'NOT ENOUGH MEMORY SPECIFIED FOR IWRK'
          WRITE(IW,*) 'ASKED FOR ',IIS,' NEED ',ITOT
        END IF
        CALL ABRT
      END IF
C
C     ----- Calculate terms independent of coupling constants -----
C
      DHCME = ENUCR
      DO I=1,NCOR
        II = (I*I+I)/2
        DHCME = DHCME + OINT(II) + FCOR(I,I)
      ENDDO
C
      IF(NSTATS.GT.1 .AND. ITER.EQ.1) THEN
        CALL VCLR(SALAG,1,L3*NSTATS*NSTATS)
C
        DO 200 M=JLO,JHI
          DO 150 ISTAT=1,NSTATS
            CVAL = CI(M,ISTAT)
            IF(ABS(CVAL).LT.TOL) GO TO 150
            DO 100 I=1,L1
              DO 100 J=1,NCOR
                IPHSE = IROT(I,J)
                IF(IPHSE.EQ.0) GO TO 100
                DVAL = FOUR*CVAL
                DVAL = DVAL*FCOR(I,J)
                DO JSTAT=1,NSTATS
                  DTMP = DVAL*CI(M,JSTAT)
                  IJSTAT = (ISTAT-1)*NSTATS + JSTAT
                  SALAG(I,J,IJSTAT) = SALAG(I,J,IJSTAT) + DTMP
                ENDDO
  100       CONTINUE
  150     CONTINUE
  200   CONTINUE
      ENDIF
C
C          ----- Configuation/Orbital Cross Terms -----
C
      CALL VCLR(WRK,1,2*NUNIQ)
      DO 300 ISTAT=1,NSTATS
        WVAL = WSTATE(ISTAT)
        IYM = (ISTAT-1)*NDETMX + JLO
        DO IUNIQ=1,NUNIQ
          DVAL = DDOT(NDETVL,CI(JLO,ISTAT),1,YAC(IUNIQ,IYM),NUNIQ)
          WRK(NUNIQ+IUNIQ) = WRK(NUNIQ+IUNIQ) + DVAL*WVAL
        ENDDO
  300 CONTINUE
C
      DO 400 I=1,L1
        DO 400 J=1,NCOR
          IPHSE = IROT(I,J)
          IJ = IABS(IPHSE)
          IF(IJ.EQ.0) GO TO 400
          DVAL = FOUR*IJ/IPHSE
          DVAL = DVAL*FCOR(I,J)
          CALL DAXPY(NUNIQ,DVAL,YAO(1,IJ),1,WRK,1)
          CALL DAXPY(NUNIQ,DVAL,WRK(NUNIQ+1),1,RHSO(1,IJ),1)
  400 CONTINUE
C
      DO 450 ISTAT=1,NSTATS
        WVAL = WSTATE(ISTAT)
        IWM = (ISTAT-1)*NDETLN + 1
        DO IUNIQ=1,NUNIQ
          DVAL = WVAL*WRK(IUNIQ)
          CALL DAXPY(NDETVL,DVAL,CI(JLO,ISTAT),1,RHSC(IUNIQ,IWM),NUNIQ)
        ENDDO
  450 CONTINUE
C
C     ----- Configuation Hessian Terms -----
C
      DO 500 ISTAT=1,NSTATS
        WVAL = WSTATE(ISTAT)
        IM = (ISTAT-1)*NDETLN + 1
        HVAL = WVAL*(DHCME-ESTATE(ISTAT))
        IYM = (ISTAT-1)*NDETMX
        DO 500 JSTAT=1,NSTATS
          DVAL = ESTATE(ISTAT) - ESTATE(JSTAT)
          DVAL = DVAL*WVAL
          DVAL = DVAL + HALF
          DO IUNIQ=1,NUNIQ
            DTMP = DDOT(NDETMX,CI(1,JSTAT),1,YAC(IUNIQ,IYM+1),NUNIQ)
            DTMP = DTMP*DVAL
            CALL DAXPY(NDETVL,DTMP,CI(JLO,JSTAT),1,RHSC(IUNIQ,IM),NUNIQ)
            IF(ISTAT.EQ.JSTAT) THEN
              CALL DAXPY(NDETVL,HVAL,YAC(IUNIQ,IYM+JLO),NUNIQ,
     *                   RHSC(IUNIQ,IM),NUNIQ)
            ENDIF
          ENDDO
  500 CONTINUE
C
C     ----- Calculate terms dependent on coupling constants -----
C
      CALL HSSCXO(YAOTMP,YAO,ERI,IROT,NUNIQ,NACT,NCOR,NNACT,NROT,L1,
     *            JROTLO,JROTHI,GOPARR)
C
      IF(GENMC) THEN
        CALL HSSCX1(AVEC,YAC,YAO,AMAT,FCOR,IROT,IWRK(INDEX2),BVEC,RHSC,
     *              RHSO,YADEN,ERI,WRK(NUNIQ+1),WRK,YAOTMP,WSTATE,SALAG,
     *              CI,NCOR,JLO,JHI,NSTATS,NDETLN,ITER,NINDX,NROT,
     *              NUNIQ,L1,NACT,NDETMX,NA,NB,X(LBST(1)),LNEED,
     *              IWRK(LIND),NSYM,IOX,LBOX1,LBOX2,LBOX3,LBOX4,LBOX5,
     *              IWRK(LGMUL),IWRK(LKTAB),IWRK(LACON1),IWRK(LACON2),
     *              IWRK(LBCON1),IWRK(LBCON2),IWRK(LANDET),IWRK(LBNDET),
     *              IWRK(NAST),IWRK(NBST),IWRK(LSYMA),IWRK(LSYMB),
     *              IWRK(LGCOM),IWRK(LSPA),IWRK(LSPB),IWRK(LDISB),
     *              IWRK(LSAS),IWRK(LSBS),IWRK(LSAC),IWRK(LSBC),ITGA,
     *              ITGB,IAST,IBST,IWRK(IPOSA),IWRK(IPERA),IWRK(IIND1),
     *              IWRK(IGROA),IWRK(IMMC),NB1EX,IWRK(JB1GR),
     *              IWRK(JB1PE),IWRK(JB1IN),IWRK(JB1PO),IWRK(JB1ST),
     *              IWRK(JB1IN2),IWRK(IIND2),IWRK(IIND3),IDIM1,IDIM2,
     *              JROTLO,JROTHI)
      ELSE
        CALL HSSCX2(NACT,NCOR,NA,NB,NALP,NBLP,IFA,IOX,NSYM,IWRK(IACON1),
     *              IWRK(IBCON1),IWRK(IACON2),IWRK(IPOSA),IWRK(IPERA),
     *              IWRK(IIND1),IWRK(INDEX),IWRK(IMMA),IWRK(IMMC),
     *              IWRK(ISYMA),IWRK(ISYMB),IWRK(ITAB),IWRK(IMUL),
     *              IWRK(ISPA),IWRK(ISPB),IWRK(ISAS),IWRK(ISBS),
     *              IWRK(ISAC),IWRK(ISBC),IWRK(ISTRB),IWRK(ISTRP),
     *              IWRK(ISTAR),CI,FCOR,AMAT,ERI,L1,NROT,NDETMX,
     *              IROT,RHSC,RHSO,YAO,YAC,NDETLN,NUNIQ,NINDX,JLO,JHI,
     *              NSTATS,WSTATE,SALAG,WRK,WRK(NUNIQ+1),YADEN,AVEC,
     *              BVEC,YAOTMP,ITER,JROTLO,JROTHI)
      ENDIF
C
C     ----- Finish with Lagrangian terms if SAMC -----
C
      IF(NSTATS.EQ.1) GO TO 2000
C
      IF(ITER.EQ.1) THEN
        CALL DSCAL(L3*NSTATS*NSTATS,HALF,SALAG,1)
        IF(GOPARR) CALL DDI_GSUMF(2174,SALAG,L3*NSTATS*NSTATS)
      ENDIF
C
      CALL VCLR(WRK,1,2*NUNIQ)
      DO 600 ISTAT=1,NSTATS
        DO 600 JSTAT=1,NSTATS
          JY = (JSTAT-1)*NDETMX + JLO
          WVAL = WSTATE(JSTAT)
          DO IUNIQ=1,NUNIQ
            DLT = DDOT(NDETVL,CI(JLO,ISTAT),1,YAC(IUNIQ,JY),NUNIQ)
            WRK(IUNIQ) = -DLT*WVAL
          ENDDO
C
          IJSTAT = (ISTAT-1)*NSTATS + JSTAT
          JISTAT = (JSTAT-1)*NSTATS + ISTAT
          DO 550 I=1,L1
            DO 550 J=1,I
             IPHSE = IROT(I,J)
             IF(IPHSE.EQ.0) GO TO 550
             IJ = IABS(IPHSE)
             DVAL = SALAG(I,J,IJSTAT) + SALAG(I,J,JISTAT)
             DVAL = DVAL - SALAG(J,I,IJSTAT) - SALAG(J,I,JISTAT)
             CALL DAXPY(NUNIQ,DVAL,WRK,1,RHSO(1,IJ),1)
C
             CALL DAXPY(NUNIQ,DVAL,YAO(1,IJ),1,WRK(NUNIQ+1),1)
  550     CONTINUE
C
          CALL DSCAL(NUNIQ,-WVAL,WRK(NUNIQ+1),1)
          JW = (JSTAT-1)*NDETLN + 1
          DO IUNIQ=1,NUNIQ
            DVAL = WRK(NUNIQ+IUNIQ)
            CALL DAXPY(NDETVL,DVAL,CI(JLO,ISTAT),1,RHSC(IUNIQ,JW),NUNIQ)
          ENDDO
  600 CONTINUE
C
C          ----- State-orbital contribution -----
C
      DO 700 I=1,L1
        DO 700 J=1,I
          IPHSE = IROT(I,J)
          IF(IPHSE.EQ.0) GO TO 700
          IJ = IABS(IPHSE)
          IJVAL = 0
          DO 650 ISTAT=1,NSTATS
            DO 620 JSTAT=1,ISTAT-1
              IJVAL = IJVAL + 1
              IJSTAT = (ISTAT-1)*NSTATS + JSTAT
              JISTAT = (JSTAT-1)*NSTATS + ISTAT
              WVAL = WSTATE(JSTAT) - WSTATE(ISTAT)
              DVAL = SALAG(I,J,IJSTAT) + SALAG(I,J,JISTAT)
              DVAL = DVAL - SALAG(J,I,IJSTAT) - SALAG(J,I,JISTAT)
              DVAL = WVAL*DVAL
              CALL DAXPY(NUNIQ,DVAL,YAO(1,IJ),1,RHSS(1,IJVAL),1)
              IF(MASWRK) THEN
                CALL DAXPY(NUNIQ,DVAL,YAS(1,IJVAL),1,RHSO(1,IJ),1)
              ENDIF
  620       CONTINUE
  650     CONTINUE
  700 CONTINUE
C
C     ----- Add state-state hessian contribution -----
C
      IJSTAT = 0
      DO 1000 ISTAT=1,NSTATS
        DO 1000 JSTAT=1,ISTAT-1
          IJSTAT = IJSTAT + 1
          DVAL = HALF*PRCNDS(IJSTAT)
          CALL DAXPY(NUNIQ,DVAL,YAS(1,IJSTAT),1,RHSS(1,IJSTAT),1)
 1000 CONTINUE
C
 2000 CONTINUE
      RETURN
      END
C*MODULE CPMCHF  *DECK HSMLTN
      SUBROUTINE HSMLTN(YAOG,YAO,I,J,K,L,IJ,KL,NACT,NNACT,NXYZ,DPHSE)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      DIMENSION YAOG(NXYZ),YAO(NXYZ,NACT*NACT,NNACT)
C
      PARAMETER (TWO=2.0D+00)
C
      IIJJ = (J-1)*NACT + I
      DLT = DPHSE
      IF(I.EQ.J) DLT = TWO*DLT
      IF(IJ.EQ.KL) DLT = TWO*DLT
      CALL DAXPY(NXYZ,DLT,YAO(1,IIJJ,KL),1,YAOG,1)
C
      IF(I.EQ.J) GO TO 200
      JJII = (I-1)*NACT + J
      DLT = DPHSE
      IF(IJ.EQ.KL) DLT = TWO*DLT
      CALL DAXPY(NXYZ,DLT,YAO(1,JJII,KL),1,YAOG,1)
C
  200 IF(IJ.EQ.KL) RETURN
      KKLL = (L-1)*NACT + K
      DLT = DPHSE
      IF(K.EQ.L) DLT = TWO*DLT
      CALL DAXPY(NXYZ,DLT,YAO(1,KKLL,IJ),1,YAOG,1)
C
      IF(K.EQ.L) RETURN
      LLKK = (K-1)*NACT + L
      DLT = DPHSE
      CALL DAXPY(NXYZ,DLT,YAO(1,LLKK,IJ),1,YAOG,1)
C
      RETURN
      END
C*MODULE CPMCHF  *DECK HSMLTP
      SUBROUTINE HSMLTP(RHSO,YAO,OINT,EPS,OPDM,TPDM,BUFF,INDEX,IA,
     *                  NROT,NUNIQ,NCOR,NACT,L0,L1,L2)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      INTEGER         C_OOOO, C_VOOO, C_VVOO, C_VOVO
      LOGICAL GOPARR,DSKWRK,MASWRK
C
      DIMENSION RHSO(NUNIQ,NROT),YAO(NUNIQ,NROT),OINT(L2),EPS(L1,L1),
     *          OPDM(*),TPDM(*),BUFF(*)
      DIMENSION INDEX(L1,L1),IA(*)
C
      COMMON /DLBTIM/ C_OOOO,C_VOOO,C_VVOO,C_VOVO
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
C
      INTEGER         D_OOOO,D_VOOO,D_VVOO,D_VOVO,D_VVVO,D_VVVV,
     *                D_OOOOAB,D_OOOOBB,D_VOOOAB,D_VOOOBA,D_VOOOBB,
     *                D_VVOOAB,D_VVOOBA,D_VVOOBB,D_VOVOAB,D_VOVOBB,
     *                D_U,D_UB,D_E,D_EB
      LOGICAL         NDOOOO,NDVOOO,NDVVOO,NDVOVO,NDVVVO,NDVVVV,NDCORE,
     *                NDVVOOBA,NDVVOOAB,NDVVOOBB,NDVOVOAB,NDVOVOBB,
     *                NDVOOOBA,NDVOOOAB,NDVOOOBB,NDOOOOAB,NDOOOOBB
      COMMON /TRFDMS/ D_OOOO,D_VOOO,D_VVOO,D_VOVO,D_VVVO,D_VVVV,
     *                D_OOOOAB,D_OOOOBB,D_VOOOAB,D_VOOOBA,D_VOOOBB,
     *                D_VVOOAB,D_VVOOBA,D_VVOOBB,D_VOVOAB,D_VOVOBB,
     *                D_U,D_UB,D_E,D_EB,
     *                NDOOOO,NDVOOO,NDVVOO,NDVOVO,NDVVVO,NDVVVV,NDCORE,
     *                NDVVOOBA,NDVVOOAB,NDVVOOBB,NDVOVOAB,NDVOVOBB,
     *                NDVOOOBA,NDVOOOAB,NDVOOOBB,NDOOOOAB,NDOOOOBB
C
      PARAMETER (ZERO=0.0D+00,ONE=1.0D+00,TWO=2.0D+00,FOUR=4.0D+00)
      PARAMETER (HALF=0.5D+00,TOL=1.0D-09)
C
      NOCC = NACT + NCOR
      NOTR = (NOCC*NOCC+NOCC)/2
      IVAL = (L1-NOCC)*L1
C
      NVIR = L0 - NOCC
C
      NBVIR = L0 - NOCC
      NBTR = (NBVIR*NBVIR+NBVIR)/2
      NBSQ = NBVIR*NBVIR
C
      CALL VCLR(BUFF,1,L2)
      CALL VCLR(EPS(1,NOCC+1),1,IVAL)
      CALL VCLR(RHSO,1,NROT*NUNIQ)
C
C     ----- Construct full one-particle density matrix -----
C
      DO I=1,NCOR
        II = IA(I) + I
        BUFF(II) = TWO
      ENDDO
C
      DO 10 I=NCOR+1,NOCC
        DO 10 J=NCOR+1,I
          IJ = IA(I) + J
          IIJJ = IA(I-NCOR) + J-NCOR
          BUFF(IJ) = OPDM(IIJJ)
   10 CONTINUE
C
C     ----- Construct one-electron contribution to orbital hessian -----
C
      IF(MASWRK) THEN
        DO 30 K=1,L0
          DO 30 L=1,K
            KL = IABS(INDEX(K,L))
            IF(KL.EQ.0) GO TO 30
C
            DO 20 I=1,L0
              IG = MAX(I,K)
              KG = MIN(I,K)
              IK = IA(IG)+KG
              IG = MAX(I,L)
              LG = MIN(I,L)
              IL = IA(IG)+LG
              DO 20 J=1,I
                IJ = IABS(INDEX(I,J))
                IF(IJ.EQ.0) GO TO 20
                JG = MAX(J,K)
                KG = MIN(J,K)
                JK = IA(JG)+KG
                JG = MAX(J,L)
                LG = MIN(J,L)
                JL = IA(JG)+LG
C
                DVAL = ZERO
                DVAL = DVAL + OINT(IK)*BUFF(JL)
                DVAL = DVAL + OINT(JL)*BUFF(IK)
                DVAL = DVAL - OINT(JK)*BUFF(IL)
                DVAL = DVAL - OINT(IL)*BUFF(JK)
                IF((I.EQ.L).AND.(K.LE.NOCC)) DVAL = DVAL + EPS(J,K)
                IF(J.EQ.K) DVAL = DVAL + EPS(I,L)
                IF(I.EQ.K) DVAL = DVAL - EPS(J,L)
                IF((J.EQ.L).AND.(K.LE.NOCC)) DVAL = DVAL - EPS(I,K)
C
                CALL DAXPY(NUNIQ,DVAL,YAO(1,KL),1,RHSO(1,IJ),1)
   20       CONTINUE
   30   CONTINUE
      ENDIF
C
C     ----- Construct two-electron part of orbital hessian -----
C
      IP = 0
      CALL TSECND(T0)
      DO 8000 IP=0,NPROC-1
        IWP = MOD(ME+IP,NPROC)
C
C     ----- Get and use (OO|OO) integrals -----
C
        CALL DDI_DISTRIB(D_OOOO,IWP,ILO,IHI,JLO,JHI)
        MAXWRK = JHI-JLO+1
C
        CALL DDI_PROCDLB_NEXT(C_OOOO,IWP,ICNTR1)
C
        DO WHILE(ICNTR1.LT.MAXWRK)
          IJ = JLO + ICNTR1
C
          DO II=1,NOCC
            DO JJ=1,II
              IJTMP = IA(II) + JJ
              IF(IJTMP.EQ.IJ) THEN
                I = II
                J = JJ
                GO TO 40
              ENDIF
            ENDDO
          ENDDO
C
   40     CALL DDI_GET(D_OOOO,1,NOTR,IJ,IJ,BUFF)
C
C          ----- Coulomb contribution to orbital hessian -----
C          -----       Inner indices are both core       -----
C
          DO 100 N=1,NCOR
            JNG = IABS(INDEX(J,N))
            IF(JNG.EQ.0) GO TO 70
            DO 60 M=1,NCOR
              IMG = IABS(INDEX(I,M))
              IF(IMG.EQ.0) GO TO 60
              MG = MAX(M,N)
              NG = MIN(M,N)
              MN = IA(MG) + NG
C
              DVAL = ZERO
              IF(M.EQ.N) THEN
                DO K=1,NCOR
                  KK = IA(K) + K
                  DVAL = DVAL + BUFF(KK)
                ENDDO
                DVAL = DVAL*TWO
C
                DO 50 K=1,NACT
                  DO 50 L=1,K
                    KL = IA(K+NCOR) + L+NCOR
                    XIJKL = BUFF(KL)
                    IF(K.NE.L) XIJKL = TWO*XIJKL
                    KL = IA(K) + L
                    DVAL = DVAL + OPDM(KL)*XIJKL
   50           CONTINUE
              ENDIF
C
              DVAL = DVAL - BUFF(MN)
              DVAL = DVAL*TWO
              IF(N.GT.J) DVAL = -DVAL
              IF(M.GT.I) DVAL = -DVAL
              CALL DAXPY(NUNIQ,DVAL,YAO(1,JNG),1,RHSO(1,IMG),1)
   60       CONTINUE
C
   70       IF(I.EQ.J) GO TO 100
            ING = IABS(INDEX(I,N))
            IF(ING.EQ.0) GO TO 100
            DO 90 M=1,NCOR
              JMG = IABS(INDEX(J,M))
              IF(JMG.EQ.0) GO TO 90
              MG = MAX(M,N)
              NG = MIN(M,N)
              MN = IA(MG) + NG
C
              DVAL = ZERO
              IF(M.EQ.N) THEN
                DO K=1,NCOR
                  KK = IA(K) + K
                  DVAL = DVAL + BUFF(KK)
                ENDDO
                DVAL = DVAL*TWO
C
                DO 80 K=1,NACT
                  DO 80 L=1,K
                    KL = IA(K+NCOR) + L+NCOR
                    XIJKL = BUFF(KL)
                    IF(K.NE.L) XIJKL = TWO*XIJKL
                    KL = IA(K) + L
                    DVAL = DVAL + OPDM(KL)*XIJKL
   80           CONTINUE
              ENDIF
C
              DVAL = DVAL - BUFF(MN)
              DVAL = TWO*DVAL
              IF(N.GT.I) DVAL = -DVAL
              IF(M.GT.J) DVAL = -DVAL
              CALL DAXPY(NUNIQ,DVAL,YAO(1,ING),1,RHSO(1,JMG),1)
   90       CONTINUE
  100     CONTINUE
C
C          ----- Coulomb contribution to orbital hessian -----
C          -----    One core index, one active index     -----
C
          DO 200 N=1,NCOR
            JNG = IABS(INDEX(J,N))
            IF(JNG.EQ.0) GO TO 150
            DO 120 M=1,NACT
              IMG = IABS(INDEX(I,M+NCOR))
              IF(IMG.EQ.0) GO TO 120
              DO K=1,NACT
                KN = IA(K+NCOR) + N
                XIJKL = BUFF(KN)
                KG = MAX(K,M)
                MG = MIN(K,M)
                KM = IA(KG) + MG
                IF(N.GT.J) XIJKL = -XIJKL
                IF((M+NCOR).GT.I) XIJKL = -XIJKL
                DVAL = XIJKL*OPDM(KM)
                CALL DAXPY(NUNIQ,-DVAL,YAO(1,JNG),1,RHSO(1,IMG),1)
                CALL DAXPY(NUNIQ,-DVAL,YAO(1,IMG),1,RHSO(1,JNG),1)
              ENDDO
  120       CONTINUE
C
  150       ING = IABS(INDEX(I,N))
            IF(ING.EQ.0) GO TO 200
            DO 170 M=1,NACT
              JMG = IABS(INDEX(J,M+NCOR))
              IF(JMG.EQ.0) GO TO 170
              DO K=1,NACT
                KN = IA(K+NCOR) + N
                XIJKL = BUFF(KN)
                KG = MAX(K,M)
                MG = MIN(K,M)
                KM = IA(KG) + MG
                IF(N.GT.I) XIJKL = -XIJKL
                IF((M+NCOR).GT.J) XIJKL = -XIJKL
                DVAL = XIJKL*OPDM(KM)
                CALL DAXPY(NUNIQ,-DVAL,YAO(1,JMG),1,RHSO(1,ING),1)
                CALL DAXPY(NUNIQ,-DVAL,YAO(1,ING),1,RHSO(1,JMG),1)
              ENDDO
  170       CONTINUE
  200     CONTINUE
C
C          ----- Coulomb contribution to orbital hessian -----
C          -----      Inner indices are both active      -----
C
          DO 300 N=1,NACT
            JNG = IABS(INDEX(J,N+NCOR))
            IF(JNG.EQ.0) GO TO 250
            DO 240 M=1,NACT
              IMG = IABS(INDEX(I,M+NCOR))
              IF(IMG.EQ.0) GO TO 240
              MG = MAX(M,N)
              NG = MIN(M,N)
              MN = IA(MG) + NG
C
              DVAL = ZERO
              DO K=1,NCOR
                KK = IA(K) + K
                DVAL = DVAL + BUFF(KK)
              ENDDO
              DVAL = TWO*DVAL
              DVAL = OPDM(MN)*DVAL
C
              DO 220 K=1,NACT
                DO 210 L=1,K
                  KL = IA(K+NCOR) + L+NCOR
                  XIJKL = BUFF(KL)
                  IF(ABS(XIJKL).LT.TOL) GO TO 210
                  IF(K.NE.L) XIJKL = TWO*XIJKL
                  KL = IA(K) + L
                  MNG = MAX(MN,KL)
                  KLG = MIN(MN,KL)
                  MNKL = IA(MNG) + KLG
                  DVAL = DVAL + TPDM(MNKL)*XIJKL
  210           CONTINUE
  220         CONTINUE
C
              IF((N+NCOR).GT.J) DVAL = -DVAL
              IF((M+NCOR).GT.I) DVAL = -DVAL
              CALL DAXPY(NUNIQ,DVAL,YAO(1,JNG),1,RHSO(1,IMG),1)
  240       CONTINUE
C
  250       IF(I.EQ.J) GO TO 300
            ING = IABS(INDEX(I,N+NCOR))
            IF(ING.EQ.0) GO TO 300
            DO 290 M=1,NACT
              JMG = IABS(INDEX(J,M+NCOR))
              IF(JMG.EQ.0) GO TO 290
              MG = MAX(M,N)
              NG = MIN(M,N)
              MN = IA(MG) + NG
C
              DVAL = ZERO
              DO K=1,NCOR
                KK = IA(K) + K
                DVAL = DVAL + BUFF(KK)
              ENDDO
              DVAL = TWO*DVAL
              DVAL = OPDM(MN)*DVAL
C
              DO 270 K=1,NACT
                DO 270 L=1,K
                  KL = IA(K+NCOR) + L+NCOR
                  XIJKL = BUFF(KL)
                  IF(ABS(XIJKL).LT.TOL) GO TO 260
                  IF(K.NE.L) XIJKL = TWO*XIJKL
                  KL = IA(K) + L
                  MNG = MAX(MN,KL)
                  KLG = MIN(MN,KL)
                  MNKL = IA(MNG) + KLG
                  DVAL = DVAL + TPDM(MNKL)*XIJKL
  260           CONTINUE
  270         CONTINUE
C
              IF((N+NCOR).GT.I) DVAL = -DVAL
              IF((M+NCOR).GT.J) DVAL = -DVAL
              CALL DAXPY(NUNIQ,DVAL,YAO(1,ING),1,RHSO(1,JMG),1)
  290       CONTINUE
  300     CONTINUE
C
C          ----- Exchange contribution to orbital hessian -----
C          -----      First summation index over core     -----
C
          IF(J.GT.NCOR) GO TO 610
          DO 500 K=1,NOCC
            DO 450 L=1,NCOR
              KG = MAX(K,L)
              LG = MIN(K,L)
              KL = IA(KG) + LG
              XIJKL = BUFF(KL)
              IF(ABS(XIJKL).LT.TOL) GO TO 450
C
              IMG = IABS(INDEX(I,J))
              KNG = IABS(INDEX(K,L))
              IF((IMG.NE.0) .AND. (KNG.NE.0)) THEN
                DVAL = TWO*FOUR*XIJKL
                IF(J.GT.I) DVAL = -DVAL
                IF(L.GT.K) DVAL = -DVAL
                CALL DAXPY(NUNIQ,DVAL,YAO(1,KNG),1,RHSO(1,IMG),1)
              ENDIF
C
              IMG = IABS(INDEX(I,L))
              KNG = IABS(INDEX(K,J))
              IF((IMG.NE.0) .AND. (KNG.NE.0)) THEN
                DVAL = TWO*XIJKL
                IF(L.GT.I) DVAL = -DVAL
                IF(J.GT.K) DVAL = -DVAL
                CALL DAXPY(NUNIQ,-DVAL,YAO(1,KNG),1,RHSO(1,IMG),1)
              ENDIF
C
              IF(J.EQ.L) THEN
                DO 400 M=1,NCOR
                  IMG = IABS(INDEX(I,M))
                  KMG = IABS(INDEX(K,M))
                  IF((IMG.EQ.0) .OR. (KMG.EQ.0)) GO TO 400
                  DVAL = TWO*XIJKL
                  IF(M.GT.I) DVAL = -DVAL
                  IF(M.GT.K) DVAL = -DVAL
                  CALL DAXPY(NUNIQ,-DVAL,YAO(1,KMG),1,RHSO(1,IMG),1)
  400           CONTINUE
C
                DO 440 M=1,NACT
                  IMG = IABS(INDEX(I,M+NCOR))
                  IF(IMG.EQ.0) GO TO 440
                  DO 430 N=1,NACT
                    KNG = IABS(INDEX(K,N+NCOR))
                    IF(KNG.EQ.0) GO TO 430
                    MG = MAX(M,N)
                    NG = MIN(M,N)
                    MN = IA(MG) + NG
                    DVAL = OPDM(MN)*XIJKL
                    IF((M+NCOR).GT.I) DVAL = -DVAL
                    IF((N+NCOR).GT.K) DVAL = -DVAL
                    CALL DAXPY(NUNIQ,-DVAL,YAO(1,KNG),1,RHSO(1,IMG),1)
  430             CONTINUE
  440           CONTINUE
              ENDIF
  450       CONTINUE
C
            DO 490 L=1,NACT
              KG = MAX(K,L+NCOR)
              LG = MIN(K,L+NCOR)
              KL = IA(KG) + LG
              XIJKL = BUFF(KL)
              IF(ABS(XIJKL).LT.TOL) GO TO 490
C
              IMG = IABS(INDEX(I,J))
              IF(IMG.NE.0) THEN
                DO 460 N=1,NACT
                  KNG = IABS(INDEX(K,N+NCOR))
                  IF(KNG.EQ.0) GO TO 460
                  LG = MAX(L,N)
                  NG = MIN(L,N)
                  LN = IA(LG) + NG
                  DVAL = OPDM(LN)*XIJKL
                  DVAL = FOUR*DVAL
                  IF(J.GT.I) DVAL = -DVAL
                  IF((N+NCOR).GT.K) DVAL = -DVAL
                  CALL DAXPY(NUNIQ,DVAL,YAO(1,KNG),1,RHSO(1,IMG),1)
  460           CONTINUE
              ENDIF
C
              KNG = IABS(INDEX(K,J))
              IF(KNG.NE.0) THEN
                DO 470 M=1,NACT
                  IMG = IABS(INDEX(I,M+NCOR))
                  IF(IMG.EQ.0) GO TO 470
                  LG = MAX(L,M)
                  MG = MIN(L,M)
                  LM = IA(LG) + MG
                  DVAL = OPDM(LM)*XIJKL
                  IF(J.GT.K) DVAL = -DVAL
                  IF((M+NCOR).GT.I) DVAL = -DVAL
                  CALL DAXPY(NUNIQ,-DVAL,YAO(1,KNG),1,RHSO(1,IMG),1)
  470           CONTINUE
              ENDIF
  490       CONTINUE
  500     CONTINUE
C
          IF((I.EQ.J) .OR. (I.GT.NCOR)) GO TO 610
          DO 600 K=1,NOCC
            DO 550 L=1,NCOR
              KG = MAX(K,L)
              LG = MIN(K,L)
              KL = IA(KG) + LG
              XIJKL = BUFF(KL)
              IF(ABS(XIJKL).LT.TOL) GO TO 550
C
              JMG = IABS(INDEX(J,I))
              KNG = IABS(INDEX(K,L))
              IF((JMG.NE.0) .AND. (KNG.NE.0)) THEN
                DVAL = TWO*FOUR*XIJKL
                IF(I.GT.J) DVAL = -DVAL
                IF(L.GT.K) DVAL = -DVAL
                CALL DAXPY(NUNIQ,DVAL,YAO(1,KNG),1,RHSO(1,JMG),1)
              ENDIF
C
              JMG = IABS(INDEX(J,L))
              KNG = IABS(INDEX(K,I))
              IF((JMG.NE.0) .AND. (KNG.NE.0)) THEN
                DVAL = TWO*XIJKL
                IF(L.GT.J) DVAL = -DVAL
                IF(I.GT.K) DVAL = -DVAL
                CALL DAXPY(NUNIQ,-DVAL,YAO(1,KNG),1,RHSO(1,JMG),1)
              ENDIF
C
              IF(I.EQ.L) THEN
                DO 510 M=1,NCOR
                  JMG = IABS(INDEX(J,M))
                  KMG = IABS(INDEX(K,M))
                  IF((JMG.EQ.0) .OR. (KMG.EQ.0)) GO TO 510
                  DVAL = TWO*XIJKL
                  IF(M.GT.J) DVAL = -DVAL
                  IF(M.GT.K) DVAL = -DVAL
                  CALL DAXPY(NUNIQ,-DVAL,YAO(1,KMG),1,RHSO(1,JMG),1)
  510           CONTINUE
C
                DO 540 M=1,NACT
                  JMG = IABS(INDEX(J,M+NCOR))
                  IF(JMG.EQ.0) GO TO 540
                  DO 530 N=1,NACT
                    KNG = IABS(INDEX(K,N+NCOR))
                    IF(KNG.EQ.0) GO TO 530
                    MG = MAX(M,N)
                    NG = MIN(M,N)
                    MN = IA(MG) + NG
                    DVAL = OPDM(MN)*XIJKL
                    IF((M+NCOR).GT.J) DVAL = -DVAL
                    IF((N+NCOR).GT.K) DVAL = -DVAL
                    CALL DAXPY(NUNIQ,-DVAL,YAO(1,KNG),1,RHSO(1,JMG),1)
  530             CONTINUE
  540           CONTINUE
              ENDIF
  550       CONTINUE
C
            DO 590 L=1,NACT
              KG = MAX(K,L+NCOR)
              LG = MIN(K,L+NCOR)
              KL = IA(KG) + LG
              XIJKL = BUFF(KL)
              IF(ABS(XIJKL).LT.TOL) GO TO 590
C
              JMG = IABS(INDEX(J,I))
              IF(JMG.NE.0) THEN
                DO 560 N=1,NACT
                  KNG = IABS(INDEX(K,N+NCOR))
                  IF(KNG.EQ.0) GO TO 560
                  LG = MAX(L,N)
                  NG = MIN(L,N)
                  LN = IA(LG) + NG
                  DVAL = OPDM(LN)*XIJKL
                  DVAL = FOUR*DVAL
                  IF(I.GT.J) DVAL = -DVAL
                  IF((N+NCOR).GT.K) DVAL = -DVAL
                  CALL DAXPY(NUNIQ,DVAL,YAO(1,KNG),1,RHSO(1,JMG),1)
  560           CONTINUE
              ENDIF
C
              KNG = IABS(INDEX(K,I))
              IF(KNG.NE.0) THEN
                DO 570 M=1,NACT
                  JMG = IABS(INDEX(J,M+NCOR))
                  IF(JMG.EQ.0) GO TO 570
                  LG = MAX(L,M)
                  MG = MIN(L,M)
                  LM = IA(LG) + MG
                  DVAL = OPDM(LM)*XIJKL
                  IF(I.GT.K) DVAL = -DVAL
                  IF((M+NCOR).GT.J) DVAL = -DVAL
                  CALL DAXPY(NUNIQ,-DVAL,YAO(1,KNG),1,RHSO(1,JMG),1)
  570           CONTINUE
              ENDIF
  590       CONTINUE
  600     CONTINUE
C
C          ----- Exchange contribution to orbital hessian -----
C          -----    First summation index over valence    -----
C
  610     IF(I.LE.NCOR) GO TO 1000
          DO 800 K=1,NOCC
            DO 700 L=1,NCOR
              KG = MAX(K,L)
              LG = MIN(K,L)
              KL = IA(KG) + LG
              XIJKL = BUFF(KL)
              IF(ABS(XIJKL).LT.TOL) GO TO 700
C
              IF(J.LE.NCOR) GO TO 650
              IMG = IABS(INDEX(I,L))
              IF(IMG.NE.0) THEN
                DO 620 N=1,NACT
                  KNG = IABS(INDEX(K,N+NCOR))
                  IF(KNG.EQ.0) GO TO 620
                  NG = MAX(N,J-NCOR)
                  JG = MIN(N,J-NCOR)
                  NJ = IA(NG) + JG
                  DVAL = OPDM(NJ)*XIJKL
                  IF(L.GT.I) DVAL = -DVAL
                  IF((N+NCOR).GT.K) DVAL = -DVAL
                  CALL DAXPY(NUNIQ,-DVAL,YAO(1,KNG),1,RHSO(1,IMG),1)
  620           CONTINUE
              ENDIF
C
              KNG = IABS(INDEX(K,L))
              IF(KNG.NE.0) THEN
                DO 640 M=1,NACT
                  IMG = IABS(INDEX(I,M+NCOR))
                  IF(IMG.EQ.0) GO TO 640
                  MG = MAX(M,J-NCOR)
                  JG = MIN(M,J-NCOR)
                  MJ = IA(MG) + JG
                  DVAL = OPDM(MJ)*XIJKL
                  DVAL = FOUR*DVAL
                  IF(L.GT.K) DVAL = -DVAL
                  IF((M+NCOR).GT.I) DVAL = -DVAL
                  CALL DAXPY(NUNIQ,DVAL,YAO(1,KNG),1,RHSO(1,IMG),1)
  640           CONTINUE
              ENDIF
C
  650         IF(I.EQ.J) GO TO 700
              JMG = IABS(INDEX(J,L))
              IF(JMG.NE.0) THEN
                DO 670 N=1,NACT
                  KNG = IABS(INDEX(K,N+NCOR))
                  IF(KNG.EQ.0) GO TO 670
                  NG = MAX(N,I-NCOR)
                  IG = MIN(N,I-NCOR)
                  NI = IA(NG) + IG
                  DVAL = OPDM(NI)*XIJKL
                  IF(L.GT.J) DVAL = -DVAL
                  IF((N+NCOR).GT.K) DVAL = -DVAL
                  CALL DAXPY(NUNIQ,-DVAL,YAO(1,KNG),1,RHSO(1,JMG),1)
  670           CONTINUE
              ENDIF
C
              KNG = IABS(INDEX(K,L))
              IF(KNG.NE.0) THEN
                DO 690 M=1,NACT
                  JMG = IABS(INDEX(J,M+NCOR))
                  IF(JMG.EQ.0) GO TO 690
                  MG = MAX(M,I-NCOR)
                  IG = MIN(M,I-NCOR)
                  MI = IA(MG) + IG
                  DVAL = OPDM(MI)*XIJKL
                  DVAL = FOUR*DVAL
                  IF(L.GT.K) DVAL = -DVAL
                  IF((M+NCOR).GT.J) DVAL = -DVAL
                  CALL DAXPY(NUNIQ,DVAL,YAO(1,KNG),1,RHSO(1,JMG),1)
  690           CONTINUE
              ENDIF
  700       CONTINUE
C
            DO 790 L=1,NACT
              KG = MAX(K,L+NCOR)
              LG = MIN(K,L+NCOR)
              KL = IA(KG) + LG
              XIJKL = BUFF(KL)
              IF(ABS(XIJKL).LT.TOL) GO TO 790
C
              IF(J.LE.NCOR) GO TO 750
              JG = MAX(J-NCOR,L)
              LG = MIN(J-NCOR,L)
              JL = IA(JG) + LG
              DO 720 M=1,NCOR
                IMG = IABS(INDEX(I,M))
                KMG = IABS(INDEX(K,M))
                IF((IMG.EQ.0) .OR. (KMG.EQ.0)) GO TO 720
                DVAL = OPDM(JL)*XIJKL
                IF(M.GT.I) DVAL = -DVAL
                IF(M.GT.K) DVAL = -DVAL
                CALL DAXPY(NUNIQ,-DVAL,YAO(1,KMG),1,RHSO(1,IMG),1)
  720         CONTINUE
C
              DO 740 M=1,NACT
                IMG = IABS(INDEX(I,M+NCOR))
                IF(IMG.EQ.0) GO TO 740
                MG = MAX(M,J-NCOR)
                JG = MIN(M,J-NCOR)
                MJ = IA(MG) + JG
                DO 730 N=1,NACT
                  KNG = IABS(INDEX(K,N+NCOR))
                  IF(KNG.EQ.0) GO TO 730
                  NG = MAX(N,L)
                  LG = MIN(N,L)
                  NL = IA(NG) + LG
                  MJG = MAX(MJ,NL)
                  NLG = MIN(MJ,NL)
                  MJNL = IA(MJG) + NLG
                  DVAL = TPDM(MJNL)*XIJKL
                  DVAL = TWO*DVAL
                  IF((M+NCOR).GT.I) DVAL = -DVAL
                  IF((N+NCOR).GT.K) DVAL = -DVAL
                  CALL DAXPY(NUNIQ,DVAL,YAO(1,KNG),1,RHSO(1,IMG),1)
  730           CONTINUE
  740         CONTINUE
C
  750         IF(I.EQ.J) GO TO 790
              IG = MAX(I-NCOR,L)
              LG = MIN(I-NCOR,L)
              IL = IA(IG) + LG
              DO 760 M=1,NCOR
                JMG = IABS(INDEX(J,M))
                KMG = IABS(INDEX(K,M))
                IF((JMG.EQ.0) .OR. (KMG.EQ.0)) GO TO 760
                DVAL = OPDM(IL)*XIJKL
                IF(M.GT.J) DVAL = -DVAL
                IF(M.GT.K) DVAL = -DVAL
                CALL DAXPY(NUNIQ,-DVAL,YAO(1,KMG),1,RHSO(1,JMG),1)
  760         CONTINUE
C
              DO 780 M=1,NACT
                JMG = IABS(INDEX(J,M+NCOR))
                IF(JMG.EQ.0) GO TO 780
                MG = MAX(M,I-NCOR)
                IG = MIN(M,I-NCOR)
                MI = IA(MG) + IG
                DO 770 N=1,NACT
                  KNG = IABS(INDEX(K,N+NCOR))
                  IF(KNG.EQ.0) GO TO 770
                  NG = MAX(N,L)
                  LG = MIN(N,L)
                  NL = IA(NG) + LG
                  MIG = MAX(MI,NL)
                  NLG = MIN(MI,NL)
                  MINL = IA(MIG) + NLG
                  DVAL = TPDM(MINL)*XIJKL
                  DVAL = TWO*DVAL
                  IF((M+NCOR).GT.J) DVAL = -DVAL
                  IF((N+NCOR).GT.K) DVAL = -DVAL
                  CALL DAXPY(NUNIQ,DVAL,YAO(1,KNG),1,RHSO(1,JMG),1)
  770           CONTINUE
  780         CONTINUE
  790       CONTINUE
  800     CONTINUE
C
C          ----- Finished with current integral buffer -----
C
 1000     CALL DDI_PROCDLB_NEXT(C_OOOO,IWP,ICNTR1)
C
        ENDDO
C
C     ----- Get and use (VO|OO) integrals -----
C
        CALL DDI_DISTRIB(D_VOOO,IWP,ILO,IHI,JLO,JHI)
        MAXWRK = JHI-JLO+1
C
        CALL DDI_PROCDLB_NEXT(C_VOOO,IWP,ICNTR2)
C
        DO WHILE(ICNTR2.LT.MAXWRK)
          JKL = JLO + ICNTR2
C
          DO KK=1,NOCC
            DO LL=1,KK
              KL = IA(KK) + LL
              DLT = TWO
              IF(KK.EQ.LL) DLT = ONE
              DO JJ=1,NOCC
                JKLTMP = (KL-1)*NOCC + JJ
                IF(JKL.EQ.JKLTMP) THEN
                  J = JJ
                  K = KK
                  L = LL
                  GO TO 1010
                END IF
              ENDDO
            ENDDO
          ENDDO
C
 1010     CALL DDI_GET(D_VOOO,1,NBVIR,JKL,JKL,BUFF)
C
C          ----- Coulomb contribution to orbital hessian -----
C          -----   Ket integral indicies are both core   -----
C
          IF(K.GT.NCOR) GO TO 1120
          JKG = IABS(INDEX(J,K))
          JLG = IABS(INDEX(J,L))
          DO 1100 I=NOCC+1,L0
            XIJKL = BUFF(I-NOCC)
            IF(ABS(XIJKL).LT.TOL) GO TO 1100
C
            ILG = IABS(INDEX(I,L))
            IF((ILG.EQ.0) .OR. (JKG.EQ.0)) GO TO 1020
            DVAL = DLT*XIJKL
            IF(K.GT.J) DVAL = -DVAL
            CALL DAXPY(NUNIQ,-DVAL,YAO(1,JKG),1,RHSO(1,ILG),1)
            CALL DAXPY(NUNIQ,-DVAL,YAO(1,ILG),1,RHSO(1,JKG),1)
C
 1020       IKG = IABS(INDEX(I,K))
            IF((IKG.EQ.0) .OR. (JLG.EQ.0)) GO TO 1030
            DVAL = DLT*XIJKL
            IF(L.GT.J) DVAL = -DVAL
            CALL DAXPY(NUNIQ,-DVAL,YAO(1,JLG),1,RHSO(1,IKG),1)
            CALL DAXPY(NUNIQ,-DVAL,YAO(1,IKG),1,RHSO(1,JLG),1)
C
 1030       IF(K.NE.L) GO TO 1100
            DO 1050 M=1,NCOR
              IMG = IABS(INDEX(I,M))
              JMG = IABS(INDEX(J,M))
              IF((IMG.EQ.0) .OR. (JMG.EQ.0)) GO TO 1050
              DVAL = FOUR*XIJKL
              IF(M.GT.J) DVAL = -DVAL
              CALL DAXPY(NUNIQ,DVAL,YAO(1,JMG),1,RHSO(1,IMG),1)
              CALL DAXPY(NUNIQ,DVAL,YAO(1,IMG),1,RHSO(1,JMG),1)
 1050       CONTINUE
C
            DO 1070 M=1,NACT
              IMG = IABS(INDEX(I,M+NCOR))
              IF(IMG.EQ.0) GO TO 1070
              DO 1060 N=1,NACT
                JNG = IABS(INDEX(J,N+NCOR))
                IF(JNG.EQ.0) GO TO 1060
                MG = MAX(M,N)
                NG = MIN(M,N)
                MN = IA(MG) + NG
                DVAL = OPDM(MN)*XIJKL
                DVAL = TWO*DVAL
                IF((N+NCOR).GT.J) DVAL = -DVAL
                CALL DAXPY(NUNIQ,DVAL,YAO(1,JNG),1,RHSO(1,IMG),1)
                CALL DAXPY(NUNIQ,DVAL,YAO(1,IMG),1,RHSO(1,JNG),1)
 1060         CONTINUE
 1070       CONTINUE
 1100     CONTINUE
          GO TO 1500
C
C          ----- Coulomb contribution to orbital hessian -----
C          -----     One ket integral index is active    -----
C
 1120     IF(L.GT.NCOR) GO TO 1220
          JLG = IABS(INDEX(J,L))
          DO 1200 I=NOCC+1,L0
            XIJKL = BUFF(I-NOCC)
            IF(ABS(XIJKL).LT.TOL) GO TO 1200
            ILG = IABS(INDEX(I,L))
C
            DO 1140 M=1,NACT
              KG = MAX(K-NCOR,M)
              MG = MIN(K-NCOR,M)
              KM = IA(KG) + MG
C
              IMG = IABS(INDEX(I,M+NCOR))
              IF((IMG.EQ.0) .OR. (JLG.EQ.0)) GO TO 1130
              DVAL = OPDM(KM)*XIJKL
              IF(L.GT.J) DVAL = -DVAL
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,JLG),1,RHSO(1,IMG),1)
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,IMG),1,RHSO(1,JLG),1)
C
 1130         JMG = IABS(INDEX(J,M+NCOR))
              IF((ILG.EQ.0) .OR. (JMG.EQ.0)) GO TO 1140
              DVAL = OPDM(KM)*XIJKL
              IF((M+NCOR).GT.J) DVAL = -DVAL
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,JMG),1,RHSO(1,ILG),1)
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,ILG),1,RHSO(1,JMG),1)
 1140       CONTINUE
 1200     CONTINUE
          GO TO 1500
C
C          ----- Coulomb contribution to orbital hessian -----
C          -----  Ket integral indicies are both active  -----
C
 1220     KKLL = IA(K-NCOR) + L-NCOR
          DO 1300 I=NOCC+1,L0
            XIJKL = BUFF(I-NOCC)
            IF(ABS(XIJKL).LT.TOL) GO TO 1300
C
            DO 1240 M=1,NCOR
              IMG = IABS(INDEX(I,M))
              JMG = IABS(INDEX(J,M))
              IF((IMG.EQ.0) .OR. (JMG.EQ.0)) GO TO 1240
              DVAL = OPDM(KKLL)*XIJKL
              DVAL = TWO*DLT*DVAL
              IF(M.GT.J) DVAL = -DVAL
              CALL DAXPY(NUNIQ,DVAL,YAO(1,JMG),1,RHSO(1,IMG),1)
              CALL DAXPY(NUNIQ,DVAL,YAO(1,IMG),1,RHSO(1,JMG),1)
 1240       CONTINUE
C
            DO 1260 M=1,NACT
              IMG = IABS(INDEX(I,M+NCOR))
              IF(IMG.EQ.0) GO TO 1260
              DO 1250 N=1,NACT
                JNG = IABS(INDEX(J,N+NCOR))
                IF(JNG.EQ.0) GO TO 1250
                MG = MAX(M,N)
                NG = MIN(M,N)
                MN = IA(MG) + NG
                MNG = MAX(MN,KKLL)
                KLG = MIN(MN,KKLL)
                MNKL = IA(MNG) + KLG
                DVAL = TPDM(MNKL)*XIJKL
                DVAL = DLT*DVAL
                IF((N+NCOR).GT.J) DVAL = -DVAL
                CALL DAXPY(NUNIQ,DVAL,YAO(1,JNG),1,RHSO(1,IMG),1)
                CALL DAXPY(NUNIQ,DVAL,YAO(1,IMG),1,RHSO(1,JNG),1)
 1250         CONTINUE
 1260       CONTINUE
 1300     CONTINUE
C
C          ----- Exchange contribution to orbital hessian -----
C          -----              J index is core             -----
C
 1500     IF(J.GT.NCOR) GO TO 1760
          IF(L.GT.NCOR) GO TO 1660
          KLG = IABS(INDEX(K,L))
          KJG = IABS(INDEX(K,J))
          LKG = IABS(INDEX(L,K))
          LJG = IABS(INDEX(L,J))
C
          DO 1650 I=NOCC+1,L0
            XIJKL = BUFF(I-NOCC)
            IF(ABS(XIJKL).LT.TOL) GO TO 1650
C
            IJG = IABS(INDEX(I,J))
            IF((IJG.EQ.0) .OR. (KLG.EQ.0)) GO TO 1510
            DVAL = FOUR*XIJKL
            DVAL = TWO*DVAL
            CALL DAXPY(NUNIQ,DVAL,YAO(1,KLG),1,RHSO(1,IJG),1)
            CALL DAXPY(NUNIQ,DVAL,YAO(1,IJG),1,RHSO(1,KLG),1)
C
 1510       ILG = IABS(INDEX(I,L))
            IF((ILG.EQ.0) .OR. (KJG.EQ.0)) GO TO 1520
            DVAL = TWO*XIJKL
            IF(J.GT.K) DVAL = -DVAL
            CALL DAXPY(NUNIQ,-DVAL,YAO(1,KJG),1,RHSO(1,ILG),1)
            CALL DAXPY(NUNIQ,-DVAL,YAO(1,ILG),1,RHSO(1,KJG),1)
C
 1520       IF(J.NE.L) GO TO 1560
            DO 1530 M=1,NCOR
              IMG = IABS(INDEX(I,M))
              KMG = IABS(INDEX(K,M))
              IF((IMG.EQ.0) .OR. (KMG.EQ.0)) GO TO 1530
              DVAL = TWO*XIJKL
              IF(M.GT.K) DVAL = -DVAL
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,KMG),1,RHSO(1,IMG),1)
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,IMG),1,RHSO(1,KMG),1)
 1530       CONTINUE
C
            DO 1550 M=1,NACT
              IMG = IABS(INDEX(I,M+NCOR))
              IF(IMG.EQ.0) GO TO 1550
              DO 1540 N=1,NACT
                KNG = IABS(INDEX(K,N+NCOR))
                IF(KNG.EQ.0) GO TO 1540
                MG = MAX(M,N)
                NG = MIN(M,N)
                MN = IA(MG) + NG
                DVAL = OPDM(MN)*XIJKL
                IF((N+NCOR).GT.K) DVAL = -DVAL
                CALL DAXPY(NUNIQ,-DVAL,YAO(1,KNG),1,RHSO(1,IMG),1)
                CALL DAXPY(NUNIQ,-DVAL,YAO(1,IMG),1,RHSO(1,KNG),1)
 1540         CONTINUE
 1550       CONTINUE
C
 1560       IF((K.EQ.L) .OR. (K.GT.NCOR)) GO TO 1650
            IF((IJG.EQ.0) .OR. (LKG.EQ.0)) GO TO 1570
            DVAL = FOUR*XIJKL
            DVAL = TWO*DVAL
            IF(K.GT.L) DVAL = -DVAL
            CALL DAXPY(NUNIQ,DVAL,YAO(1,LKG),1,RHSO(1,IJG),1)
            CALL DAXPY(NUNIQ,DVAL,YAO(1,IJG),1,RHSO(1,LKG),1)
C
 1570       IKG = IABS(INDEX(I,K))
            IF((IKG.EQ.0) .OR. (LJG.EQ.0)) GO TO 1580
            DVAL = TWO*XIJKL
            IF(J.GT.L) DVAL = -DVAL
            CALL DAXPY(NUNIQ,-DVAL,YAO(1,LJG),1,RHSO(1,IKG),1)
            CALL DAXPY(NUNIQ,-DVAL,YAO(1,IKG),1,RHSO(1,LJG),1)
C
 1580       IF(J.NE.K) GO TO 1650
            DO 1590 M=1,NCOR
              IMG = IABS(INDEX(I,M))
              LMG = IABS(INDEX(L,M))
              IF((IMG.EQ.0) .OR. (LMG.EQ.0)) GO TO 1590
              DVAL = TWO*XIJKL
              IF(M.GT.L) DVAL = -DVAL
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,LMG),1,RHSO(1,IMG),1)
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,IMG),1,RHSO(1,LMG),1)
 1590       CONTINUE
C
            DO 1610 M=1,NACT
              IMG = IABS(INDEX(I,M+NCOR))
              IF(IMG.EQ.0) GO TO 1610
              DO 1600 N=1,NACT
                LNG = IABS(INDEX(L,N+NCOR))
                IF(LNG.EQ.0) GO TO 1600
                MG = MAX(M,N)
                NG = MIN(M,N)
                MN = IA(MG) + NG
                DVAL = OPDM(MN)*XIJKL
                IF((N+NCOR).GT.L) DVAL = -DVAL
                CALL DAXPY(NUNIQ,-DVAL,YAO(1,LNG),1,RHSO(1,IMG),1)
                CALL DAXPY(NUNIQ,-DVAL,YAO(1,IMG),1,RHSO(1,LNG),1)
 1600         CONTINUE
 1610       CONTINUE
 1650     CONTINUE
C
 1660     IF(K.LE.NCOR) GO TO 1760
          KJG = IABS(INDEX(K,J))
          LJG = IABS(INDEX(L,J))
          DO 1750 I=NOCC+1,L0
            XIJKL = BUFF(I-NOCC)
            IF(ABS(XIJKL).LT.TOL) GO TO 1750
            IJG = IABS(INDEX(I,J))
C
            IF(L.LE.NCOR) GO TO 1700
            DO 1690 M=1,NACT
              MG = MAX(M,L-NCOR)
              LG = MIN(M,L-NCOR)
              ML = IA(MG) + LG
C
              IMG = IABS(INDEX(I,M+NCOR))
              IF((IMG.EQ.0) .OR. (KJG.EQ.0)) GO TO 1680
              DVAL = OPDM(ML)*XIJKL
              IF(J.GT.K) DVAL = -DVAL
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,KJG),1,RHSO(1,IMG),1)
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,IMG),1,RHSO(1,KJG),1)
C
 1680         KMG = IABS(INDEX(K,M+NCOR))
              IF((IJG.EQ.0) .OR. (KMG.EQ.0)) GO TO 1690
              DVAL = OPDM(ML)*XIJKL
              DVAL = FOUR*DVAL
              IF((M+NCOR).GT.K) DVAL = -DVAL
              CALL DAXPY(NUNIQ,DVAL,YAO(1,KMG),1,RHSO(1,IJG),1)
              CALL DAXPY(NUNIQ,DVAL,YAO(1,IJG),1,RHSO(1,KMG),1)
 1690       CONTINUE
C
 1700       IF(K.EQ.L) GO TO 1750
            DO 1740 M=1,NACT
              MG = MAX(M,K-NCOR)
              KG = MIN(M,K-NCOR)
              MK = IA(MG) + KG
C
              IMG = IABS(INDEX(I,M+NCOR))
              IF((IMG.EQ.0) .OR. (LJG.EQ.0)) GO TO 1720
              DVAL = OPDM(MK)*XIJKL
              IF(J.GT.L) DVAL = -DVAL
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,LJG),1,RHSO(1,IMG),1)
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,IMG),1,RHSO(1,LJG),1)
C
 1720         LMG = IABS(INDEX(L,M+NCOR))
              IF((IJG.EQ.0) .OR. (LMG.EQ.0)) GO TO 1740
              DVAL = OPDM(MK)*XIJKL
              DVAL = FOUR*DVAL
              IF((M+NCOR).GT.L) DVAL = -DVAL
              CALL DAXPY(NUNIQ,DVAL,YAO(1,LMG),1,RHSO(1,IJG),1)
              CALL DAXPY(NUNIQ,DVAL,YAO(1,IJG),1,RHSO(1,LMG),1)
 1740       CONTINUE
 1750     CONTINUE
C
C          ----- Exchange contribution to orbital hessian -----
C          -----            J index is active             -----
C
 1760     IF(J.LE.NCOR) GO TO 2000
          IF(L.GT.NCOR) GO TO 1860
          DO 1850 I=NOCC+1,L0
            XIJKL = BUFF(I-NOCC)
            IF(ABS(XIJKL).LT.TOL) GO TO 1850
C
            ILG = IABS(INDEX(I,L))
            KLG = IABS(INDEX(K,L))
            DO 1800 M=1,NACT
              MG = MAX(M,J-NCOR)
              JG = MIN(M,J-NCOR)
              MJ = IA(MG) + JG
C
              IMG = IABS(INDEX(I,M+NCOR))
              IF((IMG.EQ.0) .OR. (KLG.EQ.0)) GO TO 1780
              DVAL = OPDM(MJ)*XIJKL
              DVAL = FOUR*DVAL
              CALL DAXPY(NUNIQ,DVAL,YAO(1,KLG),1,RHSO(1,IMG),1)
              CALL DAXPY(NUNIQ,DVAL,YAO(1,IMG),1,RHSO(1,KLG),1)
C
 1780         KMG = IABS(INDEX(K,M+NCOR))
              IF((ILG.EQ.0) .OR. (KMG.EQ.0)) GO TO 1800
              DVAL = OPDM(MJ)*XIJKL
              IF((M+NCOR).GT.K) DVAL = -DVAL
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,KMG),1,RHSO(1,ILG),1)
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,ILG),1,RHSO(1,KMG),1)
 1800       CONTINUE
C
            IF((K.EQ.L) .OR. (K.GT.NCOR)) GO TO 1850
            IKG = IABS(INDEX(I,K))
            LKG = IABS(INDEX(L,K))
            DO 1840 M=1,NACT
              MG = MAX(M,J-NCOR)
              JG = MIN(M,J-NCOR)
              MJ = IA(MG) + JG
C
              IMG = IABS(INDEX(I,M+NCOR))
              IF((IMG.EQ.0) .OR. (LKG.EQ.0)) GO TO 1820
              DVAL = OPDM(MJ)*XIJKL
              DVAL = FOUR*DVAL
              IF(K.GT.L) DVAL = -DVAL
              CALL DAXPY(NUNIQ,DVAL,YAO(1,LKG),1,RHSO(1,IMG),1)
              CALL DAXPY(NUNIQ,DVAL,YAO(1,IMG),1,RHSO(1,LKG),1)
C
 1820         LMG = IABS(INDEX(L,M+NCOR))
              IF((IKG.EQ.0) .OR. (LMG.EQ.0)) GO TO 1840
              DVAL = OPDM(MJ)*XIJKL
              IF((M+NCOR).GT.L) DVAL = -DVAL
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,LMG),1,RHSO(1,IKG),1)
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,IKG),1,RHSO(1,LMG),1)
 1840       CONTINUE
 1850     CONTINUE
C
 1860     IF(K.LE.NCOR) GO TO 2000
          DO 1950 I=NOCC+1,L0
            XIJKL = BUFF(I-NOCC)
            IF(ABS(XIJKL).LT.TOL) GO TO 1950
C
            IF(L.LE.NCOR) GO TO 1900
            JG = MAX(J-NCOR,L-NCOR)
            LG = MIN(J-NCOR,L-NCOR)
            JL = IA(JG) + LG
            DO 1870 M=1,NCOR
              IMG = IABS(INDEX(I,M))
              KMG = IABS(INDEX(K,M))
              IF((IMG.EQ.0) .OR. (KMG.EQ.0)) GO TO 1870
              DVAL = OPDM(JL)*XIJKL
              IF(M.GT.K) DVAL = -DVAL
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,KMG),1,RHSO(1,IMG),1)
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,IMG),1,RHSO(1,KMG),1)
 1870       CONTINUE
C
            DO 1890 M=1,NACT
              IMG = IABS(INDEX(I,M+NCOR))
              IF(IMG.EQ.0) GO TO 1890
              MG = MAX(M,J-NCOR)
              JG = MIN(M,J-NCOR)
              MJ = IA(MG) + JG
              DO 1880 N=1,NACT
                KNG = IABS(INDEX(K,N+NCOR))
                IF(KNG.EQ.0) GO TO 1880
                NG = MAX(N,L-NCOR)
                LG = MIN(N,L-NCOR)
                NL = IA(NG) + LG
                MJG = MAX(MJ,NL)
                NLG = MIN(MJ,NL)
                MJNL = IA(MJG) + NLG
                DVAL = TPDM(MJNL)*XIJKL
                DVAL = TWO*DVAL
                IF((N+NCOR).GT.K) DVAL = -DVAL
                CALL DAXPY(NUNIQ,DVAL,YAO(1,KNG),1,RHSO(1,IMG),1)
                CALL DAXPY(NUNIQ,DVAL,YAO(1,IMG),1,RHSO(1,KNG),1)
 1880         CONTINUE
 1890       CONTINUE
C
 1900       IF(K.EQ.L) GO TO 1950
            JG = MAX(J-NCOR,K-NCOR)
            KG = MIN(J-NCOR,K-NCOR)
            JK = IA(JG) + KG
            DO 1910 M=1,NCOR
              IMG = IABS(INDEX(I,M))
              LMG = IABS(INDEX(L,M))
              IF((IMG.EQ.0) .OR. (LMG.EQ.0)) GO TO 1910
              DVAL = OPDM(JK)*XIJKL
              IF(M.GT.L) DVAL = -DVAL
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,LMG),1,RHSO(1,IMG),1)
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,IMG),1,RHSO(1,LMG),1)
 1910       CONTINUE
C
            DO 1940 M=1,NACT
              IMG = IABS(INDEX(I,M+NCOR))
              IF(IMG.EQ.0) GO TO 1940
              MG = MAX(M,J-NCOR)
              JG = MIN(M,J-NCOR)
              MJ = IA(MG) + JG
              DO 1930 N=1,NACT
                LNG = IABS(INDEX(L,N+NCOR))
                IF(LNG.EQ.0) GO TO 1930
                NG = MAX(N,K-NCOR)
                KG = MIN(N,K-NCOR)
                NK = IA(NG) + KG
                MJG = MAX(MJ,NK)
                NKG = MIN(MJ,NK)
                MJNK = IA(MJG) + NKG
                DVAL = TPDM(MJNK)*XIJKL
                DVAL = TWO*DVAL
                IF((N+NCOR).GT.L) DVAL = -DVAL
                CALL DAXPY(NUNIQ,DVAL,YAO(1,LNG),1,RHSO(1,IMG),1)
                CALL DAXPY(NUNIQ,DVAL,YAO(1,IMG),1,RHSO(1,LNG),1)
 1930         CONTINUE
 1940       CONTINUE
 1950     CONTINUE
C
C          ----- Finished with current integral buffer -----
C
 2000     CALL DDI_PROCDLB_NEXT(C_VOOO,IWP,ICNTR2)
C
        ENDDO
C
C     ----- Get and use (VV|OO) integrals -----
C
        CALL DDI_DISTRIB(D_VVOO,IWP,ILO,IHI,JLO,JHI)
        MAXWRK = JHI-JLO+1
C
        CALL DDI_PROCDLB_NEXT(C_VVOO,IWP,ICNTR3)
C
        DO WHILE(ICNTR3.LT.MAXWRK)
          KL = JLO + ICNTR3
C
          DO KK=1,NOCC
            DO LL=1,KK
              DLT = TWO
              IF(KK.EQ.LL) DLT = ONE
              KLTMP = IA(KK) + LL
              IF(KL.EQ.KLTMP) THEN
                K = KK
                L = LL
                GO TO 2010
              ENDIF
            ENDDO
          ENDDO
C
 2010     CALL DDI_GET(D_VVOO,1,NBTR,KL,KL,BUFF)
C
C          ----- Coulomb contribution to orbital hessian -----
C          -----      K and L are both core indicies     -----
C
          IF(K.GT.NCOR) GO TO 2150
          DO 2100 I=1,NVIR
            II = I + NOCC
            ILG = IABS(INDEX(II,L))
            IKG = IABS(INDEX(II,K))
            DO 2100 J=1,I
              JJ = J + NOCC
              IJ = IA(I) + J
              XIJKL = BUFF(IJ)
              IF(ABS(XIJKL).LT.TOL) GO TO 2100
C
              JKG = IABS(INDEX(JJ,K))
              IF((ILG.EQ.0) .OR. (JKG.EQ.0)) GO TO 2030
              DVAL = DLT*XIJKL
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,JKG),1,RHSO(1,ILG),1)
              IF(I.EQ.J) GO TO 2030
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,ILG),1,RHSO(1,JKG),1)
C
 2030         JLG = IABS(INDEX(JJ,L))
              IF((IKG.EQ.0) .OR. (JLG.EQ.0)) GO TO 2040
              DVAL = DLT*XIJKL
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,JLG),1,RHSO(1,IKG),1)
              IF(I.EQ.J) GO TO 2040
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,IKG),1,RHSO(1,JLG),1)
C
 2040         IF(K.NE.L) GO TO 2100
              DO 2050 M=1,NCOR
                IMG = IABS(INDEX(II,M))
                JMG = IABS(INDEX(JJ,M))
                IF((IMG.EQ.0) .OR. (JMG.EQ.0)) GO TO 2050
                DVAL = FOUR*XIJKL
                CALL DAXPY(NUNIQ,DVAL,YAO(1,JMG),1,RHSO(1,IMG),1)
                IF(I.EQ.J) GO TO 2050
                CALL DAXPY(NUNIQ,DVAL,YAO(1,IMG),1,RHSO(1,JMG),1)
 2050         CONTINUE
C
              DO 2070 M=1,NACT
                IMG = IABS(INDEX(II,M+NCOR))
                IF(IMG.EQ.0) GO TO 2070
                DO 2060 N=1,NACT
                  JNG = IABS(INDEX(JJ,N+NCOR))
                  IF(JNG.EQ.0) GO TO 2060
                  MG = MAX(M,N)
                  NG = MIN(M,N)
                  MN = IA(MG) + NG
                  DVAL = OPDM(MN)*XIJKL
                  DVAL = TWO*DVAL
                  CALL DAXPY(NUNIQ,DVAL,YAO(1,JNG),1,RHSO(1,IMG),1)
                  IF(I.EQ.J) GO TO 2060
                  CALL DAXPY(NUNIQ,DVAL,YAO(1,IMG),1,RHSO(1,JNG),1)
 2060           CONTINUE
 2070         CONTINUE
 2100     CONTINUE
          GO TO 3000
C
C          ----- Coulomb contribution to orbital hessian -----
C          -----         K is active, L is core          -----
C
 2150     IF(L.GT.NCOR) GO TO 2350
          DO 2300 I=1,NVIR
            II = I + NOCC
            ILG = IABS(INDEX(II,L))
            DO 2300 J=1,I
              JJ = J + NOCC
              IJ = IA(I) + J
              XIJKL = BUFF(IJ)
              IF(ABS(XIJKL).LT.TOL) GO TO 2300
              JLG = IABS(INDEX(JJ,L))
C
              DO 2200 M=1,NACT
                MG = MAX(M,K-NCOR)
                KG = MIN(M,K-NCOR)
                MK = IA(MG) + KG
C
                JMG = IABS(INDEX(JJ,M+NCOR))
                IF((ILG.EQ.0) .OR. (JMG.EQ.0)) GO TO 2170
                DVAL = OPDM(MK)*XIJKL
                DVAL = HALF*DLT*DVAL
                CALL DAXPY(NUNIQ,-DVAL,YAO(1,JMG),1,RHSO(1,ILG),1)
                IF(I.EQ.J) GO TO 2170
                CALL DAXPY(NUNIQ,-DVAL,YAO(1,ILG),1,RHSO(1,JMG),1)
C
 2170           IMG = IABS(INDEX(II,M+NCOR))
                IF((IMG.EQ.0) .OR. (JLG.EQ.0)) GO TO 2200
                DVAL = OPDM(MK)*XIJKL
                DVAL = HALF*DLT*DVAL
                CALL DAXPY(NUNIQ,-DVAL,YAO(1,JLG),1,RHSO(1,IMG),1)
                IF(I.EQ.J) GO TO 2200
                CALL DAXPY(NUNIQ,-DVAL,YAO(1,IMG),1,RHSO(1,JLG),1)
 2200         CONTINUE
 2300     CONTINUE
          GO TO 3000
C
C          ----- Coulomb contribution to orbital hessian -----
C          -----     K and L are both active indicies    -----
C
 2350     KKLL = IA(K-NCOR) + L-NCOR
          DO 2500 I=1,NVIR
            II = I + NOCC
            DO 2500 J=1,I
              JJ = J + NOCC
              IJ = IA(I) + J
              XIJKL = BUFF(IJ)
              IF(ABS(XIJKL).LT.TOL) GO TO 2500
              XIJKL = DLT*XIJKL
C
              DO 2400 M=1,NCOR
                IMG = IABS(INDEX(II,M))
                JMG = IABS(INDEX(JJ,M))
                IF((IMG.EQ.0) .OR. (JMG.EQ.0)) GO TO 2400
                DVAL = OPDM(KKLL)*XIJKL
                DVAL = TWO*DVAL
                CALL DAXPY(NUNIQ,DVAL,YAO(1,JMG),1,RHSO(1,IMG),1)
                IF(I.EQ.J) GO TO 2400
                CALL DAXPY(NUNIQ,DVAL,YAO(1,IMG),1,RHSO(1,JMG),1)
 2400         CONTINUE
C
              DO 2440 M=1,NACT
                IMG = IABS(INDEX(II,M+NCOR))
                IF(IMG.EQ.0) GO TO 2440
                DO 2420 N=1,NACT
                  JNG = IABS(INDEX(JJ,N+NCOR))
                  IF(JNG.EQ.0) GO TO 2420
                  MG = MAX(M,N)
                  NG = MIN(M,N)
                  MN = IA(MG) + NG
                  MNG = MAX(MN,KKLL)
                  KLG = MIN(MN,KKLL)
                  MNKL = IA(MNG) + KLG
                  DVAL = TPDM(MNKL)*XIJKL
                  IF(ABS(DVAL).LT.TOL) GO TO 2420
                  CALL DAXPY(NUNIQ,DVAL,YAO(1,JNG),1,RHSO(1,IMG),1)
                  IF(I.EQ.J) GO TO 2420
                  CALL DAXPY(NUNIQ,DVAL,YAO(1,IMG),1,RHSO(1,JNG),1)
 2420           CONTINUE
 2440         CONTINUE
 2500     CONTINUE
C
C          ----- Finished with current integral buffer -----
C
 3000     CALL DDI_PROCDLB_NEXT(C_VVOO,IWP,ICNTR3)
C
        ENDDO
C
C     ----- Get and use (VO|VO) integrals -----
C
        CALL DDI_DISTRIB(D_VOVO,IWP,ILO,IHI,JLO,JHI)
        MAXWRK = JHI-JLO+1
C
        CALL DDI_PROCDLB_NEXT(C_VOVO,IWP,ICNTR4)
C
        DO WHILE(ICNTR4.LT.MAXWRK)
          JL = JLO + ICNTR4
C
          DO JJ=1,NOCC
            DO LL=1,JJ
              JLTMP = IA(JJ) + LL
              IF(JL.EQ.JLTMP) THEN
                J = JJ
                L = LL
                GO TO 3010
              END IF
            ENDDO
          ENDDO
C
 3010     CALL DDI_GET(D_VOVO,1,NBSQ,JL,JL,BUFF)
C
C          ----- Exchange contribution to orbital hessian -----
C          -----        J and L are core orbitals         -----
C
          IF(J.GT.NCOR) GO TO 3120
          DO 3100 I=1,NVIR
            II = I + NOCC
            IJG = IABS(INDEX(II,J))
            ILG = IABS(INDEX(II,L))
            DO 3100 K=1,NVIR
              KK = K + NOCC
              KJG = IABS(INDEX(KK,J))
              KLG = IABS(INDEX(KK,L))
              IK = (K-1)*NVIR + I
              XIJKL = BUFF(IK)
              IF(ABS(XIJKL).LT.TOL) GO TO 3040
C
              IF((IJG.EQ.0) .OR. (KLG.EQ.0)) GO TO 3030
              DVAL = FOUR*XIJKL
              DVAL = TWO*DVAL
              CALL DAXPY(NUNIQ,DVAL,YAO(1,KLG),1,RHSO(1,IJG),1)
C
 3030         IF((ILG.EQ.0) .OR. (KJG.EQ.0)) GO TO 3040
              DVAL = TWO*XIJKL
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,KJG),1,RHSO(1,ILG),1)
C
 3040         KI = (I-1)*NVIR + K
              XIJKL = BUFF(KI)
              IF(ABS(XIJKL).LT.TOL) GO TO 3100
              IF(J.EQ.L) GO TO 3060
C
              IF((ILG.EQ.0) .OR. (KJG.EQ.0)) GO TO 3050
              DVAL = FOUR*XIJKL
              DVAL = TWO*DVAL
              CALL DAXPY(NUNIQ,DVAL,YAO(1,KJG),1,RHSO(1,ILG),1)
C
 3050         IF((IJG.EQ.0) .OR. (KLG.EQ.0)) GO TO 3060
              DVAL = TWO*XIJKL
              CALL DAXPY(NUNIQ,-DVAL,YAO(1,KLG),1,RHSO(1,IJG),1)
C
 3060         IF(J.NE.L) GO TO 3100
              DO 3070 M=1,NCOR
                IMG = IABS(INDEX(II,M))
                KMG = IABS(INDEX(KK,M))
                IF((IMG.EQ.0) .OR. (KMG.EQ.0)) GO TO 3070
                DVAL = TWO*XIJKL
                CALL DAXPY(NUNIQ,-DVAL,YAO(1,KMG),1,RHSO(1,IMG),1)
 3070         CONTINUE
C
              DO 3090 M=1,NACT
                IMG = IABS(INDEX(II,M+NCOR))
                IF(IMG.EQ.0) GO TO 3090
                DO 3080 N=1,NACT
                  KNG = IABS(INDEX(KK,N+NCOR))
                  IF(KNG.EQ.0) GO TO 3080
                  MG = MAX(M,N)
                  NG = MIN(M,N)
                  MN = IA(MG) + NG
                  DVAL = OPDM(MN)*XIJKL
                  CALL DAXPY(NUNIQ,-DVAL,YAO(1,KNG),1,RHSO(1,IMG),1)
 3080           CONTINUE
 3090         CONTINUE
 3100     CONTINUE
          GO TO 4000
C
C          ----- Exchange contribution to orbital hessian -----
C          -----          J is active, L is core          -----
C
 3120     IF(L.GT.NCOR) GO TO 3220
          DO 3200 I=1,NVIR
            II = I + NOCC
            ILG = IABS(INDEX(II,L))
            DO 3200 K=1,NVIR
              KK = K + NOCC
              IK = (K-1)*NVIR + I
              XIJKL = BUFF(IK)
              IF(ABS(XIJKL).LT.TOL) GO TO 3160
              KLG = IABS(INDEX(KK,L))
C
              DO 3150 M=1,NACT
                MG = MAX(M,J-NCOR)
                JG = MIN(M,J-NCOR)
                MJ = IA(MG) + JG
C
                KMG = IABS(INDEX(KK,M+NCOR))
                IF((ILG.EQ.0) .OR. (KMG.EQ.0)) GO TO 3140
                DVAL = OPDM(MJ)*XIJKL
                CALL DAXPY(NUNIQ,-DVAL,YAO(1,KMG),1,RHSO(1,ILG),1)
C
 3140           IMG = IABS(INDEX(II,M+NCOR))
                IF((IMG.EQ.0) .OR. (KLG.EQ.0)) GO TO 3150
                DVAL = OPDM(MJ)*XIJKL
                DVAL = FOUR*DVAL
                CALL DAXPY(NUNIQ,DVAL,YAO(1,KLG),1,RHSO(1,IMG),1)
 3150         CONTINUE
C
 3160         KI = (I-1)*NVIR + K
              XIJKL = BUFF(KI)
              IF(ABS(XIJKL).LT.TOL) GO TO 3200
C
              DO 3190 M=1,NACT
                MG = MAX(M,J-NCOR)
                JG = MIN(M,J-NCOR)
                MJ = IA(MG) + JG
C
                KMG = IABS(INDEX(KK,M+NCOR))
                IF((ILG.EQ.0) .OR. (KMG.EQ.0)) GO TO 3180
                DVAL = OPDM(MJ)*XIJKL
                DVAL = FOUR*DVAL
                CALL DAXPY(NUNIQ,DVAL,YAO(1,KMG),1,RHSO(1,ILG),1)
C
 3180           IMG = IABS(INDEX(II,M+NCOR))
                IF((IMG.EQ.0) .OR. (KLG.EQ.0)) GO TO 3190
                DVAL = OPDM(MJ)*XIJKL
                CALL DAXPY(NUNIQ,-DVAL,YAO(1,KLG),1,RHSO(1,IMG),1)
 3190         CONTINUE
 3200     CONTINUE
          GO TO 4000
C
C          ----- Exchange contribution to orbital hessian -----
C          -----       J and L are active orbitals        -----
C
 3220     JJLL = IA(J-NCOR) + L-NCOR
          DO 3300 I=1,NVIR
            II = I + NOCC
            DO 3300 K=1,NVIR
              KK = K + NOCC
              IK = (K-1)*NVIR + I
              XIJKL = BUFF(IK)
              IF(ABS(XIJKL).LT.TOL) GO TO 3260
C
              DO 3230 M=1,NCOR
                IMG = IABS(INDEX(II,M))
                KMG = IABS(INDEX(KK,M))
                IF((IMG.EQ.0) .OR. (KMG.EQ.0)) GO TO 3230
                DVAL = OPDM(JJLL)*XIJKL
                CALL DAXPY(NUNIQ,-DVAL,YAO(1,KMG),1,RHSO(1,IMG),1)
 3230         CONTINUE
C
              DO 3250 M=1,NACT
                IMG = IABS(INDEX(II,M+NCOR))
                IF(IMG.EQ.0) GO TO 3250
                MG = MAX(M,J-NCOR)
                JG = MIN(M,J-NCOR)
                MJ = IA(MG) + JG
                DO 3240 N=1,NACT
                  KNG = IABS(INDEX(KK,N+NCOR))
                  IF(KNG.EQ.0) GO TO 3240
                  NG = MAX(N,L-NCOR)
                  LG = MIN(N,L-NCOR)
                  NL = IA(NG) + LG
                  MJG = MAX(MJ,NL)
                  NLG = MIN(MJ,NL)
                  MJNL = IA(MJG) + NLG
                  DVAL = TPDM(MJNL)*XIJKL
                  DVAL = TWO*DVAL
                  CALL DAXPY(NUNIQ,DVAL,YAO(1,KNG),1,RHSO(1,IMG),1)
 3240           CONTINUE
 3250         CONTINUE
C
 3260         IF(J.EQ.L) GO TO 3300
              KI = (I-1)*NVIR + K
              XIJKL = BUFF(KI)
              IF(ABS(XIJKL).LT.TOL) GO TO 3300
C
              DO 3270 M=1,NCOR
                IMG = IABS(INDEX(II,M))
                KMG = IABS(INDEX(KK,M))
                IF((IMG.EQ.0) .OR. (KMG.EQ.0)) GO TO 3270
                DVAL = OPDM(JJLL)*XIJKL
                CALL DAXPY(NUNIQ,-DVAL,YAO(1,KMG),1,RHSO(1,IMG),1)
 3270         CONTINUE
C
              DO 3290 M=1,NACT
                IMG = IABS(INDEX(II,M+NCOR))
                IF(IMG.EQ.0) GO TO 3290
                MG = MAX(M,L-NCOR)
                LG = MIN(M,L-NCOR)
                ML = IA(MG) + LG
                DO 3280 N=1,NACT
                  KNG = IABS(INDEX(KK,N+NCOR))
                  IF(KNG.EQ.0) GO TO 3280
                  NG = MAX(N,J-NCOR)
                  JG = MIN(N,J-NCOR)
                  NJ = IA(NG) + JG
                  MLG = MAX(ML,NJ)
                  NJG = MIN(ML,NJ)
                  MLNJ = IA(MLG) + NJG
                  DVAL = TPDM(MLNJ)*XIJKL
                  DVAL = TWO*DVAL
                  CALL DAXPY(NUNIQ,DVAL,YAO(1,KNG),1,RHSO(1,IMG),1)
 3280           CONTINUE
 3290         CONTINUE
 3300     CONTINUE
C
C          ----- Finished with current integral buffer -----
C
 4000     CALL DDI_PROCDLB_NEXT(C_VOVO,IWP,ICNTR4)
C
        ENDDO
C
 8000 CONTINUE
C
      RETURN
      END
C*MODULE CPMCHF  *DECK HSMLT1
      SUBROUTINE HSMLT1(AVEC,YAC,Y1DEN,RHSC,CI,OINT,AMAT,FC,ICIT,ICI2,
     *                  IND,IO1,JJ,JLO,NSTATS,NDETMX,NDETLN,L1,NCOR,
     *                  N2,NXYZ,WSTATE,SALAG,ITER)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      DIMENSION AVEC(NXYZ,N2),YAC(NXYZ,NSTATS*NDETMX),Y1DEN(NXYZ,N2),
     *          RHSC(NXYZ,NSTATS*NDETLN),CI(NDETMX,NSTATS),OINT(L1,L1),
     *          AMAT(L1,NCOR,N2),WSTATE(*),SALAG(L1,L1,NSTATS*NSTATS)
C
      PARAMETER (TWO=2.0D+00,TOL=1.0D-09)
C
      DO 2000 ISTAT=1,NSTATS
        CVAL = CI(ICI2,ISTAT)
        IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
        FCW = FC*WSTATE(ISTAT)
        IF(ABS(CVAL).LT.TOL) GO TO 1000
        IYIT = (ISTAT-1)*NDETMX + ICIT
C
        DVAL = CVAL*FCW
        CALL DAXPY(NXYZ,DVAL,AVEC(1,IND),1,RHSC(1,IWIT),1)
C
        CALL DAXPY(NXYZ,DVAL,YAC(1,IYIT),1,Y1DEN(1,IND),1)
C
        IF(NSTATS.EQ.1 .OR. ITER.NE.1) GO TO 1000
C
        DO 100 JSTAT=1,NSTATS
          CVAL2 = CI(ICIT,JSTAT)
          IF(ABS(CVAL2).LT.TOL) GO TO 100
          DVAL = FC*CVAL*CVAL2
          IJS = (ISTAT-1)*NSTATS + JSTAT
C
          CALL DAXPY(L1*NCOR,DVAL,AMAT(1,1,IND),1,SALAG(1,1,IJS),1)
C
          IF(IO1.EQ.JJ) DVAL = DVAL*TWO
          CALL DAXPY(L1,DVAL,OINT(1,IO1+NCOR),1,SALAG(1,JJ+NCOR,IJS),1)
          IF(IO1.EQ.JJ) GO TO 100
          CALL DAXPY(L1,DVAL,OINT(1,JJ+NCOR),1,SALAG(1,IO1+NCOR,IJS),1)
  100   CONTINUE
C
C     ----- Multiply one-electron part of configuration hessian -----
C     -----            cross term with trial vector             -----
C
 1000   IF(ABS(FCW).LT.TOL) GO TO 2000
        DLT = FCW*OINT(IO1+NCOR,JJ+NCOR)
        IYI2 = (ISTAT-1)*NDETMX + ICI2
        CALL DAXPY(NXYZ,DLT,YAC(1,IYI2),1,RHSC(1,IWIT),1)
 2000 CONTINUE
C
      RETURN
      END
C*MODULE CPMCHF  *DECK HSMLT2
      SUBROUTINE HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,FC,ICIT,
     *                  ICI2,I,J,K,L,IJ,KL,NACT,NNACT,NSTATS,NXYZ,
     *                  NDETMX,NDETLN,JLO,L1,NCOR,SALAG,ITER,KILL)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      LOGICAL KILL
C
      DIMENSION YADEN(NXYZ,NACT*NACT,NNACT),YAC(NXYZ,NSTATS*NDETMX),
     *          RHSC(NXYZ,NSTATS*NDETLN),WSTATE(*),CI(NDETMX,NSTATS),
     *          ERI(L1,NACT,NNACT),WRK(*),SALAG(L1,L1,NSTATS*NSTATS)
C
      PARAMETER (ONE=1.0D+00,TWO=2.0D+00,TOL=1.0D-09)
C
      CALL VCLR(WRK,1,NXYZ)
      IWRK = 0
C
      IF(KILL) RETURN
      IM = MAX(I,J)
      JM = MIN(I,J)
      IMJM = (IM*IM-IM)/2 + JM
      KM = MAX(K,L)
      LM = MIN(K,L)
      KMLM = (KM*KM-KM)/2 + LM
      IF(IJ.NE.IMJM .OR. KL.NE.KMLM) THEN
        WRITE(6,*) 'IDET,JDET=',ICIT,ICI2
        WRITE(6,*) '   I,J,K,L=',I,J,K,L
        WRITE(6,*) '      IJ,KL=',IJ,KL
        WRITE(6,*) ' '
      ENDIF
C
C
      DO 100 ISTAT=1,NSTATS
        CVAL = CI(ICI2,ISTAT)
        WVAL = WSTATE(ISTAT)
        DVAL = CVAL*WVAL
        IF(ABS(DVAL).LT.TOL) THEN
          IWRK = IWRK + 1
          GO TO 80
        ENDIF
        IYIT = (ISTAT-1)*NDETMX + ICIT
        DVAL = FC*DVAL
        CALL DAXPY(NXYZ,DVAL,YAC(1,IYIT),1,WRK,1)
C
        IF(NSTATS.EQ.1 .OR. ITER.NE.1) GO TO 80
C
        DO 60 JSTAT=1,NSTATS
          CVAL2 = CI(ICIT,JSTAT)
          IF(ABS(CVAL2).LT.TOL) GO TO 60
          DLT = FC*CVAL*CVAL2
          IJS = (ISTAT-1)*NSTATS + JSTAT
C
          DVAL = DLT
          IF(I.EQ.J) DVAL = DVAL*TWO
          IF(IJ.EQ.KL) DVAL = DVAL*TWO
          CALL DAXPY(L1,DVAL,ERI(1,J,KL),1,SALAG(1,I+NCOR,IJS),1)
          IF(I.EQ.J) GO TO 20
C
          DVAL = DLT
          IF(IJ.EQ.KL) DVAL = DVAL*TWO
          CALL DAXPY(L1,DVAL,ERI(1,I,KL),1,SALAG(1,J+NCOR,IJS),1)
C
   20     IF(IJ.EQ.KL) GO TO 60
          DVAL = DLT
          IF(K.EQ.L) DVAL = DVAL*TWO
          CALL DAXPY(L1,DVAL,ERI(1,L,IJ),1,SALAG(1,K+NCOR,IJS),1)
C
          IF(K.EQ.L) GO TO 60
          DVAL = DLT
          CALL DAXPY(L1,DVAL,ERI(1,K,IJ),1,SALAG(1,L+NCOR,IJS),1)
   60   CONTINUE
C
C     ----- Multiply two-electron part of configuration hessian -----
C     -----                 with trial vectors                  -----
C
   80   DVAL = ERI(I+NCOR,J,KL)
        IF(ABS(DVAL).LT.TOL) GO TO 100
        DVAL = DVAL*FC*WVAL
        IYI2 = (ISTAT-1)*NDETMX + ICI2
        IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
        CALL DAXPY(NXYZ,DVAL,YAC(1,IYI2),1,RHSC(1,IWIT),1)
  100 CONTINUE
C
      IF(IWRK.EQ.NSTATS) GO TO 2000
C
      DVAL = ONE
      IIJJ = (J-1)*NACT + I
      IF(I.EQ.J) DVAL = DVAL*TWO
      IF(IJ.EQ.KL) DVAL = DVAL*TWO
      CALL DAXPY(NXYZ,DVAL,WRK,1,YADEN(1,IIJJ,KL),1)
C
      IF(I.EQ.J) GO TO 200
      DVAL = ONE
      JJII = (I-1)*NACT + J
      IF(IJ.EQ.KL) DVAL = DVAL*TWO
      CALL DAXPY(NXYZ,DVAL,WRK,1,YADEN(1,JJII,KL),1)
C
  200 IF(IJ.EQ.KL) GO TO 2000
      DVAL = ONE
      KKLL = (K-1)*NACT + L
      IF(K.EQ.L) DVAL = DVAL*TWO
      CALL DAXPY(NXYZ,DVAL,WRK,1,YADEN(1,KKLL,IJ),1)
C
      IF(K.EQ.L) GO TO 2000
      DVAL = ONE
      LLKK = (L-1)*NACT + K
      CALL DAXPY(NXYZ,DVAL,WRK,1,YADEN(1,LLKK,IJ),1)
C
 2000 CONTINUE
      RETURN
      END
C*MODULE CPMCHF  *DECK HSSCX2
      SUBROUTINE HSSCX2(NACT,NCOR,NA,NB,NALP,NBLP,IFA,IOX,NSYM,IACON1,
     *                  IBCON1,IACON2,IPOSA,IPERA,IIND1,INDEX,IMMA,
     *                  IMMC,ISYMA,ISYMB,ITAB,IMUL,ISPA,ISPB,ISAS,
     *                  ISBS,ISAC,ISBC,ISTRB,ISTRP,ISTART,CI,OINT,
     *                  AMAT,ERI,L1,NROT,NCI,IROT,RHSC,RHSO,YAO,
     *                  YAC,NDETLN,NXYZ,NINDX,JLO,JHI,NSTATS,WSTATE,
     *                  SALAG,YAOG,WRK,YADEN,AVEC,BVEC,YAOTMP,ITER,
     *                  JROTLO,JROTHI)
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      LOGICAL GOPARR,DSKWRK,MASWRK
      LOGICAL RUN
C
      INTEGER POSCP
C
      DIMENSION RHSC(NXYZ,NSTATS*NDETLN),RHSO(NXYZ,NROT)
      DIMENSION YAO(NXYZ,NROT),CI(NCI,NSTATS),YAC(NXYZ,NSTATS*NCI)
      DIMENSION OINT(L1,L1),ERI(L1,NACT,(NACT**2+NACT)/2)
      DIMENSION AMAT(L1,NCOR,(NACT**2+NACT)/2),IROT(L1,L1)
      DIMENSION WSTATE(*),SALAG(*),YAOG(NXYZ),WRK(*)
      DIMENSION YADEN(NXYZ,NACT,NACT*(NACT**2+NACT)/2),AVEC(*),BVEC(*)
      DIMENSION YAOTMP(*)
C
      DIMENSION IOX(NACT)
      DIMENSION IFA(0:NACT,0:NACT)
      DIMENSION IACON1(NA),IBCON1(NA)
      DIMENSION IACON2(NA),IPERA(NA*(NACT-NA))
      DIMENSION IIND1(NA*(NACT-NA),3)
      DIMENSION IPOSA(NA*(NACT-NA))
      DIMENSION INDEX(NINDX,NINDX)
      DIMENSION IMMA(NSYM,NA*(NACT-NA)),IMMC(NSYM)
      DIMENSION ISYMA(NALP),ISYMB(NBLP)
      DIMENSION ITAB(NSYM),IMUL(NSYM,NSYM)
      DIMENSION ISPA(NALP),ISPB(NBLP)
      DIMENSION ISAS(NSYM+1),ISBS(NSYM+1),ISAC(NALP),ISBC(NBLP)
      DIMENSION ISTRB((NBLP*NB*(NACT-NB))/2)
      DIMENSION ISTRP((NBLP*NB*(NACT-NB))/2)
      DIMENSION ISTART(NBLP)
C
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
C
      PARAMETER (ONE=1.0D+00,TOL=1.0D-09)
      ICONST = 1
C     IF (NA.EQ.NB) ICONST = 1
C
C
      RUN = .FALSE.
C
      DO 7 I=1,NINDX
         DO 8 J=1,I
            INDEX(I,J) = I*(I-1)/2 + J
            INDEX(J,I) = INDEX(I,J)
    8    CONTINUE
    7 CONTINUE
C
      NAT = NA
      NBT = NB
      NNACT = (NACT*NACT+NACT)/2
C
      DO 30 I=1,NAT
         IACON1(I) = I
   30 CONTINUE
C
      CALL FMAVEC(AVEC,YAO,AMAT,OINT,IROT,INDEX,L1,NCOR,NACT,NNACT,
     *            NXYZ,NROT,NINDX,JROTLO,JROTHI)
      IF(GOPARR) CALL DDI_GSUMF(2177,AVEC,NXYZ*NNACT)
      CALL VCLR(BVEC,1,NXYZ*NNACT)
C
C   Big Loop over all alpha determinants
C
      DO 9000 IJK = 1,NALP
C
C  Alpha excitations here
C   Single first
C
         IAC = 0
         DO 45 II=1,NSYM
            IMMC(II) = 0
   45    CONTINUE
         ICAT = ISPA(IJK)
         ISA1 = ISYMA(IJK)
         ITAS = ITAB(ISA1)
         DO 7030 IA=1,NAT
             IO1 = IACON1(IA)
             IS1 = IOX(IO1)
             IST = IO1 + 1
             IEN = IACON1(IA+1)-1
             IF (IA.EQ.NAT) IEN=NACT
             DO 7025 KKJ=IA+1,NA+1
                DO 7020 JJ=IST,IEN
                IS2 = IOX(JJ)
                IP1 = IMUL(IS2,IS1)
C
             IAC = IAC + 1
             CALL RET1CP(IACON1,IACON2,NA,IA,JJ,0,KKJ,IPER1)
C
C   Storage here for later use, well worth it
C
             IPET = POSCP(NACT,NA,IACON2,IFA)
             IPOSA(IAC) = ISPA(IPET)
             IMMC(ISYMA(IPET)) = IMMC(ISYMA(IPET)) + 1
             IMMA(ISYMA(IPET),IMMC(ISYMA(IPET))) = IAC
             IPERA(IAC) = ((-1)**IPER1)*ICONST
             IND = INDEX(JJ,IO1)
             IIND1(IAC,1) = IND
             IIND1(IAC,2) = IO1
             IIND1(IAC,3) = JJ
Cc If deoccupied and newly occupied orbitals are of diff symm,
C  skip to doubles
             IF (IS1.NE.IS2) GOTO 417
C
         DO 49 I=1,NBT
            IBCON1(I) = I
   49    CONTINUE
C
C    Loop over beta dets of the right symmetry
C
                   DO 407 INBB = ISBS(ISA1),ISBS(ISA1+1)-1
                   INB1 = ISBC(INBB)
                   ICIT = ICAT+ISPB(INB1)
                   ICI2 = IPOSA(IAC) + ISPB(INB1)
                   FC = IPERA(IAC)
C
                   IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                     CALL HSMLT1(AVEC,YAC,BVEC,RHSC,CI,OINT,AMAT,
     *                           FC,ICIT,ICI2,IND,IO1,JJ,JLO,
     *                           NSTATS,NCI,NDETLN,L1,NCOR,
     *                           NNACT,NXYZ,WSTATE,SALAG,ITER)
                   ENDIF
                   IF(ICI2.GE.JLO .AND. ICI2.LE.JHI) THEN
                     CALL HSMLT1(AVEC,YAC,BVEC,RHSC,CI,OINT,AMAT,
     *                           FC,ICI2,ICIT,IND,IO1,JJ,JLO,
     *                           NSTATS,NCI,NDETLN,L1,NCOR,
     *                           NNACT,NXYZ,WSTATE,SALAG,ITER)
                   ENDIF
  407          CONTINUE
C
                   DO 487 IK=1,NAT
                      IF (IK.EQ.IA) GOTO 487
                      ION = IACON1(IK)
                      J1 = INDEX(ION,ION)
                      J2 = INDEX(ION,JJ)
                      J3 = INDEX(ION,IO1)
                      CALL VCLR(YAOG,1,NXYZ)
                      CALL HSMLTN(YAOG,YAOTMP,IO1,JJ,ION,ION,IND,
     *                            J1,NACT,NNACT,NXYZ,ONE)
                      CALL HSMLTN(YAOG,YAOTMP,IO1,ION,ION,JJ,J3,
     *                            J2,NACT,NNACT,NXYZ,-ONE)
C
                   DO 413 INBB=ISBS(ISA1),ISBS(ISA1+1)-1
                      INB1 = ISBC(INBB)
                      ICIT = ICAT+ISPB(INB1)
                      ICI2 = IPOSA(IAC)+ISPB(INB1)
                      FC = IPERA(IAC)
C
                     IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                       DO ISTAT=1,NSTATS
                         CVAL = CI(ICI2,ISTAT)
                         WVAL = WSTATE(ISTAT)
                         IF(ABS(CVAL).GT.TOL) THEN
                           IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                           DVAL = CVAL*WVAL*FC
                           CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWIT),1)
                         ENDIF
                       ENDDO
                       CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                             FC,ICIT,ICI2,IO1,JJ,ION,ION,IND,J1,
     *                             NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                             JLO,L1,NCOR,SALAG,ITER,RUN)
                       CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                             -FC,ICIT,ICI2,IO1,ION,ION,JJ,J3,J2,
     *                             NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                             JLO,L1,NCOR,SALAG,ITER,RUN)
                     ENDIF
                     IF(ICI2.GE.JLO .AND. ICI2.LE.JHI) THEN
                       DO ISTAT=1,NSTATS
                         CVAL = CI(ICIT,ISTAT)
                         WVAL = WSTATE(ISTAT)
                         IF(ABS(CVAL).GT.TOL) THEN
                           IWI2 = (ISTAT-1)*NDETLN + ICI2 - JLO + 1
                           DVAL = CVAL*WVAL*FC
                           CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI2),1)
                         ENDIF
                       ENDDO
                       CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                             FC,ICI2,ICIT,IO1,JJ,ION,ION,IND,J1,
     *                             NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                             JLO,L1,NCOR,SALAG,ITER,RUN)
                       CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                             -FC,ICI2,ICIT,IO1,ION,ION,JJ,J3,J2,
     *                             NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                             JLO,L1,NCOR,SALAG,ITER,RUN)
                     ENDIF
  413              CONTINUE
C
  487              CONTINUE
C
C                  do 415 inb1=1,nblp
                  NST = 1
                  DO 415 INBB = ISBS(ISA1),ISBS(ISA1+1)-1
                  NEND = ISBC(INBB)
                  DO 5510 KK=NST,NEND-1
                     CALL ADVNCP(IBCON1,NBT,NACT)
 5510             CONTINUE
C
                  ICIT = ICAT+ISPB(NEND)
                  ICI2 = IPOSA(IAC)+ISPB(NEND)
C
                  FC = IPERA(IAC)
C
                     DO 790 IK=1,NBT
                     ION = IBCON1(IK)
                     J1 = INDEX(ION,ION)
                     CALL VCLR(YAOG,1,NXYZ)
                     CALL HSMLTN(YAOG,YAOTMP,IO1,JJ,ION,ION,IND,
     *                           J1,NACT,NNACT,NXYZ,ONE)
C
                     IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                       DO ISTAT=1,NSTATS
                         CVAL = CI(ICI2,ISTAT)
                         WVAL = WSTATE(ISTAT)
                         IF(ABS(CVAL).GT.TOL) THEN
                           IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                           DVAL = CVAL*WVAL*FC
                           CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWIT),1)
                         ENDIF
                       ENDDO
                       CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                             FC,ICIT,ICI2,IO1,JJ,ION,ION,IND,J1,
     *                             NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                             JLO,L1,NCOR,SALAG,ITER,RUN)
                     ENDIF
                     IF(ICI2.GE.JLO .AND. ICI2.LE.JHI) THEN
                       DO ISTAT=1,NSTATS
                         CVAL = CI(ICIT,ISTAT)
                         WVAL = WSTATE(ISTAT)
                         IF(ABS(CVAL).GT.TOL) THEN
                           IWI2 = (ISTAT-1)*NDETLN + ICI2 - JLO + 1
                           DVAL = CVAL*WVAL*FC
                           CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI2),1)
                         ENDIF
                       ENDDO
                       CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                             FC,ICI2,ICIT,IO1,JJ,ION,ION,IND,J1,
     *                             NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                             JLO,L1,NCOR,SALAG,ITER,RUN)
                     ENDIF
  790              CONTINUE
C
Cd           call ADVNCP(ibcon1,nbt,norb)
          NST = NEND
  415     CONTINUE
C
  417     CONTINUE
C
C      Double excitations
C
          DO 4015 IAA = IA+1,NAT
             IPA = IAA
             IIA = IACON1(IAA)
             IS3 = IOX(IIA)
             IF (JJ.GT.IIA) IPA = IPA - 1
             ISTAA = JJ+1
             IENAA = IEN
             DO 4010 KKJAA=KKJ,NA+1
                DO 4005 JJAA=ISTAA,IENAA
                IS4 = IOX(JJAA)
                IP2 = IMUL(IS4,IS3)
                IF (IP1.NE.IP2) GOTO 4005
C
             CALL RET1CP(IACON2,IBCON1,NA,IPA,JJAA,0,KKJAA,IPER2)
             IPET = POSCP(NACT,NA,IBCON1,IFA)
             ICA1 = ISPA(IPET)
             IPERT = IPER1+IPER2
             IPERT = ((-1)**IPERT)*ICONST
                   I2 = INDEX(IACON1(IAA),JJAA)
                   II1 = INDEX(JJAA,IO1)
                   II2 = INDEX(IACON1(IAA),JJ)
                   CALL VCLR(YAOG,1,NXYZ)
                   CALL HSMLTN(YAOG,YAOTMP,IO1,JJ,IIA,JJAA,IND,
     *                         I2,NACT,NNACT,NXYZ,ONE)
                   CALL HSMLTN(YAOG,YAOTMP,IO1,JJAA,IIA,JJ,II1,
     *                         II2,NACT,NNACT,NXYZ,-ONE)
C
                DO 786 INB1 = ISBS(ISA1),ISBS(ISA1+1)-1
                   NEND = ISBC(INB1)
                   ICI2 = ICA1 + ISPB(NEND)
                   ICIT = ICAT+ISPB(NEND)
                   FC = IPERT
C
                   IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                       DO ISTAT=1,NSTATS
                         CVAL = CI(ICI2,ISTAT)
                         WVAL = WSTATE(ISTAT)
                         IF(ABS(CVAL).GT.TOL) THEN
                           IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                           DVAL = CVAL*WVAL*FC
                           CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWIT),1)
                         ENDIF
                       ENDDO
                       CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                             FC,ICIT,ICI2,IO1,JJ,IIA,JJAA,IND,I2,
     *                             NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                             JLO,L1,NCOR,SALAG,ITER,RUN)
                       CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,-FC,
     *                             ICIT,ICI2,IO1,JJAA,IIA,JJ,II1,II2,
     *                             NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                             JLO,L1,NCOR,SALAG,ITER,RUN)
                   ENDIF
                   IF(ICI2.GE.JLO .AND. ICI2.LE.JHI) THEN
                       DO ISTAT=1,NSTATS
                         CVAL = CI(ICIT,ISTAT)
                         WVAL = WSTATE(ISTAT)
                         IF(ABS(CVAL).GT.TOL) THEN
                           IWI2 = (ISTAT-1)*NDETLN + ICI2 - JLO + 1
                           DVAL = CVAL*WVAL*FC
                           CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI2),1)
                         ENDIF
                       ENDDO
                       CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                             FC,ICI2,ICIT,IO1,JJ,IIA,JJAA,IND,I2,
     *                             NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                             JLO,L1,NCOR,SALAG,ITER,RUN)
                       CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,-FC,
     *                             ICI2,ICIT,IO1,JJAA,IIA,JJ,II1,II2,
     *                             NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                             JLO,L1,NCOR,SALAG,ITER,RUN)
                   ENDIF
  786       CONTINUE
C
 4005           CONTINUE
                ISTAA = IACON1(KKJAA)+1
                IENAA = IACON1(KKJAA+1)-1
                IF (KKJAA.EQ.NA) IENAA=NACT
 4010        CONTINUE
 4015 CONTINUE
C
C
 7020           CONTINUE
                IST = IACON1(KKJ)+1
                IEN = IACON1(KKJ+1)-1
                IF (KKJ.EQ.NA) IEN=NACT
 7025        CONTINUE
 7030     CONTINUE
C
C  Diagonal
C
            DO 67 II=1,NAT
               I1 = IACON1(II)
               IND1 = INDEX(I1,I1)
C
              DO 53 INB1 = ISBS(ISA1),ISBS(ISA1+1)-1
                NEND = ISBC(INB1)
                ICIT = ICAT+ISPB(NEND)
                FC = ONE
C
                IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                  CALL HSMLT1(AVEC,YAC,BVEC,RHSC,CI,OINT,AMAT,
     *                        FC,ICIT,ICIT,IND1,I1,I1,JLO,
     *                        NSTATS,NCI,NDETLN,L1,NCOR,
     *                        NNACT,NXYZ,WSTATE,SALAG,ITER)
                ENDIF
   53         CONTINUE
C
               DO 64 JJ=II+1,NAT
                  I2 = IACON1(JJ)
                  IND2 = INDEX(I2,I2)
                  INDM = IND2 - I2 + I1
                  J1 = INDEX(INDM,INDM)
                  J2 = INDEX(IND2,IND1)
                  CALL VCLR(YAOG,1,NXYZ)
                  CALL HSMLTN(YAOG,YAOTMP,I1,I1,I2,I2,IND1,
     *                        IND2,NACT,NNACT,NXYZ,ONE)
                  CALL HSMLTN(YAOG,YAOTMP,I1,I2,I2,I1,INDM,
     *                        INDM,NACT,NNACT,NXYZ,-ONE)
C
               DO 55 INB1 = ISBS(ISA1),ISBS(ISA1+1)-1
                  NEND = ISBC(INB1)
                  ICIT = ICAT+ISPB(NEND)
                  FC = ONE
C
                  IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                       DO ISTAT=1,NSTATS
                         CVAL = CI(ICIT,ISTAT)
                         WVAL = WSTATE(ISTAT)
                         IF(ABS(CVAL).GT.TOL) THEN
                           IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                           DVAL = CVAL*WVAL*FC
                           CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWIT),1)
                         ENDIF
                       ENDDO
                       CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                             FC,ICIT,ICIT,I1,I1,I2,I2,IND1,IND2,
     *                             NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                             JLO,L1,NCOR,SALAG,ITER,RUN)
                       CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,-FC,
     *                             ICIT,ICIT,I1,I2,I2,I1,INDM,INDM,NACT,
     *                             NNACT,NSTATS,NXYZ,NCI,NDETLN,JLO,L1,
     *                             NCOR,SALAG,ITER,RUN)
                  ENDIF
   55          CONTINUE
C
   64          CONTINUE
C
         DO 47 I=1,NBT
            IBCON1(I) = I
   47    CONTINUE
C
             NST = 1
             DO 56 INB1 = ISBS(ISA1),ISBS(ISA1+1)-1
             NEND = ISBC(INB1)
             DO 7710 KK=NST,NEND-1
                CALL ADVNCP(IBCON1,NBT,NACT)
 7710        CONTINUE
             ICIT = ICAT+ISPB(NEND)
C
               DO 68 JJ=1,NBT
                  I2 = IBCON1(JJ)
                  IND2 = INDEX(I2,I2)
                  J2 = INDEX(IND1,IND2)
                  FC = ONE
                  CALL VCLR(YAOG,1,NXYZ)
                  CALL HSMLTN(YAOG,YAOTMP,I1,I1,I2,I2,IND1,
     *                        IND2,NACT,NNACT,NXYZ,ONE)
C
                  IWIT = 0
                  IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                       DO ISTAT=1,NSTATS
                         CVAL = CI(ICIT,ISTAT)
                         WVAL = WSTATE(ISTAT)
                         IF(ABS(CVAL).GT.TOL) THEN
                           IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                           DVAL = CVAL*WVAL*FC
                           CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWIT),1)
                         ENDIF
                       ENDDO
                       CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,FC,
     *                             ICIT,ICIT,I1,I1,I2,I2,IND1,IND2,NACT,
     *                             NNACT,NSTATS,NXYZ,NCI,NDETLN,JLO,L1,
     *                             NCOR,SALAG,ITER,RUN)
                  ENDIF
   68          CONTINUE
C
Cc           call ADVNCP(ibcon1,nbt,norb)
            NST = NEND
   56       CONTINUE
C
   67       CONTINUE
C
C   Loop over Beta dets now
C
C        IF (NA.NE.NB) THEN
         DO 40 II=1,NBT
            IBCON1(II) = II
   40    CONTINUE
         JJZ = 1
C        ELSE
C        DO 41 II=1,NBT
C           IBCON1(II) = IACON1(II)
C  41    CONTINUE
C        JJZ = IJK
C        ENDIF
C
         DO 8000 KJI = JJZ,NBLP
         ISTAR = ISTART(KJI)-1
         IPB1 = ISPB(KJI)
         ISB1 = ISYMB(KJI)
         ITBS = ITAB(ISB1)
         IMZZ = IMMC(ITBS)
         M1 = 0
         M2 = 0
         IF (ISB1.EQ.ITAS) M1 = 1
         IF (IMZZ.NE.0) M2 = 1
         IF (M1.EQ.0.AND.M2.EQ.0) GOTO 7998
         QNUM = 1.0D+00
C        IF (NA.EQ.NB.AND.IJK.EQ.KJI) QNUM=2.0D+00
         IC1 = ICAT + IPB1
C
C   Beta first *********************** Single
C
          DO 900 IB=1,NBT
             IBB = IBCON1(IB)
             IB1 = IOX(IBB)
             IR1 = IMUL(IB1,ISB1)
             IST = IBB+1
             IEN = IBCON1(IB+1)-1
             IF (IB.EQ.NBT) IEN = NACT
             DO 895 KKJ=IB+1,NB+1
                DO 890 JJ=IST,IEN
                IB2 = IOX(JJ)
                ISB2 = IMUL(IR1,IB2)
                ITB2 = ITAB(ISB2)
                ISTAR = ISTAR + 1
                IF (ISB2.NE.ITAS.AND.M1.EQ.0) GOTO 890
                IF (M2.EQ.0.AND.IMMC(ITB2).EQ.0) GOTO 890
                IF (ISB2.NE.ITAS.AND.IMMC(ITB2).EQ.0) GOTO 890
C
C               call RET1MC(ibcon1,iacon2,nb,ib,jj,ncor,kkj,iper1)
C                   iposb = POSCP(nact,nb,iacon2,ifa)
C                  ipb2 = ispb(iposb)
                   IPB2 = ISTRB(ISTAR)
                   IC2 = ICAT + IPB2
C           iperb = ((-1)**iper1)
C   iperb1 = ((-1)**iper1)
                   ZPERB = ISTRP(ISTAR)/QNUM
                   IOB = INDEX(IBB,JJ)
C
C           do 1013 iat=1,iac
C                  ici2 = iposa(iat) + iposb
C                  ici3 = iposa(iat) + kji
CcState average here
C               fc = 0.0d+00
C               fc1 = 0.0d+00
C             do 319 kki=1,nstate
C             fc = fc + W(kki)*CI(ici1,iwh(kki))*CI(ici2,iwh(kki))
C             fc1 = fc1+W(kki)*CI(ici3,iwh(kki))*CI(icit,iwh(kki))
C  319          continue
C             fc = fc * ipera(iat)*zperb
C             fc1=fc1 * ipera(iat)*zperb1
C
C                   ind = iind1(iat)
C                    ix = index(ind,iob)
C                   den2(ix) = den2(ix)+fc+fc1
C                   den2(ix) = den2(ix) + fc
C 1013      continue
C
            IF (M2.EQ.0.AND.IMMC(ITB2).NE.0) THEN
               DO 1013 IAT = 1,IMMC(ITB2)
                  IJU = IMMA(ITB2,IAT)
                  IC4 = IPOSA(IJU) + IPB2
                  IND = IIND1(IJU,1)
                  IXI = IIND1(IJU,2)
                  IXJ = IIND1(IJU,3)
                  FC = IPERA(IJU)*ZPERB
                  CALL VCLR(YAOG,1,NXYZ)
                  CALL HSMLTN(YAOG,YAOTMP,IXI,IXJ,IBB,JJ,IND,
     *                        IOB,NACT,NNACT,NXYZ,ONE)
C
                  IF(IC1.GE.JLO .AND. IC1.LE.JHI) THEN
                     DO ISTAT=1,NSTATS
                       CVAL = CI(IC4,ISTAT)
                       WVAL = WSTATE(ISTAT)
                       IF(ABS(CVAL).GT.TOL) THEN
                         IW1 = (ISTAT-1)*NDETLN + IC1 - JLO + 1
                         DVAL = CVAL*WVAL*FC
                         CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IW1),1)
                       ENDIF
                     ENDDO
                     CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,FC,
     *                           IC1,IC4,IXI,IXJ,IBB,JJ,IND,IOB,NACT,
     *                           NNACT,NSTATS,NXYZ,NCI,NDETLN,JLO,L1,
     *                           NCOR,SALAG,ITER,RUN)
                  ENDIF
                  IF(IC4.GE.JLO .AND. IC4.LE.JHI) THEN
                     DO ISTAT=1,NSTATS
                       CVAL = CI(IC1,ISTAT)
                       WVAL = WSTATE(ISTAT)
                       IF(ABS(CVAL).GT.TOL) THEN
                         IW4 = (ISTAT-1)*NDETLN + IC4 - JLO + 1
                         DVAL = CVAL*WVAL*FC
                         CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IW4),1)
                       ENDIF
                     ENDDO
                     CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,FC,
     *                           IC4,IC1,IXI,IXJ,IBB,JJ,IND,IOB,NACT,
     *                           NNACT,NSTATS,NXYZ,NCI,NDETLN,JLO,L1,
     *                           NCOR,SALAG,ITER,RUN)
                  ENDIF
 1013          CONTINUE
               GOTO 890
          ENDIF
C
            IF (M1.EQ.0.AND.ISB2.EQ.ITAS) THEN
               DO 2013 IAT =1,IMMC(ITBS)
                  IJU = IMMA(ITBS,IAT)
                  IC3 = IPOSA(IJU) + IPB1
                  IND = IIND1(IJU,1)
                  IXI = IIND1(IJU,2)
                  IXJ = IIND1(IJU,3)
                  FC = IPERA(IJU)*ZPERB
                  CALL VCLR(YAOG,1,NXYZ)
                  CALL HSMLTN(YAOG,YAOTMP,IXI,IXJ,IBB,JJ,IND,
     *                        IOB,NACT,NNACT,NXYZ,ONE)
C
                  IF(IC2.GE.JLO .AND. IC2.LE.JHI) THEN
                     DO ISTAT=1,NSTATS
                       CVAL = CI(IC3,ISTAT)
                       WVAL = WSTATE(ISTAT)
                       IF(ABS(CVAL).GT.TOL) THEN
                         IW2 = (ISTAT-1)*NDETLN + IC2 - JLO + 1
                         DVAL = CVAL*WVAL*FC
                         CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IW2),1)
                       ENDIF
                     ENDDO
                     CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,FC,
     *                           IC2,IC3,IXI,IXJ,IBB,JJ,IND,IOB,NACT,
     *                           NNACT,NSTATS,NXYZ,NCI,NDETLN,JLO,L1,
     *                           NCOR,SALAG,ITER,RUN)
                  ENDIF
                  IF(IC3.GE.JLO .AND. IC3.LE.JHI) THEN
                     DO ISTAT=1,NSTATS
                       CVAL = CI(IC2,ISTAT)
                       WVAL = WSTATE(ISTAT)
                       IF(ABS(CVAL).GT.TOL) THEN
                         IW3 = (ISTAT-1)*NDETLN + IC3 - JLO + 1
                         DVAL = CVAL*WVAL*FC
                         CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IW3),1)
                       ENDIF
                     ENDDO
                     CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,FC,
     *                           IC3,IC2,IXI,IXJ,IBB,JJ,IND,IOB,NACT,
     *                           NNACT,NSTATS,NXYZ,NCI,NDETLN,JLO,L1,
     *                           NCOR,SALAG,ITER,RUN)
                  ENDIF
 2013          CONTINUE
               GOTO 890
            ENDIF
C
            IF (ISB2.NE.ITAS.AND.IMMC(ITB2).NE.0) THEN
               DO 3013 IAT = 1,IMMC(ITB2)
                  IJU = IMMA(ITB2,IAT)
                  IC4 = IPOSA(IJU) + IPB2
                  IND = IIND1(IJU,1)
                  IXI = IIND1(IJU,2)
                  IXJ = IIND1(IJU,3)
                  FC = IPERA(IJU)*ZPERB
                  CALL VCLR(YAOG,1,NXYZ)
                  CALL HSMLTN(YAOG,YAOTMP,IXI,IXJ,IBB,JJ,IND,
     *                        IOB,NACT,NNACT,NXYZ,ONE)
C
                  IF(IC1.GE.JLO .AND. IC1.LE.JHI) THEN
                     DO ISTAT=1,NSTATS
                       CVAL = CI(IC4,ISTAT)
                       WVAL = WSTATE(ISTAT)
                       IF(ABS(CVAL).GT.TOL) THEN
                         IW1 = (ISTAT-1)*NDETLN + IC1 - JLO + 1
                         DVAL = CVAL*WVAL*FC
                         CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IW1),1)
                       ENDIF
                     ENDDO
                     CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,FC,
     *                           IC1,IC4,IXI,IXJ,IBB,JJ,IND,IOB,NACT,
     *                           NNACT,NSTATS,NXYZ,NCI,NDETLN,JLO,L1,
     *                           NCOR,SALAG,ITER,RUN)
                  ENDIF
                  IF(IC4.GE.JLO .AND. IC4.LE.JHI) THEN
                     DO ISTAT=1,NSTATS
                       CVAL = CI(IC1,ISTAT)
                       WVAL = WSTATE(ISTAT)
                       IF(ABS(CVAL).GT.TOL) THEN
                         IW4 = (ISTAT-1)*NDETLN + IC4 - JLO + 1
                         DVAL = CVAL*WVAL*FC
                         CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IW4),1)
                       ENDIF
                     ENDDO
                     CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,FC,
     *                           IC4,IC1,IXI,IXJ,IBB,JJ,IND,IOB,NACT,
     *                           NNACT,NSTATS,NXYZ,NCI,NDETLN,JLO,L1,
     *                           NCOR,SALAG,ITER,RUN)
                  ENDIF
 3013          CONTINUE
               GOTO 890
            ENDIF
C
            IF (IMMC(ITB2).EQ.0.AND.ISB2.EQ.ITAS) THEN
               DO 4013 IAT =1,IMMC(ITBS)
                  IJU = IMMA(ITBS,IAT)
                  IC3 = IPOSA(IJU) + IPB1
                  IND = IIND1(IJU,1)
                  IXI = IIND1(IJU,2)
                  IXJ = IIND1(IJU,3)
                  FC = IPERA(IJU)*ZPERB
                  CALL VCLR(YAOG,1,NXYZ)
                  CALL HSMLTN(YAOG,YAOTMP,IXI,IXJ,IBB,JJ,IND,
     *                        IOB,NACT,NNACT,NXYZ,ONE)
C
                  IF(IC2.GE.JLO .AND. IC2.LE.JHI) THEN
                     DO ISTAT=1,NSTATS
                       CVAL = CI(IC3,ISTAT)
                       WVAL = WSTATE(ISTAT)
                       IF(ABS(CVAL).GT.TOL) THEN
                         IW2 = (ISTAT-1)*NDETLN + IC2 - JLO + 1
                         DVAL = CVAL*WVAL*FC
                         CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IW2),1)
                       ENDIF
                     ENDDO
                     CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,FC,
     *                           IC2,IC3,IXI,IXJ,IBB,JJ,IND,IOB,NACT,
     *                           NNACT,NSTATS,NXYZ,NCI,NDETLN,JLO,L1,
     *                           NCOR,SALAG,ITER,RUN)
                  ENDIF
                  IF(IC3.GE.JLO .AND. IC3.LE.JHI) THEN
                     DO ISTAT=1,NSTATS
                       CVAL = CI(IC2,ISTAT)
                       WVAL = WSTATE(ISTAT)
                       IF(ABS(CVAL).GT.TOL) THEN
                         IW3 = (ISTAT-1)*NDETLN + IC3 - JLO + 1
                         DVAL = CVAL*WVAL*FC
                         CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IW3),1)
                       ENDIF
                     ENDDO
                     CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,FC,
     *                           IC3,IC2,IXI,IXJ,IBB,JJ,IND,IOB,NACT,
     *                           NNACT,NSTATS,NXYZ,NCI,NDETLN,JLO,L1,
     *                           NCOR,SALAG,ITER,RUN)
                  ENDIF
 4013          CONTINUE
               GOTO 890
            ENDIF
C
            IF (IMMC(ITB2).NE.0.AND.ISB2.EQ.ITAS) THEN
               DO 5013 IAT=1,IMMC(ITB2)
                  IJU = IMMA(ITB2,IAT)
                  IC3 = IPOSA(IJU) + IPB1
                  IC4 = IPOSA(IJU) + IPB2
                  IND = IIND1(IJU,1)
                  IXI = IIND1(IJU,2)
                  IXJ = IIND1(IJU,3)
                  FC = IPERA(IJU)*ZPERB
                  CALL VCLR(YAOG,1,NXYZ)
                  CALL HSMLTN(YAOG,YAOTMP,IXI,IXJ,IBB,JJ,IND,
     *                        IOB,NACT,NNACT,NXYZ,ONE)
C
                  IF(IC2.GE.JLO .AND. IC2.LE.JHI) THEN
                     DO ISTAT=1,NSTATS
                       CVAL = CI(IC3,ISTAT)
                       WVAL = WSTATE(ISTAT)
                       IF(ABS(CVAL).GT.TOL) THEN
                         IW2 = (ISTAT-1)*NDETLN + IC2 - JLO + 1
                         DVAL = CVAL*WVAL*FC
                         CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IW2),1)
                       ENDIF
                     ENDDO
                     CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,FC,
     *                           IC2,IC3,IXI,IXJ,IBB,JJ,IND,IOB,NACT,
     *                           NNACT,NSTATS,NXYZ,NCI,NDETLN,JLO,L1,
     *                           NCOR,SALAG,ITER,RUN)
                  ENDIF
                  IF(IC3.GE.JLO .AND. IC3.LE.JHI) THEN
                     DO ISTAT=1,NSTATS
                       CVAL = CI(IC2,ISTAT)
                       WVAL = WSTATE(ISTAT)
                       IF(ABS(CVAL).GT.TOL) THEN
                         IW3 = (ISTAT-1)*NDETLN + IC3 - JLO + 1
                         DVAL = CVAL*WVAL*FC
                         CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IW3),1)
                       ENDIF
                     ENDDO
                     CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,FC,
     *                           IC3,IC2,IXI,IXJ,IBB,JJ,IND,IOB,NACT,
     *                           NNACT,NSTATS,NXYZ,NCI,NDETLN,JLO,L1,
     *                           NCOR,SALAG,ITER,RUN)
                  ENDIF
C
                  IF(IC1.GE.JLO .AND. IC1.LE.JHI) THEN
                     DO ISTAT=1,NSTATS
                       CVAL = CI(IC4,ISTAT)
                       WVAL = WSTATE(ISTAT)
                       IF(ABS(CVAL).GT.TOL) THEN
                         IW1 = (ISTAT-1)*NDETLN + IC1 - JLO + 1
                         DVAL = CVAL*WVAL*FC
                         CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IW1),1)
                       ENDIF
                     ENDDO
                     CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,FC,
     *                           IC1,IC4,IXI,IXJ,IBB,JJ,IND,IOB,NACT,
     *                           NNACT,NSTATS,NXYZ,NCI,NDETLN,JLO,L1,
     *                           NCOR,SALAG,ITER,RUN)
                  ENDIF
                  IF(IC4.GE.JLO .AND. IC4.LE.JHI) THEN
                     DO ISTAT=1,NSTATS
                       CVAL = CI(IC1,ISTAT)
                       WVAL = WSTATE(ISTAT)
                       IF(ABS(CVAL).GT.TOL) THEN
                         IW4 = (ISTAT-1)*NDETLN + IC4 - JLO + 1
                         DVAL = CVAL*WVAL*FC
                         CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IW4),1)
                       ENDIF
                     ENDDO
                     CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,FC,
     *                           IC4,IC1,IXI,IXJ,IBB,JJ,IND,IOB,NACT,
     *                           NNACT,NSTATS,NXYZ,NCI,NDETLN,JLO,L1,
     *                           NCOR,SALAG,ITER,RUN)
                  ENDIF
 5013          CONTINUE
               GOTO 890
            ENDIF
C
  890           CONTINUE
                IST = IBCON1(KKJ)+1
                IEN = IBCON1(KKJ+1)-1
                IF (KKJ.EQ.NB) IEN=NACT
  895        CONTINUE
  900     CONTINUE
C
 7998     CONTINUE
           CALL ADVNCP(IBCON1,NBT,NACT)
 8000    CONTINUE
      CALL ADVNCP(IACON1,NAT,NACT)
 9000 CONTINUE
C
C   Now for the Beta part
C
C
      DO 876 JJI=1,NBT
         IBCON1(JJI) = JJI
  876 CONTINUE
C
      DO 9999 IJK = 1,NBLP
         ICAB = ISPB(IJK)
         ISB1 = ISYMB(IJK)
C itb1 = itab(isb1)
C        IF (NA.EQ.NB) GOTO 7999
C
      DO 6030 IB=1,NBT
         IST = IBCON1(IB)+1
         IEN = IBCON1(IB+1)-1
         IF (IB.EQ.NBT) IEN=NACT
         IO1 = IBCON1(IB)
         IS1 = IOX(IO1)
         DO 6025 KKJ=IB+1,NB+1
            DO 6020 JJ=IST,IEN
            IS2 = IOX(JJ)
            IP1 = IMUL(IS2,IS1)
C
            CALL RET1CP(IBCON1,IACON2,NB,IB,JJ,0,KKJ,IPER1)
C           IPER = ((-1)**IPER1)*2
            IPER = ((-1)**IPER1)
            IND = INDEX(JJ,IO1)
Cc If deoccupied and newly occupied are of diff sym,
C   then skip to doubles
            IF (IS1.NE.IS2) GOTO 517
            IPB1 = POSCP(NACT,NB,IACON2,IFA)
            IPB1 = ISPB(IPB1)
       DO 89 I=1,NAT
          IACON1(I) = I
   89 CONTINUE
C
C  Loop over alpha
C
          DO 907 INA1 = ISAS(ISB1),ISAS(ISB1+1)-1
             ICIA = ISAC(INA1)
             ICIT = ISPA(ICIA) + ICAB
             ICI2 = ISPA(ICIA) + IPB1
             FC = IPER
C
             IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
               CALL HSMLT1(AVEC,YAC,BVEC,RHSC,CI,OINT,AMAT,
     *                     FC,ICIT,ICI2,IND,IO1,JJ,JLO,
     *                     NSTATS,NCI,NDETLN,L1,NCOR,
     *                     NNACT,NXYZ,WSTATE,SALAG,ITER)
             ENDIF
             IF(ICI2.GE.JLO .AND. ICI2.LE.JHI) THEN
               CALL HSMLT1(AVEC,YAC,BVEC,RHSC,CI,OINT,AMAT,
     *                     FC,ICI2,ICIT,IND,IO1,JJ,JLO,
     *                     NSTATS,NCI,NDETLN,L1,NCOR,
     *                     NNACT,NXYZ,WSTATE,SALAG,ITER)
             ENDIF
  907     CONTINUE
C
             DO 687 IK=1,NBT
                IF (IK.EQ.IB) GOTO 687
                ION = IBCON1(IK)
                J1 = INDEX(ION,ION)
                J2 = INDEX(ION,JJ)
                J3 = INDEX(ION,IO1)
                CALL VCLR(YAOG,1,NXYZ)
                CALL HSMLTN(YAOG,YAOTMP,IO1,JJ,ION,ION,IND,
     *                      J1,NACT,NNACT,NXYZ,ONE)
                CALL HSMLTN(YAOG,YAOTMP,IO1,ION,ION,JJ,J3,
     *                      J2,NACT,NNACT,NXYZ,-ONE)
C
           DO 918 INA1 = ISAS(ISB1),ISAS(ISB1+1)-1
               ICIA = ISAC(INA1)
               ICIT = ISPA(ICIA) + ICAB
               ICI2 = ISPA(ICIA) + IPB1
               FC = IPER
C
               IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                 DO ISTAT=1,NSTATS
                   CVAL = CI(ICI2,ISTAT)
                   WVAL = WSTATE(ISTAT)
                   IF(ABS(CVAL).GT.TOL) THEN
                     IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                     DVAL = CVAL*WVAL*FC
                     CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWIT),1)
                   ENDIF
                 ENDDO
                 CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,FC,ICIT,
     *                       ICI2,IO1,JJ,ION,ION,IND,J1,NACT,
     *                       NNACT,NSTATS,NXYZ,NCI,NDETLN,JLO,L1,NCOR,
     *                       SALAG,ITER,RUN)
                 CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,-FC,ICIT,
     *                       ICI2,IO1,ION,ION,JJ,J3,J2,NACT,NNACT,
     *                       NSTATS,NXYZ,NCI,NDETLN,JLO,L1,NCOR,SALAG,
     *                       ITER,RUN)
               ENDIF
               IF(ICI2.GE.JLO .AND. ICI2.LE.JHI) THEN
                 DO ISTAT=1,NSTATS
                   CVAL = CI(ICIT,ISTAT)
                   WVAL = WSTATE(ISTAT)
                   IF(ABS(CVAL).GT.TOL) THEN
                     IWI2 = (ISTAT-1)*NDETLN + ICI2 - JLO + 1
                     DVAL = CVAL*WVAL*FC
                     CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI2),1)
                   ENDIF
                 ENDDO
                 CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,FC,ICI2,
     *                       ICIT,IO1,JJ,ION,ION,IND,J1,NACT,NNACT,
     *                       NSTATS,NXYZ,NCI,NDETLN,JLO,L1,NCOR,SALAG,
     *                       ITER,RUN)
                 CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,-FC,ICI2,
     *                       ICIT,IO1,ION,ION,JJ,J3,J2,NACT,NNACT,
     *                       NSTATS,NXYZ,NCI,NDETLN,JLO,L1,NCOR,SALAG,
     *                       ITER,RUN)
               ENDIF
  918      CONTINUE
C
  687        CONTINUE
C
            NST = 1
            DO 920 INA1 = ISAS(ISB1),ISAS(ISB1+1)-1
            NEND = ISAC(INA1)
            DO 8810 KK=NST,NEND-1
               CALL ADVNCP(IACON1,NAT,NACT)
 8810       CONTINUE
            ICIA = ISPA(NEND)
            ICIT = ICIA + ICAB
            ICI2 = ICIA  + IPB1
C
             DO 690 IK=1,NAT
                ION = IACON1(IK)
                J1 = INDEX(ION,ION)
                FC = IPER
                CALL VCLR(YAOG,1,NXYZ)
                CALL HSMLTN(YAOG,YAOTMP,IO1,JJ,ION,ION,IND,
     *                      J1,NACT,NNACT,NXYZ,ONE)
C
                IWIT = 0
                IWI2 = 0
                IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                  DO ISTAT=1,NSTATS
                    CVAL = CI(ICI2,ISTAT)
                    WVAL = WSTATE(ISTAT)
                    IF(ABS(CVAL).GT.TOL) THEN
                      IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                      DVAL = CVAL*WVAL*FC
                      CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWIT),1)
                    ENDIF
                  ENDDO
                  CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,FC,ICIT,
     *                        ICI2,IO1,JJ,ION,ION,IND,J1,NACT,NNACT,
     *                        NSTATS,NXYZ,NCI,NDETLN,JLO,L1,NCOR,SALAG,
     *                        ITER,RUN)
                ENDIF
                IF(ICI2.GE.JLO .AND. ICI2.LE.JHI) THEN
                  DO ISTAT=1,NSTATS
                    CVAL = CI(ICIT,ISTAT)
                    WVAL = WSTATE(ISTAT)
                    IF(ABS(CVAL).GT.TOL) THEN
                      IWI2 = (ISTAT-1)*NDETLN + ICI2 - JLO + 1
                      DVAL = CVAL*WVAL*FC
                      CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI2),1)
                    ENDIF
                  ENDDO
                  CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,FC,ICI2,
     *                        ICIT,IO1,JJ,ION,ION,IND,J1,NACT,NNACT,
     *                        NSTATS,NXYZ,NCI,NDETLN,JLO,L1,NCOR,SALAG,
     *                        ITER,RUN)
                ENDIF
  690        CONTINUE
Cdo           call ADVNCP(iacon1,nat,norb)
             NST = NEND
  920    CONTINUE
C
  517   CONTINUE
C
C  Now for beta doubles
C
       DO 6015 IBB = IB+1,NBT
               ISTBB = JJ+1
               IENBB = IEN
               JB = IBCON1(IBB)
               IS3 = IOX(JB)
               IPB = IBB
               IF (JJ.GT.JB) IPB = IPB - 1
               DO 6010 KKJBB = KKJ,NB+1
                  DO 6005 JJBB = ISTBB,IENBB
                    IS4 = IOX(JJBB)
                    IP2 = IMUL(IS4,IS3)
                    IF (IP1.NE.IP2) GOTO 6005
C
          CALL RET1CP(IACON2,IACON1,NB,IPB,JJBB,0,KKJBB,IPER2)
          IBP2 = POSCP(NACT,NB,IACON1,IFA)
          IBP2 = ISPB(IBP2)
          IPER = IPER1+IPER2
C         IPER = ((-1)**IPER)*2
          IPER = ((-1)**IPER)
               I2 = INDEX(JB,JJBB)
               II1 = INDEX(JJBB,IO1)
               II2 = INDEX(JB,JJ)
               CALL VCLR(YAOG,1,NXYZ)
               CALL HSMLTN(YAOG,YAOTMP,IO1,JJ,JB,JJBB,IND,
     *                     I2,NACT,NNACT,NXYZ,ONE)
               CALL HSMLTN(YAOG,YAOTMP,IO1,JJBB,JB,JJ,II1,
     *                     II2,NACT,NNACT,NXYZ,-ONE)
C
             DO 686 INA1 = ISAS(ISB1),ISAS(ISB1+1)-1
             NEND = ISAC(INA1)
             ICIA = ISPA(NEND)
             ICIT = ICIA + ICAB
             ICI2 = ICIA + IBP2
             FC = IPER
C
               IWIT = 0
               IWI2 = 0
               IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                  DO ISTAT=1,NSTATS
                    CVAL = CI(ICI2,ISTAT)
                    WVAL = WSTATE(ISTAT)
                    IF(ABS(CVAL).GT.TOL) THEN
                      IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                      DVAL = CVAL*WVAL*FC
                      CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWIT),1)
                    ENDIF
                  ENDDO
                  CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,FC,ICIT,
     *                        ICI2,IO1,JJ,JB,JJBB,IND,I2,NACT,NNACT,
     *                        NSTATS,NXYZ,NCI,NDETLN,JLO,L1,NCOR,SALAG,
     *                        ITER,RUN)
                  CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,-FC,ICIT,
     *                        ICI2,IO1,JJBB,JB,JJ,II1,II2,NACT,NNACT,
     *                        NSTATS,NXYZ,NCI,NDETLN,JLO,L1,NCOR,SALAG,
     *                        ITER,RUN)
               ENDIF
               IF(ICI2.GE.JLO .AND. ICI2.LE.JHI) THEN
                  DO ISTAT=1,NSTATS
                    CVAL = CI(ICIT,ISTAT)
                    WVAL = WSTATE(ISTAT)
                    IF(ABS(CVAL).GT.TOL) THEN
                      IWI2 = (ISTAT-1)*NDETLN + ICI2 - JLO + 1
                      DVAL = CVAL*WVAL*FC
                      CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI2),1)
                    ENDIF
                  ENDDO
                  CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,FC,ICI2,
     *                        ICIT,IO1,JJ,JB,JJBB,IND,I2,NACT,NNACT,
     *                        NSTATS,NXYZ,NCI,NDETLN,JLO,L1,NCOR,SALAG,
     *                        ITER,RUN)
                  CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,-FC,ICI2,
     *                        ICIT,IO1,JJBB,JB,JJ,II1,II2,NACT,NNACT,
     *                        NSTATS,NXYZ,NCI,NDETLN,JLO,L1,NCOR,SALAG,
     *                        ITER,RUN)
               ENDIF
  686       CONTINUE
C
 6005          CONTINUE
               ISTBB = IBCON1(KKJBB)+1
               IENBB = IBCON1(KKJBB+1)-1
               IF (KKJBB.EQ.NB) IENBB=NACT
 6010      CONTINUE
 6015 CONTINUE
C
 6020       CONTINUE
            IST = IBCON1(KKJ)+1
            IEN=IBCON1(KKJ+1)-1
            IF (KKJ.EQ.NB) IEN=NACT
 6025     CONTINUE
 6030 CONTINUE
C
C    Remaining part of diagonal contributions
C
            DO 69 II=1,NBT
               I1 = IBCON1(II)
               IND1 = INDEX(I1,I1)
C
            DO 93 INA1 = ISAS(ISB1),ISAS(ISB1+1)-1
              NEND = ISAC(INA1)
              ICIA = ISPA(NEND)
              ICIT = ICIA + ICAB
              FC = ONE
C
              IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                CALL HSMLT1(AVEC,YAC,BVEC,RHSC,CI,OINT,AMAT,
     *                      FC,ICIT,ICIT,IND1,I1,I1,JLO,
     *                      NSTATS,NCI,NDETLN,L1,NCOR,
     *                      NNACT,NXYZ,WSTATE,SALAG,ITER)
              ENDIF
   93       CONTINUE
C
               DO 74 JJ=II+1,NBT
                  I2 = IBCON1(JJ)
                  IND2 = INDEX(I2,I2)
                  INDM = IND2-I2+I1
                  J1 = INDEX(INDM,INDM)
                  J2 = INDEX(IND2,IND1)
                  CALL VCLR(YAOG,1,NXYZ)
                  CALL HSMLTN(YAOG,YAOTMP,I1,I1,I2,I2,IND1,
     *                        IND2,NACT,NNACT,NXYZ,ONE)
                  CALL HSMLTN(YAOG,YAOTMP,I1,I2,I2,I1,INDM,
     *                        INDM,NACT,NNACT,NXYZ,-ONE)
C
            DO 97 INA1 = ISAS(ISB1),ISAS(ISB1+1)-1
               NEND = ISAC(INA1)
               ICIA = ISPA(NEND)
               ICIT = ICIA + ICAB
               FC = ONE
C
               IWIT = 0
               IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                  DO ISTAT=1,NSTATS
                    CVAL = CI(ICIT,ISTAT)
                    WVAL = WSTATE(ISTAT)
                    IF(ABS(CVAL).GT.TOL) THEN
                      IWIT = (ISTAT-1)*NDETLN + ICIT - JLO + 1
                      DVAL = CVAL*WVAL*FC
                      CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWIT),1)
                    ENDIF
                  ENDDO
                  CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,FC,ICIT,
     *                        ICIT,I1,I1,I2,I2,IND1,IND2,NACT,NNACT,
     *                        NSTATS,NXYZ,NCI,NDETLN,JLO,L1,NCOR,SALAG,
     *                        ITER,RUN)
                  CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,-FC,ICIT,
     *                        ICIT,I1,I2,I2,I1,INDM,INDM,NACT,NNACT,
     *                        NSTATS,NXYZ,NCI,NDETLN,JLO,L1,NCOR,SALAG,
     *                        ITER,RUN)
               ENDIF
   97       CONTINUE
C
   74          CONTINUE
C
   69       CONTINUE
           CALL ADVNCP(IBCON1,NBT,NACT)
 9999 CONTINUE
C
      CALL FMRHSO(RHSO,YADEN,BVEC,ERI,AMAT,OINT,WRK,IROT,INDEX,NACT,
     *            NNACT,NCOR,NXYZ,L1,NROT,NINDX)
C
      RETURN
      END
C*MODULE CPMCHF  *DECK HSSCXO
      SUBROUTINE HSSCXO(YAOG,YAO,ERI,IROT,NXYZ,NACT,NCOR,NNACT,NROT,L1,
     *                  JRLO,JRHI,GOPARR)
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      LOGICAL GOPARR
C
      DIMENSION YAOG(NXYZ,NACT*NACT,NNACT),YAO(NXYZ,NROT),
     *          ERI(L1,NACT,NNACT)
      DIMENSION IROT(L1,L1)
C
      PARAMETER (TOL=1.0D-09)
C
      CALL VCLR(YAOG,1,NXYZ*NACT*NACT*NNACT)
C
      DO 1000 I=1,NACT
        DO 900 M=1,L1
          IPHSE = IROT(M,I+NCOR)
          MI = IABS(IPHSE)
          IF(MI.LT.JRLO .OR. MI.GT.JRHI) GO TO 900
          DO 800 J=1,NACT
            IJ = (J-1)*NACT + I
            DO 700 KL=1,NNACT
              DLT = ERI(M,J,KL)
              IF(ABS(DLT).LT.TOL) GO TO 700
              DLT = DLT*MI/IPHSE
              CALL DAXPY(NXYZ,DLT,YAO(1,MI),1,YAOG(1,IJ,KL),1)
  700       CONTINUE
  800     CONTINUE
  900   CONTINUE
 1000 CONTINUE
C
      IF(GOPARR) CALL DDI_GSUMF(2179,YAOG,NXYZ*NACT*NACT*NNACT)
C
      RETURN
      END
C*MODULE CPMCHF  *DECK JCPDET
      SUBROUTINE JCPDET(WAXCI,PRCNDC,PRCNDS,CI,CIOLD,DFC,DERI,DHC,FCOR,
     *                  ERI,EG,OINT,WSTATE,IOX,IFA,IWRK,NDETMX,NDETLN,
     *                  NCI,NACT,NCOR,NA,NB,IDSYM,ISYM1,NSYM,IIS,IW,
     *                  NXYZ,L1,JLO,JHI,NSTATS,NNSTAT)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      LOGICAL GOPARR,DSKWRK,MASWRK
C
      DIMENSION WAXCI(NXYZ,NSTATS*NDETLN),PRCNDC(NDETLN,NSTATS),
     *          PRCNDS(*),CI(NDETMX,NSTATS),CIOLD(NCI,NSTATS),DFC(*),
     *          DERI(*),DHC(NXYZ),FCOR(*),ERI(*),EG(NXYZ,NNSTAT),
     *          OINT(*),WSTATE(*)
      DIMENSION IOX(NACT),IFA(0:NACT,0:NACT),IWRK(IIS)
C
      PARAMETER (MXRT=100)
C
      COMMON /ENRGYS/ ENUCR,EELCT,ETOT,SZ,SZZ,ECORE,ESCF,EERD,E1,E2,
     *                VEN,VEE,EPOT,EKIN,ESTATE(MXRT),STATN,EDFT(2),EDISP
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
C
      PARAMETER (HALF=0.5D+00,TOL=1.0D-09)
C
      NORB = NACT+NCOR
      N2 = (NACT*NACT+NACT)/2
      NINDX = N2
      IF(NORB.GT.NINDX) NINDX = NORB
      NALP = IFA(NACT,NA)
      NBLP = IFA(NACT,NB)
C
C     ----- Set starting point for various arrays -----
C
      ISYMA = 1
      ISYMB = ISYMA + NALP
      ICOA = ISYMB + NBLP
      ICOB = ICOA + NSYM
      ITAB = ICOB + NSYM
      IMUL = ITAB + NSYM
      ISPA = IMUL + NSYM*NSYM
      ISPB = ISPA + NALP
      ISAS = ISPB + NBLP
      ISBS = ISAS + NSYM+1
      ISAC = ISBS + NSYM+1
      ISBC = ISAC + NALP
C
      IACON1 = ISBC + NBLP
      IBCON1 = IACON1 + NA + 43
      IACON2 = IBCON1 + NA
      IBCON2 = IACON2 + NA
      IPOSA = IBCON2 + NB
      IPERA = IPOSA + (NA*(NACT-NA))
      IIND1 = IPERA + (NA*(NACT-NA))
      INDEX = IIND1 + (NA*(NACT-NA))
      IMMA = INDEX + NINDX*NINDX
      IMMC = IMMA + NSYM*(NA*(NACT-NA))
      ISTRB = IMMC + NSYM
      ISTRP = ISTRB + ((NB*(NACT-NB))*NBLP)/2
      ISTAR = ISTRP + ((NB*(NACT-NB))*NBLP)/2
      ITOT = ISTAR + NBLP - 1
C
      IF(ITOT.GT.IIS) THEN
        IF(MASWRK) THEN
          WRITE(IW,*) 'NOT ENOUGH MEMORY SPECIFIED FOR IWRK'
          WRITE(IW,*) 'ASKED FOR ',IIS,' NEED ',ITOT
        END IF
        CALL ABRT
      END IF
C
C     ----- Expand CI vector over all symmetry determinants -----
C     -----             and set symmetry to C1              -----
C
        CALL VCLR(CI,1,NSTATS*NDETMX)
        CALL DETCP(IW,IOX,NACT,NA,NB,IDSYM,ISYM1,NSYM,NALP,NBLP,
     *             IWRK(IACON1),IWRK(ISYMA),IWRK(ISYMB),IWRK(ICOA),
     *             IWRK(ICOB),IWRK(ITAB),IWRK(IMUL),IWRK(ISPA),
     *             IWRK(ISPB),IWRK(ISAS),IWRK(ISBS),IWRK(ISAC),
     *             IWRK(ISBC),NSTATS,CI,CIOLD)
C
      CALL SETUP(NACT,0,NA,NB,IWRK(IBCON1),
     *           IWRK(IACON2),IFA,IWRK(INDEX),IWRK(ISPB),NBLP,
     *           IWRK(ISTRB),IWRK(ISTRP),IWRK(ISTAR))
C
C     ----- Add one- and two-electron coupling constant terms -----
C     -----              to perturbed quantities              -----
C
      CALL VCLR(PRCNDC,1,NSTATS*NDETLN)
      CALL VCLR(PRCNDS,1,NNSTAT)
      CALL VCLR(WAXCI,1,NXYZ*NSTATS*NDETLN)
      CALL CPDRD2(WAXCI,PRCNDC,CI,DFC,DERI,FCOR,ERI,IWRK(INDEX),
     *            IWRK(IACON1),IWRK(IACON2),IWRK(IMMA),IWRK(IMMC),
     *            IWRK(ISPA),IWRK(ISPB),IWRK(ISYMA),IWRK(ISYMB),
     *            IWRK(ITAB),IOX,IWRK(IMUL),IWRK(IPOSA),IWRK(IPERA),
     *            IWRK(IIND1),IWRK(IBCON1),IWRK(ISAS),IWRK(ISBS),
     *            IWRK(ISAC),IWRK(ISBC),IWRK(ISTAR),IWRK(ISTRB),
     *            IWRK(ISTRP),IFA,NINDX,NDETLN,NACT,NCOR,NA,NB,NALP,
     *            NBLP,NSYM,NXYZ,L1,N2,JLO,JHI,NDETMX,NSTATS)
C
C     ----- Finish perturbed configuration gradient -----
C     -----            and preconditioner           -----
C
      DHCME = ENUCR
      DO I=1,NCOR
        II = (I*I+I)/2
        DHCME = DHCME + OINT(II) + FCOR(II)
      ENDDO
C
      IJSTAT = 0
      DO ISTAT=1,NSTATS
        EVAL = DHCME - ESTATE(ISTAT)
        DO 100 I=JLO,JHI
          CVAL = CI(I,ISTAT)
          IVAL = I - JLO + 1
          PRCNDC(IVAL,ISTAT) = PRCNDC(IVAL,ISTAT) + EVAL
          IF(ABS(CVAL).LT.TOL) GO TO 100
          PRCNDC(IVAL,ISTAT) = PRCNDC(IVAL,ISTAT) + HALF*CVAL*CVAL
          IVAL = IVAL + (ISTAT-1)*NDETLN
          CALL DAXPY(NXYZ,CVAL,DHC,1,WAXCI(1,IVAL),1)
  100   CONTINUE
C
        DO 120 JSTAT=1,ISTAT-1
          IJSTAT = IJSTAT + 1
          EVAL = ESTATE(JSTAT) - ESTATE(ISTAT)
          WVAL = WSTATE(ISTAT) - WSTATE(JSTAT)
          PRCNDS(IJSTAT) = EVAL*WVAL
  120   CONTINUE
      ENDDO
C
      CALL VCLR(EG,1,NNSTAT*NXYZ)
C
      DO 200 ISTAT=1,NSTATS
        DO 200 JSTAT=1,ISTAT
          IJ = (ISTAT*ISTAT-ISTAT)/2 + JSTAT
          DO 150 I=JLO,JHI
            CVAL = CI(I,JSTAT)
            IF(ABS(CVAL).LT.TOL) GO TO 150
            IVAL = (ISTAT-1)*NDETLN + I - JLO + 1
            CALL DAXPY(NXYZ,CVAL,WAXCI(1,IVAL),1,EG(1,IJ),1)
  150     CONTINUE
  200 CONTINUE
C
      IF(GOPARR) CALL DDI_GSUMF(2175,EG,NXYZ*NNSTAT)
C
      RETURN
      END
C*MODULE CPMCHF  *DECK JCPORM
      SUBROUTINE JCPORM(DFC,WAXCI,DHC,DERI,FCOR,OINT,ERI,PRCNDC,PRCNDS,
     *                  CI,CIOLD,WSTMP,EG,LBOX1,LBOX2,LBOX3,LBOX4,LBOX5,
     *                  IOX,IWRK,IW,NDER,NXYZ,L1,L2,N2,N4,LNEED,JLO,
     *                  JHI,NDETMX,NDETLN,NSTATS,ITGA,ITGB,IAST,IBST,
     *                  IIS,NNSTAT,NB1EX)
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      LOGICAL FDIRCT,QCORR,GOPARR,DSKWRK,MASWRK
C
      DIMENSION DFC(NXYZ,L2),WAXCI(NXYZ,NSTATS*NDETLN),DHC(NXYZ),
     *          DERI(NXYZ,N4),FCOR(L2),OINT(*),ERI(*),
     *          PRCNDC(NDETLN,NSTATS),PRCNDS(*),CI(NDETMX,NSTATS),
     *          CIOLD(*),EG(NXYZ,NNSTAT),WSTMP(*)
      DIMENSION LBOX1(*),LBOX2(*),LBOX3(*),LBOX4(*),LBOX5(*),
     *          IOX(NACT),IWRK(IIS)
C
      PARAMETER (MXRT=100)
C
      COMMON /DETWFN/ WSTATE(MXRT),SPINS(MXRT),CRIT,PRTTOL,S,SZ,
     *                GRPDET,STSYM,GLIST,
     *                NFLGDM(MXRT),IWTS(MXRT),NCORSV,NCOR,NACT,NORB,
     *                NA,NB,K,KST,IROOT,IPURES,MAXW1,NITER,MAXP,NCI,
     *                IGPDET,KSTSYM,NFTGCI
      COMMON /ENRGYS/ ENUCR,EELCT,ETOT,SZ2,SZZ,ECORE,ESCF,EERD,E1,E2,
     *                VEN,VEE,EPOT,EKIN,ESTATE(MXRT),STATN,EDFT(2),EDISP
      COMMON /FCCWFN/ NSPACE,MSTA(51),MNUM(51),MINI(51),MAXI(51),
     *                IAMI(51),IAMA(51),IBMI(51),IBMA(51),IDIM(51),
     *                LBST(51),NREF0,FDIRCT,QCORR,C0SQ
      COMMON /FMCOM / X(1)
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
C
      PARAMETER (HALF=0.5D+00,TOL=1.0D-09)
C
      NSYM = 2**IGPDET
      NINDX = N2
      IF(L1.GT.NINDX) NINDX = L1
C
      LWRK = 1
      LKTAB = LWRK + 43
      LGMUL = LKTAB + NSYM
      LCON = LGMUL + NSYM*NSYM
      LCOA = LCON + NA
      LCOB = LCOA + NSYM*ITGA
      LANDET = LCOB + NSYM*ITGB
      LBNDET = LANDET + NSPACE*ITGA
      NAST = LBNDET + NSPACE*ITGB
      NBST = NAST + ITGA + 1
      LSYMA = NBST + ITGB + 1
      LSYMB = LSYMA + IAST
      LGCOM = LSYMB + IBST
      LSPA = LGCOM + ITGB*ITGA
      LSPB = LSPA + IAST
      LDISB = LSPB + IBST
      LSAS = LDISB + NSYM*ITGB*ITGA
      LSBS = LSAS + (NSYM+1)*ITGA
      LSAC = LSBS + (NSYM+1)*ITGB
      LSBC = LSAC + IAST
      LIND = LSBC + IBST
      LACON1 = LIND + N2 + 1
      LACON2 = LACON1 + NA
      LBCON1 = LACON2 + NA
      LBCON2 = LBCON1 + NA
      IPOSA = LBCON2 + NA
      IPERA = IPOSA + NA*(NACT-NA)*NSYM
      IIND1 = IPERA + NA*(NACT-NA)*NSYM
      IIND2 = IIND1 + NA*(NACT-NA)*NSYM
      IIND3 = IIND2 + NA*(NACT-NA)*NSYM
      IGROA = IIND3 + NA*(NACT-NA)*NSYM
      IMMC = IGROA + NA*(NACT-NA)*NSYM
      INDEX2 = IMMC + NSYM
      LAST = INDEX2 + NINDX*NINDX
C
      IF(IIS.LT.(LAST-1)) THEN
        WRITE(IW,*) 'MEMORY ALLOCATION ERROR IN JCPORM!'
        CALL ABRT
      ENDIF
C
      DO II=1,NSPACE+1
        MSTA(II) = MSTA(II) - NCORSV
      ENDDO
C
      IVAL = LIND
      DO I=1,(NACT*(NACT+1))/2 + 1
         IWRK(IVAL) = (I*(I-1))/2
         IVAL = IVAL + 1
      ENDDO
C
      CALL VCLR(CI,1,NSTATS*NDETMX)
C
      CALL ORMCP(IW,NDER,LBOX1,LBOX2,LBOX3,NA,NB,CI,CIOLD,X(LBST(1)),
     *           NSTATS,NCI,NDETMX,IOX,IGPDET,KSTSYM,NSYM,NACT,IWRK,
     *           IWRK(LKTAB),IWRK(LGMUL),IWRK(LCON),IWRK(LCOA),
     *           IWRK(LCOB),IWRK(LANDET),IWRK(LBNDET),IWRK(NAST),
     *           IWRK(NBST),IWRK(LSYMA),IWRK(LSYMB),IWRK(LGCOM),
     *           IWRK(LSPA),IWRK(LSPB),IWRK(LDISB),IWRK(LSAS),
     *           IWRK(LSBS),IWRK(LSAC),IWRK(LSBC),ITGA,ITGB,IAST,IBST,
     *           NA1EX,NB1EX)
C
      IF(.NOT.FDIRCT) THEN
        IDIM1 = NSYM + 1
        IDIM2 = IBST + 1
      ELSE
        IDIM1 = 1
        IDIM2 = 1
      ENDIF
C
      JB1GR = LAST
      JB1PE = JB1GR + NB1EX
      JB1IN = JB1PE + NB1EX
      JB1PO = JB1IN + NB1EX
      JB1ST = JB1PO + NB1EX
      JB1SY = JB1ST + IDIM1*IDIM2
      JB1IN2 = JB1SY + NB*(NACT-NB)
      LAST = JB1IN2 + 2*NB1EX
C
      IF(.NOT.FDIRCT) THEN
        CALL FCPSUP(IW,NA,NB,NACT,IWRK(LACON1),IWRK(LBCON1),
     *              IWRK(LBCON2),IWRK(LIND),IWRK(NBST),IWRK(LSPB),
     *              LBOX1,LBOX2,LBOX3,LBOX4,
     *              X(LBST(1)),LNEED,IWRK(LBNDET),IWRK(LSYMB),NSYM,
     *              ITGB,IBST,NB1EX,
     *              IWRK(JB1GR),IWRK(JB1PE),IWRK(JB1IN),IWRK(JB1PO),
     *              IWRK(JB1ST),IWRK(JB1SY),IWRK(JB1IN2))
      ENDIF
C
      IF(IIS.LT.(LAST-1)) THEN
        WRITE(IW,*) 'MEMORY ALLOCATION ERROR IN JCPORM!'
        IVAL = NA*MAX(IAST,IBST)
        WRITE(IW,*) 'NA1EX,NB1EX,NB1EX(APPROX)=',NA1EX,NB1EX,IVAL
        CALL ABRT
      ENDIF
C
      CALL VCLR(PRCNDC,1,NSTATS*NDETLN)
      CALL VCLR(PRCNDS,1,NNSTAT)
      CALL VCLR(WAXCI,1,NXYZ*NSTATS*NDETLN)
C
      CALL CPDRDO(WAXCI,DFC,DERI,CI,FCOR,ERI,PRCNDC,
     *            NCORSV,JLO,JHI,NSTATS,NDETLN,
     *            N2,N4,NXYZ,L1,NACT,NDETMX,NA,NB,X(LBST(1)),LNEED,
     *            IWRK(LIND),NSYM,IOX,LBOX1,LBOX2,LBOX3,LBOX4,LBOX5,
     *            IWRK(LGMUL),IWRK(LKTAB),IWRK(LACON1),IWRK(LACON2),
     *            IWRK(LBCON1),IWRK(LBCON2),IWRK(LANDET),IWRK(LBNDET),
     *            IWRK(NAST),IWRK(NBST),IWRK(LSYMA),IWRK(LSYMB),
     *            IWRK(LGCOM),IWRK(LSPA),IWRK(LSPB),IWRK(LDISB),
     *            IWRK(LSAS),IWRK(LSBS),IWRK(LSAC),IWRK(LSBC),ITGA,
     *            ITGB,IAST,IBST,IWRK(IPOSA),IWRK(IPERA),IWRK(IIND1),
     *            IWRK(IGROA),IWRK(IMMC),NB1EX,IWRK(JB1GR),IWRK(JB1PE),
     *            IWRK(JB1IN),IWRK(JB1PO),IWRK(JB1ST),IDIM1,IDIM2)
C
C     ----- Finish perturbed configuration gradient -----
C     -----            and preconditioner           -----
C
      DHCME = ENUCR
      DO I=1,NCORSV
        II = (I*I+I)/2
        DHCME = DHCME + OINT(II) + FCOR(II)
      ENDDO
C
      IJSTAT = 0
      DO ISTAT=1,NSTATS
        EVAL = DHCME - ESTATE(ISTAT)
        DO 100 I=JLO,JHI
          CVAL = CI(I,ISTAT)
          IVAL = I - JLO + 1
          PRCNDC(IVAL,ISTAT) = PRCNDC(IVAL,ISTAT) + EVAL
          IF(ABS(CVAL).LT.TOL) GO TO 100
          PRCNDC(IVAL,ISTAT) = PRCNDC(IVAL,ISTAT) + HALF*CVAL*CVAL
          IVAL = IVAL + (ISTAT-1)*NDETLN
          CALL DAXPY(NXYZ,CVAL,DHC,1,WAXCI(1,IVAL),1)
  100   CONTINUE
C
        DO 120 JSTAT=1,ISTAT-1
          IJSTAT = IJSTAT + 1
          EVAL = ESTATE(JSTAT) - ESTATE(ISTAT)
          WVAL = WSTMP(ISTAT) - WSTMP(JSTAT)
          PRCNDS(IJSTAT) = EVAL*WVAL
  120   CONTINUE
      ENDDO
C
      CALL VCLR(EG,1,NNSTAT*NXYZ)
C
      DO 200 ISTAT=1,NSTATS
        DO 200 JSTAT=1,ISTAT
          IJ = (ISTAT*ISTAT-ISTAT)/2 + JSTAT
          DO 150 I=JLO,JHI
            CVAL = CI(I,JSTAT)
            IF(ABS(CVAL).LT.TOL) GO TO 150
            IVAL = (ISTAT-1)*NDETLN + I - JLO + 1
            CALL DAXPY(NXYZ,CVAL,WAXCI(1,IVAL),1,EG(1,IJ),1)
  150     CONTINUE
  200 CONTINUE
C
      IF(GOPARR) CALL DDI_GSUMF(2176,EG,NXYZ*NNSTAT)
C
      RETURN
      END
C*MODULE CPMCHF  *DECK JCPOVR
      SUBROUTINE JCPOVR(FCM,SDER,DFC,DERI,DLAG,DHC,DSAO,V,OINT,FCOR,ERI,
     *                  AMAT,DMMO,TPDM,PRCNDO,EPS,WRK,WRK2,IA,INDEX,
     *                  NCOR,NACT,NXYZ,L0,L1,L2,N2,N4,NROT,NDER,NFT18)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      LOGICAL GOPARR,DSKWRK,MASWRK,SVDSKW
C
      INTEGER         C_OOOO, C_VOOO, C_VVOO, C_VOVO
C
      DIMENSION FCM(NXYZ,NXYZ),SDER(NXYZ,L1*L1),DFC(NXYZ,L2),
     *          DERI(NXYZ,N4),DLAG(NXYZ,L1,L1),DHC(NXYZ),DSAO(L1*L1),
     *          V(L1,L1),OINT(L2),ERI(L1,NACT,N2),FCOR(L2),
     *          AMAT(L1,NCOR,N2),DMMO(N2),TPDM(N4),PRCNDO(NROT),
     *          EPS(L1,L1),WRK(*),WRK2(*)
      DIMENSION IA(L2),INDEX(L1,L1)
C
      PARAMETER (MXGTOT=20000,MXSH=5000)
C
      COMMON /DLBTIM/ C_OOOO,C_VOOO,C_VVOO,C_VOVO
      COMMON /IOFILE/ IR,IW,IP,IJKO,IJKT,IDAF,NAV,IODA(950)
      COMMON /NSHEL / EX(MXGTOT),CS(MXGTOT),CP(MXGTOT),CD(MXGTOT),
     *                CF(MXGTOT),CG(MXGTOT),CH(MXGTOT),CI(MXGTOT),
     *                KSTART(MXSH),KATOM(MXSH),KTYPE(MXSH),KNG(MXSH),
     *                KLOC(MXSH),KMIN(MXSH),KMAX(MXSH),NSHELL
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
C
      PARAMETER (ZERO=0.0D+00,HALF=0.5D+00,ONE=1.0D+00,TWO=2.0D+00)
C
      L3 = L1*L1
      L0TRI = (L0*L0+L0)/2
      NOCC = NACT + NCOR
C
      DO 10 I=1,L2
   10   IA(I) = (I*I-I)/2
C
      CALL VCLR(FCOR,1,L2)
      CALL VCLR(ERI,1,L1*NACT*N2)
      CALL VCLR(AMAT,1,L1*NCOR*N2)
C
      CALL DAREAD(IDAF,IODA,DHC,NXYZ,259,0)
C
      IF(GOPARR) THEN
        CALL DAREAD(IDAF,IODA,OINT,L0TRI,355,0)
      ELSE
        DSKWRK = .TRUE.
        CALL SEQREW(IJKT)
        CALL SQREAD(IJKT,OINT,L0TRI)
      END IF
C
      IF(MASWRK) CALL DCOPY(L2,OINT,1,FCOR,1)
C
C     ----- Read in perturbed integrals from NFT18 -----
C
      SVDSKW = DSKWRK
      DSKWRK = .FALSE.
      CALL SEQREW(NFT18)
C
      DO IXYZ=1,NXYZ
        CALL SQREAD(NFT18,WRK,L2)
        CALL DCOPY(L2,WRK,1,DFC(IXYZ,1),NXYZ)
        CALL SQREAD(NFT18,WRK,N4)
        CALL DCOPY(N4,WRK,1,DERI(IXYZ,1),NXYZ)
        CALL SQREAD(NFT18,WRK,L3)
        CALL DCOPY(L3,WRK,1,DLAG(IXYZ,1,1),NXYZ)
      ENDDO
C
      DSKWRK = SVDSKW
C
C     ----- Transform derivative overlap integrals into MO basis -----
C
      CALL VCLR(SDER,1,L3*NXYZ)
      CALL DAREAD(IDAF,IODA,V,L3,15,0)
C
      IF(NDER.EQ.2) THEN
        DO 40 M=1,3
          IF(M.EQ.1) CALL DAREAD(IDAF,IODA,DSAO,L3,63,0)
          IF(M.EQ.2) CALL DAREAD(IDAF,IODA,DSAO,L3,64,0)
          IF(M.EQ.3) CALL DAREAD(IDAF,IODA,DSAO,L3,65,0)
          DO 30 ISHELL=1,NSHELL
            IAT  = KATOM(ISHELL)
            IXYZ = 3*(IAT-1)
            LOCI = KLOC(ISHELL) - KMIN(ISHELL)
            MINI = KMIN(ISHELL)
            MAXI = KMAX(ISHELL)
            DO 20 I=MINI,MAXI
              II = LOCI + I
              DO JJ=1,L1
                IJ = IA(MAX(II,JJ)) + MIN(II,JJ)
                IIJJ = (JJ-1)*L1 + II
                SDER(IXYZ+M,IJ) = SDER(IXYZ+M,IJ) + DSAO(IIJJ)
              ENDDO
   20       CONTINUE
   30     CONTINUE
   40   CONTINUE
      ELSE
C
        SVDSKW = DSKWRK
        DSKWRK = .FALSE.
        DO IXYZ=1,NXYZ
          CALL SQREAD(NFT18,WRK,L2)
          CALL DCOPY(L2,WRK,1,SDER(IXYZ,1),NXYZ)
        ENDDO
        DSKWRK = SVDSKW
      ENDIF
C
      DO 70 IXYZ=1,NXYZ
        CALL DCOPY(L3,SDER(IXYZ,1),NXYZ,WRK,1)
        CALL TFTRI(DSAO,WRK,V,WRK2,L0,L1,L1)
        CALL VCLR(SDER(IXYZ,1),NXYZ,L3)
        DO 60 I=1,L0
          DO 60 J=1,I
            IIJJ = IA(I) + J
            DVAL = DSAO(IIJJ)
            IJ = (J-1)*L1 + I
            JI = (I-1)*L1 + J
            SDER(IXYZ,IJ) = DVAL
            SDER(IXYZ,JI) = DVAL
   60   CONTINUE
   70 CONTINUE
C
C     ----- Add derivative overlap contributions to force constant -----
C     -----                         matrix                         -----
C
      IF(NDER.EQ.2) THEN
        DO 100 JXYZ=1,NXYZ
          CALL DCOPY(L3,SDER(JXYZ,1),NXYZ,WRK,1)
          DO 90 J=1,NOCC
            DO 90 I=1,L1
              IJ = (J-1)*L1 + I
              DVAL = ZERO
              DO M=1,L1
                MI = (I-1)*L1 + M
                DVAL = DVAL + WRK(MI)*EPS(M,J)
              ENDDO
              WRK2(IJ) = DVAL
   90     CONTINUE
          CALL DAXPY(L1*NOCC,-ONE,DLAG(JXYZ,1,1),NXYZ,WRK2,1)
C
          DO IXYZ=1,NXYZ
            DVAL = DDOT(L1*NOCC,WRK2,1,SDER(IXYZ,1),NXYZ)
            FCM(IXYZ,JXYZ) = FCM(IXYZ,JXYZ) + DVAL
          ENDDO
  100   CONTINUE
      ENDIF
C
C     ----- Add derivative overlap (two-electron) contributions to -----
C     -----                      various terms                     -----
C
      IF(GOPARR) THEN
        CALL DDI_PROCDLB_RESET(C_OOOO)
        CALL DDI_PROCDLB_RESET(C_VOOO)
        CALL DDI_PROCDLB_RESET(C_VVOO)
        CALL DDI_PROCDLB_RESET(C_VOVO)
C
        CALL DSCAL(L2*NXYZ,ONE/NPROC,DFC,1)
        CALL DSCAL(N4*NXYZ,ONE/NPROC,DERI,1)
        CALL DSCAL(L3*NXYZ,ONE/NPROC,DLAG,1)
C
        CALL PCPSDR(WRK,SDER,DLAG,DFC,DERI,FCOR,ERI,AMAT,DMMO,TPDM,
     *              PRCNDO,IA,INDEX,NCOR,NACT,NXYZ,L0,L1,L2,N2,N4,NROT,
     *              IW)
      ENDIF
C
C     ----- Add derivative overlap (one-electron) contributions to -----
C     -----   the derivative core Fock and Hamiltonian matrices    -----
C
      DO 180 IXYZ=1,NXYZ
C
        DO 160 I=1,L1
          DO 160 J=1,I
            IJ = IA(I) + J
            DVAL = ZERO
            DO M=1,L1
              IG = MAX(I,M)
              MG = MIN(I,M)
              IM = IA(IG) + MG
C
              JG = MAX(J,M)
              MG = MIN(J,M)
              JM = IA(JG) + MG
C
              MI = (I-1)*L1 + M
              MJ = (J-1)*L1 + M
              DVAL = DVAL + SDER(IXYZ,MI)*FCOR(JM)
              DVAL = DVAL + SDER(IXYZ,MJ)*FCOR(IM)
            ENDDO
            DFC(IXYZ,IJ) = DFC(IXYZ,IJ) - HALF*DVAL
  160   CONTINUE
C
        DVAL = ZERO
        DO 170 I=1,NCOR
          II = IA(I) + I
          DVAL = DVAL + DFC(IXYZ,II)
          DO M=1,L1
            IG = MAX(I,M)
            MG = MIN(I,M)
            IM = IA(IG) + MG
            MI = (I-1)*L1 + M
            DVAL = DVAL - SDER(IXYZ,MI)*OINT(IM)
          ENDDO
  170   CONTINUE
C
        DHC(IXYZ) = DHC(IXYZ) + DVAL
  180 CONTINUE
C
C     ----- Add derivative overlap (one-electron) contributions to -----
C     -----               the derivative Lagrangian                -----
C
      DO 300 IXYZ=1,NXYZ
        DO 280 I=1,L1
C
          DO 200 J=1,NCOR
            DVAL = ZERO
            DO N=1,L1
              NG = MAX(N,I)
              IG = MIN(N,I)
              NI = IA(NG) + IG
              NJ = (J-1)*L1 + N
              DVAL = DVAL + SDER(IXYZ,NJ)*OINT(NI)
            ENDDO
            DLAG(IXYZ,I,J) = DLAG(IXYZ,I,J) - DVAL
  200     CONTINUE
C
          DO 240 J=1,NACT
            DVAL = ZERO
            DO 220 M=1,NACT
              MG = MAX(M,J)
              JG = MIN(M,J)
              MJ = IA(MG) + JG
              DMVAL = DMMO(MJ)
              DO 220 N=1,L1
                NG = MAX(N,I)
                IG = MIN(N,I)
                NI = IA(NG) + IG
                NM = (M+NCOR-1)*L1 + N
                DVAL = DVAL + SDER(IXYZ,NM)*DMVAL*OINT(NI)
  220       CONTINUE
            DLAG(IXYZ,I,J+NCOR) = DLAG(IXYZ,I,J+NCOR) - HALF*DVAL
  240     CONTINUE
C
          DO 260 J=1,NOCC
            DVAL = ZERO
            DO M=1,L1
              MI = (I-1)*L1 + M
              DVAL = DVAL + SDER(IXYZ,MI)*EPS(M,J)
            ENDDO
            DLAG(IXYZ,I,J) = DLAG(IXYZ,I,J) - HALF*DVAL
  260     CONTINUE
  280   CONTINUE
  300 CONTINUE
C
C     ----- Write total derivative Lagrangian to file -----
C
      SVDSKW = DSKWRK
      DSKWRK = .FALSE.
      CALL SEQREW(NFT18)
      DO IXYZ=1,NXYZ
        CALL DCOPY(L3,DLAG(IXYZ,1,1),NXYZ,WRK,1)
        CALL SQWRIT(NFT18,WRK,L3)
      ENDDO
      DSKWRK = SVDSKW
C
C     ----- Store derivative core Fock matrices over active -----
C     -----                  orbitals only                  -----
C
      DO 1000 I=1,NACT
        IF(NCOR.EQ.0) GO TO 1000
        II = I + NCOR
        DO J=1,I
          JJ = J + NCOR
          IJ = IA(I) + J
          IIJJ = IA(II) + JJ
          CALL DCOPY(NXYZ,DFC(1,IIJJ),1,DFC(1,IJ),1)
        ENDDO
 1000 CONTINUE
C
C     ----- Add one-electron part to orbital preconditioner -----
C
      DO 1100 I=1,L1
        DMI = ZERO
        IF(I.LE.NCOR) DMI = TWO
        IF(I.GT.NCOR .AND. I.LE.NOCC) THEN
          II = IA(I-NCOR) + I-NCOR
          DMI = DMMO(II)
        ENDIF
C
        DO 1100 J=1,I
          IJ = IABS(INDEX(I,J))
          IF(IJ.EQ.0) GO TO 1100
C
          IF(J.LE.NCOR) DMJ = TWO
          IF(J.GT.NCOR) THEN
            JJ = IA(J-NCOR) + J-NCOR
            DMJ = DMMO(JJ)
          ENDIF
C
          II = IA(I) + I
          JJ = IA(J) + J
          DVAL = DMJ*OINT(II) - EPS(J,J)
          IF(I.LE.NOCC) DVAL = DVAL - EPS(I,I) + DMI*OINT(JJ)
          PRCNDO(IJ) = PRCNDO(IJ) + DVAL
 1100 CONTINUE
C
      RETURN
      END
C*MODULE CPMCHF  *DECK MATDD1
      SUBROUTINE MATDD1(DDEN,DCI,CI,M2,NXYZ,NACT,NA,NB,
     *                  NDETLN,NALP,NBLP,IFA,IOX,NSYM,
     *                  IACON1,IBCON1,IACON2,IPOSA,IPERA,IIND1,
     *                  INDEX,ISYMA,ISYMB,
     *                  ISPA,ISPB,ISAS,ISBS,ISAC,ISBC,JLO,JHI)
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      INTEGER POSCP
      DIMENSION IOX(NACT)
      DIMENSION DDEN(NXYZ,M2), CI(*), DCI(NXYZ,NDETLN)
      DIMENSION IFA(0:NACT,0:NACT)
      DIMENSION IACON1(NA),IBCON1(NA)
      DIMENSION IACON2(NA),IPERA(NA*(NACT-NA))
      DIMENSION IIND1(NA*(NACT-NA))
      DIMENSION IPOSA(NA*(NACT-NA))
      DIMENSION INDEX(NACT,NACT)
      DIMENSION ISYMA(NALP),ISYMB(NBLP)
      DIMENSION ISPA(NALP),ISPB(NBLP)
      DIMENSION ISAS(NSYM+1),ISBS(NSYM+1),ISAC(NALP),ISBC(NBLP)
C
      PARAMETER (TWO=2.0D+00)
C
      DO 7 I=1,NACT
         DO 8 J=1,I
            INDEX(I,J) = I*(I-1)/2 + J
            INDEX(J,I) = INDEX(I,J)
    8    CONTINUE
    7 CONTINUE
C
      NAT = NA
      NBT = NB
C
      CALL VCLR(DDEN,1,M2*NXYZ)
C
      DO 30 I=1,NAT
         IACON1(I) = I
   30 CONTINUE
C
C   Big Loop over all alpha determinants
C
      DO 9000 IJK = 1,NALP
C
C  Alpha excitations here
C   Single first
C
         IAC = 0
         ICAT = ISPA(IJK)
         ISA1 = ISYMA(IJK)
C itas = itab(isa1)
         DO 7030 IA=1,NAT
             IO1 = IACON1(IA)
             IS1 = IOX(IO1)
             IST = IO1 + 1
             IEN = IACON1(IA+1)-1
             IF (IA.EQ.NAT) IEN=NACT
             DO 7025 KKJ=IA+1,NA+1
                DO 7020 JJ=IST,IEN
                IS2 = IOX(JJ)
C
             IAC = IAC + 1
             CALL RET1CP(IACON1,IACON2,NA,IA,JJ,0,KKJ,IPER1)
C
C   Storage here for later use, well worth it
C
             IPET = POSCP(NACT,NA,IACON2,IFA)
             IPOSA(IAC) = ISPA(IPET)
             IPERA(IAC) = ((-1)**IPER1)
             IND = INDEX(JJ,IO1)
             IIND1(IAC) = IND
C
         DO 49 I=1,NBT
            IBCON1(I) = I
   49    CONTINUE
C
C
                   DO 407 INBB = ISBS(ISA1),ISBS(ISA1+1)-1
                   INB1 = ISBC(INBB)
                   ICIT = ICAT+ISPB(INB1)
                   ICI2 = IPOSA(IAC) + ISPB(INB1)
C
                   IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                     FC = CI(ICI2)*IPERA(IAC)
                     IWIT = ICIT - JLO + 1
                     CALL DAXPY(NXYZ,FC,DCI(1,IWIT),1,DDEN(1,IND),1)
                   ENDIF
C
                   IF(ICI2.GE.JLO .AND. ICI2.LE.JHI) THEN
                     FC = CI(ICIT)*IPERA(IAC)
                     IWI2 = ICI2 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DCI(1,IWI2),1,DDEN(1,IND),1)
                   ENDIF
  407          CONTINUE
C
 7020           CONTINUE
                IST = IACON1(KKJ)+1
                IEN = IACON1(KKJ+1)-1
                IF (KKJ.EQ.NA) IEN=NACT
 7025        CONTINUE
 7030     CONTINUE
C
C  Diagonal
C
            DO 67 II=1,NAT
               I1 = IACON1(II)
               IND1 = INDEX(I1,I1)
C
              DO 53 INB1 = ISBS(ISA1),ISBS(ISA1+1)-1
              NEND = ISBC(INB1)
              ICIT = ICAT+ISPB(NEND)
C
              IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                FC = TWO*CI(ICIT)
                IWIT = ICIT - JLO + 1
                CALL DAXPY(NXYZ,FC,DCI(1,IWIT),1,DDEN(1,IND1),1)
              ENDIF
   53         CONTINUE
C
   67       CONTINUE
C
C   Loop over Beta dets now
C
      CALL ADVNCP(IACON1,NAT,NACT)
 9000 CONTINUE
C
C   Now for the Beta part
C
C
      DO 876 JJI=1,NBT
         IBCON1(JJI) = JJI
  876 CONTINUE
C
      DO 9999 IJK = 1,NBLP
         ICAB = ISPB(IJK)
         ISB1 = ISYMB(IJK)
C itb1 = itab(isb1)
C
      DO 6030 IB=1,NBT
         IST = IBCON1(IB)+1
         IEN = IBCON1(IB+1)-1
         IF (IB.EQ.NBT) IEN=NACT
         IO1 = IBCON1(IB)
         IS1 = IOX(IO1)
         DO 6025 KKJ=IB+1,NB+1
            DO 6020 JJ=IST,IEN
            IS2 = IOX(JJ)
C
            CALL RET1CP(IBCON1,IACON2,NB,IB,JJ,0,KKJ,IPER1)
            IPER = ((-1)**IPER1)
            IND = INDEX(JJ,IO1)
Cc If deoccupied and newly occupied are of diff sym, then
C   skip to doubles
            IF (IS1.NE.IS2) GOTO 517
            IPB1 = POSCP(NACT,NB,IACON2,IFA)
            IPB1 = ISPB(IPB1)
C
       DO 89 I=1,NAT
          IACON1(I) = I
   89 CONTINUE
C
C  Loop over alpha
C
          DO 907 INA1 = ISAS(ISB1),ISAS(ISB1+1)-1
             ICIA = ISAC(INA1)
             ICIT = ISPA(ICIA) + ICAB
             ICI2 = ISPA(ICIA) + IPB1
C
             IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
               FC = CI(ICI2)*IPER
               IWIT = ICIT - JLO + 1
               CALL DAXPY(NXYZ,FC,DCI(1,IWIT),1,DDEN(1,IND),1)
             ENDIF
C
             IF(ICI2.GE.JLO .AND. ICI2.LE.JHI) THEN
               FC = CI(ICIT)*IPER
               IWI2 = ICI2 - JLO + 1
               CALL DAXPY(NXYZ,FC,DCI(1,IWI2),1,DDEN(1,IND),1)
             ENDIF
  907     CONTINUE
C
  517 CONTINUE
 6020      CONTINUE
            IST = IBCON1(KKJ)+1
            IEN=IBCON1(KKJ+1)-1
            IF (KKJ.EQ.NB) IEN=NACT
 6025     CONTINUE
 6030 CONTINUE
C
C    Remaining part of diagonal contributions
C
            DO 69 II=1,NBT
               I1 = IBCON1(II)
               IND1 = INDEX(I1,I1)
            DO 93 INA1 = ISAS(ISB1),ISAS(ISB1+1)-1
              NEND = ISAC(INA1)
              ICIA = ISPA(NEND)
              ICIT = ICIA + ICAB
C
              IF(ICIT.GE.JLO .AND. ICIT.LE.JHI) THEN
                FC = TWO*CI(ICIT)
                IWIT = ICIT - JLO + 1
                CALL DAXPY(NXYZ,FC,DCI(1,IWIT),1,DDEN(1,IND1),1)
              ENDIF
   93       CONTINUE
C
   69       CONTINUE
           CALL ADVNCP(IBCON1,NBT,NACT)
C
 9999 CONTINUE
      RETURN
      END
C*MODULE CPMCHF  *DECK MATMC2
C     ----------------------------------------------------------
      SUBROUTINE MATMC2(NUM,NORB,NCOR,NA,NB,IFA,NSYM,IIS,NDETMX,
     *                  ITGA,ITGB,NSPACE,IAST,IBST,GENMC)
C     ----------------------------------------------------------
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      LOGICAL GENMC
      DIMENSION IFA(0:NORB-NCOR,0:NORB-NCOR)
C
      NACT = NORB - NCOR
      N2 = (NACT*NACT+NACT)/2
      NLEN = (NACT**2+NACT)/2
      IF(NUM.GT.NLEN) NLEN = NUM
      NALP = IFA(NACT,NA)
      NBLP = IFA(NACT,NB)
      NDETMX = NALP*NBLP
C
      IF(GENMC) THEN
        IIS = 43 + NSYM*(2+NSYM+ITGA+ITGB+ITGB*ITGA) +
     *        (NSYM+1)*(ITGA+ITGB) + 5*NA + NSPACE*(ITGA+ITGB) +
     *        ITGA+1 + ITGB+1 + 3*IAST + 3*IBST + ITGA*ITGB + N2+1 +
     *        6*NA*(NACT-NA)*NSYM + 6*NA*(NACT-NB)*MAX(IAST,IBST) +
     *        (NSYM+1)*(IBST+1) + NB*(NACT-NB) + NLEN*NLEN
C
      ELSE
        IAST = NALP
        IBST = NBLP
C
C       Similar to MATME2 in ALDECI
C
        IIS = 3*NA + NB + 5*(NA*(NACT-NA)) +
     *    NLEN**2 + 3*(NALP+NBLP) + 4*NSYM +
     *     2*(NSYM+1) + NSYM*NSYM + NSYM*(NA*(NACT-NA)) +
     *    ((NB*(NORB-NCOR-NB))*NBLP) + NBLP + 43
      ENDIF
C
      RETURN
      END
C*MODULE CPMCHF  *DECK MATMC3
      SUBROUTINE MATMC3(NDETMX,NCORSV,ITGA,ITGB,NA,NB,LBOX1,LBOX2,
     *                  LBOX3,LCON,LANDET,LBNDET,LGCOM,LCOB,X,NOCAS)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      DIMENSION X(*)
      DIMENSION LBOX1(*),LBOX2(*),LBOX3(*),LCON(NA),LANDET(NSPACE,ITGA),
     *          LBNDET(NSPACE,ITGB),LGCOM(ITGB,ITGA),LCOB(ITGB)
C
      LOGICAL FDIRCT,QCORR,NOCAS
C
      COMMON /FCCWFN/ NSPACE,MSTA(51),MNUM(51),MINI(51),MAXI(51),
     *                IAMI(51),IAMA(51),IBMI(51),IBMA(51),IDIM(51),
     *                LBST(51),NREF0,FDIRCT,QCORR,C0SQ
C
      DO II=1,NSPACE+1
        MSTA(II) = MSTA(II) - NCORSV
      ENDDO
C
C     Make LANDET and LBNDET
C
      ISTA1 = LBST(1)
      CALL RESETCO(LBOX1,NSPACE,NA,IAMA,IAMI,LBOX2)
      DO II=1,ITGA
         DO JJ=1,NSPACE
            ISTA2 = LBST(JJ) - ISTA1 + 1
            LANDET(JJ,II)=ISPADET(X(ISTA2),MNUM(JJ),IDIM(JJ),LBOX1(JJ))
         ENDDO
      CALL PUSHCO(LBOX1,NSPACE,NA,IAMA,IAMI,LBOX2,IEND)
      ENDDO
C
      CALL RESETCO(LBOX1,NSPACE,NB,IBMA,IBMI,LBOX2)
      DO II=1,ITGB
         DO JJ=1,NSPACE
            ISTA2 = LBST(JJ) - ISTA1 + 1
            LBNDET(JJ,II)=ISPADET(X(ISTA2),MNUM(JJ),IDIM(JJ),LBOX1(JJ))
         ENDDO
      CALL PUSHCO(LBOX1,NSPACE,NB,IBMA,IBMI,LBOX2,IEND)
      ENDDO
C
C     Make LGCOM
C
      ICOMP = 0
      CALL RESETCO(LBOX1,NSPACE,NA,IAMA,IAMI,LBOX3)
      DO JJ=1,ITGA
         CALL RESETCO(LBOX2,NSPACE,NB,IBMA,IBMI,LBOX3)
         DO II=1,ITGB
            LGCOM(II,JJ) = 0
            DO KK=1,NSPACE
               IOC = LBOX1(KK) + LBOX2(KK)
               IF (IOC.GT.MAXI(KK).OR.IOC.LT.MINI(KK)) GO TO 100
            ENDDO
C
            LGCOM(II,JJ) = 1
            ICOMP = ICOMP + 1
  100       CALL PUSHCO(LBOX2,NSPACE,NB,IBMA,IBMI,LBOX3,IEND)
         ENDDO
         CALL PUSHCO(LBOX1,NSPACE,NA,IAMA,IAMI,LBOX3,IEND)
      ENDDO
C
C     Make LCOB
C
      CALL RESETCO(LBOX1,NSPACE,NB,IBMA,IBMI,LBOX2)
      DO II=1,ITGB
        CALL RESETDE(LBOX1,NSPACE,NB,MSTA,LCON)
        ITOT = 1
        DO JJ=1,NSPACE
           ITOT = ITOT * LBNDET(JJ,II)
        ENDDO
C
        LCOB(II) = ITOT
        CALL PUSHCO(LBOX1,NSPACE,NB,IBMA,IBMI,LBOX2,IEND)
      ENDDO
C
C     Determine number of determinants
C
      CALL RESETCO(LBOX1,NSPACE,NA,IAMA,IAMI,LBOX2)
      NDETMP = 0
      DO II=1,ITGA
        CALL RESETDE(LBOX1,NSPACE,NA,MSTA,LCON)
        ITOT = 1
        DO JJ=1,NSPACE
          ITOT = ITOT*LANDET(JJ,II)
        ENDDO
C
        DO 200 LL=1,ITGB
          IF(LGCOM(LL,II).EQ.0) GO TO 200
          NDETMP = NDETMP + ITOT*LCOB(LL)
  200   CONTINUE
C
        CALL PUSHCO(LBOX1,NSPACE,NA,IAMA,IAMI,LBOX2,IEND)
      ENDDO
C
      DO II=1,NSPACE+1
        MSTA(II) = MSTA(II) + NCORSV
      ENDDO
C
      IF(NDETMP.NE.NDETMX) THEN
        NOCAS = .TRUE.
        NDETMX = NDETMP
      ENDIF
C
      RETURN
      END
C*MODULE CPMCHF  *DECK MATTD1
      SUBROUTINE MATTD1(TDEN,CI,NSTATS,NACT,NA,NB,
     *                  NDETMX,NALP,NBLP,IFA,IOX,NSYM,
     *                  IACON1,IBCON1,IACON2,IPOSA,IPERA,IIND1,
     *                  INDEX,ISYMA,ISYMB,
     *                  ISPA,ISPB,ISAS,ISBS,ISAC,ISBC)
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      INTEGER POSCP
      DIMENSION IOX(NACT)
      DIMENSION TDEN(NACT,NACT,NSTATS*NSTATS), CI(NDETMX,NSTATS)
      DIMENSION IFA(0:NACT,0:NACT)
      DIMENSION IACON1(NA),IBCON1(NA)
      DIMENSION IACON2(NA),IPERA(NA*(NACT-NA))
      DIMENSION IIND1(NA*(NACT-NA))
      DIMENSION IPOSA(NA*(NACT-NA))
      DIMENSION INDEX(NACT,NACT)
      DIMENSION ISYMA(NALP),ISYMB(NBLP)
      DIMENSION ISPA(NALP),ISPB(NBLP)
      DIMENSION ISAS(NSYM+1),ISBS(NSYM+1),ISAC(NALP),ISBC(NBLP)
C
      DO 7 I=1,NACT
         DO 8 J=1,I
            INDEX(I,J) = I*(I-1)/2 + J
            INDEX(J,I) = INDEX(I,J)
    8    CONTINUE
    7 CONTINUE
C
      NAT = NA
      NBT = NB
C
      CALL VCLR(TDEN,1,NACT*NACT*NSTATS*NSTATS)
C
      DO 30 I=1,NAT
         IACON1(I) = I
   30 CONTINUE
C
C   Big Loop over all alpha determinants
C
      DO 9000 IJK = 1,NALP
C
C  Alpha excitations here
C   Single first
C
         IAC = 0
         ICAT = ISPA(IJK)
         ISA1 = ISYMA(IJK)
C itas = itab(isa1)
         DO 7030 IA=1,NAT
             IO1 = IACON1(IA)
             IS1 = IOX(IO1)
             IST = IO1 + 1
             IEN = IACON1(IA+1)-1
             IF (IA.EQ.NAT) IEN=NACT
             DO 7025 KKJ=IA+1,NA+1
                DO 7020 JJ=IST,IEN
                IS2 = IOX(JJ)
C
             IAC = IAC + 1
             CALL RET1CP(IACON1,IACON2,NA,IA,JJ,0,KKJ,IPER1)
C
C   Storage here for later use, well worth it
C
             IPET = POSCP(NACT,NA,IACON2,IFA)
             IPOSA(IAC) = ISPA(IPET)
             IPERA(IAC) = ((-1)**IPER1)
             IND = INDEX(JJ,IO1)
             IIND1(IAC) = IND
             IF (IS1.NE.IS2) GOTO 417
C
         DO 49 I=1,NBT
            IBCON1(I) = I
   49    CONTINUE
C
C
                   DO 407 INBB = ISBS(ISA1),ISBS(ISA1+1)-1
                   INB1 = ISBC(INBB)
                   ICIT = ICAT+ISPB(INB1)
                   ICI2 = IPOSA(IAC) + ISPB(INB1)
C
                   FC = IPERA(IAC)
                   DO 406 ISTAT=1,NSTATS
                     DO 406 JSTAT=1,NSTATS
                       IJSTAT = (ISTAT-1)*NSTATS + JSTAT
                       FCJI = FC*CI(ICIT,JSTAT)*CI(ICI2,ISTAT)
                       TDEN(JJ,IO1,IJSTAT) = TDEN(JJ,IO1,IJSTAT) + FCJI
                       FCJI = FC*CI(ICI2,JSTAT)*CI(ICIT,ISTAT)
                       TDEN(IO1,JJ,IJSTAT) = TDEN(IO1,JJ,IJSTAT) + FCJI
  406              CONTINUE
  407          CONTINUE
C
C
  417     CONTINUE
C
 7020           CONTINUE
                IST = IACON1(KKJ)+1
                IEN = IACON1(KKJ+1)-1
                IF (KKJ.EQ.NA) IEN=NACT
 7025        CONTINUE
 7030     CONTINUE
C
C  Diagonal
C
            DO 67 II=1,NAT
               I1 = IACON1(II)
C
              DO 53 INB1 = ISBS(ISA1),ISBS(ISA1+1)-1
              NEND = ISBC(INB1)
              ICIT = ICAT+ISPB(NEND)
C
               DO 52 ISTAT=1,NSTATS
                 DO 52 JSTAT=1,NSTATS
                   IJSTAT = (ISTAT-1)*NSTATS + JSTAT
                   FCJI = CI(ICIT,JSTAT)*CI(ICIT,ISTAT)
                   TDEN(I1,I1,IJSTAT) = TDEN(I1,I1,IJSTAT) + FCJI
   52          CONTINUE
   53         CONTINUE
C
   67       CONTINUE
C
C   Loop over Beta dets now
C
      CALL ADVNCP(IACON1,NAT,NACT)
 9000 CONTINUE
C
C   Now for the Beta part
C
C
      DO 876 JJI=1,NBT
         IBCON1(JJI) = JJI
  876 CONTINUE
C
      DO 9999 IJK = 1,NBLP
         ICAB = ISPB(IJK)
         ISB1 = ISYMB(IJK)
C itb1 = itab(isb1)
C
      DO 6030 IB=1,NBT
         IST = IBCON1(IB)+1
         IEN = IBCON1(IB+1)-1
         IF (IB.EQ.NBT) IEN=NACT
         IO1 = IBCON1(IB)
         IS1 = IOX(IO1)
         DO 6025 KKJ=IB+1,NB+1
            DO 6020 JJ=IST,IEN
            IS2 = IOX(JJ)
C
            CALL RET1CP(IBCON1,IACON2,NB,IB,JJ,0,KKJ,IPER1)
            IPER = ((-1)**IPER1)
            IND = INDEX(JJ,IO1)
Cc If deoccupied and newly occupied are of diff sym, then
C   skip to doubles
            IF (IS1.NE.IS2) GOTO 517
            IPB1 = POSCP(NACT,NB,IACON2,IFA)
            IPB1 = ISPB(IPB1)
C
       DO 89 I=1,NAT
          IACON1(I) = I
   89 CONTINUE
C
C  Loop over alpha
C
          DO 907 INA1 = ISAS(ISB1),ISAS(ISB1+1)-1
             ICIA = ISAC(INA1)
             ICIT = ISPA(ICIA) + ICAB
             ICI2 = ISPA(ICIA) + IPB1
C
             FC = IPER
             DO 906 ISTAT=1,NSTATS
               DO 906 JSTAT=1,NSTATS
                 IJSTAT = (ISTAT-1)*NSTATS + JSTAT
                 FCJI = FC*CI(ICIT,JSTAT)*CI(ICI2,ISTAT)
                 TDEN(JJ,IO1,IJSTAT) = TDEN(JJ,IO1,IJSTAT) + FCJI
                 FCJI = FC*CI(ICI2,JSTAT)*CI(ICIT,ISTAT)
                 TDEN(IO1,JJ,IJSTAT) = TDEN(IO1,JJ,IJSTAT) + FCJI
  906        CONTINUE
  907     CONTINUE
C
  517 CONTINUE
 6020      CONTINUE
            IST = IBCON1(KKJ)+1
            IEN=IBCON1(KKJ+1)-1
            IF (KKJ.EQ.NB) IEN=NACT
 6025     CONTINUE
 6030 CONTINUE
C
C    Remaining part of diagonal contributions
C
            DO 69 II=1,NBT
               I1 = IBCON1(II)
            DO 93 INA1 = ISAS(ISB1),ISAS(ISB1+1)-1
              NEND = ISAC(INA1)
              ICIA = ISPA(NEND)
              ICIT = ICIA + ICAB
C
              DO 92 ISTAT=1,NSTATS
                DO 92 JSTAT=1,NSTATS
                  IJSTAT = (ISTAT-1)*NSTATS + JSTAT
                  FCJI = CI(ICIT,JSTAT)*CI(ICIT,ISTAT)
                  TDEN(I1,I1,IJSTAT) = TDEN(I1,I1,IJSTAT) + FCJI
   92         CONTINUE
   93       CONTINUE
C
   69       CONTINUE
           CALL ADVNCP(IBCON1,NBT,NACT)
C
 9999 CONTINUE
      RETURN
      END
C*MODULE CPMCHF  *DECK MCCPCG
      SUBROUTINE MCCPCG(YAO,YAC,YAS,PRCNDO,PRCNDC,PRCNDS,RESIDO,RESIDC,
     *                  RESIDS,ZRESO,ZRESC,ZRESS,PDIRO,PDIRC,PDIRS,
     *                  BNORM,BKNUM,BKDEN,OINT,FCOR,AMAT,ERI,EPS,OPDM,
     *                  TPDM,CI,WRK,INDEX,IA,IWRK,IFA,IOX,NOCP,
     *                  NXYZ,NUNIQ,NROT,NDETLN,NDETMX,IIS,JLO,JHI,NA,
     *                  NB,NSYM,NCOR,NACT,L0,L1,L2,NFT18,NFT19,NSTATS,
     *                  WSTATE,EGRAD,SALAG,YADEN,AVEC,BVEC,FCORSQ,
     *                  YAOTMP,GENMC,LNEED,LBOX1,LBOX2,LBOX3,LBOX4,
     *                  LBOX5,ITGA,ITGB,IAST,IBST,NB1EX,JROTLO,JROTHI)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      INTEGER         C_OOOO, C_VOOO, C_VVOO, C_VOVO
C
      LOGICAL GOPARR,DSKWRK,MASWRK
      LOGICAL GENMC
C
      DIMENSION YAO(NUNIQ,NROT),YAC(NUNIQ,NSTATS*NDETLN),YAS(NUNIQ,*),
     *          PRCNDO(NROT),PRCNDC(NSTATS*NDETLN),PRCNDS(*),
     *          RESIDO(NUNIQ,NROT),RESIDC(NUNIQ,NSTATS*NDETLN),
     *          RESIDS(NUNIQ,*),ZRESO(NUNIQ,NROT),
     *          ZRESC(NUNIQ,NSTATS*NDETLN),ZRESS(NUNIQ,*),
     *          PDIRO(NUNIQ,NROT),PDIRC(NUNIQ,NSTATS*NDETMX),
     *          PDIRS(NUNIQ,*),BNORM(NUNIQ),BKNUM(NUNIQ),BKDEN(NUNIQ),
     *          OINT(L2),FCOR(L2),AMAT(*),ERI(*),EPS(L1,L1),OPDM(*),
     *          TPDM(*),CI(NDETMX,NSTATS),WRK(*),
     *          WSTATE(*),EGRAD(*),SALAG(L1,L1,NSTATS*NSTATS),
     *          YADEN(*),AVEC(*),BVEC(*),FCORSQ(L1,L1),YAOTMP(*)
      DIMENSION INDEX(L1,L1),IA(*),IWRK(IIS),IFA(0:NACT,0:NACT),
     *          IOX(NACT),NOCP(NXYZ)
      DIMENSION LBOX1(*),LBOX2(*),LBOX3(*),LBOX4(*),LBOX5(*)
C
      COMMON /DLBTIM/ C_OOOO,C_VOOO,C_VVOO,C_VOVO
      COMMON /IOFILE/ IR,IW,IP,IJKO,IJKT,IDAF,NAV,IODA(950)
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
C
      PARAMETER (ZERO=0.0D+00,ONE=1.0D+00,TWO=2.0D+00)
      PARAMETER (THREE=3.0D+00,TOL=1.0D-06)
C
      DATA MAXIT/300/
C
      NOCC = NCOR+NACT
      NNSTAT = (NSTATS*NSTATS+NSTATS)/2
      TOLTMP = TOL
      CALL DSCAL(NROT,TWO,PRCNDO,1)
      CALL DSCAL(NSTATS*NDETLN,TWO,PRCNDC,1)
      CALL DSCAL(NNSTAT,TWO,PRCNDS,1)
C
      IJ = 1
      DO 10 I=1,L1
        DO J=1,I
          FCORSQ(I,J) = FCOR(IJ)
          FCORSQ(J,I) = FCORSQ(I,J)
          IJ = IJ + 1
        ENDDO
   10 CONTINUE
C
C     ----- Construct rhs and place in array temporarily -----
C
      CALL FMRHS(ZRESO,ZRESC,ZRESS,CI,EGRAD,WSTATE,WRK,INDEX,NOCP,NXYZ,
     *           NUNIQ,NROT,NDETLN,NOCC,L1,NFT18,NFT19,NSTATS,JLO,JHI,
     *           NDETMX,NNSTAT)
C
      DO IXYZ=1,NUNIQ
        BNORM(IXYZ) = ZERO
        BNORM(IXYZ) = DDOT(NSTATS*NDETLN,ZRESC(IXYZ,1),NUNIQ,
     *                     ZRESC(IXYZ,1),NUNIQ)
      ENDDO
      IF(GOPARR) CALL DDI_GSUMF(2169,BNORM,NUNIQ)
C
      DO IXYZ=1,NUNIQ
        BVAL = ZERO
        BVAL = DDOT(NROT,ZRESO(IXYZ,1),NUNIQ,ZRESO(IXYZ,1),NUNIQ)
        BNORM(IXYZ) = BNORM(IXYZ) + BVAL
        BVAL = DDOT(NNSTAT,ZRESS(IXYZ,1),NUNIQ,ZRESS(IXYZ,1),NUNIQ)
        BVAL = BVAL + BNORM(IXYZ)
        BNORM(IXYZ) = SQRT(BVAL)
C        IF(MASWRK) WRITE(IW,9720) IXYZ,BNORM(IXYZ)
C        CALL FLSHBF(IW)
      ENDDO
C
C     ----- Construct initial guess for solution -----
C
      CALL DCOPY(NUNIQ*NROT,ZRESO,1,YAO,1)
      CALL DCOPY(NUNIQ*NDETLN*NSTATS,ZRESC,1,YAC,1)
      CALL DCOPY(NUNIQ*NNSTAT,ZRESS,1,YAS,1)
C
      DO I=1,NROT
        FACTOR = -ONE/PRCNDO(I)
        CALL DSCAL(NUNIQ,FACTOR,YAO(1,I),1)
      ENDDO
C
      DO 20 ISTAT=1,NSTATS
        IVAL = (ISTAT-1)*NDETLN
        DO I=JLO,JHI
          IVAL = IVAL + 1
          FACTOR = -ONE/PRCNDC(IVAL)
          CALL DSCAL(NUNIQ,FACTOR,YAC(1,IVAL),1)
        ENDDO
   20 CONTINUE
C
      CALL DCOPY(NUNIQ*NROT,YAO,1,PDIRO,1)
      CALL DCOPY(NUNIQ*NNSTAT,YAS,1,PDIRS,1)
      IF(GOPARR) CALL VCLR(PDIRC,1,NUNIQ*NDETMX*NSTATS)
      DO ISTAT=1,NSTATS
        IYVAL = (ISTAT-1)*NDETLN + 1
        IPVAL = (ISTAT-1)*NDETMX + JLO
        CALL DCOPY(NUNIQ*(JHI-JLO+1),YAC(1,IYVAL),1,PDIRC(1,IPVAL),1)
      ENDDO
      IF(GOPARR) CALL DDI_GSUMF(2170,PDIRC,NUNIQ*NDETMX*NSTATS)
C
C     ----- Perform matrix multiplication for first interation -----
C     -----                of CPMCHF equations                 -----
C
      ITER = 1
      CALL TSECND(TIM)
      TIM1 = TIM
      IF(GOPARR) THEN
        CALL DDI_PROCDLB_RESET(C_OOOO)
        CALL DDI_PROCDLB_RESET(C_VOOO)
        CALL DDI_PROCDLB_RESET(C_VVOO)
        CALL DDI_PROCDLB_RESET(C_VOVO)
        CALL HSMLTP(RESIDO,PDIRO,OINT,EPS,OPDM,TPDM,WRK,INDEX,IA,NROT,
     *              NUNIQ,NCOR,NACT,L0,L1,L2)
C
      ENDIF
      CALL TSECND(TIM)
      TIM2 = TIM
      TIMORB = TIM2 - TIM1
C
      CALL HSMLTC(RESIDC,RESIDO,RESIDS,PDIRO,PDIRC,PDIRS,PRCNDS,SALAG,
     *            CI,OINT,FCORSQ,AMAT,ERI,INDEX,IWRK,IFA,IOX,NCOR,NACT,
     *            NA,NB,L1,L2,NSYM,IIS,NDETMX,NDETLN,NROT,NUNIQ,JLO,JHI,
     *            NSTATS,WSTATE,WRK,YADEN,AVEC,BVEC,YAOTMP,ITER,GENMC,
     *            LNEED,LBOX1,LBOX2,LBOX3,LBOX4,LBOX5,ITGA,ITGB,IAST,
     *            IBST,NB1EX,JROTLO,JROTHI)
      CALL TSECND(TIM)
      TIMCI = TIM - TIM2
C
C     ----- Calculate residual for first iteration -----
C
      IF(GOPARR) CALL DDI_GSUMF(2180,RESIDO,NROT*NUNIQ)
      CALL DSCAL(NROT*NUNIQ,-TWO,RESIDO,1)
      CALL DAXPY(NROT*NUNIQ,-ONE,ZRESO,1,RESIDO,1)
C
      CALL DSCAL(NSTATS*NDETLN*NUNIQ,-TWO,RESIDC,1)
      CALL DAXPY(NSTATS*NDETLN*NUNIQ,-ONE,ZRESC,1,RESIDC,1)
C
      CALL DSCAL(NNSTAT*NUNIQ,-TWO,RESIDS,1)
      CALL DAXPY(NNSTAT*NUNIQ,-ONE,ZRESS,1,RESIDS,1)
C
C     ----- Calculate initial psuedoresidual -----
C
      DO 200 IXYZ=1,NUNIQ
        DO IROT=1,NROT
          ZRESO(IXYZ,IROT) = RESIDO(IXYZ,IROT)/PRCNDO(IROT)
        ENDDO
        DO 100 ISTAT=1,NSTATS
          IVAL = (ISTAT-1)*NDETLN
          DO IDET=JLO,JHI
            IVAL = IVAL + 1
            ZRESC(IXYZ,IVAL) = RESIDC(IXYZ,IVAL)/PRCNDC(IVAL)
          ENDDO
  100   CONTINUE
        DO I=1,NNSTAT
          ZRESS(IXYZ,I) = RESIDS(IXYZ,I)
        ENDDO
  200 CONTINUE
C
C     ----- Check convergence -----
C
      IUNIQ = 0
      ERR = ZERO
      DO 220 IXYZ=1,NXYZ
        IF(NOCP(IXYZ).NE.1) IUNIQ=IUNIQ+1
        IF(NOCP(IXYZ).NE.0) GO TO 220
C
        RNORM = ZERO
        RNORM = DDOT(NSTATS*NDETLN,RESIDC(IUNIQ,1),NUNIQ,
     *               RESIDC(IUNIQ,1),NUNIQ)
        IF(GOPARR) CALL DDI_GSUMF(2181,RNORM,1)
        RNORM = RNORM +
     *          DDOT(NROT,RESIDO(IUNIQ,1),NUNIQ,RESIDO(IUNIQ,1),NUNIQ)
        RNORM = RNORM +
     *          DDOT(NNSTAT,RESIDS(IUNIQ,1),NUNIQ,RESIDS(IUNIQ,1),NUNIQ)
        TEST = SQRT(RNORM)
        IF(BNORM(IUNIQ).GT.TOL) TEST = TEST/BNORM(IUNIQ)
C
C        IF(MASWRK) WRITE(IW,9721) IUNIQ,TEST
C
        IF(TEST.LT.TOL) NOCP(IXYZ) = 2
        ERR = MAX(ERR,TEST)
  220 CONTINUE
C
      IF(MASWRK) THEN
         WRITE(IW,9000) TOL
         WRITE(IW,9030)
         WRITE(IW,9020) ITER,ERR,NUNIQ,TIMORB,TIMCI
         CALL FLSHBF(IW)
      ENDIF
      IF(ERR.LT.TOL) GO TO 800
C
C     ----- The remaining CG interations start now... -----
C
      DO 400 ITER=2,MAXIT
C
C          ----- Calculate coef. BK and direction vector PDIR -----
C
        DO IUNIQ=1,NUNIQ
          BKNUM(IUNIQ) = DDOT(NSTATS*NDETLN,ZRESC(IUNIQ,1),NUNIQ,
     *                        RESIDC(IUNIQ,1),NUNIQ)
        ENDDO
        IF(GOPARR) THEN
          CALL DDI_GSUMF(2182,BKNUM,NUNIQ)
          IF(ITER.EQ.2) THEN
            CALL VCLR(PDIRC,1,NUNIQ*NDETMX*NSTATS)
          ELSE
            CALL DSCAL(NUNIQ*NDETMX*NSTATS,ONE/NPROC,PDIRC,1)
          ENDIF
        ENDIF
C
        IUNIQ = 0
        DO 320 IXYZ=1,NXYZ
          IF(NOCP(IXYZ).NE.1) IUNIQ = IUNIQ + 1
          IF(NOCP(IXYZ).NE.0) GO TO 320
          BVAL = DDOT(NROT,ZRESO(IUNIQ,1),NUNIQ,RESIDO(IUNIQ,1),NUNIQ)
          BVAL = BVAL +
     *           DDOT(NNSTAT,ZRESS(IUNIQ,1),NUNIQ,RESIDS(IUNIQ,1),NUNIQ)
          BKNUM(IUNIQ) = BKNUM(IUNIQ) + BVAL
C          IF(BKNUM(IUNIQ).LE.-TOL) THEN
C            IF(MASWRK) WRITE(IW,9040)
C            CALL ABRT
C          ENDIF
C
          IF(ITER.EQ.2) THEN
            CALL DCOPY(NROT,ZRESO(IUNIQ,1),NUNIQ,PDIRO(IUNIQ,1),NUNIQ)
            CALL DCOPY(NNSTAT,ZRESS(IUNIQ,1),NUNIQ,PDIRS(IUNIQ,1),NUNIQ)
            DO ISTAT=1,NSTATS
              IZVAL = (ISTAT-1)*NDETLN + 1
              IPVAL = (ISTAT-1)*NDETMX + JLO
              CALL DCOPY((JHI-JLO+1),ZRESC(IUNIQ,IZVAL),NUNIQ,
     *                   PDIRC(IUNIQ,IPVAL),NUNIQ)
            ENDDO
          ELSE
            BK = BKNUM(IUNIQ)/BKDEN(IUNIQ)
            CALL DSCAL(NROT,BK,PDIRO(IUNIQ,1),NUNIQ)
            CALL DAXPY(NROT,ONE,ZRESO(IUNIQ,1),NUNIQ,PDIRO(IUNIQ,1),
     *                 NUNIQ)
            CALL DSCAL(NNSTAT,BK,PDIRS(IUNIQ,1),NUNIQ)
            CALL DAXPY(NNSTAT,ONE,ZRESS(IUNIQ,1),NUNIQ,PDIRS(IUNIQ,1),
     *                 NUNIQ)
            CALL DSCAL(NSTATS*NDETMX,BK,PDIRC(IUNIQ,1),NUNIQ)
            DO ISTAT=1,NSTATS
              IZVAL = (ISTAT-1)*NDETLN + 1
              IPVAL = (ISTAT-1)*NDETMX + JLO
              CALL DAXPY((JHI-JLO+1),ONE,ZRESC(IUNIQ,IZVAL),NUNIQ,
     *                   PDIRC(IUNIQ,IPVAL),NUNIQ)
            ENDDO
          ENDIF
          BKDEN(IUNIQ) = BKNUM(IUNIQ)
  320   CONTINUE
        IF(GOPARR) CALL DDI_GSUMF(2172,PDIRC,NUNIQ*NDETMX*NSTATS)
C
C     ----- Calculate coefficient AK, new iterate YA, new -----
C     ----- residual RESID, and new pseudo-residual ZRES  -----
C
        CALL TSECND(TIM)
        TIM1 = TIM
        IF(GOPARR) THEN
          CALL DDI_PROCDLB_RESET(C_OOOO)
          CALL DDI_PROCDLB_RESET(C_VOOO)
          CALL DDI_PROCDLB_RESET(C_VVOO)
          CALL DDI_PROCDLB_RESET(C_VOVO)
          CALL HSMLTP(ZRESO,PDIRO,OINT,EPS,OPDM,TPDM,WRK,INDEX,IA,NROT,
     *                NUNIQ,NCOR,NACT,L0,L1,L2)
C
        ENDIF
        CALL TSECND(TIM)
        TIM2 = TIM
        TIMORB = TIM2 - TIM1
C
        ITERX = ITER
        CALL HSMLTC(ZRESC,ZRESO,ZRESS,PDIRO,PDIRC,PDIRS,PRCNDS,SALAG,
     *              CI,OINT,FCORSQ,AMAT,ERI,INDEX,IWRK,IFA,IOX,NCOR,
     *              NACT,NA,NB,L1,L2,NSYM,IIS,NDETMX,NDETLN,NROT,NUNIQ,
     *              JLO,JHI,NSTATS,WSTATE,WRK,YADEN,AVEC,BVEC,YAOTMP,
     *              ITERX,GENMC,LNEED,LBOX1,LBOX2,LBOX3,LBOX4,LBOX5,
     *              ITGA,ITGB,IAST,IBST,NB1EX,JROTLO,JROTHI)
        CALL TSECND(TIM)
        TIMCI = TIM - TIM2
C
        IF(GOPARR) CALL DDI_GSUMF(2183,ZRESO,NROT*NUNIQ)
        CALL DSCAL(NROT*NUNIQ,TWO,ZRESO,1)
        CALL DSCAL(NNSTAT*NUNIQ,TWO,ZRESS,1)
        CALL DSCAL(NSTATS*NDETLN*NUNIQ,TWO,ZRESC,1)
        NXYZF = 0
        DO IXYZ = 1,NXYZ
          IF (NOCP(IXYZ).EQ.0) NXYZF = NXYZF+1
        END DO
C
        ERR = ZERO
        IUNIQ = 0
        DO 350 IXYZ=1,NXYZ
          IF(NOCP(IXYZ).NE.1) IUNIQ = IUNIQ + 1
          IF(NOCP(IXYZ).NE.0) GO TO 350
C
          AKDEN = ZERO
          DO ISTAT=1,NSTATS
            IZVAL = (ISTAT-1)*NDETLN + 1
            IPVAL = (ISTAT-1)*NDETMX + JLO
            AKDEN = AKDEN + DDOT((JHI-JLO+1),PDIRC(IUNIQ,IPVAL),
     *                           NUNIQ,ZRESC(IUNIQ,IZVAL),NUNIQ)
          ENDDO
          IF(GOPARR) CALL DDI_GSUMF(2184,AKDEN,1)
          AKDEN = AKDEN + DDOT(NROT,PDIRO(IUNIQ,1),NUNIQ,ZRESO(IUNIQ,1),
     *                         NUNIQ)
          AKDEN = AKDEN + DDOT(NNSTAT,PDIRS(IUNIQ,1),NUNIQ,
     *                         ZRESS(IUNIQ,1),NUNIQ)
          AK = BKNUM(IUNIQ)/AKDEN
C
          CALL DAXPY(NROT,AK,PDIRO(IUNIQ,1),NUNIQ,YAO(IUNIQ,1),NUNIQ)
          CALL DAXPY(NROT,-AK,ZRESO(IUNIQ,1),NUNIQ,RESIDO(IUNIQ,1),
     *               NUNIQ)
          CALL DAXPY(NNSTAT,AK,PDIRS(IUNIQ,1),NUNIQ,YAS(IUNIQ,1),NUNIQ)
          CALL DAXPY(NNSTAT,-AK,ZRESS(IUNIQ,1),NUNIQ,RESIDS(IUNIQ,1),
     *               NUNIQ)
          DO ISTAT=1,NSTATS
            IPVAL = (ISTAT-1)*NDETMX + JLO
            IYVAL = (ISTAT-1)*NDETLN + 1
            CALL DAXPY((JHI-JLO+1),AK,PDIRC(IUNIQ,IPVAL),NUNIQ,
     *                 YAC(IUNIQ,IYVAL),NUNIQ)
          ENDDO
          CALL DAXPY(NSTATS*NDETLN,-AK,ZRESC(IUNIQ,1),NUNIQ,
     *               RESIDC(IUNIQ,1),NUNIQ)
C
          DO IROT=1,NROT
            ZRESO(IUNIQ,IROT) = RESIDO(IUNIQ,IROT)/PRCNDO(IROT)
          ENDDO
          DO 340 ISTAT=1,NSTATS
            IVAL = (ISTAT-1)*NDETLN
            DO IDET=JLO,JHI
              IVAL = IVAL + 1
              ZRESC(IUNIQ,IVAL) = RESIDC(IUNIQ,IVAL)/PRCNDC(IVAL)
            ENDDO
  340     CONTINUE
          DO I=1,NNSTAT
            ZRESS(IUNIQ,I) = RESIDS(IUNIQ,I)
          ENDDO
C
C          ----- Check convergence -----
C
          RNORM = DDOT(NSTATS*NDETLN,RESIDC(IUNIQ,1),NUNIQ,
     *                 RESIDC(IUNIQ,1),NUNIQ)
          IF(GOPARR) CALL DDI_GSUMF(2185,RNORM,1)
          RNORM = RNORM +
     *            DDOT(NROT,RESIDO(IUNIQ,1),NUNIQ,RESIDO(IUNIQ,1),NUNIQ)
          RNORM = RNORM + DDOT(NNSTAT,RESIDS(IUNIQ,1),NUNIQ,
     *                         RESIDS(IUNIQ,1),NUNIQ)
          TEST = SQRT(RNORM)
          IF(BNORM(IUNIQ).GT.TOL) TEST = TEST/BNORM(IUNIQ)
C
C         IF(MASWRK) WRITE(IW,9721) IUNIQ,TEST
C
          IF(TEST.LT.TOLTMP) NOCP(IXYZ) = 2
          ERR = MAX(ERR,TEST)
  350   CONTINUE
        IF(MASWRK) THEN
           WRITE(IW,9020) ITER,ERR,NXYZF,TIMORB,TIMCI
           CALL FLSHBF(IW)
        END IF
        IF(ERR.LT.TOLTMP) GO TO 800
        IF(MOD(ITER,50).EQ.0) THEN
          TOLTMP = THREE*TOLTMP
          IF(MASWRK) WRITE(IW,9075) TOLTMP
        ENDIF
        IF(ITER.EQ.MAXIT) THEN
C          IF(ERR.LT.TOLTMP) THEN
            GO TO 800
C          END IF
C          GO TO 400
        END IF
  400 CONTINUE
C
C     ----- Calculation did not converge after too many cycles -----
C
      IF(MASWRK) WRITE(IW,9070) MAXIT
      CALL ABRT
      STOP
C
C     ----- Determine whether solution vectors are correct -----
C
C
  800 CALL DCOPY(NUNIQ*NROT,YAO,1,PDIRO,1)
      CALL DCOPY(NUNIQ*NNSTAT,YAS,1,PDIRS,1)
      IF(GOPARR) CALL VCLR(PDIRC,1,NUNIQ*NDETMX*NSTATS)
      DO ISTAT=1,NSTATS
        IPVAL = (ISTAT-1)*NDETMX + JLO
        IYVAL = (ISTAT-1)*NDETLN + 1
        CALL DCOPY(NUNIQ*(JHI-JLO+1),YAC(1,IYVAL),1,PDIRC(1,IPVAL),1)
      ENDDO
      IF(GOPARR) THEN
        CALL DDI_GSUMF(2173,PDIRC,NUNIQ*NDETMX*NSTATS)
C
        CALL DDI_PROCDLB_RESET(C_OOOO)
        CALL DDI_PROCDLB_RESET(C_VOOO)
        CALL DDI_PROCDLB_RESET(C_VVOO)
        CALL DDI_PROCDLB_RESET(C_VOVO)
        CALL HSMLTP(RESIDO,PDIRO,OINT,EPS,OPDM,TPDM,WRK,INDEX,IA,NROT,
     *              NUNIQ,NCOR,NACT,L0,L1,L2)
      ENDIF
C
      CALL HSMLTC(RESIDC,RESIDO,RESIDS,PDIRO,PDIRC,PDIRS,PRCNDS,SALAG,
     *            CI,OINT,FCORSQ,AMAT,ERI,INDEX,IWRK,IFA,IOX,NCOR,NACT,
     *            NA,NB,L1,L2,NSYM,IIS,NDETMX,NDETLN,NROT,NUNIQ,JLO,JHI,
     *            NSTATS,WSTATE,WRK,YADEN,AVEC,BVEC,YAOTMP,ITER,GENMC,
     *            LNEED,LBOX1,LBOX2,LBOX3,LBOX4,LBOX5,ITGA,ITGA,IAST,
     *            IBST,NB1EX,JROTLO,JROTHI)
C
      IF(GOPARR) CALL DDI_GSUMF(2184,RESIDO,NROT*NUNIQ)
      CALL DSCAL(NROT*NUNIQ,TWO,RESIDO,1)
      CALL DSCAL(NROT*NNSTAT,TWO,RESIDS,1)
      CALL DSCAL(NSTATS*NDETLN*NUNIQ,TWO,RESIDC,1)
C
      CALL FMRHS(ZRESO,ZRESC,ZRESS,CI,EGRAD,WSTATE,WRK,INDEX,NOCP,NXYZ,
     *           NUNIQ,NROT,NDETLN,NOCC,L1,NFT18,NFT19,NSTATS,JLO,JHI,
     *           NDETMX,NNSTAT)
C
      ERR = ZERO
      IUNIQ=0
      DO 860 IXYZ=1,NXYZ
        IF(NOCP(IXYZ).NE.1) IUNIQ=IUNIQ+1
        IF(NOCP(IXYZ).EQ.1) GO TO 860
        CALL DSCAL(NROT,-ONE,RESIDO(IUNIQ,1),NUNIQ)
        CALL DSCAL(NNSTAT,-ONE,RESIDS(IUNIQ,1),NUNIQ)
        CALL DSCAL(NSTATS*NDETLN,-ONE,RESIDC(IUNIQ,1),NUNIQ)
        CALL DAXPY(NROT,-ONE,ZRESO(IUNIQ,1),NUNIQ,RESIDO(IUNIQ,1),NUNIQ)
        CALL DAXPY(NNSTAT,-ONE,ZRESS(IUNIQ,1),NUNIQ,RESIDS(IUNIQ,1),
     *             NUNIQ)
        CALL DAXPY(NSTATS*NDETLN,-ONE,ZRESC(IUNIQ,1),NUNIQ,
     *             RESIDC(IUNIQ,1),NUNIQ)
C
        RNORM = DDOT(NSTATS*NDETLN,RESIDC(IUNIQ,1),NUNIQ,
     *               RESIDC(IUNIQ,1),NUNIQ)
        IF(GOPARR) CALL DDI_GSUMF(2186,RNORM,1)
        RNORM = RNORM +
     *          DDOT(NROT,RESIDO(IUNIQ,1),NUNIQ,RESIDO(IUNIQ,1),NUNIQ)
        RNORM = RNORM + DDOT(NNSTAT,RESIDS(IUNIQ,1),NUNIQ,
     *                       RESIDS(IUNIQ,1),NUNIQ)
        TEST = SQRT(RNORM)
        IF(BNORM(IUNIQ).GT.TOL) TEST = TEST/BNORM(IUNIQ)
        IF(TEST.GT.TOLTMP) THEN
          IF(MASWRK) WRITE(IW,9050) IUNIQ,TEST
        END IF
        ERR = MAX(ERR,TEST)
  860 CONTINUE
      IF(GOPARR) CALL DDI_SYNC(6676)
      IF(ERR.GT.TOLTMP) THEN
         IF(MASWRK) WRITE(IW,9060)
         CALL ABRT
         STOP
      END IF
C
C     ----- Print convergence message and restore original NOCP -----
C
      IF(MASWRK .AND. TOL.EQ.TOLTMP) WRITE(IW,9080) ITER
      IF(MASWRK .AND. TOL.NE.TOLTMP) WRITE(IW,9090) ITER
      DO IXYZ=1,NXYZ
         IF(NOCP(IXYZ).EQ.2) NOCP(IXYZ)=0
      ENDDO
C
 9000 FORMAT(/1X,'PRECONDITIONED CONJUGATE GRADIENT SOLVER',5X,
     *           'CONV. TOLERANCE=',1P,E8.2)
 9020 FORMAT(1X,I3,4X,1P,E13.5,0P,4X,I6,8X,F7.1,4X,F7.1)
 9030 FORMAT(1X,'ITER',3X,'RESPONSE ERROR',4X,'IMPROVED',5X,
     *       'ORB-ORB',4X,' CI-ORB',5X)
Ctjd 9040 FORMAT(1X,'***** WARNING! *****',
Ctjd     *       ' THE PRECONDITIONER IS NOT POSITIVE DEFINITE.')
 9050 FORMAT(1X,'INCORRECT SOLUTION VECTOR: IUNIQ=',I3,5X,'ERR=',E13.5)
 9060 FORMAT(1X,'CPMCHF SOLUTIONS ARE JUNK...SORRY')
 9070 FORMAT(//1X,'*** TOO MANY ITERATIONS IN MCCPCG *** MAXIT=',I5/
     *       1X,'THIS VALUE CANNOT BE RAISED BY THE INPUT BECAUSE'/
     *       1X,'MORE ITERATIONS ARE UNLIKELY TO HELP.'//)
 9075 FORMAT(1X,'DUE TO SLOW CONVERGENCE, TOLERANCE HAS BEEN',
     *       1X,'RAISED TO ',1P,E8.2)
 9080 FORMAT(1X,'THE CPMCHF HAS CONVERGED AFTER',I4,' ITERATIONS.')
 9090 FORMAT(1X,'*** CAUTION! *** '/
     *       1X,'RESPONSES CONVERGED AFTER',I4,' ITERATIONS,'/
     *       1X,'BUT ONLY TO WITHIN AN INCREASED CONVERGENCE TOLERANCE')
Ctjd 9720 FORMAT(/2X,'iuniq=',I3,2X,'bnorm=',F18.12)
Ctjd 9721 FORMAT(/2X,'iuniq=',I3,2X,'test=',F18.12)
      RETURN
      END
C*MODULE CPMCHF  *DECK ORMCP
C     ------------------------------------------------------------------
      SUBROUTINE ORMCP(IW,NDER,LBOX1,LBOX2,LBOX3,NA,NB,
     *            CI,CIOLD,X,NSTATS,NX,NDETMX,IBO,
     *            IDSYM,ISYM1,NSYM,
     *            NACT,LWRK,KTAB,LGMUL,
     *            LCON,LCOA,LCOB,
     *            LANDET,LBNDET,NAST,NBST,LSYMA,LSYMB,LGCOM,
     *            LSPA,LSPB,LDISB,
     *            LSAS,LSBS,LSAC,LSBC,
     *            ITGA,ITGB,IAST,IBST,NA1EX,NB1EX)
C     ------------------------------------------------------------------
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      LOGICAL FDIRCT,QCORR
C
      DIMENSION LBOX1(*),LBOX2(*),LBOX3(*)
      DIMENSION CI(NDETMX,NSTATS),CIOLD(NX,NSTATS),X(*)
      DIMENSION IBO(NACT)
      DIMENSION LWRK(43),KTAB(NSYM),LGMUL(NSYM,NSYM)
      DIMENSION LCON(NA)
      DIMENSION LCOA(NSYM,ITGA),LCOB(NSYM,ITGB)
      DIMENSION LANDET(NSPACE,ITGA),LBNDET(NSPACE,ITGB)
      DIMENSION NAST(ITGA+1),NBST(ITGB+1)
      DIMENSION LSYMA(IAST),LSYMB(IBST)
      DIMENSION LGCOM(ITGB,ITGA)
      DIMENSION LSPA(IAST),LSPB(IBST)
      DIMENSION LDISB(NSYM,ITGB,ITGA)
      DIMENSION LSAS(NSYM+1,ITGA),LSBS(NSYM+1,ITGB)
      DIMENSION LSAC(IAST),LSBC(IBST)
C
      COMMON /FCCWFN/ NSPACE,MSTA(51),MNUM(51),MINI(51),MAXI(51),
     *                IAMI(51),IAMA(51),IBMI(51),IBMA(51),IDIM(51),
     *                LBST(51),NREF0,FDIRCT,QCORR,C0SQ
C
      IF(NDER.EQ.1 .OR. IDSYM.LT.1) CALL DCOPY(NSTATS*NX,CIOLD,1,CI,1)
C
C 1/
C   MAKE SYMMETRY TABLES
C
      IF (IDSYM.GT.0) THEN
      CALL GTAB(IDSYM,ISYM1,KTAB,LWRK(1),LWRK(4),LWRK(7),LWRK(10))
      CALL GMUL(IDSYM,LGMUL,LWRK(1),LWRK(4),LWRK(7),LWRK(10))
      ELSE
      CALL GTAB(1,1,KTAB,LWRK(1),LWRK(4),LWRK(7),LWRK(10))
      CALL GMUL(1,LGMUL,LWRK(1),LWRK(4),LWRK(7),LWRK(10))
      ENDIF
C
      DO II=1,ITGA
         DO JJ=1,NSYM
            LCOA(JJ,II) = 0
         ENDDO
      ENDDO
C
      DO II=1,ITGB
         DO JJ=1,NSYM
            LCOB(JJ,II) = 0
         ENDDO
      ENDDO
C
C  2/
C    MAKE LANDET, LBNDET.  LANDET(I,J) SAYS HOW MANY ALPHA STRINGS
C    THERE ARE FOR GROUP J, SPACE I.  ANALOGOUS FOR LBNDET(I,J).
C
C    LOOP THROUGH ALL ALPHA GROUPS:
C
      ISTA1 = LBST(1)
      CALL RESETCO(LBOX1,NSPACE,NA,IAMA,IAMI,LBOX2)
      DO II=1,ITGA
         DO JJ=1,NSPACE
            ISTA2 = LBST(JJ) - ISTA1 + 1
            LANDET(JJ,II)=ISPADET(X(ISTA2),MNUM(JJ),IDIM(JJ),LBOX1(JJ))
         ENDDO
      CALL PUSHCO(LBOX1,NSPACE,NA,IAMA,IAMI,LBOX2,IEND)
      ENDDO
C
C    LOOP THROUGH ALL BETA GROUPS, DO SAME AS ABOVE ESSENTIALLY.
C
      CALL RESETCO(LBOX1,NSPACE,NB,IBMA,IBMI,LBOX2)
      DO II=1,ITGB
         DO JJ=1,NSPACE
            ISTA2 = LBST(JJ) - ISTA1 + 1
            LBNDET(JJ,II)=ISPADET(X(ISTA2),MNUM(JJ),IDIM(JJ),LBOX1(JJ))
         ENDDO
      CALL PUSHCO(LBOX1,NSPACE,NB,IBMA,IBMI,LBOX2,IEND)
      ENDDO
C
C  3/
C    MAKE NAST, NBST.  NAST(I) SAYS WHERE ALPHA STRINGS OF GROUP I
C    START IN FULL STRING LIST - 1.  ANALOGOUS FOR NBST.
C
      NAST(1) = 0
      NBST(1) = 0
      DO II=1,ITGA
         ITOT = 1
         DO JJ=1,NSPACE
            ITOT = ITOT * LANDET(JJ,II)
         ENDDO
         NAST(II+1) = NAST(II) + ITOT
      ENDDO
C
      DO II=1,ITGB
         ITOT = 1
         DO JJ=1,NSPACE
            ITOT = ITOT * LBNDET(JJ,II)
         ENDDO
         NBST(II+1) = NBST(II) + ITOT
      ENDDO
C
C  4/
C       MAKE LGCOM.  IF LGCOM(I,J).NE.0 THEN BETA GROUP I
C       AND ALPHA GROUP J ARE COMPATIBLE.
C
      ICOMP = 0
      CALL RESETCO(LBOX1,NSPACE,NA,IAMA,IAMI,LBOX3)
      DO JJ=1,ITGA
         CALL RESETCO(LBOX2,NSPACE,NB,IBMA,IBMI,LBOX3)
         DO II=1,ITGB
            LGCOM(II,JJ) = 0
            DO KK=1,NSPACE
               IOC = LBOX1(KK) + LBOX2(KK)
               IF (IOC.GT.MAXI(KK).OR.IOC.LT.MINI(KK)) GO TO 100
            ENDDO
C
            LGCOM(II,JJ) = 1
            ICOMP = ICOMP + 1
  100       CALL PUSHCO(LBOX2,NSPACE,NB,IBMA,IBMI,LBOX3,IEND)
         ENDDO
         CALL PUSHCO(LBOX1,NSPACE,NA,IAMA,IAMI,LBOX3,IEND)
      ENDDO
C
C  5/
C    A) MAKE LSYMB.  LSYMB(I) IS SYMMETRY OF BETA STRING I.
C       MAKE LCOB.  LCOB(I,J) IS NUMBER OF DETERMINANTS
C       OF SYMMETRY I IN GROUP J.
C       MAKE LSPB.  LSPB(I) IS BETA STRING I'S SYMMETRY POSITION IN
C       IT'S OWN GROUP.
C
      CALL RESETCO(LBOX1,NSPACE,NB,IBMA,IBMI,LBOX2)
C
C    LOOP THROUGH GROUPS.
C
      ICOUNT = 0
      DO II=1,ITGB
C
C    LOOP THROUGH ALL STRINGS IN GROUP II.
C
         CALL RESETDE(LBOX1,NSPACE,NB,MSTA,LCON)
C
         ITOT = 1
         DO JJ=1,NSPACE
            ITOT = ITOT * LBNDET(JJ,II)
         ENDDO
C
         DO KK=1,ITOT
            ICOUNT = ICOUNT + 1
            CALL GETSYM1(IW,LCON,NACT,NB,IBO,IDSYM,ISYM,
     *      LWRK(1),LWRK(4),LWRK(7),LWRK(10))
            LSYMB(ICOUNT) = ISYM
            LCOB(ISYM,II) = LCOB(ISYM,II) + 1
            LSPB(ICOUNT) = LCOB(ISYM,II)
C
            CALL MOVEUP2(LBOX1,NSPACE,NB,MSTA,LCON)
         ENDDO
C
         CALL PUSHCO(LBOX1,NSPACE,NB,IBMA,IBMI,LBOX2,IEND)
      ENDDO
C
C    B) - MAKE LSYMA.  LSYMA(I) IS SYMMETRY OF ALPHA STRING I.
C       - MAKE LCOA.  LCOA(I,J) IS NUMBER OF DETERMINANTS
C         OF SYMMETRY I IN GROUP J.
C       - MAKE LSPA.  LSPA(I) IS WHERE ALPHA STRING I STARTS IN
C         THE FULL LIST OF DETERMINANTS.  EACH ALPHA STRING IS COUPLED
C         WITH RELEVANT BETA STRINGS (IN BETA GROUP AND SYMMETRY ORDER).
C       - MAKE LDISB.  LDISB(ISYM,I,J) SAYS WHERE BETA GROUP I, AND
C         SYMMETRY ISYM STARTS WHEN COUPLED TO ALPHA GROUP J.
C
      CALL RESETCO(LBOX1,NSPACE,NA,IAMA,IAMI,LBOX2)
C
C    LOOP THROUGH GROUPS.
C
      ICOUNT = 0
      NCI = 0
      IVAL = 1
      JVAL = 1
      DO II=1,ITGA
C
C    LOOP THROUGH ALL STRINGS IN GROUP II.
C
         CALL RESETDE(LBOX1,NSPACE,NA,MSTA,LCON)
         ITOT = 1
         DO JJ=1,NSPACE
            ITOT = ITOT * LANDET(JJ,II)
         ENDDO
C
         DO KK=1,ITOT
            ICOUNT = ICOUNT + 1
            CALL GETSYM1(IW,LCON,NACT,NA,IBO,IDSYM,ISYM,
     *      LWRK(1),LWRK(4),LWRK(7),LWRK(10))
            LSYMA(ICOUNT) = ISYM
            LCOA(ISYM,II) = LCOA(ISYM,II) + 1
C
            LSPA(ICOUNT) = NCI
            JSYM = KTAB(ISYM)
            DO 200 LL=1,ITGB
               IF (LGCOM(LL,II).EQ.0) GO TO 200
               NCI = NCI + LCOB(JSYM,LL)
  200       CONTINUE
C
C      The following code places the CI vector into C1 order
C      for hessians involving higher-order point groups
C
            IF(NDER.EQ.2 .AND. IDSYM.GT.0) THEN
              JCOUNT = 0
              DO 180 LL=1,ITGB
                IF(LGCOM(LL,II).EQ.0) GO TO 180
C
                DO 160 JJ=NBST(LL)+1,NBST(LL+1)
                  JCOUNT = JCOUNT + 1
                  JSYM = LGMUL(ISYM,LSYMB(JCOUNT))
                  IF(JSYM.EQ.ISYM1) THEN
                    CI(IVAL,1) = CIOLD(JVAL,1)
                    JVAL = JVAL + 1
                  ENDIF
                  IVAL = IVAL + 1
  160           CONTINUE
  180         CONTINUE
            ENDIF
C
C      End of new code
C
            CALL MOVEUP2(LBOX1,NSPACE,NA,MSTA,LCON)
         ENDDO
C
         DO KK=1,NSYM
            LWRK(KK) = 0
         ENDDO
         DO 300 JJ=1,ITGB
            DO KK=1,NSYM
               LDISB(KK,JJ,II) = 0
            ENDDO
            IF (LGCOM(JJ,II).EQ.0) GO TO 300
            DO KK=1,NSYM
               LDISB(KK,JJ,II) = LWRK(KK)
               LWRK(KK) = LWRK(KK) + LCOB(KK,JJ)
            ENDDO
  300    CONTINUE
C
         CALL PUSHCO(LBOX1,NSPACE,NA,IAMA,IAMI,LBOX2,IEND)
      ENDDO
C
C  6/
C    A) MAKE LSAS,LSBS,AND LSAC, LSBC.
C       LSAS(I,J) SAYS WHERE ALPHA STRINGS
C       OF GROUP J AND SYMMETRY I, START IN LSAC.
C       ANALOGOUS FOR LSBS AND LSBC.
C
      IPLA = 1
      DO II=1,ITGA
         DO JJ=1,NSYM
            LSAS(JJ,II) = IPLA
            IPLA = IPLA + LCOA(JJ,II)
         ENDDO
         LSAS(NSYM+1,II) = IPLA
      ENDDO
C
      IPLB = 1
      DO II=1,ITGB
         DO JJ=1,NSYM
            LSBS(JJ,II) = IPLB
            IPLB = IPLB + LCOB(JJ,II)
         ENDDO
         LSBS(NSYM+1,II) = IPLB
      ENDDO
C
      DO II=1,ITGA
         ITOT = 1
         DO JJ=1,NSYM
            LWRK(JJ) = 0
         ENDDO
         DO JJ=1,NSPACE
            ITOT = ITOT * LANDET(JJ,II)
         ENDDO
         IDISA = NAST(II)
         DO KK=1,ITOT
            JSYM = LSYMA(IDISA+KK)
            LWRK(JSYM) = LWRK(JSYM)+1
            LSAC(LSAS(JSYM,II)+LWRK(JSYM)-1) = KK
         ENDDO
      ENDDO
C
      DO II=1,ITGB
         ITOT = 1
         DO JJ=1,NSYM
            LWRK(JJ) = 0
         ENDDO
         DO JJ=1,NSPACE
            ITOT = ITOT * LBNDET(JJ,II)
         ENDDO
         IDISB = NBST(II)
         DO KK=1,ITOT
            JSYM = LSYMB(IDISB+KK)
            LWRK(JSYM) = LWRK(JSYM)+1
            LSBC(LSBS(JSYM,II)+LWRK(JSYM)-1) = KK
         ENDDO
      ENDDO
C
C       This code generates ORMAS arrays that reflect C1 symmetry
C
      IF(NDER.EQ.2 .AND. IDSYM.GT.0) THEN
        CALL GTAB(1,1,KTAB,LWRK(1),LWRK(4),LWRK(7),LWRK(10))
        CALL GMUL(1,LGMUL,LWRK(1),LWRK(4),LWRK(7),LWRK(10))
C
        DO II=1,ITGA
           DO JJ=1,NSYM
              LCOA(JJ,II) = 0
           ENDDO
        ENDDO
C
        CALL RESETCO(LBOX1,NSPACE,NB,IBMA,IBMI,LBOX2)
        ICOUNT = 0
        DO II=1,ITGB
          DO JJ=1,NSYM
             LCOB(JJ,II) = 0
          ENDDO
C
          CALL RESETDE(LBOX1,NSPACE,NB,MSTA,LCON)
C
          ITOT = 1
          DO JJ=1,NSPACE
            ITOT = ITOT * LBNDET(JJ,II)
          ENDDO
C
          DO KK=1,ITOT
            ICOUNT = ICOUNT + 1
            LSYMB(ICOUNT) = 1
            LCOB(1,II) = LCOB(1,II) + 1
            LSPB(ICOUNT) = LCOB(1,II)
C
            CALL MOVEUP2(LBOX1,NSPACE,NB,MSTA,LCON)
          ENDDO
C
          CALL PUSHCO(LBOX1,NSPACE,NB,IBMA,IBMI,LBOX2,IEND)
        ENDDO
C
        CALL RESETCO(LBOX1,NSPACE,NA,IAMA,IAMI,LBOX2)
        ICOUNT = 0
        NCITMP = 0
        DO II=1,ITGA
          CALL RESETDE(LBOX1,NSPACE,NA,MSTA,LCON)
C
          ITOT = 1
          DO JJ=1,NSPACE
            ITOT = ITOT * LANDET(JJ,II)
          ENDDO
C
          DO KK=1,ITOT
            ICOUNT = ICOUNT + 1
            LSYMA(ICOUNT) = 1
            LCOA(1,II) = LCOA(1,II) + 1
            LSPA(ICOUNT) = NCITMP
            DO 350 LL=1,ITGB
              IF(LGCOM(LL,II).EQ.0) GO TO 350
              NCITMP = NCITMP + LCOB(1,LL)
  350       CONTINUE
C
            CALL MOVEUP2(LBOX1,NSPACE,NA,MSTA,LCON)
          ENDDO
C
          DO KK=1,NSYM
             LWRK(KK) = 0
          ENDDO
          DO 400 JJ=1,ITGB
            DO KK=1,NSYM
              LDISB(KK,JJ,II) = 0
            ENDDO
            IF (LGCOM(JJ,II).EQ.0) GO TO 400
            LDISB(1,JJ,II) = LWRK(1)
            LWRK(1) = LWRK(1) + LCOB(1,JJ)
  400     CONTINUE
C
          CALL PUSHCO(LBOX1,NSPACE,NA,IAMA,IAMI,LBOX2,IEND)
        ENDDO
C
        IPLA = 1
        DO II=1,ITGA
          DO JJ=1,NSYM
            LSAS(JJ,II) = 0
          ENDDO
          LSAS(1,II) = IPLA
          IPLA = IPLA + LCOA(1,II)
          LSAS(2,II) = IPLA
        ENDDO
C
        IPLB = 1
        DO II=1,ITGB
          DO JJ=1,NSYM
            LSBS(JJ,II) = 0
          ENDDO
          LSBS(1,II) = IPLB
          IPLB = IPLB + LCOB(1,II)
          LSBS(2,II) = IPLB
        ENDDO
C
        DO II=1,ITGA
          ITOT = 1
          DO JJ=1,NSYM
            LWRK(JJ) = 0
          ENDDO
          DO JJ=1,NSPACE
            ITOT = ITOT * LANDET(JJ,II)
          ENDDO
          IDISA = NAST(II)
          DO KK=1,ITOT
            JSYM = LSYMA(IDISA+KK)
            LWRK(JSYM) = LWRK(JSYM)+1
            LSAC(LSAS(JSYM,II)+LWRK(JSYM)-1) = KK
          ENDDO
        ENDDO
C
        DO II=1,ITGB
          ITOT = 1
          DO JJ=1,NSYM
            LWRK(JJ) = 0
          ENDDO
          DO JJ=1,NSPACE
            ITOT = ITOT * LBNDET(JJ,II)
          ENDDO
          IDISB = NBST(II)
          DO KK=1,ITOT
            JSYM = LSYMB(IDISB+KK)
            LWRK(JSYM) = LWRK(JSYM)+1
            LSBC(LSBS(JSYM,II)+LWRK(JSYM)-1) = KK
          ENDDO
        ENDDO
C
        DO II=1,NACT
          IBO(II) = 1
        ENDDO
      ENDIF
C
C       End of new code
C
      NA1EX = 0
      NB1EX = ITGA
      IF (FDIRCT) RETURN
      NB1EX = 0
C
C ****************************************
C   DETERMINE TOTAL NUMBER OF SINGLE BETA EXCITATIONS
C   WHERE B' > B.
C ****************************************
C
C    LOOP THROUGH ALL BETA GROUPS
C
      CALL RESETCO(LBOX1,NSPACE,NB,IBMA,IBMI,LBOX3)
C
      DO 1000 IIB = 1,ITGB
C
         CALL RESETDE(LBOX1,NSPACE,NB,MSTA,LCON)
C
         DO 900 KKB=NBST(IIB)+1,NBST(IIB+1)
            DO II=1,NSPACE
               LBOX2(II) = LBOX1(II)
            ENDDO
C
C  LOOP OVER ALL SINGLE EXCITATIONS, CHECKING TO SEE
C  IF IT IS VALID.
C
C  LOOP SPACES TO EXCITE ELECTRONS FROM.
C
            IEBS = NB+1
            DO 890 ISPB1=NSPACE,1,-1
               IOC1 = LBOX1(ISPB1)
               IEBE = IEBS - 1
               IEBS = IEBS - IOC1
               IF (IOC1.EQ.0) GO TO 890
               LBOX2(ISPB1) = LBOX2(ISPB1)-1
C
C  LOOP ELECTRONS IN SPACE ISPB1
C  IEBS, IEBE ARE THE ELECTRONS IN SPACE ISPB1
C
               DO 885 IB1=IEBE,IEBS,-1
                  IO1 = LCON(IB1)
C
                  IGBE = IEBE - LBOX1(ISPB1)
C
C  LOOP OVER POSSIBLE SPACES TO EXCITE INTO.
C
               DO 880 ISPB2=ISPB1,NSPACE
C
C  IGBS,IGBE ARE ELECTRONS SPECIFYING ISPB2 SPACE ELECTRON LIMITS.
C
                  IGBS = IGBE + 1
                  IGBE = IGBE + LBOX1(ISPB2)
C
                  LBOX2(ISPB2) = LBOX2(ISPB2) + 1
                  IF (LBOX2(ISPB1).LT.IBMI(ISPB1)) GO TO 870
                  IF (LBOX2(ISPB2).GT.IBMA(ISPB2)) GO TO 870
C
C  MAKE GAP INFORMATION HERE.
C
                  IGBA = MAX(IB1+1,IGBS)
                  IF (LBOX1(ISPB2).EQ.0) THEN
                     ISTA = MSTA(ISPB2)
                     IEND = MSTA(ISPB2+1)-1
                  ELSEIF (ISPB2.EQ.ISPB1) THEN
                     ISTA = IO1+1
                     IEND = LCON(IGBA)-1
                     IF (IB1.EQ.IEBE) IEND=MSTA(ISPB1+1)-1
                  ELSE
                     ISTA = MSTA(ISPB2)
                     IEND = LCON(IGBA)-1
                  ENDIF
C
C  LOOP OVER GAPS
C
                  DO 860 IGAP=IGBA,IGBE+1
C
                     DO 850 JJ=ISTA,IEND
C
                     NB1EX = NB1EX + 1
C
C  ****** ALL THE WORK HAS TO BE DONE IN HERE. *******
C
  850             CONTINUE
C
                  ISTA = LCON(IGAP)+1
                  IEND = LCON(IGAP+1)-1
                  IF (IGAP.EQ.IGBE) IEND=MSTA(ISPB2+1)-1
  860             CONTINUE
C
  870             LBOX2(ISPB2) = LBOX2(ISPB2) - 1
  880          CONTINUE
C
  885          CONTINUE
C
               LBOX2(ISPB1) = LBOX2(ISPB1) + 1
  890       CONTINUE
C
            CALL MOVEUP2(LBOX1,NSPACE,NB,MSTA,LCON)
  900    CONTINUE
C
         CALL PUSHCO(LBOX1,NSPACE,NB,IBMA,IBMI,LBOX3,IEND)
C
 1000 CONTINUE
C
      RETURN
      END
C
C*MODULE CPMCHF  *DECK PCPSDR
      SUBROUTINE PCPSDR(BUFF,SDER,DLAG,DFC,DERI,FCOR,ERI,AMAT,OPDM,TPDM,
     *                  PRCNDO,IA,INDEX,NCOR,NACT,NXYZ,L0,L1,L2,N2,N4,
     *                  NROT,IW)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      INTEGER         C_OOOO, C_VOOO, C_VVOO, C_VOVO
      LOGICAL         GOPARR, DSKWRK, MASWRK
      LOGICAL         IJVAL
C
      DIMENSION BUFF(*),SDER(NXYZ,L1,L1),DLAG(NXYZ,L1,L1),DFC(NXYZ,L2),
     *          DERI(NXYZ,N4),FCOR(L2),ERI(L1,NACT,N2),AMAT(L1,NCOR,N2),
     *          OPDM(*),TPDM(N4),PRCNDO(NROT)
      DIMENSION IA(*),INDEX(L1,L1)
C
      COMMON /DLBTIM/ C_OOOO,C_VOOO,C_VVOO,C_VOVO
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
C
      INTEGER         D_OOOO,D_VOOO,D_VVOO,D_VOVO,D_VVVO,D_VVVV,
     *                D_OOOOAB,D_OOOOBB,D_VOOOAB,D_VOOOBA,D_VOOOBB,
     *                D_VVOOAB,D_VVOOBA,D_VVOOBB,D_VOVOAB,D_VOVOBB,
     *                D_U,D_UB,D_E,D_EB
      LOGICAL         NDOOOO,NDVOOO,NDVVOO,NDVOVO,NDVVVO,NDVVVV,NDCORE,
     *                NDVVOOBA,NDVVOOAB,NDVVOOBB,NDVOVOAB,NDVOVOBB,
     *                NDVOOOBA,NDVOOOAB,NDVOOOBB,NDOOOOAB,NDOOOOBB
      COMMON /TRFDMS/ D_OOOO,D_VOOO,D_VVOO,D_VOVO,D_VVVO,D_VVVV,
     *                D_OOOOAB,D_OOOOBB,D_VOOOAB,D_VOOOBA,D_VOOOBB,
     *                D_VVOOAB,D_VVOOBA,D_VVOOBB,D_VOVOAB,D_VOVOBB,
     *                D_U,D_UB,D_E,D_EB,
     *                NDOOOO,NDVOOO,NDVVOO,NDVOVO,NDVVVO,NDVVVV,NDCORE,
     *                NDVVOOBA,NDVVOOAB,NDVVOOBB,NDVOVOAB,NDVOVOBB,
     *                NDVOOOBA,NDVOOOAB,NDVOOOBB,NDOOOOAB,NDOOOOBB
C
      PARAMETER (ZERO=0.0D+00,HALF=0.5D+00,ONE=1.0D+00,TWO=2.0D+00)
      PARAMETER (FOUR=4.0D+00,TOL=1.0D-09)
C
      NOCC = NCOR+NACT
      NOTR = (NOCC*NOCC+NOCC)/2
      NVIR = L0 - NOCC
      NBVIR = L0 - NOCC
      NBTR = (NBVIR*NBVIR+NBVIR)/2
      NBSQ = NBVIR*NBVIR
      L3 = L1*L1
C
      CALL VCLR(PRCNDO,1,NROT)
C
      IP = 0
      CALL TSECND(T0)
      DO 8000 IP=0,NPROC-1
        IWP = MOD(ME+IP,NPROC)
C
C     ----- Get and use (OO|OO) integrals -----
C
        CALL DDI_DISTRIB(D_OOOO,IWP,ILO,IHI,JLO,JHI)
        MAXWRK = JHI-JLO+1
C
        CALL DDI_PROCDLB_NEXT(C_OOOO,IWP,ICNTR1)
C
        DO WHILE(ICNTR1.LT.MAXWRK)
          IJ = JLO + ICNTR1
C
          DO II=1,NOCC
            DO JJ=1,II
              IJTMP = IA(II) + JJ
              IF(IJTMP.EQ.IJ) THEN
                I = II
                J = JJ
                GO TO 10
              ENDIF
            ENDDO
          ENDDO
C
   10     CALL DDI_GET(D_OOOO,1,NOTR,IJ,IJ,BUFF)
C
C          ----- Derivative core Fock matrices -----
C
          DO 50 M=1,NOCC
            DO 50 IC=1,NCOR
              MG = MAX(M,IC)
              ICG = MIN(M,IC)
              MIC = IA(MG) + ICG
              XIJKL = BUFF(MIC)
              IF(ABS(XIJKL).LT.TOL) GO TO 50
              AVAL = TWO*XIJKL
              CALL DAXPY(NXYZ,-AVAL,SDER(1,M,IC),1,DFC(1,IJ),1)
C
              AVAL = HALF*XIJKL
              IF(M.GT.I) GO TO 20
              IM = IA(I) + M
              CALL DAXPY(NXYZ,AVAL,SDER(1,J,IC),1,DFC(1,IM),1)
C
   20         IF((I.EQ.J).OR.(M.GT.J)) GO TO 30
              JM = IA(J) + M
              CALL DAXPY(NXYZ,AVAL,SDER(1,I,IC),1,DFC(1,JM),1)
C
   30         IF(J.GT.M) GO TO 40
              MJ = IA(M) + J
              CALL DAXPY(NXYZ,AVAL,SDER(1,I,IC),1,DFC(1,MJ),1)
C
   40         IF((I.EQ.J).OR.(I.GT.M)) GO TO 50
              MI = IA(M) + I
              CALL DAXPY(NXYZ,AVAL,SDER(1,J,IC),1,DFC(1,MI),1)
   50     CONTINUE
C
C          ----- Derivative two-electron integrals -----
C
          IF((I.LE.NCOR).OR.(J.LE.NCOR)) GO TO 100
          II = I-NCOR
          JJ = J-NCOR
          IIJJ = IA(II) + JJ
          DO 90 K=NCOR+1,NOCC
            DO 90 L=1,NOCC
              KG = MAX(K,L)
              LG = MIN(K,L)
              KL = IA(KG) + LG
              XIJKL = BUFF(KL)
              IF(ABS(XIJKL).LT.TOL) GO TO 90
              XIJKL = HALF*XIJKL
              DO 80 M=NCOR+1,NOCC
                IF(K.GT.M) GO TO 70
                MK = IA(M-NCOR) + K-NCOR
                IF(IIJJ.LE.MK) THEN
                  MKIJ = IA(MK) + IIJJ
                  CALL DAXPY(NXYZ,-XIJKL,SDER(1,M,L),1,DERI(1,MKIJ),1)
                ENDIF
C
                IF(MK.LE.IIJJ) THEN
                  IJMK = IA(IIJJ) + MK
                  CALL DAXPY(NXYZ,-XIJKL,SDER(1,M,L),1,DERI(1,IJMK),1)
                ENDIF
C
   70           IF(M.GT.K) GO TO 80
C
                KM = IA(K-NCOR) + M-NCOR
                IF(IIJJ.LE.KM) THEN
                  KMIJ = IA(KM) + IIJJ
                  CALL DAXPY(NXYZ,-XIJKL,SDER(1,M,L),1,DERI(1,KMIJ),1)
                ENDIF
C
                IF(KM.LE.IIJJ) THEN
                  IJKM = IA(IIJJ) + KM
                  CALL DAXPY(NXYZ,-XIJKL,SDER(1,M,L),1,DERI(1,IJKM),1)
                ENDIF
   80         CONTINUE
   90     CONTINUE
C
C          ----- Construct core Fock matrix -----
C
  100     DVAL = ZERO
          DO IC=1,NCOR
            ICIC = IA(IC) + IC
            DVAL = DVAL + BUFF(ICIC)
          ENDDO
          FCOR(IJ) = FCOR(IJ) + TWO*DVAL
C
          IF(J.GT.NCOR) GO TO 110
          DO K=1,I
            IK = IA(I) + K
            JG = MAX(J,K)
            KG = MIN(J,K)
            JK = IA(JG) + KG
            FCOR(IK) = FCOR(IK) - BUFF(JK)
          ENDDO
C
  110     IF((I.GT.NCOR) .OR. (I.EQ.J)) GO TO 120
          DO K=1,J
            JK = IA(J) + K
            IG = MAX(I,K)
            KG = MIN(I,K)
            IK = IA(IG) + KG
            FCOR(JK) = FCOR(JK) - BUFF(IK)
          ENDDO
C
C          ----- Construct two-electron integral array -----
C
  120     IF(J.LE.NCOR) GO TO 140
          JJ = J-NCOR
          DO 130 K=1,NACT
            DO 130 L=1,K
              KL = IA(K) + L
              KKLL = IA(K+NCOR) + L+NCOR
              ERI(I,JJ,KL) = BUFF(KKLL)
  130     CONTINUE
C
  140     IF((I.LE.NCOR) .OR. (I.EQ.J)) GO TO 155
          II = I-NCOR
          DO 150 K=1,NACT
            DO 150 L=1,K
              KL = IA(K) + L
              KKLL = IA(K+NCOR) + L+NCOR
              ERI(J,II,KL) = BUFF(KKLL)
  150     CONTINUE
C
C          ----- Construct A matrix -----
C
  155     IF(J.GT.NCOR) GO TO 160
          DO K=1,NACT
            KK = K + NCOR
            DO 157 L=1,K
              LL = L + NCOR
              KL = IA(K) + L
              KKLL = IA(KK) + LL
              DVAL = FOUR*BUFF(KKLL)
              AMAT(I,J,KL) = AMAT(I,J,KL) + DVAL
              IF((I.EQ.J) .OR. (I.GT.NCOR)) GO TO 157
              AMAT(J,I,KL) = AMAT(J,I,KL) + DVAL
  157       CONTINUE
          ENDDO
C
  160     IF(J.LE.NCOR) GO TO 165
          JJ = J - NCOR
          DO 163 K=1,NCOR
            DO L=1,NACT
              LL = L +  NCOR
              KL = IA(LL) + K
              JG = MAX(JJ,L)
              LG = MIN(JJ,L)
              JL = IA(JG) + LG
              IF(JJ.GE.L) AMAT(I,K,JL) = AMAT(I,K,JL) - BUFF(KL)
              IF(L.GE.JJ) AMAT(I,K,JL) = AMAT(I,K,JL) - BUFF(KL)
            ENDDO
  163     CONTINUE
C
  165     IF((I.LE.NCOR) .OR. (I.EQ.J)) GO TO 169
          II = I - NCOR
          DO 167 K=1,NCOR
            DO L=1,NACT
              LL = L + NCOR
              KL = IA(LL) + K
              IG = MAX(II,L)
              LG = MIN(II,L)
              IL = IA(IG) + LG
              IF(II.GE.L) AMAT(J,K,IL) = AMAT(J,K,IL) - BUFF(KL)
              IF(L.GE.II) AMAT(J,K,IL) = AMAT(J,K,IL) - BUFF(KL)
            ENDDO
  167     CONTINUE
C
C          ----- Coulomb contribution to derivative Lagrangian -----
C          -----   Lder(i,m) where m is a core orbital index   -----
C
  169     CONTINUE
          DO 200 M=1,NCOR
C
            DVAL = ZERO
            DO K=1,NCOR
              KK = IA(K) + K
              DVAL = DVAL + BUFF(KK)
            ENDDO
            DVAL = TWO*DVAL
            DO 170 K=1,NACT
              DO 170 L=1,K
                KL = IA(K) + L
                DTMP = OPDM(KL)
                IF(K.NE.L) DTMP = TWO*DTMP
                KL = IA(K+NCOR) + L+NCOR
                DVAL = DVAL + DTMP*BUFF(KL)
  170       CONTINUE
            CALL DAXPY(NXYZ,-DVAL,SDER(1,I,M),1,DLAG(1,J,M),1)
            IF(I.NE.J)
     *        CALL DAXPY(NXYZ,-DVAL,SDER(1,J,M),1,DLAG(1,I,M),1)
C
            DO 180 K=1,NCOR
              MG = MAX(M,K)
              KG = MIN(M,K)
              MK = IA(MG) + KG
              DVAL = BUFF(MK)
              IF(ABS(DVAL).LT.TOL) GO TO 180
              CALL DAXPY(NXYZ,DVAL,SDER(1,I,K),1,DLAG(1,J,M),1)
              IF(I.NE.J)
     *          CALL DAXPY(NXYZ,DVAL,SDER(1,J,K),1,DLAG(1,I,M),1)
  180       CONTINUE
C
            DO 190 K=1,NACT
              KK = K + NCOR
              DVAL = ZERO
              DO L=1,NACT
                KG = MAX(K,L)
                LG = MIN(K,L)
                KL = IA(KG) + LG
                DTMP = OPDM(KL)
                ML = IA(L+NCOR) + M
                DVAL = DVAL + DTMP*BUFF(ML)
              ENDDO
              DVAL = HALF*DVAL
              CALL DAXPY(NXYZ,DVAL,SDER(1,I,KK),1,DLAG(1,J,M),1)
              IF(I.NE.J)
     *          CALL DAXPY(NXYZ,DVAL,SDER(1,J,KK),1,DLAG(1,I,M),1)
  190       CONTINUE
  200     CONTINUE
C
C          ----- Coulomb contribution to derivative Lagrangian -----
C          ----- Lder(i,m) where m is an active orbital index  -----
C
          DO 300 M=1,NACT
            MM = M + NCOR
C
            DO 220 N=1,NCOR
              DVAL = ZERO
              DO K=1,NACT
                MG = MAX(M,K)
                KG = MIN(M,K)
                MK = IA(MG) + KG
                DTMP = OPDM(MK)
                KN = IA(K+NCOR) + N
                DVAL = DVAL + DTMP*BUFF(KN)
              ENDDO
              DVAL = HALF*DVAL
              CALL DAXPY(NXYZ,DVAL,SDER(1,I,N),1,DLAG(1,J,MM),1)
              IF(I.NE.J)
     *          CALL DAXPY(NXYZ,DVAL,SDER(1,J,N),1,DLAG(1,I,MM),1)
  220       CONTINUE
C
            DO 260 N=1,NACT
              DVAL = ZERO
              NG = MAX(N,M)
              MG = MIN(N,M)
              NM = IA(NG) + MG
              DO K=1,NCOR
                KK = IA(K) + K
                DVAL = DVAL + BUFF(KK)
              ENDDO
              DVAL = OPDM(NM)*DVAL
              DVAL = TWO*DVAL
C
              DO 240 K=1,NACT
                DO 240 L=1,K
                  KL = IA(K+NCOR) + L+NCOR
                  DTMP = BUFF(KL)
                  IF(K.NE.L) DTMP = TWO*DTMP
                  KL = IA(K) + L
                  NMG = MAX(NM,KL)
                  KLG = MIN(NM,KL)
                  NMKL = IA(NMG) + KLG
                  DVAL = DVAL + DTMP*TPDM(NMKL)
  240         CONTINUE
              DVAL = HALF*DVAL
              CALL DAXPY(NXYZ,-DVAL,SDER(1,I,N+NCOR),1,DLAG(1,J,MM),1)
              IF(I.NE.J)
     *          CALL DAXPY(NXYZ,-DVAL,SDER(1,J,N+NCOR),1,DLAG(1,I,MM),1)
  260       CONTINUE
  300     CONTINUE
C
C          ----- Exchange contribution to derivative Lagrangian -----
C
          DO 400 M=1,NOCC
            IF(J.GT.NCOR) GO TO 350
            IJVAL = .TRUE.
            IF((I.EQ.J) .OR. (I.GT.NCOR)) IJVAL = .FALSE.
            DO 330 N=1,NCOR
              MG = MAX(M,J)
              JG = MIN(M,J)
              MJ = IA(MG) + JG
              XIJKL = BUFF(MJ)
              CALL DAXPY(NXYZ,XIJKL,SDER(1,I,N),1,DLAG(1,M,N),1)
              IF(IJVAL) THEN
                MG = MAX(M,I)
                IG = MIN(M,I)
                MI = IA(MG) + IG
                XIJKL = BUFF(MI)
                CALL DAXPY(NXYZ,XIJKL,SDER(1,J,N),1,DLAG(1,M,N),1)
              ENDIF
C
              MG = MAX(M,N)
              NG = MIN(M,N)
              MN = IA(MG) + NG
              XIJKL = BUFF(MN)
              DVAL = FOUR*XIJKL
              CALL DAXPY(NXYZ,-DVAL,SDER(1,I,J),1,DLAG(1,M,N),1)
              IF(IJVAL) CALL DAXPY(NXYZ,-DVAL,SDER(1,J,I),1,
     *                             DLAG(1,M,N),1)
C
              IF(N.EQ.J) THEN
                DO K=1,NCOR
                  MG = MAX(M,K)
                  KG = MIN(M,K)
                  MK = IA(MG) + KG
                  XIJKL = BUFF(MK)
                  CALL DAXPY(NXYZ,XIJKL,SDER(1,I,K),1,DLAG(1,M,N),1)
                ENDDO
C
                DO 310 K=1,NACT
                  DO 310 L=1,NACT
                    KG = MAX(K,L)
                    LG = MIN(K,L)
                    KL = IA(KG) + LG
                    MG = MAX(M,L+NCOR)
                    LG = MIN(M,L+NCOR)
                    ML = IA(MG) + LG
                    DVAL = OPDM(KL)*BUFF(ML)
                    DVAL = HALF*DVAL
                    CALL DAXPY(NXYZ,DVAL,SDER(1,I,K+NCOR),1,
     *                         DLAG(1,M,N),1)
  310           CONTINUE
              ENDIF
C
              IF((N.EQ.I) .AND. (I.NE.J)) THEN
                DO K=1,NCOR
                  MG = MAX(M,K)
                  KG = MIN(M,K)
                  MK = IA(MG) + KG
                  XIJKL = BUFF(MK)
                  CALL DAXPY(NXYZ,XIJKL,SDER(1,J,K),1,DLAG(1,M,N),1)
                ENDDO
C
                DO 320 K=1,NACT
                  DO 320 L=1,NACT
                    KG = MAX(K,L)
                    LG = MIN(K,L)
                    KL = IA(KG) + LG
                    MG = MAX(M,L+NCOR)
                    LG = MIN(M,L+NCOR)
                    ML = IA(MG) + LG
                    DVAL = OPDM(KL)*BUFF(ML)
                    DVAL = HALF*DVAL
                    CALL DAXPY(NXYZ,DVAL,SDER(1,J,K+NCOR),1,
     *                         DLAG(1,M,N),1)
  320           CONTINUE
              ENDIF
  330       CONTINUE
C
            MG = MAX(M,J)
            JG = MIN(M,J)
            MJ = IA(MG) + JG
            IF(IJVAL) THEN
              MG = MAX(M,I)
              IG = MIN(M,I)
              MI = IA(MG) + IG
            ENDIF
            DO 340 N=1,NACT
              DO K=1,NACT
                NG = MAX(N,K)
                KG = MIN(N,K)
                NK = IA(NG) + KG
                MG = MAX(M,K+NCOR)
                KG = MIN(M,K+NCOR)
                MK = IA(MG) + KG
                DVAL = OPDM(NK)*BUFF(MK)
                DVAL = TWO*DVAL
                CALL DAXPY(NXYZ,-DVAL,SDER(1,I,J),1,DLAG(1,M,N+NCOR),1)
                IF(IJVAL) CALL DAXPY(NXYZ,-DVAL,SDER(1,J,I),1,
     *                               DLAG(1,M,N+NCOR),1)
C
                DVAL = OPDM(NK)*BUFF(MJ)
                DVAL = HALF*DVAL
                CALL DAXPY(NXYZ,DVAL,SDER(1,I,K+NCOR),1,
     *                     DLAG(1,M,N+NCOR),1)
                IF(IJVAL) THEN
                  DVAL = OPDM(NK)*BUFF(MI)
                  DVAL = HALF*DVAL
                  CALL DAXPY(NXYZ,DVAL,SDER(1,J,K+NCOR),1,
     *                       DLAG(1,M,N+NCOR),1)
                ENDIF
              ENDDO
  340       CONTINUE
C
  350       IF(I.LE.NCOR) GO TO 400
            IJVAL = .TRUE.
            IF((I.EQ.J) .OR. (J.LE.NCOR)) IJVAL = .FALSE.
            DO 360 N=1,NCOR
              MG = MAX(M,N)
              NG = MIN(M,N)
              MN = IA(MG) + NG
              DO K=1,NACT
                KG = MAX(K,I-NCOR)
                IG = MIN(K,I-NCOR)
                KI = IA(KG) + IG
                DVAL = OPDM(KI)*BUFF(MN)
                DVAL = TWO*DVAL
                CALL DAXPY(NXYZ,-DVAL,SDER(1,J,K+NCOR),1,DLAG(1,M,N),1)
                IF(IJVAL) THEN
                  KG = MAX(K,J-NCOR)
                  JG = MIN(K,J-NCOR)
                  KJ = IA(KG) + JG
                  DVAL = OPDM(KJ)*BUFF(MN)
                  DVAL = TWO*DVAL
                  CALL DAXPY(NXYZ,-DVAL,SDER(1,I,K+NCOR),1,
     *                       DLAG(1,M,N),1)
                ENDIF
C
                MG = MAX(M,K+NCOR)
                KG = MIN(M,K+NCOR)
                MK = IA(MG) + KG
                DVAL = OPDM(KI)*BUFF(MK)
                DVAL = HALF*DVAL
                CALL DAXPY(NXYZ,DVAL,SDER(1,J,N),1,DLAG(1,M,N),1)
                IF(IJVAL) THEN
                  DVAL = OPDM(KJ)*BUFF(MK)
                  DVAL = HALF*DVAL
                  CALL DAXPY(NXYZ,DVAL,SDER(1,I,N),1,DLAG(1,M,N),1)
                ENDIF
              ENDDO
  360       CONTINUE
C
            DO 390 N=1,NACT
              IG = MAX(I-NCOR,N)
              NG = MIN(I-NCOR,N)
              IN = IA(IG) + NG
              IF(IJVAL) THEN
                JG = MAX(J-NCOR,N)
                NG = MIN(J-NCOR,N)
                JN = IA(JG) + NG
              ENDIF
              DO K=1,NCOR
                MG = MAX(M,K)
                KG = MIN(M,K)
                MK = IA(MG) + KG
                DVAL = OPDM(IN)*BUFF(MK)
                DVAL = HALF*DVAL
                CALL DAXPY(NXYZ,DVAL,SDER(1,J,K),1,DLAG(1,M,N+NCOR),1)
                IF(IJVAL) THEN
                  DVAL = OPDM(JN)*BUFF(MK)
                  DVAL = HALF*DVAL
                  CALL DAXPY(NXYZ,DVAL,SDER(1,I,K),1,DLAG(1,M,N+NCOR),1)
                ENDIF
              ENDDO
C
              DO 370 K=1,NACT
                KG = MAX(K,I-NCOR)
                IG = MIN(K,I-NCOR)
                KI = IA(KG) + IG
                IF(IJVAL) THEN
                  KG = MAX(K,J-NCOR)
                  JG = MIN(K,J-NCOR)
                  KJ = IA(KG) + JG
                ENDIF
                DO 370 L=1,NACT
                  MG = MAX(M,L+NCOR)
                  LG = MIN(M,L+NCOR)
                  ML = IA(MG) + LG
                  NG = MAX(N,L)
                  LG = MIN(N,L)
                  NL = IA(NG) + LG
                  KIG = MAX(KI,NL)
                  NLG = MIN(KI,NL)
                  KINL = IA(KIG) + NLG
                  DVAL = TPDM(KINL)*BUFF(ML)
                  CALL DAXPY(NXYZ,-DVAL,SDER(1,J,K+NCOR),1,
     *                       DLAG(1,M,N+NCOR),1)
                  IF(IJVAL) THEN
                    KJG = MAX(KJ,NL)
                    NLG = MIN(KJ,NL)
                    KJNL = IA(KJG) + NLG
                    DVAL = TPDM(KJNL)*BUFF(ML)
                    CALL DAXPY(NXYZ,-DVAL,SDER(1,I,K+NCOR),1,
     *                         DLAG(1,M,N+NCOR),1)
                  ENDIF
  370         CONTINUE
  390       CONTINUE
  400     CONTINUE
C
C          ----- Coulomb contribution to preconditioner -----
C          -----      Inner indicies are both core      -----
C
           DO 440 N=1,NCOR
             JNG = IABS(INDEX(J,N))
             IF(JNG.EQ.0) GO TO 440
             DO 430 M=1,NCOR
               IMG = IABS(INDEX(I,M))
               IF(IMG.NE.JNG) GO TO 430
               MG = MAX(M,N)
               NG = MIN(M,N)
               MN = IA(MG) + NG
C
               DVAL = ZERO
               IF(M.EQ.N) THEN
                 DO K=1,NCOR
                   KK = IA(K) + K
                   DVAL = DVAL + BUFF(KK)
                 ENDDO
                 DVAL = TWO*DVAL
C
                 DO 420 K=1,NACT
                   DO 420 L=1,K
                     KL = IA(K+NCOR) + L+NCOR
                     XIJKL = BUFF(KL)
                     IF(K.NE.L) XIJKL = TWO*XIJKL
                     KL = IA(K) + L
                     DVAL = DVAL + OPDM(KL)*XIJKL
  420            CONTINUE
               ENDIF
C
               DVAL = DVAL - BUFF(MN)
               DVAL = TWO*DVAL
               IF(N.GT.J) DVAL = -DVAL
               IF(M.GT.I) DVAL = -DVAL
               PRCNDO(IMG) = PRCNDO(IMG) + DVAL
  430        CONTINUE
  440      CONTINUE
           IF(I.EQ.J) GO TO 480
C
           DO 470 N=1,NCOR
             ING = IABS(INDEX(I,N))
             IF(ING.EQ.0) GO TO 470
             DO 460 M=1,NCOR
               JMG = IABS(INDEX(J,M))
               IF(JMG.NE.ING) GO TO 460
               MG = MAX(M,N)
               NG = MIN(M,N)
               MN = IA(MG) + NG
C
               DVAL = ZERO
               IF(M.EQ.N) THEN
                 DO K=1,NCOR
                   KK = IA(K) + K
                   DVAL = DVAL + BUFF(KK)
                 ENDDO
                 DVAL = TWO*DVAL
C
                 DO 450 K=1,NACT
                   DO 450 L=1,K
                     KL = IA(K+NCOR) + L+NCOR
                     XIJKL = BUFF(KL)
                     IF(K.NE.L) XIJKL = TWO*XIJKL
                     KL = IA(K) + L
                     DVAL = DVAL + OPDM(KL)*XIJKL
  450            CONTINUE
               ENDIF
C
               DVAL = DVAL - BUFF(MN)
               DVAL = TWO*DVAL
               IF(N.GT.I) DVAL = -DVAL
               IF(M.GT.J) DVAL = -DVAL
               PRCNDO(JMG) = PRCNDO(JMG) + DVAL
  460        CONTINUE
  470      CONTINUE
C
C          ----- Coulomb contribution to preconditioner -----
C          -----    One core index, one active index    -----
C
  480      CONTINUE
           DO 540 N=1,NCOR
             JNG = IABS(INDEX(J,N))
             IF(JNG.EQ.0) GO TO 510
             DO 500 M=1,NACT
               IMG = IABS(INDEX(I,M+NCOR))
               IF(IMG.NE.JNG) GO TO 500
               DO K=1,NACT
                 KN = IA(K+NCOR) + N
                 XIJKL = BUFF(KN)
                 KG = MAX(K,M)
                 MG = MIN(K,M)
                 KM = IA(KG) + MG
                 IF(N.GT.J) XIJKL = -XIJKL
                 IF((M+NCOR).GT.I) XIJKL = -XIJKL
                 IF(I.NE.J) XIJKL = TWO*XIJKL
                 PRCNDO(IMG) = PRCNDO(IMG) - OPDM(KM)*XIJKL
               ENDDO
  500        CONTINUE
C
  510        ING = IABS(INDEX(I,N))
             IF(ING.EQ.0) GO TO 540
             DO 520 M=1,NACT
               JMG = IABS(INDEX(J,M+NCOR))
               IF(JMG.NE.ING) GO TO 520
               DO K=1,NACT
                 KN = IA(K+NCOR) + N
                 XIJKL = BUFF(KN)
                 KG = MAX(K,M)
                 MG = MIN(K,M)
                 KM = IA(KG) + MG
                 IF(N.GT.I) XIJKL = -XIJKL
                 IF((M+NCOR).GT.J) XIJKL = -XIJKL
                 IF(I.NE.J) XIJKL = TWO*XIJKL
                 PRCNDO(JMG) = PRCNDO(JMG) - OPDM(KM)*XIJKL
               ENDDO
  520        CONTINUE
  540      CONTINUE
C
C          ----- Coulomb contribution to preconditioner -----
C          -----     Inner indicies are both active     -----
C
           DO 580 N=1,NACT
             JNG = IABS(INDEX(J,N+NCOR))
             IF(JNG.EQ.0) GO TO 580
             DO 570 M=1,NACT
               IMG = IABS(INDEX(I,M+NCOR))
               IF(IMG.NE.JNG) GO TO 570
               MG = MAX(M,N)
               NG = MIN(M,N)
               MN = IA(MG) + NG
C
               DVAL = ZERO
               DO K=1,NCOR
                 KK = IA(K) + K
                 DVAL = DVAL + BUFF(KK)
               ENDDO
               DVAL = TWO*DVAL
               DVAL = OPDM(MN)*DVAL
C
               DO 560 K=1,NACT
                 DO 560 L=1,K
                   KL = IA(K+NCOR) + L+NCOR
                   XIJKL = BUFF(KL)
                   IF(ABS(XIJKL).LT.TOL) GO TO 560
                   IF(K.NE.L) XIJKL = TWO*XIJKL
                   KL = IA(K) + L
                   MNG = MAX(MN,KL)
                   KLG = MIN(MN,KL)
                   MNKL = IA(MNG) + KLG
                   DVAL = DVAL + TPDM(MNKL)*XIJKL
  560          CONTINUE
C
               IF((N+NCOR).GT.J) DVAL = -DVAL
               IF((M+NCOR).GT.I) DVAL = -DVAL
               PRCNDO(IMG) = PRCNDO(IMG) + DVAL
  570        CONTINUE
  580      CONTINUE
           IF(I.EQ.J) GO TO 650
C
           DO 640 N=1,NACT
             ING = IABS(INDEX(I,N+NCOR))
             IF(ING.EQ.0) GO TO 640
             DO 630 M=1,NACT
               JMG = IABS(INDEX(J,M+NCOR))
               IF(JMG.NE.ING) GO TO 630
               MG = MAX(M,N)
               NG = MIN(M,N)
               MN = IA(MG) + NG
C
               DVAL = ZERO
               DO K=1,NCOR
                 KK = IA(K) + K
                 DVAL = DVAL + BUFF(KK)
               ENDDO
               DVAL = TWO*DVAL
               DVAL = OPDM(MN)*DVAL
C
               DO 620 K=1,NACT
                 DO 620 L=1,K
                   KL = IA(K+NCOR) + L+NCOR
                   XIJKL = BUFF(KL)
                   IF(ABS(XIJKL).LT.TOL) GO TO 620
                   IF(K.NE.L) XIJKL = TWO*XIJKL
                   KL = IA(K) + L
                   MNG = MAX(MN,KL)
                   KLG = MIN(MN,KL)
                   MNKL = IA(MNG) + KLG
                   DVAL = DVAL + TPDM(MNKL)*XIJKL
  620          CONTINUE
C
               IF((N+NCOR).GT.I) DVAL = -DVAL
               IF((M+NCOR).GT.J) DVAL = -DVAL
               PRCNDO(JMG) = PRCNDO(JMG) + DVAL
  630        CONTINUE
  640      CONTINUE
C
C          ----- Exchange contribution to preconditioner -----
C          -----           Second index is core          -----
C
  650     IF(J.GT.NCOR) GO TO 850
          DO 740 K=1,NOCC
            DO 690 L=1,NCOR
              KG = MAX(K,L)
              LG = MIN(K,L)
              KL = IA(KG) + LG
              XIJKL = BUFF(KL)
              IF(ABS(XIJKL).LT.TOL) GO TO 690
C
              IMG = IABS(INDEX(I,J))
              KNG = IABS(INDEX(K,L))
              IF((IMG.EQ.KNG) .AND. (IMG.NE.0)) THEN
                DVAL = TWO*XIJKL
                IF(J.GT.I) DVAL = -DVAL
                IF(L.GT.K) DVAL = -DVAL
                PRCNDO(IMG) = PRCNDO(IMG) + FOUR*DVAL
              ENDIF
C
              IMG = IABS(INDEX(I,L))
              KNG = IABS(INDEX(K,J))
              IF((IMG.EQ.KNG) .AND. (IMG.NE.0)) THEN
                DVAL = TWO*XIJKL
                IF(L.GT.I) DVAL = -DVAL
                IF(J.GT.K) DVAL = -DVAL
                PRCNDO(IMG) = PRCNDO(IMG) - DVAL
              ENDIF
C
              IF(J.EQ.L) THEN
                DO 660 M=1,NCOR
                  IMG = IABS(INDEX(I,M))
                  KMG = IABS(INDEX(K,M))
                  IF((IMG.NE.KMG) .OR. (IMG.EQ.0)) GO TO 660
                  DVAL = TWO*XIJKL
                  IF(M.GT.I) DVAL = -DVAL
                  IF(M.GT.K) DVAL = -DVAL
                  PRCNDO(IMG) = PRCNDO(IMG) - DVAL
  660           CONTINUE
C
                DO 680 M=1,NACT
                  IMG = IABS(INDEX(I,M+NCOR))
                  IF(IMG.EQ.0) GO TO 680
                  DO 670 N=1,NACT
                    KNG = IABS(INDEX(K,N+NCOR))
                    IF(IMG.NE.KNG) GO TO 670
                    MG = MAX(M,N)
                    NG = MIN(M,N)
                    MN = IA(MG) + NG
                    DVAL = OPDM(MN)*XIJKL
                    IF((M+NCOR).GT.I) DVAL = -DVAL
                    IF((N+NCOR).GT.K) DVAL = -DVAL
                    PRCNDO(IMG) = PRCNDO(IMG) - DVAL
  670             CONTINUE
  680           CONTINUE
              ENDIF
  690       CONTINUE
C
            DO 730 L=1,NACT
              KG = MAX(K,L+NCOR)
              LG = MIN(K,L+NCOR)
              KL = IA(KG) + LG
              XIJKL = BUFF(KL)
              IF(ABS(XIJKL).LT.TOL) GO TO 730
C
              IMG = IABS(INDEX(I,J))
              IF(IMG.NE.0) THEN
                DO 710 N=1,NACT
                  KNG = IABS(INDEX(K,N+NCOR))
                  IF(IMG.NE.KNG) GO TO 710
                  LG = MAX(L,N)
                  NG = MIN(L,N)
                  LN = IA(LG) + NG
                  DVAL = OPDM(LN)*XIJKL
                  IF(J.GT.I) DVAL = -DVAL
                  IF((N+NCOR).GT.K) DVAL = -DVAL
                  PRCNDO(IMG) = PRCNDO(IMG) + FOUR*DVAL
  710           CONTINUE
              ENDIF
C
              KNG = IABS(INDEX(K,J))
              IF(KNG.NE.0) THEN
                DO 720 M=1,NACT
                  IMG = IABS(INDEX(I,M+NCOR))
                  IF(IMG.NE.KNG) GO TO 720
                  LG = MAX(L,M)
                  MG = MIN(L,M)
                  LM = IA(LG) + MG
                  DVAL = OPDM(LM)*XIJKL
                  IF(J.GT.K) DVAL = -DVAL
                  IF((M+NCOR).GT.I) DVAL = -DVAL
                  PRCNDO(IMG) = PRCNDO(IMG) - DVAL
  720           CONTINUE
              ENDIF
  730       CONTINUE
  740     CONTINUE
C
          IF((I.EQ.J) .OR. (I.GT.NCOR)) GO TO 850
          DO 840 K=1,NOCC
            DO 790 L=1,NCOR
              KG = MAX(K,L)
              LG = MIN(K,L)
              KL = IA(KG) + LG
              XIJKL = BUFF(KL)
              IF(ABS(XIJKL).LT.TOL) GO TO 790
C
              JMG = IABS(INDEX(J,I))
              KNG = IABS(INDEX(K,L))
              IF((JMG.EQ.KNG) .AND. (JMG.NE.0)) THEN
                DVAL = TWO*XIJKL
                IF(I.GT.J) DVAL = -DVAL
                IF(L.GT.K) DVAL = -DVAL
                PRCNDO(JMG) = PRCNDO(JMG) + FOUR*DVAL
              ENDIF
C
              JMG = IABS(INDEX(J,L))
              KNG = IABS(INDEX(K,I))
              IF((JMG.EQ.KNG) .AND. (JMG.NE.0)) THEN
                DVAL = TWO*XIJKL
                IF(L.GT.J) DVAL = -DVAL
                IF(I.GT.K) DVAL = -DVAL
                PRCNDO(JMG) = PRCNDO(JMG) - DVAL
              ENDIF
C
              IF(I.EQ.L) THEN
                DO 760 M=1,NCOR
                  JMG = IABS(INDEX(J,M))
                  KMG = IABS(INDEX(K,M))
                  IF((JMG.NE.KMG) .OR. (JMG.EQ.0)) GO TO 760
                  DVAL = TWO*XIJKL
                  IF(M.GT.J) DVAL = -DVAL
                  IF(M.GT.K) DVAL = -DVAL
                  PRCNDO(JMG) = PRCNDO(JMG) - DVAL
  760           CONTINUE
C
                DO 780 M=1,NACT
                  JMG = IABS(INDEX(J,M+NCOR))
                  IF(JMG.EQ.0) GO TO 780
                  DO 770 N=1,NACT
                    KNG = IABS(INDEX(K,N+NCOR))
                    IF(JMG.NE.KNG) GO TO 770
                    MG = MAX(M,N)
                    NG = MIN(M,N)
                    MN = IA(MG) + NG
                    DVAL = OPDM(MN)*XIJKL
                    IF((M+NCOR).GT.J) DVAL = -DVAL
                    IF((N+NCOR).GT.K) DVAL = -DVAL
                    PRCNDO(JMG) = PRCNDO(JMG) - DVAL
  770             CONTINUE
  780           CONTINUE
              ENDIF
  790       CONTINUE
C
            DO 830 L=1,NACT
              KG = MAX(K,L+NCOR)
              LG = MIN(K,L+NCOR)
              KL = IA(KG) + LG
              XIJKL = BUFF(KL)
              IF(ABS(XIJKL).LT.TOL) GO TO 830
C
              JMG = IABS(INDEX(J,I))
              IF(JMG.NE.0) THEN
                DO 810 N=1,NACT
                  KNG = IABS(INDEX(K,N+NCOR))
                  IF(JMG.NE.KNG) GO TO 810
                  LG = MAX(L,N)
                  NG = MIN(L,N)
                  LN = IA(LG) + NG
                  DVAL = OPDM(LN)*XIJKL
                  IF(I.GT.J) DVAL = -DVAL
                  IF((N+NCOR).GT.K) DVAL = -DVAL
                  PRCNDO(JMG) = PRCNDO(JMG) + FOUR*DVAL
  810           CONTINUE
              ENDIF
C
              KNG = IABS(INDEX(K,I))
              IF(KNG.NE.0) THEN
                DO 820 M=1,NACT
                  JMG = IABS(INDEX(J,M+NCOR))
                  IF(JMG.NE.KNG) GO TO 820
                  LG = MAX(L,M)
                  MG = MIN(L,M)
                  LM = IA(LG) + MG
                  DVAL = OPDM(LM)*XIJKL
                  IF(I.GT.K) DVAL = -DVAL
                  IF((M+NCOR).GT.J) DVAL = -DVAL
                  PRCNDO(JMG) = PRCNDO(JMG) - DVAL
  820           CONTINUE
              ENDIF
  830       CONTINUE
  840     CONTINUE
C
C          ----- Exchange contribution to preconditioner -----
C          -----         Second index is valence         -----
C
  850     IF(I.LE.NCOR) GO TO 1000
          DO 990 K=1,NOCC
            DO 910 L=1,NCOR
              KG = MAX(K,L)
              LG = MIN(K,L)
              KL = IA(KG) + LG
              XIJKL = BUFF(KL)
              IF(ABS(XIJKL).LT.TOL) GO TO 910
C
              IF(J.LE.NCOR) GO TO 880
              IMG = IABS(INDEX(I,L))
              IF(IMG.NE.0) THEN
                DO 860 N=1,NACT
                  KNG = IABS(INDEX(K,N+NCOR))
                  IF(IMG.NE.KNG) GO TO 860
                  NG = MAX(N,J-NCOR)
                  JG = MIN(N,J-NCOR)
                  NJ = IA(NG) + JG
                  DVAL = OPDM(NJ)*XIJKL
                  IF(L.GT.I) DVAL = -DVAL
                  IF((N+NCOR).GT.K) DVAL = -DVAL
                  PRCNDO(IMG) = PRCNDO(IMG) - DVAL
  860           CONTINUE
              ENDIF
C
              KNG = IABS(INDEX(K,L))
              IF(KNG.NE.0) THEN
                DO 870 M=1,NACT
                  IMG = IABS(INDEX(I,M+NCOR))
                  IF(IMG.NE.KNG) GO TO 870
                  MG = MAX(M,J-NCOR)
                  JG = MIN(M,J-NCOR)
                  MJ = IA(MG) + JG
                  DVAL = OPDM(MJ)*XIJKL
                  IF(L.GT.K) DVAL = -DVAL
                  IF((M+NCOR).GT.I) DVAL = -DVAL
                  PRCNDO(IMG) = PRCNDO(IMG) + FOUR*DVAL
  870           CONTINUE
              ENDIF
C
  880         IF(I.EQ.J) GO TO 910
              JMG = IABS(INDEX(J,L))
              IF(JMG.NE.0) THEN
                DO 890 N=1,NACT
                  KNG = IABS(INDEX(K,N+NCOR))
                  IF(JMG.NE.KNG) GO TO 890
                  NG = MAX(N,I-NCOR)
                  IG = MIN(N,I-NCOR)
                  NI = IA(NG) + IG
                  DVAL = OPDM(NI)*XIJKL
                  IF(L.GT.J) DVAL = -DVAL
                  IF((N+NCOR).GT.K) DVAL = -DVAL
                  PRCNDO(JMG) = PRCNDO(JMG) - DVAL
  890           CONTINUE
              ENDIF
C
              KNG = IABS(INDEX(K,L))
              IF(KNG.NE.0) THEN
                DO 900 M=1,NACT
                  JMG = IABS(INDEX(J,M+NCOR))
                  IF(JMG.NE.KNG) GO TO 900
                  MG = MAX(M,I-NCOR)
                  IG = MIN(M,I-NCOR)
                  MI = IA(MG) + IG
                  DVAL = OPDM(MI)*XIJKL
                  IF(L.GT.K) DVAL = -DVAL
                  IF((M+NCOR).GT.J) DVAL = -DVAL
                  PRCNDO(JMG) = PRCNDO(JMG) + FOUR*DVAL
  900           CONTINUE
              ENDIF
  910       CONTINUE
C
            DO 980 L=1,NACT
              KG = MAX(K,L+NCOR)
              LG = MIN(K,L+NCOR)
              KL = IA(KG) + LG
              XIJKL = BUFF(KL)
              IF(ABS(XIJKL).LT.TOL) GO TO 980
C
              IF(J.LE.NCOR) GO TO 945
              JG = MAX(J-NCOR,L)
              LG = MIN(J-NCOR,L)
              JL = IA(JG) + LG
              DO 920 M=1,NCOR
                IMG = IABS(INDEX(I,M))
                KMG = IABS(INDEX(K,M))
                IF((KMG.NE.IMG) .OR. (IMG.EQ.0)) GO TO 920
                DVAL = OPDM(JL)*XIJKL
                IF(M.GT.I) DVAL = -DVAL
                IF(M.GT.K) DVAL = -DVAL
                PRCNDO(IMG) = PRCNDO(IMG) - DVAL
  920         CONTINUE
C
              DO 940 M=1,NACT
                IMG = IABS(INDEX(I,M+NCOR))
                IF(IMG.EQ.0) GO TO 940
                MG = MAX(M,J-NCOR)
                JG = MIN(M,J-NCOR)
                MJ = IA(MG) + JG
                DO 930 N=1,NACT
                  KNG = IABS(INDEX(K,N+NCOR))
                  IF(IMG.NE.KNG) GO TO 930
                  NG = MAX(N,L)
                  LG = MIN(N,L)
                  NL = IA(NG) + LG
                  MJG = MAX(MJ,NL)
                  NLG = MIN(MJ,NL)
                  MJNL = IA(MJG) + NLG
                  DVAL = TPDM(MJNL)*XIJKL
                  IF((M+NCOR).GT.I) DVAL = -DVAL
                  IF((N+NCOR).GT.K) DVAL = -DVAL
                  PRCNDO(IMG) = PRCNDO(IMG) + TWO*DVAL
  930           CONTINUE
  940         CONTINUE
C
  945         IF(I.EQ.J) GO TO 980
              IG = MAX(I-NCOR,L)
              LG = MIN(I-NCOR,L)
              IL = IA(IG) + LG
              DO 950 M=1,NCOR
                JMG = IABS(INDEX(J,M))
                KMG = IABS(INDEX(K,M))
                IF((KMG.NE.JMG) .OR. (JMG.EQ.0)) GO TO 950
                DVAL = OPDM(IL)*XIJKL
                IF(M.GT.J) DVAL = -DVAL
                IF(M.GT.K) DVAL = -DVAL
                PRCNDO(JMG) = PRCNDO(JMG) - DVAL
  950         CONTINUE
C
              DO 970 M=1,NACT
                JMG = IABS(INDEX(J,M+NCOR))
                IF(JMG.EQ.0) GO TO 970
                MG = MAX(M,I-NCOR)
                IG = MIN(M,I-NCOR)
                MI = IA(MG) + IG
                DO 960 N=1,NACT
                  KNG = IABS(INDEX(K,N+NCOR))
                  IF(JMG.NE.KNG) GO TO 960
                  NG = MAX(N,L)
                  LG = MIN(N,L)
                  NL = IA(NG) + LG
                  MIG = MAX(MI,NL)
                  NLG = MIN(MI,NL)
                  MINL = IA(MIG) + NLG
                  DVAL = TPDM(MINL)*XIJKL
                  IF((M+NCOR).GT.J) DVAL = -DVAL
                  IF((N+NCOR).GT.K) DVAL = -DVAL
                  PRCNDO(JMG) = PRCNDO(JMG) + TWO*DVAL
  960           CONTINUE
  970         CONTINUE
  980       CONTINUE
  990     CONTINUE
C
C          ----- Finished with current integral buffer -----
C
 1000     CALL DDI_PROCDLB_NEXT(C_OOOO,IWP,ICNTR1)
C
        ENDDO
        CALL TSECND(T1)
        IF(IWP.EQ.ME  .AND.  MASWRK) WRITE(IW,9000) T1-T0
        CALL FLSHBF(IW)
        T0 = T1
C
C     ----- Get and use (VO|OO) integrals -----
C
        CALL DDI_DISTRIB(D_VOOO,IWP,ILO,IHI,JLO,JHI)
        MAXWRK = JHI-JLO+1
C
        CALL DDI_PROCDLB_NEXT(C_VOOO,IWP,ICNTR2)
C
        DO WHILE(ICNTR2.LT.MAXWRK)
          JKL = JLO + ICNTR2
C
          DO KK=1,NOCC
            DO LL=1,KK
              KL = IA(KK) + LL
              DLT = ONE
              IF(KK.EQ.LL) DLT = HALF
              DO JJ=1,NOCC
                JKLTMP = (KL-1)*NOCC + JJ
                IF(JKL.EQ.JKLTMP) THEN
                  J = JJ
                  K = KK
                  L = LL
                  IF(K.GT.NCOR .AND. L.GT.NCOR) THEN
                    KKLL = IA(K-NCOR) + L-NCOR
                  ENDIF
                  GO TO 1010
                END IF
              ENDDO
            ENDDO
          ENDDO
C
 1010     CALL DDI_GET(D_VOOO,1,NBVIR,JKL,JKL,BUFF)
C
C          ----- Derivative core Fock matrices -----
C
          DO 1060 I=NOCC+1,L0
            XIJKL = BUFF(I-NOCC)
            IF(ABS(XIJKL).LT.TOL) GO TO 1060
            IF(J.GT.NCOR) GO TO 1020
            AVAL = TWO*XIJKL
            CALL DAXPY(NXYZ,-AVAL,SDER(1,I,J),1,DFC(1,KL),1)
C
 1020       IF((K.GT.NCOR).AND.(L.GT.NCOR)) GO TO 1060
            AVAL = HALF*XIJKL
            IF(K.EQ.L) AVAL = HALF*AVAL
            IF((K.GT.J).OR.(L.GT.NCOR)) GO TO 1030
            JK = IA(J) + K
            CALL DAXPY(NXYZ,AVAL,SDER(1,I,L),1,DFC(1,JK),1)
C
 1030       IF((L.GT.J).OR.(K.GT.NCOR)) GO TO 1040
            JL = IA(J) + L
            CALL DAXPY(NXYZ,AVAL,SDER(1,I,K),1,DFC(1,JL),1)
C
 1040       IF((J.GT.K).OR.(L.GT.NCOR)) GO TO 1050
            KJ = IA(K) + J
            CALL DAXPY(NXYZ,AVAL,SDER(1,I,L),1,DFC(1,KJ),1)
C
 1050       IF((J.GT.L).OR.(K.GT.NCOR)) GO TO 1060
            LJ = IA(L) + J
            CALL DAXPY(NXYZ,AVAL,SDER(1,I,K),1,DFC(1,LJ),1)
 1060     CONTINUE
C
C          ----- Derivative two-electron integrals -----
C
          IF((J.LE.NCOR).OR.(K.LE.NCOR).OR.(L.LE.NCOR)) GO TO 1100
          DO 1090 I=NOCC+1,L0
            XIJKL = BUFF(I-NOCC)
            IF(ABS(XIJKL).LT.TOL) GO TO 1090
            XIJKL = HALF*XIJKL
            DO 1080 M=NCOR+1,NOCC
              IF(J.GT.M) GO TO 1070
              MJ = IA(M-NCOR) + J-NCOR
              IF(KKLL.LE.MJ) THEN
                MJKL = IA(MJ) + KKLL
                CALL DAXPY(NXYZ,-XIJKL,SDER(1,M,I),1,DERI(1,MJKL),1)
              ENDIF
C
              IF(MJ.LE.KKLL) THEN
                KLMJ = IA(KKLL) + MJ
                CALL DAXPY(NXYZ,-XIJKL,SDER(1,M,I),1,DERI(1,KLMJ),1)
              ENDIF
C
 1070         IF(M.GT.J) GO TO 1080
C
              JM = IA(J-NCOR) + M-NCOR
              IF(KKLL.LE.JM) THEN
                JMKL = IA(JM) + KKLL
                CALL DAXPY(NXYZ,-XIJKL,SDER(1,M,I),1,DERI(1,JMKL),1)
              ENDIF
C
              IF(JM.LE.KKLL) THEN
                KLJM = IA(KKLL) + JM
                CALL DAXPY(NXYZ,-XIJKL,SDER(1,M,I),1,DERI(1,KLJM),1)
              ENDIF
 1080       CONTINUE
 1090     CONTINUE
C
C          ----- Construct core Fock matrix -----
C
 1100     IF((K.NE.L) .OR. (K.GT.NCOR)) GO TO 1110
          DO I=NOCC+1,L0
            IJ = IA(I) + J
            FCOR(IJ) = FCOR(IJ) + TWO*BUFF(I-NOCC)
          ENDDO
C
 1110     IF(J.GT.NCOR) GO TO 1130
          IF(J.NE.L) GO TO 1120
          DO I=NOCC+1,L0
            IK = IA(I) + K
            FCOR(IK) = FCOR(IK) - BUFF(I-NOCC)
          ENDDO
C
 1120     IF((J.NE.K) .OR. (K.EQ.L)) GO TO 1130
          DO I=NOCC+1,L0
            IL = IA(I) + L
            FCOR(IL) = FCOR(IL) - BUFF(I-NOCC)
          ENDDO
C
C          ----- Coulomb contribution to derivative Lagrangian -----
C
 1130     CONTINUE
          DO 1200 I=NOCC+1,L0
            XIJKL = BUFF(I-NOCC)
            IF(ABS(XIJKL).LT.TOL) GO TO 1200
C
C               ----- Lder(j,m) where m is a core orbital index -----
C
            IF(K.LE.NCOR) THEN
              CALL DAXPY(NXYZ,XIJKL,SDER(1,I,K),1,DLAG(1,J,L),1)
              CALL DAXPY(NXYZ,XIJKL,SDER(1,J,K),1,DLAG(1,I,L),1)
              IF(K.NE.L) THEN
                CALL DAXPY(NXYZ,XIJKL,SDER(1,I,L),1,DLAG(1,J,K),1)
                CALL DAXPY(NXYZ,XIJKL,SDER(1,J,L),1,DLAG(1,I,K),1)
              ENDIF
            ENDIF
C
            DO 1140 M=1,NCOR
              DVAL = ZERO
              IF(L.GT.NCOR) DVAL = TWO*OPDM(KKLL)*XIJKL
              IF(K.EQ.L) THEN
                DVAL = HALF*DVAL
                IF(K.LE.NCOR) DVAL = TWO*XIJKL
              ENDIF
              CALL DAXPY(NXYZ,-DVAL,SDER(1,I,M),1,DLAG(1,J,M),1)
              CALL DAXPY(NXYZ,-DVAL,SDER(1,J,M),1,DLAG(1,I,M),1)
 1140       CONTINUE
C
            DO 1150 M=1,NACT
              IF((K.GT.NCOR) .AND. (L.LE.NCOR)) THEN
                MM = M+NCOR
                MG = MAX(M,K-NCOR)
                KG = MIN(M,K-NCOR)
                MK = IA(MG) + KG
                DVAL = OPDM(MK)*XIJKL
                DVAL = HALF*DVAL
                CALL DAXPY(NXYZ,DVAL,SDER(1,I,MM),1,DLAG(1,J,L),1)
                CALL DAXPY(NXYZ,DVAL,SDER(1,J,MM),1,DLAG(1,I,L),1)
              ENDIF
 1150       CONTINUE
C
C               ----- Lder(j,m) where m is an active orbital index -----
C
             DO 1180 M=1,NACT
               MM = M+NCOR
               IF((K.GT.NCOR) .AND. (L.LE.NCOR)) THEN
                 MG = MAX(M,K-NCOR)
                 KG = MIN(M,K-NCOR)
                 MK = IA(MG) + KG
                 DVAL = OPDM(MK)*XIJKL
                 DVAL = HALF*DVAL
                 CALL DAXPY(NXYZ,DVAL,SDER(1,I,L),1,DLAG(1,J,MM),1)
                 CALL DAXPY(NXYZ,DVAL,SDER(1,J,L),1,DLAG(1,I,MM),1)
               ENDIF
C
               DO 1170 N=1,NACT
                 NN = N+NCOR
                 MG = MAX(M,N)
                 NG = MIN(M,N)
                 MN = IA(MG) + NG
                 IF((K.LE.NCOR) .AND. (K.EQ.L)) THEN
                   DVAL = OPDM(MN)*XIJKL
                   CALL DAXPY(NXYZ,-DVAL,SDER(1,I,NN),1,DLAG(1,J,MM),1)
                   CALL DAXPY(NXYZ,-DVAL,SDER(1,J,NN),1,DLAG(1,I,MM),1)
                 ENDIF
                 IF(L.GT.NCOR) THEN
                   MNG = MAX(MN,KKLL)
                   KLG = MIN(MN,KKLL)
                   MNKL = IA(MNG) + KLG
                   DVAL = TPDM(MNKL)*XIJKL
                   IF(K.EQ.L) DVAL = HALF*DVAL
                   CALL DAXPY(NXYZ,-DVAL,SDER(1,I,NN),1,DLAG(1,J,MM),1)
                   CALL DAXPY(NXYZ,-DVAL,SDER(1,J,NN),1,DLAG(1,I,MM),1)
                 ENDIF
 1170          CONTINUE
 1180        CONTINUE
 1200      CONTINUE
C
C          ----- Exchange contribution to derivative Lagrangian -----
C
          DO 1400 I=NOCC+1,L0
            XIJKL = BUFF(I-NOCC)
            IF(ABS(XIJKL).LT.TOL) GO TO 1400
C
C               ----- Lder(k,m) where j or l is a core orbital -----
C
            IF(J.GT.NCOR) GO TO 1220
            IF(L.LE.NCOR) THEN
              DVAL = FOUR*XIJKL
              CALL DAXPY(NXYZ,-DVAL,SDER(1,I,J),1,DLAG(1,K,L),1)
              CALL DAXPY(NXYZ,XIJKL,SDER(1,I,L),1,DLAG(1,K,J),1)
            ENDIF
            IF((K.LE.NCOR) .AND. (K.NE.L)) THEN
              DVAL = FOUR*XIJKL
              CALL DAXPY(NXYZ,-DVAL,SDER(1,I,J),1,DLAG(1,L,K),1)
              CALL DAXPY(NXYZ,XIJKL,SDER(1,I,K),1,DLAG(1,L,J),1)
            ENDIF
C
            DO M=1,NCOR
              IF(L.EQ.J)
     *          CALL DAXPY(NXYZ,XIJKL,SDER(1,I,M),1,DLAG(1,K,M),1)
              IF((K.EQ.J) .AND. (K.NE.L))
     *          CALL DAXPY(NXYZ,XIJKL,SDER(1,I,M),1,DLAG(1,L,M),1)
            ENDDO
C
            DO 1210 M=1,NACT
              MM = M+NCOR
              IF(L.GT.NCOR) THEN
                MG = MAX(M,L-NCOR)
                LG = MIN(M,L-NCOR)
                ML = IA(MG) + LG
                DVAL = OPDM(ML)*XIJKL
                DVAL = HALF*DVAL
                CALL DAXPY(NXYZ,DVAL,SDER(1,I,MM),1,DLAG(1,K,J),1)
                DVAL = FOUR*DVAL
                CALL DAXPY(NXYZ,-DVAL,SDER(1,I,J),1,DLAG(1,K,MM),1)
              ENDIF
              IF((K.GT.NCOR) .AND. (K.NE.L)) THEN
                MG = MAX(M,K-NCOR)
                KG = MIN(M,K-NCOR)
                MK = IA(MG) + KG
                DVAL = OPDM(MK)*XIJKL
                DVAL = HALF*DVAL
                CALL DAXPY(NXYZ,DVAL,SDER(1,I,MM),1,DLAG(1,L,J),1)
                DVAL = FOUR*DVAL
                CALL DAXPY(NXYZ,-DVAL,SDER(1,I,J),1,DLAG(1,L,MM),1)
              ENDIF
C
              DO 1210 N=1,NACT
                NN = N+NCOR
                MG = MAX(M,N)
                NG = MIN(M,N)
                MN = IA(MG) + NG
                DVAL = OPDM(MN)*XIJKL
                DVAL = HALF*DVAL
                IF(L.EQ.J)
     *            CALL DAXPY(NXYZ,DVAL,SDER(1,I,MM),1,DLAG(1,K,NN),1)
                IF((K.EQ.J) .AND. (K.NE.L))
     *            CALL DAXPY(NXYZ,DVAL,SDER(1,I,MM),1,DLAG(1,L,NN),1)
 1210       CONTINUE
C
 1220       IF(L.GT.NCOR) GO TO 1260
            IF(J.LE.NCOR) THEN
              DVAL = FOUR*XIJKL
              CALL DAXPY(NXYZ,-DVAL,SDER(1,K,L),1,DLAG(1,I,J),1)
              CALL DAXPY(NXYZ,XIJKL,SDER(1,K,J),1,DLAG(1,I,L),1)
            ENDIF
C
            DO M=1,NCOR
              IF(J.EQ.L)
     *          CALL DAXPY(NXYZ,XIJKL,SDER(1,K,M),1,DLAG(1,I,M),1)
            ENDDO
C
            DO 1230 M=1,NACT
              MM = M+NCOR
              IF(J.GT.NCOR) THEN
                MG = MAX(M,J-NCOR)
                JG = MIN(M,J-NCOR)
                MJ = IA(MG) + JG
                DVAL = OPDM(MJ)*XIJKL
                DVAL = HALF*DVAL
                CALL DAXPY(NXYZ,DVAL,SDER(1,K,MM),1,DLAG(1,I,L),1)
                DVAL = FOUR*DVAL
                CALL DAXPY(NXYZ,-DVAL,SDER(1,K,L),1,DLAG(1,I,MM),1)
              ENDIF
C
              DO 1230 N=1,NACT
                NN = N+NCOR
                MG = MAX(M,N)
                NG = MIN(M,N)
                MN = IA(MG) + NG
                DVAL = OPDM(MN)*XIJKL
                DVAL = HALF*DVAL
                IF(J.EQ.L)
     *            CALL DAXPY(NXYZ,DVAL,SDER(1,K,MM),1,DLAG(1,I,NN),1)
 1230       CONTINUE
C
            IF((K.GT.NCOR) .OR. (K.EQ.L)) GO TO 1260
            IF(J.LE.NCOR) THEN
              DVAL = FOUR*XIJKL
              CALL DAXPY(NXYZ,-DVAL,SDER(1,L,K),1,DLAG(1,I,J),1)
              CALL DAXPY(NXYZ,XIJKL,SDER(1,L,J),1,DLAG(1,I,K),1)
            ENDIF
C
            DO M=1,NCOR
              IF(J.EQ.K)
     *          CALL DAXPY(NXYZ,XIJKL,SDER(1,L,M),1,DLAG(1,I,M),1)
            ENDDO
C
            DO 1250 M=1,NACT
              MM = M+NCOR
              IF(J.GT.NCOR) THEN
                MG = MAX(M,J-NCOR)
                JG = MIN(M,J-NCOR)
                MJ = IA(MG) + JG
                DVAL = OPDM(MJ)*XIJKL
                DVAL = HALF*DVAL
                CALL DAXPY(NXYZ,DVAL,SDER(1,L,MM),1,DLAG(1,I,K),1)
                DVAL = FOUR*DVAL
                CALL DAXPY(NXYZ,-DVAL,SDER(1,L,K),1,DLAG(1,I,MM),1)
              ENDIF
C
              DO 1250 N=1,NACT
                NN = N+NCOR
                MG = MAX(M,N)
                NG = MIN(M,N)
                MN = IA(MG) + NG
                DVAL = OPDM(MN)*XIJKL
                DVAL = HALF*DVAL
                IF(J.EQ.K)
     *            CALL DAXPY(NXYZ,DVAL,SDER(1,L,MM),1,DLAG(1,I,NN),1)
 1250       CONTINUE
C
C               ----- Lder(k,m) where j or l is an active orbital -----
C
 1260       IF(J.LE.NCOR) GO TO 1280
            DO M=1,NCOR
              IF(L.GT.NCOR) THEN
                JG = MAX(J-NCOR,L-NCOR)
                LG = MIN(J-NCOR,L-NCOR)
                JL = IA(JG) + LG
                DVAL = OPDM(JL)*XIJKL
                DVAL = HALF*DVAL
                CALL DAXPY(NXYZ,DVAL,SDER(1,I,M),1,DLAG(1,K,M),1)
              ENDIF
              IF((K.GT.NCOR) .AND. (K.NE.L)) THEN
                JG = MAX(J-NCOR,K-NCOR)
                KG = MIN(J-NCOR,K-NCOR)
                JK = IA(JG) + KG
                DVAL = OPDM(JK)*XIJKL
                DVAL = HALF*DVAL
                CALL DAXPY(NXYZ,DVAL,SDER(1,I,M),1,DLAG(1,L,M),1)
              ENDIF
            ENDDO
C
            DO 1270 M=1,NACT
              MM = M+NCOR
              JG = MAX(J-NCOR,M)
              MG = MIN(J-NCOR,M)
              JM = IA(JG) + MG
              DVAL = OPDM(JM)*XIJKL
              DVAL = HALF*DVAL
              IF(L.LE.NCOR) THEN
                CALL DAXPY(NXYZ,DVAL,SDER(1,I,L),1,DLAG(1,K,MM),1)
                DLT = FOUR*DVAL
                CALL DAXPY(NXYZ,-DLT,SDER(1,I,MM),1,DLAG(1,K,L),1)
              ENDIF
              IF((K.LE.NCOR) .AND. (K.NE.L)) THEN
                CALL DAXPY(NXYZ,DVAL,SDER(1,I,K),1,DLAG(1,L,MM),1)
                DLT = FOUR*DVAL
                CALL DAXPY(NXYZ,-DLT,SDER(1,I,MM),1,DLAG(1,L,K),1)
              ENDIF
C
              DO N=1,NACT
                NN = N+NCOR
                IF(L.GT.NCOR) THEN
                  NG = MAX(N,L-NCOR)
                  LG = MIN(N,L-NCOR)
                  NL = IA(NG) + LG
                  JMG = MAX(JM,NL)
                  NLG = MIN(JM,NL)
                  JMNL = IA(JMG) + NLG
                  DVAL = TPDM(JMNL)*XIJKL
                  CALL DAXPY(NXYZ,-DVAL,SDER(1,I,MM),1,DLAG(1,K,NN),1)
                ENDIF
                IF((K.GT.NCOR) .AND. (K.NE.L)) THEN
                  NG = MAX(N,K-NCOR)
                  KG = MIN(N,K-NCOR)
                  NK = IA(NG) + KG
                  JMG = MAX(JM,NK)
                  NKG = MIN(JM,NK)
                  JMNK = IA(JMG) + NKG
                  DVAL = TPDM(JMNK)*XIJKL
                  CALL DAXPY(NXYZ,-DVAL,SDER(1,I,MM),1,DLAG(1,L,NN),1)
                ENDIF
              ENDDO
 1270       CONTINUE
C
 1280       IF(L.LE.NCOR) GO TO 1300
            DO M=1,NCOR
              IF(J.GT.NCOR) THEN
                JG = MAX(J-NCOR,L-NCOR)
                LG = MIN(J-NCOR,L-NCOR)
                JL = IA(JG) + LG
                DVAL = OPDM(JL)*XIJKL
                DVAL = HALF*DVAL
                CALL DAXPY(NXYZ,DVAL,SDER(1,K,M),1,DLAG(1,I,M),1)
              ENDIF
            ENDDO
C
            DO 1290 M=1,NACT
              MM = M+NCOR
              LG = MAX(L-NCOR,M)
              MG = MIN(L-NCOR,M)
              LM = IA(LG) + MG
              DVAL = OPDM(LM)*XIJKL
              DVAL = HALF*DVAL
              IF(J.LE.NCOR) THEN
                CALL DAXPY(NXYZ,DVAL,SDER(1,K,J),1,DLAG(1,I,MM),1)
                DVAL = FOUR*DVAL
                CALL DAXPY(NXYZ,-DVAL,SDER(1,K,MM),1,DLAG(1,I,J),1)
              ENDIF
C
              DO N=1,NACT
                NN = N+NCOR
                IF(J.GT.NCOR) THEN
                  NG = MAX(N,J-NCOR)
                  JG = MIN(N,J-NCOR)
                  NJ = IA(NG) + JG
                  LMG = MAX(LM,NJ)
                  NJG = MIN(LM,NJ)
                  LMNJ = IA(LMG) + NJG
                  DVAL = TPDM(LMNJ)*XIJKL
                  CALL DAXPY(NXYZ,-DVAL,SDER(1,K,MM),1,DLAG(1,I,NN),1)
                ENDIF
              ENDDO
 1290       CONTINUE
C
 1300       IF((K.LE.NCOR) .OR. (K.EQ.L)) GO TO 1400
            DO M=1,NCOR
              IF(J.GT.NCOR) THEN
                JG = MAX(J-NCOR,K-NCOR)
                KG = MIN(J-NCOR,K-NCOR)
                JK = IA(JG) + KG
                DVAL = OPDM(JK)*XIJKL
                DVAL = HALF*DVAL
                CALL DAXPY(NXYZ,DVAL,SDER(1,L,M),1,DLAG(1,I,M),1)
              ENDIF
            ENDDO
C
            DO 1310 M=1,NACT
              MM = M+NCOR
              KG = MAX(K-NCOR,M)
              MG = MIN(K-NCOR,M)
              KM = IA(KG) + MG
              DVAL = OPDM(KM)*XIJKL
              DVAL = HALF*DVAL
              IF(J.LE.NCOR) THEN
                CALL DAXPY(NXYZ,DVAL,SDER(1,L,J),1,DLAG(1,I,MM),1)
                DVAL = FOUR*DVAL
                CALL DAXPY(NXYZ,-DVAL,SDER(1,L,MM),1,DLAG(1,I,J),1)
              ENDIF
C
              DO N=1,NACT
                NN = N+NCOR
                IF(J.GT.NCOR) THEN
                  NG = MAX(N,J-NCOR)
                  JG = MIN(N,J-NCOR)
                  NJ = IA(NG) + JG
                  KMG = MAX(KM,NJ)
                  NJG = MIN(KM,NJ)
                  KMNJ = IA(KMG) + NJG
                  DVAL = TPDM(KMNJ)*XIJKL
                  CALL DAXPY(NXYZ,-DVAL,SDER(1,L,MM),1,DLAG(1,I,NN),1)
                ENDIF
              ENDDO
 1310       CONTINUE
 1400     CONTINUE
C
C          ----- Construct two-electron integral array -----
C
          IF(J.LE.NCOR) GO TO 1500
          IF((K.LE.NCOR) .OR. (L.LE.NCOR)) GO TO 1500
          JJ = J-NCOR
          DO I=NOCC+1,L0
            ERI(I,JJ,KKLL) = BUFF(I-NOCC)
          ENDDO
C
C          ----- Construct A matrix -----
C
 1500     IF(J.GT.NCOR) GO TO 1550
          IF((K.LE.NCOR) .OR. (L.LE.NCOR)) GO TO 1550
          DO I=NOCC+1,L0
            AMAT(I,J,KKLL) = AMAT(I,J,KKLL) + FOUR*BUFF(I-NOCC)
          ENDDO
C
 1550     IF(J.LE.NCOR) GO TO 1600
          IF((K.LE.NCOR) .OR. (L.GT.NCOR)) GO TO 1600
          JJ = J-NCOR
          KK = K-NCOR
          JG = MAX(JJ,KK)
          KG = MIN(JJ,KK)
          JK = IA(JG) + KG
          DO I=NOCC+1,L0
            DVAL = BUFF(I-NOCC)
            IF(J.GE.K) AMAT(I,L,JK) = AMAT(I,L,JK) - DVAL
            IF(K.GE.J) AMAT(I,L,JK) = AMAT(I,L,JK) - DVAL
          ENDDO
C
C          ----- Finished with current integral buffer -----
C
 1600     CALL DDI_PROCDLB_NEXT(C_VOOO,IWP,ICNTR2)
C
        ENDDO
        CALL TSECND(T1)
        IF(IWP.EQ.ME  .AND.  MASWRK) WRITE(IW,9010) T1-T0
        CALL FLSHBF(IW)
        T0 = T1
C
C     ----- Get and use (VV|OO) integrals -----
C
        CALL DDI_DISTRIB(D_VVOO,IWP,ILO,IHI,JLO,JHI)
        MAXWRK = JHI-JLO+1
C
        CALL DDI_PROCDLB_NEXT(C_VVOO,IWP,ICNTR3)
C
        DO WHILE(ICNTR3.LT.MAXWRK)
          KL = JLO + ICNTR3
C
          DO KK=1,NOCC
            DO LL=1,KK
              KLTMP = IA(KK) + LL
              IF(KL.EQ.KLTMP) THEN
                K = KK
                L = LL
                GO TO 2010
              END IF
            ENDDO
          ENDDO
C
 2010     CALL DDI_GET(D_VVOO,1,NBTR,KL,KL,BUFF)
C
C          ----- Construct core Fock matrix -----
C
          IF((K.NE.L) .OR. (K.GT.NCOR)) GO TO 2030
          DO 2020 I=1,NVIR
            II = I + NOCC
            DO 2020 J=1,I
              JJ = J + NOCC
              IIJJ = IA(II) + JJ
              IJ = IA(I) + J
              FCOR(IIJJ) = FCOR(IIJJ) + TWO*BUFF(IJ)
 2020     CONTINUE
C
C          ----- Coulomb contribution to derivative Lagrangian -----
C
 2030     IF(L.GT.NCOR) KKLL = IA(K-NCOR) + L-NCOR
          DO 2100 I=1,NVIR
            II = I+NOCC
            DO 2100 J=1,I
              JJ = J+NOCC
              IJ = IA(I) + J
              XIJKL = BUFF(IJ)
              IF(ABS(XIJKL).LT.TOL) GO TO 2100
              IJVAL = .TRUE.
              IF(I.EQ.J) IJVAL = .FALSE.
C
C               ----- K and L are core indices -----
C
              IF(K.LE.NCOR) THEN
                CALL DAXPY(NXYZ,XIJKL,SDER(1,II,K),1,DLAG(1,JJ,L),1)
                IF(IJVAL) CALL DAXPY(NXYZ,XIJKL,SDER(1,JJ,K),1,
     *                               DLAG(1,II,L),1)
C
                IF(K.NE.L) THEN
                  CALL DAXPY(NXYZ,XIJKL,SDER(1,II,L),1,DLAG(1,JJ,K),1)
                  IF(IJVAL) CALL DAXPY(NXYZ,XIJKL,SDER(1,JJ,L),1,
     *                                 DLAG(1,II,K),1)
                ENDIF
C
                IF(K.EQ.L) THEN
                  DVAL = TWO*XIJKL
                  DO M=1,NCOR
                    CALL DAXPY(NXYZ,-DVAL,SDER(1,II,M),1,DLAG(1,JJ,M),1)
                    IF(IJVAL) CALL DAXPY(NXYZ,-DVAL,SDER(1,JJ,M),1,
     *                                   DLAG(1,II,M),1)
                  ENDDO
C
                  DO 2040 M=1,NACT
                    MM = M+NCOR
                    DO 2040 N=1,NACT
                      NN = N+NCOR
                      MG = MAX(M,N)
                      NG = MIN(M,N)
                      MN = IA(MG) + NG
                      DVAL = OPDM(MN)*XIJKL
                      CALL DAXPY(NXYZ,-DVAL,SDER(1,II,MM),1,
     *                           DLAG(1,JJ,NN),1)
                      IF(IJVAL) CALL DAXPY(NXYZ,-DVAL,SDER(1,JJ,MM),1,
     *                                     DLAG(1,II,NN),1)
 2040             CONTINUE
                ENDIF
                GO TO 2100
              ENDIF
C
C               ----- K is active, L is core -----
C
              IF(L.LE.NCOR) THEN
                DO M=1,NACT
                  MM = M+NCOR
                  MG = MAX(M,K-NCOR)
                  KG = MIN(M,K-NCOR)
                  MK = IA(MG) + KG
                  DVAL = OPDM(MK)*XIJKL
                  DVAL = HALF*DVAL
                  CALL DAXPY(NXYZ,DVAL,SDER(1,II,MM),1,DLAG(1,JJ,L),1)
                  IF(IJVAL) CALL DAXPY(NXYZ,DVAL,SDER(1,JJ,MM),1,
     *                                 DLAG(1,II,L),1)
C
                  CALL DAXPY(NXYZ,DVAL,SDER(1,II,L),1,DLAG(1,JJ,MM),1)
                  IF(IJVAL) CALL DAXPY(NXYZ,DVAL,SDER(1,JJ,L),1,
     *                                 DLAG(1,II,MM),1)
                ENDDO
                GO TO 2100
              ENDIF
C
C               ----- K and L are active indicies -----
C
               DVAL = OPDM(KKLL)*XIJKL
               IF(K.NE.L) DVAL = TWO*DVAL
               DO M=1,NCOR
                 CALL DAXPY(NXYZ,-DVAL,SDER(1,II,M),1,DLAG(1,JJ,M),1)
                 IF(IJVAL) CALL DAXPY(NXYZ,-DVAL,SDER(1,JJ,M),1,
     *                                DLAG(1,II,M),1)
               ENDDO
C
               DO 2050 M=1,NACT
                 MM = M+NCOR
                 DO 2050 N=1,NACT
                   NN = N+NCOR
                   MG = MAX(M,N)
                   NG = MIN(M,N)
                   MN = IA(MG) + NG
                   MNG = MAX(MN,KKLL)
                   KLG = MIN(MN,KKLL)
                   MNKL = IA(MNG) + KLG
                   DVAL = TPDM(MNKL)*XIJKL
                   IF(K.EQ.L) DVAL = HALF*DVAL
                   CALL DAXPY(NXYZ,-DVAL,SDER(1,II,MM),1,
     *                        DLAG(1,JJ,NN),1)
                   IF(IJVAL) CALL DAXPY(NXYZ,-DVAL,SDER(1,JJ,MM),1,
     *                                  DLAG(1,II,NN),1)
 2050          CONTINUE
 2100     CONTINUE
C
C          ----- Coulomb contribution to preconditioner -----
C
          DO 2300 I=1,NVIR
            II = I+NOCC
            IJ = IA(I) + I
            XIJKL = BUFF(IJ)
            IF(ABS(XIJKL).LT.TOL) GO TO 2300
C
            IF((K.GT.NCOR) .OR. (K.NE.L)) GO TO 2200
            DO 2120 M=1,NCOR
              IMG = IABS(INDEX(II,M))
              IF(IMG.EQ.0) GO TO 2120
              DVAL = FOUR*XIJKL
              IF(M.EQ.K) DVAL = HALF*DVAL
              PRCNDO(IMG) = PRCNDO(IMG) + DVAL
 2120       CONTINUE
C
            DO 2130 M=1,NACT
              IMG = IABS(INDEX(II,M+NCOR))
              IF(IMG.EQ.0) GO TO 2130
              MM = IA(M) + M
              DVAL = OPDM(MM)*XIJKL
              PRCNDO(IMG) = PRCNDO(IMG) + TWO*DVAL
 2130       CONTINUE
C
 2200       IF(L.LE.NCOR) GO TO 2300
C
            DO 2220 M=1,NCOR
              IMG = IABS(INDEX(II,M))
              IF(IMG.EQ.0) GO TO 2220
              DVAL = OPDM(KKLL)*XIJKL
              IF(K.NE.L) DVAL = TWO*DVAL
              PRCNDO(IMG) = PRCNDO(IMG) + TWO*DVAL
 2220       CONTINUE
C
            DO 2230 M=1,NACT
              IMG = IABS(INDEX(II,M+NCOR))
              IF(IMG.EQ.0) GO TO 2230
              MM = IA(M) + M
              MMG = MAX(MM,KKLL)
              KLG = MIN(MM,KKLL)
              MMKL = IA(MMG) + KLG
              DVAL = TPDM(MMKL)*XIJKL
              IF(K.NE.L) DVAL = TWO*DVAL
              PRCNDO(IMG) = PRCNDO(IMG) + DVAL
 2230       CONTINUE
 2300     CONTINUE
C
C          ----- Finished with current integral buffer -----
C
          CALL DDI_PROCDLB_NEXT(C_VVOO,IWP,ICNTR3)
C
        ENDDO
        CALL TSECND(T1)
        IF(IWP.EQ.ME  .AND.  MASWRK) WRITE(IW,9020) T1-T0
        CALL FLSHBF(IW)
        T0 = T1
C
C     ----- Get and use (VO|VO) integrals -----
C
        CALL DDI_DISTRIB(D_VOVO,IWP,ILO,IHI,JLO,JHI)
        MAXWRK = JHI-JLO+1
C
        CALL DDI_PROCDLB_NEXT(C_VOVO,IWP,ICNTR4)
C
        DO WHILE(ICNTR4.LT.MAXWRK)
          JL = JLO + ICNTR4
C
          DO JJ=1,NOCC
            DO LL=1,JJ
              JLTMP = IA(JJ) + LL
              IF(JL.EQ.JLTMP) THEN
                J = JJ
                L = LL
                GO TO 3010
              END IF
            ENDDO
          ENDDO
C
 3010     CALL DDI_GET(D_VOVO,1,NBSQ,JL,JL,BUFF)
C
C          ----- Construct core Fock matrix -----
C
          IF((J.NE.L) .OR. (J.GT.NCOR)) GO TO 3030
          DO 3020 I=1,NVIR
            II = I + NOCC
            DO 3020 K=1,I
              KK = K + NOCC
              IIKK = IA(II) + KK
              IK = (I-1)*NVIR + K
              FCOR(IIKK) = FCOR(IIKK) - BUFF(IK)
 3020     CONTINUE
C
C          ----- Exchange contribution to derivative Lagrangian -----
C
 3030     IF(J.GT.NCOR) GO TO 3130
          IF(J.EQ.L) THEN
            DO 3050 I=1,NVIR
              II = I+NOCC
              DO 3050 K=1,NVIR
                KK = K+NOCC
                KI = (K-1)*NVIR + I
                XKJIL = BUFF(KI)
                IF(ABS(XKJIL).LT.TOL) GO TO 3050
                DO M=1,NCOR
                  CALL DAXPY(NXYZ,XKJIL,SDER(1,II,M),1,DLAG(1,KK,M),1)
                ENDDO
C
                DO 3040 M=1,NACT
                  MM = M+NCOR
                  DO 3040 N=1,NACT
                   NN = N+NCOR
                   MG = MAX(M,N)
                   NG = MIN(M,N)
                   MN = IA(MG) + NG
                   DVAL = OPDM(MN)*XKJIL
                   DVAL = HALF*DVAL
                   CALL DAXPY(NXYZ,DVAL,SDER(1,II,MM),1,DLAG(1,KK,NN),1)
 3040           CONTINUE
 3050       CONTINUE
          ENDIF
C
          DO 3060 I=1,NVIR
            II = I+NOCC
            DO 3060 K=1,NVIR
              KK = K+NOCC
              IK = (I-1)*NVIR + K
              KI = (K-1)*NVIR + I
              DVAL = BUFF(KI) - FOUR*BUFF(IK)
              CALL DAXPY(NXYZ,DVAL,SDER(1,II,L),1,DLAG(1,KK,J),1)
              IF(J.EQ.L) GO TO 3060
              DVAL = BUFF(IK) - FOUR*BUFF(KI)
              CALL DAXPY(NXYZ,DVAL,SDER(1,II,J),1,DLAG(1,KK,L),1)
 3060     CONTINUE
          GO TO 3400
C
 3130     IF(L.GT.NCOR) GO TO 3230
          DO 3150 I=1,NVIR
            II = I+NOCC
            DO 3150 K=1,NVIR
              KK = K+NOCC
              KI = (K-1)*NVIR + I
              XKJIL = BUFF(KI)
              IF(ABS(XKJIL).LT.TOL) GO TO 3140
              DO M=1,NACT
                MM = M+NCOR
                MG = MAX(M,J-NCOR)
                JG = MIN(M,J-NCOR)
                MJ = IA(MG) + JG
                DVAL = OPDM(MJ)*XKJIL
                DVAL = HALF*DVAL
                CALL DAXPY(NXYZ,DVAL,SDER(1,II,L),1,DLAG(1,KK,MM),1)
                DVAL = FOUR*DVAL
                CALL DAXPY(NXYZ,-DVAL,SDER(1,II,MM),1,DLAG(1,KK,L),1)
              ENDDO
C
 3140         IK = (I-1)*NVIR + K
              XIJKL = BUFF(IK)
              IF(ABS(XIJKL).LT.TOL) GO TO 3150
              DO M=1,NACT
                MM = M+NCOR
                MG = MAX(M,J-NCOR)
                JG = MIN(M,J-NCOR)
                MJ = IA(MG) + JG
                DVAL = OPDM(MJ)*XIJKL
                DVAL = HALF*DVAL
                CALL DAXPY(NXYZ,DVAL,SDER(1,II,MM),1,DLAG(1,KK,L),1)
                DVAL = FOUR*DVAL
                CALL DAXPY(NXYZ,-DVAL,SDER(1,II,L),1,DLAG(1,KK,MM),1)
              ENDDO
 3150     CONTINUE
          GO TO 3400
C
 3230    JL = IA(J-NCOR) + L-NCOR
         DO 3300 I=1,NVIR
           II = I+NOCC
           DO 3300 K=1,NVIR
             KK = K+NOCC
             KI = (K-1)*NVIR + I
             XKJIL = BUFF(KI)
             IF(ABS(XKJIL).LT.TOL) GO TO 3270
             DO M=1,NCOR
               DVAL = OPDM(JL)*XKJIL
               DVAL = HALF*DVAL
               CALL DAXPY(NXYZ,DVAL,SDER(1,II,M),1,DLAG(1,KK,M),1)
             ENDDO
C
             DO 3250 M=1,NACT
               MM = M+NCOR
               MG = MAX(M,J-NCOR)
               JG = MIN(M,J-NCOR)
               MJ = IA(MG) + JG
               DO 3250 N=1,NACT
                 NN = N+NCOR
                 NG = MAX(N,L-NCOR)
                 LG = MIN(N,L-NCOR)
                 NL = IA(NG) + LG
                 MJG = MAX(MJ,NL)
                 NLG = MIN(MJ,NL)
                 MJNL = IA(MJG) + NLG
                 DVAL = TPDM(MJNL)*XKJIL
                 CALL DAXPY(NXYZ,-DVAL,SDER(1,II,MM),1,DLAG(1,KK,NN),1)
 3250        CONTINUE
C
 3270        IF(J.EQ.L) GO TO 3300
             IK = (I-1)*NVIR + K
             XIJKL = BUFF(IK)
             IF(ABS(XIJKL).LT.TOL) GO TO 3300
             DO M=1,NCOR
               DVAL = OPDM(JL)*XIJKL
               DVAL = HALF*DVAL
               CALL DAXPY(NXYZ,DVAL,SDER(1,II,M),1,DLAG(1,KK,M),1)
             ENDDO
C
             DO 3290 M=1,NACT
               MM = M+NCOR
               MG = MAX(M,L-NCOR)
               LG = MIN(M,L-NCOR)
               ML = IA(MG) + LG
               DO 3290 N=1,NACT
                 NN = N+NCOR
                 NG = MAX(N,J-NCOR)
                 JG = MIN(N,J-NCOR)
                 NJ = IA(NG) + JG
                 MLG = MAX(ML,NJ)
                 NJG = MIN(ML,NJ)
                 MLNJ = IA(MLG) + NJG
                 DVAL = TPDM(MLNJ)*XIJKL
                 CALL DAXPY(NXYZ,-DVAL,SDER(1,II,MM),1,DLAG(1,KK,NN),1)
 3290        CONTINUE
 3300    CONTINUE
C
C          ----- Exchange contribution to preconditioner -----
C
 3400    CONTINUE
         DO 3600 I=1,NVIR
           II = I+NOCC
           IK = (I-1)*NVIR + I
           XIJKL = BUFF(IK)
           IF(ABS(XIJKL).LT.TOL) GO TO 3600
C
           IF((J.GT.NCOR) .OR. (J.NE.L)) GO TO 3500
           DO 3420 M=1,NCOR
             IMG = IABS(INDEX(II,M))
             IF(IMG.EQ.0) GO TO 3420
             DVAL = -TWO*XIJKL
             IF(M.EQ.J) DVAL = -TWO*DVAL
             PRCNDO(IMG) = PRCNDO(IMG) + DVAL
 3420      CONTINUE
C
           DO 3430 M=1,NACT
             IMG = IABS(INDEX(II,M+NCOR))
             IF(IMG.EQ.0) GO TO 3430
             MM = IA(M) + M
             PRCNDO(IMG) = PRCNDO(IMG) - OPDM(MM)*XIJKL
 3430      CONTINUE
C
 3500      IF(L.LE.NCOR) GO TO 3600
C
           DO 3520 M=1,NCOR
             IMG = IABS(INDEX(II,M))
             IF(IMG.EQ.0) GO TO 3520
             DVAL = OPDM(JL)*XIJKL
             IF(J.NE.L) DVAL = TWO*DVAL
             PRCNDO(IMG) = PRCNDO(IMG) - DVAL
 3520      CONTINUE
C
           DO 3530 M=1,NACT
             IMG = IABS(INDEX(II,M+NCOR))
             IF(IMG.EQ.0) GO TO 3530
             MG = MAX(M,J-NCOR)
             JG = MIN(M,J-NCOR)
             MJ = IA(MG) + JG
             MG = MAX(M,L-NCOR)
             LG = MIN(M,L-NCOR)
             ML = IA(MG) + LG
             MJG = MAX(MJ,ML)
             MLG = MIN(MJ,ML)
             MJML = IA(MJG) + MLG
             DVAL = TPDM(MJML)*XIJKL
             IF(J.NE.L) DVAL = TWO*DVAL
             PRCNDO(IMG) = PRCNDO(IMG) + TWO*DVAL
 3530      CONTINUE
 3600    CONTINUE
C
C          ----- Finished with current integral buffer -----
C
          CALL DDI_PROCDLB_NEXT(C_VOVO,IWP,ICNTR4)
C
        ENDDO
        CALL TSECND(T1)
        IF(IWP.EQ.ME  .AND.  MASWRK) WRITE(IW,9030) T1-T0
        CALL FLSHBF(IW)
        T0 = T1
C
 8000 CONTINUE
C
      CALL DDI_GSUMF(2160,DFC,L2*NXYZ)
      CALL DDI_GSUMF(2161,DERI,N4*NXYZ)
      CALL DDI_GSUMF(2162,DLAG,L3*NXYZ)
      CALL DDI_GSUMF(2163,FCOR,L2)
      CALL DDI_GSUMF(2164,ERI,L1*N2*NACT)
      CALL DDI_GSUMF(2165,PRCNDO,NROT)
      CALL DDI_GSUMF(2166,AMAT,L1*NCOR*N2)
C
 9000 FORMAT(/1X,'MASTER NODE HAS FINISHED WITH (OO|OO) INTEGRALS,',
     *           ' T=',F7.1)
 9010 FORMAT(1X,'MASTER NODE HAS FINISHED WITH (VO|OO) INTEGRALS,',
     *           ' T=',F7.1)
 9020 FORMAT(1X,'MASTER NODE HAS FINISHED WITH (VV|OO) INTEGRALS,',
     *           ' T=',F7.1)
 9030 FORMAT(1X,'MASTER NODE HAS FINISHED WITH (VO|VO) INTEGRALS,',
     *           ' T=',F7.1)
      RETURN
      END
C*MODULE CPMCHF  *DECK POSCP
C     -------------------------------------------
      INTEGER FUNCTION POSCP(NACT,NOEL,CON,IFA)
C     -------------------------------------------
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      INTEGER CON(NOEL),POS1,I,J
      DIMENSION IFA(0:NACT,0:NACT)
C
C     This function is the same as POSDET in ALDECI
C
      POS1 = 0
      POSCP = 1
      DO 33 I=1,NOEL
         DO 55 J=POS1+1,CON(I)-1
            POSCP = POSCP + IFA(NACT-J,NOEL-I)
   55    CONTINUE
         POS1 = CON(I)
   33 CONTINUE
C
      RETURN
      END
C*MODULE CPMCHF  *DECK RET1CP
C     --------------------------------------------------------
      SUBROUTINE RET1CP(IBCON1,IBCON2,NB,IB,JJ,NCOR,KKJ,IPER)
C     --------------------------------------------------------
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      DIMENSION IBCON1(*),IBCON2(*)
C
C     This routine is the same as RET1DET in ALDECI
C
      IF (JJ.LT.IBCON1(IB)) THEN
         DO 870 KI=1,KKJ-1
               IBCON2(KI) = IBCON1(KI+NCOR)-NCOR
  870    CONTINUE
         IBCON2(KKJ) = JJ-NCOR
         IPR = KKJ
         DO 875 KI=KKJ,NB
              IF (KI+NCOR.EQ.IB) GOTO 875
            IPR = IPR+1
            IBCON2(IPR) = IBCON1(KI+NCOR)-NCOR
  875    CONTINUE
         IPER = IB-KKJ-NCOR
      ELSE
         IPR = 0
         DO 880 KI=1,KKJ-1
            IF (KI+NCOR.EQ.IB) GOTO 880
              IPR = IPR + 1
              IBCON2(IPR) = IBCON1(KI+NCOR)-NCOR
  880    CONTINUE
            IBCON2(KKJ-1) = JJ-NCOR
            DO 885 KI=KKJ,NB
                 IBCON2(KI) = IBCON1(KI+NCOR)-NCOR
  885       CONTINUE
            IPER = KKJ-1-IB+NCOR
      ENDIF
C
      RETURN
      END
C*MODULE CPMCHF  *DECK UAFCM
      SUBROUTINE UAFCM(FCM,DDM,YAO,YAC,DDEN,WAXO,WAXC,SDER,CI,EG,OPDM,
     *                 VEC,DIPAO,DIPMO,WRK,INDEX,NOCP,IA,L0,L1,L2,NXYZ,
     *                 NUNIQ,NROT,NDETLN,NCOR,NACT,NNACT,JLO,JHI,NFT18,
     *                 NFT19)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      LOGICAL GOPARR,DSKWRK,MASWRK,SVDSKW
C
      DIMENSION FCM(NXYZ,NXYZ),DDM(3*NXYZ),YAO(NUNIQ,NROT),
     *          YAC(NUNIQ,NDETLN),DDEN(NUNIQ,NNACT),WAXO(NROT),
     *          WAXC(NDETLN),SDER(NXYZ,L1,L1),CI(*),EG(NXYZ),
     *          OPDM(*),VEC(L1,L1),DIPAO(*),DIPMO(*),WRK(*)
      DIMENSION INDEX(L1,L1),NOCP(NXYZ),IA(*)
C
      COMMON /IOFILE/ IR,IW,IP,IS,IJKT,IDAF,NAV,IODA(950)
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
C
      PARAMETER (ZERO=0.0D+00,ONE=1.0D+00,TWO=2.0D+00,FOUR=4.0D+00)
      PARAMETER (TOL=1.0D-09)
C
      L3 = L1*L1
      NOCC = NCOR + NACT
C
      SVDSKW = DSKWRK
      DSKWRK = .FALSE.
      CALL SEQREW(NFT18)
C
C     ----- Add orbital perturbation to force constant matrix -----
C
      DO 100 IXYZ=1,NXYZ
        CALL SQREAD(NFT18,WRK,L3)
        CALL VCLR(WAXO,1,NROT)
C
        DO 50 J=1,NOCC
          DO 50 I=1,L1
            IJ = (J-1)*L1 + I
            IPHSE = INDEX(I,J)
            IROT = IABS(IPHSE)
            IF(IROT.EQ.0) GO TO 50
            DLT = IROT
            DLT = DLT/IPHSE
            WAXO(IROT) = WAXO(IROT) + DLT*WRK(IJ)
   50   CONTINUE
        CALL DSCAL(NROT,TWO,WAXO,1)
C
        JUNIQ = 0
        DO 80 JXYZ=1,NXYZ
          NJXYZ = NOCP(JXYZ)
          IF(NJXYZ.NE.1) JUNIQ = JUNIQ + 1
C
          DVAL = DDOT(L3,WRK,1,SDER(JXYZ,1,1),NXYZ)
          DVAL = -DVAL
          IF(NJXYZ.EQ.0) THEN
            DVAL = DVAL + DDOT(NROT,YAO(JUNIQ,1),NUNIQ,WAXO,1)
          ENDIF
          FCM(IXYZ,JXYZ) = FCM(IXYZ,JXYZ) + DVAL
   80   CONTINUE
  100 CONTINUE
C
C     ----- Add config. perturbation to force constant matrix -----
C
      IF(GOPARR) CALL DSCAL(NXYZ*NXYZ,ONE/NPROC,FCM,1)
C
      DSKWRK = .TRUE.
      CALL SEQREW(NFT19)
C
      DO 200 IXYZ=1,NXYZ
        CALL SQREAD(NFT19,WAXC,NDETLN)
        CALL DSCAL(NDETLN,TWO,WAXC,1)
C
        JUNIQ = 0
        DO 180 JXYZ=1,NXYZ
          NJXYZ = NOCP(JXYZ)
          IF(NJXYZ.EQ.1) GO TO 180
          JUNIQ = JUNIQ + 1
C
          DO 160 M=JLO,JHI
            MM = M-JLO+1
            YVAL = YAC(JUNIQ,MM)
            IF(ABS(YVAL).LT.TOL) GO TO 160
            CVAL = FOUR*CI(M)
C
            DVAL = YVAL*WAXC(MM)
            DVAL = DVAL - CVAL*YVAL*EG(IXYZ)
            FCM(IXYZ,JXYZ) = FCM(IXYZ,JXYZ) + DVAL
  160     CONTINUE
  180   CONTINUE
  200 CONTINUE
C
      IF(GOPARR) CALL DDI_GSUMF(2187,FCM,NXYZ*NXYZ)
C
      DSKWRK = SVDSKW
C
C     ----- Form complete MO derivative -----
C
      DO 300 I=1,L1
        DO 300 J=1,L1
          IPHSE = INDEX(I,J)
          IJ = IABS(IPHSE)
          IF(IJ.EQ.0) GO TO 300
          DLT = TWO*IJ/IPHSE
          IUNIQ = 0
          DO 250 IXYZ=1,NXYZ
            IF(NOCP(IXYZ).NE.1) IUNIQ = IUNIQ + 1
            IF(NOCP(IXYZ).NE.0) GO TO 250
            SDER(IXYZ,I,J) = SDER(IXYZ,I,J) - DLT*YAO(IUNIQ,IJ)
  250     CONTINUE
  300 CONTINUE
C
C     ----- Add derivative overlap and response terms to -----
C     -----               dipole derivative              -----
C
      DO 1000 IXYZ=1,3
C
C          ----- Transform dipole integrals to MO basis -----
C
        CALL DAREAD(IDAF,IODA,DIPAO,L2,95+IXYZ-1,0)
        CALL TFTRI(DIPMO,DIPAO,VEC,WRK,L0,L1,L1)
        CALL DAWRIT(IDAF,IODA,DIPMO,L2,252+IXYZ-1,0)
C
C          ----- Construct dipole "Lagrangian" -----
C
        CALL VCLR(WRK,1,L3)
        DO 400 I=1,L0
          DO J=1,NCOR
            II = MAX(I,J)
            JJ = MIN(I,J)
            IJ = IA(II)+JJ
            JI = (J-1)*L1 + I
            WRK(JI) = TWO*DIPMO(IJ)
          ENDDO
C
          DO 400 J=1,NACT
            DVAL = ZERO
            DO M=1,NACT
              JJ = MAX(J,M)
              MM = MIN(J,M)
              JM = IA(JJ)+MM
              II = MAX(I,M+NCOR)
              MM = MIN(I,M+NCOR)
              IM = IA(II)+MM
              DVAL = DVAL + DIPMO(IM)*OPDM(JM)
            ENDDO
            JI = (J+NCOR-1)*L1 + I
            WRK(JI) = DVAL
  400   CONTINUE
C
C          ----- Add response contributions to dipole derivative -----
C
        DO JXYZ=1,NXYZ
          IJXYZ = (JXYZ-1)*3 + IXYZ
          DDM(IJXYZ) = DDOT(L3,SDER(JXYZ,1,1),NXYZ,WRK,1)
        ENDDO
C
        DO 500 I=1,NACT
          DO 500 J=1,I
            IJ = IA(I+NCOR) + J+NCOR
            IIJJ = IA(I) + J
            DLT = TWO
            IF(I.EQ.J) DLT = ONE
            DLT = DLT*DIPMO(IJ)
            JUNIQ = 0
            DO 450 JXYZ=1,NXYZ
              NJXYZ = NOCP(JXYZ)
              IF(NJXYZ.NE.1) JUNIQ = JUNIQ + 1
              IF(NJXYZ.NE.0) GO TO 450
              JIXYZ = (JXYZ-1)*3 + IXYZ
              DDM(JIXYZ) = DDM(JIXYZ) - DLT*DDEN(JUNIQ,IIJJ)
  450       CONTINUE
  500   CONTINUE
 1000 CONTINUE
C
      RETURN
      END
C*MODULE CPMCHF  *DECK CPCHK1
      SUBROUTINE CPCHK1(MEMREP,IW,NSTATS,NXYZ,NDETMX)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      WRITE(IW,9000)
C
C     1 processor
C
      MEMCON = MEMREP
      MEMDIS = 0
      NDETLN = NDETMX
      MEMDIS = MEMDIS + NXYZ + 2
      MEMCON = MEMCON - MEMDIS*NSTATS*NDETMX
      MEMDIS = MEMDIS*NDETLN*NSTATS
      MEMTOT = MEMCON + MEMDIS
      MWDTOT = MEMTOT/1000000
      IF(MOD(MEMTOT,1000000).GT.0) MWDTOT = MWDTOT + 1
      WRITE(IW,9010) 1,MEMCON,MEMDIS,MWDTOT
C
C     2 processors
C
      MEMCON = MEMREP
      MEMDIS = 0
      NDETLN = NDETMX/2
      IF(MOD(NDETMX,2).GT.0) NDETLN = NDETLN + 1
      MEMDIS = MEMDIS + NXYZ + 2
      MEMCON = MEMCON - MEMDIS*NSTATS*NDETMX
      MEMDIS = MEMDIS*NDETLN*NSTATS
      MEMTOT = MEMCON + MEMDIS
      MWDTOT = MEMTOT/1000000
      IF(MOD(MEMTOT,1000000).GT.0) MWDTOT = MWDTOT + 1
      WRITE(IW,9010) 2,MEMCON,MEMDIS,MWDTOT
C
C     4 processors
C
      MEMCON = MEMREP
      MEMDIS = 0
      NDETLN = NDETMX/4
      IF(MOD(NDETMX,4).GT.0) NDETLN = NDETLN + 1
      MEMDIS = MEMDIS + NXYZ + 2
      MEMCON = MEMCON - MEMDIS*NSTATS*NDETMX
      MEMDIS = MEMDIS*NDETLN*NSTATS
      MEMTOT = MEMCON + MEMDIS
      MWDTOT = MEMTOT/1000000
      IF(MOD(MEMTOT,1000000).GT.0) MWDTOT = MWDTOT + 1
      WRITE(IW,9010) 4,MEMCON,MEMDIS,MWDTOT
C
C     8 processors
C
      MEMCON = MEMREP
      MEMDIS = 0
      NDETLN = NDETMX/8
      IF(MOD(NDETMX,8).GT.0) NDETLN = NDETLN + 1
      MEMDIS = MEMDIS + NXYZ + 2
      MEMCON = MEMCON - MEMDIS*NSTATS*NDETMX
      MEMDIS = MEMDIS*NDETLN*NSTATS
      MEMTOT = MEMCON + MEMDIS
      MWDTOT = MEMTOT/1000000
      IF(MOD(MEMTOT,1000000).GT.0) MWDTOT = MWDTOT + 1
      WRITE(IW,9010) 8,MEMCON,MEMDIS,MWDTOT
C
C     16 processors
C
      MEMCON = MEMREP
      MEMDIS = 0
      NDETLN = NDETMX/16
      IF(MOD(NDETMX,16).GT.0) NDETLN = NDETLN + 1
      MEMDIS = MEMDIS + NXYZ + 2
      MEMCON = MEMCON - MEMDIS*NSTATS*NDETMX
      MEMDIS = MEMDIS*NDETLN*NSTATS
      MEMTOT = MEMCON + MEMDIS
      MWDTOT = MEMTOT/1000000
      IF(MOD(MEMTOT,1000000).GT.0) MWDTOT = MWDTOT + 1
      WRITE(IW,9010) 16,MEMCON,MEMDIS,MWDTOT
C
 9000 FORMAT(/1X,'SETTING UP RIGHT-HAND SIDE OF CPMCHF EQUATIONS.',
     *       /1X,'FOLLOWING TABLE ILLUSTRATES MEMORY REQUIREMENTS.',/,
     *       /11X,'CONSTANT',7X,'SCALABLE',6X,'TOTAL',
     *       /1X,'# CPUS',3X,'REPLICATED',5X,'REPLICATED',5X,'MWORDS',
     *       /1X,6(1H-),3X,10(1H-),5X,10(1H-),5X,6(1H-))
 9010 FORMAT(3X,I2,5X,I10,5X,I10,5X,I4)
      RETURN
      END
C*MODULE CPMCHF  *DECK CPCHK2
      SUBROUTINE CPCHK2(MEMREP,IW,NSTATS,NUNIQ,NXYZ,NDETMX,L3)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      WRITE(IW,9000)
C
C     1 processor
C
      MEMCON = MEMREP
      MEMDIS = 0
      NDETLN = NDETMX
      IF(NSTATS*NDETLN .GT. L3) MEMDIS = 1
      MEMDIS = MEMDIS + 2*NUNIQ + NXYZ + 1
      MEMCON = MEMCON - MEMDIS*NSTATS*NDETMX
      MEMDIS = MEMDIS*NDETLN*NSTATS
      MEMTOT = MEMCON + MEMDIS
      MWDTOT = MEMTOT/1000000
      IF(MOD(MEMTOT,1000000).GT.0) MWDTOT = MWDTOT + 1
      WRITE(IW,9010) 1,MEMCON,MEMDIS,MWDTOT
C
C     2 processors
C
      MEMCON = MEMREP
      MEMDIS = 0
      NDETLN = NDETMX/2
      IF(MOD(NDETMX,2).GT.0) NDETLN = NDETLN + 1
      IF(NSTATS*NDETLN .GT. L3) MEMDIS = 1
      MEMDIS = MEMDIS + 2*NUNIQ + NXYZ + 1
      MEMCON = MEMCON - MEMDIS*NSTATS*NDETMX
      MEMDIS = MEMDIS*NDETLN*NSTATS
      MEMTOT = MEMCON + MEMDIS
      MWDTOT = MEMTOT/1000000
      IF(MOD(MEMTOT,1000000).GT.0) MWDTOT = MWDTOT + 1
      WRITE(IW,9010) 2,MEMCON,MEMDIS,MWDTOT
C
C     4 processors
C
      MEMCON = MEMREP
      MEMDIS = 0
      NDETLN = NDETMX/4
      IF(MOD(NDETMX,4).GT.0) NDETLN = NDETLN + 1
      IF(NSTATS*NDETLN .GT. L3) MEMDIS = 1
      MEMDIS = MEMDIS + 2*NUNIQ + NXYZ + 1
      MEMCON = MEMCON - MEMDIS*NSTATS*NDETMX
      MEMDIS = MEMDIS*NDETLN*NSTATS
      MEMTOT = MEMCON + MEMDIS
      MWDTOT = MEMTOT/1000000
      IF(MOD(MEMTOT,1000000).GT.0) MWDTOT = MWDTOT + 1
      WRITE(IW,9010) 4,MEMCON,MEMDIS,MWDTOT
C
C     8 processors
C
      MEMCON = MEMREP
      MEMDIS = 0
      NDETLN = NDETMX/8
      IF(MOD(NDETMX,8).GT.0) NDETLN = NDETLN + 1
      IF(NSTATS*NDETLN .GT. L3) MEMDIS = 1
      MEMDIS = MEMDIS + 2*NUNIQ + NXYZ + 1
      MEMCON = MEMCON - MEMDIS*NSTATS*NDETMX
      MEMDIS = MEMDIS*NDETLN*NSTATS
      MEMTOT = MEMCON + MEMDIS
      MWDTOT = MEMTOT/1000000
      IF(MOD(MEMTOT,1000000).GT.0) MWDTOT = MWDTOT + 1
      WRITE(IW,9010) 8,MEMCON,MEMDIS,MWDTOT
C
C     16 processors
C
      MEMCON = MEMREP
      MEMDIS = 0
      NDETLN = NDETMX/16
      IF(MOD(NDETMX,16).GT.0) NDETLN = NDETLN + 1
      IF(NSTATS*NDETLN .GT. L3) MEMDIS = 1
      MEMDIS = MEMDIS + 2*NUNIQ + NXYZ + 1
      MEMCON = MEMCON - MEMDIS*NSTATS*NDETMX
      MEMDIS = MEMDIS*NDETLN*NSTATS
      MEMTOT = MEMCON + MEMDIS
      MWDTOT = MEMTOT/1000000
      IF(MOD(MEMTOT,1000000).GT.0) MWDTOT = MWDTOT + 1
      WRITE(IW,9010) 16,MEMCON,MEMDIS,MWDTOT
C
 9000 FORMAT(/1X,'SOLVING CPMCHF EQUATIONS USING CG ALGORITHM.',
     *       /1X,'FOLLOWING TABLE ILLUSTRATES MEMORY REQUIREMENTS.',/,
     *       /11X,'CONSTANT',7X,'SCALABLE',6X,'TOTAL',
     *       /1X,'# CPUS',3X,'REPLICATED',5X,'REPLICATED',5X,'MWORDS',
     *       /1X,6(1H-),3X,10(1H-),5X,10(1H-),5X,6(1H-))
 9010 FORMAT(3X,I2,5X,I10,5X,I10,5X,I4)
      RETURN
      END
C*MODULE CPMCHF  *DECK CPDRDO
C     ----------------------------------------------------------------
      SUBROUTINE CPDRDO(WAXCI,DFC,DERI,CI,FCOR,ERI,PRCNDC,
     *     NCOR,JLO,JHI,NSTATS,NDETLN,
     *     M2,M4,NXYZ,L1,NACT,NCI,NA,NB,
     *     Y,NX,INDEX,NSYM,IOB,
     *     LBOX1,LBOX2,LBOX3,LBOX4,LBOX5,
     *     LGMUL,KTAB,IACON1,IACON2,IBCON1,IBCON2,
     *     LANDET,LBNDET,NAST,NBST,LSYMA,LSYMB,LGCOM,
     *     LSPA,LSPB,LDISB,LSAS,LSBS,LSAC,LSBC,
     *     ITGA,ITGB,IAST,IBST,
     *     IPOSA,IPERA,IIND1,IGROA,IMMC,
     *     NB1EX,JB1GR,JB1PE,JB1IN,JB1PO,JB1ST,IDIM1,IDIM2)
C     ----------------------------------------------------------------
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      LOGICAL FDIRCT,QCORR
C
      COMMON /FCCWFN/ NSPACE,MSTA(51),MNUM(51),MINI(51),MAXI(51),
     *                IAMI(51),IAMA(51),IBMI(51),IBMA(51),IDIM(51),
     *                LBST(51),NREF0,FDIRCT,QCORR,C0SQ
C
      DIMENSION WAXCI(NXYZ,NSTATS*NDETLN),DFC(NXYZ,M2),DERI(NXYZ,M4)
      DIMENSION CI(NCI,NSTATS),FCOR(*),ERI(L1,NACT,M2),PRCNDC(*)
      DIMENSION Y(NX)
      DIMENSION INDEX((NACT*(NACT+1))/2+1),IOB(NACT)
      DIMENSION LBOX1(NSPACE),LBOX2(NSPACE),LBOX3(NSPACE)
      DIMENSION LBOX4(NSPACE),LBOX5(NSPACE)
      DIMENSION LGMUL(NSYM,NSYM),KTAB(NSYM)
      DIMENSION IACON1(NA),IACON2(NA),IBCON1(NA),IBCON2(NA)
      DIMENSION LANDET(NSPACE,ITGA),LBNDET(NSPACE,ITGB)
      DIMENSION NAST(ITGA+1),NBST(ITGB+1)
      DIMENSION LSYMA(IAST),LSYMB(IBST),LGCOM(ITGB,ITGA)
      DIMENSION LSPA(IAST),LSPB(IBST),LDISB(NSYM,ITGB,ITGA)
      DIMENSION LSAS(NSYM+1,ITGA),LSBS(NSYM+1,ITGB)
      DIMENSION LSAC(IAST),LSBC(IBST)
      DIMENSION IPOSA(NA*(NACT-NA),NSYM)
      DIMENSION IPERA(NA*(NACT-NA),NSYM)
      DIMENSION IIND1(NA*(NACT-NA),NSYM)
      DIMENSION IGROA(NA*(NACT-NA),NSYM)
      DIMENSION IMMC(NSYM)
      DIMENSION JB1GR(NB1EX),JB1PE(NB1EX),JB1IN(NB1EX),JB1PO(NB1EX)
      DIMENSION JB1ST(IDIM1,IDIM2)
C
C  --- BIG LOOP OVER ALL ALPHA STRINGS. ---
C
      CALL RESETCO(LBOX1,NSPACE,NA,IAMA,IAMI,LBOX5)
C
      DO 5000 IGA=1,ITGA
C
         CALL RESETDE(LBOX1,NSPACE,NA,MSTA,IACON1)
C
C  KKA GIVES THE ACTUAL POSITION OF THE ALPHA STRING IACON1 IN
C  THE FULL ALPHA STRING LIST.
C
         DO 4900 KKA=NAST(IGA)+1,NAST(IGA+1)
            JPZA1 = LSPA(KKA)
            JASYM = LSYMA(KKA)
            KSYM=KTAB(JASYM)
            DO II=1,NSYM
               IMMC(II)=0
            ENDDO
C
            DO II=1,NSPACE
               LBOX2(II) = LBOX1(II)
            ENDDO
C
C  LOOP OVER SPACES TO EXCITE ELECTRON FROM.
C
            IEAS = NA+1
            DO 4890 ISPA1=NSPACE,1,-1
               IOC1 = LBOX1(ISPA1)
               IEAE = IEAS - 1
               IEAS = IEAS - IOC1
               IF (IOC1.EQ.0) GO TO 4890
               LBOX2(ISPA1) = LBOX2(ISPA1)-1
C
C  LOOP ELECTRONS IN SPACE ISPA1.
C  IEAS, IEAE ARE THE ELECTRONS IN SPACE ISPA1.
C
               DO 4885 IA1=IEAE,IEAS,-1
                  IO1 = IACON1(IA1)
                  IGAE = IEAE - LBOX1(ISPA1)
                  IS1 = IOB(IO1)
C
C  LOOP OVER POSSIBLE SPACES TO EXCITE INTO.
C
               DO 4880 ISPA2=ISPA1,NSPACE
C
C  IGAS, IGAE ARE ELECTRONS SPECIFYING ISPA2 SPACE ELECTRON LIMITS.
C
                  IGAS = IGAE + 1
                  IGAE = IGAE + LBOX1(ISPA2)
C
                  LBOX2(ISPA2) = LBOX2(ISPA2) + 1
                  IF (LBOX2(ISPA1).LT.IAMI(ISPA1)) GO TO 4870
C
C  MAKE GAP INFORMATION HERE.
C
                  IGAA = MAX(IA1+1,IGAS)
                  IF (LBOX1(ISPA2).EQ.0) THEN
                     ISTA = MSTA(ISPA2)
                     IEND = MSTA(ISPA2+1)-1
                  ELSEIF (ISPA2.EQ.ISPA1) THEN
                     ISTA = IO1+1
                     IEND = IACON1(IGAA)-1
                     IF (IA1.EQ.IEAE) IEND=MSTA(ISPA1+1)-1
                  ELSE
                     ISTA = MSTA(ISPA2)
                     IEND = IACON1(IGAA)-1
                  ENDIF
C
C  LOOP OVER GAPS
C
                  DO 4860 IGAP=IGAA,IGAE+1
C
                     DO 4850 JJ=ISTA,IEND
                        IS2 = IOB(JJ)
                        IP1 = LGMUL(IS1,IS2)
C
                     IND = INDEX(JJ) + IO1
C
              CALL REDE00(IACON1,IACON2,NA,IA1,IGAP-1,JJ,JPERA)
              IF (LBOX2(ISPA2).GT.IAMA(ISPA2)) GO TO 4800
C
C  GET GROUP NUMBER
C
           CALL POSITCO(LBOX5,NSPACE,NA,IAMA,IAMI,LBOX4,LBOX2,IGA2)
           NIAS = NAST(IGA2)
C
              CALL IDPOST(IACON2,NA,LBOX2,NSPACE,MSTA,IDIM,Y,NX,LBST,
     *                  LANDET(1,IGA2),IBCON1,JPOSA)
              KAPOS = JPOSA + NIAS
              JPZA2 = LSPA(KAPOS)
              KASYM = LSYMA(KAPOS)
C              KPER1 = ((-1)**JPERA)*2
              KPER1 = (-1)**JPERA
              IMMC(KASYM) = IMMC(KASYM) + 1
              JSPO = IMMC(KASYM)
              IPOSA(JSPO,KASYM) = JPZA2
              IPERA(JSPO,KASYM) = KPER1
              IIND1(JSPO,KASYM) = IND
              IGROA(JSPO,KASYM) = IGA2
C
C   IF DEOCCUPIED AND NEWLY OCCUPIED ORBITALS ARE OF DIFFERENT SYMMETRY,
C   SKIP TO DOUBLES.
C
              IF (IS1.NE.IS2) GO TO 4800
C
C  LOOP OVER APPROPRIATE BETA DETS
C
              DO 1700 IGB=1,ITGB
              IF (LGCOM(IGB,IGA).NE.1.OR.LGCOM(IGB,IGA2).NE.1) GOTO 1700
              JCI1 = JPZA1 + LDISB(KSYM,IGB,IGA)
              JCI2 = JPZA2 + LDISB(KSYM,IGB,IGA2)
C
              DO 1680 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                 JCI1 = JCI1 + 1
                 JCI2 = JCI2 + 1
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = KPER1*CI(JCI2,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DFC(1,IND),1,WAXCI(1,IWI1),1)
                   ENDDO
                 ENDIF
C
                 IF(JCI2.GE.JLO .AND. JCI2.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = KPER1*CI(JCI1,ISTAT)
                     IWI2 = (ISTAT-1)*NDETLN + JCI2 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DFC(1,IND),1,WAXCI(1,IWI2),1)
                   ENDDO
                 ENDIF
C
 1680         CONTINUE
C
 1700         CONTINUE
C
C   DETERMINE THE ALPHA STRING CONTRIBUTION TO THE MATRIX ELEMENT.
C
              DO 4712 IK=1,NA
                 IF (IK.EQ.IA1) GO TO 4712
                 ION = IACON1(IK)
                 J1 = INDEX(ION+1)
                 JMA = MAX(J1,IND)
                 JMI = MIN(J1,IND)
                 JJ1 = INDEX(JMA) + JMI
                 JMA = MAX(ION,JJ)
                 JMI = MIN(ION,JJ)
                 J1 = INDEX(JMA)+JMI
                 JMA = MAX(IO1,ION)
                 JMI = MIN(IO1,ION)
                 J2 = INDEX(JMA)+JMI
                 JMA = MAX(J1,J2)
                 JMI = MIN(J1,J2)
                 INX = INDEX(JMA)+JMI
C
C  LOOP OVER APPROPRIATE BETA DETS
C
              DO 1705 IGB=1,ITGB
              IF (LGCOM(IGB,IGA).NE.1.OR.LGCOM(IGB,IGA2).NE.1) GOTO 1705
              JCI1 = JPZA1 + LDISB(KSYM,IGB,IGA)
              JCI2 = JPZA2 + LDISB(KSYM,IGB,IGA2)
C
              DO 1685 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                 JCI1 = JCI1 + 1
                 JCI2 = JCI2 + 1
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = KPER1*CI(JCI2,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,JJ1),1,WAXCI(1,IWI1),1)
                     CALL DAXPY(NXYZ,-FC,DERI(1,INX),1,WAXCI(1,IWI1),1)
                   ENDDO
                 ENDIF
C
                 IF(JCI2.GE.JLO .AND. JCI2.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = KPER1*CI(JCI1,ISTAT)
                     IWI2 = (ISTAT-1)*NDETLN + JCI2 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,JJ1),1,WAXCI(1,IWI2),1)
                     CALL DAXPY(NXYZ,-FC,DERI(1,INX),1,WAXCI(1,IWI2),1)
                   ENDDO
                 ENDIF
C
 1685         CONTINUE
C
 1705         CONTINUE
C
 4712         CONTINUE
C
C  LOOP OVER BETA DETS OF THE RIGHT GROUP AND SYMMETRY.
C
              CALL RESETCO(LBOX3,NSPACE,NB,IBMA,IBMI,LBOX4)
C
              DO 4700 IGB=1,ITGB
              IF (LGCOM(IGB,IGA).NE.1.OR.LGCOM(IGB,IGA2).NE.1) GOTO 4690
              JCI1 = JPZA1 + LDISB(KSYM,IGB,IGA)
              JCI2 = JPZA2 + LDISB(KSYM,IGB,IGA2)
C
              CALL RESETDE(LBOX3,NSPACE,NB,MSTA,IBCON1)
              ISTB = 1
              DO 4680 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                 IENB = LSBC(KKB)
                 DO IIZ=ISTB,IENB-1
                    CALL MOVEUP2(LBOX3,NSPACE,NB,MSTA,IBCON1)
                 ENDDO
                 ISTB = IENB
                 JCI1 = JCI1 + 1
                 JCI2 = JCI2 + 1
C
                 DO 4670 IK=1,NB
                    ION = IBCON1(IK)
                    J1 = INDEX(ION+1)
                    JMA = MAX(J1,IND)
                    JMI = MIN(J1,IND)
                    JJ1 = INDEX(JMA) + JMI
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = KPER1*CI(JCI2,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,JJ1),1,WAXCI(1,IWI1),1)
                   ENDDO
                 ENDIF
C
                 IF(JCI2.GE.JLO .AND. JCI2.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = KPER1*CI(JCI1,ISTAT)
                     IWI2 = (ISTAT-1)*NDETLN + JCI2 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,JJ1),1,WAXCI(1,IWI2),1)
                   ENDDO
                 ENDIF
C
 4670            CONTINUE
C
 4680         CONTINUE
C
 4690         CALL PUSHCO(LBOX3,NSPACE,NB,IBMA,IBMI,LBOX4,IEND)
 4700         CONTINUE
C
C --  DOUBLE ALPHA EXCITATIONS START HERE  ---
C
 4800         CONTINUE
C
            IF (IA1.EQ.NA) GOTO 4850
            IF (JJ.EQ.NACT) GOTO 4850
C
            DO II=1,NSPACE
               LBOX3(II) = LBOX2(II)
            ENDDO
            IAES3 = 1
            DO KK=1,ISPA1-1
               IAES3 = IAES3 + LBOX2(KK)
            ENDDO
C
C  LOOP OVER SPACES TO EXCITE ELECTRONS FROM, MUST BE GE THAN
C  SPACE OF FIRST EXCITATION, ISPA1.
C
            DO 3890 ISPA3 = ISPA1,NSPACE
               IF (LBOX1(ISPA3).EQ.0) GOTO 3887
               IF (ISPA3.EQ.ISPA1.AND.IA1.EQ.IEAE) GOTO 3887
               IOC3 = LBOX2(ISPA3)
               IF (IOC3.EQ.0) GOTO 3887
C
               IAEE3 = IAES3 + LBOX2(ISPA3)-1
               LBOX3(ISPA3) = LBOX3(ISPA3)-1
C
C  LOOP OVER ELECTRONS IN ISPA3, WHICH ARE LARGER THAN IA1,
C  MAKING SURE IT ISN'T THE ALREADY EXCITED ELECTRON.
C
               JSTA3 = IAES3
               IF (ISPA3.EQ.ISPA1) THEN
                  JSTA3=IA1
                  IF (IGAP-1.EQ.IA1) JSTA3=JSTA3+1
               ENDIF
C
               DO 3880 IA3=JSTA3,IAEE3
                  IF (IA3.EQ.IGAP-1) GOTO 3880
                  IO3 = IACON2(IA3)
                  IS3 = IOB(IO3)
C
C  LOOP OVER SPACES TO EXCITE ELECTRON INTO.  MUST BE GE THAN
C  SPACE FIRST ELECTRON WAS EXCITED INTO.
C
                  IGAE3 = 0
                  DO JIK=1,ISPA2-1
                     IGAE3 = IGAE3 + LBOX2(JIK)
                  ENDDO
                  DO 3850 ISPA4=ISPA2,NSPACE
C
C  IGAS3, IGAE3 ARE ELECTRONS SPECIFYING ISPA4 SPACE ELECTRON LIMITS.
C
                  LBOX3(ISPA4) = LBOX3(ISPA4) + 1
                  IGAS3 = IGAE3 + 1
                  IGAE3 = IGAE3 + LBOX2(ISPA4)
                  IF (LBOX3(ISPA3).LT.IAMI(ISPA3)) GOTO 3840
                  IF (LBOX3(ISPA4).GT.IAMA(ISPA4)) GOTO 3840
             IF (ISPA4.EQ.ISPA2.AND.JJ.EQ.MSTA(ISPA2+1)-1) GOTO 3840
C
C  GET GROUP NUMBER
C
               CALL POSITCO(LBOX5,NSPACE,NA,IAMA,IAMI,LBOX4,LBOX3,IGA3)
               NIAS3 = NAST(IGA3)
C
C  MAKE GAP INFORMATION HERE.
C
                  IGAA3 = MAX(IGAS3,IGAP)
C
                  IF (LBOX2(ISPA4).EQ.0) THEN
                     ISTA3 = MSTA(ISPA4)
                     IEND3 = MSTA(ISPA4+1)-1
                  ELSEIF (ISPA4.EQ.ISPA2) THEN
                     ISTA3 = JJ+1
                     IEND3 = IACON2(IGAA3)-1
C
C  I AM SUSPECT ABOUT THIS NEXT LINE, WE'LL SEE WHAT HAPPENS.......
C
                     IF (IGAP-1.EQ.IGAE3) IEND3=MSTA(ISPA2+1)-1
C
                  ELSE
                     ISTA3 = MSTA(ISPA4)
                     IEND3 = IACON2(IGAA3)-1
                  ENDIF
C
C  LOOP OVER GAPS
C
                  DO 3830 IGAP3=IGAA3,IGAE3+1
C
                     DO 3820 JJ3=ISTA3,IEND3
                        IS4 = IOB(JJ3)
                        IP2 = LGMUL(IS3,IS4)
                        IF (IP1.NE.IP2) GOTO 3820
C
              CALL REDE00(IACON2,IBCON1,NA,IA3,IGAP3-1,JJ3,JPERA3)
              CALL IDPOST(IBCON1,NA,LBOX3,NSPACE,MSTA,IDIM,Y,NX,LBST,
     *                  LANDET(1,IGA3),IBCON2,JPOSA3)
C              IPER3 = ((-1)**(JPERA3+JPERA))*2
              IPER3 = (-1)**(JPERA3+JPERA)
              KAPOS3 = JPOSA3 + NIAS3
              JPZA3 = LSPA(KAPOS3)
                 JMA=MAX(JJ3,IO3)
                 JMI=MIN(JJ3,IO3)
                 I2 = INDEX(JMA) + JMI
                 INX = INDEX(I2) + IND
                 II1 = INDEX(JJ3) + IO1
                 JMA=MAX(IO3,JJ)
                 JMI=MIN(IO3,JJ)
                 II2 = INDEX(JMA) + JMI
                 JMA=MAX(II1,II2)
                 JMI=MIN(II1,II2)
                 INX2 = INDEX(JMA) + JMI
C
C  LOOP OVER BETA STRINGS OF RIGHT SYMMETRY AND GROUP.
C
              DO 3700 IGB=1,ITGB
              IF (LGCOM(IGB,IGA).NE.1.OR.LGCOM(IGB,IGA3).NE.1) GOTO 3700
              JCI1 = JPZA1 + LDISB(KSYM,IGB,IGA)
              JCI3 = JPZA3 + LDISB(KSYM,IGB,IGA3)
C
              DO 3680 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                 JCI1 = JCI1 + 1
                 JCI3 = JCI3 + 1
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = IPER3*CI(JCI3,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,INX),1,WAXCI(1,IWI1),1)
                     CALL DAXPY(NXYZ,-FC,DERI(1,INX2),1,WAXCI(1,IWI1),1)
                   ENDDO
                 ENDIF
C
                 IF(JCI3.GE.JLO .AND. JCI3.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = IPER3*CI(JCI1,ISTAT)
                     IWI3 = (ISTAT-1)*NDETLN + JCI3 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,INX),1,WAXCI(1,IWI3),1)
                     CALL DAXPY(NXYZ,-FC,DERI(1,INX2),1,WAXCI(1,IWI3),1)
                   ENDDO
                 ENDIF
C
 3680         CONTINUE
C
 3700         CONTINUE
C
 3820                CONTINUE
C
                     ISTA3 = IACON2(IGAP3)+1
                     IEND3 = IACON2(IGAP3+1)-1
                     IF (IGAP3.EQ.IGAE3) IEND3=MSTA(ISPA4+1)-1
 3830             CONTINUE
C
 3840             LBOX3(ISPA4) = LBOX3(ISPA4) - 1
 3850             CONTINUE
C
 3880          CONTINUE
C
               LBOX3(ISPA3) = LBOX3(ISPA3)+1
 3887          IAES3 = IAES3 + LBOX3(ISPA3)
 3890       CONTINUE
C
 4850                CONTINUE
C
                  ISTA = IACON1(IGAP)+1
                  IEND = IACON1(IGAP+1)-1
                  IF (IGAP.EQ.IGAE) IEND=MSTA(ISPA2+1)-1
 4860             CONTINUE
C
 4870             LBOX2(ISPA2) = LBOX2(ISPA2) - 1
 4880          CONTINUE
C
 4885          CONTINUE
C
               LBOX2(ISPA1) = LBOX2(ISPA1)+1
 4890       CONTINUE
C
C  DIAGONAL ELEMENTS HERE
C
            DO 67 II=1,NA
               I1 = IACON1(II)
               IND1 = INDEX(I1+1)
               IIFC = ((NCOR+I1)*(NCOR+I1+1))/2
C
C  LOOP OVER BETA STRINGS OF RIGHT SYMMETRY AND GROUP.
C
              DO 3705 IGB=1,ITGB
              IF (LGCOM(IGB,IGA).NE.1) GOTO 3705
              JCI1 = JPZA1 + LDISB(KSYM,IGB,IGA)
C
              DO 3685 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                 JCI1 = JCI1 + 1
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = CI(JCI1,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DFC(1,IND1),1,WAXCI(1,IWI1),1)
                     PRCNDC(IWI1) = PRCNDC(IWI1) + FCOR(IIFC)
                   ENDDO
                 ENDIF
C
 3685         CONTINUE
C
 3705         CONTINUE
C
              DO 64 JJ=II+1,NA
                 I2 = IACON1(JJ)
                 IND2 = INDEX(I2+1)
                 INDM = IND2 - I2 + I1
                 J1 = INDEX(INDM+1)
                 J2 = INDEX(IND2) + IND1
C
              DO 3710 IGB=1,ITGB
              IF (LGCOM(IGB,IGA).NE.1) GOTO 3710
              JCI1 = JPZA1 + LDISB(KSYM,IGB,IGA)
C
              DO 3690 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                 JCI1 = JCI1 + 1
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = CI(JCI1,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,J2),1,WAXCI(1,IWI1),1)
                     CALL DAXPY(NXYZ,-FC,DERI(1,J1),1,WAXCI(1,IWI1),1)
                     PRCNDC(IWI1) = PRCNDC(IWI1) + ERI(I1+NCOR,I1,IND2)
                     PRCNDC(IWI1) = PRCNDC(IWI1) - ERI(I1+NCOR,I2,INDM)
                   ENDDO
                 ENDIF
C
 3690         CONTINUE
C
 3710         CONTINUE
C
   64         CONTINUE
C
C  LOOP OVER BETA DETS OF THE RIGHT GROUP AND SYMMETRY.
C
              CALL RESETCO(LBOX3,NSPACE,NB,IBMA,IBMI,LBOX4)
C
              DO 4709 IGB=1,ITGB
              IF (LGCOM(IGB,IGA).NE.1) GOTO 4699
              JCI1 = JPZA1 + LDISB(KSYM,IGB,IGA)
C
              CALL RESETDE(LBOX3,NSPACE,NB,MSTA,IBCON1)
              ISTB = 1
              DO 4689 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                 IENB = LSBC(KKB)
                 DO IIZ=ISTB,IENB-1
                    CALL MOVEUP2(LBOX3,NSPACE,NB,MSTA,IBCON1)
                 ENDDO
                 ISTB = IENB
                 JCI1 = JCI1 + 1
                 IF(JCI1.LT.JLO .OR. JCI1.GT.JHI) GO TO 4689
C
                 DO 4679 IK=1,NB
                    I2 = IBCON1(IK)
                    IND2 = INDEX(I2+1)
                    JMI = MIN(IND1,IND2)
                    JMA = MAX(IND1,IND2)
                    J2 = INDEX(JMA) + JMI
C
                    DO ISTAT=1,NSTATS
                      FC = CI(JCI1,ISTAT)
                      IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                      CALL DAXPY(NXYZ,FC,DERI(1,J2),1,WAXCI(1,IWI1),1)
                      PRCNDC(IWI1) = PRCNDC(IWI1) + ERI(I1+NCOR,I1,IND2)
                    ENDDO
C
 4679            CONTINUE
C
 4689         CONTINUE
C
 4699         CALL PUSHCO(LBOX3,NSPACE,NB,IBMA,IBMI,LBOX4,IEND)
 4709         CONTINUE
C
   67       CONTINUE
C
C  --- END OF LOOP OVER SINGLE ALPHA EXCITATIONS. ---
C      NOW TO SORT THEM BY POSITIONS WITHIN SYMMETRIES.
C
            DO II=1,NSYM
               CALL FCCSRT3(IGROA(1,II),IPERA(1,II),IIND1(1,II),
     *                   IPOSA(1,II),IMMC(II))
            ENDDO
C
C  --- END OF LOOP OVER PURE ALPHA EXCITATIONS.
C  NOW TO LOOP OVER ALL SIMULTANEOUS AB -> A'B' EXCITATIONS.
C
      IF (NSPACE.EQ.1) GOTO 3400
C
C  ***** GENERAL CASE OF MORE THAN ONE SPACE !!!!! *******
C
      IF (.NOT.FDIRCT) THEN
C
C  LOOP OVER SINGLE ALPHA EXCITES WITHIN EACH SYMMETRY.
C
      DO 3000 ISAE=1,NSYM
         KBSYM=KTAB(ISAE)
         DO 2900 JSAE=1,IMMC(ISAE)
            JPOSAE=IPOSA(JSAE,ISAE)
            JPERAE=IPERA(JSAE,ISAE)
            JINDAE=IIND1(JSAE,ISAE)
            JGROAE=IGROA(JSAE,ISAE)
C
C  IF ISAE.EQ.JASYM THEN SPECIAL CASE.
C
       IF (ISAE.EQ.JASYM.AND.IGA.EQ.JGROAE) THEN
C
C  LOOP OVER ALL RELEVANT BETAS
C
            LABPOS = JPZA1
            LABPOS2 = JPOSAE
            DO 2813 IGB=1,ITGB
               IF (LGCOM(IGB,IGA).NE.1) GOTO 2813
               NIBS = NBST(IGB)
               DO 2763 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                  LABPOS = LABPOS + 1
                  LABPOS2 = LABPOS2 + 1
                  IBPOS = NIBS + LSBC(KKB)
C
C  LOOP OVER SINGLE BETA EXCITES FROM IBPOS
C
               DO 2613 JBINDX=JB1ST(KBSYM,IBPOS),JB1ST(KBSYM+1,IBPOS)-1
                  IGB2=JB1GR(JBINDX)
                  IF (LGCOM(IGB2,JGROAE).NE.1) GOTO 2613
C
                  JMA=MAX(JINDAE,JB1IN(JBINDX))
                  JMI=MIN(JINDAE,JB1IN(JBINDX))
                  IX=INDEX(JMA)+JMI
                  JCIB=JPOSAE+LDISB(KBSYM,IGB2,JGROAE)+JB1PO(JBINDX)
                  JCIB2=JPZA1+LDISB(KBSYM,IGB2,JGROAE)+JB1PO(JBINDX)
C
                 IF(LABPOS.GE.JLO .AND. LABPOS.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = JPERAE*JB1PE(JBINDX)*CI(JCIB,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + LABPOS - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,IX),1,WAXCI(1,IWI1),1)
                   ENDDO
                 ENDIF
C
                 IF(JCIB.GE.JLO .AND. JCIB.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = JPERAE*JB1PE(JBINDX)*CI(LABPOS,ISTAT)
                     IWIB = (ISTAT-1)*NDETLN + JCIB - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,IX),1,WAXCI(1,IWIB),1)
                   ENDDO
                 ENDIF
C
                 IF(LABPOS2.GE.JLO .AND. LABPOS2.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = JPERAE*JB1PE(JBINDX)*CI(JCIB2,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + LABPOS2 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,IX),1,WAXCI(1,IWI1),1)
                   ENDDO
                 ENDIF
C
                 IF(JCIB2.GE.JLO .AND. JCIB2.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = JPERAE*JB1PE(JBINDX)*CI(LABPOS2,ISTAT)
                     IWIB = (ISTAT-1)*NDETLN + JCIB2 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,IX),1,WAXCI(1,IWIB),1)
                   ENDDO
                 ENDIF
C
 2613          CONTINUE
C
 2763          CONTINUE
 2813       CONTINUE
C
       ELSE
C
C  LOOP OVER ALL RELEVANT (A-)BETA DETS.
C
            LABPOS = JPZA1
            DO 2800 IGB=1,ITGB
               IF (LGCOM(IGB,IGA).NE.1) GOTO 2800
               NIBS = NBST(IGB)
               DO 2750 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                  LABPOS = LABPOS + 1
                  IBPOS = NIBS + LSBC(KKB)
C
C  LOOP OVER SINGLE BETA EXCITES FROM IBPOS
C
               DO 2600 JBINDX=JB1ST(KBSYM,IBPOS),JB1ST(KBSYM+1,IBPOS)-1
                  IGB2=JB1GR(JBINDX)
                  IF (LGCOM(IGB2,JGROAE).NE.1) GOTO 2600
C
                  JMA=MAX(JINDAE,JB1IN(JBINDX))
                  JMI=MIN(JINDAE,JB1IN(JBINDX))
                  IX=INDEX(JMA)+JMI
                  JCIB=JPOSAE+LDISB(KBSYM,IGB2,JGROAE)+JB1PO(JBINDX)
C
                 IF(LABPOS.GE.JLO .AND. LABPOS.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = JPERAE*JB1PE(JBINDX)*CI(JCIB,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + LABPOS - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,IX),1,WAXCI(1,IWI1),1)
                   ENDDO
                 ENDIF
C
                 IF(JCIB.GE.JLO .AND. JCIB.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = JPERAE*JB1PE(JBINDX)*CI(LABPOS,ISTAT)
                     IWIB = (ISTAT-1)*NDETLN + JCIB - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,IX),1,WAXCI(1,IWIB),1)
                   ENDDO
                 ENDIF
C
 2600          CONTINUE
C
 2750          CONTINUE
 2800       CONTINUE
C
C  LOOP OVER ALL RELEVANT (A'-)BETA DETS.
C
            LABPOS = JPOSAE
            DO 2803 IGB=1,ITGB
               IF (LGCOM(IGB,JGROAE).NE.1) GOTO 2803
               NIBS = NBST(IGB)
               DO 2753 KKB=LSBS(KBSYM,IGB),LSBS(KBSYM+1,IGB)-1
                  LABPOS = LABPOS + 1
                  IBPOS = NIBS + LSBC(KKB)
C
C  LOOP OVER SINGLE BETA EXCITES FROM IBPOS
C
               DO 2603 JBINDX=JB1ST(KSYM,IBPOS),JB1ST(KSYM+1,IBPOS)-1
                  IGB2=JB1GR(JBINDX)
                  IF (LGCOM(IGB2,IGA).NE.1) GOTO 2603
C
                  JMA=MAX(JINDAE,JB1IN(JBINDX))
                  JMI=MIN(JINDAE,JB1IN(JBINDX))
                  IX=INDEX(JMA)+JMI
                  JCIB=JPZA1+LDISB(KSYM,IGB2,IGA)+JB1PO(JBINDX)
C
                 IF(LABPOS.GE.JLO .AND. LABPOS.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = JPERAE*JB1PE(JBINDX)*CI(JCIB,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + LABPOS - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,IX),1,WAXCI(1,IWI1),1)
                   ENDDO
                 ENDIF
C
                 IF(JCIB.GE.JLO .AND. JCIB.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = JPERAE*JB1PE(JBINDX)*CI(LABPOS,ISTAT)
                     IWIB = (ISTAT-1)*NDETLN + JCIB - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,IX),1,WAXCI(1,IWIB),1)
                   ENDDO
                 ENDIF
C
 2603          CONTINUE
C
 2753          CONTINUE
 2803       CONTINUE
C
      ENDIF
C
 2900    CONTINUE
 3000 CONTINUE
C
      ELSE
C
C  ***** DIRECT METHOD BELOW *****
C
      DO 4000 ISAE=1,NSYM
         KBSYM = KTAB(ISAE)
C
C  ANALYSE EXCITED A' GROUPS FOR COMPATIBILITY WITH B.
C
      NGRPS = 0
      DO 1976 II=1,IMMC(ISAE)
         ICGR = IGROA(II,ISAE)
         DO JJ=1,NGRPS
            IF (JB1GR(JJ).EQ.ICGR) GOTO 1976
         ENDDO
         NGRPS = NGRPS + 1
         JB1GR(NGRPS) = ICGR
 1976 CONTINUE
C
C FIRST TYPE OF BETAS, KSYM -> KBSYM
C
          CALL RESETCO(LBOX2,NSPACE,NB,IBMA,IBMI,LBOX3)
          DO 7400 IGB=1,ITGB
             IF (LGCOM(IGB,IGA).NE.1) GOTO 7399
             LAB1 = JPZA1 + LDISB(KSYM,IGB,IGA)
C
             CALL RESETDE(LBOX2,NSPACE,NB,MSTA,IBCON1)
             NIBS = NBST(IGB)
             ISTB = 1
             DO 7300 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                IENB = LSBC(KKB)
                DO IIZ=ISTB,IENB-1
                   CALL MOVEUP2(LBOX2,NSPACE,NB,MSTA,IBCON1)
                ENDDO
                ISTB = IENB
C
                IBPOS = NIBS + LSBC(KKB)
                LABPOS = LAB1 + LSPB(IBPOS)
C
C LOOP OVER SINGLE BETA EXCITES FROM IBPOS WHICH ARE OF SYMMETRY KBSYM
C
                MESYM1 = LGMUL(KSYM,KBSYM)
                DO II=1,NSPACE
                   LBOX3(II) = LBOX2(II)
                ENDDO
                IEBS = NB + 1
                DO 7290 ISPB1=NSPACE,1,-1
                   IOC1 = LBOX2(ISPB1)
                   IEBE = IEBS - 1
                   IEBS = IEBS - IOC1
                   IF (IOC1.EQ.0) GO TO 7290
                   LBOX3(ISPB1) = LBOX3(ISPB1)-1
C
C  LOOP ELECTRONS IN SPACE ISPB1
C  IEBS, IEBE ARE THE ELECTRONS IN SPACE ISPB1
C
                DO 7285 IB1 = IEBE,IEBS,-1
                   IO1 = IBCON1(IB1)
                   MESYM2 = LGMUL(MESYM1,IOB(IO1))
                   IGBE = IEBE - LBOX2(ISPB1)
C
C  LOOP OVER POSSIBLE SPACES TO EXCITE INTO.
C
                DO 7280 ISPB2=ISPB1,NSPACE
C
C  IGBS,IGBE ARE ELECTRONS SPECIFYING ISPB2 SPACE ELECTRON LIMITS.
C
                   IGBS = IGBE + 1
                   IGBE = IGBE + LBOX2(ISPB2)
C
                   LBOX3(ISPB2) = LBOX3(ISPB2) + 1
                   IF (LBOX3(ISPB1).LT.IBMI(ISPB1)) GO TO 7270
                   IF (LBOX3(ISPB2).GT.IBMA(ISPB2)) GO TO 7270
C
C  GET GROUP NUMBER
C
          CALL POSITCO(LBOX5,NSPACE,NB,IBMA,IBMI,LBOX4,LBOX3,IGB2)
          NIAS = NBST(IGB2)
C
C CHECK FOR A' GROUP COMPATIBILITY
C
             DO II=1,NGRPS
                IAGRP = JB1GR(II)
                IF (LGCOM(IGB2,IAGRP).EQ.1) GOTO 7555
             ENDDO
             GOTO 7270
 7555        CONTINUE
C
C  MAKE GAP INFORMATION HERE.
C
                  IGBA = MAX(IB1+1,IGBS)
                  IF (LBOX2(ISPB2).EQ.0) THEN
                     ISTA = MSTA(ISPB2)
                     IEND = MSTA(ISPB2+1)-1
                  ELSEIF (ISPB2.EQ.ISPB1) THEN
                     ISTA = IO1+1
                     IEND = IBCON1(IGBA)-1
                     IF (IB1.EQ.IEBE) IEND=MSTA(ISPB1+1)-1
                  ELSE
                     ISTA = MSTA(ISPB2)
                     IEND = IBCON1(IGBA)-1
                  ENDIF
C
C  LOOP OVER GAPS
C
                  DO 7260 IGAP=IGBA,IGBE+1
C
                     DO 7250 JJ=ISTA,IEND
C
C CHECK TO SEE IF EXCITED BETA IS OF RIGHT SYMMETRY (KBSYM)
C
            IF (IOB(JJ).NE.MESYM2) GOTO 7250
C
            IND1 = INDEX(JJ) + IO1
            CALL REDE00(IBCON1,IBCON2,NB,IB1,IGAP-1,JJ,IPER)
            CALL IDPOST(IBCON2,NB,LBOX3,NSPACE,MSTA,IDIM,Y,NX,LBST,
     *                  LBNDET(1,IGB2),IACON2,IPOSB)
            QJPER = ((-1)**IPER)
            JB1P = LSPB(IPOSB + NIAS)
C
            DO 3900 JSAE=1,IMMC(ISAE)
               JGROAE=IGROA(JSAE,ISAE)
               IF (LGCOM(IGB2,JGROAE).NE.1) GOTO 3900
C
               JPOSAE=IPOSA(JSAE,ISAE)
               JCIB = JB1P + JPOSAE + LDISB(KBSYM,IGB2,JGROAE)
C
               JINDAE=IIND1(JSAE,ISAE)
               JMA=MAX(JINDAE,IND1)
               JMI=MIN(JINDAE,IND1)
               IX=INDEX(JMA)+JMI
C
               JPERAE=IPERA(JSAE,ISAE)
C
                 IF(LABPOS.GE.JLO .AND. LABPOS.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = JPERAE*QJPER*CI(JCIB,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + LABPOS - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,IX),1,WAXCI(1,IWI1),1)
                   ENDDO
                 ENDIF
C
                 IF(JCIB.GE.JLO .AND. JCIB.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = JPERAE*QJPER*CI(LABPOS,ISTAT)
                     IWIB = (ISTAT-1)*NDETLN + JCIB - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,IX),1,WAXCI(1,IWIB),1)
                   ENDDO
                 ENDIF
C
 3900       CONTINUE
C
 7250                CONTINUE
C
                  ISTA = IBCON1(IGAP)+1
                  IEND = IBCON1(IGAP+1)-1
                  IF (IGAP.EQ.IGBE) IEND=MSTA(ISPB2+1)-1
 7260             CONTINUE
C
 7270              LBOX3(ISPB2) = LBOX3(ISPB2) - 1
 7280           CONTINUE
C
 7285           CONTINUE
C
                   LBOX3(ISPB1) = LBOX3(ISPB1) + 1
 7290           CONTINUE
C
 7300        CONTINUE
C
 7399        CALL PUSHCO(LBOX2,NSPACE,NB,IBMA,IBMI,LBOX3,IEND)
 7400     CONTINUE
C
C
C SECOND TYPE OF BETAS, KBSYM -> KSYM
C
          CALL RESETCO(LBOX2,NSPACE,NB,IBMA,IBMI,LBOX3)
          DO 7801 IGB=1,ITGB
C
C CHECK FOR A' GROUP COMPATIBILITY
C
             DO II=1,NGRPS
                IAGRP = JB1GR(II)
                IF (LGCOM(IGB,IAGRP).EQ.1) GOTO 7655
             ENDDO
             GOTO 7799
 7655        CONTINUE
C
             CALL RESETDE(LBOX2,NSPACE,NB,MSTA,IBCON1)
             NIBS = NBST(IGB)
             ISTB = 1
C
             DO 7701 KKB=LSBS(KBSYM,IGB),LSBS(KBSYM+1,IGB)-1
                IENB = LSBC(KKB)
                DO IIZ=ISTB,IENB-1
                   CALL MOVEUP2(LBOX2,NSPACE,NB,MSTA,IBCON1)
                ENDDO
                ISTB = IENB
C
                IBPOS = NIBS + LSBC(KKB)
                LAB1 = LSPB(IBPOS)
C
C LOOP OVER SINGLE BETA EXCITES FROM IBPOS WHICH ARE OF SYMMETRY KSYM
C
                MESYM1 = LGMUL(KSYM,KBSYM)
                DO II=1,NSPACE
                   LBOX3(II) = LBOX2(II)
                ENDDO
                IEBS = NB + 1
                DO 7691 ISPB1=NSPACE,1,-1
                   IOC1 = LBOX2(ISPB1)
                   IEBE = IEBS - 1
                   IEBS = IEBS - IOC1
                   IF (IOC1.EQ.0) GO TO 7691
                   LBOX3(ISPB1) = LBOX3(ISPB1)-1
C
C  LOOP ELECTRONS IN SPACE ISPB1
C  IEBS, IEBE ARE THE ELECTRONS IN SPACE ISPB1
C
                DO 7686 IB1 = IEBE,IEBS,-1
                   IO1 = IBCON1(IB1)
                   MESYM2 = LGMUL(MESYM1,IOB(IO1))
                   IGBE = IEBE - LBOX2(ISPB1)
C
C  LOOP OVER POSSIBLE SPACES TO EXCITE INTO.
C
                DO 7681 ISPB2=ISPB1,NSPACE
C
C  IGBS,IGBE ARE ELECTRONS SPECIFYING ISPB2 SPACE ELECTRON LIMITS.
C
                   IGBS = IGBE + 1
                   IGBE = IGBE + LBOX2(ISPB2)
C
                   LBOX3(ISPB2) = LBOX3(ISPB2) + 1
                   IF (LBOX3(ISPB1).LT.IBMI(ISPB1)) GO TO 7671
                   IF (LBOX3(ISPB2).GT.IBMA(ISPB2)) GO TO 7671
C
          CALL POSITCO(LBOX5,NSPACE,NB,IBMA,IBMI,LBOX4,LBOX3,IGB2)
          IF (LGCOM(IGB2,IGA).NE.1) GOTO 7671
          JCIBS = JPZA1 + LDISB(KSYM,IGB2,IGA)
          NIAS = NBST(IGB2)
C
C  MAKE GAP INFORMATION HERE.
C
                  IGBA = MAX(IB1+1,IGBS)
                  IF (LBOX2(ISPB2).EQ.0) THEN
                     ISTA = MSTA(ISPB2)
                     IEND = MSTA(ISPB2+1)-1
                  ELSEIF (ISPB2.EQ.ISPB1) THEN
                     ISTA = IO1+1
                     IEND = IBCON1(IGBA)-1
                     IF (IB1.EQ.IEBE) IEND=MSTA(ISPB1+1)-1
                  ELSE
                     ISTA = MSTA(ISPB2)
                     IEND = IBCON1(IGBA)-1
                  ENDIF
C
C  LOOP OVER GAPS
C
                  DO 7660 IGAP=IGBA,IGBE+1
C
                     DO 7650 JJ=ISTA,IEND
C
C CHECK TO SEE IF EXCITED BETA IS OF RIGHT SYMMETRY (KBSYM)
C
            IF (IOB(JJ).NE.MESYM2) GOTO 7650
C
            IND1 = INDEX(JJ) + IO1
            CALL REDE00(IBCON1,IBCON2,NB,IB1,IGAP-1,JJ,IPER)
            CALL IDPOST(IBCON2,NB,LBOX3,NSPACE,MSTA,IDIM,Y,NX,LBST,
     *                  LBNDET(1,IGB2),IACON2,IPOSB)
            QJPER = ((-1)**IPER)
            JCIB= JCIBS + LSPB(IPOSB + NIAS)
C
            DO 4300 JSAE=1,IMMC(ISAE)
               JGROAE=IGROA(JSAE,ISAE)
               IF (LGCOM(IGB,JGROAE).NE.1) GOTO 4300
C
               JPOSAE=IPOSA(JSAE,ISAE)
               LABPOS = LAB1 + JPOSAE + LDISB(KBSYM,IGB,JGROAE)
C
               JINDAE=IIND1(JSAE,ISAE)
               JMA=MAX(JINDAE,IND1)
               JMI=MIN(JINDAE,IND1)
               IX=INDEX(JMA)+JMI
C
               JPERAE=IPERA(JSAE,ISAE)
C
                 IF(LABPOS.GE.JLO .AND. LABPOS.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = JPERAE*QJPER*CI(JCIB,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + LABPOS - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,IX),1,WAXCI(1,IWI1),1)
                   ENDDO
                 ENDIF
C
                 IF(JCIB.GE.JLO .AND. JCIB.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = JPERAE*QJPER*CI(LABPOS,ISTAT)
                     IWIB = (ISTAT-1)*NDETLN + JCIB - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,IX),1,WAXCI(1,IWIB),1)
                   ENDDO
                 ENDIF
C
 4300       CONTINUE
C
 7650                CONTINUE
C
                  ISTA = IBCON1(IGAP)+1
                  IEND = IBCON1(IGAP+1)-1
                  IF (IGAP.EQ.IGBE) IEND=MSTA(ISPB2+1)-1
 7660             CONTINUE
C
 7671              LBOX3(ISPB2) = LBOX3(ISPB2) - 1
 7681           CONTINUE
C
 7686           CONTINUE
C
                   LBOX3(ISPB1) = LBOX3(ISPB1) + 1
 7691           CONTINUE
C
 7701        CONTINUE
C
 7799        CALL PUSHCO(LBOX2,NSPACE,NB,IBMA,IBMI,LBOX3,IEND)
 7801     CONTINUE
C
 4000 CONTINUE
C
      ENDIF
C
C  ***** END OF DIRECT OPTION *****
C
C  **** END OF GENERAL CASE OF MORE THAN ONE SPACE ******
C
      GOTO 4899
C
 3400 CONTINUE
C
C ***** SPECIAL CASE OF ONE SPACE !!!!! ******
C
C  LOOP OVER SINGLE ALPHA EXCITES WITHIN EACH SYMMETRY.
C
       DO 2901 ISAE=1,NSYM
          KBSYM=KTAB(ISAE)
          DO 2801 JSAE=1,IMMC(ISAE)
                JPOSAE=IPOSA(JSAE,ISAE)
                JPERAE=IPERA(JSAE,ISAE)
                JINDAE=IIND1(JSAE,ISAE)
                JGROAE=IGROA(JSAE,ISAE)
C
C  IF ISAE.EQ.JASYM THEN SPECIAL CASE.
C
       IF (ISAE.EQ.JASYM) THEN
C
C  LOOP OVER ALL RELEVANT BETAS
C
             LABPOS=JPZA1
             LABPOS2=JPOSAE
                DO 2721 KKB=LSBS(KSYM,1),LSBS(KSYM+1,1)-1
                    LABPOS = LABPOS + 1
                    LABPOS2 = LABPOS2 + 1
                    IBPOS =  LSBC(KKB)
C
C  LOOP OVER SINGLE BETA EXCITES FROM IBPOS
C
               DO 2621 JBINDX=JB1ST(KSYM,IBPOS),JB1ST(KSYM+1,IBPOS)-1
                  JMA=MAX(JINDAE,JB1IN(JBINDX))
                  JMI=MIN(JINDAE,JB1IN(JBINDX))
                  IX=INDEX(JMA)+JMI
                  JCIB = JPOSAE+JB1PO(JBINDX)
                  JCIB2 = JPZA1+JB1PO(JBINDX)
C
                 IF(LABPOS.GE.JLO .AND. LABPOS.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = JPERAE*JB1PE(JBINDX)*CI(JCIB,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + LABPOS - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,IX),1,WAXCI(1,IWI1),1)
                   ENDDO
                 ENDIF
C
                 IF(JCIB.GE.JLO .AND. JCIB.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = JPERAE*JB1PE(JBINDX)*CI(LABPOS,ISTAT)
                     IWIB = (ISTAT-1)*NDETLN + JCIB - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,IX),1,WAXCI(1,IWIB),1)
                   ENDDO
                 ENDIF
C
                 IF(LABPOS2.GE.JLO .AND. LABPOS2.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = JPERAE*JB1PE(JBINDX)*CI(JCIB2,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + LABPOS2 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,IX),1,WAXCI(1,IWI1),1)
                   ENDDO
                 ENDIF
C
                 IF(JCIB2.GE.JLO .AND. JCIB2.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = JPERAE*JB1PE(JBINDX)*CI(LABPOS2,ISTAT)
                     IWIB = (ISTAT-1)*NDETLN + JCIB2 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,IX),1,WAXCI(1,IWIB),1)
                   ENDDO
                 ENDIF
C
 2621          CONTINUE
C
 2721          CONTINUE
C
      ELSE
C
C  LOOP OVER ALL RELEVANT (A-)BETA DETS.
C
                LABPOS = JPZA1
                DO 2751 KKB=LSBS(KSYM,1),LSBS(KSYM+1,1)-1
                    LABPOS = LABPOS + 1
                    IBPOS =  LSBC(KKB)
C
C  LOOP OVER SINGLE BETA EXCITES FROM IBPOS
C
               DO 2601 JBINDX=JB1ST(KBSYM,IBPOS),JB1ST(KBSYM+1,IBPOS)-1
C
                  JMA=MAX(JINDAE,JB1IN(JBINDX))
                  JMI=MIN(JINDAE,JB1IN(JBINDX))
                  IX=INDEX(JMA)+JMI
                  JCIB=JPOSAE+JB1PO(JBINDX)
C
                 IF(LABPOS.GE.JLO .AND. LABPOS.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = JPERAE*JB1PE(JBINDX)*CI(JCIB,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + LABPOS - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,IX),1,WAXCI(1,IWI1),1)
                   ENDDO
                 ENDIF
C
                 IF(JCIB.GE.JLO .AND. JCIB.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = JPERAE*JB1PE(JBINDX)*CI(LABPOS,ISTAT)
                     IWIB = (ISTAT-1)*NDETLN + JCIB - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,IX),1,WAXCI(1,IWIB),1)
                   ENDDO
                 ENDIF
C
 2601          CONTINUE
C
 2751          CONTINUE
C
C  LOOP OVER ALL RELEVANT (A'-)BETA DETS.
C
               LABPOS = JPOSAE
               DO 2761 KKB=LSBS(KBSYM,1),LSBS(KBSYM+1,1)-1
                  LABPOS = LABPOS + 1
                  IBPOS = LSBC(KKB)
C
C  LOOP OVER SINGLE BETA EXCITES FROM IBPOS
C
               DO 2611 JBINDX=JB1ST(KSYM,IBPOS),JB1ST(KSYM+1,IBPOS)-1
C
                  JMA=MAX(JINDAE,JB1IN(JBINDX))
                  JMI=MIN(JINDAE,JB1IN(JBINDX))
                  IX=INDEX(JMA)+JMI
                  JCIB=JPZA1+JB1PO(JBINDX)
C
                 IF(LABPOS.GE.JLO .AND. LABPOS.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = JPERAE*JB1PE(JBINDX)*CI(JCIB,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + LABPOS - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,IX),1,WAXCI(1,IWI1),1)
                   ENDDO
                 ENDIF
C
                 IF(JCIB.GE.JLO .AND. JCIB.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = JPERAE*JB1PE(JBINDX)*CI(LABPOS,ISTAT)
                     IWIB = (ISTAT-1)*NDETLN + JCIB - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,IX),1,WAXCI(1,IWIB),1)
                   ENDDO
                 ENDIF
C
 2611          CONTINUE
C
 2761          CONTINUE
C
      ENDIF
C
 2801       CONTINUE
 2901   CONTINUE
C
C  **** END OF SPECIAL CASE OF ONE SPACE *******
C
 4899       CALL MOVEUP2(LBOX1,NSPACE,NA,MSTA,IACON1)
 4900    CONTINUE
C
         CALL PUSHCO(LBOX1,NSPACE,NA,IAMA,IAMI,LBOX5,IEND)
 5000 CONTINUE
C
C  --- END OF LOOP OVER ALPHA STRINGS. ---
C **
C  --- LOOP OVER ALL PURE BETA EXCITATIONS.
C
      CALL RESETCO(LBOX1,NSPACE,NB,IBMA,IBMI,LBOX5)
C
      DO 8000 IGB=1,ITGB
C
         CALL RESETDE(LBOX1,NSPACE,NB,MSTA,IBCON1)
C
C  KKB GIVES THE ACTUAL POSITION OF THE BETA STRING IBCON1 IN
C  THE FULL BETA STRING LIST.
C
         DO 7900 KKB=NBST(IGB)+1,NBST(IGB+1)
            JPZB1 = LSPB(KKB)
            KBSYM = LSYMB(KKB)
            KSYM=KTAB(KBSYM)
C
            DO II=1,NSPACE
               LBOX2(II) = LBOX1(II)
            ENDDO
C
C  LOOP OVER SPACES TO EXCITE ELECTRON FROM.
C
            IEBS = NB+1
            DO 7890 ISPB1=NSPACE,1,-1
               IOC1 = LBOX1(ISPB1)
               IEBE = IEBS - 1
               IEBS = IEBS - IOC1
               IF (IOC1.EQ.0) GOTO 7890
               LBOX2(ISPB1) = LBOX2(ISPB1)-1
C
C  LOOP ELECTRONS IN SPACE ISPB1.
C  IEBS, IEBE ARE THE ELECTRONS IN SPACE ISPB1.
C
               DO 7885 IB1=IEBE,IEBS,-1
                  IO1 = IBCON1(IB1)
                  IGBE = IEBE - LBOX1(ISPB1)
                  IS1 = IOB(IO1)
C
C  LOOP OVER POSSIBLE SPACES TO EXCITE INTO.
C
               DO 7880 ISPB2=ISPB1,NSPACE
C
C  IGBS, IGBE ARE ELECTRONS SPECIFYING ISPB2 SPACE ELECTRON LIMITS.
C
                  IGBS = IGBE + 1
                  IGBE = IGBE + LBOX1(ISPB2)
C
                  LBOX2(ISPB2) = LBOX2(ISPB2) + 1
                  IF (LBOX2(ISPB1).LT.IBMI(ISPB1)) GOTO 7870
C
C  MAKE GAP INFORMATION HERE.
C
                  IGBB = MAX(IB1+1,IGBS)
                  IF (LBOX1(ISPB2).EQ.0) THEN
                     ISTA = MSTA(ISPB2)
                     IEND = MSTA(ISPB2+1)-1
                  ELSEIF (ISPB2.EQ.ISPB1) THEN
                     ISTA = IO1+1
                     IEND = IBCON1(IGBB)-1
                     IF (IB1.EQ.IEBE) IEND=MSTA(ISPB1+1)-1
                  ELSE
                     ISTA = MSTA(ISPB2)
                     IEND = IBCON1(IGBB)-1
                  ENDIF
C
C  LOOP OVER GAPS
C
                  DO 7860 IGAP=IGBB,IGBE+1
C
                     DO 7850 JJ=ISTA,IEND
                        IS2 = IOB(JJ)
                        IP1 = LGMUL(IS1,IS2)
                        IND = INDEX(JJ) + IO1
C
              CALL REDE00(IBCON1,IBCON2,NB,IB1,IGAP-1,JJ,JPERB)
                  IF (LBOX2(ISPB2).GT.IBMA(ISPB2)) GOTO 7800
C
C   IF DEOCCUPIED AND NEWLY OCCUPIED ORBITALS ARE OF DIFFERENT SYMMETRY,
C   SKIP TO DOUBLES.
C
              IF (IS1.NE.IS2) GOTO 7800
C
C  GET GROUP NUMBER
C
           CALL POSITCO(LBOX5,NSPACE,NB,IBMA,IBMI,LBOX4,LBOX2,IGB2)
           NIBS = NBST(IGB2)
C
              CALL IDPOST(IBCON2,NB,LBOX2,NSPACE,MSTA,IDIM,Y,NX,LBST,
     *                  LBNDET(1,IGB2),IACON1,JPOSB)
              KBPOS = JPOSB + NIBS
              JPZB2 = LSPB(KBPOS)
C              KPER1 = ((-1)**JPERB)*2
              KPER1 = (-1)**JPERB
C
C  LOOP OVER ALPHA
C
              DO 7705 IGA=1,ITGA
              IF (LGCOM(IGB,IGA).NE.1.OR.LGCOM(IGB2,IGA).NE.1) GOTO 7705
                 JCIB1 = LDISB(KBSYM,IGB,IGA) + JPZB1
                 JCIB2 = LDISB(KBSYM,IGB2,IGA) + JPZB2
                 NIAS = NAST(IGA)
C
              DO 7685 KKA=LSAS(KSYM,IGA),LSAS(KSYM+1,IGA)-1
                 IENA1 = LSAC(KKA)
                 JCIA = LSPA(NIAS+IENA1)
                 JCI1 = JCIA + JCIB1
                 JCI2 = JCIA + JCIB2
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = KPER1*CI(JCI2,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DFC(1,IND),1,WAXCI(1,IWI1),1)
                   ENDDO
                 ENDIF
C
                 IF(JCI2.GE.JLO .AND. JCI2.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = KPER1*CI(JCI1,ISTAT)
                     IWI2 = (ISTAT-1)*NDETLN + JCI2 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DFC(1,IND),1,WAXCI(1,IWI2),1)
                   ENDDO
                 ENDIF
C
 7685         CONTINUE
C
 7705         CONTINUE
C
              DO 7712 IK=1,NB
                 IF (IK.EQ.IB1) GOTO 7712
                 ION = IBCON1(IK)
                 J1 = INDEX(ION+1)
                 JMA = MAX(J1,IND)
                 JMI = MIN(J1,IND)
                 JJ1 = INDEX(JMA) + JMI
                 JMA = MAX(ION,JJ)
                 JMI = MIN(ION,JJ)
                 J1 = INDEX(JMA)+JMI
                 JMA = MAX(IO1,ION)
                 JMI = MIN(IO1,ION)
                 J2 = INDEX(JMA)+JMI
                 JMA = MAX(J1,J2)
                 JMI = MIN(J1,J2)
                 INX = INDEX(JMA)+JMI
C
              DO 7710 IGA=1,ITGA
              IF (LGCOM(IGB,IGA).NE.1.OR.LGCOM(IGB2,IGA).NE.1) GOTO 7710
                 JCIB1 = LDISB(KBSYM,IGB,IGA) + JPZB1
                 JCIB2 = LDISB(KBSYM,IGB2,IGA) + JPZB2
                 NIAS = NAST(IGA)
C
              DO 7695 KKA=LSAS(KSYM,IGA),LSAS(KSYM+1,IGA)-1
                 IENA1 = LSAC(KKA)
                 JCIA = LSPA(NIAS+IENA1)
                 JCI1 = JCIA + JCIB1
                 JCI2 = JCIA + JCIB2
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = KPER1*CI(JCI2,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,JJ1),1,WAXCI(1,IWI1),1)
                     CALL DAXPY(NXYZ,-FC,DERI(1,INX),1,WAXCI(1,IWI1),1)
                   ENDDO
                 ENDIF
C
                 IF(JCI2.GE.JLO .AND. JCI2.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = KPER1*CI(JCI1,ISTAT)
                     IWI2 = (ISTAT-1)*NDETLN + JCI2 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,JJ1),1,WAXCI(1,IWI2),1)
                     CALL DAXPY(NXYZ,-FC,DERI(1,INX),1,WAXCI(1,IWI2),1)
                   ENDDO
                 ENDIF
C
 7695         CONTINUE
C
 7710         CONTINUE
C
 7712         CONTINUE
C
C  LOOP OVER ALPHA STRINGS OF THE RIGHT GROUP AND SYMMETRY.
C
              CALL RESETCO(LBOX3,NSPACE,NA,IAMA,IAMI,LBOX4)
C
              DO 7700 IGA=1,ITGA
              IF (LGCOM(IGB,IGA).NE.1.OR.LGCOM(IGB2,IGA).NE.1) GOTO 7690
                 JCIB1 = LDISB(KBSYM,IGB,IGA) + JPZB1
                 JCIB2 = LDISB(KBSYM,IGB2,IGA) + JPZB2
                 NIAS = NAST(IGA)
C
              CALL RESETDE(LBOX3,NSPACE,NA,MSTA,IACON1)
              ISTA1 = 1
              DO 7680 KKA=LSAS(KSYM,IGA),LSAS(KSYM+1,IGA)-1
                 IENA1 = LSAC(KKA)
                 DO IIZ=ISTA1,IENA1-1
                    CALL MOVEUP2(LBOX3,NSPACE,NA,MSTA,IACON1)
                 ENDDO
                 ISTA1 = IENA1
                 JCIA = LSPA(NIAS+IENA1)
                 JCI1 = JCIA + JCIB1
                 JCI2 = JCIA + JCIB2
C
                 DO 7670 IK=1,NA
                    ION = IACON1(IK)
                    J1 = INDEX(ION+1)
                    JMA = MAX(J1,IND)
                    JMI = MIN(J1,IND)
                    JJ1 = INDEX(JMA) + JMI
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = KPER1*CI(JCI2,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,JJ1),1,WAXCI(1,IWI1),1)
                   ENDDO
                 ENDIF
C
                 IF(JCI2.GE.JLO .AND. JCI2.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = KPER1*CI(JCI1,ISTAT)
                     IWI2 = (ISTAT-1)*NDETLN + JCI2 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,JJ1),1,WAXCI(1,IWI2),1)
                   ENDDO
                 ENDIF
C
 7670            CONTINUE
C
 7680         CONTINUE
C
 7690         CALL PUSHCO(LBOX3,NSPACE,NA,IAMA,IAMI,LBOX4,IEND)
 7700         CONTINUE
C
C  --- DOUBLE EXCITATIONS START HERE
C
 7800         CONTINUE
C
           IF (IB1.EQ.NB) GOTO 7850
           IF (JJ.EQ.NACT) GOTO 7850
C
            DO II=1,NSPACE
               LBOX3(II) = LBOX2(II)
            ENDDO
            IBES3 = 1
            DO KK=1,ISPB1-1
               IBES3 = IBES3 + LBOX2(KK)
            ENDDO
C
C  LOOP OVER SPACES TO EXCITE ELECTRONS FROM, MUST BE GE THAN
C  SPACE OF FIRST EXCITATION, ISPB1.
C
            DO 6890 ISPB3 = ISPB1,NSPACE
               IF (LBOX1(ISPB3).EQ.0) GOTO 6887
               IF (ISPB3.EQ.ISPB1.AND.IB1.EQ.IEBE) GOTO 6887
               IOC3 = LBOX2(ISPB3)
               IF (IOC3.EQ.0) GOTO 6887
C
               IBEE3 = IBES3 + LBOX2(ISPB3)-1
               LBOX3(ISPB3) = LBOX3(ISPB3)-1
C
C  LOOP OVER ELECTRONS IN ISPB3, WHICH ARE LARGER THAN IB1,
C  MAKING SURE IT ISN'T THE ALREADY EXCITED ELECTRON.
C
               JSTB3 = IBES3
               IF (ISPB3.EQ.ISPB1) THEN
                  JSTB3=IB1
                  IF (IGAP-1.EQ.IB1) JSTB3=JSTB3+1
               ENDIF
C
               DO 6880 IB3=JSTB3,IBEE3
                  IF (IB3.EQ.IGAP-1) GOTO 6880
                  IO3 = IBCON2(IB3)
                  IS3 = IOB(IO3)
C
C  LOOP OVER SPACES TO EXCITE ELECTRON INTO.  MUST BE GE THAN
C  SPACE FIRST ELECTRON WAS EXCITED INTO.
C
                  IGBE3 = 0
                  DO JIK=1,ISPB2-1
                     IGBE3 = IGBE3 + LBOX2(JIK)
                  ENDDO
                  DO 6850 ISPB4=ISPB2,NSPACE
C
C  IGBS3, IGBE3 ARE ELECTRONS SPECIFYING ISPB4 SPACE ELECTRON LIMITS.
C
                  LBOX3(ISPB4) = LBOX3(ISPB4) + 1
                  IGBS3 = IGBE3 + 1
                  IGBE3 = IGBE3 + LBOX2(ISPB4)
                  IF (LBOX3(ISPB3).LT.IBMI(ISPB3)) GOTO 6840
                  IF (LBOX3(ISPB4).GT.IBMA(ISPB4)) GOTO 6840
             IF (ISPB4.EQ.ISPB2.AND.JJ.EQ.MSTA(ISPB2+1)-1) GOTO 6840
C
C  GET GROUP NUMBER
C
               CALL POSITCO(LBOX5,NSPACE,NB,IBMA,IBMI,LBOX4,LBOX3,IGB3)
               NIBS3 = NBST(IGB3)
C
C  MAKE GAP INFORMATION HERE.
C
                  IGBB3 = MAX(IGBS3,IGAP)
C
                  IF (LBOX2(ISPB4).EQ.0) THEN
                     ISTA3 = MSTA(ISPB4)
                     IEND3 = MSTA(ISPB4+1)-1
                  ELSEIF (ISPB4.EQ.ISPB2) THEN
                     ISTA3 = JJ+1
                     IEND3 = IBCON2(IGBB3)-1
C
C  I AM SUSPECT ABOUT THIS NEXT LINE, WE'LL SEE WHAT HAPPENS.......
C
                     IF (IGAP-1.EQ.IGBE3) IEND3=MSTA(ISPB2+1)-1
C
                  ELSE
                     ISTA3 = MSTA(ISPB4)
                     IEND3 = IBCON2(IGBB3)-1
                  ENDIF
C
C  LOOP OVER GAPS
C
                  DO 6830 IGAP3=IGBB3,IGBE3+1
C
                     DO 6820 JJ3=ISTA3,IEND3
                        IS4 = IOB(JJ3)
                        IP2 = LGMUL(IS3,IS4)
                        IF (IP1.NE.IP2) GOTO 6820
C
              CALL REDE00(IBCON2,IACON1,NB,IB3,IGAP3-1,JJ3,JPERB3)
              CALL IDPOST(IACON1,NB,LBOX3,NSPACE,MSTA,IDIM,Y,NX,LBST,
     *                  LBNDET(1,IGB3),IACON2,JPOSB3)
C              IPER3 = ((-1)**(JPERB3+JPERB))*2
              IPER3 = (-1)**(JPERB3+JPERB)
              KBPOS3 = JPOSB3 + NIBS3
              JPZB3 = LSPB(KBPOS3)
C
                 JMA=MAX(JJ3,IO3)
                 JMI=MIN(JJ3,IO3)
                 I2 = INDEX(JMA) + JMI
                 INX = INDEX(I2) + IND
                 II1 = INDEX(JJ3) + IO1
                 JMA=MAX(IO3,JJ)
                 JMI=MIN(IO3,JJ)
                 II2 = INDEX(JMA) + JMI
                 JMA=MAX(II1,II2)
                 JMI=MIN(II1,II2)
                 INX2 = INDEX(JMA) + JMI
C
C  LOOP OVER ALPHA STRINGS OF RIGHT SYMMETRY AND GROUP.
C
              DO 6700 IGA=1,ITGA
              IF (LGCOM(IGB,IGA).NE.1.OR.LGCOM(IGB3,IGA).NE.1) GOTO 6700
              JCIB1 = JPZB1 + LDISB(KBSYM,IGB,IGA)
              JCIB3 = JPZB3 + LDISB(KBSYM,IGB3,IGA)
              NIAS = NAST(IGA)
C
              DO 6680 KKA=LSAS(KSYM,IGA),LSAS(KSYM+1,IGA)-1
                 IENA3 = LSAC(KKA)
                 JCIA = LSPA(NIAS+IENA3)
                 JCI1 = JCIA + JCIB1
                 JCI3 = JCIA + JCIB3
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = IPER3*CI(JCI3,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,INX),1,WAXCI(1,IWI1),1)
                     CALL DAXPY(NXYZ,-FC,DERI(1,INX2),1,WAXCI(1,IWI1),1)
                   ENDDO
                 ENDIF
C
                 IF(JCI3.GE.JLO .AND. JCI3.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = IPER3*CI(JCI1,ISTAT)
                     IWI3 = (ISTAT-1)*NDETLN + JCI3 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,INX),1,WAXCI(1,IWI3),1)
                     CALL DAXPY(NXYZ,-FC,DERI(1,INX2),1,WAXCI(1,IWI3),1)
                   ENDDO
                 ENDIF
C
 6680         CONTINUE
C
 6700         CONTINUE
C
 6820                CONTINUE
C
                     ISTA3 = IBCON2(IGAP3)+1
                     IEND3 = IBCON2(IGAP3+1)-1
                     IF (IGAP3.EQ.IGBE3) IEND3=MSTA(ISPB4+1)-1
 6830             CONTINUE
C
 6840             LBOX3(ISPB4) = LBOX3(ISPB4) - 1
 6850             CONTINUE
C
 6880          CONTINUE
C
               LBOX3(ISPB3) = LBOX3(ISPB3)+1
 6887          IBES3 = IBES3 + LBOX3(ISPB3)
 6890       CONTINUE
C
C  --- END OF LOOP OVER DOUBLE BETA EXCITATIONS.
C
 7850                CONTINUE
C
                  ISTA = IBCON1(IGAP)+1
                  IEND = IBCON1(IGAP+1)-1
                  IF (IGAP.EQ.IGBE) IEND=MSTA(ISPB2+1)-1
 7860             CONTINUE
C
 7870             LBOX2(ISPB2) = LBOX2(ISPB2) - 1
 7880          CONTINUE
C
 7885          CONTINUE
C
               LBOX2(ISPB1) = LBOX2(ISPB1)+1
 7890       CONTINUE
C
C REMAINING DIAGONAL CONTRIBUTIONS HERE
C
            DO 69 II=1,NB
               I1 = IBCON1(II)
               IND1 = INDEX(I1+1)
               IIFC = ((NCOR+I1)*(NCOR+I1+1))/2
C
              DO 6705 IGA=1,ITGA
              IF (LGCOM(IGB,IGA).NE.1) GOTO 6705
              JCIB1 = JPZB1 + LDISB(KBSYM,IGB,IGA)
              NIAS = NAST(IGA)
C
              DO 6685 KKA=LSAS(KSYM,IGA),LSAS(KSYM+1,IGA)-1
                 IENA3 = LSAC(KKA)
                 JCIA = LSPA(NIAS+IENA3)
                 JCI1 = JCIA + JCIB1
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = CI(JCI1,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DFC(1,IND1),1,WAXCI(1,IWI1),1)
                     PRCNDC(IWI1) = PRCNDC(IWI1) + FCOR(IIFC)
                   ENDDO
                 ENDIF
C
 6685         CONTINUE
C
 6705         CONTINUE
C
              DO 74 JJ=II+1,NB
                 I2 = IBCON1(JJ)
                 IND2 = INDEX(I2+1)
                 INDM = IND2 - I2 + I1
                 J1 = INDEX(INDM+1)
                 JMI = MIN(IND1,IND2)
                 JMA = MAX(IND1,IND2)
                 J2 = INDEX(JMA) + JMI
C
              DO 6710 IGA=1,ITGA
              IF (LGCOM(IGB,IGA).NE.1) GOTO 6710
              JCIB1 = JPZB1 + LDISB(KBSYM,IGB,IGA)
              NIAS = NAST(IGA)
C
              DO 6690 KKA=LSAS(KSYM,IGA),LSAS(KSYM+1,IGA)-1
                 IENA3 = LSAC(KKA)
                 JCIA = LSPA(NIAS+IENA3)
                 JCI1 = JCIA + JCIB1
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     FC = CI(JCI1,ISTAT)
                     IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                     CALL DAXPY(NXYZ,FC,DERI(1,J2),1,WAXCI(1,IWI1),1)
                     CALL DAXPY(NXYZ,-FC,DERI(1,J1),1,WAXCI(1,IWI1),1)
                     PRCNDC(IWI1) = PRCNDC(IWI1) + ERI(I1+NCOR,I1,IND2)
                     PRCNDC(IWI1) = PRCNDC(IWI1) - ERI(I1+NCOR,I2,INDM)
                   ENDDO
                 ENDIF
C
 6690         CONTINUE
C
 6710         CONTINUE
C
   74         CONTINUE
C
   69         CONTINUE
C
            CALL MOVEUP2(LBOX1,NSPACE,NB,MSTA,IBCON1)
 7900    CONTINUE
C
         CALL PUSHCO(LBOX1,NSPACE,NB,IBMA,IBMI,LBOX5,IEND)
 8000 CONTINUE
C
C  --- END OF LOOP OVER BETA STRINGS. ---
C
C ----    END OF DENSITY MATRIX GENERATION ----------
C
      RETURN
      END
C*MODULE CPMCHF  *DECK HSSCX1
C     ----------------------------------------------------------------
      SUBROUTINE HSSCX1(AVEC,YAC,YAO,AMAT,OINT,IROT,INDEX2,BVEC,
     *     RHSC,RHSO,YADEN,ERI,WRK,YAOG,YAOTMP,WSTATE,SALAG,CI,
     *     NCOR,JLO,JHI,NSTATS,NDETLN,ITER,NINDX,
     *     NROT,NXYZ,L1,NACT,NCI,NA,NB,
     *     Y,NX,INDEX,NSYM,IOB,
     *     LBOX1,LBOX2,LBOX3,LBOX4,LBOX5,
     *     LGMUL,KTAB,IACON1,IACON2,IBCON1,IBCON2,
     *     LANDET,LBNDET,NAST,NBST,LSYMA,LSYMB,LGCOM,
     *     LSPA,LSPB,LDISB,LSAS,LSBS,LSAC,LSBC,
     *     ITGA,ITGB,IAST,IBST,
     *     IPOSA,IPERA,IIND1,IGROA,IMMC,
     *     NB1EX,JB1GR,JB1PE,JB1IN,JB1PO,JB1ST,JB1IN2,IIND2,IIND3,
     *     IDIM1,IDIM2,JROTLO,JROTHI)
C     ----------------------------------------------------------------
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      LOGICAL GOPARR,DSKWRK,MASWRK,FDIRCT,QCORR
      LOGICAL RUN,KILL
C
      COMMON /FCCWFN/ NSPACE,MSTA(51),MNUM(51),MINI(51),MAXI(51),
     *                IAMI(51),IAMA(51),IBMI(51),IBMA(51),IDIM(51),
     *                LBST(51),NREF0,FDIRCT,QCORR,C0SQ
      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
C
      DIMENSION AVEC(*),YAC(NXYZ,NSTATS*NCI),YAO(NXYZ,NROT),AMAT(*)
      DIMENSION CI(NCI,NSTATS),OINT(L1,L1),IROT(L1,L1)
      DIMENSION INDEX2(NINDX,NINDX),BVEC(*),RHSC(NXYZ,NSTATS*NDETLN)
      DIMENSION RHSO(NXYZ,NROT),YADEN(*),ERI(*),WRK(*),YAOG(NXYZ)
      DIMENSION YAOTMP(*),WSTATE(*),SALAG(*)
      DIMENSION Y(NX)
      DIMENSION INDEX((NACT*(NACT+1))/2+1),IOB(NACT)
      DIMENSION LBOX1(NSPACE),LBOX2(NSPACE),LBOX3(NSPACE)
      DIMENSION LBOX4(NSPACE),LBOX5(NSPACE)
      DIMENSION LGMUL(NSYM,NSYM),KTAB(NSYM)
      DIMENSION IACON1(NA),IACON2(NA),IBCON1(NA),IBCON2(NA)
      DIMENSION LANDET(NSPACE,ITGA),LBNDET(NSPACE,ITGB)
      DIMENSION NAST(ITGA+1),NBST(ITGB+1)
      DIMENSION LSYMA(IAST),LSYMB(IBST),LGCOM(ITGB,ITGA)
      DIMENSION LSPA(IAST),LSPB(IBST),LDISB(NSYM,ITGB,ITGA)
      DIMENSION LSAS(NSYM+1,ITGA),LSBS(NSYM+1,ITGB)
      DIMENSION LSAC(IAST),LSBC(IBST)
      DIMENSION IPOSA(NA*(NACT-NA),NSYM)
      DIMENSION IPERA(NA*(NACT-NA),NSYM)
      DIMENSION IIND1(NA*(NACT-NA),NSYM)
      DIMENSION IIND2(NA*(NACT-NA),NSYM),IIND3(NA*(NACT-NA),NSYM)
      DIMENSION IGROA(NA*(NACT-NA),NSYM)
      DIMENSION IMMC(NSYM)
      DIMENSION JB1GR(NB1EX),JB1PE(NB1EX),JB1IN(NB1EX),JB1PO(NB1EX)
      DIMENSION JB1ST(IDIM1,IDIM2),JB1IN2(NB1EX,2)
C
      PARAMETER (TOL=1.0D-09,ONE=1.0D+00)
C
      M1 = NACT
      NNACT = (M1*M1+M1)/2
      KILL = .FALSE.
      RUN = .FALSE.
C
      DO 7 I=1,NINDX
         DO 8 J=1,I
            INDEX2(I,J) = I*(I-1)/2 + J
            INDEX2(J,I) = INDEX2(I,J)
    8    CONTINUE
    7 CONTINUE
C
      CALL FMAVEC(AVEC,YAO,AMAT,OINT,IROT,INDEX2,L1,NCOR,NACT,NNACT,
     *            NXYZ,NROT,NINDX,JROTLO,JROTHI)
      IF(GOPARR) CALL DDI_GSUMF(2178,AVEC,NXYZ*NNACT)
      CALL VCLR(BVEC,1,NXYZ*NNACT)
C
C  --- BIG LOOP OVER ALL ALPHA STRINGS. ---
C
      CALL RESETCO(LBOX1,NSPACE,NA,IAMA,IAMI,LBOX5)
C
      DO 5000 IGA=1,ITGA
C
         CALL RESETDE(LBOX1,NSPACE,NA,MSTA,IACON1)
C
C  KKA GIVES THE ACTUAL POSITION OF THE ALPHA STRING IACON1 IN
C  THE FULL ALPHA STRING LIST.
C
         DO 4900 KKA=NAST(IGA)+1,NAST(IGA+1)
            JPZA1 = LSPA(KKA)
            JASYM = LSYMA(KKA)
            KSYM=KTAB(JASYM)
            DO II=1,NSYM
               IMMC(II)=0
            ENDDO
C
            DO II=1,NSPACE
               LBOX2(II) = LBOX1(II)
            ENDDO
C
C  LOOP OVER SPACES TO EXCITE ELECTRON FROM.
C
            IEAS = NA+1
            DO 4890 ISPA1=NSPACE,1,-1
               IOC1 = LBOX1(ISPA1)
               IEAE = IEAS - 1
               IEAS = IEAS - IOC1
               IF (IOC1.EQ.0) GO TO 4890
               LBOX2(ISPA1) = LBOX2(ISPA1)-1
C
C  LOOP ELECTRONS IN SPACE ISPA1.
C  IEAS, IEAE ARE THE ELECTRONS IN SPACE ISPA1.
C
               DO 4885 IA1=IEAE,IEAS,-1
                  IO1 = IACON1(IA1)
                  IGAE = IEAE - LBOX1(ISPA1)
                  IS1 = IOB(IO1)
C
C  LOOP OVER POSSIBLE SPACES TO EXCITE INTO.
C
               DO 4880 ISPA2=ISPA1,NSPACE
C
C  IGAS, IGAE ARE ELECTRONS SPECIFYING ISPA2 SPACE ELECTRON LIMITS.
C
                  IGAS = IGAE + 1
                  IGAE = IGAE + LBOX1(ISPA2)
C
                  LBOX2(ISPA2) = LBOX2(ISPA2) + 1
                  IF (LBOX2(ISPA1).LT.IAMI(ISPA1)) GO TO 4870
C
C  MAKE GAP INFORMATION HERE.
C
                  IGAA = MAX(IA1+1,IGAS)
                  IF (LBOX1(ISPA2).EQ.0) THEN
                     ISTA = MSTA(ISPA2)
                     IEND = MSTA(ISPA2+1)-1
                  ELSEIF (ISPA2.EQ.ISPA1) THEN
                     ISTA = IO1+1
                     IEND = IACON1(IGAA)-1
                     IF (IA1.EQ.IEAE) IEND=MSTA(ISPA1+1)-1
                  ELSE
                     ISTA = MSTA(ISPA2)
                     IEND = IACON1(IGAA)-1
                  ENDIF
C
C  LOOP OVER GAPS
C
                  DO 4860 IGAP=IGAA,IGAE+1
C
                     DO 4850 JJ=ISTA,IEND
                        IS2 = IOB(JJ)
                        IP1 = LGMUL(IS1,IS2)
C
                     IND = INDEX(JJ) + IO1
C
              CALL REDE00(IACON1,IACON2,NA,IA1,IGAP-1,JJ,JPERA)
              IF (LBOX2(ISPA2).GT.IAMA(ISPA2)) GO TO 4800
C
C  GET GROUP NUMBER
C
           CALL POSITCO(LBOX5,NSPACE,NA,IAMA,IAMI,LBOX4,LBOX2,IGA2)
           NIAS = NAST(IGA2)
C
              CALL IDPOST(IACON2,NA,LBOX2,NSPACE,MSTA,IDIM,Y,NX,LBST,
     *                  LANDET(1,IGA2),IBCON1,JPOSA)
              KAPOS = JPOSA + NIAS
              JPZA2 = LSPA(KAPOS)
              KASYM = LSYMA(KAPOS)
C              KPER1 = ((-1)**JPERA)*2
              KPER1 = (-1)**JPERA
              IMMC(KASYM) = IMMC(KASYM) + 1
              JSPO = IMMC(KASYM)
              IPOSA(JSPO,KASYM) = JPZA2
              IPERA(JSPO,KASYM) = KPER1
              IIND1(JSPO,KASYM) = IND
              IIND2(JSPO,KASYM) = IO1
              IIND3(JSPO,KASYM) = JJ
              IGROA(JSPO,KASYM) = IGA2
C
C   IF DEOCCUPIED AND NEWLY OCCUPIED ORBITALS ARE OF DIFFERENT SYMMETRY,
C   SKIP TO DOUBLES.
C
              IF (IS1.NE.IS2) GO TO 4800
C
C  LOOP OVER APPROPRIATE BETA DETS
C
              DO 1700 IGB=1,ITGB
              IF (LGCOM(IGB,IGA).NE.1.OR.LGCOM(IGB,IGA2).NE.1) GOTO 1700
              JCI1 = JPZA1 + LDISB(KSYM,IGB,IGA)
              JCI2 = JPZA2 + LDISB(KSYM,IGB,IGA2)
C
              DO 1680 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                 JCI1 = JCI1 + 1
                 JCI2 = JCI2 + 1
                 FC = KPER1
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   CALL HSMLT1(AVEC,YAC,BVEC,RHSC,CI,OINT,AMAT,
     *                         FC,JCI1,JCI2,IND,IO1,JJ,JLO,
     *                         NSTATS,NCI,NDETLN,L1,NCOR,
     *                         NNACT,NXYZ,WSTATE,SALAG,ITER)
                 ENDIF
C
                 IF(JCI2.GE.JLO .AND. JCI2.LE.JHI) THEN
                   CALL HSMLT1(AVEC,YAC,BVEC,RHSC,CI,OINT,AMAT,
     *                         FC,JCI2,JCI1,IND,IO1,JJ,JLO,
     *                         NSTATS,NCI,NDETLN,L1,NCOR,
     *                         NNACT,NXYZ,WSTATE,SALAG,ITER)
                 ENDIF
C
 1680         CONTINUE
C
 1700         CONTINUE
C
C   DETERMINE THE ALPHA STRING CONTRIBUTION TO THE MATRIX ELEMENT.
C
              DO 4712 IK=1,NA
                 IF (IK.EQ.IA1) GO TO 4712
                 ION = IACON1(IK)
                 J1 = INDEX(ION+1)
                 JMA = MAX(J1,IND)
                 JMI = MIN(J1,IND)
                 JMA = MAX(ION,JJ)
                 JMI = MIN(ION,JJ)
                 J2 = INDEX(JMA)+JMI
                 JMA = MAX(IO1,ION)
                 JMI = MIN(IO1,ION)
                 J3 = INDEX(JMA)+JMI
                 JMA = MAX(J2,J3)
                 JMI = MIN(J2,J3)
C
                 CALL VCLR(YAOG,1,NXYZ)
                 CALL HSMLTN(YAOG,YAOTMP,IO1,JJ,ION,ION,IND,J1,NACT,
     *                       NNACT,NXYZ,ONE)
                 CALL HSMLTN(YAOG,YAOTMP,IO1,ION,ION,JJ,J3,J2,NACT,
     *                       NNACT,NXYZ,-ONE)
C
C
C  LOOP OVER APPROPRIATE BETA DETS
C
              DO 1705 IGB=1,ITGB
              IF (LGCOM(IGB,IGA).NE.1.OR.LGCOM(IGB,IGA2).NE.1) GOTO 1705
              JCI1 = JPZA1 + LDISB(KSYM,IGB,IGA)
              JCI2 = JPZA2 + LDISB(KSYM,IGB,IGA2)
C
              DO 1685 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                 JCI1 = JCI1 + 1
                 JCI2 = JCI2 + 1
                 FC = KPER1
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     CVAL = CI(JCI2,ISTAT)
                     WVAL = WSTATE(ISTAT)
                     IF(ABS(CVAL).GT.TOL) THEN
                       IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                       DVAL = CVAL*WVAL*FC
                       CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI1),1)
                     ENDIF
                   ENDDO
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         FC,JCI1,JCI2,IO1,JJ,ION,ION,IND,J1,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         -FC,JCI1,JCI2,IO1,ION,ION,JJ,J3,J2,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                 ENDIF
C
                 IF(JCI2.GE.JLO .AND. JCI2.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     CVAL = CI(JCI1,ISTAT)
                     WVAL = WSTATE(ISTAT)
                     IF(ABS(CVAL).GT.TOL) THEN
                       IWI2 = (ISTAT-1)*NDETLN + JCI2 - JLO + 1
                       DVAL = CVAL*WVAL*FC
                       CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI2),1)
                     ENDIF
                   ENDDO
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         FC,JCI2,JCI1,IO1,JJ,ION,ION,IND,J1,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         -FC,JCI2,JCI1,IO1,ION,ION,JJ,J3,J2,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                 ENDIF
C
 1685         CONTINUE
C
 1705         CONTINUE
C
 4712         CONTINUE
C
C  LOOP OVER BETA DETS OF THE RIGHT GROUP AND SYMMETRY.
C
              CALL RESETCO(LBOX3,NSPACE,NB,IBMA,IBMI,LBOX4)
C
              DO 4700 IGB=1,ITGB
              IF (LGCOM(IGB,IGA).NE.1.OR.LGCOM(IGB,IGA2).NE.1) GOTO 4690
              JCI1 = JPZA1 + LDISB(KSYM,IGB,IGA)
              JCI2 = JPZA2 + LDISB(KSYM,IGB,IGA2)
C
              CALL RESETDE(LBOX3,NSPACE,NB,MSTA,IBCON1)
              ISTB = 1
              DO 4680 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                 IENB = LSBC(KKB)
                 DO IIZ=ISTB,IENB-1
                    CALL MOVEUP2(LBOX3,NSPACE,NB,MSTA,IBCON1)
                 ENDDO
                 ISTB = IENB
                 JCI1 = JCI1 + 1
                 JCI2 = JCI2 + 1
                 FC = KPER1
C
                 DO 4670 IK=1,NB
                    ION = IBCON1(IK)
                    J1 = INDEX(ION+1)
                    JMA = MAX(J1,IND)
                    JMI = MIN(J1,IND)
C
                 CALL VCLR(YAOG,1,NXYZ)
                 CALL HSMLTN(YAOG,YAOTMP,IO1,JJ,ION,ION,IND,J1,NACT,
     *                       NNACT,NXYZ,ONE)
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     CVAL = CI(JCI2,ISTAT)
                     WVAL = WSTATE(ISTAT)
                     IF(ABS(CVAL).GT.TOL) THEN
                       IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                       DVAL = CVAL*WVAL*FC
                       CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI1),1)
                     ENDIF
                   ENDDO
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         FC,JCI1,JCI2,IO1,JJ,ION,ION,IND,J1,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                 ENDIF
C
                 IF(JCI2.GE.JLO .AND. JCI2.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     CVAL = CI(JCI1,ISTAT)
                     WVAL = WSTATE(ISTAT)
                     IF(ABS(CVAL).GT.TOL) THEN
                       IWI2 = (ISTAT-1)*NDETLN + JCI2 - JLO + 1
                       DVAL = CVAL*WVAL*FC
                       CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI2),1)
                     ENDIF
                   ENDDO
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         FC,JCI2,JCI1,IO1,JJ,ION,ION,IND,J1,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                 ENDIF
C
 4670            CONTINUE
C
 4680         CONTINUE
C
 4690         CALL PUSHCO(LBOX3,NSPACE,NB,IBMA,IBMI,LBOX4,IEND)
 4700         CONTINUE
C
C --  DOUBLE ALPHA EXCITATIONS START HERE  ---
C
 4800         CONTINUE
C
            IF (IA1.EQ.NA) GOTO 4850
            IF (JJ.EQ.NACT) GOTO 4850
C
            DO II=1,NSPACE
               LBOX3(II) = LBOX2(II)
            ENDDO
            IAES3 = 1
            DO KK=1,ISPA1-1
               IAES3 = IAES3 + LBOX2(KK)
            ENDDO
C
C  LOOP OVER SPACES TO EXCITE ELECTRONS FROM, MUST BE GE THAN
C  SPACE OF FIRST EXCITATION, ISPA1.
C
            DO 3890 ISPA3 = ISPA1,NSPACE
               IF (LBOX1(ISPA3).EQ.0) GOTO 3887
               IF (ISPA3.EQ.ISPA1.AND.IA1.EQ.IEAE) GOTO 3887
               IOC3 = LBOX2(ISPA3)
               IF (IOC3.EQ.0) GOTO 3887
C
               IAEE3 = IAES3 + LBOX2(ISPA3)-1
               LBOX3(ISPA3) = LBOX3(ISPA3)-1
C
C  LOOP OVER ELECTRONS IN ISPA3, WHICH ARE LARGER THAN IA1,
C  MAKING SURE IT ISN'T THE ALREADY EXCITED ELECTRON.
C
               JSTA3 = IAES3
               IF (ISPA3.EQ.ISPA1) THEN
                  JSTA3=IA1
                  IF (IGAP-1.EQ.IA1) JSTA3=JSTA3+1
               ENDIF
C
               DO 3880 IA3=JSTA3,IAEE3
                  IF (IA3.EQ.IGAP-1) GOTO 3880
                  IO3 = IACON2(IA3)
                  IS3 = IOB(IO3)
C
C  LOOP OVER SPACES TO EXCITE ELECTRON INTO.  MUST BE GE THAN
C  SPACE FIRST ELECTRON WAS EXCITED INTO.
C
                  IGAE3 = 0
                  DO JIK=1,ISPA2-1
                     IGAE3 = IGAE3 + LBOX2(JIK)
                  ENDDO
                  DO 3850 ISPA4=ISPA2,NSPACE
C
C  IGAS3, IGAE3 ARE ELECTRONS SPECIFYING ISPA4 SPACE ELECTRON LIMITS.
C
                  LBOX3(ISPA4) = LBOX3(ISPA4) + 1
                  IGAS3 = IGAE3 + 1
                  IGAE3 = IGAE3 + LBOX2(ISPA4)
                  IF (LBOX3(ISPA3).LT.IAMI(ISPA3)) GOTO 3840
                  IF (LBOX3(ISPA4).GT.IAMA(ISPA4)) GOTO 3840
             IF (ISPA4.EQ.ISPA2.AND.JJ.EQ.MSTA(ISPA2+1)-1) GOTO 3840
C
C  GET GROUP NUMBER
C
               CALL POSITCO(LBOX5,NSPACE,NA,IAMA,IAMI,LBOX4,LBOX3,IGA3)
               NIAS3 = NAST(IGA3)
C
C  MAKE GAP INFORMATION HERE.
C
                  IGAA3 = MAX(IGAS3,IGAP)
C
                  IF (LBOX2(ISPA4).EQ.0) THEN
                     ISTA3 = MSTA(ISPA4)
                     IEND3 = MSTA(ISPA4+1)-1
                  ELSEIF (ISPA4.EQ.ISPA2) THEN
                     ISTA3 = JJ+1
                     IEND3 = IACON2(IGAA3)-1
C
C  I AM SUSPECT ABOUT THIS NEXT LINE, WE'LL SEE WHAT HAPPENS.......
C
                     IF (IGAP-1.EQ.IGAE3) IEND3=MSTA(ISPA2+1)-1
C
                  ELSE
                     ISTA3 = MSTA(ISPA4)
                     IEND3 = IACON2(IGAA3)-1
                  ENDIF
C
C  LOOP OVER GAPS
C
                  DO 3830 IGAP3=IGAA3,IGAE3+1
C
                     DO 3820 JJ3=ISTA3,IEND3
                        IS4 = IOB(JJ3)
                        IP2 = LGMUL(IS3,IS4)
                        IF (IP1.NE.IP2) GOTO 3820
C
              CALL REDE00(IACON2,IBCON1,NA,IA3,IGAP3-1,JJ3,JPERA3)
              CALL IDPOST(IBCON1,NA,LBOX3,NSPACE,MSTA,IDIM,Y,NX,LBST,
     *                  LANDET(1,IGA3),IBCON2,JPOSA3)
C              IPER3 = ((-1)**(JPERA3+JPERA))*2
              IPER3 = (-1)**(JPERA3+JPERA)
              KAPOS3 = JPOSA3 + NIAS3
              JPZA3 = LSPA(KAPOS3)
                 JMA=MAX(JJ3,IO3)
                 JMI=MIN(JJ3,IO3)
                 I2 = INDEX(JMA) + JMI
                 II1 = INDEX(JJ3) + IO1
                 JMA=MAX(IO3,JJ)
                 JMI=MIN(IO3,JJ)
                 II2 = INDEX(JMA) + JMI
                 JMA=MAX(II1,II2)
                 JMI=MIN(II1,II2)
C
                 CALL VCLR(YAOG,1,NXYZ)
                 CALL HSMLTN(YAOG,YAOTMP,IO1,JJ,IO3,JJ3,IND,I2,NACT,
     *                       NNACT,NXYZ,ONE)
                 CALL HSMLTN(YAOG,YAOTMP,IO1,JJ3,IO3,JJ,II1,II2,NACT,
     *                       NNACT,NXYZ,-ONE)
C
C
C  LOOP OVER BETA STRINGS OF RIGHT SYMMETRY AND GROUP.
C
              DO 3700 IGB=1,ITGB
              IF (LGCOM(IGB,IGA).NE.1.OR.LGCOM(IGB,IGA3).NE.1) GOTO 3700
              JCI1 = JPZA1 + LDISB(KSYM,IGB,IGA)
              JCI3 = JPZA3 + LDISB(KSYM,IGB,IGA3)
C
              DO 3680 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                 JCI1 = JCI1 + 1
                 JCI3 = JCI3 + 1
                 FC = IPER3
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     CVAL = CI(JCI3,ISTAT)
                     WVAL = WSTATE(ISTAT)
                     IF(ABS(CVAL).GT.TOL) THEN
                       IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                       DVAL = CVAL*WVAL*FC
                       CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI1),1)
                     ENDIF
                   ENDDO
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         FC,JCI1,JCI3,IO1,JJ,IO3,JJ3,IND,I2,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         -FC,JCI1,JCI3,IO1,JJ3,IO3,JJ,II1,II2,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                 ENDIF
C
                 IF(JCI3.GE.JLO .AND. JCI3.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     CVAL = CI(JCI1,ISTAT)
                     WVAL = WSTATE(ISTAT)
                     IF(ABS(CVAL).GT.TOL) THEN
                       IWI3 = (ISTAT-1)*NDETLN + JCI3 - JLO + 1
                       DVAL = CVAL*WVAL*FC
                       CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI3),1)
                     ENDIF
                   ENDDO
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         FC,JCI3,JCI1,IO1,JJ,IO3,JJ3,IND,I2,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         -FC,JCI3,JCI1,IO1,JJ3,IO3,JJ,II1,II2,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                 ENDIF
C
 3680         CONTINUE
C
 3700         CONTINUE
C
 3820                CONTINUE
C
                     ISTA3 = IACON2(IGAP3)+1
                     IEND3 = IACON2(IGAP3+1)-1
                     IF (IGAP3.EQ.IGAE3) IEND3=MSTA(ISPA4+1)-1
 3830             CONTINUE
C
 3840             LBOX3(ISPA4) = LBOX3(ISPA4) - 1
 3850             CONTINUE
C
 3880          CONTINUE
C
               LBOX3(ISPA3) = LBOX3(ISPA3)+1
 3887          IAES3 = IAES3 + LBOX3(ISPA3)
 3890       CONTINUE
C
 4850                CONTINUE
C
                  ISTA = IACON1(IGAP)+1
                  IEND = IACON1(IGAP+1)-1
                  IF (IGAP.EQ.IGAE) IEND=MSTA(ISPA2+1)-1
 4860             CONTINUE
C
 4870             LBOX2(ISPA2) = LBOX2(ISPA2) - 1
 4880          CONTINUE
C
 4885          CONTINUE
C
               LBOX2(ISPA1) = LBOX2(ISPA1)+1
 4890       CONTINUE
C
C  DIAGONAL ELEMENTS HERE
C
            DO 67 II=1,NA
               I1 = IACON1(II)
               IND1 = INDEX(I1+1)
C
C  LOOP OVER BETA STRINGS OF RIGHT SYMMETRY AND GROUP.
C
              DO 3705 IGB=1,ITGB
              IF (LGCOM(IGB,IGA).NE.1) GOTO 3705
              JCI1 = JPZA1 + LDISB(KSYM,IGB,IGA)
C
              DO 3685 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                 JCI1 = JCI1 + 1
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     CALL HSMLT1(AVEC,YAC,BVEC,RHSC,CI,OINT,AMAT,
     *                           ONE,JCI1,JCI1,IND1,I1,I1,JLO,
     *                           NSTATS,NCI,NDETLN,L1,NCOR,
     *                           NNACT,NXYZ,WSTATE,SALAG,ITER)
                   ENDDO
                 ENDIF
C
 3685         CONTINUE
C
 3705         CONTINUE
C
              DO 64 JJ=II+1,NA
                 I2 = IACON1(JJ)
                 IND2 = INDEX(I2+1)
                 INDM = IND2 - I2 + I1
                 J1 = INDEX(INDM+1)
                 J2 = INDEX(IND2) + IND1
C
                 CALL VCLR(YAOG,1,NXYZ)
                 CALL HSMLTN(YAOG,YAOTMP,I1,I1,I2,I2,IND1,IND2,NACT,
     *                       NNACT,NXYZ,ONE)
                 CALL HSMLTN(YAOG,YAOTMP,I1,I2,I2,I1,INDM,INDM,NACT,
     *                       NNACT,NXYZ,-ONE)
C
C
              DO 3710 IGB=1,ITGB
              IF (LGCOM(IGB,IGA).NE.1) GOTO 3710
              JCI1 = JPZA1 + LDISB(KSYM,IGB,IGA)
C
              DO 3690 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                 JCI1 = JCI1 + 1
                 FC = IPER3
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     CVAL = CI(JCI1,ISTAT)
                     WVAL = WSTATE(ISTAT)
                     IF(ABS(CVAL).GT.TOL) THEN
                       IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                       DVAL = CVAL*WVAL
                       CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI1),1)
                     ENDIF
                   ENDDO
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         ONE,JCI1,JCI1,I1,I1,I2,I2,IND1,IND2,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         -ONE,JCI1,JCI1,I1,I2,I2,I1,INDM,INDM,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                 ENDIF
C
 3690         CONTINUE
C
 3710         CONTINUE
C
   64         CONTINUE
C
C  LOOP OVER BETA DETS OF THE RIGHT GROUP AND SYMMETRY.
C
              CALL RESETCO(LBOX3,NSPACE,NB,IBMA,IBMI,LBOX4)
C
              DO 4709 IGB=1,ITGB
              IF (LGCOM(IGB,IGA).NE.1) GOTO 4699
              JCI1 = JPZA1 + LDISB(KSYM,IGB,IGA)
C
              CALL RESETDE(LBOX3,NSPACE,NB,MSTA,IBCON1)
              ISTB = 1
              DO 4689 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                 IENB = LSBC(KKB)
                 DO IIZ=ISTB,IENB-1
                    CALL MOVEUP2(LBOX3,NSPACE,NB,MSTA,IBCON1)
                 ENDDO
                 ISTB = IENB
                 JCI1 = JCI1 + 1
                 IF(JCI1.LT.JLO .OR. JCI1.GT.JHI) GO TO 4689
C
                 DO 4679 IK=1,NB
                    I2 = IBCON1(IK)
                    IND2 = INDEX(I2+1)
                    JMI = MIN(IND1,IND2)
                    JMA = MAX(IND1,IND2)
                    J2 = INDEX(JMA) + JMI
C
                   CALL VCLR(YAOG,1,NXYZ)
                   CALL HSMLTN(YAOG,YAOTMP,I1,I1,I2,I2,IND1,IND2,NACT,
     *                         NNACT,NXYZ,ONE)
C
                   DO ISTAT=1,NSTATS
                     CVAL = CI(JCI1,ISTAT)
                     WVAL = WSTATE(ISTAT)
                     IF(ABS(CVAL).GT.TOL) THEN
                       IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                       DVAL = CVAL*WVAL
                       CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI1),1)
                     ENDIF
                   ENDDO
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         ONE,JCI1,JCI1,I1,I1,I2,I2,IND1,IND2,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
C
 4679            CONTINUE
C
 4689         CONTINUE
C
 4699         CALL PUSHCO(LBOX3,NSPACE,NB,IBMA,IBMI,LBOX4,IEND)
 4709         CONTINUE
C
   67       CONTINUE
C
C  --- END OF LOOP OVER SINGLE ALPHA EXCITATIONS. ---
C      NOW TO SORT THEM BY POSITIONS WITHIN SYMMETRIES.
C
            DO II=1,NSYM
               CALL FCPSRT3(IGROA(1,II),IPERA(1,II),IIND1(1,II),
     *                   IPOSA(1,II),IMMC(II),IIND2(1,II),IIND3(1,II))
            ENDDO
C
C  --- END OF LOOP OVER PURE ALPHA EXCITATIONS.
C  NOW TO LOOP OVER ALL SIMULTANEOUS AB -> A'B' EXCITATIONS.
C
      IF (NSPACE.EQ.1) GOTO 3400
C
C  ***** GENERAL CASE OF MORE THAN ONE SPACE !!!!! *******
C
      IF (.NOT.FDIRCT) THEN
C
C  LOOP OVER SINGLE ALPHA EXCITES WITHIN EACH SYMMETRY.
C
      DO 3000 ISAE=1,NSYM
         KBSYM=KTAB(ISAE)
         DO 2900 JSAE=1,IMMC(ISAE)
            JPOSAE=IPOSA(JSAE,ISAE)
            JPERAE=IPERA(JSAE,ISAE)
            JINDAE=IIND1(JSAE,ISAE)
            JGROAE=IGROA(JSAE,ISAE)
C
            IXI = IIND2(JSAE,ISAE)
            IXJ = IIND3(JSAE,ISAE)
C
C
C  IF ISAE.EQ.JASYM THEN SPECIAL CASE.
C
       IF (ISAE.EQ.JASYM.AND.IGA.EQ.JGROAE) THEN
C
C  LOOP OVER ALL RELEVANT BETAS
C
            LABPOS = JPZA1
            LABPOS2 = JPOSAE
            DO 2813 IGB=1,ITGB
               IF (LGCOM(IGB,IGA).NE.1) GOTO 2813
               NIBS = NBST(IGB)
               DO 2763 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                  LABPOS = LABPOS + 1
                  LABPOS2 = LABPOS2 + 1
                  IBPOS = NIBS + LSBC(KKB)
C
C  LOOP OVER SINGLE BETA EXCITES FROM IBPOS
C
               DO 2613 JBINDX=JB1ST(KBSYM,IBPOS),JB1ST(KBSYM+1,IBPOS)-1
                  IGB2=JB1GR(JBINDX)
                  IF (LGCOM(IGB2,JGROAE).NE.1) GOTO 2613
C
                  JMA=MAX(JINDAE,JB1IN(JBINDX))
                  JMI=MIN(JINDAE,JB1IN(JBINDX))
                  JCIB=JPOSAE+LDISB(KBSYM,IGB2,JGROAE)+JB1PO(JBINDX)
                  JCIB2=JPZA1+LDISB(KBSYM,IGB2,JGROAE)+JB1PO(JBINDX)
C
                  FC = JPERAE*JB1PE(JBINDX)
                  IXK = JB1IN2(JBINDX,1)
                  IXL = JB1IN2(JBINDX,2)
                  CALL VCLR(YAOG,1,NXYZ)
                  CALL HSMLTN(YAOG,YAOTMP,IXI,IXJ,IXK,IXL,JINDAE,
     *                        JB1IN(JBINDX),NACT,NNACT,NXYZ,ONE)
C
                  IF(LABPOS.GE.JLO .AND. LABPOS.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      CVAL = CI(JCIB,ISTAT)
                      WVAL = WSTATE(ISTAT)
                      IF(ABS(CVAL).GT.TOL) THEN
                        IWI1 = (ISTAT-1)*NDETLN + LABPOS - JLO + 1
                        DVAL = CVAL*WVAL*FC
                        CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI1),1)
                      ENDIF
                    ENDDO
                    CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                          FC,LABPOS,JCIB,IXI,IXJ,IXK,IXL,JINDAE,
     *                          JB1IN(JBINDX),NACT,NNACT,NSTATS,NXYZ,
     *                          NCI,NDETLN,JLO,L1,NCOR,SALAG,ITER,KILL)
                  ENDIF
C
                  IF(JCIB.GE.JLO .AND. JCIB.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      CVAL = CI(LABPOS,ISTAT)
                      WVAL = WSTATE(ISTAT)
                      IF(ABS(CVAL).GT.TOL) THEN
                        IWIB = (ISTAT-1)*NDETLN + JCIB - JLO + 1
                        DVAL = CVAL*WVAL*FC
                        CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWIB),1)
                      ENDIF
                    ENDDO
                    CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                          FC,JCIB,LABPOS,IXI,IXJ,IXK,IXL,JINDAE,
     *                          JB1IN(JBINDX),NACT,NNACT,NSTATS,NXYZ,
     *                          NCI,NDETLN,JLO,L1,NCOR,SALAG,ITER,KILL)
                  ENDIF
C
                  IF(LABPOS2.GE.JLO .AND. LABPOS2.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      CVAL = CI(JCIB2,ISTAT)
                      WVAL = WSTATE(ISTAT)
                      IF(ABS(CVAL).GT.TOL) THEN
                        IWI1 = (ISTAT-1)*NDETLN + LABPOS2 - JLO + 1
                        DVAL = CVAL*WVAL*FC
                        CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI1),1)
                      ENDIF
                    ENDDO
                    CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                          FC,LABPOS2,JCIB2,IXI,IXJ,IXK,IXL,JINDAE,
     *                          JB1IN(JBINDX),NACT,NNACT,NSTATS,NXYZ,
     *                          NCI,NDETLN,JLO,L1,NCOR,SALAG,ITER,KILL)
                  ENDIF
C
                  IF(JCIB2.GE.JLO .AND. JCIB2.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      CVAL = CI(LABPOS2,ISTAT)
                      WVAL = WSTATE(ISTAT)
                      IF(ABS(CVAL).GT.TOL) THEN
                        IWIB = (ISTAT-1)*NDETLN + JCIB2 - JLO + 1
                        DVAL = CVAL*WVAL*FC
                        CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWIB),1)
                      ENDIF
                    ENDDO
                    CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                          FC,JCIB2,LABPOS2,IXI,IXJ,IXK,IXL,JINDAE,
     *                          JB1IN(JBINDX),NACT,NNACT,NSTATS,NXYZ,
     *                          NCI,NDETLN,JLO,L1,NCOR,SALAG,ITER,KILL)
                  ENDIF
C
 2613          CONTINUE
C
 2763          CONTINUE
 2813       CONTINUE
C
       ELSE
C
C  LOOP OVER ALL RELEVANT (A-)BETA DETS.
C
            LABPOS = JPZA1
            DO 2800 IGB=1,ITGB
               IF (LGCOM(IGB,IGA).NE.1) GOTO 2800
               NIBS = NBST(IGB)
               DO 2750 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                  LABPOS = LABPOS + 1
                  IBPOS = NIBS + LSBC(KKB)
C
C  LOOP OVER SINGLE BETA EXCITES FROM IBPOS
C
               DO 2600 JBINDX=JB1ST(KBSYM,IBPOS),JB1ST(KBSYM+1,IBPOS)-1
                  IGB2=JB1GR(JBINDX)
                  IF (LGCOM(IGB2,JGROAE).NE.1) GOTO 2600
C
                  JMA=MAX(JINDAE,JB1IN(JBINDX))
                  JMI=MIN(JINDAE,JB1IN(JBINDX))
                  JCIB=JPOSAE+LDISB(KBSYM,IGB2,JGROAE)+JB1PO(JBINDX)
C
                  FC = JPERAE*JB1PE(JBINDX)
                  IXK = JB1IN2(JBINDX,1)
                  IXL = JB1IN2(JBINDX,2)
                  CALL VCLR(YAOG,1,NXYZ)
                  CALL HSMLTN(YAOG,YAOTMP,IXI,IXJ,IXK,IXL,JINDAE,
     *                        JB1IN(JBINDX),NACT,NNACT,NXYZ,ONE)
C
                  IF(LABPOS.GE.JLO .AND. LABPOS.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      CVAL = CI(JCIB,ISTAT)
                      WVAL = WSTATE(ISTAT)
                      IF(ABS(CVAL).GT.TOL) THEN
                        IWI1 = (ISTAT-1)*NDETLN + LABPOS - JLO + 1
                        DVAL = CVAL*WVAL*FC
                        CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI1),1)
                      ENDIF
                    ENDDO
                    CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                          FC,LABPOS,JCIB,IXI,IXJ,IXK,IXL,JINDAE,
     *                          JB1IN(JBINDX),NACT,NNACT,NSTATS,NXYZ,
     *                          NCI,NDETLN,JLO,L1,NCOR,SALAG,ITER,KILL)
                  ENDIF
C
                  IF(JCIB.GE.JLO .AND. JCIB.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      CVAL = CI(LABPOS,ISTAT)
                      WVAL = WSTATE(ISTAT)
                      IF(ABS(CVAL).GT.TOL) THEN
                        IWIB = (ISTAT-1)*NDETLN + JCIB - JLO + 1
                        DVAL = CVAL*WVAL*FC
                        CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWIB),1)
                      ENDIF
                    ENDDO
                    CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                          FC,JCIB,LABPOS,IXI,IXJ,IXK,IXL,JINDAE,
     *                          JB1IN(JBINDX),NACT,NNACT,NSTATS,NXYZ,
     *                          NCI,NDETLN,JLO,L1,NCOR,SALAG,ITER,KILL)
                  ENDIF
C
 2600          CONTINUE
C
 2750          CONTINUE
 2800       CONTINUE
C
C  LOOP OVER ALL RELEVANT (A'-)BETA DETS.
C
            LABPOS = JPOSAE
            DO 2803 IGB=1,ITGB
               IF (LGCOM(IGB,JGROAE).NE.1) GOTO 2803
               NIBS = NBST(IGB)
               DO 2753 KKB=LSBS(KBSYM,IGB),LSBS(KBSYM+1,IGB)-1
                  LABPOS = LABPOS + 1
                  IBPOS = NIBS + LSBC(KKB)
C
C  LOOP OVER SINGLE BETA EXCITES FROM IBPOS
C
               DO 2603 JBINDX=JB1ST(KSYM,IBPOS),JB1ST(KSYM+1,IBPOS)-1
                  IGB2=JB1GR(JBINDX)
                  IF (LGCOM(IGB2,IGA).NE.1) GOTO 2603
C
                  JMA=MAX(JINDAE,JB1IN(JBINDX))
                  JMI=MIN(JINDAE,JB1IN(JBINDX))
                  JCIB=JPZA1+LDISB(KSYM,IGB2,IGA)+JB1PO(JBINDX)
C
                  FC = JPERAE*JB1PE(JBINDX)
                  IXK = JB1IN2(JBINDX,1)
                  IXL = JB1IN2(JBINDX,2)
                  CALL VCLR(YAOG,1,NXYZ)
                  CALL HSMLTN(YAOG,YAOTMP,IXI,IXJ,IXK,IXL,JINDAE,
     *                        JB1IN(JBINDX),NACT,NNACT,NXYZ,ONE)
C
                  IF(LABPOS.GE.JLO .AND. LABPOS.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      CVAL = CI(JCIB,ISTAT)
                      WVAL = WSTATE(ISTAT)
                      IF(ABS(CVAL).GT.TOL) THEN
                        IWI1 = (ISTAT-1)*NDETLN + LABPOS - JLO + 1
                        DVAL = CVAL*WVAL*FC
                        CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI1),1)
                      ENDIF
                    ENDDO
                    CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                          FC,LABPOS,JCIB,IXI,IXJ,IXK,IXL,JINDAE,
     *                          JB1IN(JBINDX),NACT,NNACT,NSTATS,NXYZ,
     *                          NCI,NDETLN,JLO,L1,NCOR,SALAG,ITER,KILL)
                  ENDIF
C
                  IF(JCIB.GE.JLO .AND. JCIB.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      CVAL = CI(LABPOS,ISTAT)
                      WVAL = WSTATE(ISTAT)
                      IF(ABS(CVAL).GT.TOL) THEN
                        IWIB = (ISTAT-1)*NDETLN + JCIB - JLO + 1
                        DVAL = CVAL*WVAL*FC
                        CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWIB),1)
                      ENDIF
                    ENDDO
                    CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                          FC,JCIB,LABPOS,IXI,IXJ,IXK,IXL,JINDAE,
     *                          JB1IN(JBINDX),NACT,NNACT,NSTATS,NXYZ,
     *                          NCI,NDETLN,JLO,L1,NCOR,SALAG,ITER,KILL)
                  ENDIF
C
 2603          CONTINUE
C
 2753          CONTINUE
 2803       CONTINUE
C
      ENDIF
C
 2900    CONTINUE
 3000 CONTINUE
C
      ELSE
C
C  ***** DIRECT METHOD BELOW *****
C
      DO 4000 ISAE=1,NSYM
         KBSYM = KTAB(ISAE)
C
C  ANALYSE EXCITED A' GROUPS FOR COMPATIBILITY WITH B.
C
      NGRPS = 0
      DO 1976 II=1,IMMC(ISAE)
         ICGR = IGROA(II,ISAE)
         DO JJ=1,NGRPS
            IF (JB1GR(JJ).EQ.ICGR) GOTO 1976
         ENDDO
         NGRPS = NGRPS + 1
         JB1GR(NGRPS) = ICGR
 1976 CONTINUE
C
C FIRST TYPE OF BETAS, KSYM -> KBSYM
C
          CALL RESETCO(LBOX2,NSPACE,NB,IBMA,IBMI,LBOX3)
          DO 7400 IGB=1,ITGB
             IF (LGCOM(IGB,IGA).NE.1) GOTO 7399
             LAB1 = JPZA1 + LDISB(KSYM,IGB,IGA)
C
             CALL RESETDE(LBOX2,NSPACE,NB,MSTA,IBCON1)
             NIBS = NBST(IGB)
             ISTB = 1
             DO 7300 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                IENB = LSBC(KKB)
                DO IIZ=ISTB,IENB-1
                   CALL MOVEUP2(LBOX2,NSPACE,NB,MSTA,IBCON1)
                ENDDO
                ISTB = IENB
C
                IBPOS = NIBS + LSBC(KKB)
                LABPOS = LAB1 + LSPB(IBPOS)
C
C LOOP OVER SINGLE BETA EXCITES FROM IBPOS WHICH ARE OF SYMMETRY KBSYM
C
                MESYM1 = LGMUL(KSYM,KBSYM)
                DO II=1,NSPACE
                   LBOX3(II) = LBOX2(II)
                ENDDO
                IEBS = NB + 1
                DO 7290 ISPB1=NSPACE,1,-1
                   IOC1 = LBOX2(ISPB1)
                   IEBE = IEBS - 1
                   IEBS = IEBS - IOC1
                   IF (IOC1.EQ.0) GO TO 7290
                   LBOX3(ISPB1) = LBOX3(ISPB1)-1
C
C  LOOP ELECTRONS IN SPACE ISPB1
C  IEBS, IEBE ARE THE ELECTRONS IN SPACE ISPB1
C
                DO 7285 IB1 = IEBE,IEBS,-1
                   IO1 = IBCON1(IB1)
                   MESYM2 = LGMUL(MESYM1,IOB(IO1))
                   IGBE = IEBE - LBOX2(ISPB1)
C
C  LOOP OVER POSSIBLE SPACES TO EXCITE INTO.
C
                DO 7280 ISPB2=ISPB1,NSPACE
C
C  IGBS,IGBE ARE ELECTRONS SPECIFYING ISPB2 SPACE ELECTRON LIMITS.
C
                   IGBS = IGBE + 1
                   IGBE = IGBE + LBOX2(ISPB2)
C
                   LBOX3(ISPB2) = LBOX3(ISPB2) + 1
                   IF (LBOX3(ISPB1).LT.IBMI(ISPB1)) GO TO 7270
                   IF (LBOX3(ISPB2).GT.IBMA(ISPB2)) GO TO 7270
C
C  GET GROUP NUMBER
C
          CALL POSITCO(LBOX5,NSPACE,NB,IBMA,IBMI,LBOX4,LBOX3,IGB2)
          NIAS = NBST(IGB2)
C
C CHECK FOR A' GROUP COMPATIBILITY
C
             DO II=1,NGRPS
                IAGRP = JB1GR(II)
                IF (LGCOM(IGB2,IAGRP).EQ.1) GOTO 7555
             ENDDO
             GOTO 7270
 7555        CONTINUE
C
C  MAKE GAP INFORMATION HERE.
C
                  IGBA = MAX(IB1+1,IGBS)
                  IF (LBOX2(ISPB2).EQ.0) THEN
                     ISTA = MSTA(ISPB2)
                     IEND = MSTA(ISPB2+1)-1
                  ELSEIF (ISPB2.EQ.ISPB1) THEN
                     ISTA = IO1+1
                     IEND = IBCON1(IGBA)-1
                     IF (IB1.EQ.IEBE) IEND=MSTA(ISPB1+1)-1
                  ELSE
                     ISTA = MSTA(ISPB2)
                     IEND = IBCON1(IGBA)-1
                  ENDIF
C
C  LOOP OVER GAPS
C
                  DO 7260 IGAP=IGBA,IGBE+1
C
                     DO 7250 JJ=ISTA,IEND
C
C CHECK TO SEE IF EXCITED BETA IS OF RIGHT SYMMETRY (KBSYM)
C
            IF (IOB(JJ).NE.MESYM2) GOTO 7250
C
            IND1 = INDEX(JJ) + IO1
            CALL REDE00(IBCON1,IBCON2,NB,IB1,IGAP-1,JJ,IPER)
            CALL IDPOST(IBCON2,NB,LBOX3,NSPACE,MSTA,IDIM,Y,NX,LBST,
     *                  LBNDET(1,IGB2),IACON2,IPOSB)
            JB1P = LSPB(IPOSB + NIAS)
C
            DO 3900 JSAE=1,IMMC(ISAE)
               JGROAE=IGROA(JSAE,ISAE)
               IF (LGCOM(IGB2,JGROAE).NE.1) GOTO 3900
C
               JPOSAE=IPOSA(JSAE,ISAE)
               JCIB = JB1P + JPOSAE + LDISB(KBSYM,IGB2,JGROAE)
C
               JINDAE=IIND1(JSAE,ISAE)
               JMA=MAX(JINDAE,IND1)
               JMI=MIN(JINDAE,IND1)
C
               JPERAE=IPERA(JSAE,ISAE)
 3900       CONTINUE
C
 7250                CONTINUE
C
                  ISTA = IBCON1(IGAP)+1
                  IEND = IBCON1(IGAP+1)-1
                  IF (IGAP.EQ.IGBE) IEND=MSTA(ISPB2+1)-1
 7260             CONTINUE
C
 7270              LBOX3(ISPB2) = LBOX3(ISPB2) - 1
 7280           CONTINUE
C
 7285           CONTINUE
C
                   LBOX3(ISPB1) = LBOX3(ISPB1) + 1
 7290           CONTINUE
C
 7300        CONTINUE
C
 7399        CALL PUSHCO(LBOX2,NSPACE,NB,IBMA,IBMI,LBOX3,IEND)
 7400     CONTINUE
C
C
C SECOND TYPE OF BETAS, KBSYM -> KSYM
C
          CALL RESETCO(LBOX2,NSPACE,NB,IBMA,IBMI,LBOX3)
          DO 7801 IGB=1,ITGB
C
C CHECK FOR A' GROUP COMPATIBILITY
C
             DO II=1,NGRPS
                IAGRP = JB1GR(II)
                IF (LGCOM(IGB,IAGRP).EQ.1) GOTO 7655
             ENDDO
             GOTO 7799
 7655        CONTINUE
C
             CALL RESETDE(LBOX2,NSPACE,NB,MSTA,IBCON1)
             NIBS = NBST(IGB)
             ISTB = 1
C
             DO 7701 KKB=LSBS(KBSYM,IGB),LSBS(KBSYM+1,IGB)-1
                IENB = LSBC(KKB)
                DO IIZ=ISTB,IENB-1
                   CALL MOVEUP2(LBOX2,NSPACE,NB,MSTA,IBCON1)
                ENDDO
                ISTB = IENB
C
                IBPOS = NIBS + LSBC(KKB)
                LAB1 = LSPB(IBPOS)
C
C LOOP OVER SINGLE BETA EXCITES FROM IBPOS WHICH ARE OF SYMMETRY KSYM
C
                MESYM1 = LGMUL(KSYM,KBSYM)
                DO II=1,NSPACE
                   LBOX3(II) = LBOX2(II)
                ENDDO
                IEBS = NB + 1
                DO 7691 ISPB1=NSPACE,1,-1
                   IOC1 = LBOX2(ISPB1)
                   IEBE = IEBS - 1
                   IEBS = IEBS - IOC1
                   IF (IOC1.EQ.0) GO TO 7691
                   LBOX3(ISPB1) = LBOX3(ISPB1)-1
C
C  LOOP ELECTRONS IN SPACE ISPB1
C  IEBS, IEBE ARE THE ELECTRONS IN SPACE ISPB1
C
                DO 7686 IB1 = IEBE,IEBS,-1
                   IO1 = IBCON1(IB1)
                   MESYM2 = LGMUL(MESYM1,IOB(IO1))
                   IGBE = IEBE - LBOX2(ISPB1)
C
C  LOOP OVER POSSIBLE SPACES TO EXCITE INTO.
C
                DO 7681 ISPB2=ISPB1,NSPACE
C
C  IGBS,IGBE ARE ELECTRONS SPECIFYING ISPB2 SPACE ELECTRON LIMITS.
C
                   IGBS = IGBE + 1
                   IGBE = IGBE + LBOX2(ISPB2)
C
                   LBOX3(ISPB2) = LBOX3(ISPB2) + 1
                   IF (LBOX3(ISPB1).LT.IBMI(ISPB1)) GO TO 7671
                   IF (LBOX3(ISPB2).GT.IBMA(ISPB2)) GO TO 7671
C
          CALL POSITCO(LBOX5,NSPACE,NB,IBMA,IBMI,LBOX4,LBOX3,IGB2)
          IF (LGCOM(IGB2,IGA).NE.1) GOTO 7671
          JCIBS = JPZA1 + LDISB(KSYM,IGB2,IGA)
          NIAS = NBST(IGB2)
C
C  MAKE GAP INFORMATION HERE.
C
                  IGBA = MAX(IB1+1,IGBS)
                  IF (LBOX2(ISPB2).EQ.0) THEN
                     ISTA = MSTA(ISPB2)
                     IEND = MSTA(ISPB2+1)-1
                  ELSEIF (ISPB2.EQ.ISPB1) THEN
                     ISTA = IO1+1
                     IEND = IBCON1(IGBA)-1
                     IF (IB1.EQ.IEBE) IEND=MSTA(ISPB1+1)-1
                  ELSE
                     ISTA = MSTA(ISPB2)
                     IEND = IBCON1(IGBA)-1
                  ENDIF
C
C  LOOP OVER GAPS
C
                  DO 7660 IGAP=IGBA,IGBE+1
C
                     DO 7650 JJ=ISTA,IEND
C
C CHECK TO SEE IF EXCITED BETA IS OF RIGHT SYMMETRY (KBSYM)
C
            IF (IOB(JJ).NE.MESYM2) GOTO 7650
C
            IND1 = INDEX(JJ) + IO1
            CALL REDE00(IBCON1,IBCON2,NB,IB1,IGAP-1,JJ,IPER)
            CALL IDPOST(IBCON2,NB,LBOX3,NSPACE,MSTA,IDIM,Y,NX,LBST,
     *                  LBNDET(1,IGB2),IACON2,IPOSB)
            JCIB= JCIBS + LSPB(IPOSB + NIAS)
C
            DO 4300 JSAE=1,IMMC(ISAE)
               JGROAE=IGROA(JSAE,ISAE)
               IF (LGCOM(IGB,JGROAE).NE.1) GOTO 4300
C
               JPOSAE=IPOSA(JSAE,ISAE)
               LABPOS = LAB1 + JPOSAE + LDISB(KBSYM,IGB,JGROAE)
C
               JINDAE=IIND1(JSAE,ISAE)
               JMA=MAX(JINDAE,IND1)
               JMI=MIN(JINDAE,IND1)
C
               JPERAE=IPERA(JSAE,ISAE)
 4300       CONTINUE
C
 7650                CONTINUE
C
                  ISTA = IBCON1(IGAP)+1
                  IEND = IBCON1(IGAP+1)-1
                  IF (IGAP.EQ.IGBE) IEND=MSTA(ISPB2+1)-1
 7660             CONTINUE
C
 7671              LBOX3(ISPB2) = LBOX3(ISPB2) - 1
 7681           CONTINUE
C
 7686           CONTINUE
C
                   LBOX3(ISPB1) = LBOX3(ISPB1) + 1
 7691           CONTINUE
C
 7701        CONTINUE
C
 7799        CALL PUSHCO(LBOX2,NSPACE,NB,IBMA,IBMI,LBOX3,IEND)
 7801     CONTINUE
C
 4000 CONTINUE
C
      ENDIF
C
C  ***** END OF DIRECT OPTION *****
C
C  **** END OF GENERAL CASE OF MORE THAN ONE SPACE ******
C
      GOTO 4899
C
 3400 CONTINUE
C
C ***** SPECIAL CASE OF ONE SPACE !!!!! ******
C
C  LOOP OVER SINGLE ALPHA EXCITES WITHIN EACH SYMMETRY.
C
       DO 2901 ISAE=1,NSYM
          KBSYM=KTAB(ISAE)
          DO 2801 JSAE=1,IMMC(ISAE)
                JPOSAE=IPOSA(JSAE,ISAE)
                JPERAE=IPERA(JSAE,ISAE)
                JINDAE=IIND1(JSAE,ISAE)
                JGROAE=IGROA(JSAE,ISAE)
C
                IXI = IIND2(JSAE,ISAE)
                IXJ = IIND3(JSAE,ISAE)
C
C
C  IF ISAE.EQ.JASYM THEN SPECIAL CASE.
C
       IF (ISAE.EQ.JASYM) THEN
C
C  LOOP OVER ALL RELEVANT BETAS
C
             LABPOS=JPZA1
             LABPOS2=JPOSAE
                DO 2721 KKB=LSBS(KSYM,1),LSBS(KSYM+1,1)-1
                    LABPOS = LABPOS + 1
                    LABPOS2 = LABPOS2 + 1
                    IBPOS =  LSBC(KKB)
C
C  LOOP OVER SINGLE BETA EXCITES FROM IBPOS
C
               DO 2621 JBINDX=JB1ST(KSYM,IBPOS),JB1ST(KSYM+1,IBPOS)-1
                  JMA=MAX(JINDAE,JB1IN(JBINDX))
                  JMI=MIN(JINDAE,JB1IN(JBINDX))
                  JCIB = JPOSAE+JB1PO(JBINDX)
                  JCIB2 = JPZA1+JB1PO(JBINDX)
C
                  FC = JPERAE*JB1PE(JBINDX)
                  IXK = JB1IN2(JBINDX,1)
                  IXL = JB1IN2(JBINDX,2)
                  CALL VCLR(YAOG,1,NXYZ)
                  CALL HSMLTN(YAOG,YAOTMP,IXI,IXJ,IXK,IXL,JINDAE,
     *                        JB1IN(JBINDX),NACT,NNACT,NXYZ,ONE)
C
                  IF(LABPOS.GE.JLO .AND. LABPOS.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      CVAL = CI(JCIB,ISTAT)
                      WVAL = WSTATE(ISTAT)
                      IF(ABS(CVAL).GT.TOL) THEN
                        IWI1 = (ISTAT-1)*NDETLN + LABPOS - JLO + 1
                        DVAL = CVAL*WVAL*FC
                        CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI1),1)
                      ENDIF
                    ENDDO
                    CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                          FC,LABPOS,JCIB,IXI,IXJ,IXK,IXL,JINDAE,
     *                          JB1IN(JBINDX),NACT,NNACT,NSTATS,NXYZ,
     *                          NCI,NDETLN,JLO,L1,NCOR,SALAG,ITER,KILL)
                  ENDIF
C
                  IF(JCIB.GE.JLO .AND. JCIB.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      CVAL = CI(LABPOS,ISTAT)
                      WVAL = WSTATE(ISTAT)
                      IF(ABS(CVAL).GT.TOL) THEN
                        IWIB = (ISTAT-1)*NDETLN + JCIB - JLO + 1
                        DVAL = CVAL*WVAL*FC
                        CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWIB),1)
                      ENDIF
                    ENDDO
                    CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                          FC,JCIB,LABPOS,IXI,IXJ,IXK,IXL,JINDAE,
     *                          JB1IN(JBINDX),NACT,NNACT,NSTATS,NXYZ,
     *                          NCI,NDETLN,JLO,L1,NCOR,SALAG,ITER,KILL)
                  ENDIF
C
                  IF(LABPOS2.GE.JLO .AND. LABPOS2.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      CVAL = CI(JCIB2,ISTAT)
                      WVAL = WSTATE(ISTAT)
                      IF(ABS(CVAL).GT.TOL) THEN
                        IWI1 = (ISTAT-1)*NDETLN + LABPOS2 - JLO + 1
                        DVAL = CVAL*WVAL*FC
                        CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI1),1)
                      ENDIF
                    ENDDO
                    CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                          FC,LABPOS2,JCIB2,IXI,IXJ,IXK,IXL,JINDAE,
     *                          JB1IN(JBINDX),NACT,NNACT,NSTATS,NXYZ,
     *                          NCI,NDETLN,JLO,L1,NCOR,SALAG,ITER,KILL)
                  ENDIF
C
                  IF(JCIB2.GE.JLO .AND. JCIB2.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      CVAL = CI(LABPOS2,ISTAT)
                      WVAL = WSTATE(ISTAT)
                      IF(ABS(CVAL).GT.TOL) THEN
                        IWIB = (ISTAT-1)*NDETLN + JCIB2 - JLO + 1
                        DVAL = CVAL*WVAL*FC
                        CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWIB),1)
                      ENDIF
                    ENDDO
                    CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                          FC,JCIB2,LABPOS2,IXI,IXJ,IXK,IXL,JINDAE,
     *                          JB1IN(JBINDX),NACT,NNACT,NSTATS,NXYZ,
     *                          NCI,NDETLN,JLO,L1,NCOR,SALAG,ITER,KILL)
                  ENDIF
C
 2621          CONTINUE
C
 2721          CONTINUE
C
      ELSE
C
C  LOOP OVER ALL RELEVANT (A-)BETA DETS.
C
                LABPOS = JPZA1
                DO 2751 KKB=LSBS(KSYM,1),LSBS(KSYM+1,1)-1
                    LABPOS = LABPOS + 1
                    IBPOS =  LSBC(KKB)
C
C  LOOP OVER SINGLE BETA EXCITES FROM IBPOS
C
               DO 2601 JBINDX=JB1ST(KBSYM,IBPOS),JB1ST(KBSYM+1,IBPOS)-1
C
                  JMA=MAX(JINDAE,JB1IN(JBINDX))
                  JMI=MIN(JINDAE,JB1IN(JBINDX))
                  JCIB=JPOSAE+JB1PO(JBINDX)
C
                  FC = JPERAE*JB1PE(JBINDX)
                  IXK = JB1IN2(JBINDX,1)
                  IXL = JB1IN2(JBINDX,2)
                  CALL VCLR(YAOG,1,NXYZ)
                  CALL HSMLTN(YAOG,YAOTMP,IXI,IXJ,IXK,IXL,JINDAE,
     *                        JB1IN(JBINDX),NACT,NNACT,NXYZ,ONE)
C
                  IF(LABPOS.GE.JLO .AND. LABPOS.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      CVAL = CI(JCIB,ISTAT)
                      WVAL = WSTATE(ISTAT)
                      IF(ABS(CVAL).GT.TOL) THEN
                        IWI1 = (ISTAT-1)*NDETLN + LABPOS - JLO + 1
                        DVAL = CVAL*WVAL*FC
                        CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI1),1)
                      ENDIF
                    ENDDO
                    CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                          FC,LABPOS,JCIB,IXI,IXJ,IXK,IXL,JINDAE,
     *                          JB1IN(JBINDX),NACT,NNACT,NSTATS,NXYZ,
     *                          NCI,NDETLN,JLO,L1,NCOR,SALAG,ITER,KILL)
                  ENDIF
C
                  IF(JCIB.GE.JLO .AND. JCIB.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      CVAL = CI(LABPOS,ISTAT)
                      WVAL = WSTATE(ISTAT)
                      IF(ABS(CVAL).GT.TOL) THEN
                        IWIB = (ISTAT-1)*NDETLN + JCIB - JLO + 1
                        DVAL = CVAL*WVAL*FC
                        CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWIB),1)
                      ENDIF
                    ENDDO
                    CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                          FC,JCIB,LABPOS,IXI,IXJ,IXK,IXL,JINDAE,
     *                          JB1IN(JBINDX),NACT,NNACT,NSTATS,NXYZ,
     *                          NCI,NDETLN,JLO,L1,NCOR,SALAG,ITER,KILL)
                  ENDIF
C
 2601          CONTINUE
C
 2751          CONTINUE
C
C  LOOP OVER ALL RELEVANT (A'-)BETA DETS.
C
               LABPOS = JPOSAE
               DO 2761 KKB=LSBS(KBSYM,1),LSBS(KBSYM+1,1)-1
                  LABPOS = LABPOS + 1
                  IBPOS = LSBC(KKB)
C
C  LOOP OVER SINGLE BETA EXCITES FROM IBPOS
C
               DO 2611 JBINDX=JB1ST(KSYM,IBPOS),JB1ST(KSYM+1,IBPOS)-1
C
                  JMA=MAX(JINDAE,JB1IN(JBINDX))
                  JMI=MIN(JINDAE,JB1IN(JBINDX))
                  JCIB=JPZA1+JB1PO(JBINDX)
C
                  FC = JPERAE*JB1PE(JBINDX)
                  IXK = JB1IN2(JBINDX,1)
                  IXL = JB1IN2(JBINDX,2)
                  CALL VCLR(YAOG,1,NXYZ)
                  CALL HSMLTN(YAOG,YAOTMP,IXI,IXJ,IXK,IXL,JINDAE,
     *                        JB1IN(JBINDX),NACT,NNACT,NXYZ,ONE)
C
                  IF(LABPOS.GE.JLO .AND. LABPOS.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      CVAL = CI(JCIB,ISTAT)
                      WVAL = WSTATE(ISTAT)
                      IF(ABS(CVAL).GT.TOL) THEN
                        IWI1 = (ISTAT-1)*NDETLN + LABPOS - JLO + 1
                        DVAL = CVAL*WVAL*FC
                        CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI1),1)
                      ENDIF
                    ENDDO
                    CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                          FC,LABPOS,JCIB,IXI,IXJ,IXK,IXL,JINDAE,
     *                          JB1IN(JBINDX),NACT,NNACT,NSTATS,NXYZ,
     *                          NCI,NDETLN,JLO,L1,NCOR,SALAG,ITER,KILL)
                  ENDIF
C
                  IF(JCIB.GE.JLO .AND. JCIB.LE.JHI) THEN
                    DO ISTAT=1,NSTATS
                      CVAL = CI(LABPOS,ISTAT)
                      WVAL = WSTATE(ISTAT)
                      IF(ABS(CVAL).GT.TOL) THEN
                        IWIB = (ISTAT-1)*NDETLN + JCIB - JLO + 1
                        DVAL = CVAL*WVAL*FC
                        CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWIB),1)
                      ENDIF
                    ENDDO
                    CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                          FC,JCIB,LABPOS,IXI,IXJ,IXK,IXL,JINDAE,
     *                          JB1IN(JBINDX),NACT,NNACT,NSTATS,NXYZ,
     *                          NCI,NDETLN,JLO,L1,NCOR,SALAG,ITER,KILL)
                  ENDIF
C
 2611          CONTINUE
C
 2761          CONTINUE
C
      ENDIF
C
 2801       CONTINUE
 2901   CONTINUE
C
C  **** END OF SPECIAL CASE OF ONE SPACE *******
C
 4899       CALL MOVEUP2(LBOX1,NSPACE,NA,MSTA,IACON1)
 4900    CONTINUE
C
         CALL PUSHCO(LBOX1,NSPACE,NA,IAMA,IAMI,LBOX5,IEND)
 5000 CONTINUE
C
C  --- END OF LOOP OVER ALPHA STRINGS. ---
C **
C  --- LOOP OVER ALL PURE BETA EXCITATIONS.
C
      CALL RESETCO(LBOX1,NSPACE,NB,IBMA,IBMI,LBOX5)
C
      DO 8000 IGB=1,ITGB
C
         CALL RESETDE(LBOX1,NSPACE,NB,MSTA,IBCON1)
C
C  KKB GIVES THE ACTUAL POSITION OF THE BETA STRING IBCON1 IN
C  THE FULL BETA STRING LIST.
C
         DO 7900 KKB=NBST(IGB)+1,NBST(IGB+1)
            JPZB1 = LSPB(KKB)
            KBSYM = LSYMB(KKB)
            KSYM=KTAB(KBSYM)
C
            DO II=1,NSPACE
               LBOX2(II) = LBOX1(II)
            ENDDO
C
C  LOOP OVER SPACES TO EXCITE ELECTRON FROM.
C
            IEBS = NB+1
            DO 7890 ISPB1=NSPACE,1,-1
               IOC1 = LBOX1(ISPB1)
               IEBE = IEBS - 1
               IEBS = IEBS - IOC1
               IF (IOC1.EQ.0) GOTO 7890
               LBOX2(ISPB1) = LBOX2(ISPB1)-1
C
C  LOOP ELECTRONS IN SPACE ISPB1.
C  IEBS, IEBE ARE THE ELECTRONS IN SPACE ISPB1.
C
               DO 7885 IB1=IEBE,IEBS,-1
                  IO1 = IBCON1(IB1)
                  IGBE = IEBE - LBOX1(ISPB1)
                  IS1 = IOB(IO1)
C
C  LOOP OVER POSSIBLE SPACES TO EXCITE INTO.
C
               DO 7880 ISPB2=ISPB1,NSPACE
C
C  IGBS, IGBE ARE ELECTRONS SPECIFYING ISPB2 SPACE ELECTRON LIMITS.
C
                  IGBS = IGBE + 1
                  IGBE = IGBE + LBOX1(ISPB2)
C
                  LBOX2(ISPB2) = LBOX2(ISPB2) + 1
                  IF (LBOX2(ISPB1).LT.IBMI(ISPB1)) GOTO 7870
C
C  MAKE GAP INFORMATION HERE.
C
                  IGBB = MAX(IB1+1,IGBS)
                  IF (LBOX1(ISPB2).EQ.0) THEN
                     ISTA = MSTA(ISPB2)
                     IEND = MSTA(ISPB2+1)-1
                  ELSEIF (ISPB2.EQ.ISPB1) THEN
                     ISTA = IO1+1
                     IEND = IBCON1(IGBB)-1
                     IF (IB1.EQ.IEBE) IEND=MSTA(ISPB1+1)-1
                  ELSE
                     ISTA = MSTA(ISPB2)
                     IEND = IBCON1(IGBB)-1
                  ENDIF
C
C  LOOP OVER GAPS
C
                  DO 7860 IGAP=IGBB,IGBE+1
C
                     DO 7850 JJ=ISTA,IEND
                        IS2 = IOB(JJ)
                        IP1 = LGMUL(IS1,IS2)
                        IND = INDEX(JJ) + IO1
C
              CALL REDE00(IBCON1,IBCON2,NB,IB1,IGAP-1,JJ,JPERB)
                  IF (LBOX2(ISPB2).GT.IBMA(ISPB2)) GOTO 7800
C
C   IF DEOCCUPIED AND NEWLY OCCUPIED ORBITALS ARE OF DIFFERENT SYMMETRY,
C   SKIP TO DOUBLES.
C
              IF (IS1.NE.IS2) GOTO 7800
C
C  GET GROUP NUMBER
C
           CALL POSITCO(LBOX5,NSPACE,NB,IBMA,IBMI,LBOX4,LBOX2,IGB2)
           NIBS = NBST(IGB2)
C
              CALL IDPOST(IBCON2,NB,LBOX2,NSPACE,MSTA,IDIM,Y,NX,LBST,
     *                  LBNDET(1,IGB2),IACON1,JPOSB)
              KBPOS = JPOSB + NIBS
              JPZB2 = LSPB(KBPOS)
C              KPER1 = ((-1)**JPERB)*2
              KPER1 = (-1)**JPERB
C
C  LOOP OVER ALPHA
C
              DO 7705 IGA=1,ITGA
              IF (LGCOM(IGB,IGA).NE.1.OR.LGCOM(IGB2,IGA).NE.1) GOTO 7705
                 JCIB1 = LDISB(KBSYM,IGB,IGA) + JPZB1
                 JCIB2 = LDISB(KBSYM,IGB2,IGA) + JPZB2
                 NIAS = NAST(IGA)
C
              DO 7685 KKA=LSAS(KSYM,IGA),LSAS(KSYM+1,IGA)-1
                 IENA1 = LSAC(KKA)
                 JCIA = LSPA(NIAS+IENA1)
                 JCI1 = JCIA + JCIB1
                 JCI2 = JCIA + JCIB2
                 FC = KPER1
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   CALL HSMLT1(AVEC,YAC,BVEC,RHSC,CI,OINT,AMAT,
     *                         FC,JCI1,JCI2,IND,IO1,JJ,JLO,
     *                         NSTATS,NCI,NDETLN,L1,NCOR,
     *                         NNACT,NXYZ,WSTATE,SALAG,ITER)
                 ENDIF
C
                 IF(JCI2.GE.JLO .AND. JCI2.LE.JHI) THEN
                   CALL HSMLT1(AVEC,YAC,BVEC,RHSC,CI,OINT,AMAT,
     *                         FC,JCI2,JCI1,IND,IO1,JJ,JLO,
     *                         NSTATS,NCI,NDETLN,L1,NCOR,
     *                         NNACT,NXYZ,WSTATE,SALAG,ITER)
                 ENDIF
C
 7685         CONTINUE
C
 7705         CONTINUE
C
              DO 7712 IK=1,NB
                 IF (IK.EQ.IB1) GOTO 7712
                 ION = IBCON1(IK)
                 J1 = INDEX(ION+1)
                 JMA = MAX(J1,IND)
                 JMI = MIN(J1,IND)
                 JMA = MAX(ION,JJ)
                 JMI = MIN(ION,JJ)
                 J2 = INDEX(JMA)+JMI
                 JMA = MAX(IO1,ION)
                 JMI = MIN(IO1,ION)
                 J3 = INDEX(JMA)+JMI
                 JMA = MAX(J2,J3)
                 JMI = MIN(J2,J3)
C
                 CALL VCLR(YAOG,1,NXYZ)
                 CALL HSMLTN(YAOG,YAOTMP,IO1,JJ,ION,ION,IND,
     *                       J1,NACT,NNACT,NXYZ,ONE)
                 CALL HSMLTN(YAOG,YAOTMP,IO1,ION,ION,JJ,J3,
     *                       J2,NACT,NNACT,NXYZ,-ONE)
C
C
              DO 7710 IGA=1,ITGA
              IF (LGCOM(IGB,IGA).NE.1.OR.LGCOM(IGB2,IGA).NE.1) GOTO 7710
                 JCIB1 = LDISB(KBSYM,IGB,IGA) + JPZB1
                 JCIB2 = LDISB(KBSYM,IGB2,IGA) + JPZB2
                 NIAS = NAST(IGA)
C
              DO 7695 KKA=LSAS(KSYM,IGA),LSAS(KSYM+1,IGA)-1
                 IENA1 = LSAC(KKA)
                 JCIA = LSPA(NIAS+IENA1)
                 JCI1 = JCIA + JCIB1
                 JCI2 = JCIA + JCIB2
                 FC = KPER1
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     CVAL = CI(JCI2,ISTAT)
                     WVAL = WSTATE(ISTAT)
                     IF(ABS(CVAL).GT.TOL) THEN
                       IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                       DVAL = CVAL*WVAL*FC
                       CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI1),1)
                     ENDIF
                   ENDDO
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         FC,JCI1,JCI2,IO1,JJ,ION,ION,IND,J1,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         -FC,JCI1,JCI2,IO1,ION,ION,JJ,J3,J2,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                 ENDIF
C
                 IF(JCI2.GE.JLO .AND. JCI2.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     CVAL = CI(JCI1,ISTAT)
                     WVAL = WSTATE(ISTAT)
                     IF(ABS(CVAL).GT.TOL) THEN
                       IWI2 = (ISTAT-1)*NDETLN + JCI2 - JLO + 1
                       DVAL = CVAL*WVAL*FC
                       CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI2),1)
                     ENDIF
                   ENDDO
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         FC,JCI2,JCI1,IO1,JJ,ION,ION,IND,J1,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         -FC,JCI2,JCI1,IO1,ION,ION,JJ,J3,J2,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                 ENDIF
C
 7695         CONTINUE
C
 7710         CONTINUE
C
 7712         CONTINUE
C
C  LOOP OVER ALPHA STRINGS OF THE RIGHT GROUP AND SYMMETRY.
C
              CALL RESETCO(LBOX3,NSPACE,NA,IAMA,IAMI,LBOX4)
C
              DO 7700 IGA=1,ITGA
              IF (LGCOM(IGB,IGA).NE.1.OR.LGCOM(IGB2,IGA).NE.1) GOTO 7690
                 JCIB1 = LDISB(KBSYM,IGB,IGA) + JPZB1
                 JCIB2 = LDISB(KBSYM,IGB2,IGA) + JPZB2
                 NIAS = NAST(IGA)
C
              CALL RESETDE(LBOX3,NSPACE,NA,MSTA,IACON1)
              ISTA1 = 1
              DO 7680 KKA=LSAS(KSYM,IGA),LSAS(KSYM+1,IGA)-1
                 IENA1 = LSAC(KKA)
                 DO IIZ=ISTA1,IENA1-1
                    CALL MOVEUP2(LBOX3,NSPACE,NA,MSTA,IACON1)
                 ENDDO
                 ISTA1 = IENA1
                 JCIA = LSPA(NIAS+IENA1)
                 JCI1 = JCIA + JCIB1
                 JCI2 = JCIA + JCIB2
                 FC = KPER1
C
                 DO 7670 IK=1,NA
                    ION = IACON1(IK)
                    J1 = INDEX(ION+1)
                    JMA = MAX(J1,IND)
                    JMI = MIN(J1,IND)
C
                 CALL VCLR(YAOG,1,NXYZ)
                 CALL HSMLTN(YAOG,YAOTMP,IO1,JJ,ION,ION,IND,
     *                       J1,NACT,NNACT,NXYZ,ONE)
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     CVAL = CI(JCI2,ISTAT)
                     WVAL = WSTATE(ISTAT)
                     IF(ABS(CVAL).GT.TOL) THEN
                       IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                       DVAL = CVAL*WVAL*FC
                       CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI1),1)
                     ENDIF
                   ENDDO
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         FC,JCI1,JCI2,IO1,JJ,ION,ION,IND,J1,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                 ENDIF
C
                 IF(JCI2.GE.JLO .AND. JCI2.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     CVAL = CI(JCI1,ISTAT)
                     WVAL = WSTATE(ISTAT)
                     IF(ABS(CVAL).GT.TOL) THEN
                       IWI2 = (ISTAT-1)*NDETLN + JCI2 - JLO + 1
                       DVAL = CVAL*WVAL*FC
                       CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI2),1)
                     ENDIF
                   ENDDO
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         FC,JCI2,JCI1,IO1,JJ,ION,ION,IND,J1,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                 ENDIF
C
 7670            CONTINUE
C
 7680         CONTINUE
C
 7690         CALL PUSHCO(LBOX3,NSPACE,NA,IAMA,IAMI,LBOX4,IEND)
 7700         CONTINUE
C
C  --- DOUBLE EXCITATIONS START HERE
C
 7800         CONTINUE
C
           IF (IB1.EQ.NB) GOTO 7850
           IF (JJ.EQ.NACT) GOTO 7850
C
            DO II=1,NSPACE
               LBOX3(II) = LBOX2(II)
            ENDDO
            IBES3 = 1
            DO KK=1,ISPB1-1
               IBES3 = IBES3 + LBOX2(KK)
            ENDDO
C
C  LOOP OVER SPACES TO EXCITE ELECTRONS FROM, MUST BE GE THAN
C  SPACE OF FIRST EXCITATION, ISPB1.
C
            DO 6890 ISPB3 = ISPB1,NSPACE
               IF (LBOX1(ISPB3).EQ.0) GOTO 6887
               IF (ISPB3.EQ.ISPB1.AND.IB1.EQ.IEBE) GOTO 6887
               IOC3 = LBOX2(ISPB3)
               IF (IOC3.EQ.0) GOTO 6887
C
               IBEE3 = IBES3 + LBOX2(ISPB3)-1
               LBOX3(ISPB3) = LBOX3(ISPB3)-1
C
C  LOOP OVER ELECTRONS IN ISPB3, WHICH ARE LARGER THAN IB1,
C  MAKING SURE IT ISN'T THE ALREADY EXCITED ELECTRON.
C
               JSTB3 = IBES3
               IF (ISPB3.EQ.ISPB1) THEN
                  JSTB3=IB1
                  IF (IGAP-1.EQ.IB1) JSTB3=JSTB3+1
               ENDIF
C
               DO 6880 IB3=JSTB3,IBEE3
                  IF (IB3.EQ.IGAP-1) GOTO 6880
                  IO3 = IBCON2(IB3)
                  IS3 = IOB(IO3)
C
C  LOOP OVER SPACES TO EXCITE ELECTRON INTO.  MUST BE GE THAN
C  SPACE FIRST ELECTRON WAS EXCITED INTO.
C
                  IGBE3 = 0
                  DO JIK=1,ISPB2-1
                     IGBE3 = IGBE3 + LBOX2(JIK)
                  ENDDO
                  DO 6850 ISPB4=ISPB2,NSPACE
C
C  IGBS3, IGBE3 ARE ELECTRONS SPECIFYING ISPB4 SPACE ELECTRON LIMITS.
C
                  LBOX3(ISPB4) = LBOX3(ISPB4) + 1
                  IGBS3 = IGBE3 + 1
                  IGBE3 = IGBE3 + LBOX2(ISPB4)
                  IF (LBOX3(ISPB3).LT.IBMI(ISPB3)) GOTO 6840
                  IF (LBOX3(ISPB4).GT.IBMA(ISPB4)) GOTO 6840
             IF (ISPB4.EQ.ISPB2.AND.JJ.EQ.MSTA(ISPB2+1)-1) GOTO 6840
C
C  GET GROUP NUMBER
C
               CALL POSITCO(LBOX5,NSPACE,NB,IBMA,IBMI,LBOX4,LBOX3,IGB3)
               NIBS3 = NBST(IGB3)
C
C  MAKE GAP INFORMATION HERE.
C
                  IGBB3 = MAX(IGBS3,IGAP)
C
                  IF (LBOX2(ISPB4).EQ.0) THEN
                     ISTA3 = MSTA(ISPB4)
                     IEND3 = MSTA(ISPB4+1)-1
                  ELSEIF (ISPB4.EQ.ISPB2) THEN
                     ISTA3 = JJ+1
                     IEND3 = IBCON2(IGBB3)-1
C
C  I AM SUSPECT ABOUT THIS NEXT LINE, WE'LL SEE WHAT HAPPENS.......
C
                     IF (IGAP-1.EQ.IGBE3) IEND3=MSTA(ISPB2+1)-1
C
                  ELSE
                     ISTA3 = MSTA(ISPB4)
                     IEND3 = IBCON2(IGBB3)-1
                  ENDIF
C
C  LOOP OVER GAPS
C
                  DO 6830 IGAP3=IGBB3,IGBE3+1
C
                     DO 6820 JJ3=ISTA3,IEND3
                        IS4 = IOB(JJ3)
                        IP2 = LGMUL(IS3,IS4)
                        IF (IP1.NE.IP2) GOTO 6820
C
              CALL REDE00(IBCON2,IACON1,NB,IB3,IGAP3-1,JJ3,JPERB3)
              CALL IDPOST(IACON1,NB,LBOX3,NSPACE,MSTA,IDIM,Y,NX,LBST,
     *                  LBNDET(1,IGB3),IACON2,JPOSB3)
C              IPER3 = ((-1)**(JPERB3+JPERB))*2
              IPER3 = (-1)**(JPERB3+JPERB)
              KBPOS3 = JPOSB3 + NIBS3
              JPZB3 = LSPB(KBPOS3)
C
                 JMA=MAX(JJ3,IO3)
                 JMI=MIN(JJ3,IO3)
                 I2 = INDEX(JMA) + JMI
                 II1 = INDEX(JJ3) + IO1
                 JMA=MAX(IO3,JJ)
                 JMI=MIN(IO3,JJ)
                 II2 = INDEX(JMA) + JMI
                 JMA=MAX(II1,II2)
                 JMI=MIN(II1,II2)
C
                 CALL VCLR(YAOG,1,NXYZ)
                 CALL HSMLTN(YAOG,YAOTMP,IO1,JJ,IO3,JJ3,IND,I2,NACT,
     *                       NNACT,NXYZ,ONE)
                 CALL HSMLTN(YAOG,YAOTMP,IO1,JJ3,IO3,JJ,II1,II2,NACT,
     *                       NNACT,NXYZ,-ONE)
C
C
C  LOOP OVER ALPHA STRINGS OF RIGHT SYMMETRY AND GROUP.
C
              DO 6700 IGA=1,ITGA
              IF (LGCOM(IGB,IGA).NE.1.OR.LGCOM(IGB3,IGA).NE.1) GOTO 6700
              JCIB1 = JPZB1 + LDISB(KBSYM,IGB,IGA)
              JCIB3 = JPZB3 + LDISB(KBSYM,IGB3,IGA)
              NIAS = NAST(IGA)
C
              DO 6680 KKA=LSAS(KSYM,IGA),LSAS(KSYM+1,IGA)-1
                 IENA3 = LSAC(KKA)
                 JCIA = LSPA(NIAS+IENA3)
                 JCI1 = JCIA + JCIB1
                 JCI3 = JCIA + JCIB3
                 FC = IPER3
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     CVAL = CI(JCI3,ISTAT)
                     WVAL = WSTATE(ISTAT)
                     IF(ABS(CVAL).GT.TOL) THEN
                       IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                       DVAL = CVAL*WVAL*FC
                       CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI1),1)
                     ENDIF
                   ENDDO
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         FC,JCI1,JCI3,IO1,JJ,IO3,JJ3,IND,I2,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         -FC,JCI1,JCI3,IO1,JJ3,IO3,JJ,II1,II2,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                 ENDIF
C
                 IF(JCI3.GE.JLO .AND. JCI3.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     CVAL = CI(JCI1,ISTAT)
                     WVAL = WSTATE(ISTAT)
                     IF(ABS(CVAL).GT.TOL) THEN
                       IWI3 = (ISTAT-1)*NDETLN + JCI3 - JLO + 1
                       DVAL = CVAL*WVAL*FC
                       CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI3),1)
                     ENDIF
                   ENDDO
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         FC,JCI3,JCI1,IO1,JJ,IO3,JJ3,IND,I2,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         -FC,JCI3,JCI1,IO1,JJ3,IO3,JJ,II1,II2,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                 ENDIF
C
 6680         CONTINUE
C
 6700         CONTINUE
C
 6820                CONTINUE
C
                     ISTA3 = IBCON2(IGAP3)+1
                     IEND3 = IBCON2(IGAP3+1)-1
                     IF (IGAP3.EQ.IGBE3) IEND3=MSTA(ISPB4+1)-1
 6830             CONTINUE
C
 6840             LBOX3(ISPB4) = LBOX3(ISPB4) - 1
 6850             CONTINUE
C
 6880          CONTINUE
C
               LBOX3(ISPB3) = LBOX3(ISPB3)+1
 6887          IBES3 = IBES3 + LBOX3(ISPB3)
 6890       CONTINUE
C
C  --- END OF LOOP OVER DOUBLE BETA EXCITATIONS.
C
 7850                CONTINUE
C
                  ISTA = IBCON1(IGAP)+1
                  IEND = IBCON1(IGAP+1)-1
                  IF (IGAP.EQ.IGBE) IEND=MSTA(ISPB2+1)-1
 7860             CONTINUE
C
 7870             LBOX2(ISPB2) = LBOX2(ISPB2) - 1
 7880          CONTINUE
C
 7885          CONTINUE
C
               LBOX2(ISPB1) = LBOX2(ISPB1)+1
 7890       CONTINUE
C
C REMAINING DIAGONAL CONTRIBUTIONS HERE
C
            DO 69 II=1,NB
               I1 = IBCON1(II)
               IND1 = INDEX(I1+1)
C
              DO 6705 IGA=1,ITGA
              IF (LGCOM(IGB,IGA).NE.1) GOTO 6705
              JCIB1 = JPZB1 + LDISB(KBSYM,IGB,IGA)
              NIAS = NAST(IGA)
C
              DO 6685 KKA=LSAS(KSYM,IGA),LSAS(KSYM+1,IGA)-1
                 IENA3 = LSAC(KKA)
                 JCIA = LSPA(NIAS+IENA3)
                 JCI1 = JCIA + JCIB1
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   CALL HSMLT1(AVEC,YAC,BVEC,RHSC,CI,OINT,AMAT,
     *                         ONE,JCI1,JCI1,IND1,I1,I1,JLO,
     *                         NSTATS,NCI,NDETLN,L1,NCOR,
     *                         NNACT,NXYZ,WSTATE,SALAG,ITER)
                 ENDIF
C
 6685         CONTINUE
C
 6705         CONTINUE
C
              DO 74 JJ=II+1,NB
                 I2 = IBCON1(JJ)
                 IND2 = INDEX(I2+1)
                 INDM = IND2 - I2 + I1
                 J1 = INDEX(INDM+1)
                 JMI = MIN(IND1,IND2)
                 JMA = MAX(IND1,IND2)
                 J2 = INDEX(JMA) + JMI
C
                 CALL VCLR(YAOG,1,NXYZ)
                 CALL HSMLTN(YAOG,YAOTMP,I1,I1,I2,I2,IND1,IND2,NACT,
     *                       NNACT,NXYZ,ONE)
                 CALL HSMLTN(YAOG,YAOTMP,I1,I2,I2,I1,INDM,INDM,NACT,
     *                       NNACT,NXYZ,-ONE)
C
C
              DO 6710 IGA=1,ITGA
              IF (LGCOM(IGB,IGA).NE.1) GOTO 6710
              JCIB1 = JPZB1 + LDISB(KBSYM,IGB,IGA)
              NIAS = NAST(IGA)
C
              DO 6690 KKA=LSAS(KSYM,IGA),LSAS(KSYM+1,IGA)-1
                 IENA3 = LSAC(KKA)
                 JCIA = LSPA(NIAS+IENA3)
                 JCI1 = JCIA + JCIB1
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   DO ISTAT=1,NSTATS
                     CVAL = CI(JCI1,ISTAT)
                     WVAL = WSTATE(ISTAT)
                     IF(ABS(CVAL).GT.TOL) THEN
                       IWI1 = (ISTAT-1)*NDETLN + JCI1 - JLO + 1
                       DVAL = CVAL*WVAL
                       CALL DAXPY(NXYZ,DVAL,YAOG,1,RHSC(1,IWI1),1)
                     ENDIF
                   ENDDO
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         ONE,JCI1,JCI1,I1,I1,I2,I2,IND1,IND2,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                   CALL HSMLT2(YADEN,YAC,RHSC,WSTATE,CI,ERI,WRK,
     *                         -ONE,JCI1,JCI1,I1,I2,I2,I1,INDM,INDM,
     *                         NACT,NNACT,NSTATS,NXYZ,NCI,NDETLN,
     *                         JLO,L1,NCOR,SALAG,ITER,RUN)
                 ENDIF
C
 6690         CONTINUE
C
 6710         CONTINUE
C
   74         CONTINUE
C
   69         CONTINUE
C
            CALL MOVEUP2(LBOX1,NSPACE,NB,MSTA,IBCON1)
 7900    CONTINUE
C
         CALL PUSHCO(LBOX1,NSPACE,NB,IBMA,IBMI,LBOX5,IEND)
 8000 CONTINUE
C
C  --- END OF LOOP OVER BETA STRINGS. ---
C
      CALL FMRHSO(RHSO,YADEN,BVEC,ERI,AMAT,OINT,WRK,IROT,INDEX2,NACT,
     *            NNACT,NCOR,NXYZ,L1,NROT,NINDX)
C
      RETURN
      END
C*MODULE CPMCHF  *DECK FCPSUP
C     ------------------------------------------------------------------
      SUBROUTINE FCPSUP(IW,NA,NB,NACT,IACON1,IBCON1,IBCON2,
     *           INDEX,NBST,LSPB,
     *           LBOX1,LBOX2,LBOX3,LBOX4,
     *           X,NX,LBNDET,LSYMB,NSYM,ITGB,IBST,
     *           NB1EX,JB1GR,JB1PE,JB1IN,JB1PO,JB1ST,JB1SY,JB1IN2)
C     ------------------------------------------------------------------
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      LOGICAL FDIRCT,QCORR
C
      COMMON /FCCWFN/ NSPACE,MSTA(51),MNUM(51),MINI(51),MAXI(51),
     *                IAMI(51),IAMA(51),IBMI(51),IBMA(51),IDIM(51),
     *                LBST(51),NREF0,FDIRCT,QCORR,C0SQ
C
      DIMENSION IACON1(NA),IBCON1(NB),IBCON2(NB)
      DIMENSION INDEX((NACT*(NACT+1))/2+1)
      DIMENSION LBOX1(NSPACE),LBOX2(NSPACE),LBOX3(NSPACE)
      DIMENSION LBOX4(NSPACE)
      DIMENSION NBST(ITGB+1),LSPB(IBST)
      DIMENSION X(NX)
      DIMENSION LBNDET(NSPACE,ITGB),LSYMB(IBST)
      DIMENSION JB1GR(NB1EX),JB1PE(NB1EX),JB1IN(NB1EX),JB1PO(NB1EX)
      DIMENSION JB1ST(NSYM+1,IBST+1),JB1SY(NB*(NACT-NB))
      DIMENSION JB1IN2(NB1EX,2)
C
C  MAKE AND STORE ALL B -> B' DATA, WHERE B' > B.
C
      NB1CH = 0
      INB = 0
C
C  LOOP THROUGH ALL BETA GROUPS
C
      CALL RESETCO(LBOX1,NSPACE,NB,IBMA,IBMI,LBOX3)
C
      DO 1000 IIB = 1,ITGB
C
         CALL RESETDE(LBOX1,NSPACE,NB,MSTA,IBCON1)
C
         DO 900 KKB=NBST(IIB)+1,NBST(IIB+1)
            INB = INB + 1
            DO II=1,NSPACE
               LBOX2(II) = LBOX1(II)
            ENDDO
            JB1ST(1,INB) = NB1CH+1
            KBST = NB1CH+1
C
C  LOOP OVER ALL SINGLE EXCITATIONS, CHECKING TO SEE IF IT IS VALID.
C
C  LOOP OVER SPACES TO EXCITE ELECTRON FROM.
C
            IEBS = NB+1
            DO 890 ISPB1=NSPACE,1,-1
               IOC1 = LBOX1(ISPB1)
               IEBE = IEBS - 1
               IEBS = IEBS - IOC1
               IF (IOC1.EQ.0) GO TO 890
               LBOX2(ISPB1) = LBOX2(ISPB1)-1
C
C  LOOP ELECTRONS IN SPACE ISPB1
C  IEBS, IEBE ARE THE ELECTRONS IN SPACE ISPB1
C
               DO 885 IB1 = IEBE,IEBS,-1
                  IO1 = IBCON1(IB1)
                  IGBE = IEBE - LBOX1(ISPB1)
C
C  LOOP OVER POSSIBLE SPACES TO EXCITE INTO.
C
               DO 880 ISPB2=ISPB1,NSPACE
C
C  IGBS,IGBE ARE ELECTRONS SPECIFYING ISPB2 SPACE ELECTRON LIMITS.
C
                  IGBS = IGBE + 1
                  IGBE = IGBE + LBOX1(ISPB2)
C
                  LBOX2(ISPB2) = LBOX2(ISPB2) + 1
                  IF (LBOX2(ISPB1).LT.IBMI(ISPB1)) GO TO 870
                  IF (LBOX2(ISPB2).GT.IBMA(ISPB2)) GO TO 870
C
C  GET GROUP NUMBER
C
          CALL POSITCO(LBOX4,NSPACE,NB,IBMA,IBMI,LBOX3,LBOX2,IGB)
          NIAS = NBST(IGB)
C
C  MAKE GAP INFORMATION HERE.
C
                  IGBA = MAX(IB1+1,IGBS)
                  IF (LBOX1(ISPB2).EQ.0) THEN
                     ISTA = MSTA(ISPB2)
                     IEND = MSTA(ISPB2+1)-1
                  ELSEIF (ISPB2.EQ.ISPB1) THEN
                     ISTA = IO1+1
                     IEND = IBCON1(IGBA)-1
                     IF (IB1.EQ.IEBE) IEND=MSTA(ISPB1+1)-1
                  ELSE
                     ISTA = MSTA(ISPB2)
                     IEND = IBCON1(IGBA)-1
                  ENDIF
C
C  LOOP OVER GAPS
C
                  DO 860 IGAP=IGBA,IGBE+1
C
                     DO 850 JJ=ISTA,IEND
C
                        NB1CH = NB1CH + 1
                        JB1GR(NB1CH) = IGB
                        JB1IN(NB1CH) = INDEX(JJ)+IO1
                        JB1IN2(NB1CH,1) = IO1
                        JB1IN2(NB1CH,2) = JJ
C
            CALL REDE00(IBCON1,IBCON2,NB,IB1,IGAP-1,JJ,IPER)
            CALL IDPOST(IBCON2,NB,LBOX2,NSPACE,MSTA,IDIM,X,NX,LBST,
     *                  LBNDET(1,IGB),IACON1,IPOSB)
C
                        JB1PE(NB1CH) = (-1)**IPER
                        JB1PO(NB1CH) = LSPB(IPOSB+NIAS)
                        JB1SY(NB1CH-KBST+1) = LSYMB(IPOSB+NIAS)
C
  850                CONTINUE
C
                  ISTA = IBCON1(IGAP)+1
                  IEND = IBCON1(IGAP+1)-1
                  IF (IGAP.EQ.IGBE) IEND=MSTA(ISPB2+1)-1
  860             CONTINUE
C
  870             LBOX2(ISPB2) = LBOX2(ISPB2) - 1
  880          CONTINUE
C
  885          CONTINUE
C
               LBOX2(ISPB1) = LBOX2(ISPB1) + 1
  890       CONTINUE
C
C  ORDER THESE EXCITATIONS FOR BETA INB ACCORDING TO SYMMETRY.
C
            KNUM = NB1CH - KBST + 1
            CALL FCPSRT2(JB1GR(KBST),JB1PE(KBST),JB1IN(KBST),
     *                   JB1PO(KBST),JB1SY,KNUM,JB1IN2(KBST,1),
     *                   JB1IN2(KBST,2))
C
C  MAKE THE SYMMETRY STARTING POINTS
C ----
            IST=1
            DO 100 II=1,NSYM
               DO 200 JJ=IST,KNUM
                  IF (JB1SY(JJ).NE.II) GO TO 180
  200          CONTINUE
  180          JB1ST(II+1,INB) = JJ+KBST-1
               IST = JJ
  100       CONTINUE
C ----
C
C  REORDER WITHIN EACH SYMMETRY BY POSITION.
C
            IJST=JB1ST(1,INB)
            DO 300 II=1,NSYM
               JSTA=JB1ST(II,INB)
               JEND=JB1ST(II+1,INB)
               JNUM=JEND-JSTA
               IF (JNUM.LE.1) GO TO 300
               CALL FCPSRT2(JB1GR(JSTA),JB1PE(JSTA),JB1IN(JSTA),
     *                      JB1SY(JSTA-IJST+1),JB1PO(JSTA),JNUM,
     *                      JB1IN2(JSTA,1),JB1IN2(JSTA,2))
  300       CONTINUE
C
            CALL MOVEUP2(LBOX1,NSPACE,NB,MSTA,IBCON1)
  900    CONTINUE
C
         CALL PUSHCO(LBOX1,NSPACE,NB,IBMA,IBMI,LBOX3,IEND)
C
 1000 CONTINUE
C
      IF (NB1CH.NE.NB1EX) THEN
         WRITE(IW,9000)
         CALL ABRT
         STOP
      ENDIF
      JB1ST(1,IBST+1) = NB1CH+1
C
      RETURN
C
 9000 FORMAT(/1X,'ERROR IN CALCULATION OF SINGLE BETA EXCITES !!! ')
C
      END
C*MODULE CPMCHF  *DECK ORMDD1
C     ------------------------------------------------------------------
      SUBROUTINE ORMDD1(DDEN,DCI,NDETLN,
     *           NXYZ,JLO,JHI,M2,NACT,NA,NB,X,NX,CI,
     *           INDEX,NSYM,IOB,
     *           LBOX1,LBOX2,LBOX4,LBOX5,
     *           KTAB,IACON1,IACON2,IBCON1,IBCON2,
     *           LANDET,LBNDET,NAST,NBST,LSYMA,LSYMB,LGCOM,
     *           LSPA,LSPB,LDISB,LSAS,LSBS,LSAC,
     *           ITGA,ITGB,IAST,IBST)
C     ------------------------------------------------------------------
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      LOGICAL FDIRCT,QCORR
C
      COMMON /FCCWFN/ NSPACE,MSTA(51),MNUM(51),MINI(51),MAXI(51),
     *                IAMI(51),IAMA(51),IBMI(51),IBMA(51),IDIM(51),
     *                LBST(51),NREF0,FDIRCT,QCORR,C0SQ
C
      DIMENSION DDEN(NXYZ,M2),DCI(NXYZ,NDETLN),X(NX),CI(*)
      DIMENSION INDEX((NACT*(NACT+1))/2+1),IOB(NACT)
      DIMENSION LBOX1(NSPACE),LBOX2(NSPACE)
      DIMENSION LBOX4(NSPACE),LBOX5(NSPACE)
      DIMENSION KTAB(NSYM)
      DIMENSION IACON1(NA),IACON2(NA),IBCON1(NA),IBCON2(NA)
      DIMENSION LANDET(NSPACE,ITGA),LBNDET(NSPACE,ITGB)
      DIMENSION NAST(ITGA+1),NBST(ITGB+1)
      DIMENSION LSYMA(IAST),LSYMB(IBST),LGCOM(ITGB,ITGA)
      DIMENSION LSPA(IAST),LSPB(IBST),LDISB(NSYM,ITGB,ITGA)
      DIMENSION LSAS(NSYM+1,ITGA),LSBS(NSYM+1,ITGB)
      DIMENSION LSAC(IAST)
C
      PARAMETER (TWO=2.0D+00)
C
      CALL VCLR(DDEN,1,M2*NXYZ)
C
C ---  BIG LOOP OVER ALL ALPHA DETERMINANTS ---
C
      CALL RESETCO(LBOX1,NSPACE,NA,IAMA,IAMI,LBOX5)
C
      DO 5000 IGA=1,ITGA
C
         CALL RESETDE(LBOX1,NSPACE,NA,MSTA,IACON1)
C
C  KKA GIVES THE ACTUAL POSITION OF THE ALPHA STRING IACON1 IN
C  THE FULL ALPHA STRING LIST.
C
         DO 4900 KKA=NAST(IGA)+1,NAST(IGA+1)
            JPZA1 = LSPA(KKA)
            JASYM = LSYMA(KKA)
            KSYM=KTAB(JASYM)
C
            DO II=1,NSPACE
               LBOX2(II) = LBOX1(II)
            ENDDO
C
C  LOOP OVER SPACES TO EXCITE ELECTRON FROM.
C
            IEAS = NA+1
            DO 4890 ISPA1=NSPACE,1,-1
               IOC1 = LBOX1(ISPA1)
               IEAE = IEAS - 1
               IEAS = IEAS - IOC1
               IF (IOC1.EQ.0) GO TO 4890
               LBOX2(ISPA1) = LBOX2(ISPA1)-1
C
C  LOOP ELECTRONS IN SPACE ISPA1.
C  IEAS, IEAE ARE THE ELECTRONS IN SPACE ISPA1.
C
               DO 4885 IA1=IEAE,IEAS,-1
                  IO1 = IACON1(IA1)
                  IGAE = IEAE - LBOX1(ISPA1)
                  IS1 = IOB(IO1)
C
C  LOOP OVER POSSIBLE SPACES TO EXCITE INTO.
C
               DO 4880 ISPA2=ISPA1,NSPACE
C
C  IGAS, IGAE ARE ELECTRONS SPECIFYING ISPA2 SPACE ELECTRON LIMITS.
C
                  IGAS = IGAE + 1
                  IGAE = IGAE + LBOX1(ISPA2)
C
                  LBOX2(ISPA2) = LBOX2(ISPA2) + 1
                  IF (LBOX2(ISPA1).LT.IAMI(ISPA1)) GO TO 4870
                  IF (LBOX2(ISPA2).GT.IAMA(ISPA2)) GO TO 4870
C
C  GET GROUP NUMBER
C
           CALL POSITCO(LBOX5,NSPACE,NA,IAMA,IAMI,LBOX4,LBOX2,IGA2)
           NIAS = NAST(IGA2)
C
C  MAKE GAP INFORMATION HERE.
C
                  IGAA = MAX(IA1+1,IGAS)
                  IF (LBOX1(ISPA2).EQ.0) THEN
                     ISTA = MSTA(ISPA2)
                     IEND = MSTA(ISPA2+1)-1
                  ELSEIF (ISPA2.EQ.ISPA1) THEN
                     ISTA = IO1+1
                     IEND = IACON1(IGAA)-1
                     IF (IA1.EQ.IEAE) IEND=MSTA(ISPA1+1)-1
                  ELSE
                     ISTA = MSTA(ISPA2)
                     IEND = IACON1(IGAA)-1
                  ENDIF
C
C  LOOP OVER GAPS
C
                  DO 4860 IGAP=IGAA,IGAE+1
C
                     DO 4850 JJ=ISTA,IEND
                        IS2 = IOB(JJ)
C
C   IF DEOCCUPIED AND NEWLY OCCUPIED ORBITALS ARE OF DIFFERENT SYMMETRY,
C   SKIP.
C
              IF (IS1.NE.IS2) GO TO 4850
C
              IND = INDEX(JJ) + IO1
C
              CALL REDE00(IACON1,IACON2,NA,IA1,IGAP-1,JJ,JPERA)
              CALL IDPOST(IACON2,NA,LBOX2,NSPACE,MSTA,IDIM,X,NX,LBST,
     *                  LANDET(1,IGA2),IBCON1,JPOSA)
              KAPOS = JPOSA + NIAS
              JPZA2 = LSPA(KAPOS)
              KPER1 = (-1)**JPERA
C
C  LOOP OVER BETA STRINGS OF RIGHT SYMMETRY AND GROUP
C
              DO 4700 IGB=1,ITGB
              IF (LGCOM(IGB,IGA).NE.1.OR.LGCOM(IGB,IGA2).NE.1) GOTO 4700
              JCI1 = JPZA1 + LDISB(KSYM,IGB,IGA)
              JCI2 = JPZA2 + LDISB(KSYM,IGB,IGA2)
C
              DO 4680 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                 JCI1 = JCI1 + 1
                 JCI2 = JCI2 + 1
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   FC = CI(JCI2)*KPER1
                   IWI1 = JCI1 - JLO + 1
                   CALL DAXPY(NXYZ,FC,DCI(1,IWI1),1,DDEN(1,IND),1)
                 ENDIF
C
                 IF(JCI2.GE.JLO .AND. JCI2.LE.JHI) THEN
                   FC = CI(JCI1)*KPER1
                   IWI2 = JCI2 - JLO + 1
                   CALL DAXPY(NXYZ,FC,DCI(1,IWI2),1,DDEN(1,IND),1)
                 ENDIF
C
 4680         CONTINUE
C
 4700         CONTINUE
C
 4850          CONTINUE
C
                  ISTA = IACON1(IGAP)+1
                  IEND = IACON1(IGAP+1)-1
                  IF (IGAP.EQ.IGAE) IEND=MSTA(ISPA2+1)-1
 4860             CONTINUE
C
 4870             LBOX2(ISPA2) = LBOX2(ISPA2) - 1
 4880          CONTINUE
C
 4885          CONTINUE
C
               LBOX2(ISPA1) = LBOX2(ISPA1)+1
 4890       CONTINUE
C
C   DIAGONAL CONTRIBUTIONS HERE.
C
            DO 67 II=1,NA
               I1 = IACON1(II)
               IND1 = INDEX(I1+1)
C
               DO 53 IGB=1,ITGB
                  IF (LGCOM(IGB,IGA).NE.1) GO TO 53
                  JCI1 = JPZA1 + LDISB(KSYM,IGB,IGA)
                  DO 58 KKB=LSBS(KSYM,IGB),LSBS(KSYM+1,IGB)-1
                     JCI1 = JCI1 + 1
C
                     IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                       FC = TWO*CI(JCI1)
                       IWI1 = JCI1 - JLO + 1
                       CALL DAXPY(NXYZ,FC,DCI(1,IWI1),1,DDEN(1,IND1),1)
                     ENDIF
C
   58             CONTINUE
   53          CONTINUE
C
   67       CONTINUE
C
            CALL MOVEUP2(LBOX1,NSPACE,NA,MSTA,IACON1)
 4900    CONTINUE
C
         CALL PUSHCO(LBOX1,NSPACE,NA,IAMA,IAMI,LBOX5,IEND)
 5000 CONTINUE
C
C  --- END OF LOOP OVER ALPHA STRINGS ----
C
C  --- BIG LOOP OVER BETA -----
C
      CALL RESETCO(LBOX1,NSPACE,NB,IBMA,IBMI,LBOX5)
C
      DO 8000 IGB=1,ITGB
C
         CALL RESETDE(LBOX1,NSPACE,NB,MSTA,IBCON1)
C
C  KKB GIVES THE ACTUAL POSITION OF THE BETA STRING IBCON1 IN
C  THE FULL BETA STRING LIST.
C
         DO 7900 KKB=NBST(IGB)+1,NBST(IGB+1)
            JPZB1 = LSPB(KKB)
            KBSYM = LSYMB(KKB)
            KSYM=KTAB(KBSYM)
C
            DO II=1,NSPACE
               LBOX2(II) = LBOX1(II)
            ENDDO
C
C  LOOP OVER SPACES TO EXCITE ELECTRON FROM.
C
            IEBS = NB+1
            DO 7890 ISPB1=NSPACE,1,-1
               IOC1 = LBOX1(ISPB1)
               IEBE = IEBS - 1
               IEBS = IEBS - IOC1
               IF (IOC1.EQ.0) GO TO 7890
               LBOX2(ISPB1) = LBOX2(ISPB1)-1
C
C  LOOP ELECTRONS IN SPACE ISPB1.
C  IEBS, IEBE ARE THE ELECTRONS IN SPACE ISPB1.
C
               DO 7885 IB1=IEBE,IEBS,-1
                  IO1 = IBCON1(IB1)
                  IGBE = IEBE - LBOX1(ISPB1)
                  IS1 = IOB(IO1)
C
C  LOOP OVER POSSIBLE SPACES TO EXCITE INTO.
C
               DO 7880 ISPB2=ISPB1,NSPACE
C
C  IGBS, IGBE ARE ELECTRONS SPECIFYING ISPB2 SPACE ELECTRON LIMITS.
C
                  IGBS = IGBE + 1
                  IGBE = IGBE + LBOX1(ISPB2)
C
                  LBOX2(ISPB2) = LBOX2(ISPB2) + 1
                  IF (LBOX2(ISPB1).LT.IBMI(ISPB1)) GO TO 7870
                  IF (LBOX2(ISPB2).GT.IBMA(ISPB2)) GO TO 7870
C
C  GET GROUP NUMBER
C
           CALL POSITCO(LBOX5,NSPACE,NB,IBMA,IBMI,LBOX4,LBOX2,IGB2)
           NIBS = NBST(IGB2)
C
C  MAKE GAP INFORMATION HERE.
C
                  IGBB = MAX(IB1+1,IGBS)
                  IF (LBOX1(ISPB2).EQ.0) THEN
                     ISTA = MSTA(ISPB2)
                     IEND = MSTA(ISPB2+1)-1
                  ELSEIF (ISPB2.EQ.ISPB1) THEN
                     ISTA = IO1+1
                     IEND = IBCON1(IGBB)-1
                     IF (IB1.EQ.IEBE) IEND=MSTA(ISPB1+1)-1
                  ELSE
                     ISTA = MSTA(ISPB2)
                     IEND = IBCON1(IGBB)-1
                  ENDIF
C
C  LOOP OVER GAPS
C
                  DO 7860 IGAP=IGBB,IGBE+1
C
                     DO 7850 JJ=ISTA,IEND
                        IS2 = IOB(JJ)
                        IND = INDEX(JJ) + IO1
C
C   IF DEOCCUPIED AND NEWLY OCCUPIED ORBITALS ARE OF DIFFERENT SYMMETRY,
C   SKIP TO DOUBLES.
C
                        IF (IS1.NE.IS2) GO TO 7850
C
              CALL REDE00(IBCON1,IBCON2,NB,IB1,IGAP-1,JJ,JPERB)
C
              CALL IDPOST(IBCON2,NB,LBOX2,NSPACE,MSTA,IDIM,X,NX,LBST,
     *                  LBNDET(1,IGB2),IACON1,JPOSB)
              KBPOS = JPOSB + NIBS
              JPZB2 = LSPB(KBPOS)
              KPER1 = (-1)**JPERB
C
C  LOOP OVER ALPHA STRINGS OF THE RIGHT GROUP AND SYMMETRY.
C
              DO 7700 IGA=1,ITGA
              IF (LGCOM(IGB,IGA).NE.1.OR.LGCOM(IGB2,IGA).NE.1) GOTO 7700
                 JCIB1 = LDISB(KBSYM,IGB,IGA) + JPZB1
                 JCIB2 = LDISB(KBSYM,IGB2,IGA) + JPZB2
                 NIAS = NAST(IGA)
C
              DO 7680 KKA=LSAS(KSYM,IGA),LSAS(KSYM+1,IGA)-1
                 IENA1 = LSAC(KKA)
                 JCIA = LSPA(NIAS+IENA1)
                 JCI1 = JCIA + JCIB1
                 JCI2 = JCIA + JCIB2
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   FC = KPER1*CI(JCI2)
                   IWI1 = JCI1 - JLO + 1
                   CALL DAXPY(NXYZ,FC,DCI(1,IWI1),1,DDEN(1,IND),1)
                 ENDIF
C
                 IF(JCI2.GE.JLO .AND. JCI2.LE.JHI) THEN
                   FC = KPER1*CI(JCI1)
                   IWI2 = JCI2 - JLO + 1
                   CALL DAXPY(NXYZ,FC,DCI(1,IWI2),1,DDEN(1,IND),1)
                 ENDIF
C
 7680         CONTINUE
 7700         CONTINUE
C
 7850                CONTINUE
C
                  ISTA = IBCON1(IGAP)+1
                  IEND = IBCON1(IGAP+1)-1
                  IF (IGAP.EQ.IGBE) IEND=MSTA(ISPB2+1)-1
 7860             CONTINUE
C
 7870             LBOX2(ISPB2) = LBOX2(ISPB2) - 1
 7880          CONTINUE
C
 7885          CONTINUE
C
               LBOX2(ISPB1) = LBOX2(ISPB1)+1
 7890       CONTINUE
C
C  REMAINING PART OF DIAGONAL CONTRIBUTIONS.
C
            DO 69 II=1,NB
               I1 = IBCON1(II)
               IND1 = INDEX(I1+1)
C
              DO 76 IGA=1,ITGA
              IF (LGCOM(IGB,IGA).NE.1) GO TO 76
                 JCIB1 = LDISB(KBSYM,IGB,IGA) + JPZB1
                 NIAS = NAST(IGA)
C
              DO 78 KKA=LSAS(KSYM,IGA),LSAS(KSYM+1,IGA)-1
                 IENA1 = LSAC(KKA)
                 JCIA = LSPA(NIAS+IENA1)
                 JCI1 = JCIA + JCIB1
C
                 IF(JCI1.GE.JLO .AND. JCI1.LE.JHI) THEN
                   FC = TWO*CI(JCI1)
                   IWI1 = JCI1 - JLO + 1
                   CALL DAXPY(NXYZ,FC,DCI(1,IWI1),1,DDEN(1,IND1),1)
                 ENDIF
C
   78         CONTINUE
   76         CONTINUE
C
   69       CONTINUE
C
            CALL MOVEUP2(LBOX1,NSPACE,NB,MSTA,IBCON1)
 7900    CONTINUE
C
         CALL PUSHCO(LBOX1,NSPACE,NB,IBMA,IBMI,LBOX5,IEND)
 8000 CONTINUE
C
      RETURN
C
      END
C*MODULE CPMCHF  *DECK FCPSRT2
C     ------------------------------------------------------
      SUBROUTINE FCPSRT2(JB1GR,JB1PE,JB1IN,JB1PO,JB1SY,N,JB1INI,JB1INJ)
C     ------------------------------------------------------
      IMPLICIT INTEGER(A-Z)
      DIMENSION JB1GR(N),JB1PE(N),JB1IN(N),JB1PO(N),JB1SY(N)
      DIMENSION JB1INI(N),JB1INJ(N)
C
C    SORTING GARBAGE.
C
      IF (N.LT.2) RETURN
      L=N/2+1
      IR=N
C
   10 CONTINUE
         IF (L.GT.1) THEN
            L=L-1
            IRRA=JB1SY(L)
            IRRB=JB1GR(L)
            IRRC=JB1PE(L)
            IRRD=JB1IN(L)
            IRRE=JB1PO(L)
            IRRI=JB1INI(L)
            IRRJ=JB1INJ(L)
         ELSE
            IRRA=JB1SY(IR)
            IRRB=JB1GR(IR)
            IRRC=JB1PE(IR)
            IRRD=JB1IN(IR)
            IRRE=JB1PO(IR)
            IRRI=JB1INI(IR)
            IRRJ=JB1INJ(IR)
            JB1SY(IR)=JB1SY(1)
            JB1GR(IR)=JB1GR(1)
            JB1PE(IR)=JB1PE(1)
            JB1IN(IR)=JB1IN(1)
            JB1PO(IR)=JB1PO(1)
            JB1INI(IR)=JB1INI(1)
            JB1INJ(IR)=JB1INJ(1)
C
            IR=IR-1
            IF (IR.EQ.1) THEN
               JB1SY(1)=IRRA
               JB1GR(1)=IRRB
               JB1PE(1)=IRRC
               JB1IN(1)=IRRD
               JB1PO(1)=IRRE
               JB1INI(1)=IRRI
               JB1INJ(1)=IRRJ
C
               GO TO 122
            ENDIF
         ENDIF
         I=L
         J=L+L
   20    IF (J.LE.IR) THEN
            IF (J.LT.IR) THEN
                   IF (JB1SY(J).LT.JB1SY(J+1)) J=J+1
            ENDIF
            IF (IRRA.LT.JB1SY(J)) THEN
               JB1SY(I)=JB1SY(J)
               JB1GR(I)=JB1GR(J)
               JB1PE(I)=JB1PE(J)
               JB1IN(I)=JB1IN(J)
               JB1PO(I)=JB1PO(J)
               JB1INI(I) = JB1INI(J)
               JB1INJ(I) = JB1INJ(J)
               I=J
               J=J+J
            ELSE
               J=IR+1
            ENDIF
         GO TO 20
         ENDIF
         JB1SY(I)=IRRA
         JB1GR(I)=IRRB
         JB1PE(I)=IRRC
         JB1IN(I)=IRRD
         JB1PO(I)=IRRE
         JB1INI(I)=IRRI
         JB1INJ(I)=IRRJ
      GO TO 10
C
  122 CONTINUE
C
      RETURN
      END
C*MODULE CPMCHF  *DECK FCPSRT3
C     ------------------------------------------------------
      SUBROUTINE FCPSRT3(JB1GR,JB1PE,JB1IN,JB1SY,N,JB1INI,JB1INJ)
C     ------------------------------------------------------
      IMPLICIT INTEGER(A-Z)
      DIMENSION JB1GR(N),JB1PE(N),JB1IN(N),JB1SY(N),JB1INI(N),JB1INJ(N)
C
C    SORTING GARBAGE.
C
      IF (N.LT.2) RETURN
      L=N/2+1
      IR=N
C
   10 CONTINUE
         IF (L.GT.1) THEN
            L=L-1
            IRRA=JB1SY(L)
            IRRB=JB1GR(L)
            IRRC=JB1PE(L)
            IRRD=JB1IN(L)
            IRRI=JB1INI(L)
            IRRJ=JB1INJ(L)
         ELSE
            IRRA=JB1SY(IR)
            IRRB=JB1GR(IR)
            IRRC=JB1PE(IR)
            IRRD=JB1IN(IR)
            IRRI=JB1INI(IR)
            IRRJ=JB1INJ(IR)
            JB1SY(IR)=JB1SY(1)
            JB1GR(IR)=JB1GR(1)
            JB1PE(IR)=JB1PE(1)
            JB1IN(IR)=JB1IN(1)
            JB1INI(IR)=JB1INI(1)
            JB1INJ(IR)=JB1INJ(1)
C
            IR=IR-1
            IF (IR.EQ.1) THEN
               JB1SY(1)=IRRA
               JB1GR(1)=IRRB
               JB1PE(1)=IRRC
               JB1IN(1)=IRRD
               JB1INI(1)=IRRI
               JB1INJ(1)=IRRJ
C
               GO TO 122
            ENDIF
         ENDIF
         I=L
         J=L+L
   20    IF (J.LE.IR) THEN
            IF (J.LT.IR) THEN
                   IF (JB1SY(J).LT.JB1SY(J+1)) J=J+1
            ENDIF
            IF (IRRA.LT.JB1SY(J)) THEN
               JB1SY(I)=JB1SY(J)
               JB1GR(I)=JB1GR(J)
               JB1PE(I)=JB1PE(J)
               JB1IN(I)=JB1IN(J)
               JB1INI(I)=JB1INI(J)
               JB1INJ(I)=JB1INJ(J)
               I=J
               J=J+J
            ELSE
               J=IR+1
            ENDIF
         GO TO 20
         ENDIF
         JB1SY(I)=IRRA
         JB1GR(I)=IRRB
         JB1PE(I)=IRRC
         JB1IN(I)=IRRD
         JB1INI(I)=IRRI
         JB1INJ(I)=IRRJ
      GO TO 10
C
  122 CONTINUE
C
      RETURN
      END
